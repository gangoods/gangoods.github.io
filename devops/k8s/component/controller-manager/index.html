
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../apiserver/">
      
      
        <link rel="next" href="../etcd/">
      
      <link rel="icon" href="../../../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.4">
    
    
      
        <title>controller-manager - 斯巴拉稀</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.240905d7.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

  
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
    
    
      
    
    
  
  
  <style>.md-tag--html{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="m0 32 34.9 395.8L191.5 480l157.6-52.2L384 32H0zm308.2 127.9H124.4l4.1 49.4h175.6l-13.6 148.4-97.9 27v.3h-1.1l-98.7-27.3-6-75.8h47.7L138 320l53.5 14.5 53.7-14.5 6-62.2H84.3L71.5 112.2h241.1l-4.4 47.7z"/></svg>');}.md-tag--js{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M0 32v448h448V32H0zm243.8 349.4c0 43.6-25.6 63.5-62.9 63.5-33.7 0-53.2-17.4-63.2-38.5l34.3-20.7c6.6 11.7 12.6 21.6 27.1 21.6 13.8 0 22.6-5.4 22.6-26.5V237.7h42.1v143.7zm99.6 63.5c-39.1 0-64.4-18.6-76.7-43l34.3-19.8c9 14.7 20.8 25.6 41.5 25.6 17.4 0 28.6-8.7 28.6-20.8 0-14.4-11.4-19.5-30.7-28l-10.5-4.5c-30.4-12.9-50.5-29.2-50.5-63.5 0-31.6 24.1-55.6 61.6-55.6 26.8 0 46 9.3 59.8 33.7L368 290c-7.2-12.9-15-18-27.1-18-12.3 0-20.1 7.8-20.1 18 0 12.6 7.8 17.7 25.9 25.6l10.5 4.5c35.8 15.3 55.9 31 55.9 66.2 0 37.8-29.8 58.6-69.7 58.6z"/></svg>');}.md-tag--css{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="m480 32-64 368-223.3 80L0 400l19.6-94.8h82l-8 40.6L210 390.2l134.1-44.4 18.8-97.1H29.5l16-82h333.7l10.5-52.7H56.3l16.3-82H480z"/></svg>');}.md-tag--linux{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.62 8.35c-.42.28-1.75 1.04-1.95 1.19-.39.31-.75.29-1.14-.01-.2-.16-1.53-.92-1.95-1.19-.48-.31-.45-.7.08-.92 1.64-.69 3.28-.64 4.91.03.49.21.51.6.05.9m7.22 7.28c-.93-2.09-2.2-3.99-3.84-5.66a4.31 4.31 0 0 1-1.06-1.88c-.1-.33-.17-.67-.24-1.01-.2-.88-.29-1.78-.7-2.61-.73-1.58-2-2.4-3.84-2.47-1.81.05-3.16.81-3.95 2.4-.21.43-.36.88-.46 1.34-.17.76-.32 1.55-.5 2.32-.15.65-.45 1.21-.96 1.71-1.61 1.57-2.9 3.37-3.88 5.35-.14.29-.28.58-.37.88-.19.66.29 1.12.99.96.44-.09.88-.18 1.3-.31.41-.15.57-.05.67.35.65 2.15 2.07 3.66 4.24 4.5 4.12 1.56 8.93-.66 9.97-4.58.07-.27.17-.37.47-.27.46.14.93.24 1.4.35.49.09.85-.16.92-.64.03-.26-.06-.49-.16-.73"/></svg>');}.md-tag--golang{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M400.1 194.8c-10.9 2.8-19.9 4.3-29.1 7.6-7.3 1.9-14.7 3.9-23.2 6.1l-.6.1c-4.2 1.2-4.6 1.3-8.5-3.2-4.7-5.3-8.1-8.7-14.6-11.9-19.7-9.6-38.7-6.8-56.4 4.7-21.2 13.7-32.1 34-31.8 59.2.3 25 17.4 45.5 41.2 48.9 22 2.8 39.8-4.6 53.8-20.5 2.1-2.6 4-5.3 6.1-8.3.8-1 1.5-2.1 2.3-3.3h-60.1c-6.5 0-8.1-4-5.9-9.3 4-9.7 11.5-25.9 15.9-34 .9-1.8 3.1-5.8 6.9-5.8h101.1c4.5-13.4 11.8-26.9 21.6-39.7 22.7-29.9 49.3-45.5 87.2-52 31.8-5.6 61.7-2.5 88.9 15.9 24.6 16.8 39.8 39.6 43.9 69.5 5.3 42.1-6.9 76.3-36.7 105.6-19.7 20.9-44.9 34-73.9 39.9-5.6 1-11.1 1.5-16.5 2-2.9.2-5.7.5-8.5.8-28.3-.6-54.2-8.7-76-27.4-15.3-13.3-25.9-29.6-31.1-48.5-3.7 7.3-8 14.4-14 21.1-21.6 29.6-50.9 48-87.9 52.9-30.6 4.1-58.9-1.8-83.9-20.5-23-17.5-36.1-40.5-39.5-69.2-4.1-34 5.9-65.4 26.4-91.3 22.2-29 51.5-47.4 87.3-53.9 29.3-6.2 57.3-1.9 82.6 15.3 16.5 10.9 28.3 25.8 36.1 43.9 1.9 2.8.6 4.4-3.1 5.3zm-351.8 5.6c-1.25 0-1.56-.6-.94-1.6l6.55-8.4c.62-.9 2.18-1.5 3.43-1.5H168.6c1.2 0 1.5.9.9 1.8l-5.3 8.1c-.6 1-2.2 1.9-3.1 1.9l-112.8-.3zM1.246 229.1c-1.246 0-1.558-.7-.934-1.6l6.543-8.4c.624-.9 2.182-1.6 3.425-1.6H152.4c1.2 0 1.8 1 1.5 1.9l-2.5 7.5c-.3 1.2-1.5 1.9-2.8 1.9l-147.354.3zm74.474 26.8c-.62.9-.31 1.8.93 1.8l67.95.3c.9 0 2.2-.9 2.2-2.1l.6-7.5c0-1.3-.6-2.2-1.9-2.2H83.2c-1.25 0-2.49.9-3.12 1.9l-4.36 7.8zm501.48-18c-.2-2.6-.3-4.8-.7-7-5.6-30.8-34-48.3-63.6-41.4-29 6.5-47.7 24.9-54.5 54.2-5.6 24.3 6.2 48.9 28.6 58.9 17.2 7.5 34.3 6.6 50.8-1.9 24.6-13.6 38-32.7 39.6-59.5-.1-1.2-.1-2.3-.2-3.3z"/></svg>');}.md-tag--rust{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="m508.52 249.75-21.82-13.51c-.17-2-.34-3.93-.55-5.88l18.72-17.5a7.35 7.35 0 0 0-2.44-12.25l-24-9c-.54-1.88-1.08-3.78-1.67-5.64l15-20.83a7.35 7.35 0 0 0-4.79-11.54l-25.42-4.15c-.9-1.73-1.79-3.45-2.73-5.15l10.68-23.42a7.35 7.35 0 0 0-6.95-10.39l-25.82.91q-1.79-2.22-3.61-4.4L439 81.84a7.36 7.36 0 0 0-8.84-8.84L405 78.93q-2.17-1.83-4.4-3.61l.91-25.82a7.35 7.35 0 0 0-10.39-7L367.7 53.23c-1.7-.94-3.43-1.84-5.15-2.73l-4.15-25.42a7.35 7.35 0 0 0-11.54-4.79L326 35.26c-1.86-.59-3.75-1.13-5.64-1.67l-9-24a7.35 7.35 0 0 0-12.25-2.44l-17.5 18.72c-1.95-.21-3.91-.38-5.88-.55L262.25 3.48a7.35 7.35 0 0 0-12.5 0L236.24 25.3c-2 .17-3.93.34-5.88.55l-17.5-18.72a7.35 7.35 0 0 0-12.25 2.44l-9 24c-1.89.55-3.79 1.08-5.66 1.68l-20.82-15a7.35 7.35 0 0 0-11.54 4.79l-4.15 25.41c-1.73.9-3.45 1.79-5.16 2.73l-23.4-10.63a7.35 7.35 0 0 0-10.39 7l.92 25.81c-1.49 1.19-3 2.39-4.42 3.61L81.84 73A7.36 7.36 0 0 0 73 81.84L78.93 107c-1.23 1.45-2.43 2.93-3.62 4.41l-25.81-.91a7.42 7.42 0 0 0-6.37 3.26 7.35 7.35 0 0 0-.57 7.13l10.66 23.41c-.94 1.7-1.83 3.43-2.73 5.16l-25.41 4.14a7.35 7.35 0 0 0-4.79 11.54l15 20.82c-.59 1.87-1.13 3.77-1.68 5.66l-24 9a7.35 7.35 0 0 0-2.44 12.25l18.72 17.5c-.21 1.95-.38 3.91-.55 5.88l-21.86 13.5a7.35 7.35 0 0 0 0 12.5l21.82 13.51c.17 2 .34 3.92.55 5.87l-18.72 17.5a7.35 7.35 0 0 0 2.44 12.25l24 9c.55 1.89 1.08 3.78 1.68 5.65l-15 20.83a7.35 7.35 0 0 0 4.79 11.54l25.42 4.15c.9 1.72 1.79 3.45 2.73 5.14l-10.63 23.43a7.35 7.35 0 0 0 .57 7.13 7.13 7.13 0 0 0 6.37 3.26l25.83-.91q1.77 2.22 3.6 4.4L73 430.16a7.36 7.36 0 0 0 8.84 8.84l25.16-5.93q2.18 1.83 4.41 3.61l-.92 25.82a7.35 7.35 0 0 0 10.39 6.95l23.43-10.68c1.69.94 3.42 1.83 5.14 2.73l4.15 25.42a7.34 7.34 0 0 0 11.54 4.78l20.83-15c1.86.6 3.76 1.13 5.65 1.68l9 24a7.36 7.36 0 0 0 12.25 2.44l17.5-18.72c1.95.21 3.92.38 5.88.55l13.51 21.82a7.35 7.35 0 0 0 12.5 0l13.51-21.82c2-.17 3.93-.34 5.88-.56l17.5 18.73a7.36 7.36 0 0 0 12.25-2.44l9-24c1.89-.55 3.78-1.08 5.65-1.68l20.82 15a7.34 7.34 0 0 0 11.54-4.78l4.15-25.42c1.72-.9 3.45-1.79 5.15-2.73l23.42 10.68a7.35 7.35 0 0 0 10.39-6.95l-.91-25.82q2.22-1.79 4.4-3.61l25.15 5.93a7.36 7.36 0 0 0 8.84-8.84L433.07 405q1.83-2.17 3.61-4.4l25.82.91a7.23 7.23 0 0 0 6.37-3.26 7.35 7.35 0 0 0 .58-7.13l-10.68-23.42c.94-1.7 1.83-3.43 2.73-5.15l25.42-4.15a7.35 7.35 0 0 0 4.79-11.54l-15-20.83c.59-1.87 1.13-3.76 1.67-5.65l24-9a7.35 7.35 0 0 0 2.44-12.25l-18.72-17.5c.21-1.95.38-3.91.55-5.87l21.82-13.51a7.35 7.35 0 0 0 0-12.5Zm-151 129.08A13.91 13.91 0 0 0 341 389.51l-7.64 35.67a187.51 187.51 0 0 1-156.36-.74l-7.64-35.66a13.87 13.87 0 0 0-16.46-10.68l-31.51 6.76a187.38 187.38 0 0 1-16.26-19.21H258.3c1.72 0 2.89-.29 2.89-1.91v-54.19c0-1.57-1.17-1.91-2.89-1.91h-44.83l.05-34.35H262c4.41 0 23.66 1.28 29.79 25.87 1.91 7.55 6.17 32.14 9.06 40 2.89 8.82 14.6 26.46 27.1 26.46H407a187.3 187.3 0 0 1-17.34 20.09Zm25.77 34.49A15.24 15.24 0 1 1 368 398.08h.44a15.23 15.23 0 0 1 14.8 15.24Zm-225.62-.68a15.24 15.24 0 1 1-15.25-15.25h.45a15.25 15.25 0 0 1 14.75 15.25Zm-88.1-178.49 32.83-14.6a13.88 13.88 0 0 0 7.06-18.33L102.69 186h26.56v119.73h-53.6a187.65 187.65 0 0 1-6.08-71.58Zm-11.26-36.06a15.24 15.24 0 0 1 15.23-15.25H74a15.24 15.24 0 1 1-15.67 15.24Zm155.16 24.49.05-35.32h63.26c3.28 0 23.07 3.77 23.07 18.62 0 12.29-15.19 16.7-27.68 16.7ZM399 306.71c-9.8 1.13-20.63-4.12-22-10.09-5.78-32.49-15.39-39.4-30.57-51.4 18.86-11.95 38.46-29.64 38.46-53.26 0-25.52-17.49-41.59-29.4-49.48-16.76-11-35.28-13.23-40.27-13.23h-198.9a187.49 187.49 0 0 1 104.89-59.19l23.47 24.6a13.82 13.82 0 0 0 19.6.44l26.26-25a187.51 187.51 0 0 1 128.37 91.43l-18 40.57a14 14 0 0 0 7.09 18.33l34.59 15.33a187.12 187.12 0 0 1 .4 32.54h-19.28c-1.91 0-2.69 1.27-2.69 3.13v8.82C421 301 409.31 305.58 399 306.71ZM240 60.21A15.24 15.24 0 0 1 255.21 45h.45A15.24 15.24 0 1 1 240 60.21ZM436.84 214a15.24 15.24 0 1 1 0-30.48h.44a15.24 15.24 0 0 1-.44 30.48Z"/></svg>');}.md-tag--python{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6zM286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3zM167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4zm-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3z"/></svg>');}.md-tag--k8s{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.95 13.5h-.23c-.18.11-.26.32-.18.5l.86 2.11c.83-.53 1.46-1.32 1.79-2.25l-2.23-.36h-.01m-3.45.29a.415.415 0 0 0-.38-.29h-.08l-2.22.37c.33.92.96 1.7 1.79 2.23l.85-2.07V14c.04-.05.04-.14.04-.21m1.83.81a.378.378 0 0 0-.51-.15c-.07.05-.12.08-.15.15h-.01l-1.09 1.97c.78.26 1.62.31 2.43.12.14-.03.29-.07.43-.12l-1.09-1.97h-.01m3.45-4.57L14.1 11.5l.01.03a.37.37 0 0 0-.04.53c.05.06.11.1.18.12l.01.01 2.17.62c.07-.97-.14-1.95-.65-2.78m-3.11.16c.01.21.18.37.39.36.08 0 .15-.02.21-.05h.01l1.83-1.31a4.45 4.45 0 0 0-2.57-1.24l.13 2.24m-1.94.31c.17.11.4.08.52-.09.05-.06.07-.13.08-.21h.01l.12-2.25c-.15.02-.3.05-.46.08-.8.18-1.54.58-2.12 1.16l1.84 1.31h.01m-.99 1.69c.2-.05.32-.26.26-.46 0-.08-.05-.14-.11-.19v-.01L8.21 10c-.52.86-.74 1.84-.63 2.82l2.16-.62v-.01m1.64.66.62.3.62-.3.15-.67-.43-.53h-.69l-.43.53.16.67m10.89 1.32L20.5 6.5c-.09-.42-.37-.76-.74-.94l-7.17-3.43c-.37-.17-.81-.17-1.19 0L4.24 5.56c-.37.18-.65.52-.74.94l-1.77 7.67c-.05.2-.05.4 0 .59.01.06.03.12.05.18.03.09.08.19.13.27.03.04.05.08.09.11l4.95 6.18c.02 0 .05.04.05.06.1.09.19.16.28.22.12.08.26.14.4.17.11.05.23.05.32.05h8.12c.07 0 .14-.03.2-.05.05-.01.1-.03.14-.04.04-.02.07-.03.11-.05.05-.02.1-.05.15-.08.12-.08.23-.18.33-.28l.15-.2 4.8-5.98c.1-.12.17-.25.22-.38.02-.06.04-.12.05-.18.05-.19.05-.4 0-.59m-7.43 2.99c.02.06.04.12.07.17-.04.08-.06.17-.03.26.12.24.23.46.38.68.08.11.16.23.24.34 0 .03.03.08.04.12.12.2.06.46-.15.59s-.47.05-.59-.15c-.01-.03-.02-.05-.03-.08-.02-.03-.04-.09-.06-.09-.05-.15-.09-.28-.12-.41-.09-.25-.17-.49-.3-.72a.375.375 0 0 0-.21-.14l-.08-.16c-1.29.48-2.7.48-3.97-.01l-.1.18c-.07.01-.14.04-.19.09-.14.24-.24.49-.33.77-.03.13-.07.26-.12.4-.02 0-.04.07-.06.1a.43.43 0 0 1-.81-.29c.01-.03.03-.05.04-.08.04-.03.04-.08.04-.11.09-.12.16-.23.24-.35.16-.21.29-.45.39-.69a.54.54 0 0 0-.03-.25l.07-.18a5.611 5.611 0 0 1-2.47-3.09l-.2.03a.388.388 0 0 0-.23-.09c-.27.05-.51.13-.77.22-.11.06-.24.11-.37.15-.03.01-.07.02-.13.03a.438.438 0 0 1-.54-.27c-.07-.23.04-.47.28-.55.02 0 .05-.01.08-.01v-.01h.01l.11-.02c.14-.04.28-.04.41-.04.26 0 .52-.06.77-.12.08-.05.14-.11.19-.19l.19-.05c-.21-1.36.1-2.73.86-3.87l-.14-.12c0-.09-.03-.18-.08-.25-.2-.17-.41-.32-.64-.45-.12-.06-.24-.13-.36-.21-.02-.02-.06-.05-.08-.07l-.01-.01c-.2-.16-.25-.42-.11-.63.09-.1.21-.15.35-.15.11.01.21.05.3.12l.09.07c.1.09.19.2.28.3.18.19.37.37.58.52.08.04.17.05.26.03l.15.11c.75-.8 1.73-1.36 2.8-1.6.25-.06.52-.1.78-.12l.01-.18a.45.45 0 0 0 .14-.23c.01-.26-.01-.52-.05-.77-.03-.13-.05-.27-.06-.41V5.1c-.02-.24.15-.45.39-.48s.44.15.47.38v.22c-.01.14-.03.28-.06.41-.04.25-.06.51-.05.77.02.1.07.17.14.22l.01.19c1.36.12 2.62.73 3.56 1.72l.16-.12c.09.02.18.01.26-.03.21-.15.41-.33.58-.52.09-.1.18-.2.28-.3.03-.02.07-.06.1-.06.17-.18.44-.18.59 0 .19.16.18.43 0 .6 0 .02-.03.04-.06.06a2.495 2.495 0 0 1-.44.28c-.23.13-.45.28-.64.45-.06.07-.09.15-.08.24l-.16.14a5.44 5.44 0 0 1 .88 3.86l.19.05c.04.08.11.14.19.18.25.07.51.11.77.14h.41c.03.03.08.04.12.05.24.03.4.25.37.49-.05.23-.24.4-.48.37-.03-.01-.07-.01-.07-.02v-.01c-.06 0-.1-.01-.14-.02-.13-.04-.25-.09-.36-.15-.26-.1-.5-.17-.77-.21-.09 0-.17 0-.23.08-.07-.01-.13-.02-.19-.03-.41 1.31-1.31 2.41-2.47 3.11Z"/></svg>');}.md-tag--docker{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>');}.md-tag--bash{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg>');}.md-tag--newbie{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 6h16v10H4m16 2a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H4c-1.11 0-2 .89-2 2v10a2 2 0 0 0 2 2H0v2h24v-2h-4Z"/></svg>');}.md-tag--mysql{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.68 12.32a4.49 4.49 0 0 0-6.36.01 4.49 4.49 0 0 0 0 6.36 4.508 4.508 0 0 0 5.57.63L21 22.39 22.39 21l-3.09-3.11c1.13-1.77.87-4.09-.62-5.57m-1.41 4.95c-.98.98-2.56.97-3.54 0-.97-.98-.97-2.56.01-3.54.97-.97 2.55-.97 3.53 0 .97.98.97 2.56 0 3.54M10.9 20.1a6.527 6.527 0 0 1-1.48-2.32C6.27 17.25 4 15.76 4 14v3c0 2.21 3.58 4 8 4-.4-.26-.77-.56-1.1-.9M4 9v3c0 1.68 2.07 3.12 5 3.7v-.2c0-.93.2-1.85.58-2.69C6.34 12.3 4 10.79 4 9m8-6C7.58 3 4 4.79 4 7c0 2 3 3.68 6.85 4h.05c1.2-1.26 2.86-2 4.6-2 .91 0 1.81.19 2.64.56A3.215 3.215 0 0 0 20 7c0-2.21-3.58-4-8-4Z"/></svg>');}</style>

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="yellow" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="斯巴拉稀" class="md-header__button md-logo" aria-label="斯巴拉稀" data-md-component="logo">
      
  <img src="../../../../images/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            斯巴拉稀
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              controller-manager
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="yellow" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->

  
  


<!-- Main navigation item with nested items -->

  <li class="md-tabs__item ">
    <a href="../../../.." class="md-tabs__link">
      home
    </a>
  </li>

      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->

  
  


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <li class="md-tabs__item ">
      <a href="../../../../linux/bash/quick-start/" class="md-tabs__link">
        linux
      </a>
    </li>
  

<!-- Main navigation item -->


  <!-- Render item -->
  

<!-- Main navigation item -->

      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->

  
  


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <li class="md-tabs__item ">
      <a href="../../../../go/basis/env/" class="md-tabs__link">
        go
      </a>
    </li>
  

<!-- Main navigation item -->


  <!-- Render item -->
  

<!-- Main navigation item -->

      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->

  
  


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <li class="md-tabs__item ">
      <a href="../../../../python/basis/env/" class="md-tabs__link">
        python
      </a>
    </li>
  

<!-- Main navigation item -->


  <!-- Render item -->
  

<!-- Main navigation item -->

      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->

  
  


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <li class="md-tabs__item ">
      <a href="../../../../db/mysql/env/" class="md-tabs__link">
        db
      </a>
    </li>
  

<!-- Main navigation item -->


  <!-- Render item -->
  

<!-- Main navigation item -->

      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->

  
  
    
    
  


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <li class="md-tabs__item  md-tabs__li--active">
      <a href="../../../docker/architecture/" class="md-tabs__link md-tabs__link--active">
        devops
      </a>
    </li>
  

<!-- Main navigation item -->


  <!-- Render item -->
  

<!-- Main navigation item -->

      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->

  
  


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <li class="md-tabs__item ">
      <a href="../../../../network-programming/tcp/" class="md-tabs__link">
        网络编程
      </a>
    </li>
  

<!-- Main navigation item -->

      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->

  
  


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <li class="md-tabs__item ">
      <a href="../../../../design-pattern/creational/" class="md-tabs__link">
        设计模式
      </a>
    </li>
  

<!-- Main navigation item -->


  <!-- Render item -->
  

<!-- Main navigation item -->

      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->

  
  


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <li class="md-tabs__item ">
      <a href="../../../../cs/assembly/" class="md-tabs__link">
        CS
      </a>
    </li>
  

<!-- Main navigation item -->


  <!-- Render item -->
  

<!-- Main navigation item -->

      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->

  
  


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->


<!-- Main navigation item with nested items -->

  
  

  <!-- Recurse, if the first item has further nested items -->
  
    <li class="md-tabs__item ">
      <a href="../../../../developer/git/git/" class="md-tabs__link">
        程序员预备
      </a>
    </li>
  

<!-- Main navigation item -->


  <!-- Render item -->
  

<!-- Main navigation item -->

      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine class according to state -->

  
  


<!-- Main navigation item with nested items -->

  <li class="md-tabs__item ">
    <a href="../../../../tags/" class="md-tabs__link">
      tags
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="斯巴拉稀" class="md-nav__button md-logo" aria-label="斯巴拉稀" data-md-component="logo">
      
  <img src="../../../../images/favicon.png" alt="logo">

    </a>
    斯巴拉稀
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
          bash
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          bash
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../linux/bash/quick-start/" class="md-nav__link">
        基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../linux/bash/var/" class="md-nav__link">
        变量
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../linux/bash/script/" class="md-nav__link">
        脚本
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../linux/bash/sed/" class="md-nav__link">
        sed
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../linux/bash/grep/" class="md-nav__link">
        grep
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../linux/bash/%E7%BB%BC%E5%90%88%E4%BE%8B%E5%AD%90/" class="md-nav__link">
        综合例子
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../linux/makefile/" class="md-nav__link">
        makefile
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
          性能分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          性能分析
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../linux/systems-performance/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%97%AE%E9%A2%98%E9%9B%86%E9%94%A6/" class="md-nav__link">
        服务器问题集锦
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../linux/nginx/" class="md-nav__link">
        nginx
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          go
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          go
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
      
      
      
        <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
          基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/env/" class="md-nav__link">
        环境准备
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/quick-start/" class="md-nav__link">
        快速入门
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/plan9/" class="md-nav__link">
        汇编
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/pragma-directives/" class="md-nav__link">
        编译指示
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/variable-type/" class="md-nav__link">
        变量与类型的本质
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/unsafe/" class="md-nav__link">
        unsafe
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/mem/" class="md-nav__link">
        程序的内存分布
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/string/" class="md-nav__link">
        字符串
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/slice/" class="md-nav__link">
        切片
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/map/" class="md-nav__link">
        Map
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/func-closure/" class="md-nav__link">
        函数和闭包
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/struct/" class="md-nav__link">
        结构体
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/interface/" class="md-nav__link">
        接口
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/reflect/" class="md-nav__link">
        反射
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/defer/" class="md-nav__link">
        defer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/panic-recover/" class="md-nav__link">
        panic-recover
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/escape/" class="md-nav__link">
        逃逸分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/gc/" class="md-nav__link">
        GC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/basis/start-go/" class="md-nav__link">
        go程序的启动过程
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          并发
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          并发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/concurrency/context/" class="md-nav__link">
        context
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/concurrency/channel/" class="md-nav__link">
        channel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/concurrency/goroutine/" class="md-nav__link">
        goroutine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/concurrency/lock/" class="md-nav__link">
        lock
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/concurrency/sync/" class="md-nav__link">
        sync
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
          工程设计
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          工程设计
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/infrastructure/directory/" class="md-nav__link">
        目录结构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/infrastructure/error/" class="md-nav__link">
        错误处理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/infrastructure/test/" class="md-nav__link">
        测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/infrastructure/clean-code/" class="md-nav__link">
        编码规范
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
      
      
      
        <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
          工具与实用库
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          工具与实用库
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/pkg/dlv/" class="md-nav__link">
        dlv调试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/pkg/cobra/" class="md-nav__link">
        cobra
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../go/pkg/go-generate/" class="md-nav__link">
        generate
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
          基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../python/basis/env/" class="md-nav__link">
        环境准备
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
          pandas
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          pandas
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../python/pandas/quick-start/" class="md-nav__link">
        快速入门
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../python/pandas/analysis-diagram/" class="md-nav__link">
        分析与画图
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          db
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          db
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
      
      
      
        <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
          mysql
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          mysql
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mysql/env/" class="md-nav__link">
        环境准备
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mysql/backup-recovery/" class="md-nav__link">
        备份与恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mysql/" class="md-nav__link">
        索引底层
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mysql/sql/" class="md-nav__link">
        SQL语句
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mysql/optimization/" class="md-nav__link">
        SQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mysql/binlog/" class="md-nav__link">
        二进制日志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mysql/redo/" class="md-nav__link">
        redo日志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mysql/undo/" class="md-nav__link">
        undo日志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mysql/transaction/" class="md-nav__link">
        事务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mysql/lock/" class="md-nav__link">
        锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mysql/ha/" class="md-nav__link">
        高可用
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
      
      
      
        <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
          redis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          redis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/redis/env/" class="md-nav__link">
        环境配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/redis/persistence/" class="md-nav__link">
        数据持久化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/redis/data-type/" class="md-nav__link">
        数据类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/redis/source-code/" class="md-nav__link">
        源码分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/redis/principle/" class="md-nav__link">
        底层原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/redis/architecture/" class="md-nav__link">
        架构设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/redis/cache/" class="md-nav__link">
        缓存设计
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
      
      
      
        <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
          kafka
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          kafka
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/kafka/install/" class="md-nav__link">
        Install
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
      
      
      
        <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
          mongodb
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          mongodb
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/mongodb/install/" class="md-nav__link">
        Install
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
          elasticsearch
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_5">
          <span class="md-nav__icon md-icon"></span>
          elasticsearch
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../db/es/env/" class="md-nav__link">
        Env
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          devops
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          devops
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1" >
      
      
      
        <label class="md-nav__link" for="__nav_6_1" id="__nav_6_1_label" tabindex="0">
          docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/architecture/" class="md-nav__link">
        架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/env/" class="md-nav__link">
        环境准备
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker/" class="md-nav__link">
        常用命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/ip/" class="md-nav__link">
        流量走向分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-file/" class="md-nav__link">
        dockerfile
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-compose/" class="md-nav__link">
        docker-compose
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/namespace/" class="md-nav__link">
        namespace
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/cgroup/" class="md-nav__link">
        cgroup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/union-fs/" class="md-nav__link">
        union fs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/network/" class="md-nav__link">
        network
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
      
      
      
        <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
          cicd
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          cicd
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../cicd/git-server/" class="md-nav__link">
        git服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../cicd/github-action/" class="md-nav__link">
        github-action
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../cicd/drone/" class="md-nav__link">
        drone
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
          k8s
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          k8s
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_1" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_1" id="__nav_6_3_1_label" tabindex="0">
          基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_1">
          <span class="md-nav__icon md-icon"></span>
          基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../basics/architecture/" class="md-nav__link">
        架构总览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../basics/env/" class="md-nav__link">
        环境安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../basics/harbor/" class="md-nav__link">
        镜像仓库
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_2" id="__nav_6_3_2_label" tabindex="0">
          核心概念与实战
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_2">
          <span class="md-nav__icon md-icon"></span>
          核心概念与实战
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/pod/" class="md-nav__link">
        pod
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/controller/" class="md-nav__link">
        控制器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/scheduler/" class="md-nav__link">
        调度器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/persistence/" class="md-nav__link">
        存储管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/config/" class="md-nav__link">
        配置管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_2_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_2_6" id="__nav_6_3_2_6_label" tabindex="0">
          服务
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_3_2_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_2_6">
          <span class="md-nav__icon md-icon"></span>
          服务
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/service/service/" class="md-nav__link">
        service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/service/ingress/" class="md-nav__link">
        ingress
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/service/traefik/" class="md-nav__link">
        traefik
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/resource-quota-qos/" class="md-nav__link">
        资源配额
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/api-resource/" class="md-nav__link">
        API资源
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_6_3_3" id="__nav_6_3_3_label" tabindex="0">
          组件
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_6_3_3">
          <span class="md-nav__icon md-icon"></span>
          组件
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubectl/" class="md-nav__link">
        kubectl
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../apiserver/" class="md-nav__link">
        apiserver
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          controller-manager
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        controller-manager
      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="TOC">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      TOC
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    默认控制器
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    控制器架构原理
  </a>
  
    <nav class="md-nav" aria-label="控制器架构原理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    核心逻辑
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    设计思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resourceversion" class="md-nav__link">
    ResourceVersion
  </a>
  
    <nav class="md-nav" aria-label="ResourceVersion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#etcd" class="md-nav__link">
    资源对象与etcd
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    查询时带上
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    代码流程
  </a>
  
    <nav class="md-nav" aria-label="代码流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    流程简图
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    入口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    实例化控制器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run" class="md-nav__link">
    控制器.Run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#informerrun" class="md-nav__link">
    informer.run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#informer" class="md-nav__link">
    informer
  </a>
  
    <nav class="md-nav" aria-label="informer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    先看看一个简单例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reflector" class="md-nav__link">
    Reflector
  </a>
  
    <nav class="md-nav" aria-label="Reflector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bookmark-event" class="md-nav__link">
    Bookmark event
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deltafifo" class="md-nav__link">
    DeltaFIFO
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#workqueue" class="md-nav__link">
    Workqueue
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexer" class="md-nav__link">
    indexer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    自定义控制器
  </a>
  
    <nav class="md-nav" aria-label="自定义控制器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#k8s" class="md-nav__link">
    部署到k8s
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../etcd/" class="md-nav__link">
        etcd
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_4" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_4" id="__nav_6_3_4_label" tabindex="0">
          二次开发
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_4">
          <span class="md-nav__icon md-icon"></span>
          二次开发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/" class="md-nav__link">
        介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_4_2" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_4_2" id="__nav_6_3_4_2_label" tabindex="0">
          client-go
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_3_4_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_4_2">
          <span class="md-nav__icon md-icon"></span>
          client-go
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/client-go/" class="md-nav__link">
        介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/client-go/client-go/" class="md-nav__link">
        client-go
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_4_3" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_4_3" id="__nav_6_3_4_3_label" tabindex="0">
          operator
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_3_4_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_4_3">
          <span class="md-nav__icon md-icon"></span>
          operator
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/operator/crd/" class="md-nav__link">
        自定义资源
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/operator/sample-controller/" class="md-nav__link">
        sample-controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/operator/kubebuilder/" class="md-nav__link">
        kubebuilder
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/code-generator/" class="md-nav__link">
        代码生成器
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_5" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_5" id="__nav_6_3_5_label" tabindex="0">
          生态
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_5">
          <span class="md-nav__icon md-icon"></span>
          生态
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ecosystem/helm/" class="md-nav__link">
        helm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ecosystem/istio/" class="md-nav__link">
        istio
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../command/" class="md-nav__link">
        命令汇总
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../check/" class="md-nav__link">
        排查
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          网络编程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          网络编程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network-programming/tcp/" class="md-nav__link">
        tcp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../network-programming/https/" class="md-nav__link">
        https与证书
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          设计模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          设计模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" >
      
      
      
        <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
          创建型模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_1">
          <span class="md-nav__icon md-icon"></span>
          创建型模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design-pattern/creational/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
      
      
      
        <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
          结构型模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          结构型模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design-pattern/structural/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
      
      
      
        <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="0">
          行为型模式
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_3">
          <span class="md-nav__icon md-icon"></span>
          行为型模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../design-pattern/behavioral/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          CS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          CS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1" >
      
      
      
        <label class="md-nav__link" for="__nav_9_1" id="__nav_9_1_label" tabindex="0">
          汇编
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9_1">
          <span class="md-nav__icon md-icon"></span>
          汇编
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../cs/assembly/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2" >
      
      
      
        <label class="md-nav__link" for="__nav_9_2" id="__nav_9_2_label" tabindex="0">
          操作系统
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9_2">
          <span class="md-nav__icon md-icon"></span>
          操作系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../cs/os/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3" >
      
      
      
        <label class="md-nav__link" for="__nav_9_3" id="__nav_9_3_label" tabindex="0">
          计算机网络
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9_3">
          <span class="md-nav__icon md-icon"></span>
          计算机网络
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../cs/network/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          程序员预备
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          程序员预备
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_1" >
      
      
      
        <label class="md-nav__link" for="__nav_10_1" id="__nav_10_1_label" tabindex="0">
          git
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10_1">
          <span class="md-nav__icon md-icon"></span>
          git
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../developer/git/git/" class="md-nav__link">
        git基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../developer/git/advanced/" class="md-nav__link">
        git进阶
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../developer/git/principle/" class="md-nav__link">
        git原理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../developer/ssh/" class="md-nav__link">
        ssh
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../developer/vim/" class="md-nav__link">
        vim
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../developer/terminal/" class="md-nav__link">
        terminal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../developer/mac/" class="md-nav__link">
        mac
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../tags/" class="md-nav__link">
        tags
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="TOC">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      TOC
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    默认控制器
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    控制器架构原理
  </a>
  
    <nav class="md-nav" aria-label="控制器架构原理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    核心逻辑
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    设计思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resourceversion" class="md-nav__link">
    ResourceVersion
  </a>
  
    <nav class="md-nav" aria-label="ResourceVersion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#etcd" class="md-nav__link">
    资源对象与etcd
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    查询时带上
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    代码流程
  </a>
  
    <nav class="md-nav" aria-label="代码流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    流程简图
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    入口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    实例化控制器
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run" class="md-nav__link">
    控制器.Run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#informerrun" class="md-nav__link">
    informer.run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#informer" class="md-nav__link">
    informer
  </a>
  
    <nav class="md-nav" aria-label="informer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    先看看一个简单例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reflector" class="md-nav__link">
    Reflector
  </a>
  
    <nav class="md-nav" aria-label="Reflector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bookmark-event" class="md-nav__link">
    Bookmark event
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deltafifo" class="md-nav__link">
    DeltaFIFO
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#workqueue" class="md-nav__link">
    Workqueue
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexer" class="md-nav__link">
    indexer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    自定义控制器
  </a>
  
    <nav class="md-nav" aria-label="自定义控制器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#k8s" class="md-nav__link">
    部署到k8s
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  

  <nav class="md-tags" >
    
      
        
        
      
      
        <a href="../../../../tags/#k8s" class="md-tag md-tag-icon">k8s</a>
      
    
  </nav>




  <h1>controller-manager</h1>

<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>未完,待继续整理...</p>
</div>
<h2 id="_1">默认控制器<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Controller Manager 是多个控制器的组合, 另外像调度器其实是一种特殊的控制器.</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>ks<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>kube-controller-manager-master1<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span>--<span class="w"> </span>kube-controller-manager<span class="w"> </span>-h<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="p">|</span>grep<span class="w"> </span>-iA<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="s2">&quot;\-\-controllers&quot;</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_2">控制器架构原理<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">核心逻辑<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>k8s中每一个控制器 都对应负责k8s中的一种资源, 保证这种资源是其期待的状态<br>
每个 Controller 事实上都是一个 control loop死循环,负责侦听其管控的对象,当对象发生变更时完成配置.<br>
Controller 配置失败通常会触发自动重试,整个集群会在控制器不断重试的机制下确保最终一致性</p>
</div>
<div class="language-go highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">控制器的核心逻辑</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span>
<span class="normal"><a href="#__codelineno-1-4">4</a></span>
<span class="normal"><a href="#__codelineno-1-5">5</a></span>
<span class="normal"><a href="#__codelineno-1-6">6</a></span>
<span class="normal"><a href="#__codelineno-1-7">7</a></span>
<span class="normal"><a href="#__codelineno-1-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="nx">当前状态</span><span class="o">:=</span><span class="w"> </span><span class="nx">获取集群中对象X的当前状态</span><span class="p">(</span><span class="nx">Current</span><span class="w"> </span><span class="nx">State</span><span class="p">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="nx">期望状态</span><span class="o">:=</span><span class="w"> </span><span class="nx">获取集群中对象X的期望状态</span><span class="p">(</span><span class="nx">Desired</span><span class="w"> </span><span class="nx">State</span><span class="p">)</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="c1">// 只有不一致的时候</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">当前状态</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">期望状态</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">        </span><span class="c1">//将当前状态调整为期望状态</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="_4">设计思路<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">我们的简单思考</label><label for="__tabbed_1_2">k8s的实际设计</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><object type="image/svg+xml" data="/images/controller-manager-7711249f6ab5ba1f5b223e90a3296b17.svg" style="max-width:100%"></object></p>
</div>
<div class="tabbed-block">
<p><object type="image/svg+xml" data="/images/controller-manager-8a2a338903531145f860e5dbb883a58b.svg" style="max-width:100%"></object></p>
</div>
</div>
</div>
<h3 id="resourceversion">ResourceVersion<a class="headerlink" href="#resourceversion" title="Permanent link">&para;</a></h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>在看源码之前我们先学习一下ResourceVersion 资源版本号这个知识点<br>
请先去看下博文<a href="/devops/k8s/component/etcd/#_3">etcd的版本管理</a></p>
</div>
<h4 id="etcd">资源对象与etcd<a class="headerlink" href="#etcd" title="Permanent link">&para;</a></h4>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1"># 创建一个pod nginx, 然后</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>k<span class="w"> </span>get<span class="w"> </span>po<span class="w"> </span>nginx<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>-i<span class="w"> </span>resourceVersion
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span>resourceVersion:<span class="w"> </span><span class="s2">&quot;2794306&quot;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="c1"># 我们知道k8s 的数据持久化到etcd的,所以这里我们看下这个pod在etcd里的存储情况</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>e<span class="w"> </span>get<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>--prefix<span class="w"> </span>--keys-only<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>nginx
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span>/registry/pods/default/nginx
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="c1"># 看下 存放在etcd时的版本情况,与  k get po 得到的版本是一样的.</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a>e<span class="w"> </span>get<span class="w"> </span>/registry/pods/default/nginx<span class="w"> </span>-w<span class="w"> </span>json<span class="w"> </span><span class="c1">#(1)</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="c1"># 给pod 增加一个label 再看</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a>k<span class="w"> </span>get<span class="w"> </span>po<span class="w"> </span>nginx<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>-i<span class="w"> </span>resourceVersion
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">  </span>resourceVersion:<span class="w"> </span><span class="s2">&quot;2794480&quot;</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a>e<span class="w"> </span>get<span class="w"> </span>/registry/pods/default/nginx<span class="w"> </span>-w<span class="w"> </span>json<span class="w"> </span><span class="c1">#(2)</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="c1"># 可以看到这2个版本的数据</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a>e<span class="w"> </span>watch<span class="w"> </span>/registry/pods/default/nginx<span class="w"> </span>--rev<span class="o">=</span><span class="m">2794306</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>查看版本
    <div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="nt">&quot;header&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">        </span><span class="nt">&quot;cluster_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2356888313039106048</span><span class="p">,</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">        </span><span class="nt">&quot;member_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">14381832694777033788</span><span class="p">,</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">        </span><span class="nt">&quot;revision&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2794357</span><span class="p">,</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">        </span><span class="nt">&quot;raft_term&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="nt">&quot;kvs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">            </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;L3JlZ2lzdHJ5L3BvZHMvZGVmYXVsdC9uZ2lueA==&quot;</span><span class="p">,</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">            </span><span class="nt">&quot;create_revision&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2738283</span><span class="p">,</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="hll"><span class="w">            </span><span class="c1">// k8s 通过etcd中的这个 和 k get po 获取的resourceVersion进行对比</span>
</span></span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="hll"><span class="w">            </span><span class="c1">// 如果不相同说明 ,在你更新的时候,po 已经被更新了,则拒绝更新, 这就是乐观锁</span>
</span></span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="hll"><span class="w">            </span><span class="nt">&quot;mod_revision&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2794306</span><span class="p">,</span>
</span></span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">            </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">            </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;+=&quot;</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="p">],</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">    </span><span class="nt">&quot;count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></li>
<li>查看
    <div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="p">{</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="nt">&quot;header&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">        </span><span class="nt">&quot;cluster_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2356888313039106048</span><span class="p">,</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">        </span><span class="nt">&quot;member_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">14381832694777033788</span><span class="p">,</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">        </span><span class="nt">&quot;revision&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2794941</span><span class="p">,</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">        </span><span class="nt">&quot;raft_term&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="nt">&quot;kvs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">            </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;L3JlZ2lzdHJ5L3BvZHMvZGVmYXVsdC9uZ2lueA==&quot;</span><span class="p">,</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">            </span><span class="nt">&quot;create_revision&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2738283</span><span class="p">,</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="hll"><span class="w">            </span><span class="nt">&quot;mod_revision&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2794480</span><span class="p">,</span>
</span></span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">            </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">            </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;+=&quot;</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="p">],</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="nt">&quot;count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></li>
</ol>
<h4 id="_5">查询时带上<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>关于查询中带resourceVersion的具体表现,<a href="https://kubernetes.io/zh-cn/docs/reference/using-api/api-concepts/#semantics-for-get-and-list">请看官方文档的说明</a><br></p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:3"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">list使用resourceVersion</label><label for="__tabbed_2_2">get使用resourceVersion</label><label for="__tabbed_2_3">watch使用resourceVersion</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>resourceVersionMatch 参数</th>
<th>分页参数</th>
<th>resourceVersion 未设置</th>
<th>resourceVersion<br>="0"</th>
<th>resourceVersion<br>="&lt;非零值&gt;"</th>
</tr>
</thead>
<tbody>
<tr>
<td>未设置</td>
<td>limit 未设置</td>
<td>最新版本</td>
<td>任意版本</td>
<td>不老于指定版本</td>
</tr>
<tr>
<td>未设置</td>
<td>limit=n, continue 未设置</td>
<td>最新版本</td>
<td>任意版本</td>
<td>精确匹配</td>
</tr>
<tr>
<td>未设置</td>
<td>limit=n, continue=token</td>
<td>从 token 开始、精确匹配</td>
<td>非法请求<br>视为从 token 开始、精确匹配</td>
<td>非法请求<br>返回 HTTP 400 Bad Request</td>
</tr>
<tr>
<td>Exact</td>
<td>limit 未设置</td>
<td>非法请求</td>
<td>非法请求</td>
<td>精确匹配</td>
</tr>
<tr>
<td>Exact</td>
<td>limit=n, continue 未设置</td>
<td>非法请求</td>
<td>非法请求</td>
<td>精确匹配</td>
</tr>
<tr>
<td>NotOlderThan</td>
<td>limit 未设置</td>
<td>非法请求</td>
<td>任意版本</td>
<td>不老于指定版本</td>
</tr>
<tr>
<td>NotOlderThan</td>
<td>limit=n, continue 未设置</td>
<td>非法请求</td>
<td>任意版本</td>
<td>不老于指定版本</td>
</tr>
</tbody>
</table>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>resourceVersionMatch 如果设置的话,值=Exact或NotOlderThan<br>
<code>http://localhost:8001/api/v1/pods?resourceVersion=2196120&amp;resourceVersionMatch=NotOlderThan&amp;limit=1</code> 结果里能看到metadata里 continue的值xxx, 然后 请求带上 &amp;continue=xxx ,就是分页一样,第二页了.<br>
<strong><mark class="critic">最新版本的意思: 从 etcd 读取</mark></strong> <br>
<strong><mark>任意版本的意思: 从缓存中读取,因为缓存中可能是旧的,也可能是和etcd中一致的数据, 所以这里称为任意版本</mark></strong></p>
</div>
</div>
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>resourceVersion 未设置</th>
<th>resourceVersion="0"</th>
<th>resourceVersion="&lt;非零值&gt;"</th>
</tr>
</thead>
<tbody>
<tr>
<td>最新版本</td>
<td>任何版本</td>
<td>不老于给定版本</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>resourceVersion 未设置</th>
<th>resourceVersion="0"</th>
<th>resourceVersion="&lt;非零值&gt;"</th>
</tr>
</thead>
<tbody>
<tr>
<td>读取状态并从最新版本开始</td>
<td>读取状态并从任意版本开始</td>
<td>从指定版本开始</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="admonition danger">
<p class="admonition-title">源码说明什么时候从etcd获取,什么时候从etcd中获取</p>
<p>待确认...</p>
<div class="language-go highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">Cacher</span><span class="p">)</span><span class="w"> </span><span class="nx">List</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="nx">storage</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">,</span><span class="w"> </span><span class="nx">listObj</span><span class="w"> </span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="nx">resourceVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">opts</span><span class="p">.</span><span class="nx">ResourceVersion</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="nx">pred</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">opts</span><span class="p">.</span><span class="nx">Predicate</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">shouldDelegateList</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">        </span><span class="c1">// 从etcd 获取</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nx">List</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">opts</span><span class="p">,</span><span class="w"> </span><span class="nx">listObj</span><span class="p">)</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">    </span><span class="c1">//...</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="p">}</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="kd">func</span><span class="w"> </span><span class="nx">shouldDelegateList</span><span class="p">(</span><span class="nx">opts</span><span class="w"> </span><span class="nx">storage</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">    </span><span class="nx">resourceVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">opts</span><span class="p">.</span><span class="nx">ResourceVersion</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">    </span><span class="nx">pred</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">opts</span><span class="p">.</span><span class="nx">Predicate</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">    </span><span class="nx">pagingEnabled</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nx">Enabled</span><span class="p">(</span><span class="nx">features</span><span class="p">.</span><span class="nx">APIListChunking</span><span class="p">)</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="nx">hasContinuation</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">pagingEnabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">pred</span><span class="p">.</span><span class="nx">Continue</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">    </span><span class="c1">// resourceVersion 不等于0</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">    </span><span class="nx">hasLimit</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">pagingEnabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">pred</span><span class="p">.</span><span class="nx">Limit</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">resourceVersion</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;0&quot;</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">resourceVersion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">hasContinuation</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">hasLimit</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">opts</span><span class="p">.</span><span class="nx">ResourceVersionMatch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ResourceVersionMatchExact</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="3:4"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><input id="__tabbed_3_3" name="__tabbed_3" type="radio" /><input id="__tabbed_3_4" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">resourceVersion 空</label><label for="__tabbed_3_2">hasLimit</label><label for="__tabbed_3_3">hasContinuation</label><label for="__tabbed_3_4">从缓存中读取</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span>
<span class="normal"><a href="#__codelineno-6-6">6</a></span>
<span class="normal"><a href="#__codelineno-6-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1"># list操作 返回的结果里最外层的resourceVersion 是 list 响应被构造时的reversion</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="c1"># 就是 拉取的数据是  etcd全局reversion = 最外层的resourceVersion这个值的时候的数据</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="c1"># 所以 下次拉取的时候, 使用watch ,然后设置不老于 这个resourceVersion, 这样就全量+增量获取数据了</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="c1"># 不带resourceVersion 的时候, 会从etcd 读取,所以 这个时候的 值= 拉取的时候etcd全局的reversion</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a>curl<span class="w"> </span>localhost:8001/api/v1/namespaces/default/pods
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="c1"># 或直接在浏览器打开</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a>localhost:8001/api/v1/namespaces/default/pods<span class="w"> </span><span class="c1">#(1)</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>
<p>结果</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PodList&quot;</span><span class="p">,</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;v1&quot;</span><span class="p">,</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="nt">&quot;metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">        </span><span class="nt">&quot;resourceVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="nt">&quot;items&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">            </span><span class="nt">&quot;metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">                </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">                </span><span class="nt">&quot;namespace&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">                </span><span class="nt">&quot;resourceVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;....&quot;</span><span class="p">,</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">            </span><span class="nt">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">            </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">        </span><span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">        </span><span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">        </span><span class="p">{</span><span class="err">...</span><span class="p">}</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="w">    </span><span class="p">]</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c1"># 下面这个操作 会获取pod是nginx 版本为2794306的信息</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="c1"># 如果指定的版本被压缩过,会报错,因为这个是精确匹配,表示全局reversion=2794306时的数据,而这个版本不在了</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="c1"># 从etcd获取</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>localhost:8001/api/v1/namespaces/default/pods?resourceVersion<span class="o">=</span><span class="m">2794306</span><span class="p">&amp;</span><span class="nv">limit</span><span class="o">=</span><span class="m">5</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1"># continue 分页, 从etcd 获取</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a>localhost:8001/api/v1/namespaces/default/pods?limit<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="c1">#(1)</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="c1"># 使用 continue 继续获取下一页</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a>localhost:8001/api/v1/namespaces/default/pods?limit<span class="o">=</span><span class="m">1</span><span class="p">&amp;</span><span class="k">continue</span><span class="o">=</span>XXXXXXXXXXXXX
</span></code></pre></div></td></tr></table></div>
<ol>
<li>
<p>结果显示</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">        </span><span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PodList&quot;</span><span class="p">,</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">        </span><span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;v1&quot;</span><span class="p">,</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">        </span><span class="nt">&quot;metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">            </span><span class="nt">&quot;resourceVersion&quot;</span><span class="p">:</span><span class="w">    </span><span class="s2">&quot;2840267&quot;</span><span class="p">,</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">            </span><span class="nt">&quot;continue&quot;</span><span class="p">:</span><span class="w">           </span><span class="s2">&quot;XXXXXXXXXXXXX&quot;</span><span class="p">,</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">            </span><span class="nt">&quot;remainingItemCount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="c1">// 剩余还有几条数据</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">        </span><span class="nt">&quot;items&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span>
<span class="normal"><a href="#__codelineno-11-5">5</a></span>
<span class="normal"><a href="#__codelineno-11-6">6</a></span>
<span class="normal"><a href="#__codelineno-11-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1"># 不老于指定版本, 返回的结果里最外层的resourceVersion 是 list 响应被构造时的reversion</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="c1"># 由于是从缓存(apiserver的缓存)中获取,所以获取的时候,是缓存中最新版本的数据,但是因为是缓存</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="c1"># 显示的resourceVersion 可能在实际etcd里是已经被压缩过而不存在的值</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="c1"># 实际测试,可以测到, 这个resourceVersion 用下面的 可以访问, 去etcd 命令访问会提示too old</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a>localhost:8001/api/v1/namespaces/default/pods?resourceVersion<span class="o">=</span><span class="m">2794306</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="c1"># 同上</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a>localhost:8001/api/v1/namespaces/default/pods?resourceVersion<span class="o">=</span><span class="m">2794306</span><span class="p">&amp;</span><span class="nv">resourceVersionMatch</span><span class="o">=</span>NotOlderThan
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="_6">代码流程<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>我们以ReplicaSet资源的控制器为例</p>
</div>
<h4 id="_7">流程简图<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<object type="image/svg+xml" data="/images/controller-manager-944fb213348d209f1ef9d4608a57a755.svg" style="max-width:100%"></object>

<h4 id="_8">入口<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<div class="tabbed-set tabbed-alternate" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">controllermanager#run</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">cmd/kube-controller-manager/app/controllermanager.go#run</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span>
<span class="normal"><a href="#__codelineno-12-28">28</a></span>
<span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span>
<span class="normal"><a href="#__codelineno-12-31">31</a></span>
<span class="normal"><a href="#__codelineno-12-32">32</a></span>
<span class="normal"><a href="#__codelineno-12-33">33</a></span>
<span class="normal"><a href="#__codelineno-12-34">34</a></span>
<span class="normal"><a href="#__codelineno-12-35">35</a></span>
<span class="normal"><a href="#__codelineno-12-36">36</a></span>
<span class="normal"><a href="#__codelineno-12-37">37</a></span>
<span class="normal"><a href="#__codelineno-12-38">38</a></span>
<span class="normal"><a href="#__codelineno-12-39">39</a></span>
<span class="normal"><a href="#__codelineno-12-40">40</a></span>
<span class="normal"><a href="#__codelineno-12-41">41</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">Run</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">config</span><span class="p">.</span><span class="nx">CompletedConfig</span><span class="p">,</span><span class="w"> </span><span class="nx">stopCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="nx">run</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">startSATokenController</span><span class="w"> </span><span class="nx">InitFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">initializersFunc</span><span class="w"> </span><span class="nx">ControllerInitializersFunc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">        </span><span class="nx">controllerContext</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">CreateControllerContext</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">rootClientBuilder</span><span class="p">,</span><span class="w"> </span><span class="nx">clientBuilder</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">())</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">        </span><span class="c1">// 3. 来至NewControllerInitializers里一个个 startXXXController</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">        </span><span class="c1">// 每个startXXXController 里都用工厂方法实例化 对应类型的informer</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="hll"><span class="w">        </span><span class="nx">controllerInitializers</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">initializersFunc</span><span class="p">(</span><span class="nx">controllerContext</span><span class="p">.</span><span class="nx">LoopMode</span><span class="p">)</span>
</span></span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">        </span><span class="c1">// 4. 执行每个 startXXXController()  (2)</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">        </span><span class="c1">// 都使用controllerContext.InformerFactory 来创建对应资源informer</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">        </span><span class="c1">// 都存于controllerContext.InformerFactory.informers中</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">StartControllers</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">controllerContext</span><span class="p">,</span><span class="w"> </span><span class="nx">startSATokenController</span><span class="p">,</span><span class="w"> </span><span class="nx">controllerInitializers</span><span class="p">,</span><span class="w"> </span><span class="nx">unsecuredMux</span><span class="p">,</span><span class="w"> </span><span class="nx">healthzHandler</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span></span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">        </span><span class="c1">// 5. 然后这里启动所有的informer (1)</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="hll"><span class="w">        </span><span class="nx">controllerContext</span><span class="p">.</span><span class="nx">InformerFactory</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span></span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">        </span><span class="nx">controllerContext</span><span class="p">.</span><span class="nx">ObjectOrMetadataInformerFactory</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">        </span><span class="nb">close</span><span class="p">(</span><span class="nx">controllerContext</span><span class="p">.</span><span class="nx">InformersStarted</span><span class="p">)</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22"></a>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="w">    </span><span class="c1">// Start the main lock</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="nx">leaderElectAndRun</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">electionChecker</span><span class="p">,</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25"></a><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">ComponentConfig</span><span class="p">.</span><span class="nx">Generic</span><span class="p">.</span><span class="nx">LeaderElection</span><span class="p">.</span><span class="nx">ResourceLock</span><span class="p">,</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">ComponentConfig</span><span class="p">.</span><span class="nx">Generic</span><span class="p">.</span><span class="nx">LeaderElection</span><span class="p">.</span><span class="nx">ResourceName</span><span class="p">,</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27"></a><span class="w">        </span><span class="nx">leaderelection</span><span class="p">.</span><span class="nx">LeaderCallbacks</span><span class="p">{</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28"></a><span class="w">            </span><span class="nx">OnStartedLeading</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="w">                </span><span class="c1">// 1. NewControllerInitializers 各种不同资源控制器的定义 (3)</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="hll"><span class="w">                </span><span class="nx">initializersFunc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewControllerInitializers</span>
</span></span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">leaderMigrator</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="w">                    </span><span class="nx">initializersFunc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">createInitializersFunc</span><span class="p">(</span><span class="nx">leaderMigrator</span><span class="p">.</span><span class="nx">FilterFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">leadermigration</span><span class="p">.</span><span class="nx">ControllerNonMigrated</span><span class="p">)</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a><span class="w">                </span><span class="c1">// 2. run 去看上方的run定义</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35"></a><span class="hll"><span class="w">                </span><span class="nx">run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">startSATokenController</span><span class="p">,</span><span class="w"> </span><span class="nx">initializersFunc</span><span class="p">)</span>
</span></span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37"></a><span class="w">            </span><span class="nx">OnStoppedLeading</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40"></a>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>
<p>代码</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1">// Start initializes all requested informers.</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">sharedInformerFactory</span><span class="p">)</span><span class="w"> </span><span class="nx">Start</span><span class="p">(</span><span class="nx">stopCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="nx">f</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">informerType</span><span class="p">,</span><span class="w"> </span><span class="nx">informer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">informers</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">f</span><span class="p">.</span><span class="nx">startedInformers</span><span class="p">[</span><span class="nx">informerType</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="hll"><span class="w">            </span><span class="k">go</span><span class="w"> </span><span class="nx">informer</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span></span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">            </span><span class="nx">f</span><span class="p">.</span><span class="nx">startedInformers</span><span class="p">[</span><span class="nx">informerType</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>StartControllers</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span>
<span class="normal"><a href="#__codelineno-14-5">5</a></span>
<span class="normal"><a href="#__codelineno-14-6">6</a></span>
<span class="normal"><a href="#__codelineno-14-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">StartControllers</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">controllerCtx</span><span class="w"> </span><span class="nx">ControllerContext</span><span class="p">,</span><span class="w"> </span><span class="nx">startSATokenController</span><span class="w"> </span><span class="nx">InitFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">controllers</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">InitFunc</span><span class="p">,</span><span class="o">...</span><span class="p">){</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">controllerName</span><span class="p">,</span><span class="w"> </span><span class="nx">initFn</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">controllers</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">        </span><span class="c1">// ...</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">        </span><span class="nx">ctrl</span><span class="p">,</span><span class="w"> </span><span class="nx">started</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">initFn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">controllerCtx</span><span class="p">)</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">        </span><span class="c1">// ...</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>NewControllerInitializers</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewControllerInitializers</span><span class="p">(</span><span class="nx">loopMode</span><span class="w"> </span><span class="nx">ControllerLoopMode</span><span class="p">)</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">InitFunc</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">    </span><span class="nx">controllers</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">InitFunc</span><span class="p">{}</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;endpoint&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startEndpointController</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;endpointslice&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startEndpointSliceController</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;endpointslicemirroring&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startEndpointSliceMirroringController</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;replicationcontroller&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startReplicationController</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;podgc&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startPodGCController</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;resourcequota&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startResourceQuotaController</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;namespace&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startNamespaceController</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;serviceaccount&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startServiceAccountController</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;garbagecollector&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startGarbageCollectorController</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;daemonset&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startDaemonSetController</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;job&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startJobController</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;deployment&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startDeploymentController</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">    </span><span class="nx">controllers</span><span class="p">[</span><span class="s">&quot;replicaset&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">startReplicaSetController</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">    </span><span class="c1">//....</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">    </span><span class="c1">//....</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">controllers</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ol>
</div>
</div>
</div>
<h4 id="_9">实例化控制器<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><input id="__tabbed_5_3" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">startReplicaSetController</label><label for="__tabbed_5_2">.Informer()</label><label for="__tabbed_5_3">AddEventHandler</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span>
<span class="normal"><a href="#__codelineno-16-40">40</a></span>
<span class="normal"><a href="#__codelineno-16-41">41</a></span>
<span class="normal"><a href="#__codelineno-16-42">42</a></span>
<span class="normal"><a href="#__codelineno-16-43">43</a></span>
<span class="normal"><a href="#__codelineno-16-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">startReplicaSetController</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">controllerContext</span><span class="w"> </span><span class="nx">ControllerContext</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="nx">replicaset</span><span class="p">.</span><span class="nx">NewReplicaSetController</span><span class="p">(</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="hll"><span class="w">        </span><span class="nx">controllerContext</span><span class="p">.</span><span class="nx">InformerFactory</span><span class="p">.</span><span class="nx">Apps</span><span class="p">().</span><span class="nx">V1</span><span class="p">().</span><span class="nx">ReplicaSets</span><span class="p">(),</span><span class="w"> </span><span class="c1">//定义rs的informer</span>
</span></span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="hll"><span class="w">        </span><span class="nx">controllerContext</span><span class="p">.</span><span class="nx">InformerFactory</span><span class="p">.</span><span class="nx">Core</span><span class="p">().</span><span class="nx">V1</span><span class="p">().</span><span class="nx">Pods</span><span class="p">(),</span><span class="w">  </span><span class="c1">// rs 监控pod资源, 所以也需要pod的</span>
</span></span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">        </span><span class="nx">controllerContext</span><span class="p">.</span><span class="nx">ClientBuilder</span><span class="p">.</span><span class="nx">ClientOrDie</span><span class="p">(</span><span class="s">&quot;replicaset-controller&quot;</span><span class="p">),</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">        </span><span class="nx">replicaset</span><span class="p">.</span><span class="nx">BurstReplicas</span><span class="p">,</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="hll"><span class="w">    </span><span class="p">).</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nx">controllerContext</span><span class="p">.</span><span class="nx">ComponentConfig</span><span class="p">.</span><span class="nx">ReplicaSetController</span><span class="p">.</span><span class="nx">ConcurrentRSSyncs</span><span class="p">))</span>
</span></span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="p">}</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewReplicaSetController</span><span class="p">(</span><span class="nx">rsInformer</span><span class="w"> </span><span class="nx">appsinformers</span><span class="p">.</span><span class="nx">ReplicaSetInformer</span><span class="p">,</span><span class="w"> </span><span class="nx">podInformer</span><span class="w"> </span><span class="nx">coreinformers</span><span class="p">.</span><span class="nx">PodInformer</span><span class="p">,</span><span class="w"> </span><span class="nx">kubeClient</span><span class="w"> </span><span class="nx">clientset</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span><span class="w"> </span><span class="nx">burstReplicas</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">ReplicaSetController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NewBaseController</span><span class="p">(</span><span class="nx">rsInformer</span><span class="p">,</span><span class="w"> </span><span class="nx">podInformer</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="p">}</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewBaseController</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">ReplicaSetController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="w">    </span><span class="nx">rsc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">ReplicaSetController</span><span class="p">{</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="w">        </span><span class="nx">GroupVersionKind</span><span class="p">:</span><span class="w"> </span><span class="nx">gvk</span><span class="p">,</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="w">        </span><span class="nx">kubeClient</span><span class="p">:</span><span class="w">       </span><span class="nx">kubeClient</span><span class="p">,</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="w">        </span><span class="nx">podControl</span><span class="p">:</span><span class="w">       </span><span class="nx">podControl</span><span class="p">,</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="w">        </span><span class="nx">burstReplicas</span><span class="p">:</span><span class="w">    </span><span class="nx">burstReplicas</span><span class="p">,</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="w">        </span><span class="nx">expectations</span><span class="p">:</span><span class="w">     </span><span class="nx">controller</span><span class="p">.</span><span class="nx">NewUIDTrackingControllerExpectations</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">NewControllerExpectations</span><span class="p">()),</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="hll"><span class="w">        </span><span class="c1">// 工作队列, 消费DeltaFifo 时, 会先将数据放到这个工作队列</span>
</span></span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="hll"><span class="w">        </span><span class="nx">queue</span><span class="p">:</span><span class="w">            </span><span class="nx">workqueue</span><span class="p">.</span><span class="nx">NewNamedRateLimitingQueue</span><span class="p">(</span><span class="nx">workqueue</span><span class="p">.</span><span class="nx">DefaultControllerRateLimiter</span><span class="p">(),</span><span class="w"> </span><span class="nx">queueName</span><span class="p">),</span>
</span></span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="hll"><span class="w">    </span><span class="c1">// .Informer() 将会在 controllerContext.InformerFactory.informers 设置 .informers[informerType]=...</span>
</span></span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25"></a><span class="hll"><span class="w">    </span><span class="c1">// 消费DeltaFifo里rs资源时, 对应的事件处理方法</span>
</span></span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26"></a><span class="hll"><span class="w">    </span><span class="nx">rsInformer</span><span class="p">.</span><span class="nx">Informer</span><span class="p">().</span><span class="nx">AddEventHandler</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
</span></span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27"></a><span class="w">        </span><span class="nx">AddFunc</span><span class="p">:</span><span class="w">    </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">addRS</span><span class="p">,</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28"></a><span class="w">        </span><span class="nx">UpdateFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">updateRS</span><span class="p">,</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29"></a><span class="w">        </span><span class="nx">DeleteFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">deleteRS</span><span class="p">,</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31"></a><span class="w">    </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">rsLister</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">rsInformer</span><span class="p">.</span><span class="nx">Lister</span><span class="p">()</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32"></a><span class="w">    </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">rsListerSynced</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">rsInformer</span><span class="p">.</span><span class="nx">Informer</span><span class="p">().</span><span class="nx">HasSynced</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33"></a><span class="hll"><span class="w">    </span><span class="c1">// 消费DeltaFifo里pod资源时, 对应的事件处理方法</span>
</span></span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34"></a><span class="hll"><span class="w">    </span><span class="nx">podInformer</span><span class="p">.</span><span class="nx">Informer</span><span class="p">().</span><span class="nx">AddEventHandler</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
</span></span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35"></a><span class="w">        </span><span class="nx">AddFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">addPod</span><span class="p">,</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36"></a><span class="w">        </span><span class="nx">UpdateFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">updatePod</span><span class="p">,</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37"></a><span class="w">        </span><span class="nx">DeleteFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">deletePod</span><span class="p">,</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39"></a><span class="w">    </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">podLister</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">podInformer</span><span class="p">.</span><span class="nx">Lister</span><span class="p">()</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40"></a><span class="w">    </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">podListerSynced</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">podInformer</span><span class="p">.</span><span class="nx">Informer</span><span class="p">().</span><span class="nx">HasSynced</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41"></a>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42"></a><span class="hll"><span class="w">    </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">syncHandler</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">syncReplicaSet</span>
</span></span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">rsc</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span>
<span class="normal"><a href="#__codelineno-17-31">31</a></span>
<span class="normal"><a href="#__codelineno-17-32">32</a></span>
<span class="normal"><a href="#__codelineno-17-33">33</a></span>
<span class="normal"><a href="#__codelineno-17-34">34</a></span>
<span class="normal"><a href="#__codelineno-17-35">35</a></span>
<span class="normal"><a href="#__codelineno-17-36">36</a></span>
<span class="normal"><a href="#__codelineno-17-37">37</a></span>
<span class="normal"><a href="#__codelineno-17-38">38</a></span>
<span class="normal"><a href="#__codelineno-17-39">39</a></span>
<span class="normal"><a href="#__codelineno-17-40">40</a></span>
<span class="normal"><a href="#__codelineno-17-41">41</a></span>
<span class="normal"><a href="#__codelineno-17-42">42</a></span>
<span class="normal"><a href="#__codelineno-17-43">43</a></span>
<span class="normal"><a href="#__codelineno-17-44">44</a></span>
<span class="normal"><a href="#__codelineno-17-45">45</a></span>
<span class="normal"><a href="#__codelineno-17-46">46</a></span>
<span class="normal"><a href="#__codelineno-17-47">47</a></span>
<span class="normal"><a href="#__codelineno-17-48">48</a></span>
<span class="normal"><a href="#__codelineno-17-49">49</a></span>
<span class="normal"><a href="#__codelineno-17-50">50</a></span>
<span class="normal"><a href="#__codelineno-17-51">51</a></span>
<span class="normal"><a href="#__codelineno-17-52">52</a></span>
<span class="normal"><a href="#__codelineno-17-53">53</a></span>
<span class="normal"><a href="#__codelineno-17-54">54</a></span>
<span class="normal"><a href="#__codelineno-17-55">55</a></span>
<span class="normal"><a href="#__codelineno-17-56">56</a></span>
<span class="normal"><a href="#__codelineno-17-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">podInformer</span><span class="p">)</span><span class="w"> </span><span class="nx">Informer</span><span class="p">()</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">factory</span><span class="p">.</span><span class="nx">InformerFor</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{},</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">defaultInformer</span><span class="p">)</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="p">}</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="hll"><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">podInformer</span><span class="p">)</span><span class="w"> </span><span class="nx">defaultInformer</span><span class="p">(</span><span class="nx">client</span><span class="w"> </span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span><span class="w"> </span><span class="p">{</span>
</span></span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NewFilteredPodInformer</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span><span class="nx">f</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span><span class="nx">resyncPeriod</span><span class="p">,</span><span class="nx">cache</span><span class="p">.</span><span class="nx">Indexers</span><span class="p">{</span><span class="nx">cache</span><span class="p">.</span><span class="nx">NamespaceIndex</span><span class="p">:</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">MetaNamespaceIndexFunc</span><span class="p">},</span><span class="nx">f</span><span class="p">.</span><span class="nx">tweakListOptions</span><span class="p">)</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="p">}</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewFilteredIngressInformer</span><span class="p">(</span><span class="nx">client</span><span class="w"> </span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span><span class="w"> </span><span class="nx">namespace</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span><span class="w"> </span><span class="nx">indexers</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">Indexers</span><span class="p">,</span><span class="w"> </span><span class="nx">tweakListOptions</span><span class="w"> </span><span class="nx">internalinterfaces</span><span class="p">.</span><span class="nx">TweakListOptionsFunc</span><span class="p">)</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">NewSharedIndexInformer</span><span class="p">(</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="hll"><span class="w">        </span><span class="o">&amp;</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ListWatch</span><span class="p">{</span>
</span></span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">            </span><span class="nx">ListFunc</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">options</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">tweakListOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">                    </span><span class="nx">tweakListOptions</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">)</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">NetworkingV1</span><span class="p">().</span><span class="nx">Ingresses</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nx">List</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="w">            </span><span class="nx">WatchFunc</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">options</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">tweakListOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="w">                    </span><span class="nx">tweakListOptions</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">)</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">NetworkingV1</span><span class="p">().</span><span class="nx">Ingresses</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nx">Watch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="w">        </span><span class="o">&amp;</span><span class="nx">networkingv1</span><span class="p">.</span><span class="nx">Ingress</span><span class="p">{},</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="w">        </span><span class="nx">resyncPeriod</span><span class="p">,</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="w">        </span><span class="nx">indexers</span><span class="p">,</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28"></a><span class="p">}</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewSharedIndexInformer</span><span class="p">(</span><span class="nx">lw</span><span class="w"> </span><span class="nx">ListerWatcher</span><span class="p">,</span><span class="w"> </span><span class="nx">exampleObject</span><span class="w"> </span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span><span class="w"> </span><span class="nx">defaultEventHandlerResyncPeriod</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span><span class="w"> </span><span class="nx">indexers</span><span class="w"> </span><span class="nx">Indexers</span><span class="p">)</span><span class="w"> </span><span class="nx">SharedIndexInformer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30"></a><span class="w">    </span><span class="nx">realClock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">clock</span><span class="p">.</span><span class="nx">RealClock</span><span class="p">{}</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31"></a><span class="w">    </span><span class="nx">sharedIndexInformer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">sharedIndexInformer</span><span class="p">{</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32"></a><span class="hll"><span class="w">        </span><span class="nx">processor</span><span class="p">:</span><span class="w">                       </span><span class="o">&amp;</span><span class="nx">sharedProcessor</span><span class="p">{</span><span class="nx">clock</span><span class="p">:</span><span class="w"> </span><span class="nx">realClock</span><span class="p">},</span>
</span></span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33"></a><span class="w">        </span><span class="nx">indexer</span><span class="p">:</span><span class="w">                         </span><span class="nx">NewIndexer</span><span class="p">(</span><span class="nx">DeletionHandlingMetaNamespaceKeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">indexers</span><span class="p">),</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34"></a><span class="w">        </span><span class="nx">listerWatcher</span><span class="p">:</span><span class="w">                   </span><span class="nx">lw</span><span class="p">,</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35"></a><span class="w">        </span><span class="nx">objectType</span><span class="p">:</span><span class="w">                      </span><span class="nx">exampleObject</span><span class="p">,</span>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36"></a><span class="w">        </span><span class="nx">resyncCheckPeriod</span><span class="p">:</span><span class="w">               </span><span class="nx">defaultEventHandlerResyncPeriod</span><span class="p">,</span>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37"></a><span class="w">        </span><span class="nx">defaultEventHandlerResyncPeriod</span><span class="p">:</span><span class="w"> </span><span class="nx">defaultEventHandlerResyncPeriod</span><span class="p">,</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38"></a><span class="w">        </span><span class="nx">cacheMutationDetector</span><span class="p">:</span><span class="w">           </span><span class="nx">NewCacheMutationDetector</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%T&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">exampleObject</span><span class="p">)),</span>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39"></a><span class="w">        </span><span class="nx">clock</span><span class="p">:</span><span class="w">                           </span><span class="nx">realClock</span><span class="p">,</span>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sharedIndexInformer</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42"></a><span class="p">}</span>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43"></a>
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewIndexer</span><span class="p">(</span><span class="nx">keyFunc</span><span class="w"> </span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">indexers</span><span class="w"> </span><span class="nx">Indexers</span><span class="p">)</span><span class="w"> </span><span class="nx">Indexer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">cache</span><span class="p">{</span>
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46"></a><span class="hll"><span class="w">        </span><span class="nx">cacheStorage</span><span class="p">:</span><span class="w"> </span><span class="nx">NewThreadSafeStore</span><span class="p">(</span><span class="nx">indexers</span><span class="p">,</span><span class="w"> </span><span class="nx">Indices</span><span class="p">{}),</span>
</span></span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47"></a><span class="w">        </span><span class="nx">keyFunc</span><span class="p">:</span><span class="w">      </span><span class="nx">keyFunc</span><span class="p">,</span>
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-49"><a id="__codelineno-17-49" name="__codelineno-17-49"></a><span class="p">}</span>
</span><span id="__span-17-50"><a id="__codelineno-17-50" name="__codelineno-17-50"></a>
</span><span id="__span-17-51"><a id="__codelineno-17-51" name="__codelineno-17-51"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewThreadSafeStore</span><span class="p">(</span><span class="nx">indexers</span><span class="w"> </span><span class="nx">Indexers</span><span class="p">,</span><span class="w"> </span><span class="nx">indices</span><span class="w"> </span><span class="nx">Indices</span><span class="p">)</span><span class="w"> </span><span class="nx">ThreadSafeStore</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-52"><a id="__codelineno-17-52" name="__codelineno-17-52"></a><span class="hll"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">threadSafeMap</span><span class="p">{</span>
</span></span><span id="__span-17-53"><a id="__codelineno-17-53" name="__codelineno-17-53"></a><span class="w">        </span><span class="nx">items</span><span class="p">:</span><span class="w">    </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{},</span>
</span><span id="__span-17-54"><a id="__codelineno-17-54" name="__codelineno-17-54"></a><span class="w">        </span><span class="nx">indexers</span><span class="p">:</span><span class="w"> </span><span class="nx">indexers</span><span class="p">,</span>
</span><span id="__span-17-55"><a id="__codelineno-17-55" name="__codelineno-17-55"></a><span class="w">        </span><span class="nx">indices</span><span class="p">:</span><span class="w">  </span><span class="nx">indices</span><span class="p">,</span>
</span><span id="__span-17-56"><a id="__codelineno-17-56" name="__codelineno-17-56"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-57"><a id="__codelineno-17-57" name="__codelineno-17-57"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<p>我们在.Informer() 中初始化了 processor<br>
在AddEventHandler 添加了 Listener</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span>
<span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span>
<span class="normal"><a href="#__codelineno-18-29">29</a></span>
<span class="normal"><a href="#__codelineno-18-30">30</a></span>
<span class="normal"><a href="#__codelineno-18-31">31</a></span>
<span class="normal"><a href="#__codelineno-18-32">32</a></span>
<span class="normal"><a href="#__codelineno-18-33">33</a></span>
<span class="normal"><a href="#__codelineno-18-34">34</a></span>
<span class="normal"><a href="#__codelineno-18-35">35</a></span>
<span class="normal"><a href="#__codelineno-18-36">36</a></span>
<span class="normal"><a href="#__codelineno-18-37">37</a></span>
<span class="normal"><a href="#__codelineno-18-38">38</a></span>
<span class="normal"><a href="#__codelineno-18-39">39</a></span>
<span class="normal"><a href="#__codelineno-18-40">40</a></span>
<span class="normal"><a href="#__codelineno-18-41">41</a></span>
<span class="normal"><a href="#__codelineno-18-42">42</a></span>
<span class="normal"><a href="#__codelineno-18-43">43</a></span>
<span class="normal"><a href="#__codelineno-18-44">44</a></span>
<span class="normal"><a href="#__codelineno-18-45">45</a></span>
<span class="normal"><a href="#__codelineno-18-46">46</a></span>
<span class="normal"><a href="#__codelineno-18-47">47</a></span>
<span class="normal"><a href="#__codelineno-18-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">sharedIndexInformer</span><span class="p">)</span><span class="w"> </span><span class="nx">AddEventHandler</span><span class="p">(</span><span class="nx">handler</span><span class="w"> </span><span class="nx">ResourceEventHandler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">AddEventHandlerWithResyncPeriod</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">defaultEventHandlerResyncPeriod</span><span class="p">)</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="p">}</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">sharedIndexInformer</span><span class="p">)</span><span class="w"> </span><span class="nx">AddEventHandlerWithResyncPeriod</span><span class="p">(</span><span class="nx">handler</span><span class="w"> </span><span class="nx">ResourceEventHandler</span><span class="p">,</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">startedLock</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">startedLock</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">stopped</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">        </span><span class="nx">klog</span><span class="p">.</span><span class="nx">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">Infof</span><span class="p">(</span><span class="s">&quot;Handler %v was not added to shared informer because it has stopped already&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">handler</span><span class="p">)</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="w">        </span><span class="k">return</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13"></a>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">minimumResyncPeriod</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="w">            </span><span class="nx">klog</span><span class="p">.</span><span class="nx">Warningf</span><span class="p">(</span><span class="s">&quot;resyncPeriod %v is too small. Changing it to the minimum allowed value of %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="p">,</span><span class="w"> </span><span class="nx">minimumResyncPeriod</span><span class="p">)</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="w">            </span><span class="nx">resyncPeriod</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">minimumResyncPeriod</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19"></a>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">resyncCheckPeriod</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">started</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22"></a><span class="w">                </span><span class="nx">klog</span><span class="p">.</span><span class="nx">Warningf</span><span class="p">(</span><span class="s">&quot;resyncPeriod %v is smaller than resyncCheckPeriod %v and the informer has already started. Changing it to %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">resyncCheckPeriod</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">resyncCheckPeriod</span><span class="p">)</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23"></a><span class="w">                </span><span class="nx">resyncPeriod</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">resyncCheckPeriod</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25"></a><span class="w">                </span><span class="c1">// if the event handler&#39;s resyncPeriod is smaller than the current resyncCheckPeriod, update</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26"></a><span class="w">                </span><span class="c1">// resyncCheckPeriod to match resyncPeriod and adjust the resync periods of all the listeners</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27"></a><span class="w">                </span><span class="c1">// accordingly</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28"></a><span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">resyncCheckPeriod</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">resyncPeriod</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29"></a><span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">resyncCheckPeriodChanged</span><span class="p">(</span><span class="nx">resyncPeriod</span><span class="p">)</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33"></a>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34"></a><span class="w">    </span><span class="nx">listener</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newProcessListener</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="p">,</span><span class="w"> </span><span class="nx">determineResyncPeriod</span><span class="p">(</span><span class="nx">resyncPeriod</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">resyncCheckPeriod</span><span class="p">),</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">clock</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span><span class="w"> </span><span class="nx">initialBufferSize</span><span class="p">)</span>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35"></a>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">started</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-37"><a id="__codelineno-18-37" name="__codelineno-18-37"></a><span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="nx">listener</span><span class="p">)</span>
</span><span id="__span-18-38"><a id="__codelineno-18-38" name="__codelineno-18-38"></a><span class="w">        </span><span class="k">return</span>
</span><span id="__span-18-39"><a id="__codelineno-18-39" name="__codelineno-18-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-18-40"><a id="__codelineno-18-40" name="__codelineno-18-40"></a>
</span><span id="__span-18-41"><a id="__codelineno-18-41" name="__codelineno-18-41"></a><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">blockDeltas</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</span><span id="__span-18-42"><a id="__codelineno-18-42" name="__codelineno-18-42"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">blockDeltas</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</span><span id="__span-18-43"><a id="__codelineno-18-43" name="__codelineno-18-43"></a>
</span><span id="__span-18-44"><a id="__codelineno-18-44" name="__codelineno-18-44"></a><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="nx">listener</span><span class="p">)</span>
</span><span id="__span-18-45"><a id="__codelineno-18-45" name="__codelineno-18-45"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nx">List</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-46"><a id="__codelineno-18-46" name="__codelineno-18-46"></a><span class="w">        </span><span class="nx">listener</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">addNotification</span><span class="p">{</span><span class="nx">newObj</span><span class="p">:</span><span class="w"> </span><span class="nx">item</span><span class="p">})</span>
</span><span id="__span-18-47"><a id="__codelineno-18-47" name="__codelineno-18-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-18-48"><a id="__codelineno-18-48" name="__codelineno-18-48"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h4 id="run">控制器.Run()<a class="headerlink" href="#run" title="Permanent link">&para;</a></h4>
<div class="tabbed-set tabbed-alternate" data-tabs="6:3"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><input id="__tabbed_6_3" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Run()</label><label for="__tabbed_6_2">worker()</label><label for="__tabbed_6_3">processNextWorkItem()</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">rsc</span><span class="w"> </span><span class="o">*</span><span class="nx">ReplicaSetController</span><span class="p">)</span><span class="w"> </span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">cache</span><span class="p">.</span><span class="nx">WaitForNamedCacheSync</span><span class="p">(</span><span class="nx">rsc</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">(),</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">podListerSynced</span><span class="p">,</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">rsListerSynced</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">        </span><span class="k">return</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6"></a>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">workers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">        </span><span class="c1">// worker</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="nx">wait</span><span class="p">.</span><span class="nx">UntilWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">worker</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11"></a>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="w">    </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span>
<span class="normal"><a href="#__codelineno-20-3">3</a></span>
<span class="normal"><a href="#__codelineno-20-4">4</a></span>
<span class="normal"><a href="#__codelineno-20-5">5</a></span>
<span class="normal"><a href="#__codelineno-20-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1">// worker runs a worker thread that just dequeues items, processes them, and marks them done.</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="c1">// It enforces that the syncHandler is never invoked concurrently with the same key.</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">rsc</span><span class="w"> </span><span class="o">*</span><span class="nx">ReplicaSetController</span><span class="p">)</span><span class="w"> </span><span class="nx">worker</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">processNextWorkItem</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span>
<span class="normal"><a href="#__codelineno-21-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">rsc</span><span class="w"> </span><span class="o">*</span><span class="nx">ReplicaSetController</span><span class="p">)</span><span class="w"> </span><span class="nx">processNextWorkItem</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">    </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">quit</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">Get</span><span class="p">()</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">quit</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">Done</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7"></a>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">syncHandler</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">.(</span><span class="kt">string</span><span class="p">))</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="w">        </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">Forget</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13"></a>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14"></a><span class="w">    </span><span class="nx">utilruntime</span><span class="p">.</span><span class="nx">HandleError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;sync %q failed with %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">))</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15"></a><span class="w">    </span><span class="nx">rsc</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">AddRateLimited</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16"></a>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h4 id="informerrun">informer.run()<a class="headerlink" href="#informerrun" title="Permanent link">&para;</a></h4>
<!-- === "informer.Run" -->

<div class="language-go highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">informer.Run</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span>
<span class="normal"><a href="#__codelineno-22-18">18</a></span>
<span class="normal"><a href="#__codelineno-22-19">19</a></span>
<span class="normal"><a href="#__codelineno-22-20">20</a></span>
<span class="normal"><a href="#__codelineno-22-21">21</a></span>
<span class="normal"><a href="#__codelineno-22-22">22</a></span>
<span class="normal"><a href="#__codelineno-22-23">23</a></span>
<span class="normal"><a href="#__codelineno-22-24">24</a></span>
<span class="normal"><a href="#__codelineno-22-25">25</a></span>
<span class="normal"><a href="#__codelineno-22-26">26</a></span>
<span class="normal"><a href="#__codelineno-22-27">27</a></span>
<span class="normal"><a href="#__codelineno-22-28">28</a></span>
<span class="normal"><a href="#__codelineno-22-29">29</a></span>
<span class="normal"><a href="#__codelineno-22-30">30</a></span>
<span class="normal"><a href="#__codelineno-22-31">31</a></span>
<span class="normal"><a href="#__codelineno-22-32">32</a></span>
<span class="normal"><a href="#__codelineno-22-33">33</a></span>
<span class="normal"><a href="#__codelineno-22-34">34</a></span>
<span class="normal"><a href="#__codelineno-22-35">35</a></span>
<span class="normal"><a href="#__codelineno-22-36">36</a></span>
<span class="normal"><a href="#__codelineno-22-37">37</a></span>
<span class="normal"><a href="#__codelineno-22-38">38</a></span>
<span class="normal"><a href="#__codelineno-22-39">39</a></span>
<span class="normal"><a href="#__codelineno-22-40">40</a></span>
<span class="normal"><a href="#__codelineno-22-41">41</a></span>
<span class="normal"><a href="#__codelineno-22-42">42</a></span>
<span class="normal"><a href="#__codelineno-22-43">43</a></span>
<span class="normal"><a href="#__codelineno-22-44">44</a></span>
<span class="normal"><a href="#__codelineno-22-45">45</a></span>
<span class="normal"><a href="#__codelineno-22-46">46</a></span>
<span class="normal"><a href="#__codelineno-22-47">47</a></span>
<span class="normal"><a href="#__codelineno-22-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">sharedIndexInformer</span><span class="p">)</span><span class="w"> </span><span class="nx">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">HasStarted</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span></span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">        </span><span class="c1">// 可以 想到, 这就和前面的 设计是一致的</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">        </span><span class="c1">// 同类型资源的informer 如果已经启动了, 就不用启动了.</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">        </span><span class="k">return</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">    </span><span class="c1">// 初始化 DeltaFIFO</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="hll"><span class="w">    </span><span class="nx">fifo</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewDeltaFIFOWithOptions</span><span class="p">(</span><span class="nx">DeltaFIFOOptions</span><span class="p">{</span>
</span></span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="w">        </span><span class="nx">KnownObjects</span><span class="p">:</span><span class="w">          </span><span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">,</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">        </span><span class="nx">EmitDeltaTypeReplaced</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13"></a>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="w">    </span><span class="nx">cfg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Config</span><span class="p">{</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="hll"><span class="w">        </span><span class="nx">Queue</span><span class="p">:</span><span class="w">            </span><span class="nx">fifo</span><span class="p">,</span>
</span></span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="hll"><span class="w">        </span><span class="nx">ListerWatcher</span><span class="p">:</span><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">listerWatcher</span><span class="p">,</span>
</span></span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="w">        </span><span class="nx">ObjectType</span><span class="p">:</span><span class="w">       </span><span class="nx">s</span><span class="p">.</span><span class="nx">objectType</span><span class="p">,</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="w">        </span><span class="nx">FullResyncPeriod</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">resyncCheckPeriod</span><span class="p">,</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="w">        </span><span class="nx">RetryOnError</span><span class="p">:</span><span class="w">     </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20"></a><span class="w">        </span><span class="nx">ShouldResync</span><span class="p">:</span><span class="w">     </span><span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">shouldResync</span><span class="p">,</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21"></a><span class="hll"><span class="w">        </span><span class="nx">Process</span><span class="p">:</span><span class="w">           </span><span class="nx">s</span><span class="p">.</span><span class="nx">HandleDeltas</span><span class="p">,</span>
</span></span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22"></a><span class="w">        </span><span class="nx">WatchErrorHandler</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">watchErrorHandler</span><span class="p">,</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24"></a>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25"></a><span class="w">    </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26"></a><span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">startedLock</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27"></a><span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">startedLock</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28"></a>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29"></a><span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">controller</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">New</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30"></a><span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">controller</span><span class="p">.(</span><span class="o">*</span><span class="nx">controller</span><span class="p">).</span><span class="nx">clock</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">clock</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31"></a><span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">started</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c1">// HasStarted()</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32"></a><span class="w">    </span><span class="p">}()</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33"></a>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34"></a><span class="w">    </span><span class="c1">// Separate stop channel because Processor should be stopped strictly after controller</span>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35"></a><span class="w">    </span><span class="nx">processorStopCh</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">wait</span><span class="p">.</span><span class="nx">Group</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span><span class="w">              </span><span class="c1">// Wait for Processor to stop</span>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nb">close</span><span class="p">(</span><span class="nx">processorStopCh</span><span class="p">)</span><span class="w"> </span><span class="c1">// Tell Processor to stop</span>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39"></a><span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">StartWithChannel</span><span class="p">(</span><span class="nx">processorStopCh</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cacheMutationDetector</span><span class="p">.</span><span class="nx">Run</span><span class="p">)</span>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40"></a><span class="hll"><span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">StartWithChannel</span><span class="p">(</span><span class="nx">processorStopCh</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">run</span><span class="p">)</span><span class="w"> </span><span class="c1">//</span>
</span></span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41"></a>
</span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-43"><a id="__codelineno-22-43" name="__codelineno-22-43"></a><span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">startedLock</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</span><span id="__span-22-44"><a id="__codelineno-22-44" name="__codelineno-22-44"></a><span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">startedLock</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</span><span id="__span-22-45"><a id="__codelineno-22-45" name="__codelineno-22-45"></a><span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">stopped</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c1">// Don&#39;t want any new listeners</span>
</span><span id="__span-22-46"><a id="__codelineno-22-46" name="__codelineno-22-46"></a><span class="w">    </span><span class="p">}()</span>
</span><span id="__span-22-47"><a id="__codelineno-22-47" name="__codelineno-22-47"></a><span class="hll"><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span></span><span id="__span-22-48"><a id="__codelineno-22-48" name="__codelineno-22-48"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<!-- --- -->
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">controller.Run</label><label for="__tabbed_7_2">s.processor.run</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span>
<span class="normal"><a href="#__codelineno-23-21">21</a></span>
<span class="normal"><a href="#__codelineno-23-22">22</a></span>
<span class="normal"><a href="#__codelineno-23-23">23</a></span>
<span class="normal"><a href="#__codelineno-23-24">24</a></span>
<span class="normal"><a href="#__codelineno-23-25">25</a></span>
<span class="normal"><a href="#__codelineno-23-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">controller</span><span class="p">)</span><span class="w"> </span><span class="nx">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="w">    </span><span class="nx">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewReflector</span><span class="p">(</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="hll"><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ListerWatcher</span><span class="p">,</span>
</span></span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ObjectType</span><span class="p">,</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="hll"><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Queue</span><span class="p">,</span><span class="w">  </span><span class="c1">// 这是r.store 是 前面定义的DeltaFIFO</span>
</span></span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">FullResyncPeriod</span><span class="p">,</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">    </span><span class="nx">r</span><span class="p">.</span><span class="nx">ShouldResync</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ShouldResync</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">    </span><span class="nx">r</span><span class="p">.</span><span class="nx">WatchListPageSize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">WatchListPageSize</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="w">    </span><span class="nx">r</span><span class="p">.</span><span class="nx">clock</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">clock</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">WatchErrorHandler</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">        </span><span class="nx">r</span><span class="p">.</span><span class="nx">watchErrorHandler</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">WatchErrorHandler</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15"></a>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">reflectorMutex</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="hll"><span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">reflector</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">r</span>
</span></span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18"></a><span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">reflectorMutex</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19"></a>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">wait</span><span class="p">.</span><span class="nx">Group</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21"></a>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="hll"><span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">StartWithChannel</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">)</span>
</span></span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="w">    </span><span class="c1">// processLoop 消费DeltaFifo的方法</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24"></a><span class="hll"><span class="w">    </span><span class="nx">wait</span><span class="p">.</span><span class="nx">Until</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">processLoop</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="w"> </span><span class="nx">stopCh</span><span class="p">)</span>
</span></span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25"></a><span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="tabbed-set tabbed-alternate" data-tabs="8:2"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">r.Run</label><label for="__tabbed_8_2">controller.processLoop</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span>
<span class="normal"><a href="#__codelineno-24-3">3</a></span>
<span class="normal"><a href="#__codelineno-24-4">4</a></span>
<span class="normal"><a href="#__codelineno-24-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Group</span><span class="p">)</span><span class="w"> </span><span class="nx">StartWithChannel</span><span class="p">(</span><span class="nx">stopCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{},</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">stopCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="w">    </span><span class="nx">g</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">        </span><span class="nx">f</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span>
<span class="normal"><a href="#__codelineno-25-3">3</a></span>
<span class="normal"><a href="#__codelineno-25-4">4</a></span>
<span class="normal"><a href="#__codelineno-25-5">5</a></span>
<span class="normal"><a href="#__codelineno-25-6">6</a></span>
<span class="normal"><a href="#__codelineno-25-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">Reflector</span><span class="p">)</span><span class="w"> </span><span class="nx">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="w">    </span><span class="nx">wait</span><span class="p">.</span><span class="nx">BackoffUntil</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">ListAndWatch</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span></span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">            </span><span class="nx">r</span><span class="p">.</span><span class="nx">watchErrorHandler</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">backoffManager</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:4"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><input id="__tabbed_9_2" name="__tabbed_9" type="radio" /><input id="__tabbed_9_3" name="__tabbed_9" type="radio" /><input id="__tabbed_9_4" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">r.ListAndWatch</label><label for="__tabbed_9_2">r.listerWatcher.List/Watch</label><label for="__tabbed_9_3">pager.List()</label><label for="__tabbed_9_4">r.watchHandler</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">  1</a></span>
<span class="normal"><a href="#__codelineno-26-2">  2</a></span>
<span class="normal"><a href="#__codelineno-26-3">  3</a></span>
<span class="normal"><a href="#__codelineno-26-4">  4</a></span>
<span class="normal"><a href="#__codelineno-26-5">  5</a></span>
<span class="normal"><a href="#__codelineno-26-6">  6</a></span>
<span class="normal"><a href="#__codelineno-26-7">  7</a></span>
<span class="normal"><a href="#__codelineno-26-8">  8</a></span>
<span class="normal"><a href="#__codelineno-26-9">  9</a></span>
<span class="normal"><a href="#__codelineno-26-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-26-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-26-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-26-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-26-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-26-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-26-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-26-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-26-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-26-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-26-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-26-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-26-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-26-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-26-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-26-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-26-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-26-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-26-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-26-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-26-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-26-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-26-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-26-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-26-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-26-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-26-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-26-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-26-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-26-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-26-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-26-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-26-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-26-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-26-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-26-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-26-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-26-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-26-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-26-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-26-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-26-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-26-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-26-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-26-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-26-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-26-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-26-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-26-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-26-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-26-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-26-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-26-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-26-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-26-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-26-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-26-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-26-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-26-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-26-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-26-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-26-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-26-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-26-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-26-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-26-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-26-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-26-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-26-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-26-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-26-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-26-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-26-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-26-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-26-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-26-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-26-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-26-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-26-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-26-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-26-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-26-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-26-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-26-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-26-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-26-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-26-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-26-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-26-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-26-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-26-100">100</a></span>
<span class="normal"><a href="#__codelineno-26-101">101</a></span>
<span class="normal"><a href="#__codelineno-26-102">102</a></span>
<span class="normal"><a href="#__codelineno-26-103">103</a></span>
<span class="normal"><a href="#__codelineno-26-104">104</a></span>
<span class="normal"><a href="#__codelineno-26-105">105</a></span>
<span class="normal"><a href="#__codelineno-26-106">106</a></span>
<span class="normal"><a href="#__codelineno-26-107">107</a></span>
<span class="normal"><a href="#__codelineno-26-108">108</a></span>
<span class="normal"><a href="#__codelineno-26-109">109</a></span>
<span class="normal"><a href="#__codelineno-26-110">110</a></span>
<span class="normal"><a href="#__codelineno-26-111">111</a></span>
<span class="normal"><a href="#__codelineno-26-112">112</a></span>
<span class="normal"><a href="#__codelineno-26-113">113</a></span>
<span class="normal"><a href="#__codelineno-26-114">114</a></span>
<span class="normal"><a href="#__codelineno-26-115">115</a></span>
<span class="normal"><a href="#__codelineno-26-116">116</a></span>
<span class="normal"><a href="#__codelineno-26-117">117</a></span>
<span class="normal"><a href="#__codelineno-26-118">118</a></span>
<span class="normal"><a href="#__codelineno-26-119">119</a></span>
<span class="normal"><a href="#__codelineno-26-120">120</a></span>
<span class="normal"><a href="#__codelineno-26-121">121</a></span>
<span class="normal"><a href="#__codelineno-26-122">122</a></span>
<span class="normal"><a href="#__codelineno-26-123">123</a></span>
<span class="normal"><a href="#__codelineno-26-124">124</a></span>
<span class="normal"><a href="#__codelineno-26-125">125</a></span>
<span class="normal"><a href="#__codelineno-26-126">126</a></span>
<span class="normal"><a href="#__codelineno-26-127">127</a></span>
<span class="normal"><a href="#__codelineno-26-128">128</a></span>
<span class="normal"><a href="#__codelineno-26-129">129</a></span>
<span class="normal"><a href="#__codelineno-26-130">130</a></span>
<span class="normal"><a href="#__codelineno-26-131">131</a></span>
<span class="normal"><a href="#__codelineno-26-132">132</a></span>
<span class="normal"><a href="#__codelineno-26-133">133</a></span>
<span class="normal"><a href="#__codelineno-26-134">134</a></span>
<span class="normal"><a href="#__codelineno-26-135">135</a></span>
<span class="normal"><a href="#__codelineno-26-136">136</a></span>
<span class="normal"><a href="#__codelineno-26-137">137</a></span>
<span class="normal"><a href="#__codelineno-26-138">138</a></span>
<span class="normal"><a href="#__codelineno-26-139">139</a></span>
<span class="normal"><a href="#__codelineno-26-140">140</a></span>
<span class="normal"><a href="#__codelineno-26-141">141</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">Reflector</span><span class="p">)</span><span class="w"> </span><span class="nx">ListAndWatch</span><span class="p">(</span><span class="nx">stopCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">resourceVersion</span><span class="w"> </span><span class="kt">string</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="hll"><span class="w">    </span><span class="nx">options</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span><span class="nx">ResourceVersion</span><span class="p">:</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">relistResourceVersion</span><span class="p">()}</span>
</span></span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5"></a>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="nx">initTrace</span><span class="p">.</span><span class="nx">LogIfLong</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">paginatedResult</span><span class="w"> </span><span class="kt">bool</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="w">        </span><span class="nx">listCh</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{},</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="w">        </span><span class="nx">panicCh</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="w">            </span><span class="k">defer</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">recover</span><span class="p">();</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="w">                    </span><span class="nx">panicCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">r</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18"></a><span class="w">            </span><span class="p">}()</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19"></a><span class="hll"><span class="w">            </span><span class="nx">pager</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">pager</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">pager</span><span class="p">.</span><span class="nx">SimplePageFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">opts</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span></span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20"></a><span class="w">                </span><span class="c1">// r.listerWatcher 来至c.config.ListerWatcher</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21"></a><span class="w">                </span><span class="c1">// c.config.ListerWatcher 来至 sharedIndexInformer.listerWatcher</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="w">                </span><span class="c1">// 全量拉取数据, 配合后面的Watch 获取增量更新</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23"></a><span class="hll"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">listerWatcher</span><span class="p">.</span><span class="nx">List</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>
</span></span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24"></a><span class="w">            </span><span class="p">}))</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25"></a><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">WatchListPageSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27"></a><span class="w">                </span><span class="nx">pager</span><span class="p">.</span><span class="nx">PageSize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">WatchListPageSize</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">paginatedResult</span><span class="p">:</span>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">ResourceVersion</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">ResourceVersion</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="p">:</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30"></a><span class="w">                </span><span class="nx">pager</span><span class="p">.</span><span class="nx">PageSize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32"></a>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33"></a><span class="hll"><span class="w">            </span><span class="nx">list</span><span class="p">,</span><span class="w"> </span><span class="nx">paginatedResult</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">pager</span><span class="p">.</span><span class="nx">List</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span>
</span></span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">isExpiredError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">isTooLargeResourceVersionError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35"></a><span class="w">                </span><span class="c1">// 设置 true时, 下面的 r.relistResourceVersion() 将得到ResourceVersion=&quot;&quot;</span>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36"></a><span class="w">                </span><span class="nx">r</span><span class="p">.</span><span class="nx">setIsLastSyncResourceVersionUnavailable</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37"></a><span class="hll"><span class="w">                </span><span class="nx">list</span><span class="p">,</span><span class="w"> </span><span class="nx">paginatedResult</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">pager</span><span class="p">.</span><span class="nx">List</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span><span class="nx">ResourceVersion</span><span class="p">:</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">relistResourceVersion</span><span class="p">()})</span>
</span></span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39"></a><span class="w">            </span><span class="nb">close</span><span class="p">(</span><span class="nx">listCh</span><span class="p">)</span>
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40"></a><span class="w">        </span><span class="p">}()</span>
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41"></a><span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">stopCh</span><span class="p">:</span>
</span><span id="__span-26-43"><a id="__codelineno-26-43" name="__codelineno-26-43"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-26-44"><a id="__codelineno-26-44" name="__codelineno-26-44"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">panicCh</span><span class="p">:</span>
</span><span id="__span-26-45"><a id="__codelineno-26-45" name="__codelineno-26-45"></a><span class="w">            </span><span class="nb">panic</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span><span id="__span-26-46"><a id="__codelineno-26-46" name="__codelineno-26-46"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">listCh</span><span class="p">:</span>
</span><span id="__span-26-47"><a id="__codelineno-26-47" name="__codelineno-26-47"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-48"><a id="__codelineno-26-48" name="__codelineno-26-48"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-49"><a id="__codelineno-26-49" name="__codelineno-26-49"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span>
</span><span id="__span-26-50"><a id="__codelineno-26-50" name="__codelineno-26-50"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-51"><a id="__codelineno-26-51" name="__codelineno-26-51"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">ResourceVersion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">paginatedResult</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-52"><a id="__codelineno-26-52" name="__codelineno-26-52"></a><span class="w">            </span><span class="nx">r</span><span class="p">.</span><span class="nx">paginatedResult</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-26-53"><a id="__codelineno-26-53" name="__codelineno-26-53"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-54"><a id="__codelineno-26-54" name="__codelineno-26-54"></a><span class="w">        </span><span class="nx">r</span><span class="p">.</span><span class="nx">setIsLastSyncResourceVersionUnavailable</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="c1">// list was successful</span>
</span><span id="__span-26-55"><a id="__codelineno-26-55" name="__codelineno-26-55"></a><span class="w">        </span><span class="nx">listMetaInterface</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">ListAccessor</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span>
</span><span id="__span-26-56"><a id="__codelineno-26-56" name="__codelineno-26-56"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-57"><a id="__codelineno-26-57" name="__codelineno-26-57"></a><span class="w">            </span><span class="k">return</span>
</span><span id="__span-26-58"><a id="__codelineno-26-58" name="__codelineno-26-58"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-59"><a id="__codelineno-26-59" name="__codelineno-26-59"></a><span class="w">        </span><span class="nx">resourceVersion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">listMetaInterface</span><span class="p">.</span><span class="nx">GetResourceVersion</span><span class="p">()</span>
</span><span id="__span-26-60"><a id="__codelineno-26-60" name="__codelineno-26-60"></a><span class="w">        </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">ExtractList</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span>
</span><span id="__span-26-61"><a id="__codelineno-26-61" name="__codelineno-26-61"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-62"><a id="__codelineno-26-62" name="__codelineno-26-62"></a><span class="w">            </span><span class="k">return</span>
</span><span id="__span-26-63"><a id="__codelineno-26-63" name="__codelineno-26-63"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-64"><a id="__codelineno-26-64" name="__codelineno-26-64"></a><span class="w">        </span><span class="c1">// 将资源对象列表中的资源对象和资源版本号存储至DeltaFIFO中,会替换已存在的对象</span>
</span><span id="__span-26-65"><a id="__codelineno-26-65" name="__codelineno-26-65"></a><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">syncWith</span><span class="p">(</span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">resourceVersion</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span></span><span id="__span-26-66"><a id="__codelineno-26-66" name="__codelineno-26-66"></a><span class="w">            </span><span class="k">return</span>
</span><span id="__span-26-67"><a id="__codelineno-26-67" name="__codelineno-26-67"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-68"><a id="__codelineno-26-68" name="__codelineno-26-68"></a><span class="w">        </span><span class="c1">// 设置最后同步的资源版本号</span>
</span><span id="__span-26-69"><a id="__codelineno-26-69" name="__codelineno-26-69"></a><span class="hll"><span class="w">        </span><span class="nx">r</span><span class="p">.</span><span class="nx">setLastSyncResourceVersion</span><span class="p">(</span><span class="nx">resourceVersion</span><span class="p">)</span>
</span></span><span id="__span-26-70"><a id="__codelineno-26-70" name="__codelineno-26-70"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-26-71"><a id="__codelineno-26-71" name="__codelineno-26-71"></a><span class="w">    </span><span class="p">}();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-72"><a id="__codelineno-26-72" name="__codelineno-26-72"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-26-73"><a id="__codelineno-26-73" name="__codelineno-26-73"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-74"><a id="__codelineno-26-74" name="__codelineno-26-74"></a>
</span><span id="__span-26-75"><a id="__codelineno-26-75" name="__codelineno-26-75"></a><span class="w">    </span><span class="nx">resyncerrc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-76"><a id="__codelineno-26-76" name="__codelineno-26-76"></a><span class="w">    </span><span class="nx">cancelCh</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span>
</span><span id="__span-26-77"><a id="__codelineno-26-77" name="__codelineno-26-77"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nb">close</span><span class="p">(</span><span class="nx">cancelCh</span><span class="p">)</span>
</span><span id="__span-26-78"><a id="__codelineno-26-78" name="__codelineno-26-78"></a><span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-79"><a id="__codelineno-26-79" name="__codelineno-26-79"></a><span class="w">        </span><span class="nx">resyncCh</span><span class="p">,</span><span class="w"> </span><span class="nx">cleanup</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">resyncChan</span><span class="p">()</span>
</span><span id="__span-26-80"><a id="__codelineno-26-80" name="__codelineno-26-80"></a><span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-81"><a id="__codelineno-26-81" name="__codelineno-26-81"></a><span class="w">            </span><span class="nx">cleanup</span><span class="p">()</span><span class="w"> </span><span class="c1">// Call the last one written into cleanup</span>
</span><span id="__span-26-82"><a id="__codelineno-26-82" name="__codelineno-26-82"></a><span class="w">        </span><span class="p">}()</span>
</span><span id="__span-26-83"><a id="__codelineno-26-83" name="__codelineno-26-83"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-84"><a id="__codelineno-26-84" name="__codelineno-26-84"></a><span class="w">            </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-85"><a id="__codelineno-26-85" name="__codelineno-26-85"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">resyncCh</span><span class="p">:</span>
</span><span id="__span-26-86"><a id="__codelineno-26-86" name="__codelineno-26-86"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">stopCh</span><span class="p">:</span>
</span><span id="__span-26-87"><a id="__codelineno-26-87" name="__codelineno-26-87"></a><span class="w">                </span><span class="k">return</span>
</span><span id="__span-26-88"><a id="__codelineno-26-88" name="__codelineno-26-88"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">cancelCh</span><span class="p">:</span>
</span><span id="__span-26-89"><a id="__codelineno-26-89" name="__codelineno-26-89"></a><span class="w">                </span><span class="k">return</span>
</span><span id="__span-26-90"><a id="__codelineno-26-90" name="__codelineno-26-90"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-26-91"><a id="__codelineno-26-91" name="__codelineno-26-91"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">ShouldResync</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">ShouldResync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-92"><a id="__codelineno-26-92" name="__codelineno-26-92"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">Resync</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-93"><a id="__codelineno-26-93" name="__codelineno-26-93"></a><span class="w">                    </span><span class="nx">resyncerrc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-26-94"><a id="__codelineno-26-94" name="__codelineno-26-94"></a><span class="w">                    </span><span class="k">return</span>
</span><span id="__span-26-95"><a id="__codelineno-26-95" name="__codelineno-26-95"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-26-96"><a id="__codelineno-26-96" name="__codelineno-26-96"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-26-97"><a id="__codelineno-26-97" name="__codelineno-26-97"></a><span class="w">            </span><span class="nx">cleanup</span><span class="p">()</span>
</span><span id="__span-26-98"><a id="__codelineno-26-98" name="__codelineno-26-98"></a><span class="w">            </span><span class="nx">resyncCh</span><span class="p">,</span><span class="w"> </span><span class="nx">cleanup</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">resyncChan</span><span class="p">()</span>
</span><span id="__span-26-99"><a id="__codelineno-26-99" name="__codelineno-26-99"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-100"><a id="__codelineno-26-100" name="__codelineno-26-100"></a><span class="w">    </span><span class="p">}()</span>
</span><span id="__span-26-101"><a id="__codelineno-26-101" name="__codelineno-26-101"></a>
</span><span id="__span-26-102"><a id="__codelineno-26-102" name="__codelineno-26-102"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-103"><a id="__codelineno-26-103" name="__codelineno-26-103"></a><span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-104"><a id="__codelineno-26-104" name="__codelineno-26-104"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">stopCh</span><span class="p">:</span>
</span><span id="__span-26-105"><a id="__codelineno-26-105" name="__codelineno-26-105"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-26-106"><a id="__codelineno-26-106" name="__codelineno-26-106"></a><span class="w">        </span><span class="k">default</span><span class="p">:</span>
</span><span id="__span-26-107"><a id="__codelineno-26-107" name="__codelineno-26-107"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-108"><a id="__codelineno-26-108" name="__codelineno-26-108"></a>
</span><span id="__span-26-109"><a id="__codelineno-26-109" name="__codelineno-26-109"></a><span class="w">        </span><span class="nx">timeoutSeconds</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">int64</span><span class="p">(</span><span class="nx">minWatchTimeout</span><span class="p">.</span><span class="nx">Seconds</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Float64</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="p">))</span>
</span><span id="__span-26-110"><a id="__codelineno-26-110" name="__codelineno-26-110"></a><span class="w">        </span><span class="nx">options</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span>
</span><span id="__span-26-111"><a id="__codelineno-26-111" name="__codelineno-26-111"></a><span class="w">            </span><span class="nx">ResourceVersion</span><span class="p">:</span><span class="w"> </span><span class="nx">resourceVersion</span><span class="p">,</span>
</span><span id="__span-26-112"><a id="__codelineno-26-112" name="__codelineno-26-112"></a><span class="w">            </span><span class="nx">TimeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">timeoutSeconds</span><span class="p">,</span>
</span><span id="__span-26-113"><a id="__codelineno-26-113" name="__codelineno-26-113"></a><span class="w">            </span><span class="nx">AllowWatchBookmarks</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-26-114"><a id="__codelineno-26-114" name="__codelineno-26-114"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-115"><a id="__codelineno-26-115" name="__codelineno-26-115"></a>
</span><span id="__span-26-116"><a id="__codelineno-26-116" name="__codelineno-26-116"></a><span class="w">        </span><span class="c1">// watch, 用上面全量获取后的 资源版本号, 表示监听这之后的</span>
</span><span id="__span-26-117"><a id="__codelineno-26-117" name="__codelineno-26-117"></a><span class="w">        </span><span class="c1">// 增量更新</span>
</span><span id="__span-26-118"><a id="__codelineno-26-118" name="__codelineno-26-118"></a><span class="hll"><span class="w">        </span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">listerWatcher</span><span class="p">.</span><span class="nx">Watch</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
</span></span><span id="__span-26-119"><a id="__codelineno-26-119" name="__codelineno-26-119"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-120"><a id="__codelineno-26-120" name="__codelineno-26-120"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">utilnet</span><span class="p">.</span><span class="nx">IsConnectionRefused</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">apierrors</span><span class="p">.</span><span class="nx">IsTooManyRequests</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-121"><a id="__codelineno-26-121" name="__codelineno-26-121"></a><span class="w">                </span><span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">initConnBackoffManager</span><span class="p">.</span><span class="nx">Backoff</span><span class="p">().</span><span class="nx">C</span><span class="p">()</span>
</span><span id="__span-26-122"><a id="__codelineno-26-122" name="__codelineno-26-122"></a><span class="w">                </span><span class="k">continue</span>
</span><span id="__span-26-123"><a id="__codelineno-26-123" name="__codelineno-26-123"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-26-124"><a id="__codelineno-26-124" name="__codelineno-26-124"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-26-125"><a id="__codelineno-26-125" name="__codelineno-26-125"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-126"><a id="__codelineno-26-126" name="__codelineno-26-126"></a>
</span><span id="__span-26-127"><a id="__codelineno-26-127" name="__codelineno-26-127"></a><span class="w">        </span><span class="c1">// 对监听到的事件进行处理</span>
</span><span id="__span-26-128"><a id="__codelineno-26-128" name="__codelineno-26-128"></a><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">watchHandler</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">resourceVersion</span><span class="p">,</span><span class="w"> </span><span class="nx">resyncerrc</span><span class="p">,</span><span class="w"> </span><span class="nx">stopCh</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span></span><span id="__span-26-129"><a id="__codelineno-26-129" name="__codelineno-26-129"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">errorStopRequested</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-130"><a id="__codelineno-26-130" name="__codelineno-26-130"></a><span class="w">                </span><span class="k">switch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-131"><a id="__codelineno-26-131" name="__codelineno-26-131"></a><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="nx">isExpiredError</span><span class="p">(</span><span class="nx">err</span><span class="p">):</span>
</span><span id="__span-26-132"><a id="__codelineno-26-132" name="__codelineno-26-132"></a><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="nx">apierrors</span><span class="p">.</span><span class="nx">IsTooManyRequests</span><span class="p">(</span><span class="nx">err</span><span class="p">):</span>
</span><span id="__span-26-133"><a id="__codelineno-26-133" name="__codelineno-26-133"></a><span class="w">                    </span><span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">initConnBackoffManager</span><span class="p">.</span><span class="nx">Backoff</span><span class="p">().</span><span class="nx">C</span><span class="p">()</span>
</span><span id="__span-26-134"><a id="__codelineno-26-134" name="__codelineno-26-134"></a><span class="w">                    </span><span class="k">continue</span>
</span><span id="__span-26-135"><a id="__codelineno-26-135" name="__codelineno-26-135"></a><span class="w">                </span><span class="k">default</span><span class="p">:</span>
</span><span id="__span-26-136"><a id="__codelineno-26-136" name="__codelineno-26-136"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-26-137"><a id="__codelineno-26-137" name="__codelineno-26-137"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-26-138"><a id="__codelineno-26-138" name="__codelineno-26-138"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-26-139"><a id="__codelineno-26-139" name="__codelineno-26-139"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-140"><a id="__codelineno-26-140" name="__codelineno-26-140"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-141"><a id="__codelineno-26-141" name="__codelineno-26-141"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<p>在实例化Informer的时候, 设置了对应的list和watch方法<br>
关于 pod的list和watch 操作 参考 <a href="/devops/k8s/src_analysis/client-go/client-go/#pod">博文</a></p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span>
<span class="normal"><a href="#__codelineno-27-23">23</a></span>
<span class="normal"><a href="#__codelineno-27-24">24</a></span>
<span class="normal"><a href="#__codelineno-27-25">25</a></span>
<span class="normal"><a href="#__codelineno-27-26">26</a></span>
<span class="normal"><a href="#__codelineno-27-27">27</a></span>
<span class="normal"><a href="#__codelineno-27-28">28</a></span>
<span class="normal"><a href="#__codelineno-27-29">29</a></span>
<span class="normal"><a href="#__codelineno-27-30">30</a></span>
<span class="normal"><a href="#__codelineno-27-31">31</a></span>
<span class="normal"><a href="#__codelineno-27-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="nx">informer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sharedInformers</span><span class="p">.</span><span class="nx">Core</span><span class="p">().</span><span class="nx">V1</span><span class="p">().</span><span class="nx">Pods</span><span class="p">().</span><span class="nx">Informer</span><span class="p">()</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">podInformer</span><span class="p">)</span><span class="w"> </span><span class="nx">Informer</span><span class="p">()</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">factory</span><span class="p">.</span><span class="nx">InformerFor</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{},</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">defaultInformer</span><span class="p">)</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="p">}</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="c1">// f.defaultInformer</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">podInformer</span><span class="p">)</span><span class="w"> </span><span class="nx">defaultInformer</span><span class="p">(</span><span class="nx">client</span><span class="w"> </span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NewFilteredPodInformer</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="p">,</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">Indexers</span><span class="p">{</span><span class="nx">cache</span><span class="p">.</span><span class="nx">NamespaceIndex</span><span class="p">:</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">MetaNamespaceIndexFunc</span><span class="p">},</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">tweakListOptions</span><span class="p">)</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="p">}</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="c1">// NewFilteredPodInformer</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewFilteredPodInformer</span><span class="p">(</span><span class="nx">client</span><span class="w"> </span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span><span class="w"> </span><span class="nx">namespace</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span><span class="w"> </span><span class="nx">indexers</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">Indexers</span><span class="p">,</span><span class="w"> </span><span class="nx">tweakListOptions</span><span class="w"> </span><span class="nx">internalinterfaces</span><span class="p">.</span><span class="nx">TweakListOptionsFunc</span><span class="p">)</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">NewSharedIndexInformer</span><span class="p">(</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="w">        </span><span class="o">&amp;</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ListWatch</span><span class="p">{</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="hll"><span class="w">            </span><span class="nx">ListFunc</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">options</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span></span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">tweakListOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15"></a><span class="w">                    </span><span class="nx">tweakListOptions</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">)</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="w">                </span><span class="c1">// 这个就是获取所有pod的操作</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">CoreV1</span><span class="p">().</span><span class="nx">Pods</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nx">List</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20"></a><span class="hll"><span class="w">            </span><span class="nx">WatchFunc</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">options</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span></span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">tweakListOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22"></a><span class="w">                    </span><span class="nx">tweakListOptions</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">)</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24"></a><span class="w">                </span><span class="c1">// watch操作</span>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">CoreV1</span><span class="p">().</span><span class="nx">Pods</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nx">Watch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28"></a><span class="w">        </span><span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{},</span>
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29"></a><span class="w">        </span><span class="nx">resyncPeriod</span><span class="p">,</span>
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30"></a><span class="w">        </span><span class="nx">indexers</span><span class="p">,</span>
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-27-32"><a id="__codelineno-27-32" name="__codelineno-27-32"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span>
<span class="normal"><a href="#__codelineno-28-13">13</a></span>
<span class="normal"><a href="#__codelineno-28-14">14</a></span>
<span class="normal"><a href="#__codelineno-28-15">15</a></span>
<span class="normal"><a href="#__codelineno-28-16">16</a></span>
<span class="normal"><a href="#__codelineno-28-17">17</a></span>
<span class="normal"><a href="#__codelineno-28-18">18</a></span>
<span class="normal"><a href="#__codelineno-28-19">19</a></span>
<span class="normal"><a href="#__codelineno-28-20">20</a></span>
<span class="normal"><a href="#__codelineno-28-21">21</a></span>
<span class="normal"><a href="#__codelineno-28-22">22</a></span>
<span class="normal"><a href="#__codelineno-28-23">23</a></span>
<span class="normal"><a href="#__codelineno-28-24">24</a></span>
<span class="normal"><a href="#__codelineno-28-25">25</a></span>
<span class="normal"><a href="#__codelineno-28-26">26</a></span>
<span class="normal"><a href="#__codelineno-28-27">27</a></span>
<span class="normal"><a href="#__codelineno-28-28">28</a></span>
<span class="normal"><a href="#__codelineno-28-29">29</a></span>
<span class="normal"><a href="#__codelineno-28-30">30</a></span>
<span class="normal"><a href="#__codelineno-28-31">31</a></span>
<span class="normal"><a href="#__codelineno-28-32">32</a></span>
<span class="normal"><a href="#__codelineno-28-33">33</a></span>
<span class="normal"><a href="#__codelineno-28-34">34</a></span>
<span class="normal"><a href="#__codelineno-28-35">35</a></span>
<span class="normal"><a href="#__codelineno-28-36">36</a></span>
<span class="normal"><a href="#__codelineno-28-37">37</a></span>
<span class="normal"><a href="#__codelineno-28-38">38</a></span>
<span class="normal"><a href="#__codelineno-28-39">39</a></span>
<span class="normal"><a href="#__codelineno-28-40">40</a></span>
<span class="normal"><a href="#__codelineno-28-41">41</a></span>
<span class="normal"><a href="#__codelineno-28-42">42</a></span>
<span class="normal"><a href="#__codelineno-28-43">43</a></span>
<span class="normal"><a href="#__codelineno-28-44">44</a></span>
<span class="normal"><a href="#__codelineno-28-45">45</a></span>
<span class="normal"><a href="#__codelineno-28-46">46</a></span>
<span class="normal"><a href="#__codelineno-28-47">47</a></span>
<span class="normal"><a href="#__codelineno-28-48">48</a></span>
<span class="normal"><a href="#__codelineno-28-49">49</a></span>
<span class="normal"><a href="#__codelineno-28-50">50</a></span>
<span class="normal"><a href="#__codelineno-28-51">51</a></span>
<span class="normal"><a href="#__codelineno-28-52">52</a></span>
<span class="normal"><a href="#__codelineno-28-53">53</a></span>
<span class="normal"><a href="#__codelineno-28-54">54</a></span>
<span class="normal"><a href="#__codelineno-28-55">55</a></span>
<span class="normal"><a href="#__codelineno-28-56">56</a></span>
<span class="normal"><a href="#__codelineno-28-57">57</a></span>
<span class="normal"><a href="#__codelineno-28-58">58</a></span>
<span class="normal"><a href="#__codelineno-28-59">59</a></span>
<span class="normal"><a href="#__codelineno-28-60">60</a></span>
<span class="normal"><a href="#__codelineno-28-61">61</a></span>
<span class="normal"><a href="#__codelineno-28-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">ListPager</span><span class="p">)</span><span class="w"> </span><span class="nx">List</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">Limit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">Limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">PageSize</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="w">    </span><span class="nx">requestedResourceVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">ResourceVersion</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="w">    </span><span class="nx">requestedResourceVersionMatch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">ResourceVersionMatch</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">*</span><span class="nx">metainternalversion</span><span class="p">.</span><span class="nx">List</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="w">    </span><span class="nx">paginatedResult</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9"></a>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">paginatedResult</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14"></a><span class="w">        </span><span class="k">default</span><span class="p">:</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16"></a>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17"></a><span class="w">        </span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">PageFn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19"></a><span class="w">            </span><span class="c1">// Expired #(1)</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nx">IsResourceExpired</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">FullListIfExpired</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">Continue</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">paginatedResult</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23"></a><span class="w">            </span><span class="c1">// 我们重新发起请求</span>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24"></a><span class="w">            </span><span class="nx">options</span><span class="p">.</span><span class="nx">Limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25"></a><span class="w">            </span><span class="nx">options</span><span class="p">.</span><span class="nx">Continue</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26"></a><span class="w">            </span><span class="nx">options</span><span class="p">.</span><span class="nx">ResourceVersion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">requestedResourceVersion</span>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27"></a><span class="w">            </span><span class="nx">options</span><span class="p">.</span><span class="nx">ResourceVersionMatch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">requestedResourceVersionMatch</span>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28"></a><span class="w">            </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">PageFn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">paginatedResult</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31"></a><span class="w">        </span><span class="nx">m</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">ListAccessor</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">paginatedResult</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;returned object must be a list: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35"></a>
</span><span id="__span-28-36"><a id="__codelineno-28-36" name="__codelineno-28-36"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">GetContinue</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-37"><a id="__codelineno-28-37" name="__codelineno-28-37"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">paginatedResult</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-28-38"><a id="__codelineno-28-38" name="__codelineno-28-38"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-28-39"><a id="__codelineno-28-39" name="__codelineno-28-39"></a>
</span><span id="__span-28-40"><a id="__codelineno-28-40" name="__codelineno-28-40"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-41"><a id="__codelineno-28-41" name="__codelineno-28-41"></a><span class="w">            </span><span class="nx">list</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">metainternalversion</span><span class="p">.</span><span class="nx">List</span><span class="p">{</span><span class="nx">Items</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">Limit</span><span class="o">+</span><span class="mi">1</span><span class="p">)}</span>
</span><span id="__span-28-42"><a id="__codelineno-28-42" name="__codelineno-28-42"></a><span class="w">            </span><span class="nx">list</span><span class="p">.</span><span class="nx">ResourceVersion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">GetResourceVersion</span><span class="p">()</span>
</span><span id="__span-28-43"><a id="__codelineno-28-43" name="__codelineno-28-43"></a><span class="w">            </span><span class="nx">list</span><span class="p">.</span><span class="nx">SelfLink</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">GetSelfLink</span><span class="p">()</span>
</span><span id="__span-28-44"><a id="__codelineno-28-44" name="__codelineno-28-44"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-28-45"><a id="__codelineno-28-45" name="__codelineno-28-45"></a><span class="w">        </span><span class="c1">// 这里大体上是这样的 #(2)</span>
</span><span id="__span-28-46"><a id="__codelineno-28-46" name="__codelineno-28-46"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">EachListItem</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">obj</span><span class="w"> </span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-47"><a id="__codelineno-28-47" name="__codelineno-28-47"></a><span class="w">            </span><span class="nx">list</span><span class="p">.</span><span class="nx">Items</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">Items</span><span class="p">,</span><span class="w"> </span><span class="nx">obj</span><span class="p">)</span>
</span><span id="__span-28-48"><a id="__codelineno-28-48" name="__codelineno-28-48"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-28-49"><a id="__codelineno-28-49" name="__codelineno-28-49"></a><span class="w">        </span><span class="p">});</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-50"><a id="__codelineno-28-50" name="__codelineno-28-50"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">paginatedResult</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-28-51"><a id="__codelineno-28-51" name="__codelineno-28-51"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-28-52"><a id="__codelineno-28-52" name="__codelineno-28-52"></a>
</span><span id="__span-28-53"><a id="__codelineno-28-53" name="__codelineno-28-53"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">GetContinue</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-54"><a id="__codelineno-28-54" name="__codelineno-28-54"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">list</span><span class="p">,</span><span class="w"> </span><span class="nx">paginatedResult</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-28-55"><a id="__codelineno-28-55" name="__codelineno-28-55"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-28-56"><a id="__codelineno-28-56" name="__codelineno-28-56"></a>
</span><span id="__span-28-57"><a id="__codelineno-28-57" name="__codelineno-28-57"></a><span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">Continue</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">GetContinue</span><span class="p">()</span>
</span><span id="__span-28-58"><a id="__codelineno-28-58" name="__codelineno-28-58"></a><span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">ResourceVersion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
</span><span id="__span-28-59"><a id="__codelineno-28-59" name="__codelineno-28-59"></a><span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">ResourceVersionMatch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
</span><span id="__span-28-60"><a id="__codelineno-28-60" name="__codelineno-28-60"></a><span class="w">        </span><span class="nx">paginatedResult</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-28-61"><a id="__codelineno-28-61" name="__codelineno-28-61"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-28-62"><a id="__codelineno-28-62" name="__codelineno-28-62"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>
<p>比如自己测试,你分页请求 使用continue 第二页的时候,等待一些时间, 再发起请求</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span>
<span class="normal"><a href="#__codelineno-29-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="p">{</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="w">    </span><span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Status&quot;</span><span class="p">,</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="w">    </span><span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;v1&quot;</span><span class="p">,</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="w">    </span><span class="nt">&quot;metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">        </span><span class="nt">&quot;continue&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;XXXXXXXXXXXXX&quot;</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="w">    </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Failure&quot;</span><span class="p">,</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="w">    </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The provided continue parameter is too old to display a consistent list result.</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="s2">    You can start a new list without the continue parameter, or use the continue token </span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="s2">    in this response to retrieve the remainder of the results. </span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="s2">    Continuing with the provided token results in an inconsistent list - objects that were created,</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="s2">    modified, or deleted between the time the first chunk was returned and now may show up in the list.&quot;</span><span class="p">,</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13"></a><span class="w">    </span><span class="nt">&quot;reason&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Expired&quot;</span><span class="p">,</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14"></a><span class="w">    </span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">410</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>list()获取的列表,将items里每个添加到list中</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="p">{</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="w">    </span><span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PodList&quot;</span><span class="p">,</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="w">    </span><span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;v1&quot;</span><span class="p">,</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="w">    </span><span class="nt">&quot;metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="w">        </span><span class="nt">&quot;resourceVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2871322&quot;</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="w">    </span><span class="nt">&quot;items&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="w">        </span><span class="p">{},</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="w">        </span><span class="p">{},</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">        </span><span class="p">{},</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="w">        </span><span class="p">{}</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="w">    </span><span class="p">]</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span>
<span class="normal"><a href="#__codelineno-31-22">22</a></span>
<span class="normal"><a href="#__codelineno-31-23">23</a></span>
<span class="normal"><a href="#__codelineno-31-24">24</a></span>
<span class="normal"><a href="#__codelineno-31-25">25</a></span>
<span class="normal"><a href="#__codelineno-31-26">26</a></span>
<span class="normal"><a href="#__codelineno-31-27">27</a></span>
<span class="normal"><a href="#__codelineno-31-28">28</a></span>
<span class="normal"><a href="#__codelineno-31-29">29</a></span>
<span class="normal"><a href="#__codelineno-31-30">30</a></span>
<span class="normal"><a href="#__codelineno-31-31">31</a></span>
<span class="normal"><a href="#__codelineno-31-32">32</a></span>
<span class="normal"><a href="#__codelineno-31-33">33</a></span>
<span class="normal"><a href="#__codelineno-31-34">34</a></span>
<span class="normal"><a href="#__codelineno-31-35">35</a></span>
<span class="normal"><a href="#__codelineno-31-36">36</a></span>
<span class="normal"><a href="#__codelineno-31-37">37</a></span>
<span class="normal"><a href="#__codelineno-31-38">38</a></span>
<span class="normal"><a href="#__codelineno-31-39">39</a></span>
<span class="normal"><a href="#__codelineno-31-40">40</a></span>
<span class="normal"><a href="#__codelineno-31-41">41</a></span>
<span class="normal"><a href="#__codelineno-31-42">42</a></span>
<span class="normal"><a href="#__codelineno-31-43">43</a></span>
<span class="normal"><a href="#__codelineno-31-44">44</a></span>
<span class="normal"><a href="#__codelineno-31-45">45</a></span>
<span class="normal"><a href="#__codelineno-31-46">46</a></span>
<span class="normal"><a href="#__codelineno-31-47">47</a></span>
<span class="normal"><a href="#__codelineno-31-48">48</a></span>
<span class="normal"><a href="#__codelineno-31-49">49</a></span>
<span class="normal"><a href="#__codelineno-31-50">50</a></span>
<span class="normal"><a href="#__codelineno-31-51">51</a></span>
<span class="normal"><a href="#__codelineno-31-52">52</a></span>
<span class="normal"><a href="#__codelineno-31-53">53</a></span>
<span class="normal"><a href="#__codelineno-31-54">54</a></span>
<span class="normal"><a href="#__codelineno-31-55">55</a></span>
<span class="normal"><a href="#__codelineno-31-56">56</a></span>
<span class="normal"><a href="#__codelineno-31-57">57</a></span>
<span class="normal"><a href="#__codelineno-31-58">58</a></span>
<span class="normal"><a href="#__codelineno-31-59">59</a></span>
<span class="normal"><a href="#__codelineno-31-60">60</a></span>
<span class="normal"><a href="#__codelineno-31-61">61</a></span>
<span class="normal"><a href="#__codelineno-31-62">62</a></span>
<span class="normal"><a href="#__codelineno-31-63">63</a></span>
<span class="normal"><a href="#__codelineno-31-64">64</a></span>
<span class="normal"><a href="#__codelineno-31-65">65</a></span>
<span class="normal"><a href="#__codelineno-31-66">66</a></span>
<span class="normal"><a href="#__codelineno-31-67">67</a></span>
<span class="normal"><a href="#__codelineno-31-68">68</a></span>
<span class="normal"><a href="#__codelineno-31-69">69</a></span>
<span class="normal"><a href="#__codelineno-31-70">70</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="c1">// watchHandler watches w and keeps *resourceVersion up to date.</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">Reflector</span><span class="p">)</span><span class="w"> </span><span class="nx">watchHandler</span><span class="p">(</span><span class="nx">start</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span><span class="w"> </span><span class="nx">resourceVersion</span><span class="w"> </span><span class="o">*</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">errc</span><span class="w"> </span><span class="kd">chan</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span><span class="w"> </span><span class="nx">stopCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="w">    </span><span class="nx">eventCount</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4"></a>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="w">    </span><span class="c1">// Stopping the watcher should be idempotent and if we return from this function there&#39;s no way</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="w">    </span><span class="c1">// we&#39;re coming back in with the same watch interface.</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">Stop</span><span class="p">()</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8"></a>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="nx">loop</span><span class="p">:</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">stopCh</span><span class="p">:</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">errorStopRequested</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">errc</span><span class="p">:</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">w</span><span class="p">.</span><span class="nx">ResultChan</span><span class="p">():</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18"></a><span class="w">                </span><span class="k">break</span><span class="w"> </span><span class="nx">loop</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">watch</span><span class="p">.</span><span class="nx">Error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">expectedType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">expectedType</span><span class="p">,</span><span class="w"> </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25"></a><span class="w">                    </span><span class="k">continue</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">expectedGVK</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">*</span><span class="nx">r</span><span class="p">.</span><span class="nx">expectedGVK</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Object</span><span class="p">.</span><span class="nx">GetObjectKind</span><span class="p">().</span><span class="nx">GroupVersionKind</span><span class="p">();</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30"></a><span class="w">                    </span><span class="k">continue</span>
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-31-33"><a id="__codelineno-31-33" name="__codelineno-31-33"></a><span class="w">            </span><span class="nx">meta</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">Accessor</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span><span id="__span-31-34"><a id="__codelineno-31-34" name="__codelineno-31-34"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-35"><a id="__codelineno-31-35" name="__codelineno-31-35"></a><span class="w">                </span><span class="k">continue</span>
</span><span id="__span-31-36"><a id="__codelineno-31-36" name="__codelineno-31-36"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-31-37"><a id="__codelineno-31-37" name="__codelineno-31-37"></a><span class="w">            </span><span class="nx">newResourceVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">GetResourceVersion</span><span class="p">()</span>
</span><span id="__span-31-38"><a id="__codelineno-31-38" name="__codelineno-31-38"></a><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Type</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-39"><a id="__codelineno-31-39" name="__codelineno-31-39"></a><span class="w">                </span><span class="c1">// 添加到DeltaFIFO 中</span>
</span><span id="__span-31-40"><a id="__codelineno-31-40" name="__codelineno-31-40"></a><span class="hll"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">watch</span><span class="p">.</span><span class="nx">Added</span><span class="p">:</span>
</span></span><span id="__span-31-41"><a id="__codelineno-31-41" name="__codelineno-31-41"></a><span class="hll"><span class="w">                </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span></span><span id="__span-31-42"><a id="__codelineno-31-42" name="__codelineno-31-42"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-43"><a id="__codelineno-31-43" name="__codelineno-31-43"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-31-44"><a id="__codelineno-31-44" name="__codelineno-31-44"></a><span class="hll"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">watch</span><span class="p">.</span><span class="nx">Modified</span><span class="p">:</span>
</span></span><span id="__span-31-45"><a id="__codelineno-31-45" name="__codelineno-31-45"></a><span class="hll"><span class="w">                </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">Update</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span></span><span id="__span-31-46"><a id="__codelineno-31-46" name="__codelineno-31-46"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-47"><a id="__codelineno-31-47" name="__codelineno-31-47"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-31-48"><a id="__codelineno-31-48" name="__codelineno-31-48"></a><span class="hll"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">watch</span><span class="p">.</span><span class="nx">Deleted</span><span class="p">:</span>
</span></span><span id="__span-31-49"><a id="__codelineno-31-49" name="__codelineno-31-49"></a><span class="hll"><span class="w">                </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">Delete</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span></span><span id="__span-31-50"><a id="__codelineno-31-50" name="__codelineno-31-50"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-51"><a id="__codelineno-31-51" name="__codelineno-31-51"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-31-52"><a id="__codelineno-31-52" name="__codelineno-31-52"></a><span class="hll"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">watch</span><span class="p">.</span><span class="nx">Bookmark</span><span class="p">:</span>
</span></span><span id="__span-31-53"><a id="__codelineno-31-53" name="__codelineno-31-53"></a><span class="w">                </span><span class="c1">// A `Bookmark` means watch has synced here, just update the resourceVersion</span>
</span><span id="__span-31-54"><a id="__codelineno-31-54" name="__codelineno-31-54"></a><span class="w">            </span><span class="k">default</span><span class="p">:</span>
</span><span id="__span-31-55"><a id="__codelineno-31-55" name="__codelineno-31-55"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-31-56"><a id="__codelineno-31-56" name="__codelineno-31-56"></a><span class="w">            </span><span class="o">*</span><span class="nx">resourceVersion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newResourceVersion</span>
</span><span id="__span-31-57"><a id="__codelineno-31-57" name="__codelineno-31-57"></a><span class="hll"><span class="w">            </span><span class="nx">r</span><span class="p">.</span><span class="nx">setLastSyncResourceVersion</span><span class="p">(</span><span class="nx">newResourceVersion</span><span class="p">)</span>
</span></span><span id="__span-31-58"><a id="__codelineno-31-58" name="__codelineno-31-58"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">rvu</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">store</span><span class="p">.(</span><span class="nx">ResourceVersionUpdater</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-59"><a id="__codelineno-31-59" name="__codelineno-31-59"></a><span class="hll"><span class="w">                </span><span class="nx">rvu</span><span class="p">.</span><span class="nx">UpdateResourceVersion</span><span class="p">(</span><span class="nx">newResourceVersion</span><span class="p">)</span>
</span></span><span id="__span-31-60"><a id="__codelineno-31-60" name="__codelineno-31-60"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-31-61"><a id="__codelineno-31-61" name="__codelineno-31-61"></a><span class="w">            </span><span class="nx">eventCount</span><span class="o">++</span>
</span><span id="__span-31-62"><a id="__codelineno-31-62" name="__codelineno-31-62"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-31-63"><a id="__codelineno-31-63" name="__codelineno-31-63"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-64"><a id="__codelineno-31-64" name="__codelineno-31-64"></a>
</span><span id="__span-31-65"><a id="__codelineno-31-65" name="__codelineno-31-65"></a><span class="w">    </span><span class="nx">watchDuration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">clock</span><span class="p">.</span><span class="nx">Since</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span>
</span><span id="__span-31-66"><a id="__codelineno-31-66" name="__codelineno-31-66"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">watchDuration</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">eventCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-67"><a id="__codelineno-31-67" name="__codelineno-31-67"></a><span class="w">        </span><span class="k">return</span>
</span><span id="__span-31-68"><a id="__codelineno-31-68" name="__codelineno-31-68"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-69"><a id="__codelineno-31-69" name="__codelineno-31-69"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-31-70"><a id="__codelineno-31-70" name="__codelineno-31-70"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span>
<span class="normal"><a href="#__codelineno-32-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">controller</span><span class="p">)</span><span class="w"> </span><span class="nx">processLoop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="w">        </span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Queue</span><span class="p">.</span><span class="nx">Pop</span><span class="p">(</span><span class="nx">PopProcessFunc</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Process</span><span class="p">))</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">ErrFIFOClosed</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6"></a><span class="w">                </span><span class="k">return</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">RetryOnError</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9"></a><span class="w">                </span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Queue</span><span class="p">.</span><span class="nx">AddIfNotPresent</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="tabbed-set tabbed-alternate" data-tabs="10:3"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><input id="__tabbed_10_3" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">Pop()</label><label for="__tabbed_10_2">c.config.process</label><label for="__tabbed_10_3">s.processor.distribute</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span>
<span class="normal"><a href="#__codelineno-33-18">18</a></span>
<span class="normal"><a href="#__codelineno-33-19">19</a></span>
<span class="normal"><a href="#__codelineno-33-20">20</a></span>
<span class="normal"><a href="#__codelineno-33-21">21</a></span>
<span class="normal"><a href="#__codelineno-33-22">22</a></span>
<span class="normal"><a href="#__codelineno-33-23">23</a></span>
<span class="normal"><a href="#__codelineno-33-24">24</a></span>
<span class="normal"><a href="#__codelineno-33-25">25</a></span>
<span class="normal"><a href="#__codelineno-33-26">26</a></span>
<span class="normal"><a href="#__codelineno-33-27">27</a></span>
<span class="normal"><a href="#__codelineno-33-28">28</a></span>
<span class="normal"><a href="#__codelineno-33-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">DeltaFIFO</span><span class="p">)</span><span class="w"> </span><span class="nx">Pop</span><span class="p">(</span><span class="nx">process</span><span class="w"> </span><span class="nx">PopProcessFunc</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="w">    </span><span class="nx">f</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">queue</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">closed</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">ErrFIFOClosed</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="w">            </span><span class="nx">f</span><span class="p">.</span><span class="nx">cond</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11"></a><span class="w">        </span><span class="nx">id</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="c1">// 弹出一个</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="w">        </span><span class="nx">f</span><span class="p">.</span><span class="nx">queue</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">queue</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="w"> </span><span class="c1">// 队列=剩余的</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13"></a><span class="w">        </span><span class="nx">depth</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">queue</span><span class="p">)</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">initialPopulationCount</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15"></a><span class="w">            </span><span class="nx">f</span><span class="p">.</span><span class="nx">initialPopulationCount</span><span class="o">--</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17"></a><span class="w">        </span><span class="nx">item</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19"></a><span class="w">            </span><span class="k">continue</span>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21"></a><span class="w">        </span><span class="nb">delete</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">)</span>
</span><span id="__span-33-22"><a id="__codelineno-33-22" name="__codelineno-33-22"></a><span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">process</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
</span><span id="__span-33-23"><a id="__codelineno-33-23" name="__codelineno-33-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">err</span><span class="p">.(</span><span class="nx">ErrRequeue</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-24"><a id="__codelineno-33-24" name="__codelineno-33-24"></a><span class="w">            </span><span class="nx">f</span><span class="p">.</span><span class="nx">addIfNotPresent</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="p">)</span>
</span><span id="__span-33-25"><a id="__codelineno-33-25" name="__codelineno-33-25"></a><span class="w">            </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Err</span>
</span><span id="__span-33-26"><a id="__codelineno-33-26" name="__codelineno-33-26"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-33-27"><a id="__codelineno-33-27" name="__codelineno-33-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">item</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">process() 处理方法</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span>
<span class="normal"><a href="#__codelineno-34-12">12</a></span>
<span class="normal"><a href="#__codelineno-34-13">13</a></span>
<span class="normal"><a href="#__codelineno-34-14">14</a></span>
<span class="normal"><a href="#__codelineno-34-15">15</a></span>
<span class="normal"><a href="#__codelineno-34-16">16</a></span>
<span class="normal"><a href="#__codelineno-34-17">17</a></span>
<span class="normal"><a href="#__codelineno-34-18">18</a></span>
<span class="normal"><a href="#__codelineno-34-19">19</a></span>
<span class="normal"><a href="#__codelineno-34-20">20</a></span>
<span class="normal"><a href="#__codelineno-34-21">21</a></span>
<span class="normal"><a href="#__codelineno-34-22">22</a></span>
<span class="normal"><a href="#__codelineno-34-23">23</a></span>
<span class="normal"><a href="#__codelineno-34-24">24</a></span>
<span class="normal"><a href="#__codelineno-34-25">25</a></span>
<span class="normal"><a href="#__codelineno-34-26">26</a></span>
<span class="normal"><a href="#__codelineno-34-27">27</a></span>
<span class="normal"><a href="#__codelineno-34-28">28</a></span>
<span class="normal"><a href="#__codelineno-34-29">29</a></span>
<span class="normal"><a href="#__codelineno-34-30">30</a></span>
<span class="normal"><a href="#__codelineno-34-31">31</a></span>
<span class="normal"><a href="#__codelineno-34-32">32</a></span>
<span class="normal"><a href="#__codelineno-34-33">33</a></span>
<span class="normal"><a href="#__codelineno-34-34">34</a></span>
<span class="normal"><a href="#__codelineno-34-35">35</a></span>
<span class="normal"><a href="#__codelineno-34-36">36</a></span>
<span class="normal"><a href="#__codelineno-34-37">37</a></span>
<span class="normal"><a href="#__codelineno-34-38">38</a></span>
<span class="normal"><a href="#__codelineno-34-39">39</a></span>
<span class="normal"><a href="#__codelineno-34-40">40</a></span>
<span class="normal"><a href="#__codelineno-34-41">41</a></span>
<span class="normal"><a href="#__codelineno-34-42">42</a></span>
<span class="normal"><a href="#__codelineno-34-43">43</a></span>
<span class="normal"><a href="#__codelineno-34-44">44</a></span>
<span class="normal"><a href="#__codelineno-34-45">45</a></span>
<span class="normal"><a href="#__codelineno-34-46">46</a></span>
<span class="normal"><a href="#__codelineno-34-47">47</a></span>
<span class="normal"><a href="#__codelineno-34-48">48</a></span>
<span class="normal"><a href="#__codelineno-34-49">49</a></span>
<span class="normal"><a href="#__codelineno-34-50">50</a></span>
<span class="normal"><a href="#__codelineno-34-51">51</a></span>
<span class="normal"><a href="#__codelineno-34-52">52</a></span>
<span class="normal"><a href="#__codelineno-34-53">53</a></span>
<span class="normal"><a href="#__codelineno-34-54">54</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">sharedIndexInformer</span><span class="p">)</span><span class="w"> </span><span class="nx">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="w">    </span><span class="nx">cfg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Config</span><span class="p">{</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w">        </span><span class="nx">Queue</span><span class="p">:</span><span class="w">            </span><span class="nx">fifo</span><span class="p">,</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w">        </span><span class="c1">//...</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="hll"><span class="w">        </span><span class="nx">Process</span><span class="p">:</span><span class="w">           </span><span class="nx">s</span><span class="p">.</span><span class="nx">HandleDeltas</span><span class="p">,</span>
</span></span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="w">        </span><span class="nx">WatchErrorHandler</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">watchErrorHandler</span><span class="p">,</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="p">}</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">sharedIndexInformer</span><span class="p">)</span><span class="w"> </span><span class="nx">HandleDeltas</span><span class="p">(</span><span class="nx">obj</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11"></a><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">blockDeltas</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">blockDeltas</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13"></a>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14"></a><span class="w">    </span><span class="c1">// from oldest to newest</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">d</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">obj</span><span class="p">.(</span><span class="nx">Deltas</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="nx">d</span><span class="p">.</span><span class="nx">Type</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">Sync</span><span class="p">,</span><span class="w"> </span><span class="nx">Replaced</span><span class="p">,</span><span class="w"> </span><span class="nx">Added</span><span class="p">,</span><span class="w"> </span><span class="nx">Updated</span><span class="p">:</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18"></a><span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">cacheMutationDetector</span><span class="p">.</span><span class="nx">AddObject</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">old</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20"></a><span class="w">                </span><span class="c1">// 更新缓存</span>
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nx">Update</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24"></a>
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25"></a><span class="w">                </span><span class="nx">isSync</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26"></a><span class="w">                </span><span class="k">switch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-27"><a id="__codelineno-34-27" name="__codelineno-34-27"></a><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="nx">d</span><span class="p">.</span><span class="nx">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Sync</span><span class="p">:</span>
</span><span id="__span-34-28"><a id="__codelineno-34-28" name="__codelineno-34-28"></a><span class="w">                    </span><span class="c1">// Sync events are only propagated to listeners that requested resync</span>
</span><span id="__span-34-29"><a id="__codelineno-34-29" name="__codelineno-34-29"></a><span class="w">                    </span><span class="nx">isSync</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-34-30"><a id="__codelineno-34-30" name="__codelineno-34-30"></a><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="nx">d</span><span class="p">.</span><span class="nx">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Replaced</span><span class="p">:</span>
</span><span id="__span-34-31"><a id="__codelineno-34-31" name="__codelineno-34-31"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nx">accessor</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">Accessor</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-32"><a id="__codelineno-34-32" name="__codelineno-34-32"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="nx">oldAccessor</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">Accessor</span><span class="p">(</span><span class="nx">old</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-33"><a id="__codelineno-34-33" name="__codelineno-34-33"></a><span class="w">                            </span><span class="c1">// Replaced events that didn&#39;t change resourceVersion are treated as resync events</span>
</span><span id="__span-34-34"><a id="__codelineno-34-34" name="__codelineno-34-34"></a><span class="w">                            </span><span class="c1">// and only propagated to listeners that requested resync</span>
</span><span id="__span-34-35"><a id="__codelineno-34-35" name="__codelineno-34-35"></a><span class="w">                            </span><span class="nx">isSync</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">accessor</span><span class="p">.</span><span class="nx">GetResourceVersion</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">oldAccessor</span><span class="p">.</span><span class="nx">GetResourceVersion</span><span class="p">()</span>
</span><span id="__span-34-36"><a id="__codelineno-34-36" name="__codelineno-34-36"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-34-37"><a id="__codelineno-34-37" name="__codelineno-34-37"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-34-38"><a id="__codelineno-34-38" name="__codelineno-34-38"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-34-39"><a id="__codelineno-34-39" name="__codelineno-34-39"></a><span class="hll"><span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">distribute</span><span class="p">(</span><span class="nx">updateNotification</span><span class="p">{</span><span class="nx">oldObj</span><span class="p">:</span><span class="w"> </span><span class="nx">old</span><span class="p">,</span><span class="w"> </span><span class="nx">newObj</span><span class="p">:</span><span class="w"> </span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">},</span><span class="w"> </span><span class="nx">isSync</span><span class="p">)</span>
</span></span><span id="__span-34-40"><a id="__codelineno-34-40" name="__codelineno-34-40"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-41"><a id="__codelineno-34-41" name="__codelineno-34-41"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-42"><a id="__codelineno-34-42" name="__codelineno-34-42"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-34-43"><a id="__codelineno-34-43" name="__codelineno-34-43"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-34-44"><a id="__codelineno-34-44" name="__codelineno-34-44"></a><span class="hll"><span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">distribute</span><span class="p">(</span><span class="nx">addNotification</span><span class="p">{</span><span class="nx">newObj</span><span class="p">:</span><span class="w"> </span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">},</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
</span></span><span id="__span-34-45"><a id="__codelineno-34-45" name="__codelineno-34-45"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-34-46"><a id="__codelineno-34-46" name="__codelineno-34-46"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">Deleted</span><span class="p">:</span>
</span><span id="__span-34-47"><a id="__codelineno-34-47" name="__codelineno-34-47"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nx">Delete</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-48"><a id="__codelineno-34-48" name="__codelineno-34-48"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-34-49"><a id="__codelineno-34-49" name="__codelineno-34-49"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-34-50"><a id="__codelineno-34-50" name="__codelineno-34-50"></a><span class="hll"><span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">distribute</span><span class="p">(</span><span class="nx">deleteNotification</span><span class="p">{</span><span class="nx">oldObj</span><span class="p">:</span><span class="w"> </span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">},</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
</span></span><span id="__span-34-51"><a id="__codelineno-34-51" name="__codelineno-34-51"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-34-52"><a id="__codelineno-34-52" name="__codelineno-34-52"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-53"><a id="__codelineno-34-53" name="__codelineno-34-53"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-34-54"><a id="__codelineno-34-54" name="__codelineno-34-54"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span>
<span class="normal"><a href="#__codelineno-35-12">12</a></span>
<span class="normal"><a href="#__codelineno-35-13">13</a></span>
<span class="normal"><a href="#__codelineno-35-14">14</a></span>
<span class="normal"><a href="#__codelineno-35-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">sharedProcessor</span><span class="p">)</span><span class="w"> </span><span class="nx">distribute</span><span class="p">(</span><span class="nx">obj</span><span class="w"> </span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="nx">sync</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="w">    </span><span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4"></a>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">sync</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">listener</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">syncingListeners</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="w">            </span><span class="c1">// </span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="w">            </span><span class="nx">listener</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">listener</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">listeners</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="w">            </span><span class="nx">listener</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p>前面informer.run中  wg.StartWithChannel(processorStopCh, s.processor.run)</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span>
<span class="normal"><a href="#__codelineno-36-17">17</a></span>
<span class="normal"><a href="#__codelineno-36-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">sharedProcessor</span><span class="p">)</span><span class="w"> </span><span class="nx">run</span><span class="p">(</span><span class="nx">stopCh</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="w">    </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">listener</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">listeners</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="w">            </span><span class="nx">p</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">run</span><span class="p">)</span><span class="w">  </span><span class="c1">//(1)</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="w">            </span><span class="nx">p</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">pop</span><span class="p">)</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="w">        </span><span class="nx">p</span><span class="p">.</span><span class="nx">listenersStarted</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10"></a><span class="w">    </span><span class="p">}()</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11"></a><span class="w">    </span><span class="o">&lt;-</span><span class="nx">stopCh</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12"></a><span class="w">    </span><span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">listener</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">listeners</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15"></a><span class="w">        </span><span class="nb">close</span><span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">addCh</span><span class="p">)</span><span class="w"> </span><span class="c1">// Tell .pop() to stop. .pop() will tell .run() to stop</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17"></a><span class="w">    </span><span class="nx">p</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span><span class="w"> </span><span class="c1">// Wait for all .pop() and .run() to stop</span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>
<p>listener.run</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span>
<span class="normal"><a href="#__codelineno-37-13">13</a></span>
<span class="normal"><a href="#__codelineno-37-14">14</a></span>
<span class="normal"><a href="#__codelineno-37-15">15</a></span>
<span class="normal"><a href="#__codelineno-37-16">16</a></span>
<span class="normal"><a href="#__codelineno-37-17">17</a></span>
<span class="normal"><a href="#__codelineno-37-18">18</a></span>
<span class="normal"><a href="#__codelineno-37-19">19</a></span>
<span class="normal"><a href="#__codelineno-37-20">20</a></span>
<span class="normal"><a href="#__codelineno-37-21">21</a></span>
<span class="normal"><a href="#__codelineno-37-22">22</a></span>
<span class="normal"><a href="#__codelineno-37-23">23</a></span>
<span class="normal"><a href="#__codelineno-37-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">processorListener</span><span class="p">)</span><span class="w"> </span><span class="nx">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="w">    </span><span class="c1">// this call blocks until the channel is closed.  When a panic happens during the notification</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="w">    </span><span class="c1">// we will catch it, **the offending item will be skipped!**, and after a short delay (one second)</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="w">    </span><span class="c1">// the next notification will be attempted.  This is usually better than the alternative of never</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="w">    </span><span class="c1">// delivering again.</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="w">    </span><span class="nx">stopCh</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="w">    </span><span class="nx">wait</span><span class="p">.</span><span class="nx">Until</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">next</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">nextCh</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9"></a><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="nx">notification</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">next</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">updateNotification</span><span class="p">:</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11"></a><span class="w">                </span><span class="c1">// OnUpdate这些就是我们前面.Informer().AddEventHandler(..)</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12"></a><span class="w">                </span><span class="nx">p</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nx">OnUpdate</span><span class="p">(</span><span class="nx">notification</span><span class="p">.</span><span class="nx">oldObj</span><span class="p">,</span><span class="w"> </span><span class="nx">notification</span><span class="p">.</span><span class="nx">newObj</span><span class="p">)</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">addNotification</span><span class="p">:</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14"></a><span class="w">                </span><span class="nx">p</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nx">OnAdd</span><span class="p">(</span><span class="nx">notification</span><span class="p">.</span><span class="nx">newObj</span><span class="p">)</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">deleteNotification</span><span class="p">:</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16"></a><span class="w">                </span><span class="nx">p</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nx">OnDelete</span><span class="p">(</span><span class="nx">notification</span><span class="p">.</span><span class="nx">oldObj</span><span class="p">)</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17"></a><span class="w">            </span><span class="k">default</span><span class="p">:</span>
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18"></a><span class="w">                </span><span class="nx">utilruntime</span><span class="p">.</span><span class="nx">HandleError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;unrecognized notification: %T&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">))</span>
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-37-20"><a id="__codelineno-37-20" name="__codelineno-37-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-37-21"><a id="__codelineno-37-21" name="__codelineno-37-21"></a><span class="w">        </span><span class="c1">// the only way to get here is if the p.nextCh is empty and closed</span>
</span><span id="__span-37-22"><a id="__codelineno-37-22" name="__codelineno-37-22"></a><span class="w">        </span><span class="nb">close</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-37-23"><a id="__codelineno-37-23" name="__codelineno-37-23"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="w"> </span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-37-24"><a id="__codelineno-37-24" name="__codelineno-37-24"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ol>
</div>
</div>
</div>
<p><code>staging/src/k8s.io/client-go/informers/</code> 有各种资源的informer</p>
<h3 id="informer">informer<a class="headerlink" href="#informer" title="Permanent link">&para;</a></h3>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>inform: 通知 的意思<br>
<strong><font color="red">每一个k8s资源上都实现了Informer机制</font></strong><br>
<mark class="critic">通过informer与apiserver进行通信,保证通信的实时性、可靠性、顺序性等</mark><br>
informer到底是如何工作的呢?</p>
</div>
<h4 id="_10">先看看一个简单例子<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span>
<span class="normal"><a href="#__codelineno-38-12">12</a></span>
<span class="normal"><a href="#__codelineno-38-13">13</a></span>
<span class="normal"><a href="#__codelineno-38-14">14</a></span>
<span class="normal"><a href="#__codelineno-38-15">15</a></span>
<span class="normal"><a href="#__codelineno-38-16">16</a></span>
<span class="normal"><a href="#__codelineno-38-17">17</a></span>
<span class="normal"><a href="#__codelineno-38-18">18</a></span>
<span class="normal"><a href="#__codelineno-38-19">19</a></span>
<span class="normal"><a href="#__codelineno-38-20">20</a></span>
<span class="normal"><a href="#__codelineno-38-21">21</a></span>
<span class="normal"><a href="#__codelineno-38-22">22</a></span>
<span class="normal"><a href="#__codelineno-38-23">23</a></span>
<span class="normal"><a href="#__codelineno-38-24">24</a></span>
<span class="normal"><a href="#__codelineno-38-25">25</a></span>
<span class="normal"><a href="#__codelineno-38-26">26</a></span>
<span class="normal"><a href="#__codelineno-38-27">27</a></span>
<span class="normal"><a href="#__codelineno-38-28">28</a></span>
<span class="normal"><a href="#__codelineno-38-29">29</a></span>
<span class="normal"><a href="#__codelineno-38-30">30</a></span>
<span class="normal"><a href="#__codelineno-38-31">31</a></span>
<span class="normal"><a href="#__codelineno-38-32">32</a></span>
<span class="normal"><a href="#__codelineno-38-33">33</a></span>
<span class="normal"><a href="#__codelineno-38-34">34</a></span>
<span class="normal"><a href="#__codelineno-38-35">35</a></span>
<span class="normal"><a href="#__codelineno-38-36">36</a></span>
<span class="normal"><a href="#__codelineno-38-37">37</a></span>
<span class="normal"><a href="#__codelineno-38-38">38</a></span>
<span class="normal"><a href="#__codelineno-38-39">39</a></span>
<span class="normal"><a href="#__codelineno-38-40">40</a></span>
<span class="normal"><a href="#__codelineno-38-41">41</a></span>
<span class="normal"><a href="#__codelineno-38-42">42</a></span>
<span class="normal"><a href="#__codelineno-38-43">43</a></span>
<span class="normal"><a href="#__codelineno-38-44">44</a></span>
<span class="normal"><a href="#__codelineno-38-45">45</a></span>
<span class="normal"><a href="#__codelineno-38-46">46</a></span>
<span class="normal"><a href="#__codelineno-38-47">47</a></span>
<span class="normal"><a href="#__codelineno-38-48">48</a></span>
<span class="normal"><a href="#__codelineno-38-49">49</a></span>
<span class="normal"><a href="#__codelineno-38-50">50</a></span>
<span class="normal"><a href="#__codelineno-38-51">51</a></span>
<span class="normal"><a href="#__codelineno-38-52">52</a></span>
<span class="normal"><a href="#__codelineno-38-53">53</a></span>
<span class="normal"><a href="#__codelineno-38-54">54</a></span>
<span class="normal"><a href="#__codelineno-38-55">55</a></span>
<span class="normal"><a href="#__codelineno-38-56">56</a></span>
<span class="normal"><a href="#__codelineno-38-57">57</a></span>
<span class="normal"><a href="#__codelineno-38-58">58</a></span>
<span class="normal"><a href="#__codelineno-38-59">59</a></span>
<span class="normal"><a href="#__codelineno-38-60">60</a></span>
<span class="normal"><a href="#__codelineno-38-61">61</a></span>
<span class="normal"><a href="#__codelineno-38-62">62</a></span>
<span class="normal"><a href="#__codelineno-38-63">63</a></span>
<span class="normal"><a href="#__codelineno-38-64">64</a></span>
<span class="normal"><a href="#__codelineno-38-65">65</a></span>
<span class="normal"><a href="#__codelineno-38-66">66</a></span>
<span class="normal"><a href="#__codelineno-38-67">67</a></span>
<span class="normal"><a href="#__codelineno-38-68">68</a></span>
<span class="normal"><a href="#__codelineno-38-69">69</a></span>
<span class="normal"><a href="#__codelineno-38-70">70</a></span>
<span class="normal"><a href="#__codelineno-38-71">71</a></span>
<span class="normal"><a href="#__codelineno-38-72">72</a></span>
<span class="normal"><a href="#__codelineno-38-73">73</a></span>
<span class="normal"><a href="#__codelineno-38-74">74</a></span>
<span class="normal"><a href="#__codelineno-38-75">75</a></span>
<span class="normal"><a href="#__codelineno-38-76">76</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2"></a>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">    </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="w">    </span><span class="s">&quot;path/filepath&quot;</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8"></a>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="w">    </span><span class="c1">// corev1 &quot;k8s.io/api/core/v1&quot;</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10"></a>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="w">    </span><span class="nx">metav1</span><span class="w"> </span><span class="s">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/informers&quot;</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/kubernetes&quot;</span>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/tools/cache&quot;</span>
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/tools/clientcmd&quot;</span>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/util/homedir&quot;</span>
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17"></a><span class="p">)</span>
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18"></a>
</span><span id="__span-38-19"><a id="__codelineno-38-19" name="__codelineno-38-19"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-20"><a id="__codelineno-38-20" name="__codelineno-38-20"></a><span class="w">    </span><span class="c1">// fmt.Println(reflect.TypeOf(&amp;corev1.Pod{}))</span>
</span><span id="__span-38-21"><a id="__codelineno-38-21" name="__codelineno-38-21"></a><span class="w">    </span><span class="c1">// return</span>
</span><span id="__span-38-22"><a id="__codelineno-38-22" name="__codelineno-38-22"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">kubeconfig</span><span class="w"> </span><span class="o">*</span><span class="kt">string</span>
</span><span id="__span-38-23"><a id="__codelineno-38-23" name="__codelineno-38-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">home</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">homedir</span><span class="p">.</span><span class="nx">HomeDir</span><span class="p">();</span><span class="w"> </span><span class="nx">home</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-24"><a id="__codelineno-38-24" name="__codelineno-38-24"></a><span class="w">        </span><span class="c1">// ~/.kube/config 确保你家目录下有k8s的配置文件</span>
</span><span id="__span-38-25"><a id="__codelineno-38-25" name="__codelineno-38-25"></a><span class="w">        </span><span class="c1">// 你本地可以用kubectl get po 进行查询.</span>
</span><span id="__span-38-26"><a id="__codelineno-38-26" name="__codelineno-38-26"></a><span class="w">        </span><span class="nx">kubeconfig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;kubeconfig&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">home</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.kube&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;config&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;(optional) absolute path to the kubeconfig file&quot;</span><span class="p">)</span>
</span><span id="__span-38-27"><a id="__codelineno-38-27" name="__codelineno-38-27"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-28"><a id="__codelineno-38-28" name="__codelineno-38-28"></a><span class="w">        </span><span class="nx">kubeconfig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;kubeconfig&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;absolute path to the kubeconfig file&quot;</span><span class="p">)</span>
</span><span id="__span-38-29"><a id="__codelineno-38-29" name="__codelineno-38-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-30"><a id="__codelineno-38-30" name="__codelineno-38-30"></a><span class="w">    </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
</span><span id="__span-38-31"><a id="__codelineno-38-31" name="__codelineno-38-31"></a>
</span><span id="__span-38-32"><a id="__codelineno-38-32" name="__codelineno-38-32"></a><span class="w">    </span><span class="c1">// 使用指定的kubeconfig文件创建一个Config对象</span>
</span><span id="__span-38-33"><a id="__codelineno-38-33" name="__codelineno-38-33"></a><span class="w">    </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">clientcmd</span><span class="p">.</span><span class="nx">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="nx">kubeconfig</span><span class="p">)</span>
</span><span id="__span-38-34"><a id="__codelineno-38-34" name="__codelineno-38-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-35"><a id="__codelineno-38-35" name="__codelineno-38-35"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span id="__span-38-36"><a id="__codelineno-38-36" name="__codelineno-38-36"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-37"><a id="__codelineno-38-37" name="__codelineno-38-37"></a>
</span><span id="__span-38-38"><a id="__codelineno-38-38" name="__codelineno-38-38"></a><span class="w">    </span><span class="c1">// 创建一个新的Kubernetes客户端</span>
</span><span id="__span-38-39"><a id="__codelineno-38-39" name="__codelineno-38-39"></a><span class="w">    </span><span class="nx">clientset</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</span><span id="__span-38-40"><a id="__codelineno-38-40" name="__codelineno-38-40"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-41"><a id="__codelineno-38-41" name="__codelineno-38-41"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span id="__span-38-42"><a id="__codelineno-38-42" name="__codelineno-38-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-43"><a id="__codelineno-38-43" name="__codelineno-38-43"></a>
</span><span id="__span-38-44"><a id="__codelineno-38-44" name="__codelineno-38-44"></a><span class="w">    </span><span class="nx">stopCh</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span>
</span><span id="__span-38-45"><a id="__codelineno-38-45" name="__codelineno-38-45"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nb">close</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-38-46"><a id="__codelineno-38-46" name="__codelineno-38-46"></a><span class="w">    </span><span class="nx">sharedInformerFactory</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">informers</span><span class="p">.</span><span class="nx">NewSharedInformerFactory</span><span class="p">(</span>
</span><span id="__span-38-47"><a id="__codelineno-38-47" name="__codelineno-38-47"></a><span class="w">        </span><span class="c1">// 需要这个 与apiserver 交互</span>
</span><span id="__span-38-48"><a id="__codelineno-38-48" name="__codelineno-38-48"></a><span class="w">        </span><span class="nx">clientset</span><span class="p">,</span>
</span><span id="__span-38-49"><a id="__codelineno-38-49" name="__codelineno-38-49"></a><span class="w">        </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span>
</span><span id="__span-38-50"><a id="__codelineno-38-50" name="__codelineno-38-50"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-38-51"><a id="__codelineno-38-51" name="__codelineno-38-51"></a><span class="w">    </span><span class="c1">// 获取pod资源的informer 对象,监听谁</span>
</span><span id="__span-38-52"><a id="__codelineno-38-52" name="__codelineno-38-52"></a><span class="w">    </span><span class="nx">informer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sharedInformerFactory</span><span class="p">.</span><span class="nx">Core</span><span class="p">().</span><span class="nx">V1</span><span class="p">().</span><span class="nx">Pods</span><span class="p">().</span><span class="nx">Informer</span><span class="p">()</span>
</span><span id="__span-38-53"><a id="__codelineno-38-53" name="__codelineno-38-53"></a><span class="w">    </span><span class="c1">// informer2 := sharedInformers.Core().V1().Pods().Informer()</span>
</span><span id="__span-38-54"><a id="__codelineno-38-54" name="__codelineno-38-54"></a>
</span><span id="__span-38-55"><a id="__codelineno-38-55" name="__codelineno-38-55"></a><span class="w">    </span><span class="nx">informer</span><span class="p">.</span><span class="nx">AddEventHandler</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
</span><span id="__span-38-56"><a id="__codelineno-38-56" name="__codelineno-38-56"></a><span class="w">        </span><span class="c1">// 创建pod 资源时触发的事件回调方法</span>
</span><span id="__span-38-57"><a id="__codelineno-38-57" name="__codelineno-38-57"></a><span class="w">        </span><span class="nx">AddFunc</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">obj</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-58"><a id="__codelineno-38-58" name="__codelineno-38-58"></a><span class="w">            </span><span class="c1">// k8s实际这里是将 事件推送到 workQueue</span>
</span><span id="__span-38-59"><a id="__codelineno-38-59" name="__codelineno-38-59"></a><span class="w">            </span><span class="c1">// 我们例子直接打印看看</span>
</span><span id="__span-38-60"><a id="__codelineno-38-60" name="__codelineno-38-60"></a><span class="w">            </span><span class="nx">metav1Obj</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span><span id="__span-38-61"><a id="__codelineno-38-61" name="__codelineno-38-61"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;新的pod被添加到缓存中&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">metav1Obj</span><span class="p">.</span><span class="nx">GetName</span><span class="p">())</span>
</span><span id="__span-38-62"><a id="__codelineno-38-62" name="__codelineno-38-62"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-38-63"><a id="__codelineno-38-63" name="__codelineno-38-63"></a><span class="w">        </span><span class="nx">DeleteFunc</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">obj</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-64"><a id="__codelineno-38-64" name="__codelineno-38-64"></a><span class="w">            </span><span class="nx">metav1Obj</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span><span id="__span-38-65"><a id="__codelineno-38-65" name="__codelineno-38-65"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;pod从缓存中删除&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">metav1Obj</span><span class="p">.</span><span class="nx">GetName</span><span class="p">())</span>
</span><span id="__span-38-66"><a id="__codelineno-38-66" name="__codelineno-38-66"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-38-67"><a id="__codelineno-38-67" name="__codelineno-38-67"></a><span class="w">        </span><span class="nx">UpdateFunc</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span><span class="w"> </span><span class="nx">newObj</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-68"><a id="__codelineno-38-68" name="__codelineno-38-68"></a><span class="w">            </span><span class="nx">oObj</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">oldObj</span><span class="p">.(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span><span id="__span-38-69"><a id="__codelineno-38-69" name="__codelineno-38-69"></a><span class="w">            </span><span class="nx">nObj</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newObj</span><span class="p">.(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span><span id="__span-38-70"><a id="__codelineno-38-70" name="__codelineno-38-70"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%s pod updated to %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">oObj</span><span class="p">.</span><span class="nx">GetName</span><span class="p">(),</span><span class="w"> </span><span class="nx">nObj</span><span class="p">.</span><span class="nx">GetName</span><span class="p">())</span>
</span><span id="__span-38-71"><a id="__codelineno-38-71" name="__codelineno-38-71"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-38-72"><a id="__codelineno-38-72" name="__codelineno-38-72"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-38-73"><a id="__codelineno-38-73" name="__codelineno-38-73"></a><span class="w">    </span><span class="nx">informer</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-38-74"><a id="__codelineno-38-74" name="__codelineno-38-74"></a><span class="w">    </span><span class="c1">// sharedInformerFactory.Start(stopCh)</span>
</span><span id="__span-38-75"><a id="__codelineno-38-75" name="__codelineno-38-75"></a>
</span><span id="__span-38-76"><a id="__codelineno-38-76" name="__codelineno-38-76"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-go highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">SharedInformer</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-39-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-39-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-39-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-39-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-39-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-39-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-39-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-39-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-39-10">10</a></span>
<span class="normal"><a href="#__codelineno-39-11">11</a></span>
<span class="normal"><a href="#__codelineno-39-12">12</a></span>
<span class="normal"><a href="#__codelineno-39-13">13</a></span>
<span class="normal"><a href="#__codelineno-39-14">14</a></span>
<span class="normal"><a href="#__codelineno-39-15">15</a></span>
<span class="normal"><a href="#__codelineno-39-16">16</a></span>
<span class="normal"><a href="#__codelineno-39-17">17</a></span>
<span class="normal"><a href="#__codelineno-39-18">18</a></span>
<span class="normal"><a href="#__codelineno-39-19">19</a></span>
<span class="normal"><a href="#__codelineno-39-20">20</a></span>
<span class="normal"><a href="#__codelineno-39-21">21</a></span>
<span class="normal"><a href="#__codelineno-39-22">22</a></span>
<span class="normal"><a href="#__codelineno-39-23">23</a></span>
<span class="normal"><a href="#__codelineno-39-24">24</a></span>
<span class="normal"><a href="#__codelineno-39-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">podInformer</span><span class="p">)</span><span class="w"> </span><span class="nx">Informer</span><span class="p">()</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">factory</span><span class="p">.</span><span class="nx">InformerFor</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{},</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">defaultInformer</span><span class="p">)</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="p">}</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4"></a>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">sharedInformerFactory</span><span class="p">)</span><span class="w"> </span><span class="nx">InformerFor</span><span class="p">(</span><span class="nx">obj</span><span class="w"> </span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span><span class="w"> </span><span class="nx">newFunc</span><span class="w"> </span><span class="nx">internalinterfaces</span><span class="p">.</span><span class="nx">NewInformerFunc</span><span class="p">)</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6"></a>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7"></a><span class="w">    </span><span class="nx">informerType</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8"></a><span class="hll"><span class="w">    </span><span class="nx">informer</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">informers</span><span class="p">[</span><span class="nx">informerType</span><span class="p">]</span>
</span></span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9"></a><span class="w">    </span><span class="c1">// 对于同一个类型的资源 ,不需要重复创建</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10"></a><span class="w">    </span><span class="c1">// 存在就直接返回</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">informer</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14"></a>
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15"></a><span class="w">    </span><span class="nx">resyncPeriod</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">customResync</span><span class="p">[</span><span class="nx">informerType</span><span class="p">]</span>
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">exists</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-17"><a id="__codelineno-39-17" name="__codelineno-39-17"></a><span class="w">        </span><span class="nx">resyncPeriod</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">defaultResync</span>
</span><span id="__span-39-18"><a id="__codelineno-39-18" name="__codelineno-39-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-19"><a id="__codelineno-39-19" name="__codelineno-39-19"></a>
</span><span id="__span-39-20"><a id="__codelineno-39-20" name="__codelineno-39-20"></a><span class="w">    </span><span class="nx">informer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newFunc</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">resyncPeriod</span><span class="p">)</span>
</span><span id="__span-39-21"><a id="__codelineno-39-21" name="__codelineno-39-21"></a><span class="w">    </span><span class="c1">// 第一次 设置</span>
</span><span id="__span-39-22"><a id="__codelineno-39-22" name="__codelineno-39-22"></a><span class="hll"><span class="w">    </span><span class="nx">f</span><span class="p">.</span><span class="nx">informers</span><span class="p">[</span><span class="nx">informerType</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">informer</span>
</span></span><span id="__span-39-23"><a id="__codelineno-39-23" name="__codelineno-39-23"></a>
</span><span id="__span-39-24"><a id="__codelineno-39-24" name="__codelineno-39-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">informer</span>
</span><span id="__span-39-25"><a id="__codelineno-39-25" name="__codelineno-39-25"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="reflector">Reflector<a class="headerlink" href="#reflector" title="Permanent link">&para;</a></h4>
<h5 id="bookmark-event">Bookmark event<a class="headerlink" href="#bookmark-event" title="Permanent link">&para;</a></h5>
<p><a href="https://kubernetes.io/zh-cn/docs/reference/using-api/api-concepts/#Watch-bookmark">watch bookmark</a></p>
<p>pod list 后, watch 里比如一直没有pod资源的事件, 其他资源的事件很多导致 resourceVersion 变大了很多,
然后由于k8s etcd 5分钟就会compact, 然后某个时候 pod 的informer 出了问题,后重新连接, 我们需要重新开始同步 ,使用list, 会用之前存的比较老的resourceVersion,但是这个可能已经被compact过的, 这样会导致错误,然后重新 从etcd 全量拉取</p>
<div class="admonition danger">
<p class="admonition-title">重要说明</p>
<p>官方文档里写了, 就算你指定了allowWatchBookmarks=true 查询参数来请求 BOOKMARK 事件, 你也不能认为bookmark事件会在某一个特定的时间间隔触发<br>
http://localhost:8001/api/v1/namespaces/default/pods?watch=1&amp;allowWatchBookmarks=true</p>
</div>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-40-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-40-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-40-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-40-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-40-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-40-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-40-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-40-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-40-10">10</a></span>
<span class="normal"><a href="#__codelineno-40-11">11</a></span>
<span class="normal"><a href="#__codelineno-40-12">12</a></span>
<span class="normal"><a href="#__codelineno-40-13">13</a></span>
<span class="normal"><a href="#__codelineno-40-14">14</a></span>
<span class="normal"><a href="#__codelineno-40-15">15</a></span>
<span class="normal"><a href="#__codelineno-40-16">16</a></span>
<span class="normal"><a href="#__codelineno-40-17">17</a></span>
<span class="normal"><a href="#__codelineno-40-18">18</a></span>
<span class="normal"><a href="#__codelineno-40-19">19</a></span>
<span class="normal"><a href="#__codelineno-40-20">20</a></span>
<span class="normal"><a href="#__codelineno-40-21">21</a></span>
<span class="normal"><a href="#__codelineno-40-22">22</a></span>
<span class="normal"><a href="#__codelineno-40-23">23</a></span>
<span class="normal"><a href="#__codelineno-40-24">24</a></span>
<span class="normal"><a href="#__codelineno-40-25">25</a></span>
<span class="normal"><a href="#__codelineno-40-26">26</a></span>
<span class="normal"><a href="#__codelineno-40-27">27</a></span>
<span class="normal"><a href="#__codelineno-40-28">28</a></span>
<span class="normal"><a href="#__codelineno-40-29">29</a></span>
<span class="normal"><a href="#__codelineno-40-30">30</a></span>
<span class="normal"><a href="#__codelineno-40-31">31</a></span>
<span class="normal"><a href="#__codelineno-40-32">32</a></span>
<span class="normal"><a href="#__codelineno-40-33">33</a></span>
<span class="normal"><a href="#__codelineno-40-34">34</a></span>
<span class="normal"><a href="#__codelineno-40-35">35</a></span>
<span class="normal"><a href="#__codelineno-40-36">36</a></span>
<span class="normal"><a href="#__codelineno-40-37">37</a></span>
<span class="normal"><a href="#__codelineno-40-38">38</a></span>
<span class="normal"><a href="#__codelineno-40-39">39</a></span>
<span class="normal"><a href="#__codelineno-40-40">40</a></span>
<span class="normal"><a href="#__codelineno-40-41">41</a></span>
<span class="normal"><a href="#__codelineno-40-42">42</a></span>
<span class="normal"><a href="#__codelineno-40-43">43</a></span>
<span class="normal"><a href="#__codelineno-40-44">44</a></span>
<span class="normal"><a href="#__codelineno-40-45">45</a></span>
<span class="normal"><a href="#__codelineno-40-46">46</a></span>
<span class="normal"><a href="#__codelineno-40-47">47</a></span>
<span class="normal"><a href="#__codelineno-40-48">48</a></span>
<span class="normal"><a href="#__codelineno-40-49">49</a></span>
<span class="normal"><a href="#__codelineno-40-50">50</a></span>
<span class="normal"><a href="#__codelineno-40-51">51</a></span>
<span class="normal"><a href="#__codelineno-40-52">52</a></span>
<span class="normal"><a href="#__codelineno-40-53">53</a></span>
<span class="normal"><a href="#__codelineno-40-54">54</a></span>
<span class="normal"><a href="#__codelineno-40-55">55</a></span>
<span class="normal"><a href="#__codelineno-40-56">56</a></span>
<span class="normal"><a href="#__codelineno-40-57">57</a></span>
<span class="normal"><a href="#__codelineno-40-58">58</a></span>
<span class="normal"><a href="#__codelineno-40-59">59</a></span>
<span class="normal"><a href="#__codelineno-40-60">60</a></span>
<span class="normal"><a href="#__codelineno-40-61">61</a></span>
<span class="normal"><a href="#__codelineno-40-62">62</a></span>
<span class="normal"><a href="#__codelineno-40-63">63</a></span>
<span class="normal"><a href="#__codelineno-40-64">64</a></span>
<span class="normal"><a href="#__codelineno-40-65">65</a></span>
<span class="normal"><a href="#__codelineno-40-66">66</a></span>
<span class="normal"><a href="#__codelineno-40-67">67</a></span>
<span class="normal"><a href="#__codelineno-40-68">68</a></span>
<span class="normal"><a href="#__codelineno-40-69">69</a></span>
<span class="normal"><a href="#__codelineno-40-70">70</a></span>
<span class="normal"><a href="#__codelineno-40-71">71</a></span>
<span class="normal"><a href="#__codelineno-40-72">72</a></span>
<span class="normal"><a href="#__codelineno-40-73">73</a></span>
<span class="normal"><a href="#__codelineno-40-74">74</a></span>
<span class="normal"><a href="#__codelineno-40-75">75</a></span>
<span class="normal"><a href="#__codelineno-40-76">76</a></span>
<span class="normal"><a href="#__codelineno-40-77">77</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2"></a>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="w">    </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7"></a><span class="w">    </span><span class="s">&quot;log&quot;</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8"></a><span class="w">    </span><span class="s">&quot;path/filepath&quot;</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10"></a>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11"></a><span class="w">    </span><span class="nx">corev1</span><span class="w"> </span><span class="s">&quot;k8s.io/api/core/v1&quot;</span>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12"></a><span class="w">    </span><span class="nx">metav1</span><span class="w"> </span><span class="s">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13"></a><span class="w">    </span><span class="s">&quot;k8s.io/apimachinery/pkg/watch&quot;</span>
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/kubernetes&quot;</span>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/tools/clientcmd&quot;</span>
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/util/homedir&quot;</span>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17"></a><span class="p">)</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18"></a>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">kubeconfig</span><span class="w"> </span><span class="o">*</span><span class="kt">string</span>
</span><span id="__span-40-21"><a id="__codelineno-40-21" name="__codelineno-40-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">home</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">homedir</span><span class="p">.</span><span class="nx">HomeDir</span><span class="p">();</span><span class="w"> </span><span class="nx">home</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-22"><a id="__codelineno-40-22" name="__codelineno-40-22"></a><span class="w">        </span><span class="nx">kubeconfig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;kubeconfig&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">home</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.kube&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;config&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;(optional) absolute path to the kubeconfig file&quot;</span><span class="p">)</span>
</span><span id="__span-40-23"><a id="__codelineno-40-23" name="__codelineno-40-23"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-24"><a id="__codelineno-40-24" name="__codelineno-40-24"></a><span class="w">        </span><span class="nx">kubeconfig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;kubeconfig&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;absolute path to the kubeconfig file&quot;</span><span class="p">)</span>
</span><span id="__span-40-25"><a id="__codelineno-40-25" name="__codelineno-40-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-26"><a id="__codelineno-40-26" name="__codelineno-40-26"></a><span class="w">    </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
</span><span id="__span-40-27"><a id="__codelineno-40-27" name="__codelineno-40-27"></a>
</span><span id="__span-40-28"><a id="__codelineno-40-28" name="__codelineno-40-28"></a><span class="w">    </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">clientcmd</span><span class="p">.</span><span class="nx">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="nx">kubeconfig</span><span class="p">)</span>
</span><span id="__span-40-29"><a id="__codelineno-40-29" name="__codelineno-40-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-30"><a id="__codelineno-40-30" name="__codelineno-40-30"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span id="__span-40-31"><a id="__codelineno-40-31" name="__codelineno-40-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-32"><a id="__codelineno-40-32" name="__codelineno-40-32"></a>
</span><span id="__span-40-33"><a id="__codelineno-40-33" name="__codelineno-40-33"></a><span class="w">    </span><span class="nx">clientset</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</span><span id="__span-40-34"><a id="__codelineno-40-34" name="__codelineno-40-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-35"><a id="__codelineno-40-35" name="__codelineno-40-35"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span id="__span-40-36"><a id="__codelineno-40-36" name="__codelineno-40-36"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-37"><a id="__codelineno-40-37" name="__codelineno-40-37"></a><span class="w">    </span><span class="nx">watcher</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">clientset</span><span class="p">.</span><span class="nx">CoreV1</span><span class="p">().</span><span class="nx">Pods</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">).</span><span class="nx">Watch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span>
</span><span id="__span-40-38"><a id="__codelineno-40-38" name="__codelineno-40-38"></a><span class="w">        </span><span class="c1">// LabelSelector: &quot;app=pod-vol,run=test&quot;,</span>
</span><span id="__span-40-39"><a id="__codelineno-40-39" name="__codelineno-40-39"></a><span class="w">        </span><span class="nx">AllowWatchBookmarks</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-40-40"><a id="__codelineno-40-40" name="__codelineno-40-40"></a><span class="w">        </span><span class="nx">ResourceVersion</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;2937860&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// ResourceVersion 如果已经被压缩过, 不会报错</span>
</span><span id="__span-40-41"><a id="__codelineno-40-41" name="__codelineno-40-41"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-40-42"><a id="__codelineno-40-42" name="__codelineno-40-42"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-43"><a id="__codelineno-40-43" name="__codelineno-40-43"></a><span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-40-44"><a id="__codelineno-40-44" name="__codelineno-40-44"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-45"><a id="__codelineno-40-45" name="__codelineno-40-45"></a>
</span><span id="__span-40-46"><a id="__codelineno-40-46" name="__codelineno-40-46"></a><span class="nx">Loop</span><span class="p">:</span>
</span><span id="__span-40-47"><a id="__codelineno-40-47" name="__codelineno-40-47"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-48"><a id="__codelineno-40-48" name="__codelineno-40-48"></a><span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-49"><a id="__codelineno-40-49" name="__codelineno-40-49"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">watcher</span><span class="p">.</span><span class="nx">ResultChan</span><span class="p">():</span>
</span><span id="__span-40-50"><a id="__codelineno-40-50" name="__codelineno-40-50"></a><span class="w">            </span><span class="c1">// meta, err := meta.Accessor(event.Object)</span>
</span><span id="__span-40-51"><a id="__codelineno-40-51" name="__codelineno-40-51"></a><span class="w">            </span><span class="c1">// newResourceVersion := meta.GetResourceVersion()</span>
</span><span id="__span-40-52"><a id="__codelineno-40-52" name="__codelineno-40-52"></a><span class="w">            </span><span class="c1">// meta, _ := meta.Accessor(event.Object)</span>
</span><span id="__span-40-53"><a id="__codelineno-40-53" name="__codelineno-40-53"></a>
</span><span id="__span-40-54"><a id="__codelineno-40-54" name="__codelineno-40-54"></a><span class="w">            </span><span class="nx">pod</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Object</span><span class="p">.(</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span>
</span><span id="__span-40-55"><a id="__codelineno-40-55" name="__codelineno-40-55"></a><span class="w">            </span><span class="nx">newResourceVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">pod</span><span class="p">.</span><span class="nx">GetResourceVersion</span><span class="p">()</span>
</span><span id="__span-40-56"><a id="__codelineno-40-56" name="__codelineno-40-56"></a>
</span><span id="__span-40-57"><a id="__codelineno-40-57" name="__codelineno-40-57"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-58"><a id="__codelineno-40-58" name="__codelineno-40-58"></a><span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;xxxx::&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">pod</span><span class="p">)</span>
</span><span id="__span-40-59"><a id="__codelineno-40-59" name="__codelineno-40-59"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-40-60"><a id="__codelineno-40-60" name="__codelineno-40-60"></a><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Type</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-61"><a id="__codelineno-40-61" name="__codelineno-40-61"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">watch</span><span class="p">.</span><span class="nx">Added</span><span class="p">:</span>
</span><span id="__span-40-62"><a id="__codelineno-40-62" name="__codelineno-40-62"></a><span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Pod %s added: %s,%s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">pod</span><span class="p">.</span><span class="nx">GetResourceVersion</span><span class="p">(),</span><span class="w"> </span><span class="nx">pod</span><span class="p">.</span><span class="nx">ResourceVersion</span><span class="p">)</span>
</span><span id="__span-40-63"><a id="__codelineno-40-63" name="__codelineno-40-63"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">watch</span><span class="p">.</span><span class="nx">Modified</span><span class="p">:</span>
</span><span id="__span-40-64"><a id="__codelineno-40-64" name="__codelineno-40-64"></a><span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Pod %s modified: %s,%s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">pod</span><span class="p">.</span><span class="nx">GetResourceVersion</span><span class="p">(),</span><span class="w"> </span><span class="nx">pod</span><span class="p">.</span><span class="nx">ResourceVersion</span><span class="p">)</span>
</span><span id="__span-40-65"><a id="__codelineno-40-65" name="__codelineno-40-65"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">watch</span><span class="p">.</span><span class="nx">Deleted</span><span class="p">:</span>
</span><span id="__span-40-66"><a id="__codelineno-40-66" name="__codelineno-40-66"></a><span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Pod deleted: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span><span id="__span-40-67"><a id="__codelineno-40-67" name="__codelineno-40-67"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">watch</span><span class="p">.</span><span class="nx">Bookmark</span><span class="p">:</span>
</span><span id="__span-40-68"><a id="__codelineno-40-68" name="__codelineno-40-68"></a><span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;book:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Format</span><span class="p">(</span><span class="s">&quot;15:04:05&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">newResourceVersion</span><span class="p">)</span>
</span><span id="__span-40-69"><a id="__codelineno-40-69" name="__codelineno-40-69"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-40-70"><a id="__codelineno-40-70" name="__codelineno-40-70"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nx">After</span><span class="p">(</span><span class="mi">6660</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span>
</span><span id="__span-40-71"><a id="__codelineno-40-71" name="__codelineno-40-71"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>
</span><span id="__span-40-72"><a id="__codelineno-40-72" name="__codelineno-40-72"></a><span class="w">            </span><span class="k">break</span><span class="w"> </span><span class="nx">Loop</span>
</span><span id="__span-40-73"><a id="__codelineno-40-73" name="__codelineno-40-73"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-40-74"><a id="__codelineno-40-74" name="__codelineno-40-74"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-75"><a id="__codelineno-40-75" name="__codelineno-40-75"></a>
</span><span id="__span-40-76"><a id="__codelineno-40-76" name="__codelineno-40-76"></a>
</span><span id="__span-40-77"><a id="__codelineno-40-77" name="__codelineno-40-77"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">执行的结果...</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span>
<span class="normal"><a href="#__codelineno-41-2">2</a></span>
<span class="normal"><a href="#__codelineno-41-3">3</a></span>
<span class="normal"><a href="#__codelineno-41-4">4</a></span>
<span class="normal"><a href="#__codelineno-41-5">5</a></span>
<span class="normal"><a href="#__codelineno-41-6">6</a></span>
<span class="normal"><a href="#__codelineno-41-7">7</a></span>
<span class="normal"><a href="#__codelineno-41-8">8</a></span>
<span class="normal"><a href="#__codelineno-41-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1"></a>book:  16:15:22 2939960
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2"></a>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3"></a>book:  16:16:22 2939960
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4"></a>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5"></a>book:  16:17:22 2939960
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6"></a>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7"></a>book:  16:18:22 2939960
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8"></a>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9"></a>book:  16:19:22 2939960
</span></code></pre></div></td></tr></table></div>
<div class="admonition question">
<p class="admonition-title">代码还没有细看,回答暂时都是我的猜测</p>
<ul>
<li>问:<ul>
<li>根据代码测试, 发现大概1分钟(根据上面的重要说明,这个不用纠结它)能接收到bookmark 事件, 但是收到的resourceVersion 一直都是旧的, 很久后的bookmark事件收到的resourceVersion 才是稍微新一点的, 这和我们上面说的bookmark的目的有点相违背了?</li>
</ul>
</li>
<li>答:<ul>
<li>我们访问的是实际是APIServer(数据它给的), APIServer 也有 listAndWatch, 从etcd那里获取数据缓存到它的本地, 而如果没有对应的事件, apiserver缓存就不会更新resourceVersion, etcd是没有bookmark 事件的, bookmark是apiserver设计提供给其他客户端的一种事件.</li>
<li>我们访问 <code>http://localhost:8001/api/v1/namespaces/default/pods?resourceVersion=2939961</code> 会发现提示Too large resource version,所以首先上面的结果一直没变是对的,因为apiserver本身就没有更新resourceVersion, 然而实际上 etcd已经compact了, 这个版本在etcd里已经不存在了.</li>
<li>不同资源更新后设置自己更新时的resourceVersion,在上面的环境中,<code>k create sa sa-test ,再获取它的resourceVersion rv</code>,<code>http://localhost:8001/api/v1/namespaces/default/serviceaccounts?resourceVersion=rv</code> ok, 去 <code>pods?resourceVersion=rv</code> 报错Too large resource version</li>
<li><mark>需要再确认</mark></li>
</ul>
</li>
<li>问:<ul>
<li>如果一直没有对应事件, apiserver不可能一直不更新resourceVersion, 那么大概多久?</li>
</ul>
</li>
<li>答:<ul>
<li>10分钟?  <code>cmd/kube-apiserver/app/server.go</code></li>
<li><code>versionedInformers = clientgoinformers.NewSharedInformerFactory(clientgoExternalClient, 10*time.Minute)</code></li>
<li><mark class="critic">我给出的答案可能是不对的, 我先标记一下,后续等看apiserver 源码再修改.</mark></li>
</ul>
</li>
</ul>
</div>
<div class="language-go highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">关于间隔1分钟</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-42-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-42-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-42-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-42-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-42-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-42-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-42-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-42-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-42-10">10</a></span>
<span class="normal"><a href="#__codelineno-42-11">11</a></span>
<span class="normal"><a href="#__codelineno-42-12">12</a></span>
<span class="normal"><a href="#__codelineno-42-13">13</a></span>
<span class="normal"><a href="#__codelineno-42-14">14</a></span>
<span class="normal"><a href="#__codelineno-42-15">15</a></span>
<span class="normal"><a href="#__codelineno-42-16">16</a></span>
<span class="normal"><a href="#__codelineno-42-17">17</a></span>
<span class="normal"><a href="#__codelineno-42-18">18</a></span>
<span class="normal"><a href="#__codelineno-42-19">19</a></span>
<span class="normal"><a href="#__codelineno-42-20">20</a></span>
<span class="normal"><a href="#__codelineno-42-21">21</a></span>
<span class="normal"><a href="#__codelineno-42-22">22</a></span>
<span class="normal"><a href="#__codelineno-42-23">23</a></span>
<span class="normal"><a href="#__codelineno-42-24">24</a></span>
<span class="normal"><a href="#__codelineno-42-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="c1">// staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">watcherBookmarkTimeBuckets</span><span class="p">)</span><span class="w"> </span><span class="nx">addWatcher</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">cacheWatcher</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="w">    </span><span class="nx">nextTime</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">nextBookmarkTime</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">clock</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">bookmarkFrequency</span><span class="p">)</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="w">    </span><span class="c1">//...</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="p">}</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6"></a><span class="kd">func</span><span class="w"> </span><span class="nx">newTimeBucketWatchers</span><span class="p">(</span><span class="nx">clock</span><span class="w"> </span><span class="nx">clock</span><span class="p">.</span><span class="nx">Clock</span><span class="p">,</span><span class="w"> </span><span class="nx">bookmarkFrequency</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">watcherBookmarkTimeBuckets</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">watcherBookmarkTimeBuckets</span><span class="p">{</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="w">        </span><span class="nx">watchersBuckets</span><span class="p">:</span><span class="w">   </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int64</span><span class="p">][]</span><span class="o">*</span><span class="nx">cacheWatcher</span><span class="p">),</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9"></a><span class="w">        </span><span class="nx">createTime</span><span class="p">:</span><span class="w">        </span><span class="nx">clock</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10"></a><span class="w">        </span><span class="nx">startBucketID</span><span class="p">:</span><span class="w">     </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11"></a><span class="w">        </span><span class="nx">clock</span><span class="p">:</span><span class="w">             </span><span class="nx">clock</span><span class="p">,</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12"></a><span class="w">        </span><span class="nx">bookmarkFrequency</span><span class="p">:</span><span class="w"> </span><span class="nx">bookmarkFrequency</span><span class="p">,</span>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14"></a><span class="p">}</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15"></a>
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewCacherFromConfig</span><span class="p">(</span><span class="nx">config</span><span class="w"> </span><span class="nx">Config</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Cacher</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17"></a><span class="w">    </span><span class="c1">//...</span>
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18"></a><span class="w">    </span><span class="nx">cacher</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Cacher</span><span class="p">{</span>
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19"></a><span class="w">        </span><span class="c1">// ...</span>
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20"></a><span class="w">        </span><span class="nx">bookmarkWatchers</span><span class="p">:</span><span class="w"> </span><span class="nx">newTimeBucketWatchers</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Clock</span><span class="p">,</span><span class="w"> </span><span class="nx">defaultBookmarkFrequency</span><span class="p">),</span>
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22"></a><span class="p">}</span>
</span><span id="__span-42-23"><a id="__codelineno-42-23" name="__codelineno-42-23"></a><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-42-24"><a id="__codelineno-42-24" name="__codelineno-42-24"></a><span class="w">    </span><span class="nx">defaultBookmarkFrequency</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span>
</span><span id="__span-42-25"><a id="__codelineno-42-25" name="__codelineno-42-25"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="deltafifo">DeltaFIFO<a class="headerlink" href="#deltafifo" title="Permanent link">&para;</a></h4>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>前面我们看到, Reflector 通过 ListAndWatch 将数据先都添加到 DeltaFIFO 这个队列中去了 <br>
接下来看看这个的具体情况<br>
delta: 在数学中表示变化量</p>
</div>
<object type="image/svg+xml" data="/images/controller-manager-2a9c9cc78918bca4f587bdf8f4284e08.svg" style="max-width:100%"></object>

<div class="tabbed-set tabbed-alternate" data-tabs="11:1"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="__tabbed_11_1">DeltaFIFO</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>items存放的</li>
</ol>
<p><div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-43-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-43-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-43-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-43-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-43-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-43-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-43-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-43-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-43-10">10</a></span>
<span class="normal"><a href="#__codelineno-43-11">11</a></span>
<span class="normal"><a href="#__codelineno-43-12">12</a></span>
<span class="normal"><a href="#__codelineno-43-13">13</a></span>
<span class="normal"><a href="#__codelineno-43-14">14</a></span>
<span class="normal"><a href="#__codelineno-43-15">15</a></span>
<span class="normal"><a href="#__codelineno-43-16">16</a></span>
<span class="normal"><a href="#__codelineno-43-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">Deltas</span><span class="w"> </span><span class="p">[]</span><span class="nx">Delta</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2"></a>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="c1">// 存放的资源对象的变化</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="kd">type</span><span class="w"> </span><span class="nx">Delta</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5"></a><span class="w">    </span><span class="nx">Type</span><span class="w">   </span><span class="nx">DeltaType</span><span class="w"> </span><span class="c1">// 变化的类型</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6"></a><span class="w">    </span><span class="nx">Object</span><span class="w"> </span><span class="kd">interface</span><span class="p">{}</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7"></a><span class="p">}</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8"></a>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9"></a><span class="kd">type</span><span class="w"> </span><span class="nx">DeltaType</span><span class="w"> </span><span class="kt">string</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10"></a>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12"></a><span class="w">    </span><span class="nx">Added</span><span class="w">   </span><span class="nx">DeltaType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Added&quot;</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13"></a><span class="w">    </span><span class="nx">Updated</span><span class="w"> </span><span class="nx">DeltaType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Updated&quot;</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14"></a><span class="w">    </span><span class="nx">Deleted</span><span class="w"> </span><span class="nx">DeltaType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Deleted&quot;</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15"></a><span class="w">    </span><span class="nx">Replaced</span><span class="w"> </span><span class="nx">DeltaType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Replaced&quot;</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16"></a><span class="w">    </span><span class="nx">Sync</span><span class="w"> </span><span class="nx">DeltaType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Sync&quot;</span>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
2. keyFunc</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-44-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-44-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-44-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-44-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-44-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-44-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-44-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-44-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-44-10">10</a></span>
<span class="normal"><a href="#__codelineno-44-11">11</a></span>
<span class="normal"><a href="#__codelineno-44-12">12</a></span>
<span class="normal"><a href="#__codelineno-44-13">13</a></span>
<span class="normal"><a href="#__codelineno-44-14">14</a></span>
<span class="normal"><a href="#__codelineno-44-15">15</a></span>
<span class="normal"><a href="#__codelineno-44-16">16</a></span>
<span class="normal"><a href="#__codelineno-44-17">17</a></span>
<span class="normal"><a href="#__codelineno-44-18">18</a></span>
<span class="normal"><a href="#__codelineno-44-19">19</a></span>
<span class="normal"><a href="#__codelineno-44-20">20</a></span>
<span class="normal"><a href="#__codelineno-44-21">21</a></span>
<span class="normal"><a href="#__codelineno-44-22">22</a></span>
<span class="normal"><a href="#__codelineno-44-23">23</a></span>
<span class="normal"><a href="#__codelineno-44-24">24</a></span>
<span class="normal"><a href="#__codelineno-44-25">25</a></span>
<span class="normal"><a href="#__codelineno-44-26">26</a></span>
<span class="normal"><a href="#__codelineno-44-27">27</a></span>
<span class="normal"><a href="#__codelineno-44-28">28</a></span>
<span class="normal"><a href="#__codelineno-44-29">29</a></span>
<span class="normal"><a href="#__codelineno-44-30">30</a></span>
<span class="normal"><a href="#__codelineno-44-31">31</a></span>
<span class="normal"><a href="#__codelineno-44-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewDeltaFIFOWithOptions</span><span class="p">(</span><span class="nx">opts</span><span class="w"> </span><span class="nx">DeltaFIFOOptions</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">DeltaFIFO</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">opts</span><span class="p">.</span><span class="nx">KeyFunction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="w">        </span><span class="c1">// 获取key的方法</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="w">        </span><span class="nx">opts</span><span class="p">.</span><span class="nx">KeyFunction</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">MetaNamespaceKeyFunc</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6"></a>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="w">    </span><span class="nx">f</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">DeltaFIFO</span><span class="p">{</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8"></a><span class="w">        </span><span class="nx">items</span><span class="p">:</span><span class="w">        </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">Deltas</span><span class="p">{},</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="w">        </span><span class="nx">queue</span><span class="p">:</span><span class="w">        </span><span class="p">[]</span><span class="kt">string</span><span class="p">{},</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10"></a><span class="w">        </span><span class="nx">keyFunc</span><span class="p">:</span><span class="w">      </span><span class="nx">opts</span><span class="p">.</span><span class="nx">KeyFunction</span><span class="p">,</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11"></a><span class="w">        </span><span class="nx">knownObjects</span><span class="p">:</span><span class="w"> </span><span class="nx">opts</span><span class="p">.</span><span class="nx">KnownObjects</span><span class="p">,</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12"></a>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13"></a><span class="w">        </span><span class="nx">emitDeltaTypeReplaced</span><span class="p">:</span><span class="w"> </span><span class="nx">opts</span><span class="p">.</span><span class="nx">EmitDeltaTypeReplaced</span><span class="p">,</span>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15"></a><span class="w">    </span><span class="nx">f</span><span class="p">.</span><span class="nx">cond</span><span class="p">.</span><span class="nx">L</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">f</span><span class="p">.</span><span class="nx">lock</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">f</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17"></a><span class="p">}</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18"></a><span class="kd">func</span><span class="w"> </span><span class="nx">MetaNamespaceKeyFunc</span><span class="p">(</span><span class="nx">obj</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.(</span><span class="nx">ExplicitKey</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22"></a><span class="w">    </span><span class="nx">meta</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">Accessor</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span><span id="__span-44-23"><a id="__codelineno-44-23" name="__codelineno-44-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-24"><a id="__codelineno-44-24" name="__codelineno-44-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;object has no meta: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-44-25"><a id="__codelineno-44-25" name="__codelineno-44-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-26"><a id="__codelineno-44-26" name="__codelineno-44-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">GetNamespace</span><span class="p">())</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-27"><a id="__codelineno-44-27" name="__codelineno-44-27"></a><span class="w">        </span><span class="c1">// 如果有命名空间 则key = 命名空间/资源定义里的name</span>
</span><span id="__span-44-28"><a id="__codelineno-44-28" name="__codelineno-44-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">GetNamespace</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">GetName</span><span class="p">(),</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-44-29"><a id="__codelineno-44-29" name="__codelineno-44-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-30"><a id="__codelineno-44-30" name="__codelineno-44-30"></a><span class="w">    </span><span class="c1">// 有些资源是没有命名空间的</span>
</span><span id="__span-44-31"><a id="__codelineno-44-31" name="__codelineno-44-31"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">GetName</span><span class="p">(),</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-44-32"><a id="__codelineno-44-32" name="__codelineno-44-32"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<!-- ```go title="staging/src/k8s.io/client-go/informers/core/v1/pod.go"
type PodInformer interface {
    Informer() cache.SharedIndexInformer
    Lister() v1.PodLister
}
``` -->

<h4 id="workqueue">Workqueue<a class="headerlink" href="#workqueue" title="Permanent link">&para;</a></h4>
<object type="image/svg+xml" data="/images/controller-manager-65d15c978f2381229d664c89016a35da.svg" style="max-width:100%"></object>
<h4 id="indexer">indexer<a class="headerlink" href="#indexer" title="Permanent link">&para;</a></h4>
<h2 id="_11">自定义控制器<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<p>参考 <code>pkg/controller/replicaset/replica_set.go</code></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>下面的例子是当你创建一个service ,没有关联的pod 时,自动创建pod, 简单的demo,较粗糙</p>
</div>
<h3 id="_12">代码<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1">1</a></span>
<span class="normal"><a href="#__codelineno-45-2">2</a></span>
<span class="normal"><a href="#__codelineno-45-3">3</a></span>
<span class="normal"><a href="#__codelineno-45-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1"></a>├──<span class="w"> </span>go.mod
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2"></a>├──<span class="w"> </span>main.go
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3"></a>└──<span class="w"> </span>pkg
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="w">    </span>└──<span class="w"> </span>controller.go
</span></code></pre></div></td></tr></table></div>
<p><div class="language-go highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">main.go</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-46-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-46-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-46-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-46-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-46-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-46-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-46-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-46-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-46-10">10</a></span>
<span class="normal"><a href="#__codelineno-46-11">11</a></span>
<span class="normal"><a href="#__codelineno-46-12">12</a></span>
<span class="normal"><a href="#__codelineno-46-13">13</a></span>
<span class="normal"><a href="#__codelineno-46-14">14</a></span>
<span class="normal"><a href="#__codelineno-46-15">15</a></span>
<span class="normal"><a href="#__codelineno-46-16">16</a></span>
<span class="normal"><a href="#__codelineno-46-17">17</a></span>
<span class="normal"><a href="#__codelineno-46-18">18</a></span>
<span class="normal"><a href="#__codelineno-46-19">19</a></span>
<span class="normal"><a href="#__codelineno-46-20">20</a></span>
<span class="normal"><a href="#__codelineno-46-21">21</a></span>
<span class="normal"><a href="#__codelineno-46-22">22</a></span>
<span class="normal"><a href="#__codelineno-46-23">23</a></span>
<span class="normal"><a href="#__codelineno-46-24">24</a></span>
<span class="normal"><a href="#__codelineno-46-25">25</a></span>
<span class="normal"><a href="#__codelineno-46-26">26</a></span>
<span class="normal"><a href="#__codelineno-46-27">27</a></span>
<span class="normal"><a href="#__codelineno-46-28">28</a></span>
<span class="normal"><a href="#__codelineno-46-29">29</a></span>
<span class="normal"><a href="#__codelineno-46-30">30</a></span>
<span class="normal"><a href="#__codelineno-46-31">31</a></span>
<span class="normal"><a href="#__codelineno-46-32">32</a></span>
<span class="normal"><a href="#__codelineno-46-33">33</a></span>
<span class="normal"><a href="#__codelineno-46-34">34</a></span>
<span class="normal"><a href="#__codelineno-46-35">35</a></span>
<span class="normal"><a href="#__codelineno-46-36">36</a></span>
<span class="normal"><a href="#__codelineno-46-37">37</a></span>
<span class="normal"><a href="#__codelineno-46-38">38</a></span>
<span class="normal"><a href="#__codelineno-46-39">39</a></span>
<span class="normal"><a href="#__codelineno-46-40">40</a></span>
<span class="normal"><a href="#__codelineno-46-41">41</a></span>
<span class="normal"><a href="#__codelineno-46-42">42</a></span>
<span class="normal"><a href="#__codelineno-46-43">43</a></span>
<span class="normal"><a href="#__codelineno-46-44">44</a></span>
<span class="normal"><a href="#__codelineno-46-45">45</a></span>
<span class="normal"><a href="#__codelineno-46-46">46</a></span>
<span class="normal"><a href="#__codelineno-46-47">47</a></span>
<span class="normal"><a href="#__codelineno-46-48">48</a></span>
<span class="normal"><a href="#__codelineno-46-49">49</a></span>
<span class="normal"><a href="#__codelineno-46-50">50</a></span>
<span class="normal"><a href="#__codelineno-46-51">51</a></span>
<span class="normal"><a href="#__codelineno-46-52">52</a></span>
<span class="normal"><a href="#__codelineno-46-53">53</a></span>
<span class="normal"><a href="#__codelineno-46-54">54</a></span>
<span class="normal"><a href="#__codelineno-46-55">55</a></span>
<span class="normal"><a href="#__codelineno-46-56">56</a></span>
<span class="normal"><a href="#__codelineno-46-57">57</a></span>
<span class="normal"><a href="#__codelineno-46-58">58</a></span>
<span class="normal"><a href="#__codelineno-46-59">59</a></span>
<span class="normal"><a href="#__codelineno-46-60">60</a></span>
<span class="normal"><a href="#__codelineno-46-61">61</a></span>
<span class="normal"><a href="#__codelineno-46-62">62</a></span>
<span class="normal"><a href="#__codelineno-46-63">63</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2"></a>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w">    </span><span class="s">&quot;ctrl01/pkg&quot;</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="w">    </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="w">    </span><span class="s">&quot;path/filepath&quot;</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8"></a>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9"></a><span class="w">    </span><span class="c1">// corev1 &quot;k8s.io/api/core/v1&quot;</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10"></a>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/informers&quot;</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/kubernetes&quot;</span>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/rest&quot;</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/tools/clientcmd&quot;</span>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/util/homedir&quot;</span>
</span><span id="__span-46-16"><a id="__codelineno-46-16" name="__codelineno-46-16"></a><span class="p">)</span>
</span><span id="__span-46-17"><a id="__codelineno-46-17" name="__codelineno-46-17"></a>
</span><span id="__span-46-18"><a id="__codelineno-46-18" name="__codelineno-46-18"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-19"><a id="__codelineno-46-19" name="__codelineno-46-19"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">kubeconfig</span><span class="w"> </span><span class="o">*</span><span class="kt">string</span>
</span><span id="__span-46-20"><a id="__codelineno-46-20" name="__codelineno-46-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">home</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">homedir</span><span class="p">.</span><span class="nx">HomeDir</span><span class="p">();</span><span class="w"> </span><span class="nx">home</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-21"><a id="__codelineno-46-21" name="__codelineno-46-21"></a><span class="w">        </span><span class="c1">// ~/.kube/config 确保你家目录下有k8s的配置文件</span>
</span><span id="__span-46-22"><a id="__codelineno-46-22" name="__codelineno-46-22"></a><span class="w">        </span><span class="c1">// 你本地可以用kubectl get po 进行查询.</span>
</span><span id="__span-46-23"><a id="__codelineno-46-23" name="__codelineno-46-23"></a><span class="w">        </span><span class="nx">kubeconfig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;kubeconfig&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">home</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.kube&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;config&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;(optional) absolute path to the kubeconfig file&quot;</span><span class="p">)</span>
</span><span id="__span-46-24"><a id="__codelineno-46-24" name="__codelineno-46-24"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-25"><a id="__codelineno-46-25" name="__codelineno-46-25"></a><span class="w">        </span><span class="nx">kubeconfig</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;kubeconfig&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;absolute path to the kubeconfig file&quot;</span><span class="p">)</span>
</span><span id="__span-46-26"><a id="__codelineno-46-26" name="__codelineno-46-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-27"><a id="__codelineno-46-27" name="__codelineno-46-27"></a><span class="w">    </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
</span><span id="__span-46-28"><a id="__codelineno-46-28" name="__codelineno-46-28"></a><span class="w">    </span><span class="c1">// 使用指定的kubeconfig文件创建一个Config对象</span>
</span><span id="__span-46-29"><a id="__codelineno-46-29" name="__codelineno-46-29"></a><span class="w">    </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">clientcmd</span><span class="p">.</span><span class="nx">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="nx">kubeconfig</span><span class="p">)</span>
</span><span id="__span-46-30"><a id="__codelineno-46-30" name="__codelineno-46-30"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-31"><a id="__codelineno-46-31" name="__codelineno-46-31"></a><span class="w">        </span><span class="c1">// 我们当这种情况是在集群内部, 使用集群内部的配置</span>
</span><span id="__span-46-32"><a id="__codelineno-46-32" name="__codelineno-46-32"></a><span class="w">        </span><span class="c1">// 就是pod 的形式 运行我们这个controller 会用到的配置路径</span>
</span><span id="__span-46-33"><a id="__codelineno-46-33" name="__codelineno-46-33"></a><span class="w">        </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">rest</span><span class="p">.</span><span class="nx">InClusterConfig</span><span class="p">()</span>
</span><span id="__span-46-34"><a id="__codelineno-46-34" name="__codelineno-46-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-35"><a id="__codelineno-46-35" name="__codelineno-46-35"></a><span class="w">            </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span id="__span-46-36"><a id="__codelineno-46-36" name="__codelineno-46-36"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-46-37"><a id="__codelineno-46-37" name="__codelineno-46-37"></a>
</span><span id="__span-46-38"><a id="__codelineno-46-38" name="__codelineno-46-38"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-39"><a id="__codelineno-46-39" name="__codelineno-46-39"></a>
</span><span id="__span-46-40"><a id="__codelineno-46-40" name="__codelineno-46-40"></a><span class="w">    </span><span class="c1">// 创建一个新的Kubernetes客户端</span>
</span><span id="__span-46-41"><a id="__codelineno-46-41" name="__codelineno-46-41"></a><span class="w">    </span><span class="nx">clientset</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</span><span id="__span-46-42"><a id="__codelineno-46-42" name="__codelineno-46-42"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-43"><a id="__codelineno-46-43" name="__codelineno-46-43"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span id="__span-46-44"><a id="__codelineno-46-44" name="__codelineno-46-44"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-45"><a id="__codelineno-46-45" name="__codelineno-46-45"></a>
</span><span id="__span-46-46"><a id="__codelineno-46-46" name="__codelineno-46-46"></a><span class="w">    </span><span class="nx">stopCh</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span>
</span><span id="__span-46-47"><a id="__codelineno-46-47" name="__codelineno-46-47"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nb">close</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-46-48"><a id="__codelineno-46-48" name="__codelineno-46-48"></a><span class="w">    </span><span class="nx">sharedInformerFactory</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">informers</span><span class="p">.</span><span class="nx">NewSharedInformerFactory</span><span class="p">(</span>
</span><span id="__span-46-49"><a id="__codelineno-46-49" name="__codelineno-46-49"></a><span class="w">        </span><span class="c1">// 需要这个 与apiserver 交互</span>
</span><span id="__span-46-50"><a id="__codelineno-46-50" name="__codelineno-46-50"></a><span class="w">        </span><span class="nx">clientset</span><span class="p">,</span>
</span><span id="__span-46-51"><a id="__codelineno-46-51" name="__codelineno-46-51"></a><span class="w">        </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span>
</span><span id="__span-46-52"><a id="__codelineno-46-52" name="__codelineno-46-52"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-46-53"><a id="__codelineno-46-53" name="__codelineno-46-53"></a><span class="w">    </span><span class="c1">// 获取pod资源的informer 对象,监听谁</span>
</span><span id="__span-46-54"><a id="__codelineno-46-54" name="__codelineno-46-54"></a><span class="w">    </span><span class="nx">serviceInformer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sharedInformerFactory</span><span class="p">.</span><span class="nx">Core</span><span class="p">().</span><span class="nx">V1</span><span class="p">().</span><span class="nx">Services</span><span class="p">()</span>
</span><span id="__span-46-55"><a id="__codelineno-46-55" name="__codelineno-46-55"></a><span class="w">    </span><span class="nx">podInformer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sharedInformerFactory</span><span class="p">.</span><span class="nx">Core</span><span class="p">().</span><span class="nx">V1</span><span class="p">().</span><span class="nx">Pods</span><span class="p">()</span>
</span><span id="__span-46-56"><a id="__codelineno-46-56" name="__codelineno-46-56"></a>
</span><span id="__span-46-57"><a id="__codelineno-46-57" name="__codelineno-46-57"></a><span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">pkg</span><span class="p">.</span><span class="nx">NewController</span><span class="p">(</span><span class="nx">clientset</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceInformer</span><span class="p">,</span><span class="w"> </span><span class="nx">podInformer</span><span class="p">)</span>
</span><span id="__span-46-58"><a id="__codelineno-46-58" name="__codelineno-46-58"></a><span class="w">    </span><span class="nx">sharedInformerFactory</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-46-59"><a id="__codelineno-46-59" name="__codelineno-46-59"></a><span class="w">    </span><span class="c1">// 等待数据同步到DeltaFifo 完成后</span>
</span><span id="__span-46-60"><a id="__codelineno-46-60" name="__codelineno-46-60"></a><span class="w">    </span><span class="nx">sharedInformerFactory</span><span class="p">.</span><span class="nx">WaitForCacheSync</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-46-61"><a id="__codelineno-46-61" name="__codelineno-46-61"></a><span class="w">    </span><span class="c1">// 我们才执行这个</span>
</span><span id="__span-46-62"><a id="__codelineno-46-62" name="__codelineno-46-62"></a><span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-46-63"><a id="__codelineno-46-63" name="__codelineno-46-63"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-go highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">controller.go</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1">  1</a></span>
<span class="normal"><a href="#__codelineno-47-2">  2</a></span>
<span class="normal"><a href="#__codelineno-47-3">  3</a></span>
<span class="normal"><a href="#__codelineno-47-4">  4</a></span>
<span class="normal"><a href="#__codelineno-47-5">  5</a></span>
<span class="normal"><a href="#__codelineno-47-6">  6</a></span>
<span class="normal"><a href="#__codelineno-47-7">  7</a></span>
<span class="normal"><a href="#__codelineno-47-8">  8</a></span>
<span class="normal"><a href="#__codelineno-47-9">  9</a></span>
<span class="normal"><a href="#__codelineno-47-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-47-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-47-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-47-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-47-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-47-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-47-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-47-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-47-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-47-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-47-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-47-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-47-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-47-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-47-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-47-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-47-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-47-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-47-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-47-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-47-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-47-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-47-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-47-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-47-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-47-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-47-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-47-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-47-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-47-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-47-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-47-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-47-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-47-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-47-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-47-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-47-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-47-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-47-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-47-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-47-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-47-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-47-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-47-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-47-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-47-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-47-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-47-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-47-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-47-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-47-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-47-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-47-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-47-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-47-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-47-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-47-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-47-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-47-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-47-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-47-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-47-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-47-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-47-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-47-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-47-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-47-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-47-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-47-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-47-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-47-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-47-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-47-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-47-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-47-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-47-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-47-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-47-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-47-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-47-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-47-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-47-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-47-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-47-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-47-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-47-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-47-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-47-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-47-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-47-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-47-100">100</a></span>
<span class="normal"><a href="#__codelineno-47-101">101</a></span>
<span class="normal"><a href="#__codelineno-47-102">102</a></span>
<span class="normal"><a href="#__codelineno-47-103">103</a></span>
<span class="normal"><a href="#__codelineno-47-104">104</a></span>
<span class="normal"><a href="#__codelineno-47-105">105</a></span>
<span class="normal"><a href="#__codelineno-47-106">106</a></span>
<span class="normal"><a href="#__codelineno-47-107">107</a></span>
<span class="normal"><a href="#__codelineno-47-108">108</a></span>
<span class="normal"><a href="#__codelineno-47-109">109</a></span>
<span class="normal"><a href="#__codelineno-47-110">110</a></span>
<span class="normal"><a href="#__codelineno-47-111">111</a></span>
<span class="normal"><a href="#__codelineno-47-112">112</a></span>
<span class="normal"><a href="#__codelineno-47-113">113</a></span>
<span class="normal"><a href="#__codelineno-47-114">114</a></span>
<span class="normal"><a href="#__codelineno-47-115">115</a></span>
<span class="normal"><a href="#__codelineno-47-116">116</a></span>
<span class="normal"><a href="#__codelineno-47-117">117</a></span>
<span class="normal"><a href="#__codelineno-47-118">118</a></span>
<span class="normal"><a href="#__codelineno-47-119">119</a></span>
<span class="normal"><a href="#__codelineno-47-120">120</a></span>
<span class="normal"><a href="#__codelineno-47-121">121</a></span>
<span class="normal"><a href="#__codelineno-47-122">122</a></span>
<span class="normal"><a href="#__codelineno-47-123">123</a></span>
<span class="normal"><a href="#__codelineno-47-124">124</a></span>
<span class="normal"><a href="#__codelineno-47-125">125</a></span>
<span class="normal"><a href="#__codelineno-47-126">126</a></span>
<span class="normal"><a href="#__codelineno-47-127">127</a></span>
<span class="normal"><a href="#__codelineno-47-128">128</a></span>
<span class="normal"><a href="#__codelineno-47-129">129</a></span>
<span class="normal"><a href="#__codelineno-47-130">130</a></span>
<span class="normal"><a href="#__codelineno-47-131">131</a></span>
<span class="normal"><a href="#__codelineno-47-132">132</a></span>
<span class="normal"><a href="#__codelineno-47-133">133</a></span>
<span class="normal"><a href="#__codelineno-47-134">134</a></span>
<span class="normal"><a href="#__codelineno-47-135">135</a></span>
<span class="normal"><a href="#__codelineno-47-136">136</a></span>
<span class="normal"><a href="#__codelineno-47-137">137</a></span>
<span class="normal"><a href="#__codelineno-47-138">138</a></span>
<span class="normal"><a href="#__codelineno-47-139">139</a></span>
<span class="normal"><a href="#__codelineno-47-140">140</a></span>
<span class="normal"><a href="#__codelineno-47-141">141</a></span>
<span class="normal"><a href="#__codelineno-47-142">142</a></span>
<span class="normal"><a href="#__codelineno-47-143">143</a></span>
<span class="normal"><a href="#__codelineno-47-144">144</a></span>
<span class="normal"><a href="#__codelineno-47-145">145</a></span>
<span class="normal"><a href="#__codelineno-47-146">146</a></span>
<span class="normal"><a href="#__codelineno-47-147">147</a></span>
<span class="normal"><a href="#__codelineno-47-148">148</a></span>
<span class="normal"><a href="#__codelineno-47-149">149</a></span>
<span class="normal"><a href="#__codelineno-47-150">150</a></span>
<span class="normal"><a href="#__codelineno-47-151">151</a></span>
<span class="normal"><a href="#__codelineno-47-152">152</a></span>
<span class="normal"><a href="#__codelineno-47-153">153</a></span>
<span class="normal"><a href="#__codelineno-47-154">154</a></span>
<span class="normal"><a href="#__codelineno-47-155">155</a></span>
<span class="normal"><a href="#__codelineno-47-156">156</a></span>
<span class="normal"><a href="#__codelineno-47-157">157</a></span>
<span class="normal"><a href="#__codelineno-47-158">158</a></span>
<span class="normal"><a href="#__codelineno-47-159">159</a></span>
<span class="normal"><a href="#__codelineno-47-160">160</a></span>
<span class="normal"><a href="#__codelineno-47-161">161</a></span>
<span class="normal"><a href="#__codelineno-47-162">162</a></span>
<span class="normal"><a href="#__codelineno-47-163">163</a></span>
<span class="normal"><a href="#__codelineno-47-164">164</a></span>
<span class="normal"><a href="#__codelineno-47-165">165</a></span>
<span class="normal"><a href="#__codelineno-47-166">166</a></span>
<span class="normal"><a href="#__codelineno-47-167">167</a></span>
<span class="normal"><a href="#__codelineno-47-168">168</a></span>
<span class="normal"><a href="#__codelineno-47-169">169</a></span>
<span class="normal"><a href="#__codelineno-47-170">170</a></span>
<span class="normal"><a href="#__codelineno-47-171">171</a></span>
<span class="normal"><a href="#__codelineno-47-172">172</a></span>
<span class="normal"><a href="#__codelineno-47-173">173</a></span>
<span class="normal"><a href="#__codelineno-47-174">174</a></span>
<span class="normal"><a href="#__codelineno-47-175">175</a></span>
<span class="normal"><a href="#__codelineno-47-176">176</a></span>
<span class="normal"><a href="#__codelineno-47-177">177</a></span>
<span class="normal"><a href="#__codelineno-47-178">178</a></span>
<span class="normal"><a href="#__codelineno-47-179">179</a></span>
<span class="normal"><a href="#__codelineno-47-180">180</a></span>
<span class="normal"><a href="#__codelineno-47-181">181</a></span>
<span class="normal"><a href="#__codelineno-47-182">182</a></span>
<span class="normal"><a href="#__codelineno-47-183">183</a></span>
<span class="normal"><a href="#__codelineno-47-184">184</a></span>
<span class="normal"><a href="#__codelineno-47-185">185</a></span>
<span class="normal"><a href="#__codelineno-47-186">186</a></span>
<span class="normal"><a href="#__codelineno-47-187">187</a></span>
<span class="normal"><a href="#__codelineno-47-188">188</a></span>
<span class="normal"><a href="#__codelineno-47-189">189</a></span>
<span class="normal"><a href="#__codelineno-47-190">190</a></span>
<span class="normal"><a href="#__codelineno-47-191">191</a></span>
<span class="normal"><a href="#__codelineno-47-192">192</a></span>
<span class="normal"><a href="#__codelineno-47-193">193</a></span>
<span class="normal"><a href="#__codelineno-47-194">194</a></span>
<span class="normal"><a href="#__codelineno-47-195">195</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">pkg</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2"></a>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="w">    </span><span class="s">&quot;reflect&quot;</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8"></a>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="w">    </span><span class="nx">corev1</span><span class="w"> </span><span class="s">&quot;k8s.io/api/core/v1&quot;</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10"></a><span class="w">    </span><span class="nx">metav1</span><span class="w"> </span><span class="s">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11"></a><span class="w">    </span><span class="s">&quot;k8s.io/apimachinery/pkg/labels&quot;</span>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12"></a><span class="w">    </span><span class="s">&quot;k8s.io/apimachinery/pkg/selection&quot;</span>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13"></a><span class="w">    </span><span class="nx">utilruntime</span><span class="w"> </span><span class="s">&quot;k8s.io/apimachinery/pkg/util/runtime&quot;</span>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14"></a><span class="w">    </span><span class="s">&quot;k8s.io/apimachinery/pkg/util/sets&quot;</span>
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15"></a><span class="w">    </span><span class="s">&quot;k8s.io/apimachinery/pkg/util/wait&quot;</span>
</span><span id="__span-47-16"><a id="__codelineno-47-16" name="__codelineno-47-16"></a><span class="w">    </span><span class="nx">coreInformerV1</span><span class="w"> </span><span class="s">&quot;k8s.io/client-go/informers/core/v1&quot;</span>
</span><span id="__span-47-17"><a id="__codelineno-47-17" name="__codelineno-47-17"></a>
</span><span id="__span-47-18"><a id="__codelineno-47-18" name="__codelineno-47-18"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/kubernetes&quot;</span>
</span><span id="__span-47-19"><a id="__codelineno-47-19" name="__codelineno-47-19"></a><span class="w">    </span><span class="nx">coreListerV1</span><span class="w"> </span><span class="s">&quot;k8s.io/client-go/listers/core/v1&quot;</span>
</span><span id="__span-47-20"><a id="__codelineno-47-20" name="__codelineno-47-20"></a>
</span><span id="__span-47-21"><a id="__codelineno-47-21" name="__codelineno-47-21"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/tools/cache&quot;</span>
</span><span id="__span-47-22"><a id="__codelineno-47-22" name="__codelineno-47-22"></a><span class="w">    </span><span class="s">&quot;k8s.io/client-go/util/workqueue&quot;</span>
</span><span id="__span-47-23"><a id="__codelineno-47-23" name="__codelineno-47-23"></a><span class="p">)</span>
</span><span id="__span-47-24"><a id="__codelineno-47-24" name="__codelineno-47-24"></a>
</span><span id="__span-47-25"><a id="__codelineno-47-25" name="__codelineno-47-25"></a><span class="kd">type</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-26"><a id="__codelineno-47-26" name="__codelineno-47-26"></a><span class="w">    </span><span class="nx">client</span><span class="w">        </span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span>
</span><span id="__span-47-27"><a id="__codelineno-47-27" name="__codelineno-47-27"></a><span class="w">    </span><span class="nx">podLister</span><span class="w">     </span><span class="nx">coreListerV1</span><span class="p">.</span><span class="nx">PodLister</span>
</span><span id="__span-47-28"><a id="__codelineno-47-28" name="__codelineno-47-28"></a><span class="w">    </span><span class="nx">serviceLister</span><span class="w"> </span><span class="nx">coreListerV1</span><span class="p">.</span><span class="nx">ServiceLister</span>
</span><span id="__span-47-29"><a id="__codelineno-47-29" name="__codelineno-47-29"></a><span class="w">    </span><span class="nx">queue</span><span class="w">         </span><span class="nx">workqueue</span><span class="p">.</span><span class="nx">RateLimitingInterface</span>
</span><span id="__span-47-30"><a id="__codelineno-47-30" name="__codelineno-47-30"></a><span class="p">}</span>
</span><span id="__span-47-31"><a id="__codelineno-47-31" name="__codelineno-47-31"></a>
</span><span id="__span-47-32"><a id="__codelineno-47-32" name="__codelineno-47-32"></a><span class="cm">/*</span>
</span><span id="__span-47-33"><a id="__codelineno-47-33" name="__codelineno-47-33"></a><span class="cm">我们主要就是编写控制器</span>
</span><span id="__span-47-34"><a id="__codelineno-47-34" name="__codelineno-47-34"></a><span class="cm">定义相关的informer 表示用来获取什么类型的资源</span>
</span><span id="__span-47-35"><a id="__codelineno-47-35" name="__codelineno-47-35"></a><span class="cm">然后关心这些资源变化, 将监听到的对应事件处理函数写上</span>
</span><span id="__span-47-36"><a id="__codelineno-47-36" name="__codelineno-47-36"></a><span class="cm">*/</span>
</span><span id="__span-47-37"><a id="__codelineno-47-37" name="__codelineno-47-37"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewController</span><span class="p">(</span><span class="nx">client</span><span class="w"> </span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceInformer</span><span class="w"> </span><span class="nx">coreInformerV1</span><span class="p">.</span><span class="nx">ServiceInformer</span><span class="p">,</span><span class="w"> </span><span class="nx">podInformer</span><span class="w"> </span><span class="nx">coreInformerV1</span><span class="p">.</span><span class="nx">PodInformer</span><span class="p">)</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-38"><a id="__codelineno-47-38" name="__codelineno-47-38"></a><span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">controller</span><span class="p">{</span>
</span><span id="__span-47-39"><a id="__codelineno-47-39" name="__codelineno-47-39"></a><span class="w">        </span><span class="nx">client</span><span class="p">,</span>
</span><span id="__span-47-40"><a id="__codelineno-47-40" name="__codelineno-47-40"></a><span class="w">        </span><span class="nx">podInformer</span><span class="p">.</span><span class="nx">Lister</span><span class="p">(),</span>
</span><span id="__span-47-41"><a id="__codelineno-47-41" name="__codelineno-47-41"></a><span class="w">        </span><span class="nx">serviceInformer</span><span class="p">.</span><span class="nx">Lister</span><span class="p">(),</span>
</span><span id="__span-47-42"><a id="__codelineno-47-42" name="__codelineno-47-42"></a><span class="w">        </span><span class="c1">// 前面 controller-manager 架构里 说过</span>
</span><span id="__span-47-43"><a id="__codelineno-47-43" name="__codelineno-47-43"></a><span class="w">        </span><span class="c1">// DeltaFifo 消费时 数据没有直接处理,而是先放到工作队列中</span>
</span><span id="__span-47-44"><a id="__codelineno-47-44" name="__codelineno-47-44"></a><span class="w">        </span><span class="nx">workqueue</span><span class="p">.</span><span class="nx">NewNamedRateLimitingQueue</span><span class="p">(</span><span class="nx">workqueue</span><span class="p">.</span><span class="nx">DefaultControllerRateLimiter</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;serviceWorkqueue&quot;</span><span class="p">),</span>
</span><span id="__span-47-45"><a id="__codelineno-47-45" name="__codelineno-47-45"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-46"><a id="__codelineno-47-46" name="__codelineno-47-46"></a>
</span><span id="__span-47-47"><a id="__codelineno-47-47" name="__codelineno-47-47"></a><span class="w">    </span><span class="nx">serviceInformer</span><span class="p">.</span><span class="nx">Informer</span><span class="p">().</span><span class="nx">AddEventHandler</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
</span><span id="__span-47-48"><a id="__codelineno-47-48" name="__codelineno-47-48"></a><span class="w">        </span><span class="nx">AddFunc</span><span class="p">:</span><span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">addService</span><span class="p">,</span>
</span><span id="__span-47-49"><a id="__codelineno-47-49" name="__codelineno-47-49"></a><span class="w">        </span><span class="nx">UpdateFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">updateService</span><span class="p">,</span>
</span><span id="__span-47-50"><a id="__codelineno-47-50" name="__codelineno-47-50"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-47-51"><a id="__codelineno-47-51" name="__codelineno-47-51"></a><span class="w">    </span><span class="c1">// podInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{</span>
</span><span id="__span-47-52"><a id="__codelineno-47-52" name="__codelineno-47-52"></a><span class="w">    </span><span class="c1">//  DeleteFunc: c.deletePod,</span>
</span><span id="__span-47-53"><a id="__codelineno-47-53" name="__codelineno-47-53"></a><span class="w">    </span><span class="c1">// })</span>
</span><span id="__span-47-54"><a id="__codelineno-47-54" name="__codelineno-47-54"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span>
</span><span id="__span-47-55"><a id="__codelineno-47-55" name="__codelineno-47-55"></a><span class="p">}</span>
</span><span id="__span-47-56"><a id="__codelineno-47-56" name="__codelineno-47-56"></a>
</span><span id="__span-47-57"><a id="__codelineno-47-57" name="__codelineno-47-57"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">controller</span><span class="p">)</span><span class="w"> </span><span class="nx">addService</span><span class="p">(</span><span class="nx">obj</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-58"><a id="__codelineno-47-58" name="__codelineno-47-58"></a><span class="w">    </span><span class="nx">metav1Obj</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span><span id="__span-47-59"><a id="__codelineno-47-59" name="__codelineno-47-59"></a><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;新的service被添加到缓存中&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">metav1Obj</span><span class="p">.</span><span class="nx">GetName</span><span class="p">())</span>
</span><span id="__span-47-60"><a id="__codelineno-47-60" name="__codelineno-47-60"></a>
</span><span id="__span-47-61"><a id="__codelineno-47-61" name="__codelineno-47-61"></a><span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">enqueue</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span><span id="__span-47-62"><a id="__codelineno-47-62" name="__codelineno-47-62"></a><span class="p">}</span>
</span><span id="__span-47-63"><a id="__codelineno-47-63" name="__codelineno-47-63"></a>
</span><span id="__span-47-64"><a id="__codelineno-47-64" name="__codelineno-47-64"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">controller</span><span class="p">)</span><span class="w"> </span><span class="nx">updateService</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span><span class="w"> </span><span class="nx">newObj</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-65"><a id="__codelineno-47-65" name="__codelineno-47-65"></a><span class="w">    </span><span class="nx">metav1Obj</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">oldObj</span><span class="p">.(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span><span id="__span-47-66"><a id="__codelineno-47-66" name="__codelineno-47-66"></a><span class="w">    </span><span class="nx">metav1NewObj</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newObj</span><span class="p">.(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span><span id="__span-47-67"><a id="__codelineno-47-67" name="__codelineno-47-67"></a><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;service update&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">metav1Obj</span><span class="p">.</span><span class="nx">GetName</span><span class="p">(),</span><span class="w"> </span><span class="nx">metav1NewObj</span><span class="p">.</span><span class="nx">GetName</span><span class="p">())</span>
</span><span id="__span-47-68"><a id="__codelineno-47-68" name="__codelineno-47-68"></a><span class="w">    </span><span class="c1">// 如果更新来的数据和旧的一样, 就不做操作</span>
</span><span id="__span-47-69"><a id="__codelineno-47-69" name="__codelineno-47-69"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">DeepEqual</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span><span class="w"> </span><span class="nx">newObj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-70"><a id="__codelineno-47-70" name="__codelineno-47-70"></a><span class="w">        </span><span class="k">return</span>
</span><span id="__span-47-71"><a id="__codelineno-47-71" name="__codelineno-47-71"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-72"><a id="__codelineno-47-72" name="__codelineno-47-72"></a><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;更新有变化, 添加到工作队列: &quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">metav1NewObj</span><span class="p">.</span><span class="nx">GetName</span><span class="p">())</span>
</span><span id="__span-47-73"><a id="__codelineno-47-73" name="__codelineno-47-73"></a><span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">enqueue</span><span class="p">(</span><span class="nx">newObj</span><span class="p">)</span>
</span><span id="__span-47-74"><a id="__codelineno-47-74" name="__codelineno-47-74"></a><span class="p">}</span>
</span><span id="__span-47-75"><a id="__codelineno-47-75" name="__codelineno-47-75"></a>
</span><span id="__span-47-76"><a id="__codelineno-47-76" name="__codelineno-47-76"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">controller</span><span class="p">)</span><span class="w"> </span><span class="nx">deletePod</span><span class="p">(</span><span class="nx">obj</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-77"><a id="__codelineno-47-77" name="__codelineno-47-77"></a><span class="w">    </span><span class="c1">// todo</span>
</span><span id="__span-47-78"><a id="__codelineno-47-78" name="__codelineno-47-78"></a><span class="p">}</span>
</span><span id="__span-47-79"><a id="__codelineno-47-79" name="__codelineno-47-79"></a>
</span><span id="__span-47-80"><a id="__codelineno-47-80" name="__codelineno-47-80"></a><span class="kd">var</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span>
</span><span id="__span-47-81"><a id="__codelineno-47-81" name="__codelineno-47-81"></a>
</span><span id="__span-47-82"><a id="__codelineno-47-82" name="__codelineno-47-82"></a><span class="c1">// 处理工作队列</span>
</span><span id="__span-47-83"><a id="__codelineno-47-83" name="__codelineno-47-83"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">controller</span><span class="p">)</span><span class="w"> </span><span class="nx">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="w"> </span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-84"><a id="__codelineno-47-84" name="__codelineno-47-84"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">workers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-85"><a id="__codelineno-47-85" name="__codelineno-47-85"></a><span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="nx">wait</span><span class="p">.</span><span class="nx">Until</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">worker</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span><span class="w"> </span><span class="nx">stopCh</span><span class="p">)</span>
</span><span id="__span-47-86"><a id="__codelineno-47-86" name="__codelineno-47-86"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-87"><a id="__codelineno-47-87" name="__codelineno-47-87"></a><span class="w">    </span><span class="o">&lt;-</span><span class="nx">stopCh</span>
</span><span id="__span-47-88"><a id="__codelineno-47-88" name="__codelineno-47-88"></a><span class="p">}</span>
</span><span id="__span-47-89"><a id="__codelineno-47-89" name="__codelineno-47-89"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">controller</span><span class="p">)</span><span class="w"> </span><span class="nx">worker</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-90"><a id="__codelineno-47-90" name="__codelineno-47-90"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">processNextItem</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-91"><a id="__codelineno-47-91" name="__codelineno-47-91"></a>
</span><span id="__span-47-92"><a id="__codelineno-47-92" name="__codelineno-47-92"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-93"><a id="__codelineno-47-93" name="__codelineno-47-93"></a><span class="p">}</span>
</span><span id="__span-47-94"><a id="__codelineno-47-94" name="__codelineno-47-94"></a>
</span><span id="__span-47-95"><a id="__codelineno-47-95" name="__codelineno-47-95"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">controller</span><span class="p">)</span><span class="w"> </span><span class="nx">processNextItem</span><span class="p">()</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-96"><a id="__codelineno-47-96" name="__codelineno-47-96"></a><span class="w">    </span><span class="c1">// 从队列中</span>
</span><span id="__span-47-97"><a id="__codelineno-47-97" name="__codelineno-47-97"></a><span class="w">    </span><span class="nx">item</span><span class="p">,</span><span class="w"> </span><span class="nx">shutdown</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">Get</span><span class="p">()</span>
</span><span id="__span-47-98"><a id="__codelineno-47-98" name="__codelineno-47-98"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">shutdown</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-99"><a id="__codelineno-47-99" name="__codelineno-47-99"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-47-100"><a id="__codelineno-47-100" name="__codelineno-47-100"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-101"><a id="__codelineno-47-101" name="__codelineno-47-101"></a>
</span><span id="__span-47-102"><a id="__codelineno-47-102" name="__codelineno-47-102"></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">Done</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
</span><span id="__span-47-103"><a id="__codelineno-47-103" name="__codelineno-47-103"></a><span class="w">    </span><span class="nx">key</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">item</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-47-104"><a id="__codelineno-47-104" name="__codelineno-47-104"></a><span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">syncService</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span><span id="__span-47-105"><a id="__codelineno-47-105" name="__codelineno-47-105"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-106"><a id="__codelineno-47-106" name="__codelineno-47-106"></a><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">Forget</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span><span id="__span-47-107"><a id="__codelineno-47-107" name="__codelineno-47-107"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-47-108"><a id="__codelineno-47-108" name="__codelineno-47-108"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-109"><a id="__codelineno-47-109" name="__codelineno-47-109"></a>
</span><span id="__span-47-110"><a id="__codelineno-47-110" name="__codelineno-47-110"></a><span class="w">    </span><span class="nx">utilruntime</span><span class="p">.</span><span class="nx">HandleError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;sync %q failed with %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">))</span>
</span><span id="__span-47-111"><a id="__codelineno-47-111" name="__codelineno-47-111"></a><span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">AddRateLimited</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span><span id="__span-47-112"><a id="__codelineno-47-112" name="__codelineno-47-112"></a>
</span><span id="__span-47-113"><a id="__codelineno-47-113" name="__codelineno-47-113"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-47-114"><a id="__codelineno-47-114" name="__codelineno-47-114"></a>
</span><span id="__span-47-115"><a id="__codelineno-47-115" name="__codelineno-47-115"></a><span class="p">}</span>
</span><span id="__span-47-116"><a id="__codelineno-47-116" name="__codelineno-47-116"></a>
</span><span id="__span-47-117"><a id="__codelineno-47-117" name="__codelineno-47-117"></a><span class="c1">// syncService 这里就是简单测试, 写的很随意</span>
</span><span id="__span-47-118"><a id="__codelineno-47-118" name="__codelineno-47-118"></a><span class="c1">// 这里主要功能是 根据创建的service 的label selector,如果没有对应的pod, 则创建一个关联的pod.</span>
</span><span id="__span-47-119"><a id="__codelineno-47-119" name="__codelineno-47-119"></a><span class="c1">//  请参考k8s源码 比如 ReplicaSetController.syncReplicaSet()</span>
</span><span id="__span-47-120"><a id="__codelineno-47-120" name="__codelineno-47-120"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">controller</span><span class="p">)</span><span class="w"> </span><span class="nx">syncService</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-121"><a id="__codelineno-47-121" name="__codelineno-47-121"></a><span class="w">    </span><span class="c1">// 从key 中获取 namespace 和 name</span>
</span><span id="__span-47-122"><a id="__codelineno-47-122" name="__codelineno-47-122"></a><span class="w">    </span><span class="nx">namespace</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">SplitMetaNamespaceKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span><span id="__span-47-123"><a id="__codelineno-47-123" name="__codelineno-47-123"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-124"><a id="__codelineno-47-124" name="__codelineno-47-124"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-47-125"><a id="__codelineno-47-125" name="__codelineno-47-125"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-126"><a id="__codelineno-47-126" name="__codelineno-47-126"></a><span class="w">    </span><span class="c1">// 获取service 对象</span>
</span><span id="__span-47-127"><a id="__codelineno-47-127" name="__codelineno-47-127"></a><span class="w">    </span><span class="nx">service</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">serviceLister</span><span class="p">.</span><span class="nx">Services</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nx">Get</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span><span id="__span-47-128"><a id="__codelineno-47-128" name="__codelineno-47-128"></a>
</span><span id="__span-47-129"><a id="__codelineno-47-129" name="__codelineno-47-129"></a><span class="w">    </span><span class="nx">selectorLabelValue</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">service</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Selector</span><span class="p">[</span><span class="s">&quot;nginx-pod&quot;</span><span class="p">]</span>
</span><span id="__span-47-130"><a id="__codelineno-47-130" name="__codelineno-47-130"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-131"><a id="__codelineno-47-131" name="__codelineno-47-131"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-47-132"><a id="__codelineno-47-132" name="__codelineno-47-132"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-133"><a id="__codelineno-47-133" name="__codelineno-47-133"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-47-134"><a id="__codelineno-47-134" name="__codelineno-47-134"></a><span class="w">    </span><span class="nx">servicePodsRequire</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">labels</span><span class="p">.</span><span class="nx">NewRequirement</span><span class="p">(</span><span class="s">&quot;nginx-pod&quot;</span><span class="p">,</span>
</span><span id="__span-47-135"><a id="__codelineno-47-135" name="__codelineno-47-135"></a><span class="w">        </span><span class="nx">selection</span><span class="p">.</span><span class="nx">Equals</span><span class="p">,</span>
</span><span id="__span-47-136"><a id="__codelineno-47-136" name="__codelineno-47-136"></a><span class="w">        </span><span class="nx">sets</span><span class="p">.</span><span class="nx">NewString</span><span class="p">(</span><span class="nx">selectorLabelValue</span><span class="p">).</span><span class="nx">List</span><span class="p">())</span>
</span><span id="__span-47-137"><a id="__codelineno-47-137" name="__codelineno-47-137"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-138"><a id="__codelineno-47-138" name="__codelineno-47-138"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-47-139"><a id="__codelineno-47-139" name="__codelineno-47-139"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-140"><a id="__codelineno-47-140" name="__codelineno-47-140"></a><span class="w">    </span><span class="nx">servicePodsRequires</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">labels</span><span class="p">.</span><span class="nx">Requirement</span><span class="p">{</span>
</span><span id="__span-47-141"><a id="__codelineno-47-141" name="__codelineno-47-141"></a><span class="w">        </span><span class="o">*</span><span class="nx">servicePodsRequire</span><span class="p">,</span>
</span><span id="__span-47-142"><a id="__codelineno-47-142" name="__codelineno-47-142"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-143"><a id="__codelineno-47-143" name="__codelineno-47-143"></a>
</span><span id="__span-47-144"><a id="__codelineno-47-144" name="__codelineno-47-144"></a><span class="w">    </span><span class="c1">// 从缓存 中获取pod</span>
</span><span id="__span-47-145"><a id="__codelineno-47-145" name="__codelineno-47-145"></a><span class="w">    </span><span class="nx">pods</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">podLister</span><span class="p">.</span>
</span><span id="__span-47-146"><a id="__codelineno-47-146" name="__codelineno-47-146"></a><span class="w">        </span><span class="nx">Pods</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span>
</span><span id="__span-47-147"><a id="__codelineno-47-147" name="__codelineno-47-147"></a><span class="w">        </span><span class="nx">List</span><span class="p">(</span><span class="nx">labels</span><span class="p">.</span><span class="nx">NewSelector</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="nx">servicePodsRequires</span><span class="o">...</span><span class="p">))</span>
</span><span id="__span-47-148"><a id="__codelineno-47-148" name="__codelineno-47-148"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-149"><a id="__codelineno-47-149" name="__codelineno-47-149"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-47-150"><a id="__codelineno-47-150" name="__codelineno-47-150"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-151"><a id="__codelineno-47-151" name="__codelineno-47-151"></a><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;len&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">pods</span><span class="p">))</span>
</span><span id="__span-47-152"><a id="__codelineno-47-152" name="__codelineno-47-152"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">pods</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-153"><a id="__codelineno-47-153" name="__codelineno-47-153"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;exists&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">pods</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">GetName</span><span class="p">())</span>
</span><span id="__span-47-154"><a id="__codelineno-47-154" name="__codelineno-47-154"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-47-155"><a id="__codelineno-47-155" name="__codelineno-47-155"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-156"><a id="__codelineno-47-156" name="__codelineno-47-156"></a><span class="w">    </span><span class="nx">pod</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{</span>
</span><span id="__span-47-157"><a id="__codelineno-47-157" name="__codelineno-47-157"></a><span class="w">        </span><span class="nx">ObjectMeta</span><span class="p">:</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span><span id="__span-47-158"><a id="__codelineno-47-158" name="__codelineno-47-158"></a><span class="w">            </span><span class="nx">Name</span><span class="p">:</span><span class="w">      </span><span class="nx">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;-pod&quot;</span><span class="p">,</span>
</span><span id="__span-47-159"><a id="__codelineno-47-159" name="__codelineno-47-159"></a><span class="w">            </span><span class="nx">Namespace</span><span class="p">:</span><span class="w"> </span><span class="nx">namespace</span><span class="p">,</span>
</span><span id="__span-47-160"><a id="__codelineno-47-160" name="__codelineno-47-160"></a><span class="w">            </span><span class="nx">Labels</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-47-161"><a id="__codelineno-47-161" name="__codelineno-47-161"></a><span class="w">                </span><span class="s">&quot;nginx-pod&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">selectorLabelValue</span><span class="p">,</span>
</span><span id="__span-47-162"><a id="__codelineno-47-162" name="__codelineno-47-162"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-47-163"><a id="__codelineno-47-163" name="__codelineno-47-163"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-47-164"><a id="__codelineno-47-164" name="__codelineno-47-164"></a><span class="w">        </span><span class="nx">Spec</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">PodSpec</span><span class="p">{</span>
</span><span id="__span-47-165"><a id="__codelineno-47-165" name="__codelineno-47-165"></a><span class="w">            </span><span class="nx">Containers</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Container</span><span class="p">{</span>
</span><span id="__span-47-166"><a id="__codelineno-47-166" name="__codelineno-47-166"></a><span class="w">                </span><span class="p">{</span>
</span><span id="__span-47-167"><a id="__codelineno-47-167" name="__codelineno-47-167"></a><span class="w">                    </span><span class="nx">Name</span><span class="p">:</span><span class="w">            </span><span class="s">&quot;my-container&quot;</span><span class="p">,</span>
</span><span id="__span-47-168"><a id="__codelineno-47-168" name="__codelineno-47-168"></a><span class="w">                    </span><span class="nx">Image</span><span class="p">:</span><span class="w">           </span><span class="s">&quot;nginx:1.14.2&quot;</span><span class="p">,</span>
</span><span id="__span-47-169"><a id="__codelineno-47-169" name="__codelineno-47-169"></a><span class="w">                    </span><span class="nx">ImagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">PullIfNotPresent</span><span class="p">,</span>
</span><span id="__span-47-170"><a id="__codelineno-47-170" name="__codelineno-47-170"></a><span class="w">                </span><span class="p">},</span>
</span><span id="__span-47-171"><a id="__codelineno-47-171" name="__codelineno-47-171"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-47-172"><a id="__codelineno-47-172" name="__codelineno-47-172"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-47-173"><a id="__codelineno-47-173" name="__codelineno-47-173"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-174"><a id="__codelineno-47-174" name="__codelineno-47-174"></a><span class="w">    </span><span class="nx">p</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">CoreV1</span><span class="p">().</span>
</span><span id="__span-47-175"><a id="__codelineno-47-175" name="__codelineno-47-175"></a><span class="w">        </span><span class="nx">Pods</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span>
</span><span id="__span-47-176"><a id="__codelineno-47-176" name="__codelineno-47-176"></a><span class="w">        </span><span class="nx">Create</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span><span class="w"> </span><span class="nx">pod</span><span class="p">,</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">CreateOptions</span><span class="p">{})</span>
</span><span id="__span-47-177"><a id="__codelineno-47-177" name="__codelineno-47-177"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-178"><a id="__codelineno-47-178" name="__codelineno-47-178"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-47-179"><a id="__codelineno-47-179" name="__codelineno-47-179"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-180"><a id="__codelineno-47-180" name="__codelineno-47-180"></a><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;创建了 service %s 关联的 pod: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span><span id="__span-47-181"><a id="__codelineno-47-181" name="__codelineno-47-181"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-47-182"><a id="__codelineno-47-182" name="__codelineno-47-182"></a><span class="p">}</span>
</span><span id="__span-47-183"><a id="__codelineno-47-183" name="__codelineno-47-183"></a>
</span><span id="__span-47-184"><a id="__codelineno-47-184" name="__codelineno-47-184"></a><span class="c1">// 添加到工作队列</span>
</span><span id="__span-47-185"><a id="__codelineno-47-185" name="__codelineno-47-185"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">controller</span><span class="p">)</span><span class="w"> </span><span class="nx">enqueue</span><span class="p">(</span><span class="nx">obj</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-186"><a id="__codelineno-47-186" name="__codelineno-47-186"></a><span class="w">    </span><span class="c1">// o := obj.(*corev1.Service)</span>
</span><span id="__span-47-187"><a id="__codelineno-47-187" name="__codelineno-47-187"></a><span class="w">    </span><span class="c1">// 获取key, 这个默认方法是  namespace/name 作为key</span>
</span><span id="__span-47-188"><a id="__codelineno-47-188" name="__codelineno-47-188"></a><span class="w">    </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">MetaNamespaceKeyFunc</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span><span id="__span-47-189"><a id="__codelineno-47-189" name="__codelineno-47-189"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-190"><a id="__codelineno-47-190" name="__codelineno-47-190"></a><span class="w">        </span><span class="nx">utilruntime</span><span class="p">.</span><span class="nx">HandleError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-47-191"><a id="__codelineno-47-191" name="__codelineno-47-191"></a><span class="w">        </span><span class="k">return</span>
</span><span id="__span-47-192"><a id="__codelineno-47-192" name="__codelineno-47-192"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-193"><a id="__codelineno-47-193" name="__codelineno-47-193"></a><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;enqueue:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">)</span>
</span><span id="__span-47-194"><a id="__codelineno-47-194" name="__codelineno-47-194"></a><span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span><span id="__span-47-195"><a id="__codelineno-47-195" name="__codelineno-47-195"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">svc-controller.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-48-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-48-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-48-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-48-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-48-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-48-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-48-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-48-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-48-10">10</a></span>
<span class="normal"><a href="#__codelineno-48-11">11</a></span>
<span class="normal"><a href="#__codelineno-48-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc-controller</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="w">    </span><span class="nt">nginx-pod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">abc</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1">1</a></span>
<span class="normal"><a href="#__codelineno-49-2">2</a></span>
<span class="normal"><a href="#__codelineno-49-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1"></a>go<span class="w"> </span>run<span class="w"> </span>main.go
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2"></a>k<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>svc-controller.yaml
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3"></a>k<span class="w"> </span>get<span class="w"> </span>po<span class="w"> </span><span class="c1"># 查看是否创建了pod</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="k8s">部署到k8s<a class="headerlink" href="#k8s" title="Permanent link">&para;</a></h3>
<p><div class="language-dockerfile highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1">1</a></span>
<span class="normal"><a href="#__codelineno-50-2">2</a></span>
<span class="normal"><a href="#__codelineno-50-3">3</a></span>
<span class="normal"><a href="#__codelineno-50-4">4</a></span>
<span class="normal"><a href="#__codelineno-50-5">5</a></span>
<span class="normal"><a href="#__codelineno-50-6">6</a></span>
<span class="normal"><a href="#__codelineno-50-7">7</a></span>
<span class="normal"><a href="#__codelineno-50-8">8</a></span>
<span class="normal"><a href="#__codelineno-50-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">golang:1.18.10-alpine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">base</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/test</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="k">RUN</span><span class="w"> </span>go<span class="w"> </span>env<span class="w"> </span>-w<span class="w"> </span><span class="nv">GOPROXY</span><span class="o">=</span>https://goproxy.cn,http://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct<span class="w"> </span><span class="se">\</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>go<span class="w"> </span>mod<span class="w"> </span>tidy<span class="w"> </span><span class="se">\</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6"></a><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">GOOS</span><span class="o">=</span>linux<span class="w"> </span><span class="nv">GOARCH</span><span class="o">=</span>amd64<span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>-o<span class="w"> </span>my-controller<span class="w">  </span>main.go
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7"></a><span class="k">FROM</span><span class="w"> </span><span class="s">alpine:3.16</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8"></a><span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>base<span class="w"> </span>/test/my-controller<span class="w"> </span>/my-controller
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9"></a><span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/my-controller&quot;</span><span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1">1</a></span>
<span class="normal"><a href="#__codelineno-51-2">2</a></span>
<span class="normal"><a href="#__codelineno-51-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1"></a>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>hb.6o6.com/xyz/mycontroller:1.0<span class="w"> </span>.
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="c1"># push 到你的harbor</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="c1"># 如果是 dockerhub , 记得 tag 变下</span>
</span></code></pre></div></td></tr></table></div></p>
<div class="admonition danger">
<p class="admonition-title">注意</p>
<p>因为默认使用的default sa ,只有命名空间下的view 权限, 其他命名空间就没有了, 而我们代码是list watch所有命名空间,以及还有创建pod的操作<br>使用 k logs 可以看到报错信息<br>
这里我直接给 pod默认使用的sa 用户 clusterrolebinding 绑定一个clusterrole cluster-admin, 当然也可以自己创建clusterrole<br></p>
</div>
<p><div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-52-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-52-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-52-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-52-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-52-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-52-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-52-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-52-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-52-10">10</a></span>
<span class="normal"><a href="#__codelineno-52-11">11</a></span>
<span class="normal"><a href="#__codelineno-52-12">12</a></span>
<span class="normal"><a href="#__codelineno-52-13">13</a></span>
<span class="normal"><a href="#__codelineno-52-14">14</a></span>
<span class="normal"><a href="#__codelineno-52-15">15</a></span>
<span class="normal"><a href="#__codelineno-52-16">16</a></span>
<span class="normal"><a href="#__codelineno-52-17">17</a></span>
<span class="normal"><a href="#__codelineno-52-18">18</a></span>
<span class="normal"><a href="#__codelineno-52-19">19</a></span>
<span class="normal"><a href="#__codelineno-52-20">20</a></span>
<span class="normal"><a href="#__codelineno-52-21">21</a></span>
<span class="normal"><a href="#__codelineno-52-22">22</a></span>
<span class="normal"><a href="#__codelineno-52-23">23</a></span>
<span class="normal"><a href="#__codelineno-52-24">24</a></span>
<span class="normal"><a href="#__codelineno-52-25">25</a></span>
<span class="normal"><a href="#__codelineno-52-26">26</a></span>
<span class="normal"><a href="#__codelineno-52-27">27</a></span>
<span class="normal"><a href="#__codelineno-52-28">28</a></span>
<span class="normal"><a href="#__codelineno-52-29">29</a></span>
<span class="normal"><a href="#__codelineno-52-30">30</a></span>
<span class="normal"><a href="#__codelineno-52-31">31</a></span>
<span class="normal"><a href="#__codelineno-52-32">32</a></span>
<span class="normal"><a href="#__codelineno-52-33">33</a></span>
<span class="normal"><a href="#__codelineno-52-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crb-default-clusterrole-view</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6"></a><span class="nt">roleRef</span><span class="p">:</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-admin</span>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10"></a><span class="nt">subjects</span><span class="p">:</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14"></a><span class="nn">---</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-52-17"><a id="__codelineno-52-17" name="__codelineno-52-17"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-52-18"><a id="__codelineno-52-18" name="__codelineno-52-18"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy-my-controller</span>
</span><span id="__span-52-19"><a id="__codelineno-52-19" name="__codelineno-52-19"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-52-20"><a id="__codelineno-52-20" name="__codelineno-52-20"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-52-21"><a id="__codelineno-52-21" name="__codelineno-52-21"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-52-22"><a id="__codelineno-52-22" name="__codelineno-52-22"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-52-23"><a id="__codelineno-52-23" name="__codelineno-52-23"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod-my-controller</span>
</span><span id="__span-52-24"><a id="__codelineno-52-24" name="__codelineno-52-24"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-52-25"><a id="__codelineno-52-25" name="__codelineno-52-25"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-52-26"><a id="__codelineno-52-26" name="__codelineno-52-26"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-52-27"><a id="__codelineno-52-27" name="__codelineno-52-27"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod-my-controller</span>
</span><span id="__span-52-28"><a id="__codelineno-52-28" name="__codelineno-52-28"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-52-29"><a id="__codelineno-52-29" name="__codelineno-52-29"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-52-30"><a id="__codelineno-52-30" name="__codelineno-52-30"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c-deploy-controller</span>
</span><span id="__span-52-31"><a id="__codelineno-52-31" name="__codelineno-52-31"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hb.6o6.com/xyz/mycontroller:1.0</span>
</span><span id="__span-52-32"><a id="__codelineno-52-32" name="__codelineno-52-32"></a><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
</span><span id="__span-52-33"><a id="__codelineno-52-33" name="__codelineno-52-33"></a><span class="w">        </span><span class="nt">imagePullSecrets</span><span class="p">:</span>
</span><span id="__span-52-34"><a id="__codelineno-52-34" name="__codelineno-52-34"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">regcred</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1"></a>k<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>svc-controller.yaml
</span></code></pre></div></td></tr></table></div></p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://kubernetes.io/zh-cn/docs/reference/using-api/api-concepts/#semantics-for-get-and-list">get list resourceVersion</a>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>





  <!-- <h2 id="__comments">Comments</h2> -->
  <!-- Insert generated snippet here -->
  <script src="https://giscus.app/client.js"
  data-repo="llibeohs/llibeohs.github.io"
  data-repo-id="R_kgDOJQ6AsQ"
  data-category="Announcements"
  data-category-id="DIC_kwDOJQ6Asc4CVkC6"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="top"
  data-theme="light"
  data-lang="zh-CN"
  data-loading="lazy"
  crossorigin="anonymous"
  async>
</script>
  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate" ? "dark" : "light"
      giscus.setAttribute("data-theme", theme) 
    }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <!--
  Copyright (c) 2016-2022 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Footer -->
<footer class="md-footer">

    <!-- Link to previous and/or next page -->
    
      <nav
        class="md-footer__inner md-grid"
        aria-label=""
      >
  
        <!-- Link to previous page -->
        
          
          <a
            href="../apiserver/"
            class="md-footer__link md-footer__link--prev"
            aria-label="Previous: apiserver"
            rel="prev"
          >
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                apiserver
              </div>
            </div>
          </a>
        
  
        <!-- Link to next page -->
        
          
          <a
            href="../etcd/"
            class="md-footer__link md-footer__link--next"
            aria-label="Next: etcd"
            rel="next"
          >
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                etcd
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  </footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["content.code.annotate", "content.code.copy", "content.tooltips", "navigation.top", "navigation.tabs", "navigation.tracking", "search.highlight", "search.suggest", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.208ed371.min.js", "tags": {"Bash": "bash", "CSS": "css", "Docker": "docker", "Go": "golang", "HTML5": "html", "JavaScript": "js", "K8s": "k8s", "Linux": "linux", "MySQL": "mysql", "Python": "python", "Rust": "rust", "\u7a0b\u5e8f\u5458\u9884\u5907": "newbie"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.19047be9.min.js"></script>
      
        <script src="../../../../js/tablesort.min.js"></script>
      
        <script src="../../../../js/tablesort.js"></script>
      
        <script src="../../../../js/baidu-statistics.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>