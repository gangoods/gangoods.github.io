{"config":{"lang":["en"],"separator":"[\\s\\-,:!=\\[\\]()\"/]+|(?!\\b)(?=[A-Z][a-z])|\\.(?!\\d)|&[lg]t;","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"home","text":"<p>\u8fd8\u6709\u8c01?</p> <ol> <li>\u5b66\u4e60\u65b0\u6280\u672f\u5c31\u50cf\u62c9\u5c4e (\u7545\u5feb\u7684,\u6109\u60a6\u7684)</li> <li>\u8bb0\u7b14\u8bb0\u5c31\u50cf\u7a9c\u7a00 (\u79d2\u6740 \u54c8\u54c8)</li> <li>\u590d\u4e60\u77e5\u8bc6\u5c31\u50cf\u5403\u5c4e (\u8ba9\u5b50\u5f39\u98de\u845b\u4f18\u6076\u5fc3\u5450\u6076\u5fc3.jpg)</li> <li>\u5199\u535a\u5ba2\u5c31\u50cf\u4fbf\u79d8 (\u8fc7\u7a0b\u662f\u75db\u82e6\u7684,\u7ed3\u5c40\u662f\u8212\u670d\u7684,\u4e0d\u7528\u5403\u5c4e\u5c31\u590d\u4e86\u4e60,\u6211\u771f\u4ed6\u5a18\u7684\u662f\u4e2a\u5929\u624d)</li> </ol> <p>\u7b80\u5355\u4ecb\u7ecd</p> <p>\u5f53\u524d\u4e3b\u8981\u6574\u7406\u4e86 go \u548c k8s \u548c linux shell</p> <p>\u5f88\u591a\u53ef\u80fd\u8fd8\u4e0d\u592a\u5b8c\u5584,\u6ca1\u5199\u5b8c\u7b49\u7b49</p> <p>\u6574\u7406\u4e2d...</p>"},{"location":"about/","title":"About","text":"<p>about me</p>"},{"location":"tags/","title":"tags","text":""},{"location":"tags/#bash","title":"Bash","text":"<ul> <li>\u57fa\u7840</li> <li>sed</li> <li>\u53d8\u91cf</li> <li>\u7efc\u5408\u4f8b\u5b50</li> </ul>"},{"location":"tags/#docker","title":"Docker","text":"<ul> <li>\u6d41\u91cf\u8d70\u5411\u5206\u6790</li> </ul>"},{"location":"tags/#go","title":"Go","text":"<ul> <li>Map</li> <li>\u6c47\u7f16</li> <li>context</li> </ul>"},{"location":"tags/#linux","title":"Linux","text":"<ul> <li>\u670d\u52a1\u5668\u95ee\u9898\u96c6\u9526</li> </ul>"},{"location":"tags/#docker_1","title":"docker","text":"<ul> <li>dockerfile</li> </ul>"},{"location":"tags/#k8s","title":"k8s","text":"<ul> <li>\u547d\u4ee4\u6c47\u603b</li> <li>\u73af\u5883\u5b89\u88c5</li> <li>\u955c\u50cf\u4ed3\u5e93</li> <li>apiserver</li> <li>controller-manager</li> <li>etcd</li> <li>kubectl</li> <li>API\u8d44\u6e90</li> <li>\u914d\u7f6e\u7ba1\u7406</li> <li>\u63a7\u5236\u5668</li> <li>\u5b58\u50a8\u7ba1\u7406</li> <li>pod</li> <li>\u8c03\u5ea6\u5668</li> <li>service</li> <li>client-go</li> <li>sample-controller</li> </ul>"},{"location":"tags/#mysql","title":"mysql","text":"<ul> <li>\u7d22\u5f15\u5e95\u5c42</li> </ul>"},{"location":"tags/#redis","title":"redis","text":"<ul> <li>\u6570\u636e\u7c7b\u578b</li> <li>\u73af\u5883\u914d\u7f6e</li> <li>\u6570\u636e\u6301\u4e45\u5316</li> <li>\u6e90\u7801\u5206\u6790</li> </ul>"},{"location":"tags/#_1","title":"\u7a0b\u5e8f\u5458\u9884\u5907","text":"<ul> <li>ssh</li> <li>git\u57fa\u7840</li> </ul>"},{"location":"tags/#_2","title":"\u7f51\u7edc\u7f16\u7a0b","text":"<ul> <li>https\u4e0e\u8bc1\u4e66</li> <li>tcp</li> </ul>"},{"location":"cs/assembly/","title":"Index","text":""},{"location":"cs/assembly/env/","title":"Env","text":""},{"location":"cs/assembly/env/#_1","title":"\u5f00\u53d1\u73af\u5883\u914d\u7f6e","text":""},{"location":"cs/assembly/env/#_2","title":"\u5b89\u88c5","text":"<p>dosbox</p> <p>\u5b89\u88c5\u540e,\u5c06dosbox \u62d6\u5230\u5e94\u7528\u7a0b\u5e8f \u5b89\u88c5\u76ee\u5f55\u6709 Manual.txt  \u8fd9\u6837\u7684\u8bf4\u660e\u6587\u6863,\u91cc\u9762\u53ef\u4ee5\u770b\u770b \u7136\u540e \u6bd4\u5982\u5728 ~/ \u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\u5939, sam, \u5c06\u4e0b\u8f7d\u7684\u6587\u4ef6\u89e3\u538b,\u5c06\u91cc\u9762\u7684debug.exe \u7b49\u6587\u4ef6\u590d\u5236\u5230\u8be5\u6587\u4ef6\u5939\u91cc,\u7136\u540e \u6253\u5f00dosbox \u8f93\u5165 mount c ~/sam \u7136\u540e\u4f60\u8f93\u5165c: \u5373\u53ef\u5728dosbox \u663e\u793ac:&gt; \u8fd9\u6837</p> <p>\u4f46\u662f\u8fd9\u6837\u6bcf\u6b21\u542f\u52a8dosbox\u90fd\u5f97\u8fd9\u6837\u5f88\u9ebb\u70e6 \u6211\u4eec\u901a\u8fc7manual.txt\u91cc\u627e\u5230\u5e2e\u52a9 \u7f16\u8f91\u6587\u4ef6~/Library/Preferences/DOSBox 0.74-2 Preferences \u5728\u540e\u9762\u7684\u8fd9\u91cc\u6dfb\u52a0 <pre><code>[autoexec]\n# Lines in this section will be run at startup.\n# You can put your MOUNT lines here.\nmount c ~/myasm\nc:\n</code></pre></p>"},{"location":"cs/assembly/env/#debug","title":"debug\u7684\u4f7f\u7528\u65b9\u6cd5","text":"<p>\u8f93\u5165debug \u56de\u8f66</p> <ol> <li>r \u547d\u4ee4</li> </ol> <p>\u8f93\u5165 r \u67e5\u770b CPU \u5bc4\u5b58\u5668\u7684\u72b6\u6001 r ax \u56de\u8f66\u53ef\u4ee5\u770b\u5230ax\u5bc4\u5b58\u5668\u4e2d\u7684\u5185\u5bb9 \u7136\u540e\u8f93\u5165\u4f60\u8981\u4fee\u6539\u7684\u503c,\u56de\u8f66 \u5219\u4f1a \u4fee\u6539\u5bc4\u5b58\u5668\u4e2d\u7684\u503c</p> <ol> <li>d\u547d\u4ee4</li> </ol> <p>d \u6bb5\u5730\u5740:\u504f\u79fb\u5730\u5740\uff1a\u67e5\u770b\u4ece\u6307\u5b9a\u5185\u5b58\u5355\u5143\u5f00\u59cb\u7684 128 \u4e2a\u5185\u5b58\u5355\u5143\u7684\u5185\u5bb9 \u5728\u4e0a\u4e00\u4e2a\u6307\u4ee4\u4e4b\u540e\u518d\u4f7f\u7528d\u6307\u4ee4\uff0c\u5c06\u5217\u51fa\u540e\u7eed 128 \u4e2a\u5185\u5b58\u5355\u5143\u7684\u5185\u5bb9 d 1000:0 \u56de\u8f66 \u67e5\u770b\u5230128\u4e2a\u5b57\u8282</p> <p>d \u6bb5\u5730\u5740:\u8d77\u59cb\u504f\u79fb\u5730\u5740 \u7ed3\u5c3e\u504f\u79fb\u5730\u5740\uff1a\u67e5\u770b\u5236\u5b9a\u8303\u56f4\u7684\u5185\u5bb9 d 1000:0 F \u67e5\u770b16\u4e2a\u5b57\u8282\u7684\u5185\u5bb9</p> <p>d \u56de\u8f66 \u53ef\u4ee5\u770b\u5230\u4e09\u4e2a\u5757 \u5de6\u8fb9\u662f\u5730\u5740 \u4e2d\u95f4\u662f\u5730\u5740\u91cc\u7684\u5185\u5bb9  \u53f3\u8fb9\u662f\u5bf9\u5e94\u7684ascii\u7801</p> <ol> <li>e\u547d\u4ee4</li> </ol> <p>e \u8d77\u59cb\u5730\u5740 \u6570\u636e \u6570\u636e \u6570\u636e ......\uff1a\u8d77\u59cb\u5730\u5740(\u6bb5\u5730\u5740:\u504f\u79fb\u5730\u5740)\uff1b\u6539\u5199\u5185\u5b58\u4e2d\u7684\u5185\u5bb9\u3002</p> <p>e \u6bb5\u5730\u5740:\u504f\u79fb\u5730\u5740\uff1a\u7136\u540e\u5149\u6807\u505c\u5728.\u540e\u9762\u8868\u793a\u8f93\u5165\u9700\u8981\u4fee\u6539\u7684\u5185\u5bb9(\u5de6\u8fb9\u8868\u793a\u7684\u662f\u539f\u6765\u7684\u5185\u5bb9)\uff1b\u8fd9\u91cc\u662f\u6309\u7a7a\u683c\u952e\u7ed3\u675f\u8be5\u5355\u5143\u7684\u4fee\u6539\uff1b\u76f4\u63a5\u6309\u7a7a\u683c\u952e\uff0c\u8868\u793a\u4e0d\u4fee\u6539\uff0c\u76f4\u63a5\u7ed3\u675f\u8be5\u5355\u5143\u7684\u4fee\u6539\uff1b\u63a5\u7740\u663e\u793a\u4e0b\u4e00\u4e2a\u5185\u5b58\u5355\u5143\u7684\u539f\u59cb\u5730\u5740\uff0c\u5e76\u4ee5\u540c\u6837\u7684\u65b9\u5f0f\u8fdb\u884c\u4fee\u6539\uff1b\u6309\u56de\u8f66\u7ed3\u675f\u8be5\u64cd\u4f5c\u3002</p> <p>\u53ef\u4ee5\u5411\u5185\u5b58\u4e2d\u5199\u5165\u5b57\u7b26\uff0f\u5b57\u7b26\u4e32 e 2000:0 \"012345678\" \u56de\u8f66 \u53ef\u4ee5\u770b\u5230 \u4e2d\u95f4\u5b57\u8282\u91cc\u7684\u5185\u5bb9\u90e8\u5206\u662f\u5b57\u7b26\u5bf9\u5e94\u768416\u8fdb\u5236\u6570\u636e(ascii\u7f16\u7801), \u53f3\u8fb9\u662fascii\u7f16\u7801\u5bf9\u5e94\u7684\u5b57\u7b26</p> <ol> <li> <p>u \u547d\u4ee4 u \u521d\u59cb\u5730\u5740\uff1a\u67e5\u770b\u5185\u5b58\u4e2d\u673a\u5668\u7801\u5bf9\u5e94\u7684\u6c47\u7f16\u6307\u4ee4 \u547d\u4ee4\u65b9\u5f0f\u540cd\u547d\u4ee4, \u90fd\u53ef\u4ee5\u67e5\u770b\u6307\u5b9a\u533a\u95f4\u7684</p> </li> <li> <p>t \u547d\u4ee4</p> </li> </ol> <p>\u5176\u4ed6\u547d\u4ee4,\u6709\u4e9b\u4e0d\u8fc7\u662f\u8f93\u5165\u4e86\u5185\u5bb9,\u8fd8\u6ca1\u6709\u6267\u884c\u91cc\u9762\u7684\u6307\u4ee4!!! t\uff1a\u6267\u884cCS:IP\u6307\u5411\u7684\u6307\u4ee4\uff0c\u6307\u4ee4\u6267\u884c\u540e Debug\u4f1a\u8f93\u51faCPU\u4e2d\u5bc4\u5b58\u5668\u7684\u72b6\u6001\u3002</p> <ol> <li>a  \u547d\u4ee4 a \u521d\u59cb\u5730\u5740\uff1a\u4ee5\u6c47\u7f16\u6307\u4ee4\u7684\u5f62\u5f0f\u5728\u5185\u5b58\u4e2d\u5199\u5165\u673a\u5668\u7801\uff0c\u76f4\u63a5\u56de\u8f66\uff0c\u7ed3\u675f\u64cd\u4f5c a 1000:0 \u56de\u8f66 \u8f93\u5165\u547d\u4ee4,  \u8868\u793a\u57281000:0 \u5730\u5740\u5199\u5165\u6307\u4ee4</li> </ol> <p>a \u56de\u8f66 \u5199\u5165\u6307\u4ee4 \u4ece\u4e00\u4e2a\u9884\u8bbe\u5730\u5740\u5f00\u59cb\u8f93\u5165\u6307\u4ee4\uff0c\u76f4\u63a5\u56de\u8f66\uff0c\u7ed3\u675f\u64cd\u4f5c</p>"},{"location":"cs/assembly/env/#_3","title":"\u5c0f\u7684\u6570\u5b57\u4e4b\u95f4\u8fdb\u5236\u5feb\u901f\u8f6c\u6362","text":""},{"location":"cs/assembly/env/#_4","title":"\u5c0f\u7684\u5341\u8fdb\u5236\u6570\u5feb\u901f\u8f6c\u4e8c\u8fdb\u5236","text":"<p>\u4e00\u4e2a\u5b57\u8282\u76847\u4e2a\u4f4d 111 1111 2\u76847\u6b21\u65b9=64 \u4f9d\u6b21\u7c7b\u63a8 \u6211\u4eec\u628a\u4e00\u4e2a\u5b57\u8282\u76847\u4e2a\u4f4d \u5bf9\u5e94\u7684\u5341\u8fdb\u5236\u6570\u8bb0\u4f4f 1   1   1   1  1  1  1  64  32  16  8  4  2  1 \u7ed9\u4e2a73\u768410\u8fdb\u5236,\u6211\u4eec\u8111\u5b50\u91cc\u8981\u60f3\u523073=64+9 =64+8+1 =01001001 35=32+3=32+2+1 = 0010 0011</p>"},{"location":"cs/assembly/env/#1016","title":"\u5c0f\u768410\u8fdb\u5236\u5feb\u901f\u8f6c16\u8fdb\u5236","text":"<p>16\u8fdb\u5236 : Hexadecimal -&gt;hex 10\u8fdb\u5236: Decimal -&gt;dec 16\u7684\u500d\u6570 \u548c\u4f59\u6570 82=16X5+2 =0x52</p>"},{"location":"cs/assembly/env/#162","title":"16\u8fdb\u5236\u5feb\u901f\u8f6c2\u8fdb\u5236","text":"<p>7E= 7\u4e2a16+14= 7\u4e2a16\u9a6c\u4e0a\u8111\u5b50\u91cc\u5c31\u80fd\u5206\u51fa 4\u4e2a16+2\u4e2a16+1\u4e2a16 +14 \u8bb0\u4f4f\u4e00\u4e2a\u5b57\u8282\u7684\u540e4\u4e2a\u4f4d,\u90fd\u662f16\u7684\u500d\u6570,\u6240\u4ee5\u8fd9\u91cc\u76847\u9a6c\u4e0a\u60f3\u52304+2+1 = 0111 =0111+ 8+4+2+0 = 0111 1110</p>"},{"location":"cs/assembly/env/#_5","title":"\u5f00\u53d1\u5de5\u5177","text":""},{"location":"cs/assembly/env/#windows","title":"windows","text":"<p>dosbox</p>"},{"location":"cs/assembly/env/#mac","title":"mac","text":"<p>nasm</p>"},{"location":"cs/assembly/env/#_6","title":"\u673a\u5668\u6307\u4ee4","text":""},{"location":"cs/assembly/env/#_7","title":"\u673a\u5668\u6307\u4ee4\u4e0e\u6c47\u7f16\u6307\u4ee4","text":"<p>\u673a\u5668\u6307\u4ee4\u5c31\u662f0\u548c1 \u7684\u4e8c\u8fdb\u5236\u6570\u5b57, \u5c31\u662f\u8bb2\u4e8c\u8fdb\u5236\u6570\u5b57\u8f6c\u6362\u6210\u9ad8\u4f4e\u7535\u5e73,\u7136\u540e\u9a71\u52a8\u8ba1\u7b97\u673a\u90e8\u4ef6\u8fd0\u884c</p> <p>\u65e2\u7136\u662f\u6307\u4ee4,\u90a3\u4e48\u4e00\u5b9a\u6709\u4ed6\u7684\u542b\u4e49 \u5982\u679c\u5b89\u88c5dosbox ,\u8f93\u5165debug \u518d\u8f93\u5165-u \u8f93\u5165 -d\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u4fe1\u606f \u6bd4\u5982 B440 \u8fd9\u4e2a16\u8fdb\u5236  \u5bf9\u5e94\u7684\u6307\u4ee4\u662f MOV AH,40 B440 ==&gt; \u8f6c\u6210\u4e8c\u8fdb\u5236 \u2192 \u5bf9\u5e94\u6307\u4ee4 \u6211\u4eec\u628a \u4e8c\u8fdb\u5236\u7684\u53eb\u505a\u673a\u5668\u6307\u4ee4 \u628a \u5bf9\u5e94\u7684MOV AH,40 \u8fd9\u6837\u7684\u53eb\u505a\u6c47\u7f16\u6307\u4ee4</p>"},{"location":"cs/assembly/env/#_8","title":"\u7f16\u8bd1\u5668","text":"<p>\u6211\u4eec\u80af\u5b9a\u662f\u7528\u6c47\u7f16\u8bed\u8a00\u6765\u7f16\u5199\u7a0b\u5e8f,\u6bd4\u4f60\u76f4\u63a5\u51990101 \u4ec0\u4e48\u7684\u597d\u7684\u591a\u4e86, \u56e0\u4e3a\u8ba1\u7b97\u673a\u53ea\u8ba4\u8bc6\u673a\u5668\u6307\u4ee4,\u90a3\u4e48\u6211\u4eec\u5199\u7684\u6c47\u7f16\u5982\u4f55\u8ba9\u8ba1\u7b97\u673a\u8ba4\u8bc6\u5462, \u8fd9\u4e2a\u5c31\u9700\u8981\u4e00\u4e2a\u7ffb\u8bd1\u8f6f\u4ef6\u4e86,\u8fd9\u4e2a\u7ffb\u8bd1\u8f6f\u4ef6\u5c31\u53eb\u7f16\u8bd1\u5668</p> <p>\u6ce8\u610f \u6c47\u7f16\u6307\u4ee4 &gt;\u901a\u8fc7\u7f16\u8bd1\u5668 =&gt; 01010101 \u4f2a\u6307\u4ee4   ==&gt;\u544a\u8bc9\u7f16\u8bd1\u5668\u8fd9\u91cc\u7684\u600e\u4e48\u7ffb\u8bd1,\u7531\u7f16\u8bd1\u5668\u6307\u5411,\u6ca1\u6709\u5bf9\u5e94\u7684\u673a\u5668\u6307\u4ee4 \u7b26\u53f7\u4f53\u7cfb ==&gt; + - * / \u6ca1\u6709\u5bf9\u5e94\u7684\u673a\u5668\u6307\u4ee4,\u4e5f\u7531\u7f16\u8bd1\u5668\u6267\u884c</p>"},{"location":"cs/assembly/env/#cpu","title":"cpu\u4e0e\u5185\u5b58","text":"<p>\u901a\u8fc7cpu\u6765\u6267\u884c\u8fd9\u4e9b\u673a\u5668\u6307\u4ee4\u7684,CPU\u901a\u8fc7\u6307\u4ee4\u6765\u63a7\u5236\u8ba1\u7b97\u673a\u7684 \u8ba1\u7b97\u673a\u5173\u6709\u6307\u4ee4\u8fd8\u4e0d\u884c\u7684,\u9700\u8981\u6570\u636e \u6307\u4ee4\u548c\u6570\u636e\u5b58\u653e\u5230\u5185\u5b58\u4e2d cpu\u4e2d\u4e5f\u5b58\u653e\u4e86\u4e00\u90e8\u5206\u7684\u6307\u4ee4\u548c\u6570\u636e \u65e2\u7136\u6709\u6570\u636e,\u6015\u6df7\u4e71,\u5c31\u9700\u8981\u5bf9\u6570\u636e\u548c\u6307\u4ee4\u8fdb\u884c\u533a\u5206 \u6307\u4ee4\u548c\u6570\u636e\u662f\u4ee5\u4ec0\u4e48\u5f62\u5f0f\u5b58\u653e\u5230\u5185\u5b58\u4e2d\u7684\u5462?   \u4ee5\u4e8c\u8fdb\u5236(16\u8fdb\u5236\u7ed9\u4eba\u770b)\u7684\u5f62\u5f0f\u5b58\u653e\u5728\u5185\u5b58\u4e2d\u7684   \u5185\u5b58\u4e5f\u53eb\u5b58\u50a8\u5355\u5143,\u6700\u5c0f\u7684\u5b58\u50a8\u5355\u5143\u53ebbyte\u5b57\u8282,\u4e00\u4e2a\u5b57\u8282 = 2\u4e2a16\u8fdb\u5236\u6570\u5b57 =8\u4e2a\u4f4d \u64cd\u4f5c\u7cfb\u7edf\u4f1a\u5bf9\u5185\u5b58\u8fdb\u884c\u7f16\u53f7,\u4ece0\u5f00\u59cb\u7b97</p> <p>\u5185\u5b58\u6761\u4e0a\u6709\u5185\u5b58,\u5b9e\u9645\u4e0a\u8ba1\u7b97\u673a\u5176\u4ed6\u90e8\u4ef6\u4e0a\u4e5f\u662f\u6709\u5185\u5b58\u7684 cpu\u901a\u8fc7\u5185\u5b58\u7684\u8bfb\u5199\u6765\u63a7\u5236\u8ba1\u7b97\u673a</p> <ul> <li>cpu\u5982\u4f55\u4e0e\u5185\u5b58\u4e2d\u7684\u6307\u4ee4\u548c\u6570\u636e\u8054\u7cfb</li> </ul> <p>\u901a\u8fc7\u4e09\u4e2a\u4fe1\u606f \u5bf9\u7535\u8111\u8fdb\u884c\u63a7\u5236 1. \u5185\u5b58\u7f16\u53f7\u7684\u4fe1\u606f = \u5730\u5740\u4fe1\u606f    \u6211\u4eec\u628a\u63cf\u8ff0\u5730\u5740\u4fe1\u606f\u7684\u7535\u8def\u53eb\u505a \u5730\u5740\u7ebf</p> <ol> <li> <p>\u6570\u636e\u4fe1\u606f    == \u6570\u636e\u7ebf</p> </li> <li> <p>\u63a7\u5236\u4fe1\u606f   == \u63a7\u5236\u7ebf</p> </li> </ol>"},{"location":"cs/assembly/env/#_9","title":"\u5730\u5740\u7ebf","text":"<p>\u5730\u5740\u7ebf \u75280\u62161\u8868\u793a, \u5185\u5b58\u662f\u4ece0\u5f00\u59cb\u7f16\u53f7\u7684, \u5982\u679c\u53ea\u6709\u4e00\u4e2a\u6839\u5730\u5740\u7ebf \u90a3\u4e48\u7f16\u53f7\u4e3a0\u7684\u5730\u5740 \u75280\u6765\u8868\u793a\u7f16\u53f7\u4e3a0\u7684\u5730\u5740 1 \u75281 \u8868\u793a ,\u7f16\u53f7\u4e3a2\u7684\u5730\u5740,\u65e0\u6cd5\u8868\u793a\u4e86? \u5982\u679c\u67092\u6839\u5730\u5740\u7ebf, \u90a3\u4e48\u6700\u5927\u80fd\u6709 2\u76842\u4e2a\u5e73\u65b9 =4\u4e2a\u5730\u5740,\u4ee5\u6b64\u7c7b\u63a8</p> <p>\u5047\u8bbe\u6709N\u6839\u5730\u5740\u7ebf,\u5c31\u80fd\u627e\u52302\u7684N\u6b21\u65b9\u4e2a\u5730\u5740(\u5c31\u662f\u5b57\u8282\u4e86) \u7f16\u53f7\u5c31\u662f 0 - (2\u7684n\u6b21\u65b9-1) \u4e00\u4e2a\u5730\u5740 \u5c31\u662f\u4e00\u4e2a\u5b57\u8282,\u56e0\u4e3a\u5185\u5b58\u7684\u6700\u5c0f\u5b58\u50a8\u5355\u5143\u662f\u5b57\u8282</p> <p>\u6240\u4ee5\u5730\u5740\u7ebf\u7684\u6570\u91cf\u51b3\u5b9a\u4e86\u80fd\u591f\u8868\u793a\u591a\u5c11\u4e2a\u5730\u5740 \u5c31\u662f\u591a\u5c11\u5185\u5b58,  \u5bfb\u5740\u80fd\u529b</p> <p>\u4e00\u4e2a\u8ba1\u7b97\u673a\u5185\u5b58\u4e3a8kb,\u90a3\u4e48\u4ed6\u6709\u591a\u5c11\u6839\u5730\u5740\u7ebf\u5462 (\u6216\u8005\u95ee\u4ed6\u7684\u5730\u5740\u603b\u7ebf\u5bbd\u5ea6\u662f\u591a\u5c11) 8kb=8x1024 byte =2\u76843\u6b21\u65b9 X 2\u768410\u6b21\u65b9 =2\u768413\u6b21\u65b9  = 13\u6839</p> <p>1kb\u7684\u5b58\u50a8\u5668\u6709 1024\u4e2a\u5b58\u50a8\u5355\u5143,\u7f16\u53f7\u4ece0-1023</p> <p>8080,8088,80286,80386\u7684\u5730\u5740\u603b\u7ebf\u5bbd\u5ea6\u5206\u522b\u4e3a16\u6839,20\u6839,24\u6839,32\u6839,\u4ed6\u7684\u5bfb\u5740\u80fd\u529b\u5206\u522b\u4e3a 2\u768416\u6b21\u65b9byte=2\u76846\u6b21\u65b9 X 2\u768410\u6b21\u65b9=64X1kb,</p>"},{"location":"cs/assembly/env/#_10","title":"\u6570\u636e\u7ebf","text":"<p>\u6570\u636e\u7ebf\u4e5f\u662f\u7528 0\u62161 \u8868\u793a \u6700\u5c0f\u5355\u4f4d\u662f\u5b57\u8282 = 8\u4e2a\u4f4d \u6240\u4ee5\u6700\u5c11\u89818\u6839 \u6570\u636e\u7ebf \u4e00\u4e2abyte 8\u4e2abit \u8981\u4f20\u9001\u5230\u6bcf\u4e00\u4e2a\u6570\u636e\u7ebf\u4e0a</p> <p>8080,8088,8086,80286,80386\u7684\u6570\u636e\u603b\u7ebf\u5bbd\u5ea6\u5206\u522b\u4e3a8,8,16\u6839,16,32\u6839,\u4ed6\u4eec\u4f9d\u6b21\u53ef\u4ee5\u4f20\u9001\u7684\u6570\u636e\u4e3a1byte,1,2,2,4</p> <p>\u4ece\u5185\u5b58\u4e2d\u8bfb\u53d61024\u4e2a\u5b57\u8282\u7684\u6570\u636e,8086\u81f3\u5c11\u8981\u8bfb512\u6b21,\u56e0\u4e3a8086\u4e00\u6b21\u53ef\u4ee5\u4f20\u9001\u7684\u6570\u636e2byte</p>"},{"location":"cs/assembly/env/#_11","title":"\u63a7\u5236\u7ebf","text":"<p>\u63a7\u5236\u7ebf\u51b3\u5b9a\u4e86cpu\u80fd\u591f\u5bf9\u54ea\u4e9b\u90e8\u4ef6\u8fdb\u884c\u63a7\u5236</p>"},{"location":"cs/assembly/env/#_12","title":"\u5185\u5b58","text":"<p>debug  -e B800:400 \u4fee\u6539\u5185\u5b58\u4e2d\u7684\u6570\u636e,\u6211\u4eec\u53d1\u73b0 \u5728dosbox \u7a97\u53e3\u4e0a\u663e\u793a \u4e86\u4e0d\u540c\u7684\u4fe1\u606f, \u5176\u5b9e\u8fd9\u4e2a\u5185\u5b58\u5730\u5740\u4e0d\u662f\u5185\u5b58\u6761\u7684\u5730\u5740</p> <p>\u8ba1\u7b97\u673a\u6709\u5f88\u591a\u90e8\u4ef6,\u5185\u5b58\u6761\u662f\u8ba1\u7b97\u673a\u7684\u4e00\u4e2a\u90e8\u4ef6,\u6211\u4eec\u7684\u663e\u5361 \u663e\u5b58, \u5982\u679c\u6709\u4fee\u6539\u5185\u5bb9,\u5c31\u4f1a\u663e\u793a\u5728\u663e\u793a\u5668\u4e0a, \u663e\u5b58 \u4e5f\u662f\u4e00\u79cd\u5185\u5b58</p> <p>\u6211\u4eec\u53ef\u4ee5\u8bd5\u7740\u4fee\u6539\u5176\u4ed6\u5730\u5740,\u4f60\u53ef\u80fd\u770b\u5230 \u7a97\u53e3\u4e0a\u4e0d\u4f1a\u663e\u793a\u4ec0\u4e48\u4fe1\u606f, \u8fd9\u79cd\u60c5\u51b5 \u5c31\u8bf4\u660e\u73b0\u5728\u7684\u5185\u5b58\u4e0d\u662f\u663e\u5b58\u4e0a\u7684\u4e86</p> <p>cpu\u901a\u8fc73\u4e2a\u7ebf \u53bb\u63a7\u5236\u4e3b\u677f\u4e0a\u7684\u90e8\u4ef6(\u5185\u5b58\u548c\u663e\u5361), \u5185\u5b58\u7a7a\u95f4 \u5305\u62ec \u5185\u5b58\u6761\u4e0a\u7684\u5185\u5b58,\u663e\u5b58\u7b49\u5185\u5b58 \u5185\u5b58\u6761\u7684\u5185\u5b58\u7684\u5730\u5740 \u6bd4\u5982\u662f\u4ece100-200 \u8fd9\u6837\u7684\u7f16\u53f7 \u800c\u663e\u5b58\u4e5f\u6709 \u5730\u5740\u7f16\u53f7,\u6bd4\u5982\u662f201-300</p> <p>\u8bb0\u4f4f:</p> <pre><code>\u4fee\u6539\u663e\u5b58\u4e2d\u7684\u5185\u5b58,\u4f1a\u4fee\u6539\u663e\u793a\u60c5\u51b5\n\u6bd4\u5982 \u4fee\u6539\u4e86cmd\u7a97\u53e3\u4e2d\u6587\u5b57\u7684\u989c\u8272\n</code></pre> <p>RAM \u5185\u5b58 : \u5141\u8bb8\u8bfb\u53d6\u548c\u5199\u5165 \u65ad\u7535\u540e\u6307\u4ee4\u548c\u6570\u636e\u5c31\u4e22\u5931\u4e86</p> <p>ROM : \u53ea\u5141\u8bb8\u8bfb\u53d6, \u65ad\u7535\u540e, \u6307\u4ee4\u548c\u6570\u636e\u8fd8\u5b58\u5728, \u4e00\u822c\u7528\u5728\u542f\u52a8\u8ba1\u7b97\u673a\u4e0a\u9762     \u4e5f\u662f\u901a\u8fc7\u5185\u5b58\u5730\u5740\u53bb\u8bbf\u95ee\u7684</p> <p>\u9f20\u6807,\u952e\u76d8,\u97f3\u54cd\u8fd9\u4e9b,cpu\u662f\u5982\u4f55\u63a7\u5236\u7684\u5462? \u662f\u901a\u8fc7\u7aef\u53e3\u6765 \u9f20\u6807\u548c\u952e\u76d8 \u90fd\u6709\u4e00\u5757\u82af\u7247, \u82af\u7247\u91cc\u5b58\u7740\u6307\u4ee4\u548c\u6570\u636e</p> <p>\u952e\u76d8\u901a\u8fc7\u7aef\u53e3\u4e0e\u8ba1\u7b97\u673a\u94fe\u63a5\u7740 \u7aef\u53e3\u53c8\u4e0e\u4e3b\u677f\u94fe\u63a5, \u4e3b\u677f\u4e0ecpu\u94fe\u63a5\u7740\u7684 \u952e\u76d8\u901a\u8fc7\u4e0e\u4e3b\u677f\u94fe\u63a5\u7684\u7535\u7ebf,\u53d1\u9001\u4ed6\u7684\u6307\u4ee4\u5230\u7aef\u53e3, cpu\u901a\u8fc7\u4e09\u6839\u7ebf(..) \u83b7\u53d6\u7aef\u53e3\u4e2d\u7684\u6307\u4ee4</p> <p>cpu \u662f\u53ef\u4ee5\u901a\u8fc7\u4e3b\u677f\u4e0a\u7684\u7535\u8def,\u8bfb\u5230\u6240\u6709\u7684\u6570\u636e\u7684</p>"},{"location":"cs/assembly/env/#_13","title":"\u7aef\u53e3\u53f7","text":"<p>\u4ec0\u4e48\u952e\u76d8\u9f20\u6807,cpu\u662f\u901a\u8fc7\u7aef\u53e3\u53f7\u6765\u8fde\u63a5\u63a7\u5236\u7684 cpu\u4e5f\u7ed9 \u4ed6\u4eec\u7f16\u53f7\u4e86 60H\u662f\u952e\u76d8\u7684</p> <p>\u901a\u8fc7\u5185\u5b58\u5730\u5740\u53bb\u8bbf\u95ee\u5185\u5b58\u6761,\u663e\u5b58 rom\u7b49\u7684</p>"},{"location":"cs/assembly/env/#gpu","title":"GPU","text":"<p>\u56fe\u5f62\u7684\u8981\u6c42\u8d8a\u6765\u8d8a\u9ad8\u4e86, \u65e9\u671f\u753b\u56fe\u8fd9\u4e2a\u5de5\u4f5c\u4e5f\u662fcpu\u5e72\u7684,, \u73b0\u5728\u5c31\u628a\u56fe\u5f62\u7684\u5904\u7406\u4e13\u95e8 \u7ed9GPU\u6765\u5904\u7406\u4e86 GPU\u4e5f\u6709\u4e13\u95e8\u7684\u7f16\u7a0b\u8bed\u8a00</p>"},{"location":"cs/assembly/env/#cpu_1","title":"cpu\u4e0e\u6c47\u7f16","text":"<p>\u6211\u4eec\u6c47\u7f16\u8bed\u8a00 \u5c31\u662f\u9488\u5bf9cpu\u7684\u8bed\u8a00 cpu\u901a\u8fc7\u5730\u5740\u7ebf,\u6570\u636e\u7ebf,\u63a7\u5236\u7ebf\u6765 \u8bbf\u95ee\u5185\u5b58\u548c\u7aef\u53e3\u7684 \u90a3\u4e48cpu\u4e2d\u80af\u5b9a\u5b58\u50a8\u7740\u8fd9\u4e9b\u7ebf\u7684\u4fe1\u606f(\u5730\u5740\u4fe1\u606f,\u6570\u636e\u4fe1\u606f) ,,\u8fd9\u4e9b\u5730\u65b9\u5c31\u53eb\u505a \u5bc4\u5b58\u5668</p> <p>\u90a3\u4e48\u6211\u4eec\u7684\u6c47\u7f16\u8bed\u8a00\u5c31\u662f\u901a\u8fc7\u6c47\u7f16\u4e2d\u7684\u6c47\u7f16\u6307\u4ee4\u53bb\u4fee\u6539\u5bc4\u5b58\u5668\u4e2d\u7684\u5185\u5bb9,\u4ece\u800c\u63a7\u5236\u4e86cpu, \u8fd9\u6837\u5c31\u63a7\u5236\u4e86\u6574\u4e2a\u8ba1\u7b97\u673a\u4e86 </p> <p>\u6bd4\u5982\u6307\u4ee4 : MOV AX,0005  \u5176\u4e2d\u7684AC\u5c31\u662f\u4e00\u4e2a\u6570\u636e\u5bc4\u5b58\u5668</p> <p>debug  -r \u67e5\u770b\u5bc4\u5b58\u5668</p>"},{"location":"cs/assembly/env/#_14","title":"\u5bc4\u5b58\u5668","text":""},{"location":"cs/assembly/env/#_15","title":"\u901a\u7528\u5bc4\u5b58\u5668","text":"<p>AX BX CX DX</p> <p>\u901a\u7528\u5bc4\u5b58\u5668,\u662f\u5b58\u653e\u6570\u636e\u7684,\u6570\u636e\u5bc4\u5b58\u5668 \u4ed6\u4eec\u662f\u6709\u5bb9\u91cf\u7684</p> <p>\u5bc4\u5b58\u5668 \u5927\u591a\u662f 2\u4e2a\u5b57\u8282 = 16\u4e2abit    0000 0000 0000 0000 ~ 1111 1111 1111 1111    0~65535  \u4e00\u5171\u53ef\u4ee5\u8868\u793a65536\u4e2a\u72b6\u6001</p> <p>\u6211\u4eec\u4e5f\u79f0\u4e4b\u4e3a16\u4f4d \u5bc4\u5b58\u5668</p> <p>\u4e3a\u4ec0\u4e48\u6211\u4eec\u628a4\u4e2a\u5bc4\u5b58\u5668 \u8bf4\u6210\u6bd4\u8f83\u7279\u6b8a\u5462</p> <p>\u56e0\u4e3a\u4ed6\u4eec\u53ef\u4ee5\u5404\u81ea\u5206\u5272\u4e3a2\u4e2a8\u4f4d\u7684\u5bc4\u5b58\u5668</p> <p>AX =AH+AL    AX\u7684\u9ad88\u4f4d \u6784\u6210\u4e86 AH\u5bc4\u5b58\u5668  H= High   AX\u7684\u4f4e8\u4f4d \u6784\u6210\u4e86 AL\u5bc4\u5b58\u5668  L= Low BX =BH+BL CX =CH+CL DX =DH+DL</p> <p>\u8fd9\u4e9b\u4e2a8\u4f4d\u5bc4\u5b58\u5668 \u53ea\u80fd\u8868\u793a 0000 0000 - 1111 1111 0-255  256\u4e2a\u72b6\u6001</p> <p>\u4e3a\u4ec0\u4e48\u67098\u4f4d\u5bc4\u5b58\u5668\u5462? \u4e3a\u4e86\u517c\u5bb9,\u5c31\u662f\u4ee5\u524d\u7f16\u5199\u7684\u7a0b\u5e8f,\u6539\u6539\u5c31\u80fd\u8fd0\u884c\u57288086cpu\u4e0a</p>"},{"location":"cs/assembly/env/#816816","title":"8\u4f4d,16\u5bc4\u5b58\u5668\u548c8\u4f4d,16\u4f4d\u6570\u636e","text":"<p>\u5728\u4f7f\u7528mov \u65f6,\u8981\u4fdd\u8bc1\u6570\u636e\u4e0e\u5bc4\u5b58\u5668\u4e4b\u95f4 \u4f4d\u6570\u7684\u4e00\u81f4\u6027 <pre><code>#\u8f93\u5165r\u56de\u8f66,\u67e5\u770b\u5bc4\u5b58\u5668\u7684\u72b6\u6001\n#\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u770b\u5230 \u5404\u4e2a\u5bc4\u5b58\u5668\u91cc\u5b58\u653e\u7684\u503c\n# 073E:010E \u53f3\u8fb9\u5bf9\u5e94\u4e00\u4e2a\u6307\u4ee4\u4ec0\u4e48\u7684\n#\u6211\u4eec\u7528 a\u547d\u4ee4\u6765\u8fd0\u884c\u67d0\u4e2a\u6307\u4ee4\n#\u8f93\u5165a 073E:010E  \u56de\u8f66\n\u8f93\u5165 mov ax,5   \u8fd9\u91cc\u76845\u8868\u793a\u7684\u662f16\u8fdb\u5236\n\u8f93\u5165r \u67e5\u770b \u5bc4\u5b58\u5668\u7684\u72b6\u6001,\u8fd9\u4e2a\u6307\u4ee4\u770b\u4e0d\u5230\u4fee\u6539\u540e\u7684\u5bc4\u5b58\u5668\u7684\u5b58\u50a8\u7684\u6570\u636e\u7684\n\nmov ax,0005  --&gt;0005 16\u4f4d\u7684\u6570\u5b57\n\u8f93\u5165 t \u67e5\u770b\u5bc4\u5b58\u5668\u7684\u503c\n\n\u540c\u6837\u65b9\u5f0f\u8fd0\u884c\u4e0a\u9762\u7684\u6307\u4ee4\n\u7136\u540e \u8f93\u5165\u7684\u662f \nmov al,7\n\u5728r ,t \u4f60\u4f1a\u770b\u5230  mov al,07  \u53d8\u62108\u4f4d\u7684\u6570\u636e\u4e86\n\nmov bl,ax \u62a5\u9519\u7684,\u56e0\u4e3a\u4f60\u628a16\u4f4d\u5bc4\u5b58\u5668\u7684\u6570\u636e\u7ed98\u4f4d\u7684,\nmov al,100 \u62a5\u9519, \u6ce8\u610f\u8fd9\u91cc\u7684\u90fd\u662f16\u8fdb\u5236,100\u8d85\u8fc7\u4e868\u4f4d\u4e86\u4e86\n\na\n\u4e0b\u9762\u7684\u5de6\u4fa7 \u5c31\u662f\u4f60\u7684\u6307\u4ee4\u5b58\u653e\u7684\u5185\u5b58\u4f4d\u7f6e\n073F:010C mov ax,0\n073F:010F mov ax,93\n073F:0112 add al,85\n\u56de\u8f66\n\u7136\u540e\u8f93\u5165r \u5148\u67e5\u770b\n\u7136\u540et \u67e5\u770b\u547d\u4ee4\u8fd0\u884c\u7684\u7ed3\u679c(\u5bc4\u5b58\u5668\u7684\u503c\u53d8\u5316\u4e86)\n\u7ee7\u7eedr, \u4e00\u6b65\u4e00\u6b65\u7684\u6307\u4ee4\u7684\u64cd\u4f5c\u90fd\u770b\u5230\u7ed3\u679c\u4e86\n\n93=1001 0011  \u521a\u597d8\u4e2a\u4f4d\u7684\n93+85 =118 \u53ef\u4ee5\u5f88\u5feb\u7684\u5f97\u5230\u7b54\u6848  \u56e0\u4e3a\u662f16\u8fdb\u5236\u7684,\u902216\u8fdb1,=118\n\nadd al,85\nal=ax+85 = 93+85=118 \n\u800c118\u8d85\u8fc7\u4e868\u4e2a\u4f4d,al\u662f8\u4f4d\u5bc4\u5b58\u5668\n\u7ed3\u679c\u5982\u4f55\u5462?\n\n\u6211\u4eec\u53d1\u73b0ax\u5bc4\u5b58\u5668\u4e0a\u663e\u793a\u7684\u7ed3\u679c\u662f0018\n\u90a3\u4e48118 \u524d\u9762\u76841\u8dd1\u54ea\u91cc\u53bb\u4e86\u5462?? \u5176\u5b9e\u6ca1\u6709\u6d88\u5931\u6389,\u4fdd\u5b58\u5230\u5176\u4ed6\u5730\u65b9\u4e86\n\u6d4b\u8bd5\u4e00\u4e2a16\u4f4d\u7684\u76f8\u52a0,\u5982\u679c\u8d85\u8fc7\u4e8616\u4f4d\u7684, \u60c5\u51b5\u4e0e\u4e0a\u9762\u4e00\u81f4\n\n\u5bc4\u5b58\u5668 \u90fd\u662f\u4e92\u76f8\u72ec\u7acb\u7684,al\u662fal,ah\u662fah \u4e0d\u4f1a\u4e92\u76f8\u5f71\u54cd\n</code></pre></p>"},{"location":"cs/assembly/env/#_16","title":"\u5b58\u653e\u5185\u5b58\u5730\u5740\u7684\u5bc4\u5b58\u5668","text":"<p>ds    sp es    bp ss    si cs    di       ip       bx \u8f93\u5165r \u770b\u5230 ds=073F \u8f93\u5165d \u770b\u5230 073F:0100  073F: \u8868\u793a\u6bb5\u5730\u5740   \u7528\u6bb5\u5730\u5740\u5bc4\u5b58\u5668\u6765\u5b58\u653e 0100: \u504f\u79fb\u5730\u5740     \u7528\u504f\u79fb\u5730\u5740\u5bc4\u5b58\u5668\u6765\u5b58\u653e</p> <p>8086cpu \u7ed9\u4e8620\u6839\u5730\u5740\u7ebf \u5c31\u670920\u4e2a\u4f4d, \u5730\u5740\u7ebf\u7684\u6570\u91cf\u51b3\u5b9a\u4e86cpu\u7684\u5bfb\u5740\u80fd\u529b \u4f46\u662f\u5bc4\u5b58\u5668\u53ea\u670916\u4f4d\u554a, \u5982\u4f55? \u6709\u4e86\u5730\u5740\u52a0\u6cd5\u5668  </p>"},{"location":"cs/assembly/env/#_17","title":"\u5730\u5740\u7684\u8ba1\u7b97\u65b9\u5f0f","text":"<p>\u6bb5\u5730\u5740 X 16 (\u8fd9\u4e2a16\u662f10\u8fdb\u5236\u7684 ,\u8fd9\u4e2a\u7ed3\u679c\u4e5f\u53eb\u57fa\u7840\u5730\u5740) + \u504f\u79fb\u5730\u5740  =\u7269\u7406\u5730\u5740</p> <p>\u4f7f\u7528\u79d1\u5b66\u8ba1\u7b97\u5668\u7684\u65f6\u5019 \u752816\u8fdb\u5236\u7684\u6bb5\u5730\u5740 X 10 \u5373\u53ef (16\u768410\u8fdb\u5236 \u6362\u621016\u8fdb\u5236 \u662f10)</p> <p>\u8fd9\u6837\u7684\u8ba1\u7b97\u65b9\u5f0f \u53ef\u4ee5\u7528\u4e0a\u6240\u6709\u768420\u6839\u5730\u5740\u7ebf, \u4e0d\u6d6a\u8d39</p> <p>d\u6307\u4ee4\u67e5\u770b d 2000:1F60 \u770b\u770b e 2000:1F60 \u8f93\u5165\u4f60\u8981\u4fee\u6539\u7684\u503c,\u6309\u4e0b\u7a7a\u683c,\u53ef\u4ee5\u7ee7\u7eed\u4fee\u6539 \u7136\u540e\u56de\u8f66 \u91cd\u590dd 2000:1F60 \u770b\u770b</p> <p>\u8fd9\u4e2a\u7684\u7269\u7406\u5730\u5740= 21F60 \u90a3\u4e48 \u901a\u8fc7\u5bf9\u5730\u5740\u8ba1\u7b97\u65b9\u5f0f\u7684\u4e86\u89e3 2100:0F60 \u4e5f\u662f21F60  \u6240\u4ee5\u8bf4 \u6709\u53ef\u80fd\u6709\u597d\u51e0\u79cd\u5bfb\u5740\u7684\u65b9\u5f0f \u5c31\u662f\u591a\u79cd \u6bb5\u5730\u5740\u548c\u504f\u79fb\u5730\u5740\u7684\u7ec4\u5408</p> <p>\u6bd4\u5982\u6bb5\u5730\u5740\u4e3a 0001H, \u90a3\u4e48\u4ec5\u4ec5\u901a\u8fc7\u53d8\u5316\u504f\u79fb\u5730\u5740 \u7684\u5bfb\u5740\u80fd\u529b,,, (\u504f\u79fb\u5730\u5740\u5bc4\u5b58\u5668\u662f16\u4f4d\u7684 ,\u6240\u4ee5\u4ed6\u7684\u53d6\u503c\u662f0~FFFFH) cpu\u7684\u5bfb\u5740\u8303\u56f4\u662f 10H ~ 0001H*10H+(0~FFFFH)</p> <p>\u6d4b\u8bd5\u9898 \u6709\u4e00\u4e2a\u6570\u636e\u5b58\u653e\u5728\u5185\u5b58 20000H\u5355\u5143\u4e2d, \u73b0\u5728\u7ed9 \u6bb5\u5730\u5740\u4e3asa \u82e5\u60f3\u7528\u504f\u79fb\u5730\u5740\u5bfb\u5740\u627e\u5230\u8be5\u5355\u5143,\u5219sa\u5e94\u8be5\u6ee1\u8db3\u7684\u6761\u4ef6\u662f \u6700\u5c0f1001H~\u6700\u59272000H 1000H+FFFFH=1FFFFH &lt;  20000H \u518d\u52a0\u4e0a\u4e00\u4e2a1 \u5c31\u53ef\u4ee5\u8fbe\u523020000H\u4e86</p> <p>d\u6307\u4ee4\u662f\u67e5\u770b\u5185\u5b58\u5730\u5740\u91cc\u9762\u5f00\u59cb\u5b58\u653e\u7684\u5b57\u8282\u5f53\u505a\u6570\u636e, \u6240\u4ee5\u4e0a\u9762\u7684d 2000:1F60 \u4f60\u770b\u523001 00 .. u\u6307\u4ee4 \u662f\u628a\u5185\u5b58\u5730\u5740\u5f00\u59cb\u7684\u5b57\u8282 \u5168\u90e8\u5f53\u4f5c\u6307\u4ee4 \u663e\u793a\u7ed9\u4f60\u770b</p>"},{"location":"cs/assembly/env/#cpu_2","title":"cpu\u662f\u5982\u4f55\u533a\u5206\u6307\u4ee4\u548c\u6570\u636e\u7684","text":"<p>\u5148\u505a\u4e2a\u6d4b\u8bd5 \u8f93\u5165 a  mov ax,1 r \u662f\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u8fd0\u884c\u7684\u6307\u4ee4\u7684 t \u67e5\u770b\u7ed3\u679c \u53d1\u73b0 ip\u5bc4\u5b58\u5668\u4e2d\u7684\u6570\u636e\u53d8\u5316\u4e86, \u6211\u4eec\u53ef\u4ee5\u8bf4 ip\u5bc4\u5b58\u5668\u548c\u6307\u4ee4\u6709\u5173</p> <p>\u518d\u6d4b\u8bd5 \u8f93\u5165 a r ds 0 \u6bb5\u5730\u5740\u4fee\u6539\u4e3a0 r  \u6ca1\u770b\u5230\u6307\u4ee4\u7684\u53d8\u5316 r es 0 r \u6765\u770b\u6307\u4ee4 r ss 0 r \u770b\u6307\u4ee4 \u53d1\u73b0\u524d\u9762\u4fee\u6539\u4e863\u4e2a\u6bb5\u5730\u5740\u7684\u503c, \u90fd\u6ca1\u6709\u53d1\u73b0\u6307\u4ee4\u7684\u53d8\u5316 r cs 0 r \u6307\u4ee4\u53d8\u5316\u4e86,</p> <p>\u7efc\u4e0a\u8bf4\u660e cs \u548cip \u5bc4\u5b58\u5668 \u4e0e\u6307\u4ee4\u6709\u5173</p> <p>8086cpu\u4e2d,\u5728\u4efb\u610f\u65f6\u523b,cpu\u5c06cs:ip \u6240\u6307\u5411\u7684 \u5185\u5bb9\u5f53\u6210\u6307\u4ee4\u6765\u6267\u884c</p> <p>\u518d\u6b21\u63d0\u9192,\u5728\u5185\u5b58\u4e2d \u6307\u4ee4\u548c\u6570\u636e \u662f\u6ca1\u6709\u533a\u522b\u7684,\u90fd\u662f\u4e8c\u8fdb\u5236\u4fe1\u606f, cpu\u53ea\u6709\u5728\u5de5\u4f5c\u7684\u65f6\u5019 \u624d\u5c06\u6709\u7684\u4fe1\u606f \u5f53\u4f5c\u6307\u4ee4,\u6709\u7684\u4fe1\u606f\u5f53\u4f5c\u6570\u636e,</p> <p>e 2000:0 \u7136\u540e\u4e00\u4e9b\u6570\u636e,\u6bd4\u5982b8,20,4e,05,16,14  \u7528u\u53ef\u4ee5\u770b\u5230 \u8fd9\u4e9b\u6570\u636e\u5bf9\u5e94\u7684\u6307\u4ee4 mov ax,4e20 add ax,1416</p> <p>\u5982\u679c\u6211\u4eec\u9700\u8981\u5c06\u6211\u4eec\u7684\u8f93\u5165 \u5f53\u6210\u6307\u4ee4\u6765\u8fd0\u884c\u7684\u8bdd, \u6211\u4eec\u53ef\u4ee5\u5c06cs\u548cip\u4e2d\u7684\u503c \u8bbe\u7f6e\u4e3a2000:0 (\u5148\u7528r\u67e5\u770bcs\u548cip\u5bf9\u5e94\u7684\u5730\u5740) \u7136\u540e\u6309t \u5c31\u53ef\u4ee5\u67e5\u770b\u5230\u6548\u679c\u4e86</p> <p>cpu\u4f1a\u4ececs\u6bb5\u5730\u5740\u5bc4\u5b58\u5668\u548cip\u504f\u79fb\u5730\u5740\u5bc4\u5b58\u5668 \u7ec4\u5408\u7684\u65f6\u5019,\u4ece\u4e2d\u8bfb\u53d6\u5185\u5bb9,\u5f53\u4f5c\u6307\u4ee4\u6765\u6267\u884c</p> <p>\u8fd92\u4e2a\u5bc4\u5b58\u5668\u51b3\u5b9a\u4e86cpu\u4ece\u54ea\u91cc\u83b7\u53d6\u6307\u4ee4,\u6240\u4ee5\u6211\u4eec\u4e00\u65e6\u4fee\u6539\u4e86\u8fd92\u4e2a\u5bc4\u5b58\u5668\u7684\u5730\u5740,\u7136\u540e \u4f60\u5728\u8be5\u5730\u5740\u4e0a\u5199\u4e0a\u6570\u636e, \u8fd9\u4e9b\u4e2a\u6570\u636e\u5c31\u4f1a\u88ab\u5f53\u4f5c\u6307\u4ee4\u6765\u6267\u884c\u4e86</p>"},{"location":"cs/assembly/env/#_18","title":"\u6307\u4ee4\u7684\u6267\u884c\u8fc7\u7a0b","text":"<p>\u6307\u4ee4\u662f\u6709\u957f\u5ea6\u7684,\u4e00\u6761\u6307\u4ee4\u53ef\u4ee5\u6709\u591a\u4e2a\u5b57\u8282\u6784\u6210</p> <p>\u6267\u884c\u8fc7\u7a0b 1. CPU\u4ececs:ip\u6240\u6307\u5411\u7684\u5185\u5b58\u5355\u5143\u8bfb\u53d6\u6307\u4ee4,\u5b58\u653e\u5230\u6307\u4ee4\u7f13\u51b2\u5668\u4e2d 2. \u8bbe\u7f6eip=ip+\u6307\u4ee4\u7684\u957f\u5ea6, \u4ece\u800c\u6307\u5411\u4e0b\u4e00\u6761\u6307\u4ee4 3. \u6307\u5411\u6307\u4ee4\u7f13\u51b2\u5668\u4e2d\u7684\u5185\u5bb9,\u56de\u5230\u6b65\u9aa41 \u518d\u6b21\u8bfb\u53d6\u65b0\u6307\u4ee4</p> <p></p> <p>\u5206\u6790\u4e00\u4e0b\u5177\u4f53\u6307\u4ee4\u7684\u6267\u884c\u8fc7\u7a0b \u5047\u8bbecs=2000 ip=0000 a 2000:0    cs =2000 ip=0   mov ax,6622   jmp 1000:3   mov cx,ax   \u56de\u8f66 \u6211\u4eec\u662f\u4e00\u6b21\u6027\u8f93\u5165\u6307\u4ee4 ,\u7136\u540e\u56de\u8f66\u7684, \u6307\u4ee4\u662f\u5df2\u7ecf\u5199\u5165\u5230\u5185\u5b58\u4e2d\u7684, (\u7406\u89e3\u4e3a,\u6307\u4ee4\u5199\u5165\u5230\u4e86 \u5f53\u524d\u6307\u4ee4\u5bc4\u5b58\u5668\u5c31\u662fcs\u548cip \u6240\u6307\u5411\u7684\u5730\u5740\u4f4d\u7f6e\u7684\u5185\u5b58\u4e2d) \u8bfb\u53d6\u6307\u4ee4mov ax,6622\u5230\u7f13\u51b2\u5668 \u7136\u540e cs=2000 ip=0+3 \u6267\u884c\u7f13\u51b2\u5668\u4e2d\u7684\u6307\u4ee4 \u8bfb\u53d6\u6307\u4ee4jmp 1000:0\u5230\u7f13\u51b2\u5668.. cs=2000 ip=3+5, \u6267\u884c\u6307\u4ee4 \u6267\u884c\u6307\u4ee4\u540e,\u8fd9\u4e2a\u65f6\u5019cs\u548cip\u90fd\u53d8\u4e86, \u524d\u9762\u7684\u6267\u884c\u8fc7\u7a0b\u6709\u8bf4\u7684\u5f88\u6e05\u695a\u4e86, \u6267\u884c\u5b8c\u6307\u4ee4\u540e,\u91cd\u590d\u6b65\u9aa41, \u662f\u4ececs:ip \u8bfb\u53d6\u6307\u4ee4\u7684,\u8fd9\u4e2a\u65f6\u5019\u518d\u6b21\u8bfb\u53d6\u7684\u5730\u65b9\u5c31\u4e0d\u662f\u539f\u6765\u7684\u4e86, \u6240\u4ee5mov cx,ax \u53ef\u4ee5\u8bf4\u6ca1\u6709\u6267\u884c\u4e86</p>"},{"location":"cs/assembly/env/#_19","title":"\u6c47\u7f16\u6307\u4ee4\u7b80\u5355\u4ecb\u7ecd","text":"<pre><code>MOV AH,40 #\u8868\u793a\u5c06\u6570\u5b5740 \u79fb\u52a8\u5230 \u4e00\u4e2a\u53ebAH\u7684\u5bc4\u5b58\u5668\nADD AX,8 # \u8868\u793a\u5c06ax+8 \u7684\u503c\u518d\u8d4b\u503c\u7ed9ax\n</code></pre> <ol> <li>jmp</li> </ol> <p>\u76f4\u63a5\u4fee\u6539\u5b58\u653e\u6307\u4ee4\u7684\u5bc4\u5b58\u5668\u7684\u5730\u5740</p> <p>8086cpu\u6ca1\u6709\u63d0\u4f9b mov cs,2000 \u8fd9\u6837\u6765\u4fee\u6539\u7684\u529f\u80fd,\u6709jmp <pre><code>a\njmp 2000:0\n\u56de\u8f66\nr\nt\n\u770b\u5230cs\u548cip \u5206\u522b\u53d8\u6210\u4e862000\u548c0000\n\nmov ax,2222\njmp ax    \u8868\u793a\u5c062222\u7ed9ip\u5bc4\u5b58\u5668\nr\nt \n\u770b\u5230ip\u5bc4\u5b58\u5668\u7684\u6570\u636e\u53d8\u6210\u4e862222 \n</code></pre></p> <ol> <li>call (\u4e0e\u51fd\u6570\u8c03\u7528\u7c7b\u4f3c) </li> </ol>"},{"location":"cs/assembly/env/#_20","title":"\u7ec3\u4e60\u9898","text":"<ol> <li>\u5b9e\u73b02\u76848\u6b21\u65b9</li> </ol> <pre><code>a 2000:0 #\u8fd8\u8981\u8bb0\u5f97\u4fee\u6539cs\u548cip\u6307\u5411\u8fd9\u91cc\nmov ax,1   \u8fd9\u91cc\u7684\u5730\u57402000:0\nadd ax,ax  \u8fd9\u91cc\u7684\u5730\u5740\u662f2000:3\njmp 2000:3 \u91cd\u65b0\u8fd0\u884c\u4e0a\u9762\u7684\u6307\u5411,\u7136\u540e\u4ed6\u8fd0\u884c\u5b8c\u540e\u53c8\u4f1a\u8d70\u8fd9\u6761\u6307\u4ee4\n\n\u5047\u8bbe\u4e0a\u9762\u7684\u5fd8\u8bb0\u4fee\u6539cs\u548cip\u4e86\n\u4e0a\u9762\u7684\u547d\u4ee4\u8f93\u5165\u5b8c\u6bd5\u540e,\n\u5148r \u770b\u4e0b\u5f53\u524d\u7684ip\u662f\u4ec0\u4e48,\n\u7136\u540e a cs:ip  \u8f93\u5165 jmp 2000:0 \u56de\u8f66 \u624d\u80fd\u4fee\u6539\n\u5426\u5219\u5982\u679c\u4f60\u4f4d\u7f6e\u641e\u4e0d\u5bf9\u4e86, \u65e0\u6cd5\u6267\u884c\u4f60\u8f93\u5165\u7684jmp\u547d\u4ee4\n\n\u8fbe\u5230\u4e86 \u81ea\u5df1+\u81ea\u5df1  \u6b21\u65b9\u7684\u76ee\u7684\n</code></pre> <ol> <li>\u5411\u7269\u7406\u5730\u5740\u4e3ab8100H \u5f00\u59cb\u7684\u5185\u5b58\u5355\u5143\u586b\u5199\u6570\u636e</li> </ol> <pre><code>e b810:0000 01 01 \u8bb0\u5f97\u60f3\u8d77\u6765 \u5185\u5b58\u7684\u8ba1\u7b97\u65b9\u5f0f\n  b800:0100 \u4e5f\u884c\n</code></pre> <ol> <li>\u67e5\u770b\u5185\u5b58\u4e2d\u7684\u5185\u5bb9    pc\u4e3b\u677f\u4e0a\u7684rom\u4e2d\u5199\u6709\u4e00\u4e2a\u751f\u4ea7\u65e5\u671f, \u5728\u5185\u5b58FFF00H-FFFFFH \u4e2d\u7684\u67d0\u51e0\u4e2a\u5355\u5143\u4e2d,, dosbox\u4e2d\u4e0d\u80fd\u4fee\u6539  \u56e0\u4e3a\u662from\u5185\u5b58</li> </ol>"},{"location":"cs/os/io/epoll/","title":"Epoll","text":""},{"location":"cs/os/io/epoll/#c10k","title":"C10K","text":"<p>C : client C10K \u5c31\u662f\u5355\u673a\u540c\u65f6\u5904\u74061\u4e07\u4e2a\u8bf7\u6c42(\u5e76\u53d1\u8fde\u63a51\u4e07) \u65e9\u671f\u670d\u52a1\u5668\u90fd\u662f\u57fa\u4e8e\u591a\u8fdb\u7a0b/\u591a\u7ebf\u7a0b\u6a21\u578b,\u65b0\u6765\u4e00\u4e2aTCP\u8fde\u63a5,\u5c31\u8981\u5206\u914d1\u4e2a\u8fdb\u7a0b(\u6216\u8005\u7ebf\u7a0b),\u800c\u521b\u5efa\u8fdb\u7a0b\u548c\u7ebf\u7a0b\u7684\u5f00\u9500\u90fd\u662f\u6bd4\u8f83\u5927\u7684.</p>"},{"location":"cs/os/io/epoll/#select","title":"select (\u53ef\u8de8\u5e73\u53f0)","text":""},{"location":"cs/os/io/epoll/#epoll","title":"epoll","text":""},{"location":"db/mysql/","title":"\u7d22\u5f15\u5e95\u5c42","text":"<p>Warning</p> <p>\u672a\u5b8c\u5f85\u7eed</p> <p>\u5565\u662f\u7d22\u5f15?</p> <p>\u4e00\u672c\u65b0\u534e\u5b57\u5178,\u5982\u679c\u6ca1\u6709\u524d\u9762\u7684\u76ee\u5f55,\u4f60\u67e5\u4e2a\u5b57 \u662f\u4e0d\u662f\u906d\u8001\u7f6a\u4e86! app\u4e0a\u9009\u62e9\u4f60\u7684\u57ce\u5e02\u65f6,\u5982\u679c\u6ca1\u6709\u53f3\u8fb9\u7684\u90a3\u4e2a\u6ed1\u52a8,\u662f\u4e0d\u662f\u4e5f\u633a\u9ebb\u70e6\u7684. \u8fd9\u4e9b\u8ba9\u4f60\u627e\u8d77\u6765\u65b9\u4fbf\u7684\u4e1c\u897f\u5c31\u662f\u7d22\u5f15. mysql \u6570\u636e\u5e93\u540c\u6837\u5982\u6b64,\u90fd\u662f\u5728\u4e00\u5806\u6570\u636e\u91cc\u627e\u4f60\u8981\u7684\u4e1c\u897f.</p>","tags":["mysql"]},{"location":"db/mysql/#_1","title":"\u5e95\u5c42\u6570\u636e\u7ed3\u6784","text":"","tags":["mysql"]},{"location":"db/mysql/#red-black-trees","title":"\u7ea2\u9ed1\u6811 Red-Black Trees","text":"<p>\u8bf4\u660e</p> <p>\u7ea2\u9ed1\u6811\u89e3\u51b3\u4e86\u4e8c\u53c9\u6811\u63d2\u5165\u6709\u5e8f\u6570\u636e\u5bfc\u81f4\u6240\u6709\u7684\u8282\u70b9\u90fd\u4f1a\u5728\u6839\u8282\u70b9\u7684\u53f3\u4fa7\u6216\u5de6\u4fa7,\u53d8\u6210\u4e86\u94fe\u8868\u7684\u95ee\u9898, \u63d2\u5165\u4e00\u6761\u6570\u636e\u540e,\u4f1a\u81ea\u52a8\u8c03\u6574  \u90a3\u4e48\u80fd\u4e0d\u80fd\u7528\u8fd9\u4e2a\u7ed3\u6784\u6765\u5b58\u50a8mysql\u6570\u636e\u5462? </p> <p>n\u5c42\u7684\u8bdd, \u603b\u5171\u80fd\u653e total = 2\u2070 + 2\u00b9 +2\u00b2 +...  2\u207f\u207b\u00b9  2total =  2\u00b9 +2\u00b2 +...  2\u207f = 2\u2070 + 2\u00b9 +2\u00b2 +...  2\u207f\u207b\u00b9+ 2\u207f - 2\u2070    = total + 2\u207f - 2\u2070  2total = total + 2\u207f - 2\u2070  \u7ed3\u679c: total = 2\u207f-1</p>","tags":["mysql"]},{"location":"db/mysql/backup-recovery/","title":"\u5907\u4efd\u4e0e\u6062\u590d","text":""},{"location":"db/mysql/backup-recovery/#csv","title":"\u5bfc\u51facsv,\u5e26\u5b57\u6bb5\u540d","text":"<pre><code># \u9ed8\u8ba4\u5bfc\u51fa\u6ca1\u6709\u6807\u9898. \u6240\u4ee5\u7528union \u6765\u5b8c\u6210\u6548\u679c\nmysql -uroot -proot test -e \"select 'a','b','c'\nfrom dual union select a,b,c from test  into outfile '/tmp/x.csv' CHARACTER SET gbk fields terminated by ',' optionally enclosed by '\\\"' lines terminated by '\\r\\n'; \"\n</code></pre> <p>Tip</p> <p>optionally enclosed by '\\\"'  \u8fd9\u6837  \u5b57\u6bb5\u5185\u5bb9\u6709, \u53f7\u7684 \u5c31\u4e0d\u4f1a\u88ab\u5206\u62102\u4e2a\u4e86. secure_file_priv=/tmp/    \u8fd9\u4e2a\u53c2\u6570\u5f71\u54cd \u5bfc\u51fa\u6587\u4ef6\u7684\u4f4d\u7f6e,\u4ee5\u53ca\u662f\u5426\u53ef\u5bfc\u51fa \u5982\u679c \u4e0a\u9762\u7684\u53c2\u6570\u4e3a\u7a7a, \u53bb /tmp/xxxxx-mariadb/tmp \u770b\u770b</p>"},{"location":"db/mysql/backup-recovery/#_1","title":"\u67e5\u770b\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4f4d\u7f6e","text":"<pre><code>mysql --help|grep 'my.cnf'\n</code></pre>"},{"location":"db/mysql/backup-recovery/#_2","title":"\u5907\u4efd","text":""},{"location":"db/mysql/backup-recovery/#-compact","title":"--compact\u6d4b\u8bd5\u5bfc\u51fa\u7ed3\u679c","text":"<pre><code># --compact\nmysqldump -uroot -p12345 --compact -B dbname\n</code></pre>"},{"location":"db/mysql/backup-recovery/#_3","title":"\u5f00\u53d1\u5e38\u7528\u7684\u547d\u4ee4","text":"<pre><code># \u5bfc\u51fa \u9700\u8981\u7684\u5e93\u4e0e\u8868\u7684\u521b\u5efa\u8bed\u53e5 ,\u6240\u4ee5\u6211\u4eec\u4e00\u822c\u4e0d\u7528-A\n# \u5305\u542bevent \u5b58\u50a8\u8fc7\u7a0b\u7b49\nmysqldump -uroot -p123456 -B -d --triggers -R -E  db1 db2&gt; db_struct.sql\n\n# \u5bfc\u51fa\u9700\u8981\u521d\u59cb\u5316\u7684\u8868\u6570\u636e\n# \u542b\u6709 db\u7684create \u548cuse \u8bed\u53e5\u7684\nmysqldump -uroot -p12345 -B --hex-blob -t mysql db1 db2&gt; dbdata.sql\nmysqldump -uroot -p12345 --hex-blob -t dbname table1 table2  &gt; sometable.sql\n\n# \u5148\u5bfc\u5165mysql\nmysql -uroot -p123456 &lt; db_struct.sql\nmysql -uroot -p123456 &lt; dbdata.sql\n\nmysql -uroot -p123456 dbname &lt; sometable.sql\n</code></pre>"},{"location":"db/mysql/backup-recovery/#_4","title":"\u751f\u4ea7\u73af\u5883\u547d\u4ee4","text":"<pre><code># -E --events\n# -R --routines\n# -F --flush-logs\nmysqldump -uroot -p123456 -A --flush-privileges --single-transaction --master-data=1(\u6216\u80052) -F --triggers -R -E --hex-blob |gzip &gt;xx.sql.gz\n</code></pre>"},{"location":"db/mysql/backup-recovery/#_5","title":"\u5907\u4efd\u5355\u4e2a\u4e0e\u591a\u4e2a\u6570\u636e\u5e93","text":"<p><pre><code>\u9ed8\u8ba4\u662f\u5bfc\u51fa\u8868\u521b\u5efa\u8bed\u53e5\u548c\u6570\u636e\u7684\n</code></pre> <pre><code># -B  \u4f1a\u6709create db \u8bed\u53e5,\u548c use db \u8bed\u53e5. \u8fd9\u6837\u5bfc\u5165\u65f6\u4e0d\u9700\u8981\u6307\u5b9a \u6570\u636e\u5e93\nmysqldump -uroot -p12345  -B dbname mysqldump -uroot -p12345  -B dbname  dbname2\n</code></pre></p>"},{"location":"db/mysql/backup-recovery/#_6","title":"\u5907\u4efd\u5355\u8868\u548c\u591a\u4e2a\u8868","text":"<pre><code>mysqldump -uroot -p12345 dbname school &gt; school.sql\nmysqldump -uroot -p12345 dbname city school &gt; city_school.sql\n</code></pre>"},{"location":"db/mysql/backup-recovery/#_7","title":"\u53ea\u5bfc\u51fa\u8868\u7ed3\u6784","text":"<pre><code># \u4e00\u4e2a\u5e93 (\u5305\u542b\u5e93\u521b\u5efa\u8bed\u53e5\u548c\u6240\u6709\u8868\u7684\u521b\u5efa\u8bed\u53e5)\nmysqldump -uroot -p12345 -B -d dbname &gt; dbname.sql\n\n# \u591a\u4e2a\u8868\u7684\u521b\u5efa\u8bed\u53e5\nmysqldump -uroot -p12345 -d dbname table1 table2 &gt; dbname.sql\n</code></pre>"},{"location":"db/mysql/backup-recovery/#_8","title":"\u53ea\u5bfc\u51fa\u6570\u636e","text":"<pre><code>mysqldump -uroot -p12345 -t dbname &gt; dbname.sql\nmysqldump -uroot -p12345 -t dbname table1 table2 &gt; dbname.sql\n</code></pre>"},{"location":"db/mysql/binlog/","title":"\u4e8c\u8fdb\u5236\u65e5\u5fd7","text":""},{"location":"db/mysql/binlog/#_1","title":"\u914d\u7f6e","text":"my.cnf<pre><code>server-id               = 1\nlog_bin                 = mysql-bin\n</code></pre> <p>\u67e5\u770b\u53d8\u91cf<pre><code>+-----------------------------------------+---------------------+\n| Variable_name               | Value                           |\n+-----------------------------------------+---------------------+\n| log_bin                     | ON                              |  -- \u662f\u5426\u5f00\u542f\n| log_bin_basename            | /var/lib/mysql/mysql-bin        |\n| log_bin_index               | /var/lib/mysql/mysql-bin.index  |\n| max_binlog_size             | 104857600                       |  -- binlog\u6587\u4ef6\u7684\u6700\u5927\u503c,\u8fbe\u5230\u6700\u5927\u503c,\u5219\u91cd\u65b0\u751f\u6210\u4e00\u4e2a\u65b0\u7684\n| binlog_format               | ROW                             |  -- \u6709\u4e09\u79cd statement(\u8bb0\u5f55sql\u8bed\u53e5), row(\u6bcf\u4e00\u884c\u6570\u636e) , mixed\n+-----------------------------------------+---------------------+\n</code></pre> <pre><code>show master status;\n</code></pre></p> <p>\u7ed3\u679c<pre><code>+------------------+----------+\n| File             | Position |\n+------------------+----------+\n| mysql-bin.000001 |      154 |\n+------------------+----------+\n</code></pre> \u6211\u4eec\u53d1\u73b0 mysql-bin.000001\u7684\u6587\u4ef6\u5927\u5c0f \u5b57\u8282\u6570 \u5c31\u662f \u4e0a\u9762\u7684position <pre><code>ll mysql-bin*\n-rw-r----- 1 mysql mysql 154 Sep  3 14:36 mysql-bin.000001\n-rw-r----- 1 mysql mysql  19 Sep  3 14:36 mysql-bin.index\n</code></pre></p> <ul> <li> <p>\u67e5\u770bbinlog\u66f4\u5177\u4f53\u7684\u5185\u5bb9 <pre><code>show binlog events in 'mysql-bin.000001'\\G\n</code></pre> \u7ed3\u679c<pre><code>*************************** 1. row ***************************\n   Log_name: mysql-bin.000001\n        Pos: 4\n Event_type: Format_desc\n  Server_id: 1\nEnd_log_pos: 123\n       Info: Server ver: 5.7.17-0ubuntu0.16.04.1-log, Binlog ver: 4\n*************************** 2. row ***************************\n   Log_name: mysql-bin.000001\n        Pos: 123\n Event_type: Previous_gtids\n  Server_id: 1\nEnd_log_pos: 154\n       Info:\n</code></pre></p> </li> <li> <p>\u5237\u65b0\u65e5\u5fd7,\u4f1a\u91cd\u65b0\u751f\u6210\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6 <pre><code>flush binary logs;\nshow master status;\n+------------------+----------+\n| File             | Position |\n+------------------+----------+\n| mysql-bin.000002 |      154 |\n+------------------+----------+\n</code></pre></p> </li> </ul>"},{"location":"db/mysql/binlog/#binlog_format","title":"binlog_format","text":"format description statement \u8bb0\u5f55\u64cd\u4f5c\u7684sql\u6587  \u4e0d\u652f\u6301\u4e0d\u786e\u5b9a\u7684sql\u8bed\u53e5,<code>\u6bd4\u5982update ....  limit 3</code> row \u8bb0\u5f55\u64cd\u4f5c\u7684\u6bcf\u4e00\u884c\u6570\u636e,\u6bcf\u5f20\u8868\u4e00\u5b9a\u8981\u6709\u4e3b\u952e mixed"},{"location":"db/mysql/binlog/#binlogsql","title":"\u67e5\u770bbinlog\u6587\u4ef6\u91cc\u7684sql\u8bed\u53e5","text":"<p><pre><code>#\u8fd9\u4e2a\u53ef\u4ee5\u770b\u5230\u5177\u4f53\u7684sql\u6587\u4ef6\nmysqlbinlog mysql-bin.000001 -vv\n#-----------------------------------------------------\n### INSERT INTO `test`.`mm`\n### SET\n###   @1=5 /* INT meta=0 nullable=0 is_null=0 */\n###   @2=5 /* INT meta=0 nullable=1 is_null=0 */\n#-----------------------------------------------------\n@1 \u8868\u793a\u7b2c\u4e00\u5217\n@2 \u8868\u793a\u7b2c\u4e8c\u5217\n</code></pre> <pre><code>mysqlbinlog mysql-bin.000001 --base64-output=decode-row -v\n</code></pre></p> <pre><code>help show binlog events;\n</code></pre>"},{"location":"db/mysql/env/","title":"\u73af\u5883\u51c6\u5907","text":""},{"location":"db/mysql/env/#mysql","title":"\u514d\u5bc6\u767b\u5f55mysql","text":"<pre><code># \u6211\u4eec\u5728my.cnf \u5176\u5b9e\u662f\u53ef\u4ee5\u914d\u7f6e\u7684,\u4f46\u662f\u660e\u6587,\u4e0d\u597d\n# mysql\u63d0\u4f9b\u4e86\u4e00\u4e2a\u547d\u4ee4,\u8bbe\u7f6e\u4e00\u4e2a\u6807\u7b7emy (\u540d\u5b57\u968f\u4fbf\u8d77)\u6765\u767b\u5f55\n# \u8fd9\u4e2a\u547d\u4ee4\u5b9e\u9645\u4e0a\u751f\u6210\u4e86\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6,\u8def\u5f84\u662f ~/.mylogin.cnf\n# -G my \u540e\u9762\u662f\u4f60\u7684\u8fde\u63a5\u53c2\u6570, \u9700\u8981\u4ec0\u4e48\u5c31\u52a0\u4ec0\u4e48, \u6bd4\u5982 -h -P\nmysql_config_editor set -G my -uroot -p\nEnter password:   \u8fd9\u91cc\u4f60\u8f93\u5165\u5bc6\u7801\n# \u7136\u540e\u6211\u4eec\u6253\u5370\u4e00\u4e0b\nmysql_config_editor print --all\n# \u663e\u793a\u7684\u5bc6\u7801\u4e0d\u662f\u660e\u6587\n[my]\nuser = root\n  password = *****\n# \u4f7f\u7528\u8be5\u6807\u7b7e\u767b\u5f55\nmysql --login-path=my\n</code></pre>"},{"location":"db/mysql/optimization/","title":"SQL\u4f18\u5316","text":""},{"location":"db/mysql/optimization/#_1","title":"\u7cfb\u7edf\u9ed8\u8ba4\u7684\u4f18\u5316","text":""},{"location":"db/mysql/optimization/#join","title":"join \u4f18\u5316(\u6ca1\u5199\u5b8c... )","text":"<p>\u4ec0\u4e48\u662f\u9a71\u52a8\u8868</p> <p>\u5728join\u8fde\u8868\u67e5\u8be2\u65f6,\u7528\u6765\u6700\u5148\u83b7\u5f97\u6570\u636e\uff0c\u5e76\u4ee5\u6b64\u8868\u7684\u6570\u636e\u4e3a\u4f9d\u636e\uff0c\u9010\u6b65\u83b7\u5f97\u5176\u4ed6\u8868\u7684\u6570\u636e\uff0c\u76f4\u81f3\u6700\u7ec8\u67e5\u8be2\u5230\u6240\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u7684\u7b2c\u4e00\u4e2a\u8868</p> <p>2\u4e2a\u8868 id\u4e3b\u952e<pre><code>select * from a;\n+----+------+------+\n| id | name | age  |\n+----+------+------+\n|  1 | tom  |   20 |\n|  2 | jack |   22 |\n+----+------+------+\n\nselect * from b;\n+----+--------+\n| id | class  |\n+----+--------+\n|  1 | class1 |\n|  2 | class2 |\n|  3 | class3 |\n+----+--------+\n</code></pre> <pre><code>-- \u8fde\u8868\u67e5\u8be2\nselect * from a,b where a.id=b.id\n</code></pre></p> <p>Note</p> <p>\u8fd9\u5c31\u597d\u6bd4\u6765\u4e862\u4e2a\u4eba,\u53bb\u4f60\u4e0a\u5b66\u7684\u73ed\u7ea7\u91cc\u627e\u548c\u4ed6\u4eec\u540c\u540d\u7684\u540c\u5b66. \u4f60\u603b\u4e0d\u81f3\u4e8e\u7528\u4f60\u73ed\u7ea7\u7684\u4eba\u7684\u540d\u5b57\u4e00\u4e2a\u4e00\u4e2a\u53bb\u548c\u8fd92\u4e2a\u4eba\u5bf9\u6bd4\u5427? \u76f4\u63a5\u75282\u4e2a\u4eba\u7684\u540d\u5b57 \u4ece\u4f60\u73ed\u7ea7\u91cc\u627e\u5c31\u662f\u4e86.\u53ea\u9700\u89812\u6b21</p> <pre><code>for each row in \u9a71\u52a8\u8868 do\n    lookup \u9a71\u52a8\u8868\u7684each row\u7684\u7d22\u5f15 in  \u5185\u8868 index\n        if \u5982\u679c\u5728\u5185\u8868\u91cc\u627e\u5230\u4e86\u8be5\u7d22\u5f15\n</code></pre> <pre><code>+----+-------------+-------+---------------+------+----------+----------------------------------------------------+\n| id | select_type | table | possible_keys | rows | filtered | Extra                                              |\n+----+-------------+-------+---------------+------+----------+----------------------------------------------------+\n|  1 | SIMPLE      | a     | PRIMARY       |    2 |   100.00 | NULL                                               |\n|  1 | SIMPLE      | b     | PRIMARY       |    3 |    33.33 | Using where; Using join buffer (Block Nested Loop) |\n+----+-------------+-------+---------------+------+----------+----------------------------------------------------+\n</code></pre>"},{"location":"db/mysql/optimization/#sql","title":"SQL\u7f16\u5199\u4f18\u5316","text":""},{"location":"db/mysql/optimization/#_2","title":"\u6700\u5de6\u524d\u7f00\u6cd5\u5219","text":""},{"location":"db/mysql/optimization/#_3","title":"\u4e0d\u5728\u7d22\u5f15\u5217\u4e0a\u505a\u4efb\u4f55\u64cd\u4f5c","text":""},{"location":"db/mysql/optimization/#orinunion","title":"\u5c11\u7528or\u6216in,\u4f7f\u7528union","text":""},{"location":"db/mysql/optimization/#_4","title":"\u5b57\u7b26\u4e32\u8981\u52a0\u5355\u5f15\u53f7","text":""},{"location":"db/mysql/optimization/#null","title":"!= \u548c null \u5224\u65ad \u90fd\u4f1a\u4f7f\u7d22\u5f15\u5931\u6548","text":""},{"location":"db/mysql/optimization/#order-by","title":"order by \u4f18\u5316","text":""},{"location":"db/mysql/optimization/#_5","title":"\u5206\u9875\u67e5\u8be2\u4f18\u5316","text":""},{"location":"db/mysql/optimization/#in-exists","title":"in &amp; exists","text":""},{"location":"db/mysql/sql/","title":"SQL\u8bed\u53e5","text":"<p>Note</p> <p>sql\u8bed\u53e5\u540e\u9762\u90fd\u53ef\u4ee5\u52a0\u4e0a\\G (;\u5206\u53f7\u524d\u9762),\u8fd9\u6837\u4f1a\u663e\u793a\u4e00\u884c\u4e00\u884c,\u800c\u4e0d\u662f\u8868\u683c.</p>"},{"location":"db/mysql/sql/#_1","title":"\u5e38\u7528\u51fd\u6570","text":"<pre><code>-- \u83b7\u53d6\u4e00\u4e2auuid\nselect uuid();\n-- \u5f53\u524d\u65f6\u95f4\nselect now();\n</code></pre>"},{"location":"db/mysql/sql/#_2","title":"\u5b57\u7b26\u4e32\u5904\u7406","text":""},{"location":"db/mysql/sql/#mysql","title":"mysql \u914d\u7f6e\u76f8\u5173","text":""},{"location":"db/mysql/sql/#mysql_1","title":"\u67e5\u770bmysql\u76f8\u5173\u4fe1\u606f","text":"<p><pre><code>-- \u8fdb\u5165mysql\u63a7\u5236\u53f0\u540e (mysql -uroot .. \u547d\u4ee4\u8fde\u63a5\u540e\u7684\u754c\u9762) \u8f93\u5165 \\s \u540e\u56de\u8f66\n\\s\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>--------------\nmysql  Ver 5.7.41-0ubuntu0.20.04.2 for Linux on x86_64 ((Ubuntu))\n\nConnection id:      3\nCurrent database:   test\nCurrent pager:      stdout\nUsing outfile:      ''\nUsing delimiter:    ;\nServer version:     5.7.41 MySQL Community Server (GPL)\nProtocol version:   10\nConnection:     192.168.1.100 via TCP/IP\nServer characterset:    latin1\nDb     characterset:    latin1\nClient characterset:    latin1\nConn.  characterset:    latin1\nTCP port:       3306\nBinary data as:     Hexadecimal\nUptime:         43 min 23 sec\n--------------\n</code></pre></p>"},{"location":"db/mysql/sql/#_3","title":"\u67e5\u770b\u4f1a\u8bdd\u4e0e\u5168\u5c40\u53d8\u91cf","text":"<pre><code>-- \u8fdb\u5165mysql\u540e \u67e5\u770b\u4f1a\u8bdd\u53d8\u91cf\nselect @@autocommit;\n-- \u67e5\u770b\u5168\u5c40\nselect @@global.autocommit;\n-- \u6211\u4eec\u5e73\u5e38\u8bbe\u7f6e\u53d8\u91cf ,\u4e0b\u9762\u7684\u53ea\u5bf9\u5f53\u524d\u4f1a\u8bdd\u6709\u6548\n-- \u5176\u5b9e\u662f\u7701\u7565\u4e86set session autocommit=1; \u4e2d\u7684session\nset autocommit=1;\n-- \u8fd9\u6837\u8bbe\u7f6e\u540e,\u6211\u4eec\u67e5\u770bselect @@autocommit \u53d1\u73b0\u8fd8\u662f1,\n-- global\u53ea\u5bf9\u4ee5\u540e\u7684\u4f1a\u8bdd\u6709\u6548,\u5bf9\u5f53\u524d\u65e0\u6548,\u5f53\u524d\u7684\u8fd8\u662f\u4fdd\u6301\u539f\u6765\u7684\nset global autocommit=0;\n-- \u6a21\u7cca\u67e5\u770b\u53d8\u91cf\nshow variables like \"%log%\";\n</code></pre>"},{"location":"db/mysql/sql/#_4","title":"\u67e5\u770b\u5b57\u7b26\u96c6","text":"<p><pre><code>show character set like '%utf%';\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>+---------+------------------+--------------------+--------+\n| Charset | Description      | Default collation  | Maxlen |\n+---------+------------------+--------------------+--------+\n| utf8    | UTF-8 Unicode    | utf8_general_ci    |      3 |\n| utf8mb4 | UTF-8 Unicode    | utf8mb4_general_ci |      4 |\n| utf16   | UTF-16 Unicode   | utf16_general_ci   |      4 |\n| utf16le | UTF-16LE Unicode | utf16le_general_ci |      4 |\n| utf32   | UTF-32 Unicode   | utf32_general_ci   |      4 |\n+---------+------------------+--------------------+--------+\n</code></pre></p>"},{"location":"db/mysql/sql/#_5","title":"\u9694\u79bb\u7ea7\u522b","text":"<pre><code>show variables like '%tx%';\n</code></pre>"},{"location":"db/mysql/sql/#_6","title":"\u6743\u9650\u8bbe\u7f6e","text":"<pre><code>-- \u89d2\u8272,mysql\u4e2d\u6ca1\u6709\u89d2\u8272,\u7528\u7684\u4e00\u79cd\u53eb\u4ee3\u7406\u7684\u65b9\u5f0f  \u8fd9\u4e2a\u53ea\u67095.7\u652f\u6301\n-- \u5b98\u65b9\u53eb role like \u673a\u5236\nshow grants;\ncreate user 'dba'@'127.0.0.1';\ncreate user 'xyz'@'::1';\ngrant proxy on 'dba'@'127.0.0.1' to 'xyz'@'::1';\ngrant select on mysql.* to 'dba'@'127.0.0.1';\n-- \u67e5\u770b\u8be5\u7528\u6237\u7684\u6743\u9650\nshow grants for 'dba'@'127.0.0.1';\n-- \u53ef\u4ee5\u67e5\u770b\u5230\nselect * from mysql.proxies_priv; </code></pre>"},{"location":"db/mysql/sql/#database","title":"database","text":"<pre><code>-- mysql\u4e2ddatabase\u4e0eschema \u662f\u4e00\u6a21\u4e00\u6837\u7684.\n-- \u5176\u4ed6\u6570\u636e\u5e93\u53ef\u80fd\u662f\u4e00\u4e2adatabase\u6709\u591a\u4e2aschema.\n-- mysql\u4f30\u8ba1\u662f\u4e3a\u4e86\u548c\u5176\u4ed6\u6570\u636e\u5e93\u4fdd\u6301\u4e00\u81f4,\u597d\u7406\u89e3\u6240\u4ee5\u6709\u4e86schema\n-- \u4e0b\u97622\u4e2a\u64cd\u4f5c\u7ed3\u679c\u4e00\u6837\nshow databases;\nshow schemas;\n-- \u9009\u62e9database,\u8fdb\u884c\u67e5\u8be2\u65f6,\u9700\u8981\u5148\u9009\u62e9\u4f60\u7684db\nuse database_name;\n-- \u6bcf\u4e00\u4e2a\u6570\u636e\u5e93\u5bf9\u5e94data dir\u76ee\u5f55\u91cc\u7684\u662f\u4e00\u4e2a\u6587\u4ef6\u5939.\u4f46\u662finformation_schema \u4e0d\u5728\u91cc\u9762\nuse information_schema;\n-- \u6211\u4eec\u53d1\u73b0\u8fd9\u4e9b\u4e2a\u8868\u7684\u5f15\u64ce\u90fd\u662fmemory,\u6240\u4ee5..\u6ca1\u6709\nshow table status; </code></pre>"},{"location":"db/mysql/sql/#table","title":"table","text":""},{"location":"db/mysql/sql/#_7","title":"\u67e5\u770b\u521b\u5efa\u4fe1\u606f","text":"<pre><code>-- \u67e5\u770b\u5f53\u524ddb\u4e0b\u7684\u6240\u6709\u8868\u4fe1\u606f\nshow table status;\n-- \u67d0\u4e2a\u8868\u7684\u4e00\u4e9b\u4fe1\u606f\nshow table status like 'table_name';\n-- \u663e\u793a\u521b\u5efa\u8868\u7684\u8bed\u53e5\nshow create table table_name;\n</code></pre>"},{"location":"db/mysql/sql/#_8","title":"\u7d22\u5f15","text":"<pre><code>-- \u5220\u9664\u4e3b\u952e\nalter table table_name drop primary key;\n-- \u5220\u9664\u4e00\u822c\u7d22\u5f15\nalter table table_name drop index index_name;\n</code></pre>"},{"location":"db/mysql/sql/#_9","title":"\u4e34\u65f6\u8868","text":"<p>\u6ce8\u610f</p> <ol> <li>\u521b\u5efa\u7684\u4e34\u65f6\u8868\u662f\u57fa\u4e8e\u4f1a\u8bdd\u7684,\u4f60\u53e6\u5916\u5f00\u4e00\u4e2a\u4f1a\u8bdd,\u4f60\u770b\u4e0d\u5230\u4f60\u521b\u5efa\u7684\u4e34\u65f6\u8868</li> <li>\u4e34\u65f6\u8868\u53ef\u4ee5\u4e0e\u5b9e\u4f53\u8868\u91cd\u540d</li> <li>\u5728\u6709\u91cd\u540d\u7684\u60c5\u51b5\u4e0b, \u4f60<code>select * from a</code>\u5b9e\u9645\u67e5\u8be2\u7684\u662f\u4e34\u65f6\u8868,\u800c\u4e0d\u662f\u5b9e\u4f53\u8868</li> </ol> <ul> <li>\u521b\u5efa\u4e34\u65f6\u8868 <pre><code>create temporary table  tmp_a (id int);\n</code></pre></li> <li>\u67e5\u770b\u4e34\u65f6\u8868\u7684\u9ed8\u8ba4\u5b58\u50a8\u5f15\u64ce <pre><code>show variables like '%default_tmp%';\n</code></pre> \u7ed3\u679c<pre><code>+----------------------------+--------+\n| Variable_name              | Value  |\n+----------------------------+--------+\n| default_tmp_storage_engine | InnoDB |\n+----------------------------+--------+\n</code></pre></li> <li> <p>\u67e5\u770b \u4e34\u65f6\u8868\u7684\u72b6\u6001 <pre><code>-- \u53ef\u4ee5\u770b\u5230\u7cfb\u7edf\u91cc\u6709\u521b\u5efa\u4e86\u591a\u5c11\u4e2a\u4e34\u65f6\u8868\nshow global status like '%tmp_tables%';\n-- \u5f53\u524d\u4f1a\u8bdd\u91cc\u7684\u60c5\u51b5\nshow status like '%tmp_tables%';\n</code></pre> \u7ed3\u679c<pre><code>+--------------------+-------+\n| Variable_name      | Value |\n+--------------------+-------+\n| Created_tmp_tables | 6     |\n+--------------------+-------+\n</code></pre></p> </li> <li> <p>\u8868\u7ed3\u6784\u5b58\u653e\u76ee\u5f55 <pre><code>show variables like 'tmpdir';\n</code></pre> <pre><code>-- \u5982\u679c\u4f60\u662f\u5728mysql\u6240\u5728\u670d\u52a1\u5668 \u7528\u7684mysql\u547d\u4ee4\u8fde\u63a5\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u67e5\u770b\n-- \u53ef\u4ee5\u770b\u5230.frm\u7684\u6587\u4ef6\n-- \u9000\u51fa\u5f53\u524dmysql \u4f1a\u8bdd, \u8fd9\u4e2a\u8868\u7a7a\u95f4\u6587\u4ef6\u4f1a\u5220\u9664\u7684.\nsystem ls /tmp\n</code></pre> \u4e34\u65f6\u8868\u8868\u7ed3\u6784\u6587\u4ef6\u547d\u540d\u65b9\u5f0f<pre><code>\u4e34\u65f6\u8868\u7684\u8868\u7ed3\u6784\u6587\u4ef6.frm \u547d\u540d\u65b9\u5f0f\u662f #sql{\u8fdb\u7a0bid}_{\u7ebf\u7a0bid}_\u5e8f\u5217\u53f7&lt;br&gt;\n\u7ebf\u7a0bid \u901a\u8fc7 `show processlist` \u7684ID\u5217\u83b7\u5f97.\n</code></pre></p> </li> <li> <p>\u8868\u7a7a\u95f4\u7684\u5b58\u653e\u76ee\u5f55 <pre><code>show variables like \"%data%\";\n</code></pre> \u8fd9\u91cc\u663e\u793a\u51e0\u4e2a\u6211\u4eec\u5173\u5fc3\u7684<pre><code>+---------------------------------------+------------------------+\n| Variable_name                         | Value                  |\n+---------------------------------------+------------------------+\n| datadir                               | /var/lib/mysql/        |\n| innodb_data_file_path                 | ibdata1:12M:autoextend |\n| innodb_data_home_dir                  |                        |\n| innodb_temp_data_file_path            | ibtmp1:12M:autoextend  |\n+---------------------------------------+------------------------+\n\n1. \u521b\u5efa\u7684\u6587\u4ef6\u540d\u662f ibtmp1,\u653e\u5728 innodb_data_home_dir \u76ee\u5f55\u4e0b\n2. \u5982\u679c innodb_data_home_dir \u662f\u7a7a\u7684, \u5c31\u653e\u5230datadir \u4e0b\n</code></pre> <pre><code>-- \u53ef\u4ee5\u770b\u5230\nsystem ls /var/lib/mysql/ibtmp1\n</code></pre></p> </li> </ul>"},{"location":"db/mysql/sql/#_10","title":"\u589e","text":""},{"location":"db/mysql/sql/#_11","title":"\u5220","text":""},{"location":"db/mysql/sql/#_12","title":"\u6539","text":""},{"location":"db/mysql/sql/#_13","title":"\u67e5","text":""},{"location":"db/mysql/sql/#null","title":"null","text":"<p>\u6ce8\u610f</p> <ol> <li>\u4efb\u4f55\u503c\u4e0enull\u8fdb\u884c=\u6bd4\u8f83,\u5f97\u5230\u7684\u90fd\u662fnull</li> <li>\u7528is \u6765\u5224\u65ad</li> </ol> <pre><code>select null=1;\nselect 1=null;\nselect null in (1,null);\n</code></pre>"},{"location":"db/redis/architecture/","title":"\u67b6\u6784\u8bbe\u8ba1","text":""},{"location":"db/redis/architecture/#_1","title":"\u7b80\u5355\u4e3b\u4ece","text":""},{"location":"db/redis/architecture/#_2","title":"\u54e8\u5175","text":""},{"location":"db/redis/architecture/#_3","title":"\u96c6\u7fa4","text":""},{"location":"db/redis/data-type/","title":"\u6570\u636e\u7c7b\u578b","text":"<p>Warning</p> <p>\u672a\u5b8c\u5f85\u7eed</p>","tags":["redis"]},{"location":"db/redis/data-type/#5","title":"5\u5927\u57fa\u672c\u7c7b\u578b","text":"","tags":["redis"]},{"location":"db/redis/data-type/#strings","title":"strings","text":"","tags":["redis"]},{"location":"db/redis/data-type/#_1","title":"\u57fa\u672c\u547d\u4ee4","text":"\u589e\u6539\u67e5\u81ea\u589e\u51cf\u5220\u9664 <pre><code>set age 20 # \u4e0d\u7ba1\u8fd9\u4e2akey \u5b58\u4e0d\u5b58\u5728\u90fd\u8bbe\u7f6e\n# SETNX = SET if Not eXists, \u4e0d\u5b58\u5728\u624d\u8bbe\u7f6e\n# \u73b0\u5728\u7528 set key value NX \u6765\u66ff\u4ee3\nset age 30 nx # \u4e0d\u5b58\u5728\u624d\u8bbe\u7f6e,\u76f8\u5f53\u4e8e\u521b\u5efa\nset age 34 xx # age\u5b58\u5728\u624d\u8bbe\u7f6e,\u76f8\u5f53\u4e8e\u66f4\u65b0\nget age # \u67e5\u770bkey,\u4e0d\u5b58\u5728\u8fd4\u56denil\n# SET key value EX seconds\n# ex expire , \u8bbe\u7f6ekey 5\u79d2\u540e\u8fc7\u671f, \u4f1a\u5220\u9664\nset age 10 EX 5\n# MSET key value [key value ...]\n# n\u6b21get\u547d\u4ee4,\u9700\u8981n\u6b21\u7f51\u7edc\u65f6\u95f4,\u548cn\u6b21\u547d\u4ee4\u65f6\u95f4\n# mget \u53ea\u9700\u8981\u4e00\u6b21,\u4e00\u6b21\u4f1a\u4f20\u9012\u6240\u6709\u7684\u547d\u4ee4\u7ed9, \u6267\u884c\u8981\u4e48\u5168\u90e8\u6210\u529f,\u8981\u4e48\u90fd\u5931\u8d25\nmset name tom age 10\nmget name age\n\n# \u8bbe\u7f6e\u65b0\u7684\u503c,\u4f1a\u8fd4\u56de\u65e7\u7684name\u7684\u503c\ngetset name tom\n# \u8ffd\u52a0\u5b57\u7b26\u4e32\u5230key\u7684\u503c\u540e\u9762\nappend name cat\n# ==&gt; tomcat\n# strlen \u4e5f\u662fo(1)\u7684\u590d\u6742\u5ea6, \u5c31\u662f\u8bf4 \u4e0d\u662f\u5b9e\u65f6\u8ba1\u7b97key\u7684\u957f\u5ea6\u7684,\n# \u800c\u662f \u6709\u8ba1\u6570\u5668\u7edf\u8ba1\u8be5key\u7684\u957f\u5ea6 \u505a\u4e86\u8bb0\u5f55\u7684\nstrlen name # \u83b7\u53d6\u957f\u5ea6\nsetrange name 1 x\n# tomcat ==&gt; txmcat\ngetrange name 1 3\n# ==&gt;xmc\n</code></pre> <pre><code># \u5982\u679ckey\u4e0d\u5b58\u5728,\u90a3\u4e48\u8be5key\u662fint\u578b,\u521d\u59cb\u503c\u662f0, \u5219\u81ea\u589e1, \u5c31\u53d8\u6210\u4e861, \u8fd4\u56de\u503c\u5c31\u662fage\u7684\u503c\nincr age\n# \u5982\u679c\u4e0d\u5b58\u5728\u8be5key, \u503c\u53d8\u4e3a-1 \u540c\u4e0a\ndecr age\n\nincrby age 2 # \u8868\u793aage \u589e\u52a02\ndecrby age 2 # -2\nincrbyfloat age 1.2\n# \u4f7f\u7528\u8d1f\u6570\u6765\u5b9e\u73b0 decr \u7684\nincrbyfloat age -1.2\n</code></pre> <pre><code>del name\n</code></pre>","tags":["redis"]},{"location":"db/redis/data-type/#_2","title":"\u5e94\u7528\u573a\u666f","text":"<p>\u5206\u5e03\u5f0fid \u751f\u6210\u5668 \u5229\u7528redis\u7684\u5355\u7ebf\u7a0b\u7279\u6027, \u591a\u4e2a\u670d\u52a1\u53ef\u80fd\u8981\u6765\u8bf7\u6c42,\u4f7f\u7528incr \u5c31\u53ef\u4ee5\u6765\u641e\u51fa\u4e00\u4e2a\u81ea\u589e\u7684id</p>","tags":["redis"]},{"location":"db/redis/data-type/#lists","title":"lists","text":"<p>\u6709\u5e8f\u7684,\u53ef\u4ee5\u505a\u5de6\u8fb9\u63d2\u5165,\u5f39\u51fa,\u53f3\u8fb9\u63d2\u5165,\u5f39\u51fa\u7684\u64cd\u4f5c</p>","tags":["redis"]},{"location":"db/redis/data-type/#_3","title":"\u57fa\u672c\u547d\u4ee4","text":"push/pop\u67e5\u6307\u5b9a\u5143\u7d20\u524d\u540e\u63d2\u5165\u5220\u9664\u6839\u636e\u7d22\u5f15\u4fee\u6539\u5143\u7d20\u6839\u636e\u7d22\u5f15\u622a\u53d6\u5143\u7d20 <pre><code># \u4ece\u53f3\u8fb9\u63d2\u5165,\u53ef\u63d2\u5165\u591a\u4e2a\nrpush names tom jack\n# \u4ece\u5de6\u8fb9\u63d2\u5165\nlpush names bob stark\n\nlpop names #\u5de6\u8fb9\u5f39\u51fa\nrpop names #\u53f3\u8fb9\u5f39\u51fa\n# \u4e0a\u9762\u6211\u4eec\u7684lpop \u548crpop \u90fd\u662f\u975e\u963b\u585e\u7684,\u76f4\u63a5\u7ed9\u51fa\u7ed3\u679c,\u5982\u679c\u6ca1\u6709\u5143\u7d20\u7684\u8bdd,\u8fd4\u56de\u7684\u662fnil\n# \u8fd9\u91cc\u7684blpop\u548cbrpop\u662f\u963b\u585e\u7248\u672c\n# \u5982\u679ckey\u5217\u8868\u91cc\u9762\u6709\u503c,\u5219\u9a6c\u4e0a\u8fd4\u56de,\u4e0d\u7ba1\u4f60\u7684timeout\u662f\u5565\n# \u5982\u679ckey\u91cc\u9762\u6ca1\u6709\u5143\u7d20,\u5219\u7b49\u5f85timeout\u79d2, \u8fd8\u6ca1\u6709\u7ed3\u679c\u5219\u9000\u51fa\n# \u5982\u679ctimeout=0,\u5219\u4f1a\u6c38\u8fdc\u7684\u7b49\u5f85\u4e0b\u53bb,\u76f4\u5230\u5217\u8868\u91cc \u6709\u65b0\u7684\u5143\u7d20\nblpop key timeout\n</code></pre> <pre><code># lrange key start end # \u5305\u542bend\n# start end \u5982\u679c\u662f \u8d1f\u6570\n# \u6bd4\u5982 lrange key -6  -1    :-1 \u8868\u793a\u6700\u53f3\u8fb9\u7684\u90a3\u4e2a\u5143\u7d20, -2 \u8868\u793a -1\u90a3\u4e2a\u7684\u5de6\u8fb9\u5143\u7d20\nlrange names 0 -1 # \u67e5\u770b\u6240\u6709\u7684\u5143\u7d20\n# \u83b7\u53d6 \u7d22\u5f15\u4f4d\u7f6e\u7684\u5143\u7d20\nlindex names 2\n# \u5217\u8868\u957f\u5ea6 (\u5143\u7d20\u4e2a\u6570)\nllen names\n</code></pre> <pre><code># \u5728\n# \u4e0b\u97622\u4e2a\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662fo(n),\u56e0\u4e3a\u9700\u8981\u904d\u5386\ninsert after bob bob2\ninsert before bob marry\n</code></pre> <pre><code># \u5982\u679ccount &gt;0 \u5219\u8868\u793a\u4ece\u5de6\u5230\u53f3\u5220\u9664count\u4e2a \u76f8\u540c\u7684value(\u56e0\u4e3alist\u53ef\u4ee5\u5b58\u653e\u76f8\u540c\u7684\u5143\u7d20)\n# \u5982\u679ccount &lt;0 \u5219\u8868\u793a\u4ece\u53f3\u5230\u5de6\n# count=0 \u5220\u9664\u6240\u6709\nlrem key count value\n</code></pre> <pre><code># \u8bbe\u7f6e\u7d22\u5f15\u4f4d\u7f6e1 \u7684\u5143\u7d20\u4e3a trump\nlset names 1 trump\n</code></pre> <pre><code> # names a b c d e\nltrim names 1 3 # \u622a\u53d6\u7d22\u5f151-3 \u5305\u542b3 \u7684\u5143\u7d20\nlrange names 0 -1 # ==&gt; b c d\n</code></pre>","tags":["redis"]},{"location":"db/redis/data-type/#hashes","title":"hashes","text":"<p>\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837,\u5c31\u662fkey\u5bf9\u5e94\u7684\u662f\u4e2amap</p> <p><pre><code>\"tom\":{\n    \"name\":\"tom\",\n    \"age\":20,\n    \"sex\":\"boy\"\n}\n</code></pre> \u53ef\u4ee5\u7406\u89e3\u4e3a \u4e00\u5f20\u8868\u7684\u4e00\u6761\u8bb0\u5f55 \u6bd4\u5982user\u8868,\u65e0\u6cd5\u7ed9\u5355\u72ec\u7684field \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4</p>","tags":["redis"]},{"location":"db/redis/data-type/#_4","title":"\u57fa\u672c\u547d\u4ee4","text":"\u589e\u6539\u67e5\u5220 <pre><code># u:1 \u53ebkey ,name \u53ebfield\nhset u:1 name tom\n# \u591a\u4e2afield, #\u539f\u672c\u7684\u591a\u4e2afield\u7684\u547d\u4ee4 hmset \u8bf4\u662f\u5c06\u88ab\u5e9f\u5f03,\u73b0\u5728\u8fd8\u53ef\u4ee5\u7528\nhset u:1 name tom age 22 sex boy\n# \u53ea\u80fd\u8bbe\u7f6e\u4e00\u4e2afield ,  \u8fd9\u641e\u7684. \u4e0d\u5982\u5c31\u4fdd\u7559 hmset , \u4e0d\u8981\u5728 hset \u91cc\u53ef\u4ee5\u8bbe\u7f6e\u591a\u4e2afield.\nHSETNX  u:1 name jack # \u4e0d\u5b58\u5728\u624d\u8bbe\u7f6e\n# field \u81ea\u589e\nhincrby u:1 age 1\n</code></pre> <pre><code># \u83b7\u53d6field,\u53ea\u80fd\u4e00\u4e2afield\nhget u:1 name\n# \u591a\u4e2afield .. \u670d\u4e86. \u548c\u4e0a\u9762\u7684\u611f\u89c9..\nhmget u:1 name age\nhgetall u:1 #\u8fd4\u56de\u6240\u6709field \u548cvalue\n# \u5224\u65adfield\u662f\u5426\u5b58\u5728\nhexists u:1 name\n# \u5982\u679c\u8bf4\u5224\u65ad u1 \u662f\u5426\u5b58\u5728\nhlen u:1 # \u8fd4\u56de u1 \u6709\u591a\u5c11\u4e2afield\nhkeys u:1 # \u8fd4\u56de\u6240\u6709\u7684field\nhvals u:1 # \u8fd4\u56de\u6240\u6709\u7684value\n</code></pre> <pre><code>hdel u:1 name\nhdel u:1 age sex #\u5220\u9664\u591a\u4e2afield\n</code></pre>","tags":["redis"]},{"location":"db/redis/data-type/#_5","title":"\u5e94\u7528\u573a\u666f","text":"<p>\u4f7f\u7528user:id\u503c \u4f5c\u4e3akey, \u91cc\u9762\u518d\u5b58map \u6bd4\u5982name \u554a, pv(\u4e3b\u9875\u8bbf\u95ee\u91cf),\u8fd9\u6837\u4e00\u4e2akey \u5b58\u653e\u5f88\u591a\u7528\u6237\u7684\u4fe1\u606f</p>","tags":["redis"]},{"location":"db/redis/data-type/#sets","title":"sets \u96c6\u5408","text":"<p>\u65e0\u5e8f,\u65e0\u91cd\u590d</p>","tags":["redis"]},{"location":"db/redis/data-type/#_6","title":"\u57fa\u672c\u547d\u4ee4","text":"\u6dfb\u52a0\u5220\u9664\u67e5\u770b\u96c6\u5408\u8fd0\u7b97 <pre><code># \u6dfb\u52a0\u5143\u7d20\nsadd country china\n</code></pre> <pre><code># \u5220\u9664\u5143\u7d20\nsrem country japan\n</code></pre> <pre><code># \u8ba1\u7b97\u96c6\u5408\u5143\u7d20\u4e2a\u6570\nscard animal\n# \u83b7\u53d6\u96c6\u5408\u6240\u6709\u5143\u7d20\nsmembers animal\n# \u5224\u65ad\u5143\u7d20\u662f\u5426\u5728\u96c6\u5408\u5185\nSISMEMBER animal cow\n# \u968f\u673a\u8fd4\u56de\u4e00\u4e2a\u5143\u7d20\nSRANDMEMBER animal\n# \u968f\u673a\u5f39\u51fa\u4e00\u4e2a\u5143\u7d20\nSPOP animal\n</code></pre> <pre><code>sdiff  user:1:playing_game  user:2:playing_game #\u5dee\u96c6\nsinter user:1:playing_game  user:2:playing_game #\u4ea4\u96c6\nsunion user:1:playing_game  user:2:playing_game #\u5e76\u96c6\n</code></pre>","tags":["redis"]},{"location":"db/redis/data-type/#_7","title":"\u5e94\u7528\u573a\u666f","text":"<ul> <li>\u62bd\u5956\u53ef\u4ee5\u7528srandmember/spop</li> <li>\u7528\u6237\u70b9\u8d5e\u67d0\u4e2a\u5e16\u5b50 ( \u5e16\u5b50id\u4f5c\u4e3akey,\u91cc\u9762\u5b58\u53d1\u7528\u6237id\u8868\u793a\u70b9\u8d5e)</li> <li>\u7ed9\u7528\u6237\u6dfb\u52a0\u6807\u7b7e, \u8fd8\u8981\u77e5\u9053\u4e00\u4e2a\u6807\u7b7e\u5bf9\u5e94\u4e86\u90a3\u4e9b\u7528\u6237,\u90fd\u53ef\u4ee5\u7528\u96c6\u5408\u6765</li> <li>\u5fae\u535a\u7528\u6237\u4e4b\u95f4\u7684\u5171\u540c\u5173\u6ce8</li> </ul>","tags":["redis"]},{"location":"db/redis/data-type/#sorted-sets","title":"sorted sets \u6709\u5e8f\u96c6\u5408","text":"<p>set \u5b58\u653e\u7684\u5c31\u662f\u5143\u7d20 zset \u5b58\u653e\u7684 \u9700\u8981\u4e00\u4e2ascore\u5206\u503c(\u7528\u6765\u6392\u5e8f\u7684,\u53ef\u4ee5\u91cd\u590d) \u548c \u5143\u7d20 \u65f6\u95f4\u590d\u6742\u5ea6\u662f o(logN)</p>","tags":["redis"]},{"location":"db/redis/data-type/#_8","title":"\u57fa\u672c\u547d\u4ee4","text":"\u589e\u6539\u5220\u67e5\u96c6\u5408\u8fd0\u7b97 <pre><code># zadd key score element1 score2 element2 ...\nzadd student 80 xiaoming\nzadd student 80 xiaoming 90 tom\n# \u589e\u52a0\u6216\u51cf\u5c11(\u4f7f\u7528\u8d1f\u6570) \u5143\u7d20\u7684\u5206\u6570\nzincrby student 3 xiaoming\n</code></pre> <pre><code># \u6307\u5b9a\u5143\u7d20\u5220\u9664 \u53ef\u4ee5\u5220\u9664\u591a\u4e2a\u5143\u7d20\nzrem student xiaoming xiaobai\n# \u6839\u636e\u6392\u540d\u8303\u56f4\u6765\u5220\u9664\u5143\u7d20\nZREMRANGEBYRANK student 1 2\n# \u67d1\u6a58\u5206\u6570\u8303\u56f4\u6765\u5220\u9664\u5143\u7d20\nZREMRANGEBYscore student 71  89\n</code></pre> <pre><code># \u83b7\u53d6\u5143\u7d20\u7684\u5206\u6570\nzscore student xiaoming\n\n# \u8fd4\u56de\u5143\u7d20\u603b\u6570\nzcard student\n# \u6309\u7167\u5206\u6570\u5347\u5e8f, \u8fd4\u56de\u5143\u7d20\u7684\u6392\u540d,\n# 0 \u8868\u793a\u7b2c\u4e00\u4f4d, \u4e5f\u5c31\u662f\u5206\u6570\u6700\u5c0f\u7684\u90a3\u4e00\u4f4d\nzrank student xiaoming\n# \u6309\u7167\u5206\u6570\u964d\u5e8f,\u8fd4\u56de\u5143\u7d20\u7684\u6392\u540d\n# 0 \u8868\u793a\u7b2c\u4e00\u4f4d, \u4e5f\u5c31\u662f\u5206\u6570\u6700\u5927\u7684\u90a3\u4e00\u4f4d\nzrevrank student xiaohei\n\n# range \u6309\u7167\u5206\u6570\u5347\u5e8f,\u8fd4\u56de\u7d22\u5f15\u8303\u56f4\u5185\u7684\u5143\u7d20\nzrange student 0 -1\n# withscores \u8868\u793a\u663e\u793a\u5206\u6570\nzrange student 0 -1 withscores\n# \u8fd4\u56de\u6307\u5b9a\u5206\u6570\u8303\u56f4\u5185\u7684\u5143\u7d20\nzrangebyscore student 70 90 [withscores]\n# \u6309\u7167\u5206\u6570\u964d\u5e8f\nzrevrange student 0 -1\n# \u6307\u5b9a\u5206\u6570\u8303\u56f4, \u5148\u6307\u5b9a\u5927 \u540e\u5c0f\nzrevrangebyscore student 100 50 [withscores]\n# \u6307\u5b9a\u5206\u6570\u8303\u56f4\u5185\u6709\u591a\u5c11\u4e2a\u5143\u7d20\nzcount key minScore maxScore\n</code></pre> <pre><code>zadd stu1 77 tom 80 jack 50 karen\nzadd stu2 10 tom 60 jack 80 kelly\n\n# \u4ea4\u96c6\n# ZINTERSTORE destination numkeys key [key ...] [WEIGHTS weight [weight ...]] [AGGREGATE &lt;SUM | MIN | MAX&gt;]\n# destination \u4f1a\u5c06\u4ea4\u96c6\u7684\u7ed3\u679c\u5199\u5165 \u8fd9\u4e2akey\n# numkeys 2 \u8868\u793a\u67092\u4e2akey \u53c2\u4e0e\u4ea4\u96c6\u8fd0\u7b97, \u5fc5\u987b\u6307\u5b9a\n# WEIGHTS \u9ed8\u8ba4\u662f1, \u4e5f\u5c31\u662f\u8bf4\u4f60\u7684\u5206\u6570\u7684\u6743\u91cd, \u6bd4\u5982\u6743\u91cd\u662f10,\u5982\u679c\u4f60\u7684\u5206\u6570\u662f1, \u90a3\u4e48\u7b49\u540c\u4e8e\u662f10\u5206\u7684\u5206\u91cf\n# AGGREGATE \u4ea4\u96c6\u540e\u5bf9\u4e8e\u5143\u7d20\u5206\u6570\u7684\u5904\u7406, \u9ed8\u8ba4\u662fSUM,\u5404\u96c6\u5408\u8be5\u5143\u7d20\u7684\u5206\u6570*\u6743\u91cd \u7684\u548c\nzinterstore res_stu 2 stu1 stu2 # \u4ea4\u96c6\u540e tom \u5143\u7d20\u7684\u5206\u6570\u662f 77*1+10*1 =87\nzrange res_stu  0 -1 withscores # (1)\n# \u6743\u91cd\u9700\u8981\u5206\u522b\u6307\u5b9a\nzinterstore res_stu 2 stu1 stu2 WEIGHTS 5 1 AGGREGATE SUM\n\n# \u5e76\u96c6 ,\u5176\u4ed6\u53c2\u6570\u7b49 \u540c\u4ea4\u96c6\u7684\u5904\u7406\nZUNIONSTORE res_stu 2 stu1 stu2\n</code></pre> <ol> <li> <p>\u7ed3\u679c</p> <pre><code>tom\n87\njack\n140\n</code></pre> </li> </ol>","tags":["redis"]},{"location":"db/redis/data-type/#_9","title":"\u5e94\u7528\u573a\u666f","text":"<p>\u4ec0\u4e48\u4ec0\u4e48\u5404\u79cd\u6392\u884c\u7248 \u53ef\u4ee5\u4f7f\u7528\u6709\u5e8f\u96c6\u5408</p>","tags":["redis"]},{"location":"db/redis/data-type/#_10","title":"\u6269\u5c55\u7c7b\u578b","text":"","tags":["redis"]},{"location":"db/redis/data-type/#bitmaps","title":"bitmaps \u4f4d\u56fe","text":"","tags":["redis"]},{"location":"db/redis/data-type/#_11","title":"\u57fa\u672c\u547d\u4ee4","text":"<p>Tip</p> <p>bitmaps are an extension of the string data type</p> \u4f4d\u7684\u8bbe\u7f6e\u4e0e\u83b7\u53d6\u4f4d\u8fd0\u7b97 <p>\u5b57\u6bcdA \u5bf9\u5e94\u7684ascii\u7801\u662f 65 \u5bf9\u5e94\u7684\u4e8c\u8fdb\u5236 <code>0100 0001</code></p> <pre><code># \u6ce8\u610f\u7d22\u5f15\u4ece0\u5f00\u59cb,\u4ece\u9ad8\u4f4d\u5f80\u4f4e\u4f4d\u8fd9\u6837\u7b97,\u4ece\u5de6\u5230\u53f3.\n#  65\u4e8c\u8fdb\u5236\u7684\u9ad8\u4f4d\u7b2c6\u4f4d(\u4ece0\u5f00\u59cb\u7b97)\u662f1,\u8fd9\u91cc\u7d22\u5f15\u662f1\nsetbit x 1 1 #\u547d\u4ee4\u7684\u8fd4\u56de\u7ed3\u679c \u662f\u4e4b\u524d\u8fd9\u4e2a\u4f4d\u7f6e\u7684\u503c (\u503c:0\u62161)\nsetbit x 7 1 # \u8fd9\u4e2a\u8bbe\u7f6e\u7684\u662f\u4f4e\u4f4d\u76841, \u4e5f\u5c31\u662f\u4e8c\u8fdb\u5236\u7684\u7b2c0\u4f4d\n# \u901a\u8fc7\u4ee5\u4e0a\u7684\u8bbe\u7f6eA\u8fd9\u4e2akey \u7684\u7ed3\u679c\u5c31\u662f 0100 0001\nget x\n# \u7ed3\u679c\u5c31\u662fA\n# \u83b7\u53d6key \u7b2c\u4e8c\u4e2a\u4f4d\u7f6e\u7684 bit\u503c\ngetbit x 1\n# \u83b7\u53d6bit\u4e3a1\u7684\u4e2a\u6570, \u53ef\u4ee5\u6307\u5b9abit\u8303\u56f4\nbitcount A [start end]\nset z 65 # \u6ce8\u610f\u6211\u4eec\u7684\u503c\u662f\u5b57\u7b26\u4e32,\u662f\u4e00\u4e2a\u5b57\u8282\u4e00\u4e2a\u5b57\u8282\u8fdb\u884c\"\u89e3\u6790\"\u7684\nstrlen z # \u53ef\u4ee5\u770b\u5230\u957f\u5ea6\n# \"65\"\u7684 ascii\u662f 6\u662f54  0011 0110,\u5728\u5185\u5b58\u7684\u4f4e\u5730\u5740,  5 \u662f53  0011 0101 \u5728\u5185\u5b58\u4e0a\u5730\u5740\u6bd4\"6\" \u7684\u5927\u4e00\u4e2a\u5b57\u8282\n# \u518d\u5f3a\u8c03\u4e00\u4e0b \u5b57\u7b26\u4e32\u662f\u4e00\u4e2a\u5b57\u8282\u4e00\u4e2a\u5b57\u8282\u8fdb\u884c\"\u89e3\u6790\"\u7684\n# \u90a3\u4e480-7\u7684\u7d22\u5f15\u662f \"6\"\u7684\u4f4d , 8-15\u662f\"5\"\u7684\u4f4d\n# setbit \u7d22\u5f15\u672c\u8eab\u5c31\u662f\u4ece\u4f4e\u5730\u5740\u5230\u9ad8\u5730\u5740, \u53ea\u4e0d\u8fc7\u6bcf\u4e2a\u5b57\u8282\u4e0a (\u5b57\u8282\u7684\u9ad8\u4f4d\u5728\u5c0f\u7684\u7d22\u5f15\u4e0a)\ngetbit z 6 # 1\ngetbit z 15 # 1\n</code></pre> go\u4ee3\u7801\u9a8c\u8bc1\u5b57\u7b26\u4e32\u5de6\u8fb9\u662f\u653e\u5728\u4f4e\u5730\u5740<pre><code>a := \"654\"\nb := (*reflect.StringHeader)(unsafe.Pointer(&amp;a))\nprintln(b.Len, b.Data)\nc := (*[3]int8)(unsafe.Pointer(b.Data))\nprintln(c[0], c[1], c[2])\nprintln(&amp;c[0], &amp;c[1], &amp;c[2])\n</code></pre> <pre><code>setbit tmp 6 1\nsetbit tmp 7 1\n# bitop= bit + operate + \u540e\u9762\u7684 and\u4e0e,or\u6216,not\u975e,xor\u5f02\u6216 \u7b49\n# \u4f4d\u7684\u6216\u64cd\u4f5c,\u5c06\u7ed3\u679c\u7ed9\u5230new_str\u8fd9\u4e2akey\nbitop or new_str A tmp\n# new_str\u7684value\u7ed3\u679c\u662f \"C\"\n</code></pre>","tags":["redis"]},{"location":"db/redis/data-type/#_12","title":"\u5e94\u7528\u573a\u666f","text":"<p>\u7528\u6765\u7edf\u8ba1\u767b\u5f55\u7528\u6237,\u6216\u8005\u8bf4\u6709\u591a\u5c11\u7528\u6237</p> <ul> <li>\u5047\u8bbe\u67091\u4ebf\u4e2a\u7528\u6237, \u90a3\u4e48\u9700\u89811\u4ebf\u4e2a\u4f4d,\u4e5f\u4e0d\u8fc710M\u591a, <code>setbit login_user user_id 1</code> \u8be5\u7528\u6237\u5728\u7ebf\u4e86</li> <li>\u5982\u679c\u6709\u7684\u8bbe\u8ba1\u4e0a\u7528\u6237\u7684id\u521d\u59cb\u5c31\u975e\u5e38\u5de8\u5927. \u7b2c\u4e00\u4e2a\u7528\u6237\u662f100\u4ebf.\u4ee5\u540e\u4f9d\u6b21\u9012\u589e, \u90a3\u4e48\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5-100\u4ebf\u540e\u7684\u6570\u5b57 \u4f5c\u4e3a\u7d22\u5f15\u8fdb\u884c\u8bbe\u7f6e1</li> </ul>","tags":["redis"]},{"location":"db/redis/data-type/#geo","title":"GEO","text":"<pre><code>type city  # \u662fzset\u7c7b\u578b\ngeoadd key \u7ecf\u5ea6 \u7eac\u5ea6 \u6210\u5458\ngeoadd city 116.20 39.56 beijing\n# \u53ef\u4ee5\u6dfb\u52a0\u591a\u4e2a\nGEOADD city 116.20 39.56 beijing 120.12 30.16 hangzhou # \u83b7\u53d6\u67d0\u4e2a\u6210\u5458\u7ecf\u7eac\u5ea6\ngeopos city hangzhou\n# \u8ba1\u7b972\u4e2a\u4f4d\u7f6e\u4e4b\u95f4\u7684\u8ddd\u79bb,\u9ed8\u8ba4\u5355\u4f4d\u662fm, \u53ef\u4ee5\u5728\u540e\u9762\u5e26\u4e0a(km\u5343\u7c73,mi\u82f1\u91cc,ft\u5c3a)\nGEODIST city hangzhou beijing km\n\n# georadius \u83b7\u53d6\u6307\u5b9a\u8303\u56f4\u5185\u7684\u5730\u7406\u4f4d\u7f6e\ngeoradius city 116 39 100 km # --&gt; beijing\n</code></pre>","tags":["redis"]},{"location":"db/redis/data-type/#hyperloglog","title":"hyperLogLog","text":"<p>Note</p> <p>\u5982\u679c\u8ba9\u4f60\u7edf\u8ba1\u4e00\u4e2a\u6570\u636e\u96c6\u91cc\u4e0d\u540c\u5143\u7d20\u7684\u6570\u91cf,\u6bd4\u5982\u65e5\u6d3b\u7528\u6237 \u4f60\u53ef\u80fd\u4f1a\u8bf4\u7edf\u8ba1\u8fd9\u4e2a, \u653e\u8fdbset ,\u7136\u540escard \u4e0d\u5c31\u884c\u4e86.  \u5982\u679c\u6570\u636e\u91cf\u5de8\u5927\u5462, \u90fd\u653e\u8fdbset\u5417, \u6240\u4ee5\u8fd9\u79cd\u60c5\u51b5set\u80af\u5b9a\u4e0d\u884c.</p> <p>\u7528bitmap? 1000\u4e07\u4e5f\u624d1M\u591a, \u633a\u4e0d\u9519\u7684. \u6709\u6ca1\u6709\u5360\u7528\u66f4\u5c11\u7684\u5462. </p> <p>hyperLogLog\u5c31\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898 \u57fa\u4e8ehyperLogLog(HLL)\u7b97\u6cd5,\u4f7f\u7528\u6781\u5c0f\u7684\u7a7a\u95f4,\u5b8c\u6210\u6570\u91cf\u7edf\u8ba1, \u672c\u8d28\u662f\u5b57\u7b26\u4e32 HyperLogLog\uff08HLL\uff09\u662f\u4e00\u79cd\u57fa\u6570(\u4e00\u4e2a\u96c6\u5408\u4e2d\u4e0d\u540c\u5143\u7d20\u7684\u6570\u91cf)\u4f30\u8ba1\u7b97\u6cd5. HLL\u7b97\u6cd5\u53ef\u4ee5\u5728\u6781\u5c11\u7684\u5185\u5b58\u4f7f\u7528\u4e0b,\u5feb\u901f\u51c6\u786e\u5730\u4f30\u8ba1\u4e00\u4e2a\u5927\u578b\u6570\u636e\u96c6\u7684\u57fa\u6570.</p> <p>\u6bcf\u4e2aHyperLogLog\u952e\u53ea\u5360\u7528<code>12KB</code>\u5185\u5b58,\u5c31\u53ef\u4ee5\u8ba1\u7b97\u63a5\u8fd1<code>2^64</code>\u4e2a\u4e0d\u540c\u5143\u7d20\u7684\u57fa\u6570</p> <pre><code># \u6dfb\u52a0\u591a\u4e2a\n# key\u4e0d\u5b58\u5728,\u5219\u6dfb\u52a0\u6210\u529f\u8fd4\u56de1\n# \u5982key\u5df2\u7ecf\u5b58\u5728, \u7136\u540e\u6dfb\u52a0\u7684\u5143\u7d20 \u4e5f\u90fd\u5df2\u7ecf\u6709\u4e86, \u5219\u8fd4\u56de0, \u8868\u793a\u6dfb\u52a0\u65e0\u6548.\nPFADD login_yesterday 1 2 3 4 2\ntype login_yesterday # \u672c\u8d28\u662f\u5b57\u7b26\u4e32\n# \u8ba1\u7b97\u57fa\u6570 (\u4e0d\u540c\u5143\u7d20\u7684\u6570\u91cf) \u63d2\u5165\u5927\u91cf\u6570\u636e\u65f6,\u7edf\u8ba1\u53ef\u80fd\u4e0d\u90a3\u4e48\u51c6\u786e, \u56e0\u4e3a\u672c\u8eab\u5c31\u662f\u9884\u4f30\nPFCOUNT login_yesterday # 4\u4e2a\npfadd login_today 1 2 5 7\nPFMERGE login login_today login_yesterday # \u5c06\u5408\u5e76\u7684\u7ed3\u679c\u8bbe\u7f6e\u5230login \u8fd9\u4e2akey\u4e2d\nPFCOUNT login_yesterday login_today # \u76f4\u63a5\u5408\u5e76\u8ba1\u7b97\n</code></pre>","tags":["redis"]},{"location":"db/redis/data-type/#_13","title":"\u5e94\u7528\u573a\u666f","text":"<p>Note</p> <p>hyperLogLog \u672c\u8eab\u4e0d\u4fdd\u5b58\u5b9e\u9645\u7684\u6570\u636e,\u53ea\u662f\u7528\u6765\u7edf\u8ba1</p> <ul> <li>\u7edf\u8ba1\u65e5\u6d3b,\u6708\u6d3b\u6570\u636e</li> </ul>","tags":["redis"]},{"location":"db/redis/data-type/#bloom-filter","title":"Bloom Filter \u5e03\u9686\u8fc7\u6ee4\u5668","text":"<p>Note</p> <p>\u8fd9\u4e2a\u4e0d\u662f\u6570\u636e\u7c7b\u578b. \u4e0d\u8fc7\u6211\u6682\u65f6\u653e\u5728\u8fd9\u91cc</p> <p>\u539f\u7406\u5c31\u662f: \u4e00\u4e2a\u5f88\u957f\u7684\u4e8c\u8fdb\u5236 (\u521d\u59cb\u4f4d\u7684\u503c\u90fd\u662f0,\u50cfbitmap)\u548c\u8bfa\u5e72\u4e2ahash\u51fd\u6570 \u6bd4\u5982\u4e00\u4e2a\u7535\u8bdd\u53f7\u7801 \u7ed9\u54c8\u5e0c\u51fd\u6570(\u591a\u4e2a)\u8ba1\u7b97\u8fc7\u540e\u7684\u503c,\u5728\u4e8c\u8fdb\u5236\u7684\u76f8\u5e94\u4f4d\u7f6e\u7684\u4f4d\u4e0a\u6539\u62101, \u6bd4\u5982\u6211\u4eec\u8981\u5224\u65ad\u8fd9\u4e2a\u7535\u8bdd\u53f7\u7801\u662f\u5426\u5728\u8fd910\u4ebf\u53f7\u7801\u4e2d, \u5148\u5c0610\u4ebf\u4e2a\u53f7\u7801\u8fd9\u6837\u5904\u7406, \u7136\u540e\u6211\u4eec\u8ba1\u7b97\u8fd9\u4e2a\u7535\u8bdd\u53f7\u7801\u7684\u54c8\u5e0c,\u770b\u5bf9\u5e94\u4f4d\u4e0a\u662f\u5426\u90fd\u662f1</p> <p>\u8bef\u5dee\u7387 - m\u4e2a\u4e8c\u8fdb\u5236\u4f4d - n\u4e2a\u9884\u5907\u6570\u636e - k\u4e2a\u54c8\u5e0c\u51fd\u6570</p>","tags":["redis"]},{"location":"db/redis/data-type/#_14","title":"\u5e94\u7528\u573a\u666f","text":"<p>\u5783\u573e\u90ae\u4ef6\u8fc7\u6ee4\u7b49</p>","tags":["redis"]},{"location":"db/redis/data-type/#bitfieldstodo","title":"bitfields(todo)","text":"","tags":["redis"]},{"location":"db/redis/data-type/#streamstodo","title":"Streams(todo)","text":"<ol> <li> <p>\u8fdb\u5165\u8fd9\u4e2a\u94fe\u63a5\u70b9\u51fbRedis \u7c7b\u578b command reference,\u53ef\u4ee5\u770b\u5230\u66f4\u591a\u547d\u4ee4 \u21a9</p> </li> <li> <p>\u5b98\u65b9\u8bfe\u7a0b \u21a9</p> </li> </ol>","tags":["redis"]},{"location":"db/redis/env/","title":"\u73af\u5883\u914d\u7f6e","text":"<p>Warning</p> <p>\u672a\u5b8c\u5f85\u7eed</p>","tags":["redis"]},{"location":"db/redis/env/#_1","title":"\u5b89\u88c5","text":"","tags":["redis"]},{"location":"db/redis/env/#_2","title":"\u914d\u7f6e","text":"/usr/local/etc/redis.conf<pre><code>...\ndaemonize no # \u662f\u5426\u5b88\u62a4, \u4e00\u822c\u6b63\u5f0f\u7528\u7684\u8bdd \u662fyes,\u4f60\u6d4b\u8bd5\u7684\u65f6\u5019\u53ef\u4ee5\u662fno\nport 6379\nlogfile \"6379.log\" # \u6587\u4ef6\u4f1a\u5b58\u653e\u5230dir\u6307\u5b9a\u7684\u76ee\u5f55\ndir /usr/local/var/db/redis/ #\u5de5\u4f5c\u76ee\u5f55 \u6570\u636e\u90fd\u4f1a\u4fdd\u5b58\u5728\u8fd9\u91cc, (rdb\u6587\u4ef6\u548caof\u6587\u4ef6)\n...\n</code></pre> \u547d\u4ee4\u67e5\u770b\u76f8\u5173\u914d\u7f6e<pre><code>info\ninfo server #\u770b\u4e0bredis\u7684\u7248\u672c,\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\u554a\u4e4b\u7c7b\u7684\nconfig get port #\u67e5\u770b\u7aef\u53e3 (1)\nconfig get *\n# \u652f\u6301\u7684\u6700\u5927\u8fde\u63a5\u6570\nconfig get maxclients\n</code></pre> <ol> <li>\u7ed3\u679c     <pre><code>1) \"port\"\n2) \"6379\"\n</code></pre></li> </ol>","tags":["redis"]},{"location":"db/redis/env/#_3","title":"\u57fa\u7840\u547d\u4ee4","text":"<pre><code># \u5ba2\u6237\u7aef\u8fde\u63a5\u670d\u52a1\u7aef\nredis-cli -h 127.0.0.1 -p 6379\n# \u76f4\u63a5\u6267\u884c \u547d\u4ee4 set age\nredis-cli -p 6378 set age 11\n# \u76f4\u63a5\u8f93\u5165ping \u547d\u4ee4, ok\u7684\u8bdd, pong \u56de\u5e94\nping\n\n# set string\nset name \"hei\"\nget name\n# \u5224\u65adkey\u662f\u5426\u5b58\u5728\nexists name\n# \u5224\u65adkey\u662f\u4ec0\u4e48\u7c7b\u578b\ntype name\n## \u8fd4\u56de\u503c\n#- none \u8868\u793a\u6ca1\u6709\u8fd9\u4e2akey\n#- string\n#- hash\n#- set \u96c6\u5408\n#- zset \u6709\u5e8f\u96c6\u5408\n#- list\n# \u67e5\u770b\u5f53\u524ddb \u6709\u591a\u5c11key,key\u7684\u603b\u6570\ndbsize # \u4ed6\u5b9e\u9645\u662f\u4e00\u4e2a\u8ba1\u6570\u5668,\u4e0d\u662f\u8ba1\u7b97key\u7684\u603b\u6570 \u7684\u64cd\u4f5c\u7684\n# \u904d\u5386\u6240\u6709key, \u663e\u793a\u6240\u6709key\nkeys *\n# \u53ef\u4ee5\u4f7f\u7528\u6b63\u5219\nkeys na* #\u904d\u5386\u6240\u6709na\u5f00\u5934\u7684key\n#\u5220\u9664key\ndel name\ndel name age #\u591a\u4e2a\u5220\u9664\n# \u8fc7\u671f\u8bbe\u7f6e\nexpire name 5 #\u5355\u4f4d\u662f\u79d2,5\u79d2\u540e\u8fc7\u671f\n# \u67e5\u770bkey\u7684\u8fc7\u671f\nttl name #\u8fd4\u56de-2 \u8868\u793a\u5df2\u7ecf\u4e0d\u5b58\u5728\u4e86\n#\u53d6\u6d88\u8fc7\u671f\u65f6\u95f4\u8bbe\u7f6e (\u5c31\u662f\u6ca1\u6709\u8fc7\u671f\u65f6\u95f4\u4e86)\npersist name\n#\u518d\u6b21 \u67e5\u770b\nttl name #\u8fd4\u56de-1 \u8868\u793akey\u6ca1\u6709\u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4\n</code></pre>","tags":["redis"]},{"location":"db/redis/env/#redis","title":"redis\u751f\u547d\u5468\u671f","text":"<ol> <li>\u5ba2\u6237\u7aef\u53d1\u9001\u547d\u4ee4,\u5411\u670d\u52a1\u7aef\u53d1\u9001\u8bf7\u6c42</li> <li>\u5728redis\u670d\u52a1\u7aef,redis\u662f\u5355\u7ebf\u7a0b\u7684,\u6240\u4ee5\u53ef\u4ee5\u60f3\u8c61\u6210\u6709\u4e00\u4e2a\u961f\u5217\u5728\u7ef4\u62a4\u5ba2\u6237\u7aef\u53d1\u9001\u6765\u7684\u8bf7\u6c42\u547d\u4ee4</li> <li>\u670d\u52a1\u7aef\u4e00\u4e2a\u4e00\u4e2a\u7684\u6267\u884c\u961f\u5217\u91cc\u7684\u547d\u4ee4</li> <li>\u8fd4\u56de\u7ed3\u679c\u7ed9\u5ba2\u6237\u7aef</li> </ol>","tags":["redis"]},{"location":"db/redis/env/#pipeline","title":"\u6d41\u6c34\u7ebfpipeline","text":"<p>\u4e00\u6b21\u7f51\u7edc\u547d\u4ee4\u901a\u4fe1\u7684\u65f6\u95f4= \u5ba2\u6237\u7aef\u4f20\u8f93\u547d\u4ee4\u7ed9\u670d\u52a1\u7aef\u9700\u8981\u7684\u7f51\u7edc\u65f6\u95f4+ \u670d\u52a1\u7aef\u6267\u884c\u547d\u4ee4\u9700\u8981\u7684\u65f6\u95f4 + \u8fd4\u56de\u7ed3\u679c\u7ed9\u5ba2\u6237\u7aef\u9700\u8981\u7684\u7f51\u7edc\u65f6\u95f4 \u6216\u8005\u8bf4  \u4e00\u6b21\u65f6\u95f4= \u4e00\u6b21\u7f51\u7edc\u65f6\u95f4+ \u547d\u4ee4\u6267\u884c\u65f6\u95f4 n\u6b21\u7f51\u7edc\u547d\u4ee4\u901a\u4fe1\u7684\u65f6\u95f4 = n\u6b21\u7f51\u7edc\u65f6\u95f4+ n\u6b21\u547d\u4ee4\u6267\u884c\u65f6\u95f4 \u5982\u4f55\u5b9e\u73b0mset mget\u8fd9\u6837\u7684\u6279\u91cf\u7684 \u6548\u679c\u5462</p> <p>\u6d41\u6c34\u7ebf\u5c31\u662f \u4e00\u6b21\u628a\u6279\u91cf\u7684\u547d\u4ee4\u6253\u5305\u53d1\u9001\u7ed9\u670d\u52a1\u7aef,\u670d\u52a1\u7aef\u8ba1\u7b97n\u6b21,\u7136\u540e\u5c06\u6309\u987a\u5e8f\u5c06\u7ed3\u679c\u8fd4\u56de \u6d41\u6c34\u7ebf \u6bd4\u4e0a\u9762\u7684n\u6b21\u7f51\u7edc\u547d\u4ee4 \u7684\u597d\u5904\u5c31\u5728\u4e0e, \u53ea\u8981\u4e00\u6b21\u7f51\u7edc+ n\u6b21\u547d\u4ee4\u65f6\u95f4</p> <p>redis\u7684\u547d\u4ee4\u64cd\u4f5c\u662f\u5fae\u5999\u7ea7\u522b \u6211\u4eec\u9700\u8981\u63a7\u5236\u7684\u5c31\u662f\u7f51\u7edc\u65f6\u95f4\u7684\u51cf\u5c11,</p> <p>mset \u547d\u4ee4\u662f\u539f\u5b50\u6027\u7684,\u5c31\u662f\u8bf4\u91cc\u9762\u7684\u547d\u4ee4\u4e00\u6b21\u6027\u5168\u90e8\u6267\u884c\u5b8c\u6bd5 \u800c\u6211\u4eec\u7684pipeline\u4e0d\u662f\u539f\u5b50\u6027\u7684,\u4ed6\u53ef\u80fd\u628a\u6240\u6709\u8981\u6267\u884c\u7684\u547d\u4ee4\u62c6\u5206\u4e86,\u5148\u6267\u884c\u4e86\u4e00\u90e8\u5206,\u7136\u540e\u88ab\u5176\u4ed6\u4e00\u822c\u7684\u547d\u4ee4\u63d2\u5165\u4e86,\u6267\u884c\u5b83\u540e,\u518d...</p>","tags":["redis"]},{"location":"db/redis/env/#_4","title":"\u6162\u67e5\u8be2","text":"<ul> <li>mysql \u6709\u6162\u67e5\u8be2, redis \u4e5f\u6709, \u5c31\u662f\u670d\u52a1\u7aef\u771f\u6b63\u6267\u884c\u547d\u4ee4\u6240\u82b1\u8d39\u7684\u65f6\u95f4 \u6bd4\u8f83\u6162\u7684 \u8bed\u53e5</li> <li>redis\u628a\u6162\u67e5\u8be2\u7684\u547d\u4ee4\u5b58\u653e\u5230\u4e00\u4e2a\u961f\u5217\u4e2d,\u8fd9\u4e2a\u961f\u5217\u6709\u4e00\u4e2a\u957f\u5ea6,\u5982\u679c\u8d85\u8fc7\u4e86\u8fd9\u4e2a\u957f\u5ea6,\u5219\u4f1a\u8e22\u6389,\u5148\u8fdb\u5148\u8e22</li> </ul> <p>redis.conf<pre><code># \u5982\u679c\u8bbe\u7f6e\u4e3a0 ,\u8868\u793a\u8bb0\u5f55\u6240\u6709\u547d\u4ee4\n# \u5982\u679c\u8bbe\u7f6e &lt; 0 \u5219\u8868\u793a \u4e0d\u8bb0\u5f55\u4efb\u4f55\u547d\u4ee4\nslowlog-log-slower-than 10000  # \u8fd9\u91cc\u662f1s,\u6267\u884c\u65f6\u95f4\u8d85\u8fc71s\u5219\u8ba4\u4e3a\u662f\u6162\u67e5\u8be2\nslowlog-max-len 128            # \u961f\u5217\u4e2d\u7684\u6162\u67e5\u8be2\u4e2a\u6570 \u8d85\u8fc7\u8fd9\u4e2a,\u65e7\u7684\u6162\u67e5\u8be2\u5c31\u4f1a\u4ece\u961f\u5217\u4e2d\u5220\u9664\n</code></pre> \u5e94\u8be5\u5b9a\u671f\u6301\u4e45\u5316\u6162\u67e5\u8be2 ,\u53ef\u4ee5\u4f7f\u7528slowlog get\u7b49\u547d\u4ee4\u5c06\u6162\u67e5\u8be2\u5199\u5165\u5230mysql\u7b49\u6570\u636e\u5e93</p> <pre><code># \u83b7\u53d6\u6700\u65b0\u7684n\u6761\u6162\u67e5\u8be2\u8bb0\u5f55\nslowlog get n\n# \u83b7\u53d6\u6162\u67e5\u8be2\u961f\u5217\u957f\u5ea6\nslowlog len\n# \u6e05\u7a7a\u6162\u67e5\u8be2\u961f\u5217\nslowlog reset\n</code></pre>","tags":["redis"]},{"location":"db/redis/env/#_5","title":"\u5ba2\u6237\u7aef\u5de5\u5177","text":"<p>insight</p> <ol> <li> <p>insight \u21a9</p> </li> </ol>","tags":["redis"]},{"location":"db/redis/persistence/","title":"\u6570\u636e\u6301\u4e45\u5316","text":"<p>Warning</p> <p>\u672a\u5b8c\u5f85\u7eed</p>","tags":["redis"]},{"location":"db/redis/persistence/#rdb","title":"RDB","text":"<p>Note</p> <ul> <li>snapshot,\u5feb\u7167</li> <li>\u4e8c\u8fdb\u5236\u683c\u5f0f</li> <li>\u65e9\u671fredis\u7248\u672c\u7684\u9ed8\u8ba4\u65b9\u5f0f</li> <li>\u6309\u7167\u4e8b\u5148\u6307\u5b9a\u7684\u9891\u7387,\u5468\u671f\u6027\u90fd\u4fdd\u5b58\u5230\u78c1\u76d8</li> <li>\u9ed8\u8ba4\u6587\u4ef6\u662fdump.rdb</li> <li>\u5b95\u673a\u540e,\u6570\u636e\u4f1a\u4e22\u5931\u4e00\u90e8\u5206</li> </ul> redis.conf<pre><code>save 900 1  #900\u79d2\u5185\u5982\u679c\u6709&gt;=1\u4e2akey\u53d1\u751f\u53d8\u5316(set\u5199\u5165\u7684\u64cd\u4f5c),\u5219\u5199\u5165\u78c1\u76d8\nsave 300 10 #300\u79d2\u5185\u5982\u679c\u6709&gt;=10\u4e2akey,\u5219\u4e0d\u7528\u7b49\u5f85900\u79d2 \u5199\u5165\nsave 60 10000  #\u5982\u679c60\u79d2\u5185\u6709&gt;=10000\u4e2a \u5219\u5199\u5165\n</code></pre> <p>Question</p> <p>\u5982\u679c\u4f60\u572860\u79d2\u5185 \u505a\u4e86 999\u6b21\u64cd\u4f5c, \u7136\u540e\u8fd9\u4e2a\u65f6\u5019redis\u670d\u52a1\u5668\u5b95\u673a\u4e86. \u90a3\u4e48\u6570\u636e\u5c31\u4e0d\u4f1a\u5199\u5165\u78c1\u76d8,\u4e5f\u5c31\u662f\u8bf4\u4e22\u5931\u4e86.</p>","tags":["redis"]},{"location":"db/redis/persistence/#rdb_1","title":"\u4e3b\u52a8\u751f\u6210rdb\u5feb\u7167","text":"<p>\u8fdb\u5165\u5ba2\u6237\u7aef <pre><code># \u6bcf\u6b21\u6267\u884c\u8fd9\u6837\u7684\u547d\u4ee4\u90fd\u4f1a\u5c06\u6240\u6709redis\u5185\u5b58\u5feb\u7167\u5230\u4e00\u4e2a\u65b0\u7684rdb\u6587\u4ef6,\u5e76\u8986\u76d6\u539f\u6709\u5feb\u7167\u6587\u4ef6\nsave \u6216 bgsave  \n</code></pre></p> savebgsave <p>\u540c\u6b65\u65b9\u5f0f,\u5728\u4e3b\u7ebf\u7a0b\u4e2d\u4fdd\u5b58\u5feb\u7167, \u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019\u6240\u6709\u64cd\u4f5c\u4f1a\u963b\u585e,\u56e0\u4e3a\u4e3b\u7ebf\u7a0b\u5c31\u662f\u7528\u6765\u6267\u884cclient\u7684\u8bf7\u6c42\u7684</p> <ul> <li>background save ,\u5f02\u6b65\u65b9\u5f0f,client\u8bf7\u6c42\u4e0d\u4f1a\u963b\u585e</li> <li>\u8c03\u7528fork\u521b\u5efa\u4e00\u4e2a\u5b50\u8fdb\u7a0b,\u7236\u8fdb\u7a0b\u7ee7\u7eed\u5904\u7406\u5404\u4e2a\u8bf7\u6c42</li> <li>linux\u7684\u5199\u65f6\u590d\u5236cow\u7279\u70b9,\u7236\u5b50\u8fdb\u7a0b\u5171\u4eab\u540c\u4e00\u4e2a\u7269\u7406\u7a7a\u95f4,\u7236\u8fdb\u7a0b\u4f1a\u5c06\u64cd\u4f5c\u7684\u9875\u9762\u521b\u5efa\u4e00\u4e2a\u526f\u672c,\u800c\u5b50\u8fdb\u7a0b\u7684\u6570\u636e\u8fd8\u662f\u8981\u5f00\u59cb\u4fdd\u5b58\u7684\u90a3\u4e2a\u65f6\u95f4\u70b9</li> <li>\u5b50\u8fdb\u7a0b\u8d1f\u8d23\u5c06\u5185\u5b58\u4e2d\u7684\u5185\u5bb9\u4fdd\u5b58\u5230\u4e34\u65f6\u6587\u4ef6,\u53ea\u6709\u5f53\u5176\u4fdd\u5b58ok\u540e,\u624d\u4f1a\u4fdd\u5b58\u5230\u771f\u6b63\u7684\u6587\u4ef6</li> <li>\u6267\u884c\u5b8c\u540e,\u5b50\u8fdb\u7a0b\u9000\u51fa</li> </ul>","tags":["redis"]},{"location":"db/redis/persistence/#_1","title":"\u91cd\u653e","text":"<ul> <li>\u5c31\u662f\u5c06dump.rdb \u91cd\u65b0\u52a0\u8f7d\u5230\u5185\u5b58</li> <li>rdb\u6bd4aof\u7684\u91cd\u653e\u901f\u5ea6\u5feb,\u76f4\u63a5\u6587\u4ef6\u91cd\u65b0\u5199\u5165 ,aof\u662f\u91cd\u65b0\u6267\u884c\u547d\u4ee4</li> </ul>","tags":["redis"]},{"location":"db/redis/persistence/#aof","title":"AOF","text":"<p>\u25cf append only file \u25cf \u8bb0\u5f55\u6bcf\u4e00\u6b21\u7684\u5199\u64cd\u4f5c,\u51e0\u4e4e\u4e0d\u4f1a\u4e22\u5931\u6570\u636e,\u4f46\u662f \u8fd9\u6837\u6027\u80fd\u80af\u5b9a\u5c31\u6ca1\u90a3\u4e48\u597d\u4e86   \u25cb \u56e0\u4e3a\u5199\u5165\u78c1\u76d8\u672c\u8eab \u662f\u5148\u5199\u5230\u7f13\u5b58\u7684? \u64cd\u4f5c\u7cfb\u7edf.. \u25cf \u5c31\u662f\u5c06\u4f60\u6267\u884c\u7684redis\u547d\u4ee4 \u6dfb\u52a0\u5230\u6307\u5b9a\u7684\u6587\u4ef6 \u25cf \u6587\u4ef6\u4f1a\u6bd4\u8f83\u5927 \u25cf \u91cd\u542f\u65f6,\u53ef\u4ee5\u901a\u8fc7\u91cd\u65b0\u6267\u884c\u6587\u4ef6\u4e2d\u7684\u547d\u4ee4\u5728\u5185\u5b58\u4e2d\u91cd\u5efa\u6570\u636e</p> redis.conf\u4e2d\u5f00\u542faof<pre><code>appendonly no # \u8bbe\u7f6e\u4e3ayes \u5f00\u542f\nappendfilename \"appendonly.aof\"  # \u6587\u4ef6\u540d\ndir /usr/local/var/db/redis/  # \u5b58\u653e\u7684\u76ee\u5f55\u5728\u8fd9\u91cc\n</code></pre>","tags":["redis"]},{"location":"db/redis/persistence/#_2","title":"\u5199\u5165\u7b56\u7565","text":"<pre><code># appendfsync always  # \u6bcf\u5199\u4e00\u6761\u547d\u4ee4,\u5c31\u5199\u5165, \u8fd9\u4e2a\u6027\u80fd\u6700\u4e0d\u597d\n# \u6bcf1\u79d2,redis\u5185\u90e8\u672c\u8eab\u4e5f\u662f\u5148\u5199\u5230\u7f13\u5b58\u4e2d,\u5230\u8fbe1\u79d2\u540e,\u5199\u5165\u78c1\u76d8\n# \u6545\u969c\u65f6 \u53ea\u4f1a\u4e22\u59311\u79d2\u949f\u7684\u6570\u636e\nappendfsync everysec\n# appendfsync no      # \u5c06\u6570\u636e\u4ea4\u7ed9\u64cd\u4f5c\u7cfb\u7edf\u6765\u5904\u7406.\n\n#\u8868\u793a\u91cd\u5199\u7684\u65f6\u5019,\u7236\u8fdb\u7a0b\u7684\u65b0\u7684\u64cd\u4f5c\u4e0d\u540c\u6b65\u5230\u6587\u4ef6\nno-appendfsync-on-rewrite no\n</code></pre> <pre><code>#\u53ef\u4ee5\u7528config set parma value \u6765\u4fee\u6539\n\u4f46\u662f\u5982\u679c\u8981\u6c38\u4e45\u8bdd,\u9700\u8981 config rewirte\n</code></pre>","tags":["redis"]},{"location":"db/redis/persistence/#_3","title":"\u91cd\u5199\u4f18\u5316","text":"<p>\u6211\u4eec\u77e5\u9053\u5f53redis\u91cd\u542f\u65f6, \u4f1a\u5c06aof\u6587\u4ef6\u91cc\u7684\u547d\u4ee4\u91cd\u65b0\u6267\u884c\u6765\u8fbe\u5230\u91cd\u5efa\u6570\u636e\u7684\u76ee\u7684</p> <ul> <li>aof\u91cd\u5199\u7684\u95ee\u9898</li> <li>aof \u662f\u91cd\u65b0\u6267\u884c\u4e86\u4e00\u904d\u547d\u4ee4, \u80af\u5b9a\u6bd4rdb \u91cd\u653e\u6162</li> <li>\u7531\u4e8e\u53ef\u80fd\u6709\u5f88\u591a\u65e0\u7528\u7684\u547d\u4ee4, \u8fd9\u4e2a\u5f88\u597d\u7406\u89e3, \u5c31\u662f\u4f60\u540e\u9762\u7684\u547d\u4ee4 \u76f4\u63a5\u8986\u76d6\u4e86\u524d\u9762\u7684, set a 1 ,set a 2,\u7b2c\u4e00\u6761\u547d\u4ee4\u5b9e\u9645\u5c31\u662f\u6ca1\u7528\u7684</li> <li>\u6bd4\u5982\u4f60\u6267\u884c\u4e86100\u6b21\u7684\u64cd\u4f5c,\u53ef\u80fd\u53ea\u8981\u4e00\u6b21\u5c31\u884c\u4e86,\u4f46\u662f\u4fdd\u5b58\u7684\u8fd8\u662f100\u8bed\u53e5</li> <li>\u624b\u52a8\u91cd\u5199\u547d\u4ee4 bgrewirteaof \u547d\u4ee4\u53ef\u4ee5\u91cd\u5199aof\u6587\u4ef6,\u5408\u5e76\u4e00\u4e9b\u64cd\u4f5c</li> <li>\u4e0d\u4f1a\u8bfb\u53d6\u65e7\u7684aof\u6587\u4ef6</li> <li>\u6bd4\u5982\u5185\u5b58\u4e2d\u7684\u7ed3\u679c\u76f4\u63a5\u53d8\u6210 \u5b83\u6240\u5bf9\u5e94\u7684\u8bed\u53e5 \u5199\u5230\u4e34\u65f6\u6587\u4ef6</li> <li>\u5c06\u5185\u5b58\u4e2d\u7684\u6587\u4ef6\u4fdd\u5b58\u5230\u4e34\u65f6\u6587\u4ef6,\u6700\u540e\u66ff\u6362\u771f\u6b63\u7684\u6587\u4ef6</li> <li>\u8fc7\u7a0b<ul> <li>\u4e3b\u8fdb\u7a0b\u901a\u8fc7fork \u751f\u6210\u5b50\u8fdb\u7a0b</li> <li>\u5b50\u8fdb\u7a0b\u6839\u636e\u5185\u5b58\u4e2d\u7684\u6570\u636e\u521b\u5efa\u6570\u636e\u5e93\u91cd\u5efa\u547d\u4ee4\u5e8f\u5217\u4e0e\u4e34\u65f6\u6587\u4ef6\u4e2d</li> <li>\u7236\u8fdb\u7a0b\u7ee7\u7eed\u63a5\u6536client\u7684\u8bf7\u6c42,\u4f1a\u628a\u8fd9\u4e9b\u8bf7\u6c42\u7684\u547d\u4ee4\u8ffd\u52a0\u4e8e\u539f\u6765\u7684aof\u6587\u4ef6,\u4e3a\u4e86\u9632\u6b62\u91cd\u5199\u5931\u8d25,\u989d\u5916\u7684\u4f1a\u628a\u8fd9\u4e9b\u65b0\u7684\u8bf7\u6c42\u5199\u4e8e\u4e00\u4e2a\u7f13\u51b2\u961f\u5217\u4e2d</li> <li>\u5b50\u8fdb\u7a0b\u5199\u5b8c\u4e34\u65f6\u6587\u4ef6\u540e,\u4f1a\u901a\u77e5\u7236\u8fdb\u7a0b,\u7236\u8fdb\u7a0b\u4f1a\u628a\u7f13\u51b2\u961f\u5217\u4e2d\u7684\u547d\u4ee4\u5199\u5230\u4e34\u65f6\u6587\u4ef6\u4e2d</li> <li>\u6700\u540e \u7236\u8fdb\u7a0b?\u7528\u4e34\u65f6\u6587\u4ef6\u66ff\u6362\u8001\u7684aof\u6587</li> </ul> </li> </ul>","tags":["redis"]},{"location":"db/redis/persistence/#_4","title":"\u91cd\u5199\u7b56\u7565","text":"<pre><code># \u5f53\u4f60\u7684\u6587\u4ef6 \u81ea\u4e0a\u4e00\u6b21\u91cd\u5199\u540e \u5927\u5c0f\u589e\u52a0\u4e86100%\u540e, \u4f1a\u89e6\u53d1\u91cd\u5199\n#\u5f53\u73b0\u5728\u5f97aof\u6587\u4ef6\u662f\u4e0a\u6b21\u91cd\u5199\u540e\u7684\u6587\u4ef6\u76842\u500d\u5927\u5c0f\u65f6,\u518d\u6b21\u91cd\u5199\nauto-aof-rewrite-percentage 100\n# \u8868\u793a\u5f53\u6587\u4ef6\u81f3\u5c11\u8fbe\u523064m\u7684\u65f6\u5019\u624d\u4f1a\u81ea\u52a8\u91cd\u5199, \u56e0\u4e3a\u6587\u4ef6\u592a\u5c0f \u672c\u8eab\u52a0\u8f7d\u5230\u5185\u5b58\u5c31\u5f88\u5feb.\nauto-aof-rewrite-min-size 64mb\n</code></pre>","tags":["redis"]},{"location":"db/redis/persistence/#redis-40","title":"redis 4.0\u4ee5\u540e \u6df7\u5408\u6301\u4e45\u5316","text":"<p>\u91cd\u542f Redis \u65f6\uff0c\u6211\u4eec\u5f88\u5c11\u4f7f\u7528 RDB\u6765\u6062\u590d\u5185\u5b58\u72b6\u6001\uff0c\u56e0\u4e3a\u4f1a\u4e22\u5931\u5927\u91cf\u6570\u636e\u3002\u6211\u4eec\u901a\u5e38\u4f7f\u7528 AOF \u65e5\u5fd7\u91cd \u653e\uff0c\u4f46\u662f\u91cd\u653e AOF \u65e5\u5fd7\u6027\u80fd\u76f8\u5bf9 RDB\u6765\u8bf4\u8981\u6162\u5f88\u591a\uff0c\u8fd9\u6837\u5728 Redis \u5b9e\u4f8b\u5f88\u5927\u7684\u60c5\u51b5\u4e0b\uff0c\u542f\u52a8\u9700\u8981\u82b1\u8d39\u5f88 \u957f\u7684\u65f6\u95f4\u3002 Redis 4.0 \u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5e26\u6765\u4e86\u4e00\u4e2a\u65b0\u7684\u6301\u4e45\u5316\u9009\u9879\u2014\u2014\u6df7\u5408\u6301\u4e45\u5316</p> <ul> <li>\u5c31\u662f\u7ed3\u5408\u4e86\u4e0a\u9762\u76842\u4e2a</li> <li> <p>\u5f00\u542f <pre><code>aof-use-rdb-preamble yes\n</code></pre></p> </li> <li> <p>AOF\u5728\u91cd\u5199\u65f6\uff0c\u4e0d\u518d\u662f\u5355\u7eaf\u5c06\u5185\u5b58\u6570\u636e\u8f6c\u6362\u4e3aRESP\u547d\u4ee4\u5199\u5165AOF\u6587\u4ef6\uff0c\u800c\u662f\u5c06 \u91cd\u5199\u8fd9\u4e00\u523b\u4e4b\u524d\u7684\u5185\u5b58**\u505aRDB\u5feb\u7167\u5904\u7406\uff0c\u5e76\u4e14\u5c06RDB\u5feb\u7167\u5185\u5bb9\u548c**\u589e\u91cf****\u7684AOF\u4fee\u6539\u5185\u5b58\u6570\u636e\u7684\u547d\u4ee4\u5b58\u5728\u4e00 \u8d77\uff0c\u90fd\u5199\u5165\u65b0\u7684AOF\u6587\u4ef6\uff0c\u65b0\u7684\u6587\u4ef6\u4e00\u5f00\u59cb\u4e0d\u53ebappendonly.aof\uff0c\u7b49\u5230\u91cd\u5199\u5b8c\u65b0\u7684AOF\u6587\u4ef6\u624d\u4f1a\u8fdb\u884c\u6539 \u540d\uff0c\u539f\u5b50\u7684\u8986\u76d6\u539f\u6709\u7684AOF\u6587\u4ef6\uff0c\u5b8c\u6210\u65b0\u65e7\u4e24\u4e2aAOF\u6587\u4ef6\u7684\u66ff\u6362\u3002 </p> </li> <li>\u4e8e\u662f\u5728 Redis \u91cd\u542f\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u5148\u52a0\u8f7d RDB \u7684\u5185\u5bb9\uff0c\u7136\u540e\u518d\u91cd\u653e\u589e\u91cf AOF \u65e5\u5fd7\u5c31\u53ef\u4ee5\u5b8c\u5168\u66ff\u4ee3\u4e4b\u524d\u7684 AOF \u5168\u91cf\u6587\u4ef6\u91cd\u653e\uff0c\u56e0\u6b64\u91cd\u542f\u6548\u7387\u5927\u5e45\u5f97\u5230\u63d0\u5347\u3002 </li> <li>bgrewirteaof \u540e\u770b\u4e0b aof\u6587\u4ef6,\u7136\u540e set  \u5199\u5165 ,\u518d\u770b\u770b\u6587\u4ef6\u91cc\u7684\u5185\u5bb9</li> </ul>","tags":["redis"]},{"location":"db/redis/source-code/","title":"\u6e90\u7801\u5206\u6790","text":"<p>Warning</p> <p>\u672a\u5b8c\u5f85\u7eed</p> env version redis 6.2.7","tags":["redis"]},{"location":"db/redis/source-code/#vscode-debug","title":"vscode debug \u73af\u5883\u642d\u5efa","text":"<ol> <li>\u6dfb\u52a0\u914d\u7f6e</li> </ol> <p>mac \u73af\u5883\u9009\u62e9lldb, \u7136\u540e\u4fee\u6539\u90e8\u5206\u914d\u7f6e,\u5982\u4e0b launch.json<pre><code>{\n\"version\": \"0.2.0\",\n\"configurations\": [\n{\n\"name\": \"(lldb) \u542f\u52a8\",\n\"type\": \"cppdbg\",\n\"request\": \"launch\",\n\"program\": \"${workspaceFolder}/src/redis-server\",\n\"args\": [\n\"./redis.conf\"\n],\n\"stopAtEntry\": false,\n\"cwd\": \"${workspaceFolder}\",\n\"environment\": [],\n\"externalConsole\": false,\n\"MIMode\": \"lldb\"\n}\n]\n}\n</code></pre> 2. \u7f16\u8bd1 <pre><code># \u7f16\u8bd1\n# -O0 \u53c2\u6570\u8868\u793a\u544a\u8bc9\u7f16\u8bd1\u5668\u4e0d\u8981\u4f18\u5316\u4ee3\u7801, \u9632\u6b62\u4f60\u5728 Debug \u7684\u65f6\u5019,IDE \u91cc\u9762\u7684 Redis \u6e90\u7801\u4e0e\u5b9e\u9645\u8fd0\u884c\u7684\u4ee3\u7801\u5bf9\u5e94\u4e0d\u4e0a.\n# MALLOC=jemalloc,\u6307\u5b9a\u5728 Mac OS \u7cfb\u7edf\u4e0a Redis \u4f7f\u7528 jemalloc \u5185\u5b58\u5206\u914d\u5668,\n# Linux \u9ed8\u8ba4\u4f7f\u7528\u8be5\u5206\u914d\u5668\uff0c\u5982\u679c\u662f Linux \u7cfb\u7edf,\u65e0\u9700\u6307\u5b9a\u8be5\u53c2\u6570\nmake CFLAGS=\"-g -O0\" MALLOC=jemalloc\n</code></pre> 3. \u5f00\u59cb\u8c03\u8bd5 (\u5feb\u6377\u952eF5) src/server.c main()\u4e3b\u51fd\u6570 \u6253\u4e2a\u65ad\u70b9<pre><code>int main(int argc, char **argv) {\nstruct timeval tv;\nint j;\nchar config_from_stdin = 0;\n...\n...\n}\n</code></pre></p>","tags":["redis"]},{"location":"db/redis/source-code/#_1","title":"\u603b\u4f53\u6d41\u7a0b","text":"","tags":["redis"]},{"location":"db/redis/source-code/#_2","title":"\u670d\u52a1\u542f\u52a8","text":"server.c\u5165\u53e3redisCommandTableinitServer() server.c<pre><code>// \u5165\u53e3\nint main(int argc, char **argv) {\n// ...\ninitServerConfig();\n// ...\ninitServer();\n// ...\n}\n</code></pre> <pre><code>struct redisCommand redisCommandTable[] = {\n{\"module\",moduleCommand,-2,\n\"admin no-script\",\n0,NULL,0,0,0,0,0,0},\n{\"get\",getCommand,2,\n\"read-only fast @string\",\n0,NULL,1,1,1,0,0,0},\n...\n}\n</code></pre> <pre><code>void initServer(void) {\n// ...\nserver.db = zmalloc(sizeof(redisDb)*server.dbnum);\n// ...\n/* \u521b\u5efa\u5e76\u521d\u59cb\u5316\u6570\u636e\u5e93\u7ed3\u6784 dbnum=16  \u6211\u4eecselect 0 \u9009\u62e9\u6570\u636e\u5e93*/\nfor (j = 0; j &lt; server.dbnum; j++) {\nserver.db[j].dict = dictCreate(&amp;dbDictType,NULL);\nserver.db[j].expires = dictCreate(&amp;dbExpiresDictType,NULL);\nserver.db[j].expires_cursor = 0;\nserver.db[j].blocking_keys = dictCreate(&amp;keylistDictType,NULL);\nserver.db[j].ready_keys = dictCreate(&amp;objectKeyPointerValueDictType,NULL);\nserver.db[j].watched_keys = dictCreate(&amp;keylistDictType,NULL);\nserver.db[j].id = j;\nserver.db[j].avg_ttl = 0;\nserver.db[j].defrag_later = listCreate();\nlistSetFreeMethod(server.db[j].defrag_later,(void (*)(void*))sdsfree);\n}\n}\n</code></pre>","tags":["redis"]},{"location":"db/redis/source-code/#set-age-11-doing","title":"set age 11 \u7684\u8fc7\u7a0b(doing)","text":"<p>Could not render!</p> <p>\u5f00\u5230key-value\u7684\u8fd9\u79cd\u7ed3\u6784,\u6570\u636e\u662f\u5982\u4f55\u5b58\u50a8\u7684\u5462? \u6211\u4eec\u5e94\u8be5\u5f88\u5bb9\u6613\u60f3\u5230\u54c8\u5e0c\u8868\u5427, \u53bb\u770bgo\u4e2dmap\u7684\u56fe\u4e66\u9986\u4f8b\u5b50.</p> <p>\u8fd9\u91cc\u6211\u518d\u4e3e\u4e2a\u4f8b\u5b50, \u65b0\u534e\u5b57\u5178, \u6211\u4eec\u53ef\u4ee5\u8bf4\u5b57\u5178\u67092\u79cd\u54c8\u5e0c\u51fd\u6570, \u4e00\u79cd\u662f\u6309\u7167\u62fc\u97f3\u6765\u67e5,\u53e6\u5916\u4e00\u79cd\u662f\u6309\u504f\u65c1\u90e8\u9996.</p> <pre><code>typedef struct redisDb {\n/* The keyspace for this DB */\ndict *dict;                 /* Timeout of keys with a timeout set */\ndict *expires;           /* Keys with clients waiting for data (BLPOP)*/\ndict *blocking_keys;   /* Blocked keys that received a PUSH */\ndict *ready_keys;          /* WATCHED keys for MULTI/EXEC CAS */\ndict *watched_keys;         /* Database ID */\nint id;                     /* Average TTL, just for stats */\nlong long avg_ttl;\n/* Cursor of the active expire cycle. */\nunsigned long expires_cursor; /* List of key names to attempt to defrag one by one, gradually. */\nlist *defrag_later;         } redisDb;\n</code></pre> <p></p> <pre><code>\n</code></pre>","tags":["redis"]},{"location":"developer/blog/","title":"Blog","text":"<p>Warning</p> <p>\u672a\u5b8c\u5f85\u7eed</p>"},{"location":"developer/blog/#1","title":"\u57df\u540d1","text":"<p>\u8d2d\u4e70\u7f51\u7ad9</p>"},{"location":"developer/blog/#_1","title":"\u535a\u5ba2\u4e66\u5199\u5de5\u5177","text":""},{"location":"developer/blog/#mkdocs","title":"mkdocs","text":"<p>mkdocs-material best plugin charts</p>"},{"location":"developer/blog/#tasklistchecklist","title":"tasklist/checklist","text":"/opt/miniconda3/envs/py310/lib/python3.10/site-packages/pymdownx<pre><code>    classes.append(\"task-list-item\")\n# \u8fd9\u91cc\u7b80\u5355\u6539\u6539...\n#  [ ] __xxx \u5f00\u5934\u7684tasklist \u8868\u793a\u6b63\u5728\u8fdb\u884c\u4e2d\u7684\u4efb\u52a1\n#  [x] --xxx \u5f00\u5934\u8868\u793a\u5df2\u7ecf\u5b8c\u6210,\u6bd4\u8f83\u6ee1\u610f\n#  __ \u5f00\u5934\u7684tasklist \u8868\u793a\u6b63\u5728\u8fdb\u884c\u4e2d\u7684\u4efb\u52a1\nif li.text is not None:\nif \"__\" in li.text :\nclasses.append(\"task-list-item-wip\")\nli.text = li.text.replace(\"__\", \"\")\nelif \"--\" in li.text:\nclasses.append(\"task-list-item-perfect\")\nli.text = li.text.replace(\"--\", \"\")\nelse:\nclasses.append(\"task-list-item-todo-finish\")\nif len(li):\nfirst = list(li)[0]\nif first.tag == \"p\" and first.text is not None:\nif \"__\" in first.text:\nclasses.append(\"task-list-item-wip\")\nfirst.text = first.text.replace(\"__\", \"\")\nelif \"--\" in first.text:\nclasses.append(\"task-list-item-perfect\")\nfirst.text = first.text.replace(\"--\", \"\")\nelse:\nclasses.append(\"task-list-item-todo-finish\")\n</code></pre> <pre><code>- [x] java\n- [ ] python\n    * [x] golang\n    * [x] js\n    * [ ] __rust __\u8868\u793a\u6b63\u5728\u8fdb\u884c\n- [ ] c\n</code></pre>"},{"location":"developer/blog/#chart","title":"chart","text":"<p>charts demo page</p>"},{"location":"developer/blog/#markmap","title":"markmap","text":"<p>mkdocs-markmap markmap <pre><code>```markmap\n# Root\n\n## Branch 1\n\n- Branchlet 1a\n- Branchlet 1b\n- abc\n- fff\n    - fff\n\n## Branch 2\n\n- Branchlet 2a\n- Branchlet 2b\n```\n</code></pre></p> # Root  ## Branch 1  - Branchlet 1a - Branchlet 1b - abc - fff     - fff  ## Branch 2  - Branchlet 2a - Branchlet 2b"},{"location":"developer/blog/#bitfield","title":"bitfield","text":""},{"location":"developer/blog/#plantuml","title":"plantuml","text":"\u4f7f\u7528\u5df2\u6709\u7684plantuml\u6587\u4ef6,\u76ee\u5f55\u662f\u76f8\u5bf9docs/<pre><code>```\n@from_file:go/.diagram/reflect-type.plantuml\n```\n</code></pre>"},{"location":"developer/blog/#blockdiag","title":"blockdiag","text":"<p>blockdiag</p>"},{"location":"developer/blog/#_2","title":"\u5bfc\u5165\u6587\u4ef6","text":"<p>Warning</p> <p>\u6587\u4ef6\u8def\u5f84\u8bf7\u7528 \"\" \u5305\u8d77\u6765</p> <p><code>--8&lt;-- \"c/basis/code/main.c\"</code></p> <p>\u6216\u4f7f\u7528<code>--8&lt;--</code> \u7136\u540e\u6362\u884c+<code>\u6587\u4ef6\u8def\u5f84</code>+\u6362\u884c+<code>--8&lt;--</code> \u7684\u65b9\u5f0f</p> <p>\u4f60\u53ef\u4ee5\u5728\u8fd9\u4e9b\u5916\u9762\u7528 3\u4e2a`\u5305\u8d77\u6765,\u8fd9\u6837\u5c31\u53d8\u6210\u4ee3\u7801\u5757</p>"},{"location":"developer/blog/#hugo","title":"hugo","text":"<p>docsy\u4e3b\u9898 hugo\u5b98\u7f51 <pre><code>hugo # \u751f\u6210\u9759\u6001\u6587\u4ef6. public/\n</code></pre></p>"},{"location":"developer/blog/#_3","title":"\u535a\u5ba2\u90e8\u7f72\u65b9\u6848","text":""},{"location":"developer/blog/#github-pages","title":"github pages","text":""},{"location":"developer/blog/#vercel","title":"vercel","text":"<p>Tip</p> <p>\u4f60\u90e8\u7f72\u5728vercel\u4e0a\u7684\u7f51\u7ad9\u662f\u53ef\u4ee5\u8bbf\u95ee\u5916\u7f51\u7684\u54e6,\u4e0d\u7528\u7ffb\u5899.</p>"},{"location":"developer/blog/#_4","title":"\u6ce8\u518c","text":"<ol> <li>\u8bbf\u95eevercel\u7f51\u7ad9</li> <li>\u8f93\u5165\u7528\u6237\u540d\u540e,continue </li> <li> <p>\u9009\u62e9\u6ce8\u518c\u65b9\u5f0f </p> Continue with GithubContinue with Email <p>\u70b9\u51fb\u540e,\u5f39\u51fa\u7684\u9875\u9762\u4e2d\u9009\u62e9\u8fd9\u4e2a\u6388\u6743  \u5982\u679c\u4f60\u7528\u7684github\u90ae\u7bb1\u662f\u56fd\u5185\u7684,\u6216\u8005 hotmail \u53ef\u80fd\u90fd\u4f1a\u63d0\u793auser block\u4e4b\u7c7b\u7684\u9519\u8bef. \u53ef\u4ee5\u8bd5\u7740\u4e3a\u4f60\u7684github\u6dfb\u52a0\u4e00\u4e2agmail\u90ae\u7bb1(\u5173\u4e8e\u6ce8\u518c\u81ea\u884c\u89e3\u51b3,\u767b\u5f55\u53ef\u4ee5\u7528QQ\u90ae\u7bb1APP,\u65e0\u9700fq),\u7136\u540e\u5c06\u5b83\u8bbe\u7f6e\u4e3a\u4f60\u7684\u4e3b\u90ae\u7bb1. \u518d\u8bd5\u7740\u70b9\u51fb <code>Continue with Github</code> (\u53ef\u80fd\u9700\u8981\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4),\u5982\u679c\u8fd8\u4e0d\u884c\u7684\u8bdd, \u6211\u4eec\u5c31\u4f7f\u7528 <code>Continue with Email</code> \u90ae\u7bb1\u6765\u6ce8\u518c.</p> <p>\u8f93\u5165\u90ae\u7bb1 ,\u8bf7\u4f7f\u7528gmail\u90ae\u7bb1</p> </li> <li> <p>\u624b\u673a\u9a8c\u8bc1, \u53ef\u4ee5\u4f7f\u7528\u56fd\u5185\u7684\u624b\u673a\u53f7</p> </li> </ol>"},{"location":"developer/blog/#_5","title":"\u767b\u5f55","text":"<p>Warning</p> <p>\u7528\u90ae\u7bb1\u767b\u5f55\u7684\u65f6\u5019,\u63d0\u793a\u7684\u9875\u9762\u5343\u4e07\u4e0d\u8981\u5173\u95ed, \u5148\u53bb\u9a8c\u8bc1\u90ae\u7bb1,\u7136\u540e\u8fd9\u4e2a \u9875\u9762\u4f1a\u81ea\u52a8\u8df3\u8f6c\u5230\u5df2\u7ecf\u767b\u5f55\u7684\u754c\u9762!!</p>"},{"location":"developer/blog/#_6","title":"\u90e8\u7f72","text":""},{"location":"developer/blog/#_7","title":"\u56fd\u5185\u65e0\u6cd5\u8bbf\u95ee\u7684\u95ee\u9898","text":"<p>\u9700\u8981\u914d\u7f6e\u57df\u540d</p> <ol> <li>\u6253\u5f00 \u57df\u540d\u89e3\u6790\u9875\u9762(\u8fd9\u91cc\u4ee5aliyun\u4e3a\u4f8b)</li> <li>\u70b9\u51fb \u4f60\u60f3\u8981\u4f7f\u7528\u7684\u57df\u540d \u90a3\u884c\u7684\u89e3\u6790\u8bbe\u7f6e,\u6dfb\u52a0\u8bb0\u5f55</li> <li> <p>\u8f93\u5165</p> \u9009\u9879 \u8f93\u5165\u6216\u9009\u62e9\u7684\u5185\u5bb9 \u8bb0\u5f55\u7c7b\u578b CNAME \u8bb0\u5f55\u7c7b\u578b \u968f\u4fbf, \u4f5c\u4e3a\u4f60\u90e8\u7f72\u7684\u7ad9\u70b9\u7684\u57df\u540d \u8bb0\u5f55\u503c <code>cname.vercel-dns.com</code> </li> <li> <p>\u5728\u8be5dashboard\u9875\u9762,\u70b9\u51fb\u4f60\u90e8\u7f72\u7684\u9879\u76ee</p> </li> <li> <p>\u9009\u62e9settings-&gt;Domains-&gt;\u8f93\u5165\u4f60\u7684\u57df\u540d\u2192\u70b9\u51fbADD</p> <p></p> </li> <li> <p>\u7b49\u5f85vercel\u9a8c\u8bc1\u4f60\u7684\u57df\u540d,\u7136\u540e\u5c31\u53ef\u4ee5\u5728\u56fd\u5185\u7f51\u7edc\u4e0a\u8bbf\u95ee\u4e86.</p> </li> </ol>"},{"location":"developer/blog/#cloudflare","title":"cloudflare","text":"<ol> <li> <p>https://wanwang.aliyun.com/domain \u21a9</p> </li> <li> <p>https://vercel.com/signup \u21a9</p> </li> <li> <p>cloudflare \u21a9</p> </li> </ol>"},{"location":"developer/mac/","title":"mac","text":""},{"location":"developer/mac/#brew1","title":"brew1","text":""},{"location":"developer/mac/#homebrew","title":"\u4f7f\u7528\u56fd\u5185\u6e90\u6765\u5b89\u88c5homebrew","text":"<pre><code>export HOMEBREW_BREW_GIT_REMOTE=\"https://mirrors.ustc.edu.cn/brew.git\"\nexport HOMEBREW_CORE_GIT_REMOTE=\"https://mirrors.ustc.edu.cn/homebrew-core.git\"\nexport HOMEBREW_BOTTLE_DOMAIN=\"https://mirrors.ustc.edu.cn/homebrew-bottles\"\nexport HOMEBREW_API_DOMAIN=\"https://mirrors.ustc.edu.cn/homebrew-bottles/api\"\n/bin/bash -c \"$(curl -fsSL https://github.com/Homebrew/install/raw/HEAD/install.sh)\"\n# \u6216\n/bin/bash -c \"$(curl -fsSL https://mirrors.ustc.edu.cn/misc/brew-install.sh)\"\n</code></pre>"},{"location":"developer/mac/#brew","title":"brew \u56fd\u5185\u6e90\u914d\u7f6e","text":"4.0\u7248\u672c <pre><code>export HOMEBREW_BREW_GIT_REMOTE=\"https://mirrors.ustc.edu.cn/brew.git\"\nbrew update\necho 'export HOMEBREW_BREW_GIT_REMOTE=\"https://mirrors.ustc.edu.cn/brew.git\"' &gt;&gt; ~/.zshrc\necho 'export HOMEBREW_BOTTLE_DOMAIN=\"https://mirrors.ustc.edu.cn/homebrew-bottles\"' &gt;&gt; ~/.zshrc\necho 'export HOMEBREW_API_DOMAIN=\"https://mirrors.ustc.edu.cn/homebrew-bottles/api\"' &gt;&gt; ~/.zshrc\nbrew tap --custom-remote --force-auto-update homebrew/cask https://mirrors.ustc.edu.cn/homebrew-cask.git\nbrew tap --custom-remote --force-auto-update homebrew/cask-versions https://mirrors.ustc.edu.cn/homebrew-cask-versions.git\n</code></pre>"},{"location":"developer/mac/#brew-install","title":"\u53d6\u6d88brew install \u63d0\u793a\u5347\u7ea7","text":"<pre><code>export HOMEBREW_NO_AUTO_UPDATE=true\n</code></pre>"},{"location":"developer/mac/#_1","title":"\u547d\u4ee4","text":"<pre><code># \u67e5\u770b\u5df2\u5b89\u88c5\u5305\u5217\u8868\nbrew list\n# \u67e5\u8be2\u53ef\u7528\u5305\nbrew search &lt;packageName&gt;\nbrew install node\nbrew uninstall git\nbrew -v\n# \u5b89\u88c5mysql\u6307\u5b9a\u7248\u672c,\u6839\u636e\u4e0a\u9762\u7684search \u53ef\u4ee5\u627e\u5230\nbrew install mysql@5.7\n# \u542f\u52a8\u548c\u505c\u6b62\u670d\u52a1\nbrew services stop redis\nbrew services start redis\n</code></pre>"},{"location":"developer/mac/#term2lrzsz","title":"Term2\u91cclrzsz\u652f\u6301\u6587\u4ef6\u4e0a\u4f20","text":"<p><pre><code>brew install lrzsz\n</code></pre> \u521b\u5efa2\u4e2abash\u811a\u672c /usr/local/bin/term_send.sh<pre><code>#!/bin/bash\n# Author: Matt Mastracci (matthew@mastracci.com)\n# AppleScript from http://stackoverflow.com/questions/4309087/cancel-button-on-osascript-in-a-bash-script\n# licensed under cc-wiki with attribution required\n# Remainder of script public domain\nFILE=`osascript -e 'tell application \"iTerm\" to activate' -e 'tell application \"iTerm\" to set thefile to choose file with prompt \"Choose a file to send\"' -e \"do shell script (\\\"echo \\\"&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\\\"\\\")\"`\nif [[ -z \"$FILE\" ]]; then\necho Cancelled.\n    # Send ZModem cancel\necho -e \\\\x18\\\\x18\\\\x18\\\\x18\\\\x18\n    sleep 1\necho\necho \\# Cancelled transfer\nelse\necho $FILE\n/usr/local/bin/sz \"$FILE\" -E -e -b\n    sleep 1\necho \\# Received $FILE\nfi\n</code></pre></p> /usr/local/bin/term_recv.sh<pre><code>#!/usr/bin/env bash\n# vim: fdm=marker foldlevel=0 sw=2 ts=2 sts=2\nFILE=`osascript -e 'tell application \"iTerm\" to activate' -e 'tell application \"iTerm\" to set thefile to choose folder with prompt \"Choose a folder to place received files in\"' -e \"do shell script (\\\"echo \\\"&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\\\"\\\")\"`\nif [[ -z \"$FILE\" ]]; then\necho \" Cancelled\"\n# Send ZModem cancel\necho -e \\\\x18\\\\x18\\\\x18\\\\x18\\\\x18\n  sleep 1\necho\necho \" # Cancelled transfer\"\nelse\ncd \"$FILE\"\n\"${HOMEBREW_PREFIX:-/usr/local}/bin/rz\" -E -e -b\n  sleep 1\necho\necho \" # Sent -&gt; $FILE\"\necho\nfi\n</code></pre> <p>\u8bbe\u7f6eIterm2\u7684Tirgger\u7279\u6027\uff0cprofiles-&gt;default-&gt;editProfiles-&gt;Advanced\u4e2d\u7684Tirgger</p> <p>\u6dfb\u52a0\u4e24\u6761trigger\uff0c\u5206\u522b\u8bbe\u7f6e Regular expression\uff0cAction\uff0cParameters\uff0cInstant\u5982\u4e0b\uff1a \u7b2c\u4e00\u4e2atrigger<pre><code>Regular expression: rz waiting to receive.\\*\\*B0100\nAction: Run Silent Coprocess\nParameters: /usr/local/bin/term_send.sh\nInstant: checked\n</code></pre> \u7b2c\u4e8c\u4e2a<pre><code>Regular expression: \\*\\*B00000000000000\nAction: Run Silent Coprocess\nParameters: /usr/local/bin/term_recv.sh\nInstant: checked\n</code></pre></p>"},{"location":"developer/mac/#_2","title":"\u7ec8\u7aef\u5feb\u6377\u952e","text":"\u5feb\u6377\u952e \u529f\u80fd Cmd+K \u6e05\u5c4f  ,\u65e0\u6cd5\u518d\u770b\u4e4b\u524d\u7684\u8f93\u51fa\u5c4f\u5e55 Ctrl+L \u6e05\u5c4f,\u7ec8\u7aef\u5149\u6807\u79fb\u5230\u5230\u5c4f\u5e55\u4e0a\u65b9.."},{"location":"developer/mac/#u","title":"U\u76d8\u548c\u6709\u4e9b\u79fb\u52a8\u786c\u76d8","text":"<p>\u4e00\u822c\u6211\u4eec\u7684u\u76d8\u7684\u6587\u4ef6\u683c\u5f0f\u662fntfs,\u800cmac\u4e0d\u652f\u6301</p> <p><pre><code># \u63d2\u5165u\u76d8\u6216\u79fb\u52a8\u786c\u76d8\u540e\ndiskutil list\n# \u770b\u5230\u5982\u4e0b\u7684\u76d8\u7b26\n# Microsoft Basic Data \u4e4b\u540e\u7684\u5c31\u662f\u4f60\u7684\u76d8\u7b26\u7684\u540d\u79f0\u4e86\n# \u6709\u591a\u5c11\u4e2a\u4f60\u90fd\u8bb0\u4e0b\u6765( \u4e00\u822c\u6211\u4eec\u4f1a\u5c06\u79fb\u52a8\u786c\u76d8\u5206\u533a,\u5c31\u662f\u5206\u533a\u7684\u540d\u79f0\u4e86)\n/dev/disk2 (external, physical):\nMicrosoft Basic Data XYZ       1.0 TB     disk2s1\n</code></pre> \u4fee\u6539/etc/fstab, \u6dfb\u52a0\u5982\u4e0b = \u53f7\u53f3\u8fb9\u7684\u7b2c\u4e00\u4e2a\u5c31\u662f\u5199\u4f60\u7684\u76d8\u7b26\u540d\u79f0,\u6709\u591a\u5c11\u4e2a,\u5c31\u6709\u591a\u5c11\u884c <pre><code>LABEL=OPQ none ntfs rw,auto,nobrowse\nLABEL=XYZ none ntfs rw,auto,nobrowse\n</code></pre> \u6620\u5c04\u76d8\u7b26,\u5c06\u76d8\u7b26\u6620\u5c04\u5230\u684c\u9762\u5feb\u6377\u952e\u65b9\u5f0f\u4e00\u6837 <pre><code>sudo ln -s /Volumes/XYZ ~XYZsktop/XYZ\n</code></pre></p> <p>\u91cd\u542f\u7535\u8111</p>"},{"location":"developer/mac/#u_1","title":"\u9047\u5230\u590d\u5236\u5230u\u76d8\u6587\u4ef6\u53d8\u7070\u8272","text":"<pre><code># \u8868\u793a\u5220\u9664\u6587\u4ef6\u6216\u8005\u6587\u4ef6\u5939\u91cc\u9762\u7684\u6587\u4ef6\u7684 \u5c5e\u6027 com.apple.FinderInfo\n# -d \u8868\u793a\u5220\u9664, -r\u9012\u5f52\nxattr -d -r com.apple.FinderInfo *\n</code></pre> <ol> <li> <p>https://brew.sh/ \u21a9</p> </li> </ol>"},{"location":"developer/mirrors/","title":"Mirrors","text":""},{"location":"developer/mirrors/#_1","title":"\u56fd\u5185\u6e90","text":"<p>https://mirrors.huaweicloud.com/home</p>"},{"location":"developer/plantuml/","title":"Plantuml","text":""},{"location":"developer/plantuml/#mindmap","title":"mindmap","text":"<p>plantuml-mindmap</p> \u901a\u7528\u6a21\u677f<pre><code>@startmindmap\n&lt;style&gt;\n' \u901a\u7528\u8bbe\u7f6e\nnode {\n    Padding 12\n    Margin 10\n    HorizontalAlignment center\n    LineColor black\n    LineThickness 1.0\n    BackgroundColor #eab8de\n    RoundCorner 15\n    ' \u81ea\u52a8\u6362\u884c, \u6bcf\u884c\u6700\u5927\u957f\u5ea6\n    MaximumWidth 100\n    Shadowing 6.0\n    ' leafNode\u7684\u4f18\u5148\u7ea7\u66f4\u9ad8'\n    :depth(3) {\n        BackGroundColor white\n    }\n}\n' \u5728\u5916\u5c42\u4e5f\u53ef\u4ee5 \u597d\u50cf\u53ea\u5f71\u54cdnode \u7684\u6837\u5f0f\n:depth(3) {\n    BackGroundColor white\n}\nrootNode {\n    ' LineStyle 8.0;3.0\n    RoundCorner 15\n    Padding 12\n    BackgroundColor #a8eb99\n}\nleafNode {\n    LineColor gold\n    RoundCorner 15\n    ' Padding 12\n    LineColor black\n    Shadowing 4.0\n    BackgroundColor #fbe972\n}\narrow {\n    LineStyle 5\n    LineThickness 1.0\n    LineColor green\n    ' \u53ef\u8bbe\u7f6e \u5c42\u7ea7\u7684 \u7bad\u5934\u6837\u5f0f\n    :depth(1) {\n      LineColor red\n    }\n}\n' ***_ \u65e0\u6846\u6846\u7684\u8282\u70b9\u7684\u6837\u5f0f\nboxless {\n    FontColor darkgreen\n}\nlegend{\n    LineStyle 4\n    RoundCorner 1\n    BackGroundColor #f3fbec\n    LineColor #f3fbec\n    Padding 10\n    FontColor grey\n}\n' \u914d\u7f6e\u4e00\u4e2aclass(\u5f53\u6210class) \u8fd9\u6837\u53ef\u4ee5\u4fee\u6539\u67d0\u4e2anode\u7684\u6837\u5f0f\n' \u7136\u540e\u5728 node \u540e\u9762\u7684 ; \u540e\u9762 \u4f7f\u7528 &lt;&lt;rose&gt;&gt; \u5373\u53ef\n.rose {\n    BackgroundColor #FFBBCC\n    RoundCorner 1\n}\n' \u5f71\u54cd\u8be5\u8282\u70b9\u4ee5\u53ca\u5b83\u7684\u6240\u6709\u5b50\u5b59\u8282\u70b9\n.LightCyan *{\n    BackgroundColor LightCyan\n}\n.lightyellow *{\n    BackgroundColor  LightYellow\n    ' \u53ef\u4ee5\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765 \u8c03\u989c\u8272, \u5bf9\u5e94\u8fd8\u6709 darken'\n    ' BackgroundColor %lighten(LightYellow, 1)\n}\n.yellow *{\n    BackgroundColor #fbe972\n    ' \u518d\u8bbe\u7f6e\u5b83\u81ea\u5df1\u7684\u5404\u4e2a\u5c42\u7ea7\u7684\u80cc\u666f\n    ' :depth(2) {\n    '   BackgroundColor #89c6fa\n    ' }\n    ' :depth(3) {\n    '   BackgroundColor gold\n    ' }\n}\n.lightgreen *{\n    BackgroundColor  #94c644\n}\n.gold *{\n    BackgroundColor gold\n}\n&lt;/style&gt;\ncaption figure 1\ntitle My super title\n* aaa\n** bbb &lt;&lt;rose&gt;&gt;\n***_ ccc\n* dd\n** ee\n*** ff &lt;&lt;green&gt;&gt;\n****: hello\nworld;\nheader\nMy super header\nendheader\ncenter footer My super footer\nlegend right\nShort\nendlegend\n@endmindmap\n</code></pre>"},{"location":"developer/plantuml/#color","title":"color","text":""},{"location":"developer/rime/","title":"Rime","text":""},{"location":"developer/rime/#rime","title":"rime","text":"<p>Tips</p> <p>vim\u4e2d ESC\u540e\u5c31\u4f1a\u81ea\u52a8\u5207\u6362\u5230\u82f1\u6587\u6a21\u5f0f</p>"},{"location":"developer/rime/#_1","title":"\u53cc\u62fc\u8f93\u5165\u6cd5","text":"<ol> <li> <p>https://rime.im/ \u21a9</p> </li> </ol>"},{"location":"developer/shortcut/","title":"Shortcut","text":""},{"location":"developer/shortcut/#_1","title":"\u9875\u9762\u5237\u65b0","text":"<p>command+r  \u6b63\u5e38\u5237\u65b0\uff0c\u4f7f\u7528\u7f13\u5b58\u6570\u636e command+shift+r \u5f3a\u5236\u5237\u65b0,\u5f3a\u5236\u6d4f\u89c8\u5668\u91cd\u65b0\u4e0b\u8f7d\u5e76\u52a0\u8f7d\u5185\u5bb9</p>"},{"location":"developer/site/","title":"Site","text":""},{"location":"developer/site/#_1","title":"\u8bbe\u8ba1","text":""},{"location":"developer/site/#icon","title":"icon","text":"<p>iconify icones \u963f\u91cc\u5df4\u5df4\u56fe\u6807\u5e93 \u5b57\u8282\u8df3\u52a8iconPark\u56fe\u6807\u5e93</p>"},{"location":"developer/site/#_2","title":"\u514d\u8d39\u53ef\u5546\u7528\u89c6\u9891\u56fe\u7247\u7d20\u6750","text":"<p>\u9ad8\u6e05\u56fe\u7247\u7d20\u6750unsplash \u89c6\u9891\u7d20\u6750mixkit pexels pixabay picjumbo foodiesfeed\u7f8e\u98df\u56fe\u7247 stocksnap isorepublic \u65e5\u672c\u7684pakutaso \u56fe\u7247\u538b\u7f29</p>"},{"location":"developer/site/#_3","title":"\u5728\u7ebf\u7f16\u8f91\u5668","text":"<p>stackblitz</p>"},{"location":"developer/site/#_4","title":"\u5176\u4ed6","text":"<p>\u514d\u8d39\u7684\u5171\u7528\u8d26\u53f7</p>"},{"location":"developer/site/#_5","title":"\u6280\u672f\u7f51\u7ad9","text":"<p>hacker news</p>"},{"location":"developer/ssh/","title":"ssh","text":"","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/ssh/#_1","title":"\u5bc6\u94a5\u751f\u6210\u4e0e\u4e0a\u4f20","text":"<pre><code>#\u672c\u5730 \u6267\u884c ,\u751f\u6210\u5bc6\u94a5\u5bf9\nssh-keygen\n\n# \u5c06\u516c\u94a5\u4e0a\u4f20\u81f3\u8fdc\u7a0b\u670d\u52a1\u5668, \u8fd9\u4e2a\u547d\u4ee4\u9700\u8981\u80fd\u7528\u5bc6\u7801\u8fdc\u7a0b\u767b\u5f55..\n# -i \u6307\u5b9a\u516c\u94a5\u8def\u5f84\nssh-copy-id  -i ~/.ssh/id_rsa.pub  remote_user@remote_ip -p22\n# \u6267\u884c\u5b8c\u540e,\u5b9e\u9645\u4f1a\u5c06\u8be5\u516c\u94a5\u5185\u5bb9 \u653e\u5230\u8fdc\u7a0b\u670d\u52a1\u7aef\u4e0a\u7684 ~/.ssh/authorized_keys \u91cc,\n# \u4f60\u53ef\u4ee5\u624b\u52a8\u5c06\u672c\u673a\u7684\u516c\u94a5\u5185\u5bb9\u590d\u5236\u5230\u8fd9\u4e2a\u6587\u4ef6\u91cc\n# \u6ce8\u610f\u5982\u679c\u662f\u624b\u52a8\u4fee\u6539, \u8bf7\u786e\u4fdd\u6587\u4ef6\u6743\u9650\u6700\u540e\u662f600\nchmod 600 ~/.ssh/authorized_keys\n#-rw------- 1 root root  393 Oct 11 22:48 authorized_keys\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/ssh/#ssh","title":"ssh\u5feb\u6377\u8fde\u63a5\u670d\u52a1\u5668","text":"~/.ssh/config\u914d\u7f6e\u6587\u4ef6\u6dfb\u52a0<pre><code>Host dev\n  HostName 192.168.1.100\n  Port 22\n  User root\n  IdentityFile ~/.ssh/id_rsa\n</code></pre> \u7b80\u5355\u7684\u547d\u4ee4\u5c31\u8fde\u63a5\u670d\u52a1\u5668<pre><code>ssh dev\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/ssh/#github","title":"\u591a\u4e2agithub\u8d26\u53f7\u5982\u4f55\u8fde\u63a5","text":"<p>Note</p> <p>\u5176\u5b9e\u548c\u4e0a\u9762\u662f\u4e00\u6837\u7684 \u4e0d\u540c\u7684github\u8d26\u53f7\u5728github\u4e0a\u4e0d\u80fd\u4f7f\u7528\u540c\u4e00\u4e2a\u516c\u94a5, \u800c\u4f60\u53c8\u9700\u8981\u5728\u4e00\u4e2a\u673a\u5668\u4e0a\u63d0\u4ea4\u4e1c\u897f\u5230\u4e0d\u540c\u7684github\u8d26\u53f7\u7684\u4ed3\u5e93</p> <pre><code># \u5982\u679c\u4e0d\u5e26 -f \u6307\u5b9a\u6587\u4ef6\u540d ,\u90a3\u4e48\u56de\u8f66,\u9700\u8981\u586b\u5165\u4e00\u4e2a\u540d\u79f0,\u5426\u5219\u6587\u4ef6\u540d\u90fd\u662fid_rsa ,\u4f1a\u5bfc\u81f4\u8986\u76d6\u539f\u6709\u7684 id_rsa\nssh-keygen -t rsa -C \"\u6ce8\u91ca\u4fe1\u606f,\u4f60\u53ef\u4ee5\u5199\u4f60\u7684\u90ae\u7bb1\u7b49\" -f \"\u6587\u4ef6\u540d\"\n</code></pre> ~/.ssh/config\u914d\u7f6e\u6587\u4ef6\u6dfb\u52a0<pre><code>Host gh1\n  HostName github.com\n  Port 22\n  User root\n  IdentityFile ~/.ssh/gh1.id_rsa  # \u751f\u6210\u7684\u79c1\u94a51\n\nHost gh2\n  HostName github.com\n  Port 22\n  User root\n  IdentityFile ~/.ssh/gh2.id_rsa #\u751f\u6210\u7684\u79c1\u94a52\n</code></pre> <pre><code># \u9700\u8981\u5c06 \u6839\u636e\u4f60\u7684\u4ed3\u5e93\u5730\u5740,\u5c06github.com \u6539\u6210gh1\u6216gh2\ngit clone git@github.com:tom/abc.git\n#==&gt; \u8fd9\u6837\u5c31\u4f1a\u533agh1\u914d\u7f6e\u91cc\u4f7f\u7528\u7684\u5bc6\u94a5\u5bf9,\u53bb\u5bf9\u5e94\u7684github\u5e10\u53f7clone\ngit clone git@gh1:tom/abc.git\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/ssh/#ssh-mysql","title":"\u901a\u8fc7ssh\u96a7\u9053 \u8fde\u63a5mysql","text":"<p>\u670d\u52a1\u5668\u8bf4\u660e</p> <ol> <li>\u8fdc\u7a0b\u670d\u52a1\u5668A, \u8fd9\u4e2a\u4f60\u53ef\u4ee5ssh\u8fde\u63a5\u7684</li> <li>mysql\u670d\u52a1\u5668, \u4f60\u65e0\u6cd5\u5916\u90e8\u8bbf\u95ee, \u670d\u52a1\u5668A\u53ef\u4ee5\u8bbf\u95eemysql\u670d\u52a1\u5668</li> <li>\u4f60\u60f3\u8981\u5728\u672c\u5730\u8fde\u63a5\u8fd9\u4e2amysql, \u6bd4\u5982\u7528navicat\u76f4\u63a5\u770b,\u600e\u4e48\u529e\u5462?</li> </ol> <p>navicat \u672c\u8eab\u53ef\u4ee5\u8bbe\u7f6essh\u96a7\u9053. \u8fd9\u91cc\u6211\u7528\u672c\u5730\u6620\u5c04\u7684\u65b9\u5f0f</p> <pre><code># -f \u5fc5\u987b\u5e26\u4e0a, \u8868\u793a\u8f6c\u5230\u540e\u53f0\n# \u5c06\u8fdc\u7a0b\u7684mysql\u7aef\u53e3\u6620\u5c04\u5230\u672c\u5730\u76843307,\u8fd9\u6837\u672c\u5730\u5c31\u53ef\u4ee5\u76f4\u63a5\u8fde\u4e86\nssh -fN -L3307:remotemysqlip:3306 A\u670d\u52a1\u5668\u7528\u6237\u540d@A\u7684ip\nlsof -i:3307 # \u67e5\u770b\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/ssh/#_2","title":"\u901a\u8fc7\u5821\u5792\u673a\u8fde\u63a5\u5185\u90e8\u670d\u52a1\u5668","text":"<p>Note</p> <p>\u4e00\u5e2e\u60c5\u51b5\u4e0b, \u4f60\u9700\u8981\u767b\u5f55\u7f51\u9875,\u8f93\u5165\u5bc6\u7801, \u7136\u540e\u9009\u62e9\u4f60\u8981\u8fde\u63a5\u7684\u670d\u52a1\u5668 (\u6211\u5de5\u4f5c\u4e2d\u7684\u5b9e\u9645\u60c5\u51b5) \u5f88\u9ebb\u70e6. \u8fd9\u91cc\u8bbe\u7f6e \u76f4\u63a5\u672c\u5730 ssh dev \u5373\u53ef\u8fde\u63a5 (\u5982\u679c\u9700\u8981vpn\u7684, \u90a3\u4e48vpn\u5f97\u5148\u8fde\u4e0a)</p> \u914d\u7f6e~/.ssh/config\u6587\u4ef6 \u589e\u52a0<pre><code>Host baolei\n    HostName \u5821\u5792\u673aip\n    User \u5821\u5792\u673a\u8d26\u6237\n    Port \u8fde\u63a5\u5821\u5792\u673a\u7684\u7aef\u53e3\n    IdentityFile ~/.ssh/id_rsa  # \u4e0a\u4f20\u7ed9\u5821\u5792\u673a\u516c\u94a5\u5bf9\u5e94\u7684\u79c1\u94a5\nHost dev\n    HostName \u5821\u5792\u673a\u53ef\u4ee5\u8fde\u63a5\u7684\u5185\u90e8\u670d\u52a1\u5668ip\n    User \u5821\u5792\u673a\u8fde\u63a5\u5185\u90e8\u670d\u52a1\u5668\u7684\u7528\u6237\n    Port \u5821\u5792\u673a\u8fde\u63a5\u5185\u90e8\u670d\u52a1\u5668\u4f7f\u7528\u7684\u7aef\u53e3\n    #\u8fd9\u4e2a\u4e0d\u9700\u8981\u8bbe\u7f6e \u5821\u5792\u673a\u4f30\u8ba1\u5df2\u7ecf\u8bbe\u7f6e ssh \u76f4\u63a5\u8bbf\u95ee dev\u670d\u52a1\u5668. \u6240\u4ee5\u4e0d\u7528\n    #IdentityFile ~/.ssh/id_rsa\n    ProxyCommand ssh \u5821\u5792\u673a\u8d26\u6237@baolei -W %h:%p\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/tcpdump/","title":"Tcpdump","text":"<p>Note</p> <p>todo...</p>"},{"location":"developer/tcpdump/#_1","title":"\u76d1\u542c\u4e00\u4e2a\u7f51\u5361","text":"<pre><code>tcpdump -v -i eth1\n# \u5c06\u6570\u636e\u4fdd\u5b58\ntcpdump -v -i eth1 -w tt.pcap\n</code></pre>"},{"location":"developer/tcpdump/#_2","title":"\u6307\u5b9a\u7aef\u53e3","text":"<pre><code>tcpdump -i en1 tcp port  80\n</code></pre>"},{"location":"developer/tcpdump/#_3","title":"\u6307\u5b9a\u7f51\u7ad9","text":"<pre><code># \u6253\u5f00\u4e00\u4e2a\u7ec8\u7aef\u7a97\u53e3\ntcpdump -S -i en1  host www.baidu.com and tcp port  80\n# \u6253\u5f00\u53e6\u5916\u4e00\u4e2a\u7a97\u53e3\ncurl www.baidu.com\n# \u5c31\u53ef\u4ee5\u770b\u5230\u4e86.\n# \u25cf S : syn\n# \u25cf .  : ack\n# \u25cf p \u6570\u636e\u5305\n# \u25cf F  : finish\n</code></pre>"},{"location":"developer/tcpdump/#_4","title":"\u53c2\u6570","text":"<pre><code># -XX  \u663e\u793a16\u8fdb\u5236\u4e0eascii \ntcpdump -D # \u67e5\u770b\u5f53\u524d\u6709\u591a\u5c11\u7aef\u53e3\u53ef\u4ee5\u770b\u7684\ntcpdump -L # \n</code></pre>"},{"location":"developer/tcpdump/#web","title":"\u672c\u5730web\u670d\u52a1\u7684\u6293\u5305","text":"<ul> <li>\u6ce8\u610f\u662flo0 (mac \u673a\u5668\u4e0a\u7684) \u8fd9\u4e2a\u662flocal \u672c\u5730\u4e3b\u673a\u6216\u8bf4\u56de\u73af\u63a5\u53e3 ,\u4e0d\u662f\u4ee5\u592a\u574a</li> <li>eth0: ethernet\u7684\u7b80\u5199\uff0c\u4e00\u822c\u7528\u4e8e\u4ee5\u592a\u7f51\u63a5\u53e3</li> </ul> <pre><code>tcpdump -XX -e  -S -n -i lo0  host 127.0.0.1  and tcp port  8080\n</code></pre>"},{"location":"developer/terminal/","title":"terminal","text":""},{"location":"developer/terminal/#zshohmyzsh","title":"zsh+ohmyzsh","text":""},{"location":"developer/terminal/#iterm2","title":"iterm2","text":""},{"location":"developer/terminal/#_1","title":"\u53d1\u9001\u547d\u4ee4\u5230\u6240\u6709\u7a97\u53e3","text":"<p><code>command+shift+i</code> \u70b9\u51fb\u786e\u5b9a</p> <p><code>command+shift+i</code> \u70b9\u51fb\u53d6\u6d88\u5373\u53ef (\u5982\u679c\u4e0a\u9762\u5df2\u7ecf\u70b9\u51fb\u4e0d\u7528\u63d0\u793a\u7684\u8bdd,\u8fd9\u91cc \u4e0d\u4f1a\u6709\u4e1c\u897f\u5f39\u51fa\u6765, \u76f4\u63a5\u5c31\u5df2\u7ecf\u53d6\u6d88\u53d1\u9001\u5230\u591a\u4e2a\u7a97\u53e3\u4e86)</p> <ol> <li> <p>\u79d1\u5927\u6e90 \u21a9</p> </li> </ol>"},{"location":"developer/tool/","title":"Tool","text":""},{"location":"developer/tool/#ffmpeg","title":"ffmpeg","text":""},{"location":"developer/tool/#_1","title":"\u591a\u4e2a\u89c6\u9891\u5408\u5e76\u6210\u4e00\u4e2a","text":"<pre><code># \u5f53\u524d\u6587\u4ef6\u76ee\u5f55\u4e0b \u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\nfile.txt\n# \u91cc\u9762\u7684\u5185\u5bb9\u662f\nfile 'a.mp4'\nfile 'out.mp4'\n# \u5c062\u4e2a\u89c6\u9891\u5408\u5e76\u6210\u4e86\u4e00\u4e2a\nffmpeg -f concat -i file.txt  -c copy c.mp4\n</code></pre>"},{"location":"developer/tool/#_2","title":"\u526a\u5207","text":"<pre><code>ffmpeg -i a.mp4  -ss 00:01:00 -to 02:00:00 -c copy out.mp4\n</code></pre>"},{"location":"developer/tool/#asciinema","title":"\u7ec8\u7aef\u5f55\u5236\u5de5\u5177asciinema","text":"<ol> <li> <p>ffmpeg \u21a9</p> </li> <li> <p>asciinema \u21a9</p> </li> </ol>"},{"location":"developer/vim/","title":"vim","text":""},{"location":"developer/vim/#_1","title":"\u914d\u7f6e","text":"<pre><code>\" basic settings\nset history=500\nset shortmess=atI   \" \u542f\u52a8\u7684\u65f6\u5019\u4e0d\u663e\u793a\u90a3\u4e2a\u63f4\u52a9\u4e4c\u5e72\u8fbe\u513f\u7ae5\u7684\u63d0\u793a \n\" Use Vim settings, rather than Vi settings (much better!).\n\" This must be first, because it changes other options as a side effect.\nset nocompatible  \"\u53bb\u6389\u8ba8\u538c\u7684\u6709\u5173vi\u4e00\u81f4\u6027\u6a21\u5f0f\uff0c\u907f\u514d\u4ee5\u524d\u7248\u672c\u7684\u4e00\u4e9bbug\u548c\u5c40\u9650\nset nobackup \"\u4e0d\u5907\u4efd\nset ruler       \" show the cursor position all the time\nset showcmd     \" display incomplete commands\nset incsearch       \" do incremental searching\nset nu\nset foldenable      \" \u5141\u8bb8\u6298\u53e0  \nset foldmethod=manual   \" \u624b\u52a8\u6298\u53e0 \n\"Always show current position\nset ruler\n\" Height of the command bar\nset cmdheight=2\nsyntax on\n\nlet $LANG='en'\nset langmenu=en\nlet g:coc_global_extensions = [\n  \\  \"coc-explorer\",\n  \\  \"coc-translator\",\n  \\  \"coc-python\",\n  \\  \"coc-vimlsp\",\n  \\ \"coc-gitignore\",\n  \\  \"coc-json\",\n  \\  \"coc-rust-analyzer\",\n  \\  \"coc-go\",\n  \\  \"coc-yaml\",\n  \\  \"coc-syntax\",\n  \\  \"coc-html\"\n\\ ]\nautocmd BufWritePre *.go :silent call CocAction('runCommand', 'editor.action.organizeImport')\ninoremap &lt;silent&gt;&lt;expr&gt; &lt;TAB&gt;\n      \\ pumvisible() ? \"\\&lt;C-n&gt;\" :\n      \\ &lt;SID&gt;check_back_space() ? \"\\&lt;TAB&gt;\" :\n      \\ coc#refresh()\ninoremap &lt;expr&gt;&lt;S-TAB&gt; pumvisible() ? \"\\&lt;C-p&gt;\" : \"\\&lt;C-h&gt;\"\nfunction! s:check_back_space() abort\n  let col = col('.') - 1\n  return !col || getline('.')[col - 1]  =~# '\\s'\nendfunction\n\" \u63d0\u793a \u4e3b\u52a8\u7684\u5feb\u6377\u952e\nif has('nvim')\n  inoremap &lt;silent&gt;&lt;expr&gt; &lt;c-o&gt; coc#refresh()\nelse\n  inoremap &lt;silent&gt;&lt;expr&gt; &lt;c-o&gt; coc#refresh()\nendif\nnmap &lt;silent&gt; [g &lt;Plug&gt;(coc-diagnostic-prev)\nnmap &lt;silent&gt; ]g &lt;Plug&gt;(coc-diagnostic-next)\ninoremap &lt;silent&gt;&lt;expr&gt; &lt;cr&gt; pumvisible() ? coc#_select_confirm()\n                              \\: \"\\&lt;C-g&gt;u\\&lt;CR&gt;\\&lt;c-r&gt;=coc#on_enter()\\&lt;CR&gt;\"\n\" GoTo code navigation.\nnmap &lt;silent&gt; gd &lt;Plug&gt;(coc-definition)\nnmap &lt;silent&gt; gy &lt;Plug&gt;(coc-type-definition)\nnmap &lt;silent&gt; gi &lt;Plug&gt;(coc-implementation)\nnmap &lt;silent&gt; gr &lt;Plug&gt;(coc-references)\n\n\" Use K to show documentation in preview window.\n\"nnoremap &lt;silent&gt; &lt;LEADER&gt;h :call &lt;SID&gt;show_documentation()&lt;CR&gt;\n\nnnoremap &lt;silent&gt; K :call &lt;SID&gt;show_documentation()&lt;CR&gt;\nnnoremap tt :CocCommand explorer&lt;CR&gt;\n\" coc-translator\nnmap ts &lt;Plug&gt;(coc-translator-p)\nfunction! s:show_documentation()\n  if (index(['vim','help'], &amp;filetype) &gt;= 0)\n    execute 'h '.expand('&lt;cword&gt;')\n  elseif (coc#rpc#ready())\n    call CocActionAsync('doHover')\n  else\n    execute '!' . &amp;keywordprg . \" \" . expand('&lt;cword&gt;')\n  endif\nendfunction\nxmap &lt;leader&gt;a  &lt;Plug&gt;(coc-codeaction-selected)\nnmap &lt;leader&gt;a  &lt;Plug&gt;(coc-codeaction-selected)\n\" Highlight the symbol and its references when holding the cursor.\nautocmd CursorHold * silent call CocActionAsync('highlight')\n\n\" Symbol renaming.\nnmap &lt;leader&gt;rn &lt;Plug&gt;(coc-rename)\n\n\" Formatting selected code.\nxmap &lt;leader&gt;f  &lt;Plug&gt;(coc-format-selected)\nnmap &lt;leader&gt;f  &lt;Plug&gt;(coc-format-selected)\n\naugroup mygroup\n  autocmd!\n  \" Setup formatexpr specified filetype(s).\n  autocmd FileType typescript,json setl formatexpr=CocAction('formatSelected')\n  \" Update signature help on jump placeholder.\n  autocmd User CocJumpPlaceholder call CocActionAsync('showSignatureHelp')\naugroup end\n\n\" Applying codeAction to the selected region.\n\" Example: `&lt;leader&gt;aap` for current paragraph\nxmap &lt;leader&gt;a  &lt;Plug&gt;(coc-codeaction-selected)\nnmap &lt;leader&gt;a  &lt;Plug&gt;(coc-codeaction-selected)\n\n\" Remap keys for applying codeAction to the current buffer.\nnmap &lt;leader&gt;ac  &lt;Plug&gt;(coc-codeaction)\n\" Apply AutoFix to problem on the current line.\nnmap &lt;leader&gt;qf  &lt;Plug&gt;(coc-fix-current)\n\n\" Run the Code Lens action on the current line.\nnmap &lt;leader&gt;cl  &lt;Plug&gt;(coc-codelens-action)\n\n\" Map function and class text objects\n\" NOTE: Requires 'textDocument.documentSymbol' support from the language server.\nxmap if &lt;Plug&gt;(coc-funcobj-i)\nomap if &lt;Plug&gt;(coc-funcobj-i)\nxmap af &lt;Plug&gt;(coc-funcobj-a)\nomap af &lt;Plug&gt;(coc-funcobj-a)\nxmap ic &lt;Plug&gt;(coc-classobj-i)\nomap ic &lt;Plug&gt;(coc-classobj-i)\nxmap ac &lt;Plug&gt;(coc-classobj-a)\nomap ac &lt;Plug&gt;(coc-classobj-a)\n\n\" Remap &lt;C-f&gt; and &lt;C-b&gt; for scroll float windows/popups.\nif has('nvim-0.4.0') || has('patch-8.2.0750')\n  nnoremap &lt;silent&gt;&lt;nowait&gt;&lt;expr&gt; &lt;C-f&gt; coc#float#has_scroll() ? coc#float#scroll(1) : \"\\&lt;C-f&gt;\"\n  nnoremap &lt;silent&gt;&lt;nowait&gt;&lt;expr&gt; &lt;C-b&gt; coc#float#has_scroll() ? coc#float#scroll(0) : \"\\&lt;C-b&gt;\"\n  inoremap &lt;silent&gt;&lt;nowait&gt;&lt;expr&gt; &lt;C-f&gt; coc#float#has_scroll() ? \"\\&lt;c-r&gt;=coc#float#scroll(1)\\&lt;cr&gt;\" : \"\\&lt;Right&gt;\"\n  inoremap &lt;silent&gt;&lt;nowait&gt;&lt;expr&gt; &lt;C-b&gt; coc#float#has_scroll() ? \"\\&lt;c-r&gt;=coc#float#scroll(0)\\&lt;cr&gt;\" : \"\\&lt;Left&gt;\"\n  vnoremap &lt;silent&gt;&lt;nowait&gt;&lt;expr&gt; &lt;C-f&gt; coc#float#has_scroll() ? coc#float#scroll(1) : \"\\&lt;C-f&gt;\"\n  vnoremap &lt;silent&gt;&lt;nowait&gt;&lt;expr&gt; &lt;C-b&gt; coc#float#has_scroll() ? coc#float#scroll(0) : \"\\&lt;C-b&gt;\"\nendif\n\n\" Use CTRL-S for selections ranges.\n\" Requires 'textDocument/selectionRange' support of language server.\nnmap &lt;silent&gt; &lt;C-s&gt; &lt;Plug&gt;(coc-range-select)\nxmap &lt;silent&gt; &lt;C-s&gt; &lt;Plug&gt;(coc-range-select)\n\n\" Add `:Format` command to format current buffer.\ncommand! -nargs=0 Format :call CocActionAsync('format')\n\n\" Add `:Fold` command to fold current buffer.\ncommand! -nargs=? Fold :call     CocAction('fold', &lt;f-args&gt;)\n\n\" Add `:OR` command for organize imports of the current buffer.\ncommand! -nargs=0 OR   :call     CocActionAsync('runCommand', 'editor.action.organizeImport')\n\n\" Add (Neo)Vim's native statusline support.\n\" NOTE: Please see `:h coc-status` for integrations with external plugins that\n\" provide custom statusline: lightline.vim, vim-airline.\nset statusline^=%{coc#status()}%{get(b:,'coc_current_function','')}\n\n\" Mappings for CoCList\n\" Show all diagnostics.\nnnoremap &lt;silent&gt;&lt;nowait&gt; &lt;space&gt;a  :&lt;C-u&gt;CocList diagnostics&lt;cr&gt;\n\" Manage extensions.\nnnoremap &lt;silent&gt;&lt;nowait&gt; &lt;space&gt;e  :&lt;C-u&gt;CocList extensions&lt;cr&gt;\n\" Show commands.\nnnoremap &lt;silent&gt;&lt;nowait&gt; &lt;space&gt;c  :&lt;C-u&gt;CocList commands&lt;cr&gt;\n\" Find symbol of current document.\nnnoremap &lt;silent&gt;&lt;nowait&gt; &lt;space&gt;o  :&lt;C-u&gt;CocList outline&lt;cr&gt;\n\" Search workspace symbols.\nnnoremap &lt;silent&gt;&lt;nowait&gt; &lt;space&gt;s  :&lt;C-u&gt;CocList -I symbols&lt;cr&gt;\n\" Do default action for next item.\nnnoremap &lt;silent&gt;&lt;nowait&gt; &lt;space&gt;j  :&lt;C-u&gt;CocNext&lt;CR&gt;\n\" Do default action for previous item.\nnnoremap &lt;silent&gt;&lt;nowait&gt; &lt;space&gt;k  :&lt;C-u&gt;CocPrev&lt;CR&gt;\n\" Resume latest coc list.\nnnoremap &lt;silent&gt;&lt;nowait&gt; &lt;space&gt;p  :&lt;C-u&gt;CocListResume&lt;CR&gt;\n\"set clipboard+=unnamed\n\n\" Turn on the WiLd menu\n\"set wildmenu\n\n\" Ignore compiled files\n\"set wildignore=*.o,*~,*.pyc\n\"if has(\"win16\") || has(\"win32\")\n\"    set wildignore+=.git\\*,.hg\\*,.svn\\*\n\"else\n\"    set wildignore+=*/.git/*,*/.hg/*,*/.svn/*,*/.DS_Store\n\"endif\n\n\" When started as \"evim\", evim.vim will already have done these settings.\nif v:progname =~? \"evim\"\n  finish\nendif\n\n\" allow backspacing over everything in insert mode\nset backspace=indent,eol,start\n  \"set undofile     \" keep an undo file (undo changes after closing)\n\n\" Don't use Ex mode, use Q for formatting\nmap Q gq\n\n\" CTRL-U in insert mode deletes a lot.  Use CTRL-G u to first break undo,\n\" so that you can undo CTRL-U after inserting a line break.\ninoremap &lt;C-U&gt; &lt;C-G&gt;u&lt;C-U&gt;\n\" In many terminal emulators the mouse works just fine, thus enable it.\nif has('mouse')\n  \"set mouse=a\nendif\n\" Switch syntax highlighting on, when the terminal has colors\n\" Also switch on highlighting the last used search pattern.\nif &amp;t_Co &gt; 2 || has(\"gui_running\")\n  syntax on\n  set hlsearch\nendif\n\n\" Only do this part when compiled with support for autocommands.\nif has(\"autocmd\")\n\n  \" Enable file type detection.\n  \" Use the default filetype settings, so that mail gets 'tw' set to 72,\n  \" 'cindent' is on in C files, etc.\n  \" Also load indent files, to automatically do language-dependent indenting.\n  filetype plugin indent on\n\n  \" Put these in an autocmd group, so that we can delete them easily.\n  augroup vimrcEx\n  au!\n\n  \" For all text files set 'textwidth' to 78 characters.\n  autocmd FileType text setlocal textwidth=78\n\n  \" When editing a file, always jump to the last known cursor position.\n  \" Don't do it when the position is invalid or when inside an event handler\n  \" (happens when dropping a file on gvim).\n  \" Also don't do it when the mark is in the first line, that is the default\n  \" position when opening a file.\n  autocmd BufReadPost *\n    \\ if line(\"'\\\"\") &gt; 1 &amp;&amp; line(\"'\\\"\") &lt;= line(\"$\") |\n    \\   exe \"normal! g`\\\"\" |\n    \\ endif\n\n  augroup END\n\nelse\n\n  set autoindent        \" always set autoindenting on\n\nendif \" has(\"autocmd\")\n\n\" Convenient command to see the difference between the current buffer and the\n\" file it was loaded from, thus the changes you made.\n\" Only define it when not defined already.\nif !exists(\":DiffOrig\")\n  command DiffOrig vert new | set bt=nofile | r ++edit # | 0d_ | diffthis\n          \\ | wincmd p | diffthis\nendif\n\" rust\nautocmd Filetype rust set foldmethod=syntax\n\n\" SYNTAX HIGHLIGHTING:\nset t_Co=256\n\"syntax on\n\"colorscheme ir_black\nset bs=2\nfiletype off                  \" required\n\" set the runtime path to include Vundle and initialize\n\"set rtp+=~/.vim/bundle/Vundle.vim\n\"call vundle#begin()\n\"call vundle#begin('~/some/path/here')\ncall plug#begin()\n\"Plugin 'VundleVim/Vundle.vim'\nPlug 'jiangmiao/auto-pairs'\nPlug 'tomtom/tcomment_vim'  \"in &lt;space&gt;cn to comment a line\n\" type yskw' to wrap the word with '' or type cs'` to change 'word' to `word`\nPlug 'tpope/vim-surround' \n\" in Visual mode, type k' to select all text in '', or type k) k] k} kp\nPlug 'gcmt/wildfire.vim' \nPlug 'ryanoasis/vim-devicons'\nPlug 'tpope/vim-fugitive'\nPlug 'bling/vim-airline'\n\" \u5728 Vim \u4e2d\u5feb\u901f\u5bfc\u822a\u6587\u4ef6,\u597d\u50cf\u9700\u8981ruby\u652f\u6301,\u6682\u65f6\u4e0d\u6309\u7167\n\" Plugin 'git://git.wincent.com/command-t.git'\n\"Plug 'rstacruz/sparkup', {'rtp': 'vim/'}\nPlug 'rust-lang/rust.vim'\n\"Bundle 'Rykka/riv.vim'\nPlug 'ctrlpvim/ctrlp.vim'\nPlug 'nvim-treesitter/nvim-treesitter'\n\" pretty dress\nPlug 'theniceboy/nvim-deus'\nPlug 'scrooloose/nerdtree'\nPlug 'neoclide/coc.nvim', {'branch': 'release'}\nPlug 'wellle/tmux-complete.vim'\n\n\" \u8fd9\u4e2a\u63d2\u4ef6\u53ef\u4ee5\u663e\u793a\u6587\u4ef6\u7684 Git \u589e\u5220\u72b6\u6001\nPlug 'Xuyuanp/nerdtree-git-plugin'\n\"Plugin 'user/L9', {'name': 'newL9'}\n\"Plug 'scrooloose/syntastic'\nPlug 'tpope/vim-markdown'\nPlug 'mattn/emmet-vim'\nPlug 'kien/rainbow_parentheses.vim'\nPlug 'godlygeek/tabular'\nPlug 'Yggdroot/indentLine'\nPlug 'majutsushi/tagbar'\nPlug 'junegunn/fzf', { 'do': { -&gt; fzf#install() } }\ncall plug#end()\n\n\"call vundle#end()            \" required\nfiletype plugin indent on    \" required\nset guifont=Droid\\ Sans\\ Mono\\ for\\ Powerline\\ Plus\\ Nerd\\ File\\ Types\\ 12\nset nu\nlet mapleader=';'\nautocmd InsertLeave * if pumvisible() == 0|pclose|endif \"\u79bb\u5f00\u63d2\u5165\u6a21\u5f0f\u540e\u81ea\u52a8\u5173\u95ed\u9884\u89c8\u7a97\u53e3\n\"autocmd FileType php set omnifunc=phpcomplete#CompletePHP\nset shiftwidth=4\nset tabstop=4\nset softtabstop=4\nset expandtab                  \"\u5c06tab\u66ff\u6362\u4e3a\u76f8\u5e94\u6570\u91cf\u7a7a\u683c\nset smartindent\nset encoding=utf8               \"\u8bbe\u7f6e\u5185\u90e8\u7f16\u7801\u4e3autf8\nset fileencoding=utf8            \"\u5f53\u524d\u7f16\u8f91\u7684\u6587\u4ef6\u7f16\u7801\nset fileencodings=uft8-bom,utf8,gbk,gb2312,big5   \"\u6253\u5f00\u652f\u6301\u7f16\u7801\u7684\u6587\u4ef6\nset backspace=2               \"\u53ef\u968f\u65f6\u7528\u5012\u9000\u952e\u5220\u9664\n\"imap ;; &lt;ESC&gt;\n\"cmap ;; &lt;ESC&gt;\nvmap &lt;C-c&gt; \"+y\nset cursorline\nset hlsearch\nset incsearch\nset showmatch\nset report=0\nset laststatus=2\nlet g:airline_powerline_fonts = 1\n\"let g:airline_symbols\n\"let g:airline_left_sep='\u25b6'\n\"let g:airline_right_sep='\u25c0'\nlet g:airline#extensions#tabline#enabled = 1\nsyntax enable\n\" \u5982\u679c\u662f\u5728xshell\u4e0bvim \u8fd9\u91cc\u9700\u8981\u6253\u5f00\n\" \u767e\u5ea6\u641c\u7d22 xshell vim solarized\nlet g:solarized_termcolors=256\nset background=dark\ncolorscheme solarized\nlet g:ctrlp_map = '&lt;c-p&gt;'\nlet g:ctrlp_cmd = 'CtrlP'\nlet g:ctrlp_working_path_mode = 'ra'\nset wildignore+=*/tmp/*,*.so,*.swp,*.zip     \" MacOSX/Linux\nset wildignore+=*\\\\tmp\\\\*,*.swp,*.zip,*.exe  \" Windows\n\n\"let g:ctrlp_custom_ignore = '\\v[\\/]\\.(git|hg|svn)$'\nlet g:ctrlp_custom_ignore = {\n  \\ 'dir':  '\\v[\\/]\\.(git|hg|svn)$',\n  \\ 'file': '\\v\\.(exe|so|dll)$',\n  \\ 'link': 'some_bad_symbolic_links',\n  \\}\nmap &lt;F3&gt; :NERDTreeToggle&lt;CR&gt;\n\" \u53ef\u76f4\u63a5\u590d\u5236\u5230\u7cfb\u7edf\u526a\u8d34\u677f\nset clipboard=unnamed\n\"autocmd vimenter * NERDTree\nlet g:NERDTreeDirArrowExpandable = '\u2764'\nlet g:NERDTreeDirArrowCollapsible = '\u25bc'\nlet g:NERDTreeGitStatusIndicatorMapCustom= {\n    \\ \"Modified\"  : \"\u2739\",\n    \\ \"Staged\"    : \"\u271a\",\n    \\ \"Untracked\" : \"\u272d\",\n    \\ \"Renamed\"   : \"\u279c\",\n    \\ \"Unmerged\"  : \"\u2550\",\n    \\ \"Deleted\"   : \"\u2716\",\n    \\ \"Dirty\"     : \"\u2717\",\n    \\ \"Clean\"     : \"\u2714\ufe0e\",\n    \\ \"Unknown\"   : \"?\"\n    \\ }\nlet g:autoclose_vim_commentmode = 1\nset statusline+=%#warningmsg#\nset statusline+=%{SyntasticStatuslineFlag()}\nset statusline+=%*\n\nlet g:syntastic_always_populate_loc_list = 1\nlet g:syntastic_auto_loc_list = 1\nlet g:syntastic_check_on_open = 1\nlet g:syntastic_check_on_wq = 0\nlet g:user_emmet_install_global = 0\nlet g:syntastic_ignore_files=[\".*\\.rst$\"]\nautocmd FileType html,css EmmetInstall\nlet g:rbpt_colorpairs = [\n    \\ ['brown',       'RoyalBlue3'],\n    \\ ['Darkblue',    'SeaGreen3'],\n    \\ ['darkgray',    'DarkOrchid3'],\n    \\ ['darkgreen',   'firebrick3'],\n    \\ ['darkcyan',    'RoyalBlue3'],\n    \\ ['darkred',     'SeaGreen3'],\n    \\ ['darkmagenta', 'DarkOrchid3'],\n    \\ ['brown',       'firebrick3'],\n    \\ ['gray',        'RoyalBlue3'],\n    \\ ['black',       'SeaGreen3'],\n    \\ ['darkmagenta', 'DarkOrchid3'],\n    \\ ['Darkblue',    'firebrick3'],\n    \\ ['darkgreen',   'RoyalBlue3'],\n    \\ ['darkcyan',    'SeaGreen3'],\n    \\ ['darkred',     'DarkOrchid3'],\n    \\ ['red',         'firebrick3'],\n    \\ ]\nlet g:rbpt_max = 36\nlet g:rbpt_loadcmd_toggle = 0\nau VimEnter * RainbowParenthesesToggle\nau Syntax * RainbowParenthesesLoadRound\nau Syntax * RainbowParenthesesLoadSquare\nau Syntax * RainbowParenthesesLoadBraces\n\"let g:indent_guides_auto_colors = 1\n\"let g:indent_guides_enable_on_vim_startup = 1\nlet g:indentLine_color_term = 239\nlet g:indentLine_enabled = 1\n\"ctrlp\nnnoremap &lt;silent&gt; &lt;Leader&gt;f :CtrlPMRU&lt;CR&gt;\nnnoremap &lt;silent&gt; &lt;Leader&gt;b :CtrlPBuffer&lt;CR&gt;\n\" \u7a97\u53e3\u5207\u6362\nnnoremap &lt;c-h&gt; &lt;c-w&gt;h\nnnoremap &lt;c-l&gt; &lt;c-w&gt;l\nnnoremap &lt;c-j&gt; &lt;c-w&gt;j\nnnoremap &lt;c-k&gt; &lt;c-w&gt;k\n\n\"\u8bbe\u7f6e\u64a4\u9500\u7684\u76ee\u5f55\nset undodir=/tmp/vimundodir \nnnoremap &lt;Leader&gt;w :w&lt;CR&gt;\nnnoremap &lt;Leader&gt;q :q&lt;CR&gt;\ninoremap &lt;c-a&gt; &lt;ESC&gt;0i\n\"inoremap &lt;c-e&gt; &lt;ESC&gt;$a\n\"map &lt;F5&gt; :!javac %&amp;&amp;java %:r &lt;CR&gt;\nhi MatchParen cterm=bold ctermbg=none ctermfg=magenta\nlet g:UltiSnipsExpandTrigger=\"&lt;c-y&gt;\"\n\"let g:vimim_cloud = 'sogou'\n\n\"tagbar settings\n\" vim php\u6587\u4ef6\u65f6,\u6309\u4e0bF8\u5373\u53ef\n\" http://ctags.sourceforge.net/\n\" \u8fdb\u5165\u67d0\u4e2acode\u76ee\u5f55 ctags -R \u751f\u6210tags\n\" \" \u8fdb\u5165\u4ee3\u7801\u76ee\u5f55 ctags -R \u751f\u6210tags\u6587\u4ef6\n\" \u6253\u5f00\u4ee3\u7801  F8 \u5373\u53ef\u6253\u5f00\u53f3\u4fa7\n\" ctrl + ] \u8df3\u8f6c\u5b9a\u4e49\n\" ctrl + t \u8c03\u56de\u539f\u6765\u7684\u5730\u65b9\n\" nmap \u8868\u793a \u6b63\u5e38\u6a21\u5f0f, n normal\n\"nmap &lt;M-d&gt; &lt;ctrl-]&gt; \n\" \u914d\u7f6e\u63d2\u5165\u6a21\u5f0f\u4e0b \u4e5f\u4f7f\u7528ctrl+] \u6765\u8df3\u8f6c\nimap &lt;c-]&gt; &lt;Esc&gt;&lt;c-]&gt;\nnmap &lt;F8&gt; :TagbarToggle&lt;CR&gt;\nlet g:tagbar_ctags_bin = 'ctags'\nlet g:tagbar_width = 30\n\" \u9700\u8981\u590d\u5236\u4e00\u5806\u4e1c\u897f\u5230vim\u6253\u5f00\u7684\u6587\u4ef6\u65f6,\u4f1a\u4e71\u4e86\u683c\u5f0f,\u8fd9\u4e2a\u5c31\u662f\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\n\" F10 \u6765\u5207\u6362\nset pastetoggle=&lt;F10&gt;\n\"inoremap ( ()&lt;ESC&gt;i\n\"inoremap [ []&lt;ESC&gt;i\n\"inoremap { {}&lt;ESC&gt;i\n\"inoremap &lt; &lt;&gt;&lt;ESC&gt;i\n</code></pre>"},{"location":"developer/vim/#vimdiff","title":"vimdiff\u65f6\u7684\u5feb\u6377\u952e","text":"\u5feb\u6377\u952e \u529f\u80fd Ctrl+W,l \u5207\u6362\u5230\u53f3\u8fb9\u7684\u7a97\u53e3 Ctrl+W,h \u5207\u6362\u5230\u5de6\u8fb9\u7684\u7a97\u53e3"},{"location":"developer/vim/#ipad-esc","title":"ipad esc \u952e\u600e\u4e48\u6309","text":"<ul> <li>\u6ca1\u6709 \u8fd9\u4e2a\u952e\uff0c \u7528 ctrl+[ \u6216 cmd+.\u6765\u4ee3\u66ff  ESC\u952e</li> <li>\u6216\u8005\u5728 \u8bbe\u7f6e\u4e2d \u901a\u7528-&gt;\u952e\u76d8-&gt;\u5b9e\u4f53\u952e\u76d8-&gt;\u4fee\u9970\u952e  \u6539\u5927\u5199\u9501\u5b9a\u952e=&gt;ESC </li> </ul>"},{"location":"developer/vim/#nerdtree","title":"nerdtree","text":"<ul> <li> <p>\u7a97\u53e3\u5207\u6362\u5feb\u6377\u952e <pre><code>ctrl + w ,\u518d\u6309 h \u5207\u6362\u5230\u5de6\u4fa7\nctrl + w ,\u518d\u6309 l \u5207\u6362\u5230\u53f3\u4fa7\nctrl + w ,\u518d\u6309 w \u81ea\u52a8\u5207\u6362\u5230\u53e6\u5916\u4e00\u8fb9\n</code></pre></p> </li> <li> <p>\u7a97\u53e3\u8bbe\u7f6e\u5927\u5c0f vimrc\u4e2d\u6dfb\u52a0<pre><code># \u8bbe\u7f6e\u5de6\u4fa7\u62e6\u5bbd\u5ea6\nlet g:NERDTreeWinSize = 20\n</code></pre></p> </li> </ul>"},{"location":"developer/vim/#bash","title":"\u76f4\u63a5\u8fd0\u884cbash\u547d\u4ee4","text":"<pre><code>:!command\n\u6bd4\u5982\n:!ls -l\n</code></pre>"},{"location":"developer/vim/#vim","title":"vim\u4fee\u6539\u4e8c\u8fdb\u5236\u6587\u4ef6","text":"<pre><code> vim -b test.bin\n# \u8f93\u5165\u4e0b\u9762\u6267\u884c, \u7136\u540e\u624d\u53bb\u4fee\u6539\u6587\u4ef6\n:%!xxd\n# \u4fee\u6539\u5b8c\u6bd5\u540e\n:%!xxd -r\n:wq\n</code></pre>"},{"location":"developer/weird/","title":"Weird","text":""},{"location":"developer/weird/#mac","title":"mac\u4e0a\u6253\u51fa\u5e73\u65b9(\u6253\u51fa\u4e0a\u6807)","text":"<p>Note</p> <p>\u6bd4\u5982\u4f60\u8981\u8f93\u51653\u7684\u5e73\u65b9</p> <p>\u5148\u8f93\u51653 \u7136\u540e \u6309\u4e0b Ctrl+Cmd+Space \u7136\u540e\u4f60\u53ef\u4ee5\u8f93\u51652\u8fd9\u4e2a\u6570\u5b57,\u518d\u9009\u62e9\u4e0a\u6807\u7684\u90a3\u4e2a\u5f62\u5f0f\u5373\u53ef</p>"},{"location":"developer/weird/#wifi","title":"\u4f7f\u7528\u547d\u4ee4\u67e5\u770bwifi\u5bc6\u7801","text":"windowslinux <pre><code>#key=clear \u8868\u793a\u663e\u793a\u5bc6\u7801\nnetsh wlan show profile\nnetsh wlan show profile name=\"wifi\u7684\u540d\u79f0\" key=clear  \n</code></pre> <pre><code>cd /etc/NetworkManager/system_connections\nls </code></pre>"},{"location":"developer/weird/#md5-sha256","title":"\u67e5\u770b\u6587\u4ef6md5 sha256","text":"windowslinux <pre><code>certutil -hashfile filename MD5\ncertutil -hashfile filename SHA1\ncertutil -hashfile filename SHA256\n</code></pre> <pre><code>openssl dgst  -sha256 filename\nopenssl dgst  -sha1 filename\nopenssl dgst  -md5 filename\n# \u4e0b\u9762\u7684\u66f4\u65b9\u4fbf\nmd5 filename\nsha1sum filename\nsha256sum filename\n</code></pre>"},{"location":"developer/windows/","title":"Windows","text":""},{"location":"developer/windows/#_1","title":"\u547d\u4ee4\u6c38\u4e45\u4fee\u6539\u73af\u5883\u53d8\u91cf","text":"<pre><code>setx PATH \"%PATH%;c:\\go\\bin\"\n</code></pre>"},{"location":"developer/git/advanced/","title":"git\u8fdb\u9636","text":""},{"location":"developer/git/advanced/#hook","title":"hook \u94a9\u5b50","text":""},{"location":"developer/git/advanced/#_1","title":"\u5b50\u6a21\u5757","text":""},{"location":"developer/git/advanced/#subtree","title":"subtree","text":""},{"location":"developer/git/advanced/#submodule","title":"submodule","text":""},{"location":"developer/git/advanced/#gitmodulesurl","title":"\u4fee\u6539.gitmodules\u4ed3\u5e93url\u540e\u9700\u8981\u7684\u64cd\u4f5c","text":"<p>```toml \".gitmodules\" [submodule \"themes/docsy\"]     path = themes/docsy     url = https://github.com/google/docsy.git     branch = v0.2.0 <pre><code>\u540e\u6765\u8fd9\u4e2a\u5730\u5740\u53d8\u66f4\u4e86,\u62c9\u53d6\u6700\u65b0, .gitmodules \u662f\u53d8\u66f4\u4e86\n\n```toml title=\".gitmodules \u53d8\u66f4\u540e\u7684\u7ed3\u679c\"\n[submodule \"themes/docsy\"]\n    path = themes/docsy\n    url = https://github.com/google/docsy2.git\n    branch = v0.2.0\n</code></pre> <pre><code># \u53d1\u73b0\u8fd8\u662f \u7528\u7684\u8001\u5730\u5740 \u8fdb\u884cclone\ngit submodule update --init --recursive --depth 1\n</code></pre></p> \u9700\u8981\u66f4\u65b0\u5230\u672c\u5730\u7684\u914d\u7f6e<pre><code># \u4f1a\u5c06.gitmodules \u7684\u914d\u7f6e\u66f4\u65b0\u5230 .git/config\u4e2d\u53bb, \u5b9e\u9645\u7528\u5230\u7684\u4ed3\u5e93url\u5728\u672c\u5730\u914d\u7f6e\u91cc\ngit submodule sync --recursive\n# \u67e5\u770b\ncat .git/config # \u53ef\u4ee5\u770b\u5230\u66f4\u65b0\u4e86\n# \u53ef\u4ee5\u4e86\ngit submodule update --init --recursive --depth 1\n</code></pre>"},{"location":"developer/git/advanced/#git-filter-repo","title":"git filter-repo","text":"<p>Note</p> <p>\u6bd4\u5982commit\u4e86\u4e00\u4e2a\u53ef\u6267\u884c\u6587\u4ef6,\u63a8\u9001\u5230\u4e86\u8fdc\u7a0b,\u7136\u540e\u4e0b\u4e2acommit\u4f60\u5c06\u5b83\u5220\u9664,\u63a8\u9001,</p> <p>\u5b9e\u9645\u4e0a\u8fd9\u4e2a\u6587\u4ef6\u8fd8\u662f\u5b58\u5728\u7684. \u5982\u4f55\u5f7b\u5e95\u5220\u9664\u5b83?</p> <p>\u5b89\u88c51</p> <pre><code># \u53ea\u4fdd\u7559README.md\u6587\u4ef6 \u548c guides/\u76ee\u5f55\u548c tools/releases\u76ee\u5f55 ,\u76f8\u5bf9\u4e8e\u6839\u76ee\u5f55\u4f4d\u7f6e\u7684\u6587\u4ef6\ngit filter-repo --path README.md --path guides/ --path tools/releases\n# \u4e0e\u4e0a\u9762\u521a\u597d\u76f8\u53cd, \u53ea\u5220\u9664\u8fd9\u51e0\u4e2a \u4e1c\u897f , \u76f8\u5bf9\u4e8e\u6839\u76ee\u5f55\u4f4d\u7f6e\u7684\u6587\u4ef6\ngit filter-repo --path README.md --path guides/ --path tools/releases --invert-paths\n#--path-glob '*.DS_Store' \u6307\u5b9a\u8fd9\u4e2a\u7684\u8bdd , \u76f8\u6bd4path,\u8fd9\u4e2a\u4f1a \u5305\u542b\u8fd9\u7c7bfoo.DS_Store or bar/baz.DS_Store\n#--path \u57fa\u4e8e\u6839\u76ee\u5f55\u7684\n#\u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\u540e, \u4e0d\u9700\u8981\u518d \u6e05\u7406reflog \u548coriginal\u91cc\u7684\u4e1c\u897f (git filter-branch \u8fd9\u4e2a\u5b98\u65b9\u7684\u9700\u8981\u8fd9\u4e48\u505a), \u56e0\u4e3a\u5df2\u7ecf\u5e2e\u4f60\u505a\u4e86\n#\u76f4\u63a5\ngit push -f --all\ngit push -f --tags\n</code></pre>"},{"location":"developer/git/advanced/#_2","title":"\u5b9e\u9645\u4ed3\u5e93\u7626\u8eab","text":"<p><pre><code>#\u6267\u884c\u547d\u4ee4, \u4f1a\u8fdb\u884c\u538b\u7f29\u6253\u5305, \u5728 .git/objects/pack \u76ee\u5f55\u4e0b\u751f\u6210\u4e00\u4e2apack\u6587\u4ef6,\n# objects/ \u539f\u672c\u597d\u591a\u7684\u6587\u4ef6\u5939\u90fd\u4e0d\u89c1\u4e86. \u90fd\u538b\u7f29\u6253\u5305\u5230\u4e86\u8fd9\u91cc\ngit gc\n\n#\u53ef\u4ee5\u770b\u5230pack\u6253\u5305\u7684\u6587\u4ef6\u91cc \u5177\u4f53\u662f\u4ec0\u4e48\u6587\u4ef6\ngit verify-pack -v .git/objects/pack/*.idx\n\n#\u67e5\u770b\u5f53\u524d\u6240\u6709\u7684\u6587\u4ef6.  \u591a\u6b21commit \u90fd\u4f1a\u663e\u793a\u54e6\ngit rev-list --objects --all\n\n#-k 3 \u5bf9\u7b2c\u4e09\u5217\u7684\u5b57\u6bb5\u8fdb\u884c\u6392\u5e8f.  -n \u8868\u793a\u7528\u6570\u503c\u6392\u5e8f\ngit verify-pack -v .git/objects/pack/*.idx | sort -k 3 -n  #\u627e\u5230\u5360\u7528\u7a7a\u95f4\u6bd4\u8f83\u5927\u7684\u6587\u4ef6\u540d\ngit rev-list --objects --all | grep \"$(git verify-pack -v .git/objects/pack/*.idx | sort -k 3 -n | tail -15 | awk '{print$1}')\"\n#\u4e0b\u65b9\u547d\u4ee4\u4e2d\u7684 path/to/large/files \u662f\u5927\u6587\u4ef6\u6240\u5728\u7684\u8def\u5f84\uff0c\u5343\u4e07\u4e0d\u8981\u5f04\u9519\uff01\ngit filter-branch --tree-filter 'rm -f path/to/large/files' --tag-name-filter cat -- --all\n\n#\u5982\u679c\u63d0\u793a\nCannot create a new backup.\nA previous backup already exists in refs/original/\nForce overwriting the backup with -f\n\u5c31\ngit filter-branch -f --tree-filter 'rm -f path/to/large/files' --tag-name-filter cat -- --all\n\n# \u8fd0\u884c\u540e\n\u63d0\u793a \u6240\u6709\u5206\u652f\u90fd\u91cd\u5199\u4e86. \u6240\u6709\u5206\u652f\u91cc\u7684\u8fd9\u4e2a\u6587\u4ef6 \u90fd\u6ca1\u6709\u4e86\u54e6\nRef 'refs/heads/master' was rewritten\nRef 'refs/heads/x' was rewritten\nRef 'refs/remotes/origin/master' was rewritten\nRef 'refs/remotes/origin/x' was rewritten\n\n# \u63d0\u4ea4\ngit push origin --tags --force\ngit push origin --all --force\n</code></pre> <pre><code># \u5176\u4ed6\u5f00\u53d1\u4eba\u5458\ngit pull --rebase\n</code></pre></p>"},{"location":"developer/git/advanced/#_3","title":"\u63d0\u5347\u76ee\u5f55\u4e3a\u6839\u76ee\u5f55","text":"\u4ed3\u5e93\u5f53\u524d\u76ee\u5f55\u7ed3\u679c<pre><code>module/\n   foo.c\n   bar.c\notherDir/\n   blah.config\n   stuff.txt\nzebra.jpg\n</code></pre> <p>\u53ea\u4fdd\u7559module\u4e0b\u7684\u6587\u4ef6, \u5e76\u4e14\u5c06module\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u79fb\u52a8\u5230\u6839\u76ee\u5f55\u4e0b<pre><code>git filter-repo --subdirectory-filter module/\n</code></pre> \u6267\u884c\u5b8c\u540e\u7684\u4ed3\u5e93\u76ee\u5f55\u7ed3\u6784,\u5176\u4ed6\u90fd\u6ca1\u4e86<pre><code>foo.c\nbar.c\n</code></pre></p>"},{"location":"developer/git/advanced/#_4","title":"\u79fb\u52a8\u6240\u6709\u6587\u4ef6\u5230\u5176\u4ed6\u76ee\u5f55\u4e0b","text":"<p>\u4ed3\u5e93\u5f53\u524d\u76ee\u5f55\u7ed3\u679c<pre><code>module/\n   foo.c\n   bar.c\notherDir/\n   blah.config\n   stuff.txt\nzebra.jpg\n</code></pre> <pre><code>git filter-repo --to-subdirectory-filter my-module/\n</code></pre> \u6267\u884c\u540e\u7684\u76ee\u5f55\u7ed3\u6784<pre><code>my-module/\n   module/\n      foo.c\n      bar.c\n   otherDir/\n      blah.config\n      stuff.txt\n   zebra.jpg\n</code></pre></p>"},{"location":"developer/git/advanced/#commit-message","title":"commit message \u89c4\u8303","text":""},{"location":"developer/git/advanced/#_5","title":"\u9519\u8bef\u6392\u67e5","text":"<p>detected dubious ownership in repository <pre><code># \u4ee3\u7801\u7684 owner \u6709\u95ee\u9898, \u4fee\u6539\u4e00\u4e0b.\n</code></pre></p> <ol> <li> <p>https://github.com/newren/git-filter-repo/blob/main/INSTALL.md#installation-via-package-manager \u21a9</p> </li> <li> <p>EXAMPLES \u21a9</p> </li> <li> <p>Git packFile) \u21a9</p> </li> <li> <p>\u4ed3\u5e93\u4f53\u79ef\u4f55\u51cf\u5c0f \u21a9</p> </li> </ol>"},{"location":"developer/git/git/","title":"git\u57fa\u7840","text":"<p>Warning</p> <p>\u672a\u5b8c\u5f85\u7eed..</p>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#_1","title":"\u914d\u7f6e","text":"","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#_2","title":"\u4fee\u6539\u914d\u7f6e","text":"<pre><code>git config --global user.name \"tt\"\ngit config --global user.email \"tt@163.com\"\n# \u5220\u9664\u914d\u7f6e\ngit config --global --unset user.name\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#config","title":"config\u7684\u4f5c\u7528\u57df","text":"<pre><code># \u53ea\u5bf9\u5f53\u524d\u4ed3\u5e93\u6709\u6548, \u5f53\u524d\u4ed3\u5e93\u76ee\u5f55/.git/config\ngit config --local\n# \u5bf9\u5f53\u524d\u7528\u6237\u6240\u6709\u4ed3\u5e93\u6709\u6548 , ~/.gitconfig\ngit config --global\n# \u5bf9\u7cfb\u7edf\u6240\u6709\u7528\u6237\u7684\u4ed3\u5e93\u6709\u6548, /etc/gitconfig\ngit config --system\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#_3","title":"\u663e\u793a\u914d\u7f6e","text":"<pre><code>git config --list --system\ngit config --list --global\ngit config --list --local\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#_4","title":"\u6211\u7684\u914d\u7f6e","text":"<pre><code>[user]\n    name = yourusername\n    email = youremail\n[core]\n    trustctime = false\n    editor = vim\n    filemode = false\n    autocrlf = false\n    # \u5982\u679c\u662ftrue ,\u975eASCII \u5b57\u7b26\u4f1a\u7528\u516b\u8fdb\u5236\u8fdb\u884c\u8f6c\u4e49\n    # \u73b0\u5728\u7ec8\u7aef\u90fd\u652f\u6301\u8f93\u51fa\u5176\u4ed6\u5b57\u7b26\u4e86,\u6240\u4ee5\u53d6\u6d88\n    quotepath = false\n[alias]\n    last = log -1 --stat\n    cp = cherry-pick\n    co = checkout\n    cl = clone\n    ci = commit\n    st = status -sb\n    br = branch\n    unstage = reset HEAD --\n    dc = diff --cached\n    lg = log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %Cblue&lt;%an&gt;%Creset' --abbrev-commit --date=relative\n    pull = pull --ff-only\n    df = difftool\n    mg = mergetool\n[merge]\n    tool = vimdiff\n[diff]\n    tool = vimdiff\n[difftool]\n    prompt = false\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#git-clone-insteadof","title":"git clone\u6162\u7684\u89e3\u51b3\u65b9\u6cd5 insteadOf","text":"<pre><code># \u8fd9\u6837 \u4f60git clone https://github.com/xx/yy \u5c31\u4f1a\u53d8\u6210 git clone https://ghproxy.com/https://github.com/xx/yy\ngit config --global url.\"https://ghproxy.com/https://github.com/\".insteadOf https://github.com/\n# \u53d6\u6d88\ngit config --global  --unset url.\"https://ghproxy.com/https://github.com/\".insteadOf\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#_5","title":"\u5f00\u53d1\u4eba\u5458\u4e00\u822c\u6b65\u9aa4","text":"<p>1.git clone \u4e0b\u516c\u53f8\u4ee3\u7801\u4ed3\u5e93 <pre><code>git clone git@gitee.com:xyz/test.git\n</code></pre> 2.\u4ee5dev\u6216\u5176\u4ed6\u5f00\u53d1\u4e2d\u7684\u4e3b\u5206\u652f\u6bd4\u5982WIP(\u7528\u516c\u53f8\u53ef\u80fd\u7528\u8fd9\u4e2a\u5206\u652f\u540d\u5b57)\u6216\u8005\u5176\u4ed6 v1.0 \u8fd9\u79cd \u521b\u5efa\u4e00\u4e2a\u5206\u652f\u8fdb\u884c\u5f00\u53d1 \u6ce8\u610f\u4e00\u4e2a\u529f\u80fd,\u6216\u4e00\u6b21bug\u4fee\u590d\u5c31\u7528\u4e00\u4e2a\u5206\u652f. <pre><code>git co -b fix/xyz dev\n</code></pre> 3.\u5199\u4ee3\u7801, git add,commit, \u81f3\u5c11\u6bcf\u5929\u4e0b\u73ed\u524d git commit \u4e00\u6b21, \u529f\u80fd\u5f00\u53d1\u5b8c\u6bd5 \u5408\u5e76\u524d,\u53ef\u4ee5\u968f\u610fcommit,\u968f\u610f\u7684\u63a8\u9001\u8be5\u5206\u652f\u5230\u8fdc\u7a0b <pre><code>git add .\ngit ci -m \"msg\"\n</code></pre> 4.\u63d0\u4ea4pull request \u9636\u6bb5</p> <p>\u5c06\u4f60\u7684commit \u5408\u5e76\u6210\u4e00\u4e2acommit \u8fd9\u4e2acommit_id \u662f\u4f60 <code>git co -b fix/xyz</code> \u5206\u652f\u65f6\u7684\u6700\u65b0commit</p> git reset \u65b9\u5f0fgit rebase\u65b9\u5f0f <pre><code>git reset commit_id\ngit add .\ngit ci -m \"msg\"\n</code></pre> <p>\u4fdd\u7559\u7b2c\u4e00\u884c\u7684\u90a3\u4e2acommit ,\u4e0d\u52a8, \u5c31\u662f\u4f60\u7b2c\u4e00\u6b21\u63d0\u4ea4\u7684commit \u5c06\u5176\u4ed6\u524d\u9762\u7684pick \u6539\u6210s ,\u7136\u540e \u4fdd\u5b58\u9000\u51fa, \u63d0\u793a \u8f93\u5165\u65b0\u7684commit msg \u518d\u4fdd\u5b58\u9000\u51fa <pre><code>git rebase -i commit_id\n</code></pre></p> <p>\u5408\u5e76\u73b0\u5728\u6700\u65b0\u7684dev\u4ee3\u7801\u5230\u4f60\u7684\u5206\u652f <pre><code># \u5148\u62c9\u53d6\u6700\u65b0\u7684dev\u4ee3\u7801\u5230\u672c\u5730dev\ngit pull origin dev:dev\n# \u672c\u5730\u5408\u5e76\u6765\u81ea dev\u7684\u6700\u65b0\u4ee3\u7801 \u4e0d\u8981\u7528merge\n# \u5c31\u76f8\u5f53\u4e8e\u4f60\u5728\u6700\u65b0\u4ee3\u7801\u7684dev\u5206\u652f\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u5f00\u53d1,merge \u5b8c\u5168\u6ca1\u5fc5\u8981\ngit rebase dev\n</code></pre></p> \u5f00\u53d1\u524d\u7684dev\u5206\u652f\u73b0\u5728\u7684dev\u4f60\u7684\u5206\u652fmerge wip\u540erebase wip\u540e <pre><code>* 123ffca - add c.txt\n* 5721887 - add b.txt\n* b8172ad - add a.txt\n* 128d312 - (origin/master, origin/HEAD, master) readme\n</code></pre> <pre><code>*   e33481e - (HEAD -&gt; wip) Merge branch 'fix/hello' into wip\n|\\\n| * be69a6e - (origin/fix/hello, fix/hello) fix b.txt add hello\n|/\n* 123ffca - add c.txt\n* 5721887 - add b.txt\n* b8172ad - add a.txt\n* 128d312 - (origin/master, origin/HEAD, master) readme\n</code></pre> <pre><code>* 95d6da4 - (HEAD -&gt; fix/one) fix c.txt add one\n* 123ffca - add c.txt\n* 5721887 - add b.txt\n* b8172ad - add a.txt\n* 128d312 - (origin/master, origin/HEAD, master) readme\n</code></pre> <pre><code>*   99a02ef - (HEAD -&gt; fix/one) Merge branch 'wip' into fix/one\n|\\\n| *   e33481e - (wip) Merge branch 'fix/hello' into wip\n| |\\\n| | * be69a6e - (origin/fix/hello, fix/hello) fix b.txt add hello\n| |/\n* / 95d6da4 - fix c.txt add one\n|/\n* 123ffca - add c.txt\n* 5721887 - add b.txt\n* b8172ad - add a.txt\n* 128d312 - (origin/master, origin/HEAD, master) readme\n</code></pre> <pre><code>* 8c0df48 - (HEAD -&gt; fix/one) fix c.txt add one\n*   e33481e - (wip) Merge branch 'fix/hello' into wip\n|\\\n| * be69a6e - (origin/fix/hello, fix/hello) fix b.txt add hello\n|/\n* 123ffca - add c.txt\n* 5721887 - add b.txt\n* b8172ad - add a.txt\n* 128d312 - (origin/master, origin/HEAD, master) readme\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#_6","title":"\u5e38\u7528\u547d\u4ee4","text":"","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#clone","title":"clone","text":"\u4ec5\u4ec5\u4e3a\u4e86\u4f7f\u7528\u90a3\u4e2a\u4ed3\u5e93<pre><code># \u53ea\u4e0b\u8f7d\u6700\u8fd1\u4e00\u4e2acommit, \u6211\u4eec\u4e0b\u8f7d\u6700\u65b0\u7684\u4ee3\u7801\u5c31\u884c\u4e86\ngit clone --depth=1  https://github.com/vuejs/vuepress.git\n# --branch \u6307\u5b9a\u5206\u652f..\ngit clone --depth=1 --branch main https://github.com/vuejs/vuepress.git\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#pull","title":"pull","text":"<pre><code># \u62c9\u53d6\u8fdc\u7a0b\u5206\u652fremote_dev \u5408\u5e76\u5230 \u672c\u5730\u7684local_dev \u5206\u652f\ngit pull origin remote_dev:local_dev\n</code></pre> --ff \u81ea\u52a8\u5408\u5e76\u6a21\u5f0f(\u9ed8\u8ba4\u5c31\u662f\u8fd9\u4e2a)--no-ff non-Fast-forward \u6a21\u5f0f--ff-only Fast-forward \u6a21\u5f0f <ul> <li>\u5f53\u5408\u5e76\u7684\u5206\u652f\u4e3a\u5f53\u524d\u5206\u652f\u7684\u540e\u4ee3\u65f6, \u4f1a\u81ea\u52a8\u6267\u884c --ff (Fast-forward)\u6a21\u5f0f,</li> <li>\u5982\u679c\u4e0d\u662f\u540e\u4ee3\u5219\u6267\u884c --no-ff (non-Fast-forward)\u5408\u5e76\u6a21\u5f0f</li> </ul> <p>\u5728\u4efb\u4f55\u60c5\u51b5\u4e0b\u90fd\u4f1a\u521b\u5efa\u65b0\u7684commit</p> <p>\u53ea\u4f1a\u6309\u7167 Fast-forward \u6a21\u5f0f\u8fdb\u884c\u5408\u5e76\uff0c\u5982\u679c\u4e0d\u662f\u5f53\u524d\u5206\u652f\u7684\u76f4\u63a5\u540e\u4ee3,\u5219\u4f1a\u62d2\u7edd\u5408\u5e76\u8bf7\u6c42\u5e76\u9000\u51fa</p>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#remote","title":"remote \u4ed3\u5e93","text":"<pre><code># \u67e5\u770b\u8fdc\u7a0b\u4ed3\u5e93\u4fe1\u606f\ngit remote -vv\n# \u6dfb\u52a0 \u65b0\u7684\u8fdc\u7a0b\u4ed3\u5e93,\u4f60\u53ef\u4ee5\u6dfb\u52a0\u591a\u4e2a\u8fdc\u7a0b\u4ed3\u5e93\ngit remote add new_origin git@github.com:llibeohs/llibeohs.github.io.git\n# \u76f4\u63a5\u4fee\u6539\u8fdc\u7a0b\u4ed3\u5e93\u5730\u5740\ngit remote set-url origin git@.../test.git\n# \u5220\u9664\ngit remote rm origin\n</code></pre> <p>\u672c\u5730\u5220\u9664\u5df2\u7ecf\u4e0d\u5b58\u5728\u7684\u8fdc\u7a0b\u5206\u652f, \u522b\u4eba\u63d0\u4ea4\u7684\u8fdc\u7a0b\u5206\u652f,\u4f60 pull\u8fc7, \u7136\u540e\u522b\u4eba\u5220\u9664\u4e86\u8fdc\u7a0b\u5206\u652f,\u8fd9\u4e2a\u65f6\u5019\u4f60\u672c\u5730\u8fd8\u4fdd\u7559\u7740,\u60f3\u8981\u5220\u9664 \u67e5\u770b\u8fdc\u7a0b\u7684\u76f8\u5173\u4fe1\u606f<pre><code>git remote show origin\n\n* remote origin\n        Fetch URL: /root/gittest/./rep\n        Push  URL: /root/gittest/./rep\n        HEAD branch: master\n        Remote branches:\n          master                  tracked\n          refs/remotes/origin/gen stale (use 'git remote prune' to remove)\n</code></pre> \u5220\u9664<pre><code>git remote prune origin\n</code></pre></p>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#branch","title":"branch","text":"<pre><code>git br -r #\u53ea\u663e\u793a\u8fdc\u7a0b\u7684\u5206\u652f\ngit br # \u672c\u5730\u5206\u652f\ngit br -a #\u663e\u793a\u6240\u6709\u7684\u5206\u652f\n# \u5207\u6362\u5230master\u5206\u652f, \u5206\u652f\u540d\u5fc5\u987b\u5b58\u5728\ngit co master\n# \u6839\u636e\u5f53\u524d\u5206\u652f \u521b\u5efa\u4e86\u4e00\u4e2a\u5206\u652f,\u5e76\u5207\u6362\u5230\u8be5\u5206\u652f\ngit co -b your_branch\n# \u4ee5\u67d0\u4e2acommit \u521b\u5efa\u5206\u652f\ngit co -b your_branch commit_id\n# \u63a8\u9001\u672c\u5730\u5206\u652f\u5230\u8fdc\u7a0b\u5206\u652f,\u8fd9\u4e2a\u8fdc\u7a0b\u5206\u652f\u540d\u4e0e\u4f60\u7684\u672c\u5730\u5206\u652f\u540c\u540d\ngit push origin your_branch\n# :\u5de6\u8fb9\u662f\u672c\u5730\u5206\u652f \u53f3\u8fb9\u662f\u8fdc\u7a0b\u5206\u652f\u540d\ngit push origin dev:dev\n# \u5c06\u4f60\u65b0\u5efa\u7684\u672c\u5730\u5206\u652fdev\u4e0e\u8fdc\u7a0b\u5206\u652f\u5173\u8054\u8d77\u6765\n# \u8fd9\u6837 \u4f60\u5c31\u53ef\u4ee5\u76f4\u63a5 git push, \u4e0d\u9700\u8981\u6bcf\u6b21\u90fd git push origin dev\ngit br -u origin/dev dev\n# \u53ef\u4ee5\u770b\u5230\u5173\u8054\u4fe1\u606f\ngit br -vv\n     #dev2   a950611 up  &lt;--- \u65e0\u5173\u8054\n#master a950611 [origin/master: ahead 3] up&lt;---- \u6709\u5173\u8054\n# \u7b2c\u4e00\u6b21\u76f4\u63a5push \u5e76\u4e14\u5173\u8054\u8fdc\u7a0b\u5206\u652f\ngit push -u origin dev\n\n# \u5047\u8bbe\u8fd9\u4e2a\u65f6\u5019\u6709\u4e2a\u8fdc\u7a0b\u5206\u652f\u662fdev\n# \u4e00\u4e0b\u547d\u4ee4\u76f4\u63a5\u4ece\u8fdc\u7a0b\u5206\u652f\u521b\u5efa\u672c\u5730\u5206\u652f,\u5e76\u5207\u6362\u5230 \u8be5\u5206\u652f,\n# \u8fd9\u4e2a\u65f6\u5019 \u5df2\u7ecf\u4e92\u76f8\u5173\u8054\u4e0a\u4e86,\u76f4\u63a5git pull/push\ngit co -b dev origin/dev\n# \u5220\u9664\u672c\u5730\u5206\u652f\ngit br -d \u5206\u652f\u540d # \u4f1a\u63d0\u793a\u4e00\u4e9b\u8b66\u544a,\u6bd4\u5982\u4f60\u5f53\u524d\u5206\u652f\u6ca1\u6709\u505a\u8fc7merge\u4ec0\u4e48\u7684, \u4e0d\u80fd\u5220\u9664\ngit br -D \u5206\u652f\u540d # \u52a0\u5165\u4f60\u786e\u5b9a\u8981\u5220\u9664\u5206\u652f, \u5219\u4f7f\u7528-D \u6765\n# \u5220\u9664\u8fdc\u7a0b\u5206\u652f\ngit push \u8fdc\u7a0b\u540d :\u8fdc\u7a0b\u5206\u652f\u540d\ngit push origin :dev # \u5220\u9664\u8fdc\u7a0b\u5206\u652f dev\n# \u4fee\u6539\u5206\u652f\u540d\ngit br -m old_br new_br\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#checkout-co","title":"checkout (co)","text":"<pre><code># \u5c31\u662f\u4f60 git add \u4e00\u6b21\u5230\u4e86\u6682\u5b58\u533a,\u7136\u540e\u53c8\u505a\u4e86\u4fee\u6539, \u4f46\u662f\u4f60\u53d1\u73b0\n# \u8fd8\u4e0d\u5982 \u6682\u5b58\u533a\u7684\u5185\u5bb9\u597d,\u6240\u4ee5\u60f3\u8981\u5c06\u5de5\u4f5c\u533a\u7684\u5185\u5bb9\u53d8\u6210\u548c\u6682\u5b58\u533a\u4e00\u6a21\u4e00\u6837\n# \u4fee\u6539\u5185\u5bb9\u540e, git status  \u4e00\u6837\u53ef\u4ee5\u770b\u5230\u63d0\u793a\ngit checkout -- a.txt\n\n#  \u4f1a\u5c06\u539f\u5206\u652f\u7684\u5185\u5bb9\u62f7\u8d1d, \u7136\u540e\u65b0\u7684\u5206\u652f\u91cc \u6ca1\u6709\u4e00\u4e2acommit ,\u4f60\u9700\u8981git add ,commit \u505a\u4e00\u4e2a\u521d\u59cb\u63d0\u4ea4.\n# \u6216\u8005\u4f60\u53ef\u4ee5\u5220\u9664\u91cc\u9762\u6240\u6709\u7684\u5185\u5bb9, \u8fd9\u6837 \u53d8\u6210\u4e00\u4e2a\u7a7a\u7684\u5206\u652f,\u4f60\u505a\u5565\u90fd\u884c.\ngit co --orphan \u5206\u652f\u540d\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#add","title":"add","text":"","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#unstage","title":"unstage","text":"<pre><code># unstage = reset HEAD --\n#\u5c06\u6587\u4ef6\u4ece\u6682\u5b58\u533a \u653e\u5230\u5de5\u4f5c\u533a.\n#\u5c31\u662f git add \u540e, \u6211\u4eec \u53d6\u6d88\u8fd9\u4e2a\u64cd\u4f5c\ngit unstage world.txt\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#commit","title":"commit \u6ce8\u91ca\u4fee\u6539","text":"<pre><code># \u4fee\u6539\u6700\u65b0\u7684commit\u7684\u6ce8\u91ca\u4fe1\u606f\ngit ci --amend\n\n# \u4fee\u6539\u4e4b\u524d\u7684commit\u7684\u6ce8\u91ca\u4fe1\u606f\ngit lg\n    * df6b55b - (HEAD -&gt; master) modify:d * 565bd5a - modify c.txt\n    * b50b285 - stg3yy\n    * 23fd353 - stg2\n    * 4164370 - stg1\n# \u6bd4\u5982\u4f60\u8981\u4fee\u653923fd353 \u7684msg,\u90a3\u4e48\u4f60\u9700\u8981\ngit rebase -i 4164370 #(\u4f60\u8981\u4fee\u6539\u7684commit\u7684\u4e0a\u4e00\u4e2acommit)\n# \u4f1a\u5f39\u51fa\u4e00\u4e2a\u7a97\u53e3\n# \u6ce8\u91ca\u4e5f\u8bf4\u7684\u5f88\u660e\u767d,\n# \u8fd9\u91cc\u6bd4\u5982\u6211\u4eec\u8981\u4fee\u65392\u4e2acommit\u7684msg,\u6211\u4eec\u5c06\u524d\u9762\u9ed8\u8ba4\u7684pick \u4fee\u6539\u4e3ar,\n#   r, reword = use commit, but edit the commit message\n# \u5176\u4ed6\u4e0d\u8981\u53d8\u7684 \u5c31\u8fd8\u662fpick\n# :wq \u4fdd\u5b58\u9000\u51fa,\u4f1a\u8df3\u51fa\u53e6\u5916\u4e00\u4e2a\u7a97\u53e3\nr 23fd353 stg2\n    r b50b285 stg3yy\n    pick 565bd5a modify c.txt\n    pick df6b55b modify:d\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#cherry-pick-cp","title":"cherry-pick (cp)","text":"<p>\u5c06\u4efb\u610f\u5206\u652f\u4e0a\u7684\u67d0\u51e0\u4e2a\u63d0\u4ea4,\u5e94\u7528\u5230\u5f53\u524d\u5206\u652f\u4e0a, \u76f8\u5f53\u4e8e\u5728\u5f53\u524d\u5206\u652f\u4e0a\u4f60\u505a\u4e86\u8fd9\u4e9b\u4fee\u6539 <pre><code>git cp commit_id\n# \u4e24\u4e2acommit\u533a\u95f4\u7684\u6240\u6709commit, ..\u5de6\u8fb9\u7684\u662f\u65e7\u7684commit,\u4e0d\u5305\u542b\u8be5commit\ngit cp commit_id1..commit_id2\n# 2\u4e2a\u5206\u652f\u4e4b\u95f4\u7684.\ngit cp dev..fix/one\ngit lg\n* 411be80 - d\n* f145376 - c\n* ca55914 - b\ngit cp ca55914..411be80  \u76f8\u5f53\u4e8e\n  git cp f145376\n  git cp 411be80\n# \u5982\u679c\u6709\u51b2\u7a81\ngit add .\n    git cp --continue\n# \u6216\u8005 \u53d6\u6d88\ngit cp --abort\n</code></pre></p>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#push","title":"push","text":"<pre><code># \u5c06\u5f53\u524d\u672c\u5730\u5206\u652f\u63a8\u9001\u5230\u8fdc\u7a0b\u5206\u652f\ngit push origin dev:dev # :\u5de6\u8fb9\u662f\u672c\u5730\u5206\u652f \u53f3\u8fb9\u662f\u8fdc\u7a0b\u5206\u652f\u540d\n# \u8fd9\u4e2a\u9ed8\u8ba4\u5c31\u662f\u63a8\u9001\u5230\u8fdc\u7a0b\u7684dev\u5206\u652f,\u540c\u4e0a\ngit push origin dev\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#clean","title":"clean \u5220\u9664\u4e0d\u5728\u5de5\u4f5c\u533a\u7684\u6587\u4ef6","text":"<pre><code># -n = --dry-run\n# \u8868\u793a\u5148\u770b\u770b\u4f1a\u5220\u9664\u4ec0\u4e48 ,\u5220\u9664\u4e0d\u5728\u5de5\u4f5c\u533a\u7684\u6587\u4ef6. \u5c31\u662f\u8fd8\u4ece\u6ca1git add\u8fc7\u7684\n# \u53ea\u4f1a\u770b\u6587\u4ef6\ngit clean -n\n# -d \u4f1a\u770b\u4e0d\u5728\u5de5\u4f5c\u533a \u7684\u6587\u4ef6(\u9ed8\u8ba4\u5c31\u4f1a\u770b\u7684)\u548c\u6587\u4ef6\u5939\ngit clean -n -d\n# \u4f1a\u63d0\u793a\u4f60 clean.requireForce defaults to true and neither -i, -n, nor -f given; refusing to clean\ngit clean\n# \u6267\u884c\u5220\u9664\u64cd\u4f5c , \u9700\u8981-f\ngit clean -f\n# -d \u6587\u4ef6\u5939\u4e5f\u5220\u9664\ngit clean -f -d\n# -x \u5728.gitignore \u6587\u4ef6\u91cc\u7684 \u4e5f\u4f1a\u5220\u9664,\u9ed8\u8ba4\u4e0d\u4f1a\u5220\u9664\ngit clean -f -d -x\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#rm","title":"rm","text":"<pre><code># \u5220\u9664\u6587\u4ef6, \u72b6\u6001\u5df2\u7ecf\u662f \u5728 \u6682\u5b58\u533a\u4e86, \u76f8\u5f53\u4e8e rm \u6587\u4ef6\u540e, \u7136\u540egit add filename\ngit rm filename\n# \u672c\u5730\u4fdd\u7559\u8be5\u6587\u4ef6, \u7136\u540euntrack \u8be5\u6587\u4ef6, \u5c31\u662f\u4e0d\u8981\u7248\u672c\u63a7\u5236\u5b83...\n# \u4e00\u822c\u60c5\u51b5\u4e0b,\u6211\u4eec\u4f1a\u63a5\u7740\u5c06\u8be5\u6587\u4ef6\u6dfb\u52a0\u5230.gitignore\u4e2d\ngit rm --cached filename\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#diff","title":"diff \u6bd4\u8f83","text":"<pre><code># \u66f4\u65e7\u7684\u653e\u524d\u9762,\u65b0\u7684\u653e\u540e\u9762,\u60f3\u770bcommit2 \u76f8\u5bf9commit1\u505a\u4e86\u54ea\u4e9b\u66f4\u6539\n# \u53ef\u4ee5\u662f\u4e0d\u540c\u7684\u5206\u652f\u7684commit id\u54e6\ngit diff commit1 commit2 filename\n#\u67e5\u770b\u5c06\u8981\u63a8\u9001\u7684\u5185\u5bb9, (\u6bd4\u8f83\u672c\u5730\u7684dev\u5206\u652f\u5bf9 \u8fdc\u7a0bdev\u505a\u4e86\u54ea\u4e9b\u4fee\u6539)\ngit diff origin/dev..dev\n# \u5b9e\u9645\u4e0e git diff HEAD~~ HEAD \u4e00\u6837\ngit diff HEAD~~..HEAD~\n\n# \u6bd4\u8f83tmp\u5206\u652f\u548cmaster\u5206\u652f a.txt\u6587\u4ef6\u7684\u533a\u522b\ngit diff tmp master -- a.txt\n# \u76f4\u63a5\u7528commit_id \u6765\u6bd4\u8f83 \u4e5f\u662f\u4e00\u6837\u7684\n# \u56e0\u4e3a\u5b9e\u9645\u4e0a\u5206\u652f\u540d\u6bd4\u8f83\u7684\u539f\u7406\u5c31\u662f \u5c31\u662f\u56e0\u4e3a\u5206\u652f\u540d\u6307\u5411\u7684\u5c31\u662f\u8be5\u5206\u652f\u6700\u65b0\u7684\u4e00\u6b21\u63d0\u4ea4,\u8fd8\u662fcommit_id\ngit diff tmp_commit_id master_commit_id -- a.txt\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#_7","title":"\u51b2\u7a81","text":"<p>world.txt(merge \u51b2\u7a81\u540e\u7684\u6587\u4ef6)<pre><code>woxld\n&lt;&lt;&lt;&lt;&lt;&lt;&lt; ours\noyo\n=======\nomo\n&gt;&gt;&gt;&gt;&gt;&gt;&gt; theirs\n</code></pre> \u4e00\u822c\u60c5\u51b5\u4e0b \u4f1a\u770b\u5230 \u4e0a\u9762 \u4e00\u4e2a\u662f\u6211\u4eec\u5206\u652f\u7684\u7248\u672c \u4e00\u4e2a\u662f\u4f60\u60f3\u8981merge\u7684\u5206\u652f\u7684\u7248\u672c</p> <p>oyo \u662f\u6211\u4eec\u7684\u7248\u672c\u7684\u4fee\u6539</p> <p>omo \u662f\u522b\u4eba\u7684\u7248\u672c\u7684\u4fee\u6539</p> <p>Note</p> <p>\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e merge.conflictstyle \u9009\u9879\u4e3a diff3 \u6765\u505a\u4e3a\u4ee5\u540e\u5408\u5e76\u51b2\u7a81\u7684\u9ed8\u8ba4\u9009\u9879 <code>git config --global merge.conflictstyle diff3</code> merge \u662f\u9ed8\u8ba4\u9009\u9879, diff3 \u5c31\u4f1a\u751f\u62103\u65b9\u5185\u5bb9\u6765\u5bf9\u6bd4</p> <p>\u589e\u52a0\u539f\u59cb\u7248\u672c<pre><code>git checkout --conflict=diff3 world.txt\n\n&lt;&lt;&lt;&lt;&lt;&lt;&lt; ours\noyo\n||||||| base\nooo\n=======\nomo\n&gt;&gt;&gt;&gt;&gt;&gt;&gt; theirs\n</code></pre> ooo\u662f\u539f\u6765\u7684\u60c5\u51b5</p> <pre><code>#\u5047\u8bbe\u6211\u4eec\u51b3\u5b9a\u4f7f\u7528\u6211\u4eec\u7684\u7248\u672c\u6765\u4f5c\u4e3a\u89e3\u51b3\u51b2\u7a81,\u90a3\u4e48\u53ef\u4ee5\ngit co --ours world.txt\n\n#\u60f3\u8981\u4f7f\u7528\u4ed6\u4eec\u7684\ngit co --theirs world.txt\n\ngit diff --ours # \u67e5\u770b\u76f8\u5bf9\u4e8e\u6211\u4eec\u672c\u5730\u7684\u7248\u672c \u505a\u4e86\u54ea\u4e9b\u66f4\u6539\ngit diff --ours filename\ngit diff --theirs # \u67e5\u770b\u76f8\u5bf9\u4e8e\u4ed6\u4eec\u7684\u7248\u672c \u505a\u4e86\u54ea\u4e9b\u66f4\u6539\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#log","title":"log","text":"<pre><code># \u67e5\u770b\u9879\u76ee\u7684\u63d0\u4ea4\u8bb0\u5f55\ngit lg\ngit lg \u6587\u4ef6\u540d  #(\u67e5\u770b\u8be5\u6587\u4ef6\u7684\u63d0\u4ea4\u8bb0\u5f55 log)\ngit lg commit_id  #(\u67e5\u770b\u8fd9\u4e2acommit_id \u4ee5\u53ca\u4e4b\u524d\u7684\u63d0\u4ea4\u8bb0\u5f55log)\n#-p \u6309\u8865\u4e01\u683c\u5f0f\u663e\u793a\u6bcf\u4e2a\u66f4\u65b0\u4e4b\u95f4\u7684\u5dee\u5f02\u3002\n# \u4f1a\u663e\u793a\u63d0\u4ea4\u7684\u5185\u5bb9\ngit lg -p commit_id # (\u67e5\u770b\u8fd9\u4e2acommit_id \u4ee5\u53ca\u4e4b\u524d\u6240\u6709\u7684\u63d0\u4ea4\u5185\u5bb9)\ngit lg -p #(\u67e5\u770b\u63d0\u4ea4\u5185\u5bb9  \u76f8\u6bd4git lg, \u591a\u4e86\u5185\u5bb9\u7684\u67e5\u770b)\ngit lg -p    + \u6587\u4ef6\u540d #\uff08\u53ef\u67e5\u770b\u8be5\u6587\u4ef6\u4ee5\u524d\u6bcf\u4e00\u6b21commit\u7684\u4fee\u6539\u5185\u5bb9\uff09\ngit lg -p -1 + \u6587\u4ef6\u540d #\uff08\u53ea\u67e5\u770b\u8be5\u6587\u4ef6\u5f53\u524d\u8fd9\u4e00\u6b21\u7684commit\u5185\u5bb9\uff09\ngit lg -p dev..fix/one # \u67e5\u770b\u4f60\u7684\u5206\u652f\u76f8\u5bf9\u4e8e\u672c\u5730dev\u5206\u652f\u505a\u4e86\u54ea\u4e9b\u4fee\u6539\ngit lg -p origin/master..HEAD # \u5f53\u524d\u5206\u652f\u6700\u65b0\u4ee3\u7801\u5bf9\u4e0e\u8fdc\u7a0bmaster\u5206\u652f\u505a\u4e86\u54ea\u4e9b\u4fee\u6539\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#rebase","title":"rebase","text":"<pre><code>git rebase -i commit_id\n# git rebase -i \u65e0\u6cd5\u628a\u7b2c\u4e00\u4e2acommit\u8fdb\u884c\u5408\u5e76\u7b49\u64cd\u4f5c\n# \u8fd9\u4e2a\u53ef\u4ee5 \u5c06\u6240\u6709commit \u5408\u5e76\u4e3a\u4e00\u4e2a.\ngit rebase -i --root\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#shortlog","title":"shortlog \u663e\u793a\u53d1\u5e03\u7b80\u62a5","text":"<p>Note</p> <p>\u53ef\u7528\u4e8e\u663e\u793a\u8fd9\u6b21\u53d1\u5e03,\u66f4\u65b0\u4e86\u54ea\u4e9b\u4e1c\u897f</p> <pre><code># v1.1.2 \u662f\u4f60\u4e0a\u6b21\u53d1\u5e03\u7684\u7248\u672c.\u8fd9\u91cc\u5c31\u663e\u793a \u8fd9\u6b21\u66f4\u65b0\u4e86\u54ea\u4e9b\u4e1c\u897f.\n# \u4f1a\u663e\u793a\u7528\u6237 \u63d0\u4ea4\u7684 commit message\ngit shortlog --no-merges v1.1.2..master\ngit shortlog --no-merges master --not v1.1.2\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#blame","title":"blame","text":"<pre><code>git blame world.txt\n# \u67e5\u770b world.txt 99-120\u884c \u7684\u4ee3\u7801\u60c5\u51b5 . \u6700\u540e\u66f4\u65b0\u4eba\u4e0e\u65f6\u95f4\ngit blame -L 99,120 world.txt\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#bundle","title":"bundle \u6253\u5305","text":"<pre><code># \u6253\u5305\u6574\u4e2amaster \u5206\u652f\ngit bundle create x.repo HEAD master\n# \u6839\u636e\u6253\u7684\u5305 clone \u4ed3\u5e93 \u5230 tmp_dir \u76ee\u5f55\ngit clone x.repo tmp_dir\n\n#\u6253\u5305\u51e0\u4e2a\u63d0\u4ea4\n#\u6253\u5305\u5f53\u524d\u6211\u4eec\u65b0\u589e\u52a0\u7684\u51e0\u4e2a\u63d0\u4ea4,\u672c\u5730fix/one\u5206\u652f\u76f8\u5bf9\u4e8e\u8fdc\u7a0b\u63d0\u4ea4\u4e86\u54ea\u4e9b\ngit bundle create ../new_commit.bundle origin/dev..fix/one\n\n# \u5207\u6362\u5230dev\u5206\u652f,\u62c9\u53d6\u6700\u65b0,\u7136\u540e\u6821\u9a8c\u770b\u662f\u5426\u80fd\u66f4\u65b0ok\ngit co dev\ngit pull\ngit bundle verify ../new_commit.bundle\n# \u5c06fix/one\u91cc\u7684\u63d0\u4ea4 ,\u5bfc\u5165\u5230wip \u5206\u652f\ngit pull ../new_commit.bundle   fix/one:wip\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#tag","title":"tag","text":"<pre><code># \u5217\u663e\u5df2\u6709\u7684\u6807\u7b7e\ngit tag\n# \u8fc7\u6ee4\u663e\u793a\ngit tag -l 'v1.4.2.*'\nv1.4.2.1\n    v1.4.2.2\n    v1.4.2.3\n# \u65b0\u5efa\u6807\u7b7e,\u4ee5\u5f53\u524dcommit\u4e3a\u51c6 \u6253\u4e0a\ngit tag -a v1.4 -m 'my version 1.4'\ngit show v1.4\n#\u8f7b\u91cf\u7ea7 \u6253\u6807\u7b7e\ngit tag v1.4\n\n# \u4e3a\u67d0\u4e2acommit \u6253\u4e0atag\ngit tag -a v1.2 9fceb02\n# \u63a8\u9001\u6807\u7b7e\u5230\u8fdc\u7a0b\ngit push origin v1.5\n# \u63a8\u9001\u6240\u6709\u6807\u7b7e\u5230\u8fdc\u7a0b\ngit push origin --tags\n</code></pre>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#gitignore","title":".gitignore","text":"<p>\u4ece github1 \u4e0a\u4e0b\u8f7d \u5bf9\u5e94\u8bed\u8a00\u7684.gitignore \u6587\u4ef6</p>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#_8","title":"\u4fdd\u7559\u6587\u4ef6\u5939,\u5ffd\u7565\u91cc\u9762\u7684\u5185\u5bb9","text":"<p>\u5728\u76ee\u6807\u6587\u4ef6\u5939\u5185\u5355\u72ec\u5efa\u4e00\u4e2a.gitignore\u6587\u4ef6\uff0c\u800c\u4e0d\u662f\u5199\u5728\u6839\u76ee\u5f55\u7684.gitignore\u91cc</p> <p><pre><code>*\n!.gitignore\n</code></pre> \u6216\u8005 \u76ee\u6807\u6587\u4ef6\u5939data\u91cc\u9762 \u6dfb\u52a0\u4e00\u4e2a.gitkeep \u603b\u7684.gitignore <pre><code>data/*\n!data/.gitkeep\n</code></pre></p>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"developer/git/git/#gitignore_1","title":"\u67e5\u770b\u6587\u4ef6\u662f\u5426\u7b26\u5408.gitignore\u89c4\u5219","text":"<pre><code># \u770b\u4e0b\u5f53\u524ddata\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6, \u662f\u5426\u88ab\u89c4\u5219\u5339\u914d\u5230.\ngit check-ignore -v ./data/abc\n# \u8fd4\u56de\u503c\u662f 0 \u8868\u793a\u8be5\u76ee\u5f55\u6587\u4ef6\u88ab \u5339\u914d\u5230,\u5c06\u88ab\u5ffd\u7565\n</code></pre> <ol> <li> <p>https://github.com/github/gitignore \u21a9</p> </li> </ol>","tags":["\u7a0b\u5e8f\u5458\u9884\u5907"]},{"location":"devops/cicd/drone/","title":"drone","text":""},{"location":"devops/cicd/drone/#provider-gogs","title":"provider gogs","text":"<p>\u4f60\u7684git\u670d\u52a1 \u662fgogs\u7684 \u60c5\u51b5.</p> <p>DRONE_AGENTS_ENABLED as true if you want to run server and agent in the same container(or \u670d\u52a1\u5668). \u4f46\u662fhttps://docs.drone.io/server/reference/ \u91cc \u6839\u672c\u6ca1\u6709\u8fd9\u4e2a\u914d\u7f6e. \u7136\u540e\u53c8\u5728https://docs.drone.io/server/provider/gogs/  Start the Server \u6b65\u9aa4\u91cc\u80fd\u770b\u5230...</p> <p>Server\u8d1f\u8d23\u63d0\u4f9bweb\u7ba1\u7406\u9875\u9762\u663e\u793a\u6267\u884c\u60c5\u51b5, Runner\u662f\u771f\u6b63\u6267\u884c\u6301\u7eed\u90e8\u7f72\u64cd\u4f5c\u7684\u670d\u52a1, \u4e0d\u540c\u7684\u60c5\u51b5 ,\u5c31\u9700\u8981\u5b89\u88c5\u4e0d\u540c\u7684runner, \u6bd4\u5982\u4f60\u4f7f\u7528docker\u53d1\u5e03,\u5c31\u5b89\u88c5docker\u7684runner</p> <p>Note</p> <p>We strongly recommend using postgres instead of mysql. The system has been optimized for features not found in mysql. \u5b98\u65b9\u76f8\u6bd4mysql \u66f4\u63a8\u8350\u4f7f\u7528postgres. \u5f53\u7136\u4f60\u53ef\u4ee5\u7528 sqlite DRONE_USER_CREATE \u91cc\u8bbe\u7f6e\u7684username ,\u4f60\u5e94\u8be5\u662f\u5728gogs\u91cc\u6709\u7684. username:root,machine:false,admin:true \u56e0\u4e3a\u6211\u4eec\u4f1a\u7528gogs\u7684\u8d26\u6237\u767b\u5f55,\u8fd9\u91cc\u8bbe\u7f6e\u6211\u4eec\u7528gogs\u767b\u5f55\u7684\u8d26\u6237root ,\u5b83\u4e3aadmin</p> <p>Warning</p> <p>\u6211\u5f53\u524d\u53d1\u73b0\u4e00\u4e2a\u95ee\u9898,\u5c31\u662f\u4f60\u767b\u5f55\u540e. \u7136\u540e docker compose down \u518d\u91cd\u65b0up, \u7136\u540e\u7528gogs \u521a\u521a\u767b\u5f55\u6210\u529f\u7684\u7528\u6237\u65e0\u6cd5\u767b\u5f55\u4e86. \u6211\u5728gogs\u91cd\u65b0\u521b\u5efa\u4e86\u4e00\u4e2a\u7528\u6237,\u53ef\u4ee5\u767b\u5f55... \u6682\u65f6\u8fd9\u6837\u8bb0\u5f55\u4e00\u4e0b</p> <p>https://github.com/drone-runners/drone-runner-docker \u770b\u7248\u672c, \u7528 :1 \u4f1a\u62c9\u53d6 1\u7684\u6700\u65b0\u7248.</p> docker-compose.yaml<pre><code>version: \"3\"\nvolumes:\ndrone-data:\nservices:\ndrone-server: # \u670d\u52a1\u7aef\nimage: drone/drone:2\ncontainer_name: drone-server\nrestart: always\nenvironment:\nDRONE_AGENTS_ENABLED: \"true\"\nDRONE_GOGS_SERVER: \"http://192.168.1.105:10880/\"\nDRONE_RPC_SECRET: \"00e8790ebd7e353bc75204f736207ece\"  #openssl rand -hex 16 \u751f\u6210\nDRONE_SERVER_HOST: \"192.168.1.105:8084\"\nDRONE_SERVER_PROTO: \"http\"\nDRONE_USER_CREATE: \"username:root,machine:false,admin:true\"\n# DRONE_DATABASE_DRIVER: mysql\n# DRONE_DATABASE_DATASOURCE: \"root:password@tcp(1.2.3.4:3306)/drone?parseTime=true&amp;loc=Local\"\nports:\n- \"8084:80\"\n- \"8443:443\"\nvolumes:\n- drone-data:/data\ndrone-runner:\nimage: drone/drone-runner-docker:1\ncontainer_name: drone-runner\nrestart: always\nenvironment:\nDRONE_RPC_PROTO: \"http\"\nDRONE_RPC_HOST: \"192.168.1.105:8084\"\nDRONE_RPC_SECRET: \"00e8790ebd7e353bc75204f736207ece\"\nDRONE_RUNNER_CAPACITY: \"2\"\nDRONE_RUNNER_NAME: \"my-runner\"\nports:\n- \"8300:3000\"\ndepends_on:\n- drone-server\nvolumes:\n- /var/run/docker.sock:/var/run/docker.sock\n- /etc/docker:/etc/docker\n</code></pre> <p>\u6d4f\u89c8\u5668\u6253\u5f008084\u7aef\u53e3 \u4f7f\u7528\u60a8\u7684<code>Gogs</code>\u7528\u6237\u540d\u548c\u5bc6\u7801\u767b\u5f55  (root/root) \u4e0b\u4e00\u6b65 \u4e0d\u7528\u7ba1 \u76f4\u63a5 submit \u53ef\u4ee5\u770b\u5230\u6211\u4eecgogs  \u4f60gogs\u767b\u5f55\u7684\u7528\u6237\u5728gogs\u91cc\u521b\u5efa\u76842\u4e2a \u4ed3\u5e93. \u5982\u679c\u6ca1\u6709, \u70b9\u51fbsync \u540c\u6b65,\u6bd4\u5982gogs\u90a3\u8fb9\u521a\u521a\u7528\u4ed3\u5e93\u8f6c\u79fb\u6240\u6709\u6743\u7ed9\u4e86\u767b\u5f55\u7528\u6237.</p>"},{"location":"devops/cicd/drone/#provider-gitea","title":"provider gitea","text":"<pre><code>version: \"3\"\nvolumes:\ndrone-data:\nservices:\ndrone-server:\nimage: drone/drone:2\ncontainer_name: drone-server\nrestart: always\nenvironment:\nDRONE_AGENTS_ENABLED: \"true\"\nDRONE_GITEA_SERVER: \"http://192.168.1.105:10880/\"\nDRONE_RPC_SECRET: \"00e8790ebd7e353bc75204f736207ece\"  #openssl rand -hex 16 \u751f\u6210\nDRONE_GITEA_CLIENT_ID: \"2d14bdbb-28e1-4e67-9c36-32ef6bc6edf4\"\nDRONE_GITEA_CLIENT_SECRET: \"gto_6bdgzvdgstzzucn4y2is4oi7wi6a7oyjg553yu5fcvasg4zozeja\"\nDRONE_SERVER_HOST: \"192.168.1.105:8084\"\nDRONE_SERVER_PROTO: \"http\"\nDRONE_USER_CREATE: \"username:root,machine:false,admin:true\"\nports:\n- \"8084:80\"\n- \"8443:443\"\nvolumes:\n- drone-data:/data\ndrone-runner:\nimage: drone/drone-runner-docker:1\ncontainer_name: drone-runner\nrestart: always\nenvironment:\nDRONE_RPC_PROTO: \"http\"\nDRONE_RPC_HOST: \"192.168.1.105:8084\"\nDRONE_RPC_SECRET: \"00e8790ebd7e353bc75204f736207ece\"\nDRONE_RUNNER_CAPACITY: \"2\"\nDRONE_RUNNER_NAME: \"my-runner\"\nports:\n- \"8300:3000\"\ndepends_on:\n- drone-server\nvolumes:\n- /var/run/docker.sock:/var/run/docker.sock\n- /etc/docker:/etc/docker\n</code></pre> <p>https://docs.gitea.com/administration/config-cheat-sheet?_highlight=allowed_host_list#webhook-webhook</p> <p>Question</p> <p>Delivery: Post \"http://192.168.1.105:8084/hook\": dial tcp 192.168.1.105:8084: webhook can only call allowed HTTP servers (check your webhook.ALLOWED_HOST_LIST setting), deny '192.168.1.105(192.168.1.105:8084)'</p> <pre><code>docker volume ls/inspect \u627e\u5230\u76ee\u5f55\n\u4fee\u6539app.ini\n\u6dfb\u52a0\n[webhook]\nALLOWED_HOST_LIST=private,*\n# \u6216? \u6211\u600e\u4e48\u7b2c\u4e00\u6b21\u5f04\u4e0d\u884c.. \u53ef\u4ee5\u518d\u8bd5\u8bd5...  \u597d\u50cf\u4e5f\u884c\u4e86.\nALLOWED_HOST_LIST=192.168.1.105\n\ndocker compose restart\n</code></pre>"},{"location":"devops/cicd/drone/#_1","title":"\u4f7f\u7528","text":"<p>drone\u9875\u9762 \u70b9\u51fb\u4e00\u4e2a\u4ed3\u5e93\u2192 settings\u2192 active Repository, \u7136\u540e\u52fe\u9009trusted</p> <p>\u7136\u540e\u6211\u4eec\u53bbgogs \u9875\u9762\u770b \u5bf9\u5e94\u4ed3\u5e93\u540d-\u4ed3\u5e93\u8bbe\u7f6e-\u7ba1\u7406Web\u94a9\u5b50 \u53ef\u4ee5\u770b\u5230\u521b\u5efa\u4e86\u4e00\u4e2ahook.</p> <ul> <li>\u73b0\u5728\u6211\u4eec\u63d0\u4ea4\u4ee3\u7801 \u589e\u52a0 .drone.yml (\u8fd9\u4e2a\u6587\u4ef6\u540d\u53ef\u4ee5\u5728drone\u9875\u9762\u8fdb\u884c\u4fee\u6539.)</li> </ul> <p>.drone.yml<pre><code>kind: pipeline\ntype: docker\nname: 6o6-web-publish\nenvironment:\nGOOS: linux\nGOARCH: amd64\nsteps:\n- name: build # git clone \u4ed3\u5e93,\u7136\u810f\u6784\u5efa\u955c\u50cf\u5e76\u63a8\u9001\nimage: plugins/docker\nvolumes:\n- name: hosts\npath: /etc/hosts # hb.6o6.com \u8fd9\u4e2a\u662f\u672c\u5730\u57df\u540d,\u9700\u8981\u6302\u8f7dhosts\n- name: docker-ca\npath: /etc/docker  # \u767b\u5f55 \u79c1\u6709\u955c\u50cf\u4ed3\u5e93  \u9700\u8981\u8bc1\u4e66.\n- name: docker-sock\npath: /var/run/docker.sock\nsettings:\nusername: admin\npassword:\nfrom_secret: harbor_password # drone\u9875\u9762\u91cc\u5bf9\u5e94\u4ed3\u5e93 settings-&gt;secrets-&gt;\u521b\u5efa\u8fd9\u4e2a\u540d\u5b57\u7684,\u5bc6\u7801\u662fharbor\u7684hb123\nrepo: hb.6o6.com/6o6/6o6-web\nregistry: hb.6o6.com\ntags:\n- v1.1\n- name: ssh commands # \u542f\u52a8\u4e00\u4e2a\u5bb9\u5668\u53bbssh\u8fde\u63a5\u670d\u52a1\u5668 ,\u7136\u540e\u62c9\u53d6\u955c\u50cf\u542f\u52a8\u5bb9\u5668\nimage: appleboy/drone-ssh\nsettings:\nhost: 192.168.1.105\nusername: root\npassword:\nfrom_secret: ssh_password # root ssh \u8fde\u63a5192.168.1.105\u65f6 \u7528\u7684\u5bc6\u7801\nport: 22  # 2340 \u662f\u6620\u5c04\u5230\u4e3b\u673a\u7684\u7aef\u53e3.. \u8fd9\u91cc\u8fd8\u662f22\nscript:\n#\u62c9\u53d6\u955c\u50cf\u5e76\u91cd\u542f \u6ce8\u610f--\u9700\u8981\u63d0\u524d\u5728\u76ee\u6807\u4e3b\u673a\u5b8c\u6210docker login\n- if [ $(docker ps -a | grep 6o6-web | wc -l) -ge 1 ];then docker stop 6o6-web &amp;&amp; docker rm 6o6-web; fi\n- docker pull hb.6o6.com/6o6/6o6-web:v1.1\n- export BACKEND_HOST=http://192.168.1.105:8082/\n- docker run --name 6o6-web --restart=always -d -p8081:80 -e BACKEND_HOST=$BACKEND_HOST hb.6o6.com/6o6/6o6-web:v1.1\nvolumes:\n- name: hosts\nhost:\npath: /etc/hosts\n- name: docker-ca\nhost:\npath: /etc/docker\n- name: docker-sock\nhost:\npath: /var/run/docker.sock\n</code></pre> <pre><code>git add . git ci -m \"first build\"\ngit push\n# \u63a8\u9001\u540e, \u6211\u4eec\u5728gogs\u4e0a \u7ba1\u7406web hook \u90a3\u91cc\u770b\u5230\u63a8\u9001\u8bb0\u5f55.\n# \u89e6\u53d1\u4e86 web hook, \u4f1a\u53bb\u8bf7\u6c42 http://192.168.1.105:8084/hook\n# \u5c31\u4f1a\u5728 drone \u6240\u5728\u670d\u52a1\u5668 \u505a\u4e00\u4e9b\u64cd\u4f5c\u4e86. \u6839\u636e.drone.yml\u91cc\u7684\u5185\u5bb9\n</code></pre></p> <p>Note</p> <p>\u9700\u8981\u5728gogs\u91cc\u914d\u7f6e \u767d\u540d\u5355, \u5426\u5219web hook \u5931\u8d25</p> <pre><code>docker volume inspect gogs_gogs-data\nvim /var/lib/docker/volumes/gogs_gogs-data/_data/gogs/conf/app.ini\n[security] \u4e0b\nLOCAL_NETWORK_ALLOWLIST = 192.168.1.105 # \u6dfb\u52a0 drone\u6240\u5728\u670d\u52a1\u5668.\n\u91cd\u542fgogs \u5bb9\u5668\n\u518d push \u770b\u770b \u770b\u5230ok\u7684\n\u7136\u540e\u53bb drone \u9875\u9762\u770b ,\u6784\u5efaok\u7684\u8bdd,  \u6211\u4eec\u5c31\u53ef\u4ee5\u53bb\u8bbf\u95ee \u542f\u52a8\u7684\u5bb9\u5668web\u670d\u52a1 8081 \u7aef\u53e3\n</code></pre> <p>Note</p> <p>\u4f7f\u7528gogs provider, \u767b\u5f55drone\u540e, \u9000\u51fa\u518d\u7b49,\u5c31\u62a5\u9519.. \u63d0\u793a\u6ca1\u6709\u6743\u9650</p> <ol> <li> <p>drone \u21a9</p> </li> <li> <p>drone github \u21a9</p> </li> <li> <p>drone github \u21a9</p> </li> <li> <p>gogs provider \u21a9</p> </li> </ol>"},{"location":"devops/cicd/git-server/","title":"git\u670d\u52a1","text":""},{"location":"devops/cicd/git-server/#git","title":"git \u670d\u52a1","text":"<p>gitea</p>"},{"location":"devops/cicd/git-server/#gogs","title":"gogs","text":"<p>gogs github docker\u65b9\u5f0f\u5b89\u88c5 docker-compose<pre><code>version: \"3\"\nvolumes:\ngogs-data:\nservices:\ngogs:\nimage: gogs/gogs\n#  image: gogs/gogs:0.12.10\ncontainer_name: gogs\nvolumes:\n- gogs-data:/data\nrestart: always\nports:\n- \"10022:22\"\n- \"10880:3000\"\n</code></pre> \u6d4f\u89c8\u5668\u8bbf\u95ee10880\u7aef\u53e3</p> <pre><code>SSH \u7aef\u53e3\u53f7 \u6539\u6210\u4e0a\u9762\u8bbe\u7f6e\u768410022\n\u6570\u636e\u5e93\u7c7b\u578b \u81ea\u5df1\u6d4b\u8bd5\u53ef\u4ee5\u6682\u65f6\u4f7f\u7528sqlite\n\u57df\u540d \u6539\u6210 ip\u5730\u5740. 192.168.1.105\n\u5e94\u7528 URL \u6539\u6210 http://192.168.1.105:10880/\n\n\u7ba1\u7406\u5458\u5e10\u53f7\u8bbe\u7f6e  \u6211\u8bbe\u7684 root root\n\nssh\u8bbe\u7f6e\u6dfb\u52a0\u5bc6\u94a5\n\u53f3\u4e0a\u89d2\u70b9\u51fb+\u53f7, \u521b\u5efa\u65b0\u7684\u4ed3\u5e93\n\u7136\u540e\u4f60\u7684\u4ee3\u7801\u90a3\u91cc git remote add origin ... \ngit push -u origin master \n</code></pre>"},{"location":"devops/cicd/git-server/#gitea","title":"gitea","text":"<p>docker-compose.yaml<pre><code>version: \"3\"\nnetworks:\ngitea:\nexternal: false\nvolumes:\ngitea-data:\nservices:\nserver:\nimage: gitea/gitea:latest\ncontainer_name: gitea\nenvironment:\n- USER_UID=1000\n- USER_GID=1000\nrestart: always\nnetworks:\n- gitea\nvolumes:\n- gitea-data:/data\n- /etc/timezone:/etc/timezone:ro\n- /etc/localtime:/etc/localtime:ro\nports:\n- \"10022:22\"\n- \"10880:3000\"\n</code></pre> \u6d4f\u89c8\u5668\u8bbf\u95ee10880\u7aef\u53e3</p> <p>\u7ba1\u7406\u540e\u53f0\u2192\u5e94\u7528\u2192 \u521b\u5efaoauth(url \u586b\u5199drone\u7684\u767b\u5f55url : http://192.168.1.105:8084/login) \u8bb0\u4f4f \u5ba2\u6237\u7aefID\u548c\u5ba2\u6237\u7aef\u5bc6\u94a5 \u5728drone\u4e2d \u586b\u5199..</p>"},{"location":"devops/cicd/github-action/","title":"github-action","text":""},{"location":"devops/cicd/github-action/#github-action","title":"github action","text":"<p>github action github action</p> <p>\u4ee5hugo \u4e3a\u4f8b \u6b63\u5e38\u6211\u4eec\u7684\u53d1\u5e03\u6d41\u7a0b\u53ef\u80fd\u662f\u8fd9\u6837 1. build \u672c\u5730\u4ee3\u7801 \u751f\u6210\u9759\u6001\u6587\u4ef6 2. \u4e0a\u4f20\u5230\u670d\u52a1\u5668 (\u6bd4\u5982scp\u64cd\u4f5c) 3. \u57df\u540d\u914d\u7f6e \u6bd4\u5982nginx</p> <p>github action \u5c31\u662f\u542f\u52a8\u4e00\u4e2a\u5c0f\u7684\u865a\u62df\u673a,\u53d1\u73b0\u4f60push\u540e,\u5c31\u505a\u67d0\u4e9b\u64cd\u4f5c ,\u6bd4\u5982build \u548cscp \u7684\u64cd\u4f5c</p> <p><pre><code># 1. \u5f53\u524dgit\u4ed3\u5e93\u4e2d \u521b\u5efa.github/workflows/ \u76ee\u5f55\nmkdir -p .github/workflows/\ntouch .github/workflows/learn-github-actions.yml\n</code></pre> learn-github-actions.yml<pre><code>name: learn-github-actions\nrun-name: ${{ github.actor }} is learning GitHub Actions\non: [push] # \u5f53\u6709push \u63a8\u9001\u65f6 \u4f1a\u89e6\u53d1\u6211\u4eec\u7684job (1)\njobs:\ncheck-bats-version: # \u8fd9\u4e2a\u4f60\u4f60\u7684\u4efb\u52a1\u7684\u540d\u5b57, \u968f\u4fbf\u8d77, \u5f53\u7136\u6211\u4eec\u8d77\u4e00\u4e2a\u80fd\u8868\u660e\u4efb\u52a1\u7684\u540d\u5b57..\n# \u5c06\u4f5c\u4e1a\u914d\u7f6e\u4e3a\u5728\u6700\u65b0\u7248\u672c\u7684 Ubuntu Linux \u8fd0\u884c\u5668\u4e0a\u8fd0\u884c\u3002 \n# \u8fd9\u610f\u5473\u7740\u8be5\u4f5c\u4e1a\u5c06\u5728 GitHub \u6258\u7ba1\u7684\u65b0\u865a\u62df\u673a\u4e0a\u6267\u884c\nruns-on: ubuntu-latest\nsteps:\n#  uses \u5173\u952e\u5b57\u6307\u5b9a\u6b64\u6b65\u9aa4\u5c06\u8fd0\u884c actions/checkout \u64cd\u4f5c\u7684 v3 (2)\n# \u6211\u4eec\u53ef\u4ee5\u4ece\u5b57\u9762\u4e0a\u770b\u51fa\u8fd9\u662f\u4e00\u4e2a git checkout  \u4ed3\u5e93\u7684\u64cd\u4f5c.\n# \u5c06\u4ed3\u5e93 checkout\u5230\u8fd0\u884c\u5668(\u865a\u62df\u673a)\u4e0a\n- uses: actions/checkout@v3 #\n# checkout \u4ee3\u7801\u540e, \u7136\u540e\u8fd9\u91cc\u662f\u5b89\u88c5 node\n- uses: actions/setup-node@v3\nwith:\nnode-version: '14' # \u5b89\u88c5\u7684\u7248\u672c\u662f14\n- run: npm install -g bats # \u6267\u884c\u547d\u4ee4\n- run: bats -v\n</code></pre></p> <ol> <li>\u6307\u5b9a\u5206\u652f\u7684push\u53d1\u751f\u65f6    \u5b98\u65b9\u6587\u6863 <pre><code>on:\npush:\nbranches:\n- main\n- 'releases/**'\n</code></pre></li> <li>\u5b9e\u9645\u662f\u4e2agithub\u4ed3\u5e93\u54e6    https://github.com/actions/checkout</li> </ol> <p>https://github.com/peaceiris/actions-hugo https://github.com/peaceiris/actions-gh-pages</p> <p>my_repo/nav_src hugo\u535a\u5ba2\u6e90\u7801, \u7136\u540e\u6211\u60f3\u8981push\u540e,\u81ea\u52a8build \u751f\u6210\u9759\u6001\u6587\u4ef6,\u53d1\u5e03\u5230\u53e6\u5916\u4e00\u4e2a\u4ed3\u5e93\u4e2d</p> hugo.yml<pre><code>name: Hugo Actions\non:\npush:\nbranches:\n- main  # \u8fd9\u91cc\u7684\u610f\u601d\u662f\u5f53 main \u5206\u652f\u53d1\u751f push \u7684\u65f6\u5019\uff0c\u8fd0\u884c\u4e0b\u9762\u7684 jobs\njobs:\ndeploy:\nruns-on: ubuntu-latest\nsteps:\n- uses: actions/checkout@v3\n#   with:\n#     submodules: true  # Fetch submodule\n#     fetch-depth: 0 \n- name: Setup Hugo\nuses: peaceiris/actions-hugo@v2 # hugo\u5b98\u65b9\u7684action, \u5b89\u88c5hugo\nwith:\nhugo-version: '0.110.0'   # \u5b89\u88c5\u6307\u5b9a\u7248\u672c\u7684hugo\n- name: Build\nrun: hugo --minify  # \u4f7f\u7528hugo\u751f\u6210\u9759\u6001\u7f51\u9875\n- name: Deploy To another  repository  # \u90e8\u7f72\u81f3\u5176\u4ed6\u4ed3\u5e93,\u4e5f\u53ef\u4ee5\u662f\u5176\u4ed6\u5206\u652f\nuses: peaceiris/actions-gh-pages@v3 # hugo\u5b98\u65b9\u63d0\u4f9b\u7684\u81ea\u52a8\u53d1\u5e03github pages\u7684action\nwith:\nexternal_repository: my_repo/nav  # \u53d1\u5e03\u5230\u54ea\u4e2arepo\npersonal_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}\n# hugo \u751f\u6210\u7684\u9759\u6001\u6587\u4ef6\u5728 public \u76ee\u5f55, \u8fd9\u91cc\u7684\u610f\u601d\u662f \u8981\u53d1\u5e03 public \u6587\u4ef6\u5939\u91cc\u7684\u5185\u5bb9\npublish_dir: ./public\npublish_branch: main  # \u53d1\u5e03\u5230\u54ea\u4e2a\u5206\u652f\nforce_orphan: true\nfull_commit_message: ${{ github.event.head_commit.message }}\n</code></pre> <p>PERSONAL_ACCESS_TOKEN\u6539\u6210\u4f60\u8bbe\u7f6e\u7684NAME</p> <ol> <li> <p>\u521b\u5efa Personal_Access_Token\uff1a      </p> <ul> <li>Note: \u7ed9token \u63cf\u8ff0</li> <li>Expiration: No expiration</li> <li>Select scopes: \u5168\u9009</li> </ul> <p>\u751f\u6210\u540e, \u590d\u5236token</p> </li> <li> <p>\u76ee\u6807\u4ed3\u5e93 \u8bbe\u7f6e Personal_Access_Token\uff1a</p> <p>\u6253\u5f00\u76ee\u6807\u4ed3\u5e93\u9875\u9762 -&gt; \u70b9\u51fbSettings -&gt; Security -&gt; Secrets and variables -&gt; Actions\uff0c\u9009\u62e9 New repository secret -&gt;\u8bbe\u7f6e\u4e00\u4e2a\u540d\u5b57 NAME (\u6bd4\u5982 DEPLOY2NAV) -&gt; \u7c98\u8d34\u524d\u9762\u751f\u6210\u7684 personal_access_token</p> </li> <li> <p>\u5c06hugo.yml \u91cc\u7684 PERSONAL_ACCESS_TOKEN \u6539\u6210DEPLOY2NAV</p> </li> </ol> <p>push \u540e\u53bb\u770b my_repo/nav_src \u4ed3\u5e93\u7684 Actions ,\u770b\u6267\u884c\u7684\u547d\u4ee4\u60c5\u51b5. \u6210\u529f\u7684\u8bdd,\u4f1a\u5728 <code>my_repo/nav</code>\u4ed3\u5e93\u91cc\u770b\u5230\u9759\u6001\u9875\u9762.</p>"},{"location":"devops/docker/architecture/","title":"\u67b6\u6784","text":"<p>Note</p> <p>\u5f85\u505a</p> <p>OCI Containerd RunC</p> <p></p>"},{"location":"devops/docker/docker-compose/","title":"docker-compose","text":"<p>https://docs.docker.com/compose/install/linux/</p> <p><pre><code># \u5b89\u88c5\napt-get install docker-compose-plugin\n</code></pre> <pre><code># Compose standalone \u65b9\u5f0f\ndocker-compose -f docker-compose.yml  up -d\n# Compose plugin \u65b9\u5f0f\ndocker compose up -d # \u4e0d\u80fd\u6307\u5b9a\u6587\u4ef6...?\n# \u4e0b\u9762\u7684\u64cd\u4f5c\u90fd\u9700\u8981\u5728 \u6709docker-compose.yml \u6587\u4ef6\u7684\u76ee\u5f55\u4e0b\u6267\u884c\ndocker-compose stop\ndocker-compose down # \u505c\u6b62\u5bb9\u5668\u5e76\u4e14\u5220\u9664\u5bb9\u5668\ndocker compose ps # \u67e5\u770b \u7528compose \u542f\u52a8\u7684\u5bb9\u5668\n# \u8fdb\u5165\u67d0\u4e2a\u5bb9\u5668\n# \u8fd9\u91cc\u5c31\u7528db \u5c31\u53ef\u4ee5\u4e86\n# \u5982\u679c\u4f7f\u7528 docker exec \u9700\u8981\u7684\u540d\u5b57\u5c31\u4e0d\u4e00\u6837\u4e86 docker ps -a \u67e5\u770b\ndocker-compose exec db sh\ndocker compose restart\n</code></pre> <pre><code>version: '3'\nservices:\ndb:\nimage: mysql:5.7\ncontainer_name: my_db\nports:\n- 3306:3306\nvolumes:\n- mysql-data:/var/lib/mysql\nenvironment:\nMYSQL_ALLOW_EMPTY_PASSWORD: 1  #\u5fc5\u987b\u4f7f\u75281 \u624d\u884c,\nnetworks:\n- my-bridge\nvolumes:\nmysql-data:    # \u8fd9\u6837\u8bbe\u7f6e\u8868\u793a\u4e00\u4e2a\u5377\u6807 ,\u4e0a\u9762\u7684\u6302\u8f7d, \u4e0d\u77e5\u9053\u6302\u8f7d\u5230\u54ea\u91cc\u4e86\nnetworks:\nmy-bridge:\ndriver: bridge\n</code></pre> <pre><code>docker volume ls |grep mysql-data\n# local               dockerfile_mysql-data\n# \u627e\u5230\u4f4d\u7f6e\ndocker volume inspect   dockerfile_mysql-data\n</code></pre></p>"},{"location":"devops/docker/docker-compose/#yml","title":"\u4e00\u4e9b\u7b80\u6613\u7684yml","text":"<p>consul<pre><code>version: '3'\nservices:\nconsul:\nimage: consul\nrestart: always\ncontainer_name: consul_server\nnetwork_mode: bridge volumes: - ./consul:/tmp/consul\nports:\n- 8300:8300\n- 8301:8301\n- 8301:8301/udp\n- 8302:8302\n- 8302:8302/udp\n- 8400:8400\n- 8500:8500\n- 8600:8600/udp\n- 53:53/udp\ncommand: consul agent -data-dir=/tmp/consul -dev -client=0.0.0.0\n</code></pre> grafana<pre><code>version: \"3\"\nservices:\ngrafana:\nimage: grafana/grafana\nports:\n- 3000:3000\nenvironment:\n#   GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource\n#   GF_SECURITY_ADMIN_PASSWORD=admin\nGF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource # \u5361\u7684\u8bdd,\u4f7f\u7528url\u5730\u5740\u6765;\u540e\u9762\u662f\u522b\u540d \u7136\u540e\u7528,\u9694\u5f00\u8868\u793a\u53e6\u5916\u4e00\u4e2a\u63d2\u4ef6 https://codeload.github.com/grafana/clock-panel/legacy.zip/bb466d0682d58af659b018748d53c0d3b69a8377;clock-panel,https://codeload.github.com/grafana/simple-json-datasource/legacy.zip/87ced44c4587eae39eeedcbd4b2936593724de16;simple-json-datasource\nGF_SECURITY_ADMIN_PASSWORD: admin\nvolumes:\n- ./grafana:/var/lib/grafana\n</code></pre></p> <p>mysql<pre><code>version: '3'\nservices:\ndb:\nimage: mysql:5.7\ncontainer_name: mysql\nports:\n- 3306:3306\nenvironment:\nMYSQL_ALLOW_EMPTY_PASSWORD: 1\nvolumes:\n- ./mysql/data:/var/lib/mysql\nnetworks:\n- my-bridge\nnetworks:\nmy-bridge:\ndriver: bridge\n</code></pre> rabbitmq<pre><code>version: '3.1'\nservices:\nrabbitmq:\nimage: rabbitmq:3.6.9-management\nports:\n- \"4369:4369\"\n- \"5671:5671\"\n- \"5672:5672\"\n- \"15672:15672\"\n- \"25672:25672\"\nhostname: rmq\ncontainer_name: rabbitmq\nenvironment:\nRABBITMQ_DEFAULT_VHOST: /\nRABBITMQ_DEFAULT_USER: admin\nRABBITMQ_DEFAULT_PASS: admin\nRABBITMQ_LOGS: /var/lib/rabbitmq/rabbitmq.log\nRABBITMQ_SASL_LOGS: /var/lib/rabbitmq/rabbitmq-sasl.log\nRABBITMQ_ERLANG_COOKIE: LZJADKXKLULIXFKAALGX\nTZ: Asia/Shanghai\n#extra_hosts:\n#      - \"rmq_node1:172.16.11.106\"\n#- \"rmq_node2:172.16.11.156\"\n#      - \"rmq_node3:172.16.11.206\"\nvolumes:\n- ./rabbitmq:/var/lib/rabbitmq\n#      - /etc/hosts:/etc/hosts\nrestart: always\n</code></pre> redis<pre><code>version: '3'\nservices:\nredis:\nimage: redis:alpine\ncontainer_name: redis\n#    restart: always\nvolumes:\n- ~/docker_data/redis/data:/data\n- ~/docker_data/redis/logs:/logs\n#- ./conf/redis.conf:/usr/local/etc/redis/redis.conf\nports:\n- 6379:6379\n</code></pre></p>"},{"location":"devops/docker/docker-compose/#vscode-go","title":"vscode go\u5f00\u53d1\u7528","text":"<p>golang-vscode2</p> <p>nacos1</p> <ol> <li> <p>nacos-docker \u21a9</p> </li> <li> <p>https://github.com/microsoft/vscode-remote-try-go \u21a9</p> </li> </ol>"},{"location":"devops/docker/docker-file/","title":"dockerfile","text":"<p>Warning</p> <p>\u672a\u5b8c\u5f85\u7eed</p>","tags":["docker"]},{"location":"devops/docker/docker-file/#dockerfile","title":"dockerfile \u6307\u4ee4","text":"","tags":["docker"]},{"location":"devops/docker/docker-file/#from","title":"from","text":"<p>FROM:\u9009\u62e9\u57fa\u7840\u955c\u50cf\uff0c\u63a8\u8350 alpine <pre><code>FROM [--platform=&lt;platform&gt;] &lt;image&gt;[@&lt;digest&gt;] [AS &lt;name&gt;]\n</code></pre></p>","tags":["docker"]},{"location":"devops/docker/docker-file/#label","title":"LABEL","text":"<p>maintainer \u5e9f\u5f03</p> <p>\u6309\u6807\u7b7e\u7ec4\u7ec7\u9879\u76ee (\u4e0d\u7528\u641e\u76ee\u5f55\u4ec0\u4e48\u7684.)</p> <pre><code>LABEL multi.label1=\"value1\" multi.label2=\"value2\" other=\"value3\"\n</code></pre> <p>\u914d\u5408 label filter \u53ef\u8fc7\u6ee4\u955c\u50cf\u67e5\u8be2\u7ed3\u679c</p> <pre><code>docker images -f label=multi.label1=\"value1\"\n</code></pre> <p>\u67e5\u770b\u955c\u50cf\u7684label</p> <pre><code># -A 10 \u770b labels \u540e10\u884c\ndocker inspect image_name |grep labels -A 10\n</code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#run","title":"RUN","text":"<p>Warning</p> <p>\u8fd9\u4e24\u6761\u547d\u4ee4\u5e94\u8be5\u6c38\u8fdc\u7528&amp;&amp;\u8fde\u63a5\uff0c\u5982\u679c\u5206\u5f00\u6267\u884c\uff0cRUN apt-get update \u6784\u5efa\u5c42\u88ab\u7f13\u5b58\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u65b0 package \u65e0\u6cd5\u5b89\u88c5</p> <p>\u6267\u884c\u547d\u4ee4,\u6700\u5e38\u89c1\u7684\u7528\u6cd5\u662f <pre><code>RUN apt-get update &amp;&amp; apt-get install\n</code></pre></p>","tags":["docker"]},{"location":"devops/docker/docker-file/#cmd","title":"CMD","text":"<p>Tip</p> <ol> <li>\u8fd0\u884c\u7684\u547d\u4ee4\u4f1a\u88ab\u5b9e\u9645\u6267\u884c\u662f\u6307\u5b9a\u7684\u547d\u4ee4\u8986\u76d6</li> <li>\u5b9a\u4e49\u4e86\u591a\u4e2a,\u53ea\u6709\u6700\u540e\u4e00\u4e2a\u4f1a\u6267\u884c</li> <li>\u5f53\u6307\u5b9a\u4e86 ENTRYPOINT \u540e\uff0cCMD \u7684\u542b\u4e49\u5c31\u53d1\u751f\u4e86\u6539\u53d8\uff0c\u4e0d\u518d\u662f\u76f4\u63a5\u7684\u8fd0\u884c\u5176\u547d\u4ee4\uff0c\u800c\u662f\u5c06 CMD \u7684\u5185\u5bb9\u4f5c\u4e3a\u53c2\u6570\u4f20\u7ed9 ENTRYPOINT \u6307\u4ee4</li> </ol> <p><pre><code>CMD [\"executableA\", \"param1\", \"param2\"...]\nCMD [\"executableB\", \"param1\", \"param2\"...]\n</code></pre> <pre><code># \u8fd9\u4e2aecho hello \u4f1a\u8986\u76d6\u914d\u7f6e\u91cc\u7684cmd, \u914d\u7f6e\u91cc\u7684cmd\u4e0d\u4f1a\u6267\u884c\n# \u5728\u6ca1\u6709 ENTRYPOINT\u7684\u65f6\u5019,\u6211\u4eec\u8fd0\u884c\u5bb9\u5668, \u60f3\u6267\u884c\u4ec0\u4e48\u547d\u4ee4\u5c31\u6267\u884c\u4ec0\u4e48\u547d\u4ee4\ndocker run image_name echo hello\n</code></pre></p>","tags":["docker"]},{"location":"devops/docker/docker-file/#entrypoint","title":"ENTRYPOINT","text":"<p>Tips</p> <ul> <li>\u5b9a\u4e49\u53ef\u4ee5\u6267\u884c\u7684\u5bb9\u5668\u955c\u50cf\u5165\u53e3\u547d\u4ee4 ,\u5fc5\u5b9a\u4f1a\u6267\u884c,\u4e0d\u4f1a\u88ab\u8986\u76d6</li> <li>\u5728\u4e0d\u6307\u5b9aentrypoint\u7684\u60c5\u51b5\u4e0b,Docker \u4f1a\u4e3a\u4f60\u63d0\u4f9b\u4e00\u4e2a\u9690\u542b\u7684 ENTRYPOINT\uff0c\u5373:/bin/sh -c, \u6240\u4ee5\u4f60\u7684cmd \u662f\u8fd9\u4e2a\u7684\u53c2\u6570\u54e6</li> <li>\u4e0d\u8fc7docker run \u65f6\u6307\u5b9a--entrypoint \u53ef\u4ee5\u8986\u76d6</li> </ul> <pre><code># \u6211\u4eec\u4e00\u822c \u662f\u4e0d\u4f1a\u8fd9\u4e48\u505a\u7684...\ndocker run -it --entrypoint /bin/bash image_name # \u6ce8\u610f\u8986\u76d6\u7684\u662f entrypoint \u91cc\u7684\u6307\u4ee4,\n# \u8bbe\u7f6e\u7684cmd \u8fd8\u662f\u4f5c\u4e3a entrypoint \u7684\u53c2\u6570,\u8fd9\u91cc\u53ef\u4ee5\u6307\u5b9a\u53c2\u6570 /usr/share/nginx/html\ndocker run -it --entrypoint ls nginx  /usr/share/nginx/html\n\n# \u8fd9\u4e2a\u662f\u8fdb\u5165\u5bb9\u5668\u6267\u884c, \u4e0d\u662f\u8bf4\u8986\u76d6\u4e86\u539f\u6765\u7684entrypoint..  \u522b\u6df7\u6dc6\u4e86.\n# \u4efb\u4f55\u8fd0\u884c\u7684\u5bb9\u5668,\u90fd\u53ef\u4ee5\u8fd9\u6837\u64cd\u4f5c..\ndocker exec -it image_name bash\n</code></pre> <pre><code>#docker run \u2013-entrypoint \u53ef\u66ff\u6362 Dockerfile \u4e2d\u5b9a\u4e49\u7684 ENTRYPOINT  \n#ENTRYPOINT \u7684\u6700\u4f73\u5b9e\u8df5\u662f\u7528 ENTRYPOINT \u5b9a\u4e49\u955c\u50cf\u4e3b\u547d\u4ee4\uff0c\u5e76\u901a\u8fc7 CMD \u5b9a\u4e49\u4e3b\u8981\u53c2\u6570\uff0c\u5982\u4e0b\u6240\u793a\nENTRYPOINT [\"sed\"]\nCMD [\"--help\"]\n#\u53ef\u4ee5\u8fd9\u6837, \u8fd9\u6837\u7684\u8bdd, \u5c31\u770b\u4f60\u8fd0\u884c\u7684\u65f6\u5019\u6307\u5b9a\u5565\u4e86.\nCMD []\n</code></pre> <p><pre><code>FROM ubuntu\nRUN apt-get update &amp;&amp; apt-get install  -y stress\nENTRYPOINT [\"/usr/bin/stress\"]\nCMD []\n</code></pre> <pre><code>docker build -t stress .\n# \u6307\u5b9a\u7684\u53c2\u6570-v\u4f1a\u8986\u76d6 dockerfile\u91cc\u914d\u7f6e\u7684cmd\ndocker run --rm stress -v\n</code></pre></p>","tags":["docker"]},{"location":"devops/docker/docker-file/#exec-shell","title":"exec\u6a21\u5f0f \u4e0e shell\u6a21\u5f0f","text":"<p>shell\u6a21\u5f0f\u4e0eexec\u6a21\u5f0f\u7684\u533a\u522b</p> <p>shell \u6a21\u5f0f\u4f1a\u5ffd\u7565\u6240\u6709 CMD \u547d\u4ee4\u7684\u53c2\u6570\u548c docker run \u7684\u547d\u4ee4\u884c\u53c2\u6570\uff0cENTRYPOINT \u8981\u8fd0\u884c\u7684\u547d\u4ee4\u4f1a\u4f5c\u4e3a /bin/sh -c \u7684\u5b50\u547d\u4ee4\u8fd0\u884c\uff0c\u800c\u4e14 /bin/sh \u4e0d\u4f1a\u4f20\u9012\u4fe1\u53f7\uff0c\u4e5f\u5c31\u662f\u8bf4 ENTRYPOINT \u8981\u8fd0\u884c\u7684\u547d\u4ee4\u4e0d\u662f PID \u4e3a 1 \u7684\u8fdb\u7a0b\uff0c\u4e14\u4e0d\u4f1a\u6536\u5230 Unix \u4fe1\u53f7\uff0c\u6240\u4ee5\u4f60\u8981\u6267\u884c\u7684\u547d\u4ee4\u4e0d\u4f1a\u6536\u5230 docker stop  \u53d1\u51fa\u7684 SIGTERM \u4fe1\u53f7 (\u8fd9\u91cc\u8bf4\u7684\u662f,\u4e0d\u4f1a\u4f18\u96c5\u9000\u51fa, \u5c31\u662f\u76f4\u63a5\u505c\u6b62\u4e86\u5bb9\u5668, \u8fd8\u6ca1\u505c\u6b62\u91cc\u9762\u7684\u7a0b\u5e8f, \u53ef\u4ee5\u5199\u4e2a\u7a0b\u5e8f\u6d4b\u8bd5) \u4e00\u822c\u60c5\u51b5\u4e0b,\u6211\u4eec\u505c\u6b62\u4e00\u4e2a\u670d\u52a1, \u662f\u9700\u8981\u4f18\u96c5\u9000\u51fa\u7684. \u6bd4\u5982nginx ,\u4f1a\u5148\u8ba9\u5176\u5904\u7406\u5df2\u7ecf\u53d1\u9001\u8fc7\u6765\u7684\u8bf7\u6c42.</p> exec\u6a21\u5f0f (\u63a8\u8350)shell\u6a21\u5f0fgo\u7a0b\u5e8f\u6d4b\u8bd5 <p><pre><code># exec \u6a21\u5f0f\nENTRYPOINT [\"executable\", \"param1\", \"param2\"] </code></pre> <pre><code>FROM ubuntu\nENTRYPOINT [\"top\", \"-b\"]\nCMD [\"-c\"]\n</code></pre> <pre><code>docker build -t top .\ndocker run --rm --name top top\n# \u7136\u540e\u5728\u53e6\u5916\u4e00\u4e2a\u4f1a\u8bdd\u6267\u884c \u4e0b\u9762\u7684, \u53ef\u4ee5\u770b\u5230, \u6267\u884c\u7684\u547d\u4ee4\u672c\u8eab pid =1\ndocker exec -it top ps -ef\n    UID        PID  PPID  C STIME TTY          TIME CMD\n    root         1     0  0 03:29 ?        00:00:00 top -b -c\n    root        16     0  0 03:30 pts/0    00:00:00 ps -ef\n\u6211\u4eec\u53ef\u4ee5 ctrl+c \u9000\u51fa\n</code></pre></p> <pre><code>ENTRYPOINT command param1 param2\n</code></pre> <p><pre><code>FROM ubuntu\nENTRYPOINT top -b\nCMD -c\n</code></pre> <pre><code># \u662f pid=1 \u7684shell \u8fdb\u7a0b\u7684 \u5b50\u8fdb\u7a0b\ndocker exec -it stest ps -ef\n    UID        PID  PPID  C STIME TTY          TIME CMD\n    root         1     0  0 03:36 ?        00:00:00 /bin/sh -c top -b /bin/sh -c -c\n    root         7     1  0 03:36 ?        00:00:00 top -b\n    root        17     0  0 03:36 pts/0    00:00:00 ps -ef\n#ctrl+c \u6ca1\u53cd\u5e94.. \n</code></pre></p> <p>Warning</p> <p>\u5199\u7684\u4ee3\u7801 \u6d4b\u8bd5\u4fe1\u53f7\u63a5\u6536.. \u4ee3\u7801\u6682\u65f6\u6ca1\u627e\u5230\u5728\u54ea.....</p>","tags":["docker"]},{"location":"devops/docker/docker-file/#expose","title":"EXPOSE","text":"<p>\u66b4\u9732\u7aef\u53e3</p> <ul> <li>\u662f\u955c\u50cf\u521b\u5efa\u8005\u548c\u4f7f\u7528\u8005\u7684\u7ea6\u5b9a,\u544a\u77e5\u7528\u6237\u4f60\u66b4\u9732\u4e86\u4ec0\u4e48\u670d\u52a1(\u7aef\u53e3)</li> <li>\u5728 docker run \u2013P \u65f6\uff0cdocker \u4f1a\u81ea\u52a8\u6620\u5c04 expose \u7684\u7aef\u53e3\u5230\u4e3b\u673a\u5927\u7aef\u53e3\uff0c\u59820.0.0.0:32768-&gt;80/tcp</li> <li>-P \u662f\u5c06\u5bb9\u5668\u5185\u6240\u6709\u66b4\u9732\u7684\u7aef\u53e3(\u5199\u4e86EXPOSE\u7684) \u6620\u5c04\u5230\u4e3b\u673a\u7684\u968f\u673a\u7aef\u53e3\u4e0a,\u5982\u679c\u6ca1\u6709\u5199EXPOSE, \u5c31\u4e0d\u4f1a\u6620\u5c04\u4efb\u4f55\u7aef\u53e3</li> <li>-p \u6307\u5b9a\u5bb9\u5668\u7684\u7aef\u53e3(\u65e0\u9700 dockerfile \u5199 EXPOSE)\u6620\u5c04\u5230\u4e3b\u673a</li> <li>\u4ece\u67d0\u79cd\u610f\u4e49\u4e0a\u770bEXPOSE\u53ea\u662f\u4e00\u79cd\u63d0\u9192/\u544a\u77e5: \u8bf4\u6211\u8fd9\u4e2a\u5e94\u7528\u5e94\u8be5\u8bbf\u95ee\u8fd9\u4e2a\u7aef\u53e3,\u8fd9\u4e2a\u7aef\u53e3\u63d0\u4f9b\u670d\u52a1 <pre><code>package main\nimport \"github.com/gin-gonic/gin\"\nfunc main() {\nr := gin.Default()\nr.GET(\"/ping\", func(c *gin.Context) {\nc.JSON(200, gin.H{\n\"message\": \"pong\",\n})\n})\nr.Run(\":9090\") // \u76d1\u542c\u5e76\u5728 0.0.0.0:8080(\u9ed8\u8ba4) \u4e0a\u542f\u52a8\u670d\u52a1\n}\n</code></pre> <pre><code>FROM golang:alpine as base\nWORKDIR /test\nCOPY . .\nRUN go env -w GOPROXY=https://goproxy.cn,http://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct \\\n&amp;&amp; go mod init go-web \\\n&amp;&amp; go mod tidy \\\n&amp;&amp; go build\nFROM alpine:3.16\nCOPY --from=base /test/go-web /go-web\nEXPOSE 9090\nCMD [\"/go-web\"]\n</code></pre></li> </ul> <pre><code>EXPOSE &lt;port&gt; [&lt;port&gt;/&lt;protocol&gt;...]\n</code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#healthcheck","title":"HEALTHCHECK","text":"<p>\u5065\u5eb7\u68c0\u67e5 <pre><code>--interval=&lt;duration&gt;\uff1a\u6307\u5b9a\u5065\u5eb7\u68c0\u67e5\u7684\u65f6\u95f4\u95f4\u9694,\u9ed8\u8ba4\u4e3a 30 \u79d2.\n--timeout=&lt;duration&gt;\uff1a\u6307\u5b9a\u6bcf\u6b21\u5065\u5eb7\u68c0\u67e5\u7684\u8d85\u65f6\u65f6\u95f4,\u9ed8\u8ba4\u4e3a 30 \u79d2.\n--retries=&lt;number&gt;\uff1a\u6307\u5b9a\u5728\u5c06\u5bb9\u5668\u6807\u8bb0\u4e3a\u4e0d\u5065\u5eb7\u4e4b\u524d\u5c1d\u8bd5\u5065\u5eb7\u68c0\u67e5\u7684\u6b21\u6570,\u9ed8\u8ba4\u4e3a 3 \u6b21.\n</code></pre> <pre><code>HEALTHCHECK --interval=5s --timeout=3s \\\nCMD curl -f http://localhost/ || exit 1\n</code></pre></p>","tags":["docker"]},{"location":"devops/docker/docker-file/#env","title":"ENV","text":"<p>\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf, \u5c31\u662f\u8fdb\u5165\u5bb9\u5668\u540e,\u4f60\u53ef\u4ee5\u7528env \u770b\u5230\u8fd9\u4e9b</p> <pre><code>ENV &lt;key&gt;=&lt;value&gt; ...\n#\u6216\u8005MYSQL_VERSION=5.7\nENV MYSQL_VERSION 5.7\n# run \u5b9e\u9645\u4e0a\u662f\u8fdb\u5165\u5bb9\u5668\u6267\u884c\u7684. \u6240\u4ee5\u7528\u5230\u7684\u53d8\u91cf\u53ef\u4ee5\nRUN agt-get install -y mysql-server=\"${MYSQL_VERSION}\"  </code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#add","title":"ADD (\u4e0d\u63a8\u8350)","text":"<p>Note</p> <ul> <li>\u4ece\u6e90\u5730\u5740(\u6587\u4ef6\uff0c\u76ee\u5f55\u6216\u8005 URL)\u590d\u5236\u6587\u4ef6\u5230\u76ee\u6807\u8def\u5f84</li> <li>\u5982\u679c src \u662f\u4e00\u4e2a\u672c\u5730\u538b\u7f29\u6587\u4ef6,\u5219\u5728 ADD \u7684\u540c\u65f6\u5b8c\u6574\u89e3\u538b\u64cd\u4f5c</li> <li>\u5982\u679c dest \u4e0d\u5b58\u5728,\u5219 ADD \u6307\u4ee4\u4f1a\u521b\u5efa\u76ee\u6807\u76ee\u5f55</li> <li>\u5982\u679c dest \u7ed3\u5c3e\u6ca1\u6709/,\u90a3\u4e48 dest \u662f\u76ee\u6807\u6587\u4ef6\u540d,\u5982\u679c dest \u7ed3\u5c3e\u6709/,\u90a3\u4e48 dest \u662f\u76ee\u6807\u76ee\u5f55\u540d</li> <li>\u5982\u679c src \u662f\u4e00\u4e2a\u76ee\u5f55,\u5219\u6240\u6709\u6587\u4ef6\u90fd\u4f1a\u88ab\u590d\u5236\u81f3 dest</li> <li>\u5982\u679c src \u662f\u4e00\u4e2a\u672c\u5730\u538b\u7f29\u6587\u4ef6,\u5219\u5728 ADD \u7684\u540c\u65f6\u5b8c\u6574\u89e3\u538b\u64cd\u4f5c</li> <li>ADD \u652f\u6301\u901a\u914d\u7b26\uff0c\u5982 ADD check* /testdir/</li> </ul> <pre><code>ADD [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;  ADD [--chown=&lt;user&gt;:&lt;group&gt;] [\"&lt;src&gt;\",... \"&lt;dest&gt;\"] (\u8def\u5f84\u4e2d\u6709\u7a7a\u683c\u65f6\u4f7f\u7528)\n</code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#copy","title":"COPY","text":"<p>Note</p> <ul> <li>COPY:\u4ece\u6e90\u5730\u5740(\u6587\u4ef6\uff0c\u76ee\u5f55)\u590d\u5236\u6587\u4ef6\u5230\u76ee\u6807\u8def\u5f84</li> <li>\u53ef\u4ee5\u7528\u4e8e\u591a\u9636\u6bb5\u7f16\u8bd1\u573a\u666f\uff0c\u53ef\u4ee5\u7528\u524d\u4e00\u4e2a\u4e34\u65f6\u955c\u50cf\u4e2d\u62f7\u8d1d\u6587\u4ef6</li> <li>COPY \u4e0d\u89e3\u538b\u6587\u4ef6</li> <li>COPY \u53ea\u652f\u6301\u672c\u5730\u6587\u4ef6\u7684\u590d\u5236</li> </ul> <pre><code>COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;\nCOPY [--chown=&lt;user&gt;:&lt;group&gt;] [\"&lt;src&gt;\",... \"&lt;dest&gt;\"] # \u8def\u5f84\u4e2d\u6709\u7a7a\u683c\u65f6\u4f7f\u7528\nCOPY --from=build /bin/project /bin/project\n</code></pre> src\u662f\u76ee\u5f55\u65f6\u6ce8\u610f\u70b9<pre><code>FROM ubuntu\nCOPY tmp /root/\n\n.\n\u251c\u2500\u2500 dockerfile\n\u2514\u2500\u2500 tmp\n    \u251c\u2500\u2500 abc\n    \u2514\u2500\u2500 t2\n        \u2514\u2500\u2500 123\ndocker run --rm tmp ls /root abc\n    t2\n#\u6ca1\u6709 tmp \u76ee\u5f55,, \u6240\u4ee5\u5199copy\u7684\u65f6\u5019 \u8981 copy tmp /root/tmp\n</code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#volume","title":"VOLUME","text":"<p>\u5c06\u6307\u5b9a\u76ee\u5f55\u5b9a\u4e49\u4e3a\u5916\u6302\u5b58\u50a8\u5377\uff0cDockerfile \u4e2d\u5728\u8be5\u6307\u4ee4\u4e4b\u540e\u6240\u6709\u5bf9\u540c\u4e00\u76ee\u5f55\u7684\u4fee\u6539\u90fd\u65e0\u6548 VOLUME [\"/data\"] <pre><code>\u7b49\u4ef7\u4e8e docker run \u2013v /data\uff0c\u53ef\u901a\u8fc7 docker inspect \u67e5\u770b\u4e3b\u673a\u7684 mount point\uff0c /var/lib/docker/volumes/&lt;containerid&gt;/_data\n</code></pre></p>","tags":["docker"]},{"location":"devops/docker/docker-file/#workdir","title":"WORKDIR","text":"<p>\u5207\u6362\u5de5\u4f5c\u76ee\u5f55 WORKDIR\uff0c\u610f\u601d\u662f\u5728\u8fd9\u4e00\u53e5\u4e4b\u540e\uff0cDockerfile \u540e\u9762\u7684\u64cd\u4f5c\u90fd\u4ee5\u8fd9\u4e00\u53e5\u6307\u5b9a\u7684 WORKDIR \u76ee\u5f55\u4f5c\u4e3a\u5f53\u524d\u76ee\u5f55 \u8fd8\u6709\u8bbe\u7f6e\u540e,\u4f60<code>docker run -it xxx bash</code> \u8fdb\u5165\u540e, <code>pwd</code>\u770b\u5230\u7684,\u5c31\u4e0d\u4f1a\u662f\u9ed8\u8ba4\u7684/ \u800c\u662f\u8fd9\u4e2a\u4e86.</p> <pre><code>WORKDIR /path/to/workdir\n</code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#user","title":"USER","text":"<p>USER:\u5207\u6362\u8fd0\u884c\u955c\u50cf\u7684\u7528\u6237\u548c\u7528\u6237\u7ec4, \u5bb9\u5668\u9ed8\u8ba4\u4f1a\u4ee5root\u7684\u7528\u6237\u53bb\u8fd0\u884c\u5bb9\u5668, \u53ef\u4ee5\u7528user\u6307\u5b9a\u6210\u5176\u4ed6 \u7528\u6237\u5fc5\u987b\u5b58\u5728,\u6ca1\u6709\u7684\u8bdd\u5148\u6dfb\u52a0</p> <pre><code>#RUN USERADD abc\nUSER &lt;user&gt;[:&lt;group&gt;] \n# \u8fdb\u53bb\u5bb9\u5668\u540e,  whoami \u80fd\u770b\u5230\n</code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#arg","title":"ARG","text":"<pre><code>from ubuntu\nARG FILE\n# \u53ef\u4ee5\u6709\u9ed8\u8ba4\u503c\nARG DIR=\"/root\"\nRUN cd $DIR &amp;&amp; touch $FILE\n# \u751f\u6210\u955c\u50cf\u7684\u65f6\u5019 --build-arg \u7136\u540e FILE=hello.txt \u4f20\u9012 \u53c2\u6570\ndocker build --build-arg FILE=hello.txt -t yyy  .\n</code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#_1","title":"\u5176\u4ed6","text":"<pre><code>\u2022 ONBUILD  \n\u2022 STOPSIGNAL  \n\u2022 HEALTHCHECK \n\u2022 SHELL\n</code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#dockerfile_1","title":"dockerfile \u6700\u4f73\u5b9e\u8df5","text":"<ul> <li>\u6bcf\u4e2a\u955c\u50cf\u6700\u597d\u53ea\u6709\u4e00\u4e2a\u8fdb\u7a0b</li> <li>\u5f53\u65e0\u6cd5\u907f\u514d\u540c\u4e00\u955c\u50cf\u8fd0\u884c\u591a\u8fdb\u7a0b\u65f6,\u5e94\u9009\u62e9\u5408\u7406\u7684\u521d\u59cb\u5316\u8fdb\u7a0b(init process)</li> <li>\u6700\u5c0f\u5316\u5c42\u7ea7\u6570<ul> <li>\u53ea\u6709 RUN,COPY,ADD \u4f1a\u521b\u5efa\u65b0\u5c42,\u5176\u4ed6\u6307\u4ee4\u521b\u5efa\u4e34\u65f6\u5c42,\u4e0d\u4f1a\u589e\u52a0\u955c\u50cf\u5927\u5c0f</li> <li>\u591a\u6761 RUN \u547d\u4ee4\u53ef\u901a\u8fc7\u8fde\u63a5\u7b26\u8fde\u63a5\u6210\u4e00\u6761\u6307\u4ee4\u96c6\u4ee5\u51cf\u5c11\u5c42\u6570</li> <li>\u901a\u8fc7\u591a\u6bb5\u6784\u5efa\u51cf\u5c11\u955c\u50cf\u5c42\u6570</li> </ul> </li> <li>\u628a\u591a\u884c\u53c2\u6570\u6309\u5b57\u6bcd\u6392\u5e8f\uff0c\u53ef\u4ee5\u51cf\u5c11\u53ef\u80fd\u51fa\u73b0\u7684\u91cd\u590d\u53c2\u6570\uff0c\u5e76\u4e14\u63d0\u9ad8\u53ef\u8bfb\u6027</li> <li>\u7f16\u5199 dockerfile \u7684\u65f6\u5019,\u5e94\u8be5\u628a\u53d8\u66f4\u9891\u7387\u4f4e\u7684\u7f16\u8bd1\u6307\u4ee4\u4f18\u5148\u6784\u5efa\u4ee5\u4fbf\u653e\u5728\u955c\u50cf\u5e95\u5c42\u4ee5\u6709\u6548\u5229\u7528 build cache</li> <li>\u590d\u5236\u6587\u4ef6\u65f6,\u6bcf\u4e2a\u6587\u4ef6\u5e94\u72ec\u7acb\u590d\u5236,\u8fd9\u786e\u4fdd\u67d0\u4e2a\u6587\u4ef6\u53d8\u66f4\u65f6,\u53ea\u5f71\u54cd\u6539\u6587\u4ef6\u5bf9\u5e94\u7684\u7f13\u5b58</li> </ul>","tags":["docker"]},{"location":"devops/docker/docker-file/#1","title":"\u591a\u8fdb\u7a0b\u7684\u5bb9\u5668\u955c\u50cf1","text":"<ul> <li>\u9009\u62e9\u9002\u5f53\u7684 init \u8fdb\u7a0b</li> <li>\u9700\u8981\u6355\u83b7 SIGTERM \u4fe1\u53f7\u5e76\u5b8c\u6210\u5b50\u8fdb\u7a0b\u7684\u4f18\u96c5\u7ec8\u6b62</li> <li>\u8d1f\u8d23\u6e05\u7406\u9000\u51fa\u7684\u5b50\u8fdb\u7a0b\u4ee5\u907f\u514d\u50f5\u5c38\u8fdb\u7a0b</li> </ul>","tags":["docker"]},{"location":"devops/docker/docker-file/#build","title":"\u6784\u5efa build","text":"","tags":["docker"]},{"location":"devops/docker/docker-file/#build-context","title":"\u7406\u89e3\u6784\u5efa\u4e0a\u4e0b\u6587(Build Context)","text":"<p>Note</p> <ul> <li>\u5f53\u8fd0\u884c docker build \u547d\u4ee4\u65f6\uff0c\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u88ab\u79f0\u4e3a\u6784\u5efa\u4e0a\u4e0b\u6587</li> <li>\u9996\u5148\u4f1a\u628a\u6784\u5efa\u4e0a\u4e0b\u6587\u4f20\u8f93\u7ed9docker daemon,\u53ef\u80fd\u5f53\u524d\u76ee\u5f55(\u6784\u5efa\u4e0a\u4e0b\u6587)\u91cc\u6709\u5f88\u591a\u6ca1\u7528\u7684\u6587\u4ef6,\u8fd9\u6837\u5c31\u4f1a\u5bfc\u81f4\u4f20\u8f93\u65f6\u95f4\u957f,\u6240\u4ee5\u5f53\u524d\u76ee\u5f55\u8981\u5e72\u51c0</li> <li>\u53ef\u4ee5\u901a\u8fc7 <code>.dockerignore</code> \u6587\u4ef6\u4ece\u7f16\u8bd1\u4e0a\u4e0b\u6587\u6392\u9664\u67d0\u4e9b\u6587\u4ef6</li> <li>\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u4e13\u95e8\u7684\u76ee\u5f55\u653e\u7f6e Dockerfile\uff0c\u5e76\u5728\u76ee\u5f55\u4e2d\u8fd0\u884c docker build</li> </ul> <pre><code># .  \u5c31\u662f\u4f60\u7684\u6784\u5efa\u76ee\u5f55,\u4f1a\u5c06\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u5305\u542b\u5728\u6784\u5efa\u4e0a\u4e0b\u6587\n# \u9ed8\u8ba4\u67e5\u627e\u5f53\u524d\u76ee\u5f55\u7684 Dockerfile ,\u2013f \u6307\u5b9a Dockerfile\ndocker build . \u2013f ./Dockerfile\n</code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#build-cache","title":"Build Cache","text":"<p>\u6784\u5efa\u5bb9\u5668\u955c\u50cf\u65f6\uff0cDocker \u4f9d\u6b21\u8bfb\u53d6 Dockerfile \u4e2d\u7684\u6307\u4ee4\uff0c\u5e76\u6309\u987a\u5e8f\u4f9d\u6b21\u6267\u884c\u6784\u5efa\u6307\u4ee4\u3002 Docker \u8bfb\u53d6\u6307\u4ee4\u540e\uff0c\u4f1a\u5148\u5224\u65ad\u7f13\u5b58\u4e2d\u662f\u5426\u6709\u53ef\u7528\u7684\u5df2\u5b58\u955c\u50cf\uff0c\u53ea\u6709\u5df2\u5b58\u955c\u50cf\u4e0d\u5b58\u5728\u65f6\u624d\u4f1a\u91cd\u65b0\u6784\u5efa\u3002</p> <ul> <li>\u901a\u5e38 Docker \u7b80\u5355\u5224\u65ad Dockerfile \u4e2d\u7684\u6307\u4ee4\u4e0e\u955c\u50cf\u3002</li> <li>\u9488\u5bf9 ADD \u548c COPY \u6307\u4ee4\uff0cDocker \u5224\u65ad\u8be5\u955c\u50cf\u5c42\u6bcf\u4e00\u4e2a\u6587\u4ef6\u7684\u5185\u5bb9\u5e76\u751f\u6210\u4e00\u4e2a checksum\uff0c\u4e0e\u73b0\u5b58\u955c\u50cf\u6bd4\u8f83\u65f6\uff0cDocker \u6bd4\u8f83\u7684\u662f\u4e8c\u8005\u7684 checksum\u3002</li> <li>\u5176\u4ed6\u6307\u4ee4\uff0c\u6bd4\u5982 RUN apt-get -y update\uff0cDocker \u7b80\u5355\u6bd4\u8f83\u4e0e\u73b0\u5b58\u955c\u50cf\u4e2d\u7684\u6307\u4ee4\u5b57\u4e32\u662f\u5426\u4e00\u81f4\u3002</li> <li>\u5f53\u67d0\u4e00\u5c42 cache \u5931\u6548\u4ee5\u540e\uff0c\u6240\u6709\u6240\u6709\u5c42\u7ea7\u7684 cache \u5747\u4e00\u5e76\u5931\u6548\uff0c\u540e\u7eed\u6307\u4ee4\u90fd\u91cd\u65b0\u6784\u5efa\u955c\u50cf\u3002<ul> <li>\u6240\u4ee5\u6784\u5efa\u7684\u65f6\u5019,\u4e0d\u4f1a\u53d8\u7684\u4e1c\u897f\u653e\u5230\u6700\u4e0a\u9762</li> </ul> </li> </ul>","tags":["docker"]},{"location":"devops/docker/docker-file/#multi-stage-build","title":"\u591a\u6bb5\u6784\u5efa(Multi-stage build)","text":"<pre><code>FROM golang:1.10-alpine3.8 AS multistage\nRUN apk add --no-cache --update git\n\nWORKDIR /go/src/api\nCOPY . .\n\nRUN go get -d -v \\\n&amp;&amp; go install -v \\\n&amp;&amp; go build\n\n##alpine \u7a7a\u7684,\u5565\u4e5f\u6ca1\u6709, \u56e0\u4e3a\u6211\u4eec\u7684go\u7a0b\u5e8f\u672c\u8eab\u5c31\u662f\u53ef\u6267\u884c\u6587\u4ef6.\nFROM alpine:3.8\nCOPY --from=multistage /go/bin/api /go/bin/\nEXPOSE 3000\nCMD [\"/go/bin/api\"]\n</code></pre> <p>Tip</p> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528<code>--from=0</code> \u6765\u8868\u793a\u4ece\u7b2c\u4e00\u4e2a\u9636\u6bb5\u6765</p>","tags":["docker"]},{"location":"devops/docker/docker-file/#_2","title":"\u4f7f\u7528\u6700\u5c0f\u7684\u955c\u50cf","text":"<pre><code>from scratch # \u7a7a\u7684, \u91cc\u9762\u57fa\u7840\u547d\u4ee4\u90fd\u6ca1\u6709, \u6240\u4ee5\u4e00\u822c\u6211\u4eec\u7528 alpine\n#\u5f88\u591a\u90fd\u6709\u8fd9\u79cd -alpine\nfrom golang:1.17.2-alpine\n\nfrom openjdk:alpine\n</code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#dockerfile_2","title":"\u901a\u8fc7\u955c\u50cf\u9006\u5411dockerfile","text":"<pre><code>docker run -v /var/run/docker.sock:/var/run/docker.sock alpine/dfimage nginx:alpine\n</code></pre>","tags":["docker"]},{"location":"devops/docker/docker-file/#dockerignore","title":".dockerignore","text":"<ol> <li> <p>https://github.com/krallin/tini \u21a9</p> </li> <li> <p>alpine \u21a9</p> </li> </ol>","tags":["docker"]},{"location":"devops/docker/docker/","title":"\u5e38\u7528\u547d\u4ee4","text":"<p>Warning</p> <p>\u5f85\u6574\u7406</p>"},{"location":"devops/docker/docker/#_1","title":"\u57fa\u7840\u547d\u4ee4","text":"<ul> <li> <p>\u663e\u793adocker\u76f8\u5173\u4fe1\u606f <pre><code>docker info\n</code></pre> \u7ed3\u679c<pre><code>Client:\n Context:    default\n Debug Mode: false\n Plugins:\n  buildx: Docker Buildx (Docker Inc.)\n    Version:  v0.10.4\n    Path:     /usr/libexec/docker/cli-plugins/docker-buildx\n  compose: Docker Compose (Docker Inc.)\n    Version:  v2.17.2\n    Path:     /usr/libexec/docker/cli-plugins/docker-compose\n  scan: Docker Scan (Docker Inc.)\n    Version:  v0.23.0\n    Path:     /usr/libexec/docker/cli-plugins/docker-scan\n\nServer:\n Containers: 6\n  Running: 6\n  Paused: 0\n  Stopped: 0\n Images: 6\n Server Version: 23.0.2\n Storage Driver: overlay2\n  Backing Filesystem: extfs\n  Supports d_type: true\n  Using metacopy: false\n  Native Overlay Diff: true\n  userxattr: false\n Logging Driver: json-file # \u8868\u793a\u5b58\u5728\u672c\u5730, \u662f\u53ef\u4ee5\u8ba9\u4ed6\u5b58\u653e\u5728\u8fdc\u7aef\u7684\n Cgroup Driver: cgroupfs # \u9650\u5236\u4e0e\u9694\u79bb\u7684\u9a71\u52a8\n Cgroup Version: 1\n Plugins:\n  Volume: local\n  Network: bridge host ipvlan macvlan null overlay\n  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog\n Swarm: inactive  # \u7f16\u6392\u5de5\u5177, \u4e0d\u5f00\u542f\n Runtimes: io.containerd.runc.v2 runc\n Default Runtime: runc\n Init Binary: docker-init\n containerd version: 2806fc1057397dbaeefbea0e4e17bddfbd388f38\n runc version: v1.1.5-0-gf19387a\n init version: de40ad0\n Security Options:\n  apparmor\n  seccomp\n   Profile: builtin\n Kernel Version: 5.4.0-146-generic\n Operating System: Ubuntu 20.04.6 LTS\n OSType: linux\n Architecture: x86_64\n CPUs: 2\n Total Memory: 3.84GiB\n Name: ubtest\n ID: fb514c1e-58bd-4be0-ad81-c8d7c4413f53\n Docker Root Dir: /var/lib/docker  # \u6570\u636e\u5b58\u653e\u7684\u4f4d\u7f6e\n Debug Mode: false\n Registry: https://index.docker.io/v1/ \n Experimental: false\n Insecure Registries:\n  127.0.0.0/8\n Live Restore Enabled: false  #\u70ed\u66f4\u65b0 \u751f\u4ea7\u73af\u5883 \u8bbe\u7f6e\u4e3atrue ,\u8868\u793a\u91cd\u542fdocker ,\u5bb9\u5668\u4e0d\u4f1a\u91cd\u542f\n</code></pre></p> </li> <li> <p>\u67e5\u770b\u7248\u672c <pre><code>docker version\n</code></pre> \u7ed3\u679c<pre><code>Server: Docker Engine - Community\n Engine:\n  Version:          23.0.2\n  API version:      1.42 (minimum version 1.12)\n  Go version:       go1.19.7\n  Git commit:       219f21b\n  Built:            Mon Mar 27 16:16:18 2023\n  OS/Arch:          linux/amd64\n  Experimental:     false\n containerd:\n  Version:          1.6.20\n  GitCommit:        2806fc1057397dbaeefbea0e4e17bddfbd388f38\n runc:\n  Version:          1.1.5\n  GitCommit:        v1.1.5-0-gf19387a\n docker-init:\n  Version:          0.19.0\n  GitCommit:        de40ad0\n</code></pre></p> </li> </ul>"},{"location":"devops/docker/docker/#_2","title":"\u955c\u50cf\u64cd\u4f5c","text":""},{"location":"devops/docker/docker/#_3","title":"\u641c\u7d22","text":"<pre><code>docker search nginx\n</code></pre>"},{"location":"devops/docker/docker/#_4","title":"\u62c9\u53d6","text":"<pre><code># \u9ed8\u8ba4\u62c9\u53d6\u6700\u65b0\u7248\ndocker pull nginx\n# \u7b49\u4ef7\u4e8e\u8fd9\u4e2a\ndocker pull nginx:latest\n# \u62c9\u53d6\u67d0\u4e2a sha256\u7684\u7248\u672c\ndocker pull nginx@sha256:1195d1c1cd901058d1f059f2e31e17b559f51a03e093bf0a774c9304aebb5c36\n</code></pre>"},{"location":"devops/docker/docker/#_5","title":"\u67e5\u770b","text":"<pre><code># \u67e5\u770b\u672c\u5730\u4e0b\u8f7d\u7684\u6240\u6709\u955c\u50cf\ndocker images\n# \u67e5\u770b\u955c\u50cf\u6709\u51e0\u5c42 (\u770bdockerfile\u540e\u5c31\u660e\u767d\u4e86)\ndocker history image_id\n</code></pre>"},{"location":"devops/docker/docker/#_6","title":"\u6807\u7b7e","text":"<pre><code># docker tag \u955c\u50cfid\u6216\u8005\u955c\u50cf\u540d:\u7248\u672c  \u65b0\u7684...\ndocker images\n    REPOSITORY   TAG       IMAGE ID       CREATED      SIZE\n    nginx        latest    0e901e68141f   3 days ago   142MB\ndocker tag 0e901e68141f nginx:v1.0\n# \u6216\ndocker tag nginx:latest nginx:v1.0\n\n# \u67e5\u770b ,\u539f\u6765\u7684\u8fd8\u5728\u7684, \u53e6\u5916\u4e00\u4e2a\u5e76\u4e0d\u4f1a\u5360\u7528\u7a7a\u95f4\u7684.\ndocker images\n    REPOSITORY   TAG       IMAGE ID       CREATED      SIZE\n    nginx        v1.0      0e901e68141f   3 days ago   142MB\n    nginx        latest    0e901e68141f   3 days ago   142MB\n\ndocker rmi nginx:latest # \u76f8\u5f53\u4e8e\u5220\u9664\u6807\u7b7e\n</code></pre>"},{"location":"devops/docker/docker/#_7","title":"\u767b\u5f55\u548c\u63a8\u9001","text":"<pre><code>docker login  #\u9ed8\u8ba4\u767b\u5f55\u5b98\u65b9\u7684 hub\u5e93\ndocker login hub.yy.com # \u767b\u5f55\u81ea\u5df1\u7684\u955c\u50cf\u4ed3\u5e93. hub.yy.com \u81ea\u5df1\u5f04\u53bb\n# \u767b\u5f55\u4f60\u7684aliyun \u7684 \u4ed3\u5e93. \ndocker login --username=...  register.cn-hz-aliyuncs.com\n# \u5c06\u4f60\u7684\u955c\u50cftag \u6539\u6210\u4f60\u7684 \u4ed3\u5e93\u540d. myhub\u662f\u4f60\u7684\u4ed3\u5e93\u540d\ndocker tag 0e901e68141f myhub/nginx:latest\n\n# \u63a8\u9001\u955c\u50cf\ndocker image push myhub/nginx:latest\n#\u7b49\u4ef7\u4e0e\ndocker push myhub/nginx:latest\n</code></pre>"},{"location":"devops/docker/docker/#_8","title":"\u5220\u9664","text":"<pre><code># \u5982\u679c\u955c\u50cf\u6b63\u5728\u88ab\u5bb9\u5668\u4f7f\u7528, \u662f\u65e0\u6cd5\u5220\u9664\u7684\ndocker rmi image_id\n# \u7b49\u4ef7\ndocker image rm image_id\n\n# \u5220\u9664\u6240\u6709\u7684\u955c\u50cf\ndocker image prune\n</code></pre>"},{"location":"devops/docker/docker/#_9","title":"\u7f16\u8bd1\u6253\u5305","text":"<pre><code># \u6839\u636edockerfile \u6253\u5305\u955c\u50cf\n# -t \u8868\u793a \u955c\u50cf\u7684tag, . \u662fdockerfile\u6240\u5728\u8def\u5f84\ndocker build -t nginx:123 .\n</code></pre>"},{"location":"devops/docker/docker/#save-load","title":"save &amp;&amp; load","text":"<p>Tip</p> <p>\u5f53\u4f60\u955c\u50cf\u4e0d\u80fd\u901a\u8fc7\u4ed3\u5e93\u8fdb\u884c\u5206\u4eab\u6216\u4f20\u8f93, \u6211\u4eec\u672c\u5730\u4fdd\u5b58\u7136\u540e\u7ed9\u5176\u4ed6\u4eba.</p> <pre><code>docker save nginx -o nginx.tar\n# \u5176\u4ed6\u4eba\u4f7f\u7528\u7684\u65f6\u5019\ndocker load &lt; nginx.tar\n</code></pre>"},{"location":"devops/docker/docker/#_10","title":"\u5bb9\u5668\u64cd\u4f5c","text":""},{"location":"devops/docker/docker/#_11","title":"\u521b\u5efa,\u542f\u52a8,\u505c\u6b62","text":"<pre><code># \u521b\u5efa\ndocker create -it --name nginx nginx:latest\ndocker ps # \u6ca1\u6709\u770b\u5230, \u53ea\u662f\u521b\u5efa\u4e86.\n# \u542f\u52a8\u5bb9\u5668, \u4f7f\u7528\u5bb9\u5668\u540d\u6216\u5bb9\u5668id\ndocker start nginx\ndocker ps\n# \u4f18\u96c5\u505c\u6b62, \u4f7f\u7528\u5bb9\u5668\u540d\u6216\u5bb9\u5668id\ndocker stop nginx\n# \u5f3a\u5236\u505c\u6b62, \u4f7f\u7528\u5bb9\u5668\u540d\u6216\u5bb9\u5668id\ndocker kill nginx\n# \u505c\u6b62\u5bb9\u5668\u91cc\u7684\u8fdb\u7a0b\ndocker pause nginx\ndocker ps # \u67e5\u770b, \u5bb9\u5668\u8fd8\u662f\u8fd0\u884c\u7684, status \u663e\u793a pause\nCONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS                  PORTS     NAMES\n  316e566c99fa   nginx:latest   \"/docker-entrypoint.\u2026\"   4 minutes ago   Up 7 seconds (Paused)   80/tcp    nginx\ndocker unpause nginx # \u91cd\u65b0\u542f\u52a8\u8fdb\u7a0b\n</code></pre>"},{"location":"devops/docker/docker/#_12","title":"\u8fd0\u884c","text":"<p>Tip</p> <p>\u76f8\u6bd4\u8f83\u524d\u9762\u7684 create start \u8fd9\u4e2a\u66f4\u5e38\u7528, \u76f4\u63a5\u5c31\u521b\u5efa\u5e76\u4e14\u542f\u52a8\u4e86\u5bb9\u5668</p> <pre><code>#\u4ea4\u4e92\u7684,\u76f4\u63a5\u8fdb\u5165\u8be5\u5bb9\u5668,\u5982\u679c\u9000\u51faexit,\u8be5\u5bb9\u5668\u5c31\u9000\u51fa\u4e86\n# -it  \u4ea4\u4e92\u5f0f \u524d\u53f0, \u8fd0\u884cbash \u547d\u4ee4 ,-i=--interactive -t=tty\n# nginx:latest \u955c\u50cf\u540d, \u5148\u4f1a\u67e5\u770b\u672c\u5730\u6709\u6ca1\u6709\u8fd9\u4e2a\u955c\u50cf,\u5982\u679c\u6ca1\u6709\u5219\u4ece docker.io\u4e0a\u62c9\u53d6\n# --name \u5bb9\u5668\u540d\ndocker run -it --name abc nginx:latest bash\n# \u540e\u53f0 -d\ndocker run -itd nginx:latest\n# \u7aef\u53e3\u6620\u5c04,\u5c06\u5bb9\u5668\u91cc\u768480\u7aef\u53e3\u6620\u5c04\u5230\u672c\u673a\u76848080\u7aef\u53e3\ndocker run -itd -p 8080:80 nginx:latest\n\n# \u9000\u51fa\u4f1a\u81ea\u52a8\u5220\u9664\u5bb9\u5668\ndocker run -it --rm nginx:latest\n</code></pre>"},{"location":"devops/docker/docker/#commit","title":"commit","text":"<pre><code>docker pull centos\ndocker run -it centos\n#\u8fd9\u4e2a\u65f6\u5019\u5df2\u7ecf\u76f4\u63a5\u8fdb\u53bb\u8be5\u5bb9\u5668\u7684bash\u4e86\nyum install vim -y #\u6211\u4eec\u5b89\u88c5\u4e00\u4e2avim\n#exit #\u7136\u540e\u9000\u51fa\n#\u53ef\u4ee5\u67e5\u770b\u4e00\u4e0b\u8be5\u5bb9\u5668\u7684\u4fe1\u606f\n#\u5c06\u8be5\u5bb9\u5668commit \u6210\u4e00\u4e2aimage \u4e0b\u9762\u7684:latest \u662ftag \u53ef\u4ee5\u4e0d\u8bbe\u7f6e,\u9ed8\u8ba4\u5c31\u662flatest\ndocker commit -m 'install vim' \u5bb9\u5668\u540d \u81ea\u5df1\u8bbe\u7f6e\u7684image\u540d(test/centos-vim:latest)\n</code></pre>"},{"location":"devops/docker/docker/#exec","title":"exec \u6267\u884c\u6307\u4ee4","text":"<pre><code># \u6267\u884c\u5bb9\u5668\u91cc\u7684bash , \u8fd9\u4e2a\u5b9e\u9645\u5c31\u662f\u8fdb\u5165\u4e86\u5bb9\u5668, \u6267\u884c\u4e86bash ,\u524d\u53f0\ndocker exec -it nginx bash\n# \u8fdb\u5165\u5bb9\u5668\u8fd0\u884c\u6307\u4ee4\u540e\u76f4\u63a5\u9000\u51fa\ndocker exec -it nginx ls /var/log/nginx\n  # access.log  error.log\n</code></pre>"},{"location":"devops/docker/docker/#_13","title":"\u67e5\u770b\u5bb9\u5668\u8fdb\u7a0b\u4fe1\u606f","text":"<pre><code># \u67e5\u770b\u5bb9\u5668\u91cc\u7684\u8fd0\u884c\u7684\u8fdb\u7a0b\ndocker top nginx\n# \u67e5\u770b\u5bb9\u5668\u91cc\u8fdb\u7a0b\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5, \u4f1a\u524d\u53f0\u6267\u884c\u4e00\u76f4\ndocker stats nginx\n# \u8f93\u51fa\u4e00\u6b21\u5c31\u9000\u51fa\ndocker stats nginx --no-stream\n</code></pre>"},{"location":"devops/docker/docker/#_14","title":"\u91cd\u547d\u540d","text":"<pre><code>docker rename nginx nginx_new\n</code></pre>"},{"location":"devops/docker/docker/#cpu","title":"\u63a7\u5236cpu\u7684\u4f7f\u7528\u7684\u8fd0\u884c","text":"<pre><code>docker run -itd --name=nginx --cpu-period=100000 --cpu-quota=10000 nginx\n</code></pre>"},{"location":"devops/docker/docker/#net-ns","title":"\u52a0\u5165\u5176\u4ed6\u5bb9\u5668\u7684net ns","text":"<pre><code>docker run -it --net container:4ddf4638572d busybox ifconfig\n</code></pre>"},{"location":"devops/docker/docker/#_15","title":"\u5e26\u4e0a\u6570\u636e\u6301\u4e45\u5316\u7684\u8fd0\u884c","text":"<pre><code>#\u5c06\u672c\u5730\u7684/home/html\u76ee\u5f55\u6620\u5c04\u5230\u5bb9\u5668\u4e2d\u7684/usr/share/nginx/html\n#\u8fd9\u6837\u672c\u5730\u505a\u4ec0\u4e48\u4fee\u6539\uff0c\u5bb9\u5668\u5c31\u4fee\u6539\uff0c\u901a\u8fc7\u5bb9\u5668\u4fee\u6539\uff0c\u672c\u5730\u4e5f\u5c31\u4fee\u6539\u4e86\ndocker run -d --name nginx01 -v /home/html:/usr/share/nginx/html nginx\n\ndocker volume ls\n</code></pre>"},{"location":"devops/docker/docker/#_16","title":"\u67e5\u770b\u8fd0\u884c\u7684\u5bb9\u5668","text":"<pre><code>#\u663e\u793a\u5f53\u524d\u6b63\u5728\u8fd0\u884c\u7684\u5bb9\u5668\ndocker ps\ndocker container ls #\u7b49\u4ef7\u4e8e\u4e0a\u9762\u7684\n# \u67e5\u770b \u72b6\u6001\u662f\u9000\u51fa\u7684\u5bb9\u5668\ndocker ps -f 'status=exited'\n# \u6bd4\u5982\u4f60\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u5b57\u4e3ago-web \u7684\u5bb9\u5668, \u4f60\u60f3\u8981\u770b\u8fd9\u4e2a\u5bb9\u5668 \u5305\u542b\u5173\u7cfb\ndocker ps -f name=go\ndocker ps -l # \u6700\u65b0\u521b\u5efa\u7684\u4e00\u4e2a\u5bb9\u5668\n#\u663e\u793a\u6240\u6709\u7684\u5bb9\u5668\uff0c\u5305\u62ec\u5df2\u7ecf\u9000\u51fa\u7684\ndocker ps -a\ndocker container ls -a\n# \u67e5\u770b\u8fd0\u884c\u7684\u5bb9\u5668\u7684id (\u7b80\u5316\u8f93\u51fa)\ndocker ps -q\n# \u6240\u6709\u5bb9\u5668\u7684id\ndocker ps -aq\n</code></pre>"},{"location":"devops/docker/docker/#_17","title":"\u5220\u9664","text":"<pre><code># \u8fd9\u4e2a\u9ed8\u8ba4\u5c31\u662f\u5220\u9664\u5bb9\u5668\n# id \u53ea\u8981\u524d\u9762\u51e0\u4f4d\u5c31\u884c\uff0c\u80fd\u533a\u522b\u5176\u4ed6\u7684\u5bb9\u5668\u5c31ok\n# \u5bb9\u5668\u6b63\u5728\u8fd0\u884c \u8fd9\u4e2a\u547d\u4ee4\u4f1a\u62a5\u9519\ndocker rm \u5bb9\u5668id\ndocker container rm \u5bb9\u5668id\n# \u5f3a\u5236\u5220\u9664, \u4e0d\u7ba1\u662f\u5426\u5728\u8fd0\u884c\ndocker rm -f \u5bb9\u5668id\n\n# \u5220\u9664\u6240\u6709\u7684\u5bb9\u5668,\u5f3a\u5236\u7684. \u6ce8\u610f\u64cd\u4f5c.\ndocker rm -f $(docker ps -aq)\n# \u53ea\u5220\u9664\u5df2\u7ecf\u9000\u51fa\u7684\u5bb9\u5668\ndocker rm $(docker ps -f 'status=exited' -q)\n# \u5220\u9664\u5df2\u7ecf\u9000\u51fa\u7684\u5bb9\u5668\ndocker container prune\n</code></pre>"},{"location":"devops/docker/docker/#_18","title":"\u67e5\u770b\u5bb9\u5668\u8fd0\u884c\u65e5\u5fd7","text":"<pre><code># \u5047\u5982\u4f60\u7684\u5bb9\u5668\u91cc\u7684\u65e5\u5fd7\u662f\u5199\u5728\u6587\u4ef6\u91cc\u7684, \u90a3\u4e48\u8fd9\u91cc\u5c31\u770b\u4e0d\u5230 \u5bb9\u5668\u7684\u65e5\u5fd7\u4e86\n# \u6211\u4eec\u81ea\u5df1\u5f00\u53d1\u7684\u955c\u50cf \u8fd0\u884c\u540e  \u5e94\u8be5\u5c06\u65e5\u5fd7\u663e\u793a\u5728\u524d\u53f0. \u63a7\u5236\u53f0, \u624d\u80fd\u770b\u5230\u65e5\u5fd7\ndocker logs -f  \u5bb9\u5668id\ndocker logs -f  \u5bb9\u5668id  --tail 1\n</code></pre>"},{"location":"devops/docker/docker/#_19","title":"\u5bb9\u5668\u4e0e\u4e3b\u673a\u7684\u6587\u4ef6\u4f20\u8f93","text":"\u4ece\u5bb9\u5668\u590d\u5236\u5230\u4e3b\u673a\u4ece\u4e3b\u673a\u590d\u5236\u5230\u5bb9\u5668 <pre><code># nginx \u662f\u5bb9\u5668\u540d  ~/ \u662f\u4e3b\u673a\u7684\u76ee\u5f55\ndocker cp nginx:/app.c ~/\n</code></pre> <pre><code># nginx: \u8868\u793a\u5bb9\u5668\u540d, text.txt \u662f\u4e3b\u673a\u7684\u6587\u4ef6\ndocker cp text.txt nginx:/\n</code></pre>"},{"location":"devops/docker/docker/#_20","title":"\u6392\u67e5 \u5bb9\u5668\u7684\u64cd\u4f5c\u8bb0\u5f55","text":"<pre><code># \u67e5\u770b\u4ece\u6628\u5929\u5f00\u59cb\u5230\u73b0\u5728\u7684 docker\u7684\u64cd\u4f5c\u8bb0\u5f55\ndocker events --since=$(date -d \"1 day ago\" +%s)\ndocker events --since=$(date -d \"2 day ago\" +%s) --until=$(date -d \"1 day ago\" +%s)\n</code></pre>"},{"location":"devops/docker/docker/#inspect","title":"inspect \u83b7\u53d6\u5bb9\u5668/\u955c\u50cf\u7684\u5143\u6570\u636e","text":"<pre><code>docker inspect \u5bb9\u5668id/\u5bb9\u5668\u540d/\u955c\u50cf\u540d/\u955c\u50cfid\n</code></pre>"},{"location":"devops/docker/env/","title":"\u73af\u5883\u51c6\u5907","text":""},{"location":"devops/docker/env/#_1","title":"\u5b89\u88c5","text":"<p>docker.io \u662fdebian/ubuntu \u56e2\u961f\u7ef4\u62a4\u7684. \u57fa\u4e8e\u793e\u533a\u6e90\u7801\u5c01\u88c5\u7684\u7248\u672c,\u91c7\u7528apt\u7684\u65b9\u5f0f\u7ba1\u7406\u4f9d\u8d56 docker-ce \u793e\u533a\u7248,docker\u5b98\u65b9\u7ef4\u62a4\u7684. \u7528go\u7684\u65b9\u5f0f\u7ba1\u7406\u4f9d\u8d56, \u4f1a\u81ea\u5df1\u7ba1\u7406\u6240\u6709\u7684\u4f9d\u8d56 </p>"},{"location":"devops/docker/env/#_2","title":"\u56fd\u5185\u6e90\u914d\u7f6e","text":"<p>\u6ce8\u610f</p> <p>\u6ce8\u610f\u4e0d\u8981\u7528\u81ea\u5df1\u7684 mirrors (\u53ef\u80fd\u9700\u8981\u7ef4\u62a4\u5b83\u5427..) , \u4e4b\u524d\u7528aliyun\u5f04\u7684\u4e00\u4e2a,\u540e\u6765\u53d1\u73b0, \u7528\u81ea\u5df1\u7684\u955c\u50cf\u7684\u66f4\u65b0\u662f\u65e7\u7684. \u5c31\u662f\u8bf4\u4f60\u7528<code>pull nginx:latest</code>\u53d1\u73b0\u8fd8\u662f\u5f88\u8001\u7684\u7248\u672c......</p> /etc/docker/daemon.json<pre><code>{\n\"registry-mirrors\": [\n\"https://registry.docker-cn.com\",\n\"http://hub-mirror.c.163.com\",\n\"https://docker.mirrors.ustc.edu.cn\"\n]\n}\n</code></pre> centosubuntu <pre><code># \u4fee\u6539\u540e,\u9700\u8981.\nsudo systemctl daemon-reload\nsudo systemctl restart docker\ndocker info # \u80fd\u770b\u5230 Registry Mirrors \u7684\u914d\u7f6e\n</code></pre> <pre><code>service docker restart\ndocker info\n</code></pre>"},{"location":"devops/docker/ip/","title":"\u6d41\u91cf\u8d70\u5411\u5206\u6790","text":"","tags":["Docker"]},{"location":"devops/docker/ip/#_1","title":"\u542f\u52a8\u5bb9\u5668","text":"<pre><code>docker run -itd --name nginx -p 80:80 nginx\n</code></pre>","tags":["Docker"]},{"location":"devops/docker/ip/#iptables","title":"\u6253\u5f00iptables\u8c03\u8bd5\u529f\u80fd","text":"<p>\u901a\u8fc7\u8c03\u8bd5\u53ef\u4ee5\u770b iptables \u51e0\u4e2a\u8868 (raw mangle nat filter  ) \u7684\u987a\u5e8f,\u8c01\u5148\u8c01\u540e, \u53ef\u4ee5\u81ea\u5df1\u6d4b\u8bd5\u4e00\u4e0b.</p> <pre><code>modprobe ipt_LOG #centos6\nmodprobe nf_log_ipv4 #centos7\n# \u67e5\u770b\nsysctl net.netfilter.nf_log.2\n   #centos 7\nnet.netfilter.nf_log.2 = nf_log_ipv4\n# raw \u8868 \u6dfb\u52a0\u89c4\u5219, \u6253\u5f00\u8c03\u8bd5. \niptables -t raw -A PREROUTING -p tcp --dport 80 -j TRACE iptables -t raw -A OUTPUT -p tcp --dport 80 -j TRACE\niptables -t raw -nL\n</code></pre>","tags":["Docker"]},{"location":"devops/docker/ip/#nat","title":"\u67e5\u770b NAT \u8868","text":"<pre><code>iptables -t nat -nvL --line-numbers\n</code></pre> \u7ed3\u679c <pre><code>Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n1        0     0 DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL\n\nChain INPUT (policy ACCEPT 0 packets, 0 bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 12 packets, 883 bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n1        0     0 DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL\n\nChain POSTROUTING (policy ACCEPT 12 packets, 883 bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n1        0     0 MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0\n2        0     0 MASQUERADE  tcp  --  *      *       172.17.0.2           172.17.0.2           tcp dpt:80\n\nChain DOCKER (2 references)\nnum   pkts bytes target     prot opt in     out     source               destination\n1        0     0 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0\n2        0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:172.17.0.2:80\n</code></pre>","tags":["Docker"]},{"location":"devops/docker/ip/#filter","title":"\u67e5\u770b filter \u8868","text":"<pre><code>iptables -t filter -nvL --line-numbers\n</code></pre> \u7ed3\u679c <pre><code>Chain INPUT (policy ACCEPT 523 packets, 31567 bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n1       40  7071 DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n2       40  7071 DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n3       15   833 ACCEPT     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED\n4        3   156 DOCKER     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0\n5       22  6082 ACCEPT     all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0\n6        0     0 ACCEPT     all  --  docker0 docker0  0.0.0.0/0            0.0.0.0/0\n\nChain OUTPUT (policy ACCEPT 274 packets, 92208 bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n\nChain DOCKER (1 references)\nnum   pkts bytes target     prot opt in     out     source               destination\n1        3   156 ACCEPT     tcp  --  !docker0 docker0  0.0.0.0/0            172.17.0.2           tcp dpt:80\n\nChain DOCKER-ISOLATION-STAGE-1 (1 references)\nnum   pkts bytes target     prot opt in     out     source               destination\n1       22  6082 DOCKER-ISOLATION-STAGE-2  all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0\n2       40  7071 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain DOCKER-ISOLATION-STAGE-2 (1 references)\nnum   pkts bytes target     prot opt in     out     source               destination\n1        0     0 DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0\n2       22  6082 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain DOCKER-USER (1 references)\nnum   pkts bytes target     prot opt in     out     source               destination\n1       40  7071 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/\n</code></pre>","tags":["Docker"]},{"location":"devops/docker/ip/#watch","title":"watch \u65e5\u5fd7","text":"<pre><code>tail -f /var/log/kern.log\n# \u6216 ?\ntail -f /var/log/messages\n#\u6216 ?\ndmesg --follow\n</code></pre>","tags":["Docker"]},{"location":"devops/docker/ip/#nginx","title":"\u5916\u90e8\u6d4f\u89c8\u5668\u8bbf\u95ee nginx","text":"<p>\u4e0a\u9762\u6211\u7684\u64cd\u4f5c\u6211\u662f\u5728\u865a\u62df\u673a\u91cc\u7684.</p>","tags":["Docker"]},{"location":"devops/docker/ip/#_2","title":"\u89c2\u5bdf\u65e5\u5fd7","text":"<p>\u6d41\u91cf\u8fdb\u6765\u5148\u8d70 nat:PREROUTING -&gt; \u5982\u679c\u6709\u8f6c\u53d1\u5c31\u8d70filter:FORWARD-&gt;nat:POSTROUTING</p> \u7ed3\u679c <pre><code>TRACE: raw:PREROUTING:policy:2 IN=eth0 OUT=\n# nat:PREROUTING:rule:1 \u627e nat:PREROUTING \u7b2c\u4e00\u6761\u89c4\u5219, target \u662f DOCKER\nTRACE: nat:PREROUTING:rule:1 IN=eth0 OUT=\n#  nat:DOCKER: \u7684\u7b2c\u4e00\u6761\u89c4\u5219 in \u4e0d\u5339\u914d, \u6240\u4ee5 \u7ee7\u7eed\u4e0b\u4e00\u6761\u89c4\u5219. \u7b2c2\u6761\u5339\u914d\u4e86.\nTRACE: nat:DOCKER:rule:2 IN=eth0 OUT=\n# \u8d70filter \u7684 forward(\u56e0\u4e3a\u524d\u9762\u7684\u89c4\u5219\u91ccnat:DOCKER:rule:2  \u518d\u6839\u636e\u8def\u7531)\n# \u8df3\u8f6c\u5230 DOCKER-USER\nTRACE: filter:FORWARD:rule:1 IN=eth0 OUT=docker0 \n# \u8df3\u8fd9DOCKER-USER \u7b2c\u4e00\u6761. \u662f\u4e2areturn (return\u7684\u610f\u601d\u662f,\u7ed3\u675f\u5b50chains,\u8fd4\u56de\u5230\u539f\u6765\u7684chains \u7ee7\u7eed\u5b83\u7684\u4e0b\u4e00\u6761)\n# \u53ef\u4ee5\u7406\u89e3\u4e3a main\u51fd\u6570\u91cc \u8c03\u7528\u4e86 A \u51fd\u6570, A\u51fd\u6570\u91cc\u9762return\u4e86. \u4f60\u5230\u4e86main ,\u6267\u884c A\u51fd\u6570\u540e\u9762\u7684\u8bed\u53e5.\nTRACE: filter:DOCKER-USER:return:1 IN=eth0 OUT=docker0\n# \u56de\u5230forward\u7684\u7b2c\u4e8c\u6761 \u53d1\u73b0\u662f\u8df3 DOCKER-ISOLATION-STAGE-1\nTRACE: filter:FORWARD:rule:2 IN=eth0 OUT=docker0\n# DOCKER-ISOLATION-STAGE-1\u7684\u7b2c\u4e00\u6761 \u6ca1\u6709\u7b26\u5408\u89c4\u5219, \u7ee7\u7eed\u7b2c\u4e8c\u6761\u770b\u662f\u5426\u5339\u914d, \u5339\u914d\u4e86.\n# \u7b2c\u4e8c\u6761\u662f\u4e2areturn \nTRACE: filter:DOCKER-ISOLATION-STAGE-1:return:2 IN=eth0 OUT=docker0\n# \u7ee7\u7eed\u56de\u5230forward.  (\u770b\u7b2c3\u6761\u89c4\u5219\u6ca1\u5339\u914d,\u56e0\u4e3a\u662f\u8fd8\u6ca1\u6709\u5efa\u7acb\u8fde\u63a5)\nTRACE: filter:FORWARD:rule:4 IN=eth0 OUT=docker0\n# accept \u4e86..\nTRACE: filter:DOCKER:rule:1 IN=eth0 OUT=docker0\nTRACE: nat:POSTROUTING:policy:3 IN= OUT=docker0\n# \u540e\u7eed\nTRACE: filter:FORWARD:rule:1 IN=eth0 OUT=docker0\nTRACE: filter:DOCKER-USER:return:1 IN=eth0 OUT=docker0\nTRACE: filter:FORWARD:rule:2 IN=eth0 OUT=docker0\nTRACE: filter:DOCKER-ISOLATION-STAGE-1:return:2 IN=eth0 OUT=docker0\n# \u770b \u8fd9\u4e2a\u65f6\u5019\u5339\u914d\u4e0a\u4e86. \u56e0\u4e3a\u5df2\u7ecf\u5efa\u7acb\u8fde\u63a5\u4e86.\nTRACE: filter:FORWARD:rule:3 IN=eth0 OUT=docker0\n</code></pre>","tags":["Docker"]},{"location":"devops/k8s/command/","title":"\u547d\u4ee4\u6c47\u603b","text":"<p>Warning</p> <p>\u672a\u5b8c\u5f85\u7eed, \u9700\u8981\u91cd\u65b0\u6574\u7406</p>","tags":["k8s"]},{"location":"devops/k8s/command/#_1","title":"\u67e5","text":"<pre><code># \u6839\u636e~/.kube/config  \u91cc\u9762\u7684\u914d\u7f6e\u627e\u5230\u8981\u770b\u7684\u662f\u54ea\u4e2a\u96c6\u7fa4\n- context:\n    cluster: kubernetes  \u96c6\u7fa4\n    user: kubernetes-admin  \u7528\u6237\n\n#\u547d\u4ee4\u7a7a\u95f4\u7ea7\u522b\u7684\u8d44\u6e90\nkubectl get ns default           Active   115m\n    kube-node-lease   Active   115m\n    kube-public       Active   115m\n    kube-system       Active   115m\n# \u67e5\u770b\u8282\u70b9\nkubectl get nodes\n# \u7b49\u4ef7\nkubectl get no\n\nkubectl get po / pod /pods\nkubectl get pods # \u9ed8\u8ba4\u662f\u770b\u7684default\u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u8d44\u6e90, \u6709\u591a\u4e2apod\n#kube-system \u547d\u540d\u7a7a\u95f4\u4e0b\u7684 pod\u8d44\u6e90, \u9ed8\u8ba4\u5c31\u6709\u7684\nget pods -n kube-system -o wide\nget po -nkube-system -owide # \u53ef\u4ee5\u8fde\u5728\u4e00\u8d77\u5199\n# \u67e5\u770b\u6240\u6709\u547d\u540d\u7a7a\u95f4\u7684pods\nkubectl get pods -A  # \u7b49\u4ef7\u4e8e --all-namespaces\n# \u6307\u5b9ans \u591a\u4e2apod\nkubectl get po/calico-node-6tfnq po/calico-node-mq6p6 -n kube-system\nkubectl get po -w  # watch \u7684, \u4e00\u76f4\u5728\u663e\u793a \n#labels\nkubectl get po -w -l app=nginx\n# \u53ef\u4ee5\u8fd9\u6837 \u67e5\u770bpod\u7684image \u662f\u4ec0\u4e48\nkubectl get po -l app=nginx  -oyaml |grep image:\n\n# \u67e5\u770b node \u7684\u4f7f\u7528\u60c5\u51b5\nkubectl top node\n# \u67e5\u770bpod \u7684\u4f7f\u7528\u60c5\u51b5\nkubectl top pod\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#_2","title":"\u589e","text":"<pre><code># \u521b\u5efa\u547d\u4ee4\u7a7a\u95f4\nkubectl create ns dev # \u540c\u4e0a\u4e00\u6a21\u4e00\u6837\u7684\u6548\u679c\nkubectl create namespace dev\n# \u5220\u9664\u4e00\u4e2a\u8d44\u6e90\n#namespaces \u8868\u793a\u4e00\u79cd\u8d44\u6e90\u7c7b\u578b\nkubectl delete namespaces dev\nkubectl delete ns/dev #\u540c\u4e0a, \u53ef\u4ee5\u6307\u5b9a\u591a\u4e2a \nkubectl delete ns/dev ns/test\n\n# \u8fd9\u4e2a\u662f\u9648\u8ff0\u5f0f\u7684 \u8bed\u53e5\n# \u5982\u679c\u5df2\u7ecf\u521b\u5efa\u8fc7,\u5219\u4f1a\u62a5\u9519\nkubectl create -f dev-ns.yaml\nkubectl create -f dashboard.yaml\n# \u8fd9\u4e2a\u662f\u7533\u660e\u5f0f\u7684\u8bed\u53e5,\n#\u8fd9\u4e2a\u4e0d\u4f1a\u62a5\u9519,\u91cd\u65b0\u5e94\u7528\u4e00\u904d\nkubectl apply -f dashboard.yaml #(\u63a8\u8350) \n# \u67e5\u770b\u72b6\u6001\nkubectl get -f myapp.yaml\n#\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u76ee\u5f55,\u4e00\u6b21\u521b\u5efa\u591a\u4e2a\nkubectl apply -f ./\n\n# \u6ce8\u610f\u8fd9\u4e2a \u4f1a\u5148\u5220\u9664pod \u518d\u91cd\u5efa, \u4f1a\u5bfc\u81f4Pod\u7684IP\u5730\u5740\u548c\u6807\u8bc6\u7b26uid\u53d1\u751f\u53d8\u5316\nkubectl replace --force -f dashboard.yaml\nk get po -o yaml # \u770b\u5230\u7684uid\u4e0d\u4e00\u6837\u4e86,/var/lib/kubelet/pods/\n# \u4f7f\u7528\u5df2\u6709\u7684pod \u5230\u5904\u4e00\u4e2apod \u7684yaml\u6587\u4ef6,\u7136\u540e\u4fee\u6539\u4fee\u6539\n# --export \u8fd9\u4e2a\u53c2\u6570,\u4f1a\u8ba9\u5bfc\u51fa \u5c11\u4e00\u4e9b\u4e1c\u897f\nkubectl get pods/ngx-dep-75944fcf5f-jzlkm -o yaml --export &gt; aa.yaml\n\n# \u521b\u5efa\u4e00\u4e2adeploy\nkubectl create deploy ngx-dep  --image=nginx:1.14-alpine\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#_3","title":"\u5220","text":"<pre><code># \u5220\u9664\u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u6240\u6709pod\nkubectl delete po --all\n\n# \u540c\u6837\u6839\u636e\u6587\u4ef6\u6765\u5220\u9664 \u91cc\u9762\u6307\u5b9a\u7684pod\nkubectl delete -f dev-ns.yaml\n\n# -l labels \u6765\u8fc7\u6ee4 ,\u5220\u9664\u6389\u8fd9\u4e9blabels \u7684pod\nKubectl delete po -l app=nginx\n# \u9ed8\u8ba4\u60c5\u51b5\u4e0b ,\u6240\u6709\u7684\u5220\u9664\u64cd\u4f5c\u90fd\u4f1a\u9644\u6709 30 \u79d2\u949f\u7684\u5bbd\u9650\u671f\u9650\n# kubectl delete \u547d\u4ee4\u652f\u6301 --grace-period=&lt;seconds&gt; \u9009\u9879\uff0c\u5141\u8bb8\u4f60\u91cd\u8f7d\u9ed8\u8ba4\u503c\uff0c \u8bbe\u5b9a\u81ea\u5df1\u5e0c\u671b\u7684\u671f\u9650\u503c\n# \u5f3a\u5236\u5220\u9664, \u6bd4\u5982node \u8282\u70b9\u4f60\u505c\u6b62\u4e86. \u60f3\u8981\u5220\u9664\u4e0a\u9762\u7684 pod\nk delete po redis-cache-7954659dc4  --grace-period=0  --force\n\n# \u5220\u9664pod\u91cc\u7684\u5bb9\u5668\nk  delete pod &lt;pod_name&gt; -c &lt;container_name&gt;\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#_4","title":"\u6539","text":"<pre><code># \u8fdb\u5165pod \u4e2d\u7684\u67d0\u4e2a\u5bb9\u5668, \u5982\u679c\u8be5pod\u6709\u591a\u4e2a\u5bb9\u5668 \u5bb9\u5668\u540d\u524d\u9762\u9700\u8981\u52a0 -c\n# \u5148\u67e5\u770bpod\nkubectl get pods\n# \u83b7\u53d6pod \u66f4\u591a\u4fe1\u606f,\u627e\u5230 \u91cc\u9762\u7684\u5bb9\u5668\u540d\ncontainers:\n    - image: nginx:1.14-alpine\n        imagePullPolicy: IfNotPresent\n        name: nginx # \u8fd9\u4e2a\u5c31\u662f\u5bb9\u5668\u540d\nresources: {}\nterminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n        volumeMounts:\n        - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n        name: default-token-9qwmq\n        readOnly: true\nkubectl get pods/ngx-dep-75944fcf5f-jzlkm -o yaml\n# kubectl exec pod\u540d -c \u5bb9\u5668\u540d  -n \u547d\u540d\u7a7a\u95f4\nkubectl exec ngx-dep-75944fcf5f-jzlkm -c nginx  -it -- /bin/sh\n## -- \u540e\u9762\u76f4\u63a5\u8fd0\u884c\u4f60\u8981\u8fd0\u884c\u7684\u547d\u4ee4, \u6bd4\u5982 rm\u5220\u4ec0\u4e48\u4e1c\u897f\nkubectl exec ngx-dep-75944fcf5f-jzlkm -c nginx  -- rm /test.txt\n# \u5982\u679c\u53ea\u6709\u4e00\u4e2a\u5bb9\u5668,\u5219\u53ef\u4ee5 \u7701\u7565 -c \u5bb9\u5668\u540d\n# \u8fdb\u53bb\u4e4b\u540e\u53ef\u4ee5\u67e5\u770bip \u5730\u5740,\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#patch","title":"patch","text":"nginx-test.yaml<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nlabels:\nrun: nginx-test\nname: nginx-test\nnamespace: test\nspec:\ncontainers:\n- image: nginx:1.14.2\nname: nginx1\n</code></pre> <p>patch.yaml<pre><code>metadata:\nlabels:\napp: nginx-oo\n</code></pre> <pre><code>k apply -f nginx-test.yaml\n# \u6ca1\u6709\u7684\u5c31\u589e\u52a0, \u6709\u7684\u5c31\u66f4\u65b0\n# \u4e5f\u53ea\u6709\u4e00\u4e9b\u5c5e\u6027\u53ef\u4ee5\u8fd9\u6837\u64cd\u4f5c\nk patch pod -n test nginx-test  --patch \"$(cat patch.yaml)\"\nk get po -n test nginx-test -o yaml\n</code></pre></p>","tags":["k8s"]},{"location":"devops/k8s/command/#_5","title":"\u5176\u4ed6","text":"<pre><code>kubernetes port-forward podname nodeport:podport\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#pod","title":"pod\u7684\u64cd\u4f5c","text":"<pre><code># c = container\n# \u6ca1\u770b\u5230\u5bb9\u5668 \u76f8\u5173\nctr c ls\n# \u6211\u4eec\u9700\u8981\u52a0\u4e0anamespace \u624d\u80fd\u770b\u5230\nctr -n k8s.io c ls\n    0ccb703e70ea5b20c7aa12459cd71a6c5bc5ff2cc8ba05c9ed5523f2689d663b    registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6          io.containerd.runc.v2\n\n#\u4fee\u6539pod\u91cc\u5bb9\u5668\u7684\u8d44\u6e90\u5f00\u9500\nkubectl set resources deployment nginx-app -c=nginx -- limits=cpu=500m,memory=128Mi\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#_6","title":"\u76f4\u63a5\u521b\u5efa","text":"<pre><code>#\u76f4\u63a5\u547d\u4ee4\u521b\u5efa ,\u4e0d\u63a8\u8350\nkubectl run nginx-test --image=nginx\n#\u8fd0\u884c\u4e00\u4e2a\u4e34\u65f6\u7684 pod \nkubectl run -it --image busybox dns-test --restart=Never --rm /bin/sh\n\nkubectl get po -owide\n    nginx-test   1/1     Running   0              4m54s   172.20.204.66    m3 # \u6d4b\u8bd5\ncurl 172.20.204.66:80\nkubectl delete po nginx-test\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#yaml","title":"\u4f7f\u7528yaml\u6587\u4ef6\u521b\u5efa","text":"<pre><code>kubectl run nginx-test --image=nginx  --dry-run -oyaml  &gt;nginx.yaml\n#--dry-run is deprecated and can be replaced with --dry-run=client.\napiVersion: v1\nkind: Pod #\u8d44\u6e90\u7c7b\u578b\nmetadata: #\u5143\u6570\u636e\ncreationTimestamp: null\nlabels: # \u6807\u7b7e\nrun: nginx-test # key value\nname: nginx-test #pod \u540d\u79f0 \nspec: #pod \u771f\u6b63\u7684\u914d\u7f6e\ncontainers: #\u914d\u7f6e\u5bb9\u5668\u7684\u5730\u65b9,\u53ef\u4ee5\u5b9a\u4e49\u591a\u4e2a\n- image: nginx\nname: nginx-test\nports:\n- containerPort: 80\nargs: [\"abc\"] #\u76f8\u5f53\u4e8edocker\u91cc\u7684CMD\ncommand: [ \"sleep\" ,\"10\" ] # \u76f8\u5f53\u4e8edocker\u91cc\u7684entrypoint, \u53ef\u4ee5\u4fee\u6539\u5bb9\u5668\u7684\u542f\u52a8\u547d\u4ee4\n#  - image: redis\n#   name: redis\nresources: {}\ndnsPolicy: ClusterFirst\nrestartPolicy: Always\nstatus: {}\n# \u5982\u679cyaml\u6587\u4ef6\u91cc\u6709\u591a\u4e2a\u914d\u7f6e(---\u9694\u5f00\u7684). \u53ef\u4ee5\u9009\u62e9\u521b\u5efa\u54ea\u4e00\u4e2a.\nk create -f sidecar.yaml  -l run=nginx-test\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#_7","title":"\u67e5\u770b\u5b98\u65b9\u6587\u6863","text":"<p>Tip</p> <p>\u547d\u4ee4\u4e2d\u6709url \u5730\u5740 ,\u5b98\u65b9\u7684\u5e2e\u52a9\u6587\u6863</p> <pre><code>#apiVersion: v1\n# \u4f7f\u7528\u4e0b\u9762\u8fd9\u4e2a\u547d\u4ee4\u6765\u67e5\u770b \u5230\u5e95\u662f\u4f7f\u7528\u4ec0\u4e48\u7248\u672c\nkubectl api-resources |grep pod\n# \u67e5\u770bpod\u7684\u7533\u660e\u5f0f\u5b9a\u4e49\nkubectl explain pod\nkubectl explain pod.spec.containers\nkubectl explain namespaces\nkubectl explain service\nkubectl explain service.kind # \u591a\u7ea7\u89e3\u91ca\nkubectl create -f nginx.yaml\n# \u5982\u679c\u4f60\u9700\u8981\u4fee\u6539nginx.yaml \u91cc\u7684spec , \u90a3\u4e48\u9700\u8981\u5148\u5220\u9664\u539f\u6765\u7684pod\nkubectl delete -f nginx.yaml\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#events","title":"events","text":"<pre><code>k get events\nk get ev # \u7b80\u5316..\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#podpod","title":"\u67e5\u770bpod\u7684\u72b6\u6001,\u8c03\u67e5pod\u5931\u8d25\u539f\u56e0","text":"<pre><code>kubectl describe pod nginx-test\n\n# \u76f4\u63a5\u6267\u884c\u4e00\u4e0b \u5bb9\u5668\u91cc\u7684\u547d\u4ee4\nkubectl exec dep-nginx-cc78676bc-xlg48 -- ping 192.168.66.110\n\n# \u8fdb\u5165\u5bb9\u5668 \nkubectl exec  -it dep-nginx-cc78676bc-xlg48 -- sh\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#pod_1","title":"\u67e5\u770bpod\u7684\u65e5\u5fd7","text":"<pre><code># \u5bb9\u5668\u91cc\u65e5\u5fd7\u6253\u5728\u524d\u53f0\u7684\u53ef\u4ee5\u8fd9\u6837\u76f4\u63a5\u770b\nk logs nginx-test\n# \u6700\u8fd110m\u4e2d\u5185\u7684\u65e5\u5fd7 , --since=1h \u4e00\u4e2a\u5c0f\u65f6\nk logs  nginx --since=10m\n# \u5b9e\u65f6\u67e5\u770b\nk logs -f nginx-test\n# \u67e5\u770b\u6700\u65b0\u7684100\u884c\nk logs --tail=100 nginx-test\n# Pod\u4e4b\u524d\u53d1\u751f\u8fc7\u5d29\u6e83,\u8bbf\u95ee\u4e0a\u4e00\u4e2aPod\u7684\u65e5\u5fd7\nk logs --previous nginx-test\n# k logs pod\u540d \u5bb9\u5668\u540d\nk logs pod-nginx c-nginx1 -n test\n# \u5982\u679c\u5bb9\u5668\u91cc\u65e5\u5fd7\u5199\u5728\u5b83\u91cc\u9762\u7684\u67d0\u4e2a\u6587\u4ef6, \u90a3\u5c31 exec \u8fdb\u53bb\u5bb9\u5668 \u67e5\u770b\nk exec nginx-test -- tail -f /var/logs/xxxxx\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#labels","title":"labels","text":"<pre><code># \u663e\u793a\u6807\u7b7e\nkubectl get po  --show-labels\n    NAME                         READY   STATUS    RESTARTS       AGE   LABELS\n    busybox                      1/1     Running   41 (20m ago)   8d    &lt;none&gt;\n    nginx-hpa-7b486cb77c-q6jd4   1/1     Running   0              55m   app=nginx-hpa,pod-template-hash=7b486cb77c\n# \u4f7f\u7528\u6807\u7b7e\u8fc7\u6ee4\nkubectl get po -l app=nginx\n\n# \u6253\u6807\u5668.,\u4e00\u6b21\u547d\u4ee4\u53ef\u4ee5\u6253\u591a\u4e2a\u6807\u7b7e,\u7ed9\u591a\u4e2a\u5bf9\u8c61\u6253\nkubectl label node n1 n2 gpu=true disk=ssd\n# \u66f4\u65b0 \u6807\u7b7e\nkubectl label node n1  gpu=false  --overwrite\n\n# \u6279\u91cf\u66f4\u65b0, \u6709gpu(\u53ef\u4ee5\u662f\u5176\u4ed6\u9009\u62e9\u65b9\u5f0f) \u6807\u7b7e\u7684 \u66f4\u65b0 gpu=xx\nkubectl label node -l gpu gpu=xx  --overwrite\n\n# \u5220\u9664\u6807\u7b7e  key-\nkubectl label no n1 gpu-\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/command/#_8","title":"\u6ce8\u89e3","text":"<pre><code># \u6dfb\u52a0\nk annotate sc nfs-client  storageclass.kubernetes.io/is-default-class=true\n# \u5220\u9664\nk annotate sc nfs-client  storageclass.kubernetes.io/is-default-class-\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/basics/architecture/","title":"\u67b6\u6784\u603b\u89c8","text":""},{"location":"devops/k8s/basics/env/","title":"\u73af\u5883\u5b89\u88c5","text":"<p>Warning</p> <p>\u4ece1.24\u5f00\u59cb k8s\u4f7f\u7528\u7684docker-engine \u4e0d\u4e00\u6837\u4e86. \u662fcri-dockerd \u800c\u4e0d\u662f\u539f\u6765\u7684dockerd-shm</p>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#k8s","title":"k8s\u6587\u6863\u79bb\u7ebf\u90e8\u7f72","text":"<pre><code>git clone https://github.com/kubernetes/website.git\ncd website\n</code></pre> <p>\u89e3\u51b3\u641c\u7d22\u540e\u5f97\u5230\u7684url\u662fkubernetes\u5b98\u65b9\u5730\u5740\u7684\u95ee\u9898</p> <p>Warning</p> <p>\u8fd9\u53ea\u662f\u7b80\u5355\u7684\u5904\u7406, \u8fd8\u662f\u6709\u90e8\u5206url\u662f\u5b98\u65b9\u7684 bing-custom-search, \u8fd9\u4e2a\u5e94\u8be5\u662f\u80fd\u81ea\u5df1\u6574\u641c\u7d22</p> <p>\u914d\u7f6e\u6587\u4ef6\u4fee\u6539, \u53ef\u80fd\u4e0d\u9700\u8981?<pre><code>\u4fee\u6539config.toml\u7684baseURL\u4e3a\u4f60\u914d\u7f6e\u7684nginx\u5730\u5740\nbaseURL = \"http://localhost:8000\"\n\n\u4fee\u6539 netlify.toml\nHUGO_BASEURL = \"http://localhost:8000/\"\n</code></pre> static/js/search.js \u6dfb\u52a0\u66ff\u6362url\u7684\u4ee3\u7801<pre><code>        $.ajax(ajaxConf).done(function(res) {\nif (res.webPages == null) return; // If no result, 'webPages' is 'undefined'\nvar paginationAnchors = window.getPaginationAnchors(Math.ceil(res.webPages.totalEstimatedMatches / 10));\nres.webPages.value.map(ob =&gt; { results += window.getResultMarkupString(ob); })\n// ===== add start ======\nre = new RegExp(\"https://kubernetes.io\",\"g\");\nresults = results.replace(re, \"http://localhost:8000\");\n// ===== add end   ======\nif($('#bing-results-container').length &gt; 0) $('#bing-results-container').html(results);\nif($('#bing-pagination-container').length &gt; 0) $('#bing-pagination-container').html(paginationAnchors);\n});\n</code></pre></p> hugo \u751f\u6210\u9759\u6001\u6587\u4ef6\u65b9\u5f0f\u6307\u5b9a\u7248\u672cdocker \u65b9\u5f0f <p><pre><code># \u5b89\u88c5hugo \u548cnode , \u5c06\u91cc\u9762\u7684\u5bf9\u5e94\u7248\u672c\u4fee\u6539\u4e3a\u4f60\u5b89\u88c5\u7684\u7248\u672c\n# netlify.toml\ngit config --global url.\"https://ghproxy.com/https://github.com/\".insteadOf https://github.com/\nmake module-init\nnpm ci\nhugo # \u751f\u6210\u9759\u6001\u6587\u4ef6\u5230\u5f53\u524dpublic\u76ee\u5f55 ,\u7528nginx \u6765\u914d\u7f6e, \u4e0d\u8981\u7528 make serve ,\u4f1a\u5360\u7528\u5927\u91cf\u5185\u5b58.\n# \u53d6\u6d88\ngit config --global  --unset url.\"https://ghproxy.com/https://github.com/\".insteadOf\n# \u66f4\u65b0api \u6587\u6863\ncurl 'https://ghproxy.com/https://raw.githubusercontent.com/kubernetes/kubernetes/master/api/openapi-spec/swagger.json' &gt; api-ref-assets/api/swagger.json\ncd api-ref-generator/gen-resourcesdocs\ngo get -u golang.org/x/sys\n#go: upgraded golang.org/x/sys v0.0.0-20200930185726-fdedc70b468f =&gt; v0.9.0\ncd ../../\nmake api-reference\n</code></pre> nginx.conf<pre><code>  server {\n    listen       8000;\n    server_name  localhost;\n\n    location / {\n        root   /your-path/website/public;\n        index  index.html index.htm;\n    }\n}\n</code></pre></p> <p>Note</p> <p>\u5982\u679c\u60f3\u8981\u914d\u7f6e\u591a\u4e2a\u7248\u672c, \u5728\u9875\u9762\u4e0a\u53ef\u4ee5\u70b9\u51fb\u8df3\u8f6c\u5230\u6bd4\u59821.26\u7684\u6587\u6863, \u90a3\u4e48\u4fee\u6539 config.toml\u91cc\u7684params.versions\u5bf9\u5e94\u7684url,\u4e5f\u8981\u5bf9\u5e94\u751f\u6210\u9759\u6001\u6587\u4ef6,nginx \u914d\u7f6eurl \u6253\u5f00\u7f51\u9875,\u9996\u9875\u5c31\u4f1a\u770b\u5230 You are viewing documentation for Kubernetes version: v1.23</p> <pre><code>git co release-1.23\n# \u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u91cc\u539f\u6765\u7684\u7248\u672c, \u6700\u65b0\u7684hugo \u751f\u6210\u9759\u6001\u6587\u4ef6\u65f6\u4f1a\u62a5\u9519...\ngo install -tags extended github.com/gohugoio/hugo@v0.87.0\ngit config --global url.\"https://ghproxy.com/https://github.com/\".insteadOf https://github.com/\nmake module-init\nnpm ci\n~/go/bin/hugo # \u751f\u6210\u9759\u6001\u6587\u4ef6\u5230\u5f53\u524dpublic\u76ee\u5f55 ,\u7528nginx \u6765\u914d\u7f6e, \u4e0d\u8981\u7528 make serve ,\u4f1a\u5360\u7528\u5927\u91cf\u5185\u5b58.\n# \u53d6\u6d88\ngit config --global  --unset url.\"https://ghproxy.com/https://github.com/\".insteadOf\n# \u66f4\u65b0api \u6587\u6863\ncurl https://ghproxy.com/https://raw.githubusercontent.com/kubernetes/kubernetes/release-1.23/api/openapi-spec/swagger.json &gt; api-ref-assets/api/swagger.json\ncd api-ref-generator/gen-resourcesdocs\ngo get -u golang.org/x/sys\n#go: upgraded golang.org/x/sys v0.0.0-20200930185726-fdedc70b468f =&gt; v0.9.0\ncd ../../\nmake api-reference\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#api-postman","title":"api \u5bfc\u5165postman","text":"<p>\u4e0a\u9762\u7684 swagger.json \u5bfc\u5165postman</p> <p><pre><code># \u90e8\u7f72\u5b8ck8s\u540e\nkubectl proxy --accept-hosts=\".*\" --address=0.0.0.0\n</code></pre> \u5bbf\u4e3b\u673a\u4e0a\u6dfb\u52a0\u8fd9\u4e2a\u53c2\u6570, \u503c\u662f \u4e0a\u9762\u8bbe\u7f6e\u7684 <code>kubectl \u6240\u5728\u4e3b\u673aip:8001</code> </p> <p>sed\u53d1\u9001\u8bf7\u6c42\u540e\u63d0\u793assl\u9519\u8bef, \u5728settings \u91cc\u5c06 Enable SSL certificate verification \u53d6\u6d88</p>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#_1","title":"\u524d\u7f6e\u5b89\u88c5","text":"<p>Danger</p> <p>\u6211\u6253\u5305\u7684\u865a\u62df\u673a\u955c\u50cf\u91cc\u5df2\u7ecf\u524d\u7f6e\u5b89\u88c5\u4e86\u4e00\u4e9b\u4e1c\u897f,\u53ef\u80fd\u6709\u4e9b\u8fd9\u91cc\u6ca1\u8bb0\u5f55.\u540e\u7eed\u6211\u518d\u6574\u7406.</p> <ul> <li>\u5173\u95ed\u9632\u706b\u5899 <pre><code># --now \u8868\u793a \u9a6c\u4e0a\u505c\u6b62, \u8fd9\u6837\u5c31\u662f\u7981\u7528\u5e76\u505c\u6b62\nsystemctl disable --now firewalld\n# systemctl disable --now dnsmasq\n# systemctl disable --now NetworkManager\n# \u4ee5\u524d\u6211\u8fd9\u4e2a\u4e5f\u662fdisabled\nsed -Ei.bak 's/^SELINUX=[[:alpha:]]+$/SELINUX=permissive/' /etc/selinux/config\nsed -Ei.bak 's/^SELINUX=[[:alpha:]]+$/SELINUX=disabled/' /etc/sysconfig/selinux\nsetenforce 0 # 0\u8868\u793a\u8bbe\u7f6e\u4e3apermissive\ngetenforce # \u67e5\u770b, \u663e\u793a permissive\n</code></pre></li> <li> <p>\u5173\u95ed swap\u5206\u533a <pre><code>swapoff -a &amp;&amp; sysctl -w vm.swappiness=0\n# \u6ce8\u91ca\u6389fstab \u91cc\u7684swap\u914d\u7f6e\nsed -Ei.bak '/^[^#]*swap/s/^/#/' /etc/fstab\n</code></pre></p> </li> <li> <p>docker\u914d\u7f6e /etc/docker/daemon.json<pre><code>{\n\"registry-mirrors\": [\n\"https://registry.docker-cn.com\",\n\"http://hub-mirror.c.163.com\",\n\"https://docker.mirrors.ustc.edu.cn\"\n],\n\"exec-opts\": [\"native.cgroupdriver=systemd\"],\n\"max-concurrent-downloads\": 10,\n\"max-concurrent-uploads\": 5,\n\"log-opts\": {  // /var/lib/docker/containers/\n\"max-size\": \"300m\",\n\"max-file\": \"2\"\n},\n\"live-restore\": true  // \u5982\u679c\u4e0d\u662ftrue, \u91cd\u542fdocker,\u56de\u5bfc\u81f4\u5bb9\u5668\u91cd\u542f.\n}\n</code></pre> <pre><code>systemctl daemon-reload\nsystemctl restart docker\n# \u67e5\u770b\u662f\u5426\u914d\u7f6e\ndocker info |grep -E -A 3 \"Cgroup|Registry Mirrors\"\n</code></pre></p> </li> <li> <p>\u65f6\u95f4\u540c\u6b65 <pre><code>timedatectl set-timezone Asia/Shanghai\nsed -i \"s/server 0.centos.pool.ntp.org iburst/server cn.pool.ntp.org iburst/\" /etc/chrony.conf\nsystemctl enable chronyd\nsystemctl start chronyd\n</code></pre></p> </li> <li> <p>ulimit <pre><code>ulimit -SHn 65535\ncat &gt;&gt; /etc/security/limits.conf &lt;&lt;EOF\n*    soft    nofile    655350\n*    hard    nofile    655350\n*    soft    noproc    655350\n*    hard    noproc    655350\n*    soft    memlock   unlimited\n*    hard    memlock   unlimited\nEOF\n</code></pre></p> </li> <li> <p>\u8282\u70b9\u95f4ssh\u914d\u7f6e <pre><code>cat &gt;&gt; /etc/hosts &lt;&lt; EOF\n192.168.66.100  m1\n192.168.66.101  m2\n192.168.66.102  m3\n192.168.66.110  n1\n192.168.66.111  n2\nEOF\n# \u5c06 master\u7684 pub \u53d1\u9001\u5230 node\nssh-keygen -t rsa\nfor i in n1 n2 m2 m3;do ssh-copy-id -i ~/.ssh/id_rsa.pub root@$i;done\n</code></pre></p> </li> </ul>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#_2","title":"\u90e8\u7f72","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/env/#kubeadm","title":"kubeadm\u65b9\u5f0f","text":"<p>\u5b98\u65b9\u6587\u6863</p>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#kubeadm_1","title":"\u6240\u6709\u8282\u70b9\u5b89\u88c5kubeadm","text":"red hat-based <p><pre><code>cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n</code></pre> <pre><code># sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\n# \u5b89\u88c5\u6307\u5b9a\u7248\u672c\nsudo yum install -y kubelet-1.23.17 kubeadm-1.23.17 kubectl-1.23.17  # cri-tools-1.23.0\nsudo systemctl enable kubelet\n</code></pre></p> <ul> <li>\u9a8c\u8bc1\u5b89\u88c5 <pre><code>kubeadm version\n</code></pre></li> </ul>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#masterinit","title":"master\u8282\u70b9init","text":"<pre><code>kubeadm config print init-defaults &gt; kubeadm.yaml\n</code></pre> <p>Tips</p> <p>apiVersion \u6ce8\u610f\u770b\u914d\u7f6e\u6587\u4ef6\u7684\u6bcf\u4e2akind\u7684\u7248\u672c, \u7136\u540e\u53bb\u6587\u6863\u641c\u5bf9\u5e94\u7684\u914d\u7f6e,\u53ef\u80fd\u6709\u53d8\u5316</p> kubeadm.yaml \u505a\u4e00\u4e9b\u4fee\u6539<pre><code>apiVersion: kubeadm.k8s.io/v1beta3\nbootstrapTokens:\n- groups:\n- system:bootstrappers:kubeadm:default-node-token\ntoken: abcdef.0123456789abcdef\nttl: 24h0m0s\nusages:\n- signing\n- authentication\nkind: InitConfiguration\nlocalAPIEndpoint:\nadvertiseAddress: 192.168.66.102 # (1)\nbindPort: 6443\nnodeRegistration:\ncriSocket: /var/run/dockershim.sock # docker \u4f5c\u4e3aruntime\n#   criSocket: unix:///var/run/containerd/containerd.sock  # containerd \u4f5c\u4e3aruntime\nimagePullPolicy: IfNotPresent\nname: master # (4)\ntaints: null\n---\napiServer:\ntimeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns: {}\n#   type: CoreDNS   v1beta3 \u5b57\u6bb5 \"ClusterConfiguration.dns.type\" \u5df2\u7ecf\u88ab\u79fb\u9664\uff0c\u56e0\u4e3a CoreDNS \u662f kubeadm \u6240\u652f\u6301 \u7684\u552f\u4e00 DNS \u670d\u52a1\u5668\u7c7b\u578b\u3002\netcd:\nlocal:\ndataDir: /var/lib/etcd\nlisten-peer-urls: \"https://192.168.66.102:2380\" # (2)\nlisten-client-urls: \"https://192.168.66.102:2379,http://127.0.0.1:2379\"\nimageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers # (3)\nkind: ClusterConfiguration\nkubernetesVersion: 1.23.17\nnetworking:\ndnsDomain: cluster.local\nserviceSubnet: 10.96.0.0/12\npodSubnet: 10.244.0.0/16 # (5)\nscheduler: {}\n</code></pre> <ol> <li>master\u8282\u70b9\u7684ip</li> <li>\u6dfb\u52a0listen-peer-urls</li> <li>\u4fee\u6539\u4e3a aliyun \u7684</li> <li>\u8282\u70b9\u7684\u540d\u5b57</li> <li>\u96c6\u7fa4Pod\u7684\u7f51\u6bb5</li> </ol> master\u8282\u70b9<pre><code># \u5217\u51fa\u9700\u8981\u4e0b\u8f7d\u7684\u955c\u50cf\nkubeadm config images list --config kubeadm.yaml\n# \u5148 \u4e0b\u8f7d \u955c\u50cf\nkubeadm config images pull --config kubeadm.yaml\nkubeadm init --config kubeadm.yaml\n\n# \u53ef\u4ee5\u91cd\u65b0\u4fee\u6539\u76f8\u5173\u914d\u7f6e.\nkubectl edit cm -n kube-system kubeadm-config\n\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n\n# \u8bb0\u4e0b kubeadm join \u7684\u547d\u4ee4\n# \u5fd8\u8bb0\u4e86, \u4e5f\u6ca1\u5173\u7cfb ,\u91cd\u65b0\u8f93\u51fa\nkubeadm  token create --print-join-command\n</code></pre> <pre><code>k get po -A # \u4f1a\u770b\u5230CoreDNS pending \u4e2d, \u9700\u8981\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#pod","title":"\u5b89\u88c5 Pod \u7f51\u7edc\u9644\u52a0\u7ec4\u4ef6","text":"<p>Note</p> <p>\u6709\u8bb8\u591a\u7f51\u7edc\u6a21\u578b\u53ef\u4ee5\u9009\u62e9</p> <p>\u9700\u8981kubeadm init \u65f6\u6307\u5b9a --pod-network-cidr \u8fd9\u4e2a\u53c2\u6570</p> <ul> <li> <p>flannel <pre><code>wget https://ghproxy.com/https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml\nk create -f  kube-flannel.yml\n\nk get po -A # \u4f1a\u770b\u5230CoreDNS \u4e5f\u6210\u529frunning\u4e86.\n</code></pre></p> </li> <li> <p>calico https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart#install-calico</p> </li> </ul> <p><pre><code>wget  https://docs.projectcalico.org/manifests/calico.yaml\n# \u4f1a\u770b\u5230  \u5b9e\u9645\u7684url \nhttps://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml\nwget https://ghproxy.com/https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml\n# \u505a\u76f8\u5e94\u4fee\u6539..\nk apply -f calico.yaml\n</code></pre> network-plugins</p> <p>\u901a\u8fc7\u7ed9 Kubelet \u4f20\u9012 --network-plugin=cni \u547d\u4ee4\u884c\u9009\u9879\u53ef\u4ee5\u9009\u62e9 CNI \u63d2\u4ef6\u3002 Kubelet \u4ece --cni-conf-dir \uff08\u9ed8\u8ba4\u662f /etc/cni/net.d\uff09 \u8bfb\u53d6\u6587\u4ef6\u5e76\u4f7f\u7528 \u8be5\u6587\u4ef6\u4e2d\u7684 CNI \u914d\u7f6e\u6765\u8bbe\u7f6e\u5404\u4e2a Pod \u7684\u7f51\u7edc</p> <p>\u5220\u9664calico \u9700\u8981\u5230 \u6bcf\u4e2a\u8282\u70b9\u4e0a\u7684 <code>/etc/cni/net.d</code> \u76ee\u5f55\u4e0b\u5220\u9664 calico \u7684\u76f8\u5173\u914d\u7f6e, \u7136\u540e \u90fd<code>systemctl restart kubelet</code></p>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#nodejoin","title":"node\u8282\u70b9join","text":"<p>Note</p> <p>kubectl \u6267\u884c\u7684\u547d\u4ee4\u4f1a\u53bb\u8bf7\u6c42master\u8282\u70b9\u7684apiserver,\u9700\u8981\u6743\u9650, \u4f7f\u7528\u7684\u914d\u7f6e\u6587\u4ef6\u9700\u8981\u4ecemaster\u90a3\u91cc\u590d\u5236\u8fc7\u6765. \u4efb\u4f55\u673a\u5668\u4e0a\u6709kubectl \u8fd9\u4e2a\u547d\u4ee4, \u7136\u540e\u6709\u53ef\u4ee5\u8fde\u63a5\u4e0aapiserver\u7684\u914d\u7f6e\u6587\u4ef6, \u90a3\u4e48\u5c31\u53ef\u4ee5\u7528kubectl\u8fdb\u884c\u67e5\u770b\u7b49\u64cd\u4f5c</p> <pre><code>all_nodes='n1 n2'\nfor node in $all_nodes; do\nssh $node \"mkdir -p /root/.kube\"\nscp /etc/kubernetes/admin.conf $node:/root/.kube/config\ndone\nkubeadm join 192.168.66.100:6443 --token ... --discovery-token-ca-cert-hash ...\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#_3","title":"\u5b89\u88c5\u540e\u7684\u76f8\u5173\u914d\u7f6e\u4ee5\u53ca\u66f4\u65b0","text":"<p>Tip</p> <p>\u5728 k8s \u4e2d,\u6709\u4e00\u79cd\u7279\u6b8a\u7684\u5bb9\u5668\u542f\u52a8\u65b9\u6cd5\u53eb\u505a\"Static Pod\"\u3002\u5b83\u5141\u8bb8\u4f60\u628a\u8981\u90e8\u7f72\u7684 Pod \u7684 YAML \u6587\u4ef6\u653e\u5728\u4e00\u4e2a\u6307\u5b9a\u7684\u76ee\u5f55\u91cc,\u5f53\u8fd9\u53f0\u673a\u5668\u4e0a\u7684 kubelet \u542f\u52a8\u65f6\uff0c\u5b83\u4f1a \u81ea\u52a8\u68c0\u67e5\u8fd9\u4e2a\u76ee\u5f55\uff0c\u52a0\u8f7d\u6240\u6709\u7684 Pod YAML \u6587\u4ef6\uff0c\u7136\u540e\u5728\u8fd9\u53f0\u673a\u5668\u4e0a\u542f\u52a8\u5b83\u4eec \u9759\u6001 Pod \u5728\u6307\u5b9a\u7684\u8282\u70b9\u4e0a\u7531 kubelet \u5b88\u62a4\u8fdb\u7a0b\u76f4\u63a5\u7ba1\u7406,\u4e0d\u9700\u8981 API \u670d\u52a1\u5668\u76d1\u7ba1. \u4e0e\u7531\u63a7\u5236\u9762\u7ba1\u7406\u7684 Pod\uff08\u4f8b\u5982\uff0cDeployment\uff09 \u4e0d\u540c,kubelet \u76d1\u89c6\u6bcf\u4e2a\u9759\u6001 Pod\uff08\u5728\u5b83\u5931\u8d25\u4e4b\u540e\u91cd\u65b0\u542f\u52a8\uff09</p> centos\u627e\u5230kubelet\u7684\u914d\u7f6e\u6587\u4ef6<pre><code># 1. \u5148\u770b\u914d\u7f6e\u6587\u4ef6\u4f4d\u7f6e\nps -ef |grep kubelet\n# 2. \u9996\u5148\u6211\u4eec kubelet \u662f\u901a\u8fc7systemctl \u542f\u52a8\u7684.\ntree /etc/systemd/system |grep kubelet -B 10\n# 3. \u4f4d\u7f6e\u5728\u8fd9, \u4f60\u4f1a\u53d1\u73b0\u91cc\u9762\u5e76\u6ca1\u6709\u914d\u7f6e\u4fe1\u606f,\u8fd9\u4e0e\u6211\u4eec ps -ef |grep kubelet \u770b\u5230\u7684,\u4e0d\u4e00\u6837\n/usr/lib/systemd/system/kubelet.service #(1)\n# 4. \u90a3\u4e48\u5fc5\u5b9a\u6709 /usr/lib/systemd/system/kubelet.service.d \u6587\u4ef6\u5939\u7528\u4e8e\u653e\u7f6e\u914d\u7f6e\u6587\u4ef6\u7684\n#    \u91cc\u9762\u7684.conf \u914d\u7f6e\u6587\u4ef6\u4f1a\u5bf9 systemd \u5355\u5143\u6587\u4ef6(.service \u91cc\u7684\u542f\u52a8\u7a0b\u5e8f) \u8fdb\u884c\u6dfb\u52a0\u3001\u4fee\u6539\u6216\u8986\u76d6\u670d\u52a1\u7684\u7279\u5b9a\u9009\u9879\n#    systemd \u4f1a\u52a0\u8f7d\u5b83\u4eec\u5e76\u5e94\u7528\u4e8e\u539f\u59cb\u670d\u52a1\u5355\u5143\u6587\u4ef6\ntree /usr/lib/systemd/system/kubelet.service.d\n\u2514\u2500\u2500 10-kubeadm.conf\n# 5. 10-kubeadm.conf \u770b\u540d\u5b57\u90fd\u77e5\u9053\u8fd9\u4e2a\u662fkubeadm \u7ed9\u6211\u4eec\u521b\u5efa\u7684.\ncat 10-kubeadm.conf #(2)\n</code></pre> <ol> <li>kubelet.service     <pre><code>[Unit]\nDescription=kubelet: The Kubernetes Node Agent\nDocumentation=https://kubernetes.io/docs/\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nExecStart=/usr/bin/kubelet\nRestart=always\nStartLimitInterval=0\nRestartSec=10\n\n[Install]\nWantedBy=multi-user.target\n</code></pre></li> <li>10-kubeadm.conf     <pre><code># Note: This dropin only works with kubeadm and kubelet v1.11+\n[Service]\nEnvironment=\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf\"\nEnvironment=\"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml\"\n# This is a file that \"kubeadm init\" and \"kubeadm join\" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically\nEnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env\n# This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use\n# the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.\nEnvironmentFile=-/etc/sysconfig/kubelet\nExecStart=\nExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS\n</code></pre></li> </ol> \u67e5\u770bstaticPod\u76ee\u5f55<pre><code>grep staticPod /var/lib/kubelet/config.yaml\ntree /etc/kubernetes/manifests\n\u251c\u2500\u2500 etcd.yaml\n\u251c\u2500\u2500 kube-apiserver.yaml\n\u251c\u2500\u2500 kube-controller-manager.yaml\n\u2514\u2500\u2500 kube-scheduler.yaml\n</code></pre> <p>Tip</p> <p>kubelet \u4f1a\u76d1\u89c6\u8fd9\u4e2a\u76ee\u5f55,\u4f60\u5728\u91cc\u9762\u6bd4\u5982\u521b\u5efa\u4e00\u4e2apod\u7684yaml,kubelet\u5c31\u4f1a\u4e3a\u4f60\u521b\u5efa\u8fd9\u4e2apod. \u4fee\u6539\u91cc\u9762\u7684\u914d\u7f6e\u6587\u4ef6, K8s \u5c06\u81ea\u52a8\u68c0\u6d4b\u5230\u914d\u7f6e\u6587\u4ef6\u7684\u66f4\u6539\u5e76\u91cd\u65b0\u542f\u52a8\u76f8\u5173\u670d\u52a1</p>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#minikube","title":"minikube","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/env/#kind","title":"kind\u65b9\u5f0f","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/env/#_4","title":"\u4e8c\u8fdb\u5236\u65b9\u5f0f","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/env/#kubespray","title":"kubespray\u65b9\u5f0f","text":"<p>kubespray</p>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#kubesphere","title":"kubesphere","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/env/#rancher","title":"rancher","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/env/#kops","title":"kops","text":"<p>Tip</p> <p>Installing and launching a Kubernetes cluster hosted on AWS, GCE, DigitalOcean, Hetzner, OpenStack, Azure</p>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#google-kubernetes-engine-gke","title":"Google Kubernetes Engine (GKE)","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/env/#_5","title":"\u9ad8\u53ef\u7528\u96c6\u7fa4","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/env/#_6","title":"\u540e\u7f6e\u5b89\u88c5","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/env/#_7","title":"\u81ea\u52a8\u8865\u5168","text":"<p>kubectl\u81ea\u52a8\u8865\u5168</p> \u5f53\u524d\u7528\u6237\u5168\u5c40\u8bbe\u7f6e <pre><code># apt-get install bash-completion\nyum install bash-completion -y\nsource /usr/share/bash-completion/bash_completion\necho  \"source /usr/share/bash-completion/bash_completion\" &gt;&gt; ~/.bashrc\n# \u68c0\u67e5 bash-completion \u662f\u5426\u8bbe\u7f6e\u5b8c\u6210\ntype _init_completion\necho \"source &lt;(kubectl completion bash)\" &gt;&gt; ~/.bashrc\n# \u8fd9\u6837 \u4f7f\u7528k \u5c31\u80fd\u81ea\u52a8\u8865\u5168\u4e86\necho 'alias k=kubectl' &gt;&gt;~/.bashrc\necho 'complete -o default -F __start_kubectl k' &gt;&gt;~/.bashrc\n# \u8fd9\u6837\u53bb\u641c\u5173\u952e\u5b57  kubectl alias auto complete\necho 'alias ks=\"kubectl -n kube-system\"' &gt;&gt;~/.bashrc\necho 'complete -o default -F __start_kubectl ks' &gt;&gt;~/.bashrc\n</code></pre> <pre><code># apt-get install bash-completion\nyum install bash-completion -y\nsource /usr/share/bash-completion/bash_completion\n# echo  \"source /usr/share/bash-completion/bash_completion\" &gt;&gt; /etc/profile\nkubectl completion bash | sudo tee /etc/bash_completion.d/kubectl &gt; /dev/null\n# \u68c0\u67e5 bash-completion \u662f\u5426\u8bbe\u7f6e\u5b8c\u6210\ntype _init_completion\necho \"source &lt;(kubectl completion bash)\" &gt;&gt; /etc/profile\n# \u8fd9\u6837 \u4f7f\u7528k \u5c31\u80fd\u81ea\u52a8\u8865\u5168\u4e86\necho 'alias k=kubectl' &gt;&gt;/etc/profile\necho 'complete -o default -F __start_kubectl k' &gt;&gt;/etc/profile\n# \u8fd9\u6837\u53bb\u641c\u5173\u952e\u5b57  kubectl alias auto complete\necho 'alias ks=\"kubectl -n kube-system\"' &gt;&gt;/etc/profile\necho 'complete -o default -F __start_kubectl ks' &gt;&gt;/etc/profile\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/basics/env/#kubectl","title":"\u72ec\u7acb\u5b89\u88c5kubectl","text":"<p>mac\u5b89\u88c5kubectl <pre><code>curl -LO \"https://dl.k8s.io/release/v1.23.17/bin/darwin/amd64/kubectl\"\nchmod +x kubectl\nmv kubectl /usr/local/bin\n# \u5c06master\u8282\u70b9(\u6211\u7684\u73af\u5883 \u662f\u865a\u62df\u673a)\u91cc\u7684.kube \u6587\u4ef6\u5939\u590d\u5236\u5230 mac (host \u4e3b\u673a)\u7684 ~ \u76ee\u5f55\n# \u8fd9\u6837\n</code></pre></p> \u9a8c\u8bc1\u662f\u5426\u914d\u7f6e\u6210\u529f<pre><code>kubectl cluster-info # \u770b\u770b\nkubectl get no\n  NAME      STATUS   ROLES                  AGE     VERSION\n  master1   Ready    control-plane,master   4d23h   v1.23.17\n  node1     Ready    &lt;none&gt;                 3d17h   v1.23.17\n  node2     Ready    &lt;none&gt;                 4m46s   v1.23.17\nkubectl get no -o wide # \u53ef\u4ee5\u770b\u5230 \u4f7f\u7528\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\n</code></pre> <ol> <li> <p>k8s\u5b98\u65b9\u79bb\u7ebf\u6587\u6863 \u21a9</p> </li> <li> <p>kubeadm\u91cd\u65b0\u4fee\u6539\u96c6\u7fa4\u914d\u7f6e \u21a9</p> </li> <li> <p>kubesphere\u00a8\u00a0\u21a9</p> </li> <li> <p>kops \u21a9</p> </li> <li> <p>GKE \u21a9</p> </li> <li> <p>kubespray \u21a9</p> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/","title":"\u955c\u50cf\u4ed3\u5e93","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/#harbor","title":"harbor","text":"<p>Tip</p> <p>\u642d\u5efa\u81ea\u5df1\u7684\u4ed3\u5e93</p>","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/#docker-compose","title":"docker-compose \u65b9\u5f0f","text":"Generate a Certificate Authority Certificate<pre><code># Generate a CA certificate private key.\nopenssl genrsa -out ca.key 4096\n# Generate the CA certificate\n# CN= \u6539\u6210\u4f60\u7684\u57df\u540d\nopenssl req -x509 -new -nodes -sha512 -days 3650 \\\n-subj \"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=hb.6o6.com\" \\\n-key ca.key \\\n-out ca.crt\n</code></pre> Generate a Server Certificate<pre><code># Generate a private key.\nopenssl genrsa -out hb.6o6.com.key 4096\n# Generate a certificate signing request (CSR).\nopenssl req -sha512 -new \\\n-subj \"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=hb.xx.com\" \\\n-key hb.6o6.com.key \\\n-out hb.6o6.com.csr\n\n# Generate an x509 v3 extension file\ncat &gt; v3.ext &lt;&lt;-EOF\nauthorityKeyIdentifier=keyid,issuer\nbasicConstraints=CA:FALSE\nkeyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n[alt_names]\nDNS.1=hb.6o6.com\nDNS.2=hb.6o6\nDNS.3=hostname\nEOF\nopenssl x509 -req -sha512 -days 3650 \\\n-extfile v3.ext \\\n-CA ca.crt -CAkey ca.key -CAcreateserial \\\n-in hb.6o6.com.csr \\\n-out hb.6o6.com.crt\n</code></pre> <p>Provide the Certificates to Harbor and Docker<pre><code>mkdir -p /hb_data/cert\ncp hb.6o6.com.crt /hb_data/cert/\ncp hb.6o6.com.key /hb_data/cert/\n\nopenssl x509 -inform PEM -in hb.6o6.com.crt -out hb.6o6.com.cert\nmkdir -p /etc/docker/certs.d/hb.6o6.com/\ncp hb.6o6.com.cert /etc/docker/certs.d/hb.6o6.com/\ncp hb.6o6.com.key /etc/docker/certs.d/hb.6o6.com/\ncp ca.crt /etc/docker/certs.d/hb.6o6.com/\n\nsystemctl restart docker\n# \u4e0b\u8f7donline\u7248, \u81ea\u5df1pull \u955c\u50cf\nwget https://github.com/goharbor/harbor/releases/download/v2.8.2/harbor-online-installer-v2.8.2.tgz\ntar xf harbor-online-installer-v2.8.2.tgz\ncd harbor\ncp harbor.yml.tmpl harbor.yml\nsed -i 's/reg.mydomain.com$/hb.6o6.com/' harbor.yml\nsed -i 's#certificate: /your/certificate/path#certificate: /etc/docker/certs.d/hb.6o6.com/hb.6o6.com.cert#' harbor.yml\nsed -i 's#private_key: /your/private/key/path#private_key: /etc/docker/certs.d/hb.6o6.com/hb.6o6.com.key#' harbor.yml\n# \u9875\u9762\u5bc6\u7801\nsed -i 's/harbor_admin_password: Harbor12345/harbor_admin_password: hb123/' harbor.yml\n# db\u5bc6\u7801\nsed -i 's/password: root123/password: hb123/' harbor.yml\nsed -i 's#data_volume: /data#data_volume: /hb_data#' harbor.yml\n\n./install.sh\n\n# \u6240\u6709\u8282\u70b9\u4e0a\necho &gt;&gt;/etc/hosts &lt;&lt;EOF\n192.168.1.105 hb.6o6.com\nEOF\n</code></pre> \u6d4f\u89c8\u5668\u8bbf\u95ee \u81ea\u5df1\u7684harbor \u7528\u6237\u662fadmin</p>","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/#helm","title":"helm \u65b9\u5f0f\u5b89\u88c5","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/#_1","title":"\u4f7f\u7528","text":"<ol> <li>\u65b0\u5efa\u9879\u76ee, \u8bbe\u7f6e\u4e00\u4e2a\u540d\u79f0xyz, \u8bbf\u95ee\u7ea7\u522b \u4e0d\u8981\u70b9\u9009, \u8fd9\u6837\u5c31\u8868\u793a\u79c1\u6709, -1\u8868\u793a\u5bb9\u91cf\u4e0d\u9650.</li> <li>\u70b9\u51fb\u65b0\u5efa\u7684\u9879\u76ee\u540dxyz\u2192\u955c\u50cf\u4ed3\u5e93\u2192\u63a8\u9001\u547d\u4ee4</li> </ol> \u5728\u6211\u4eec\u7684k8s \u8282\u70b9\u4e0a\u64cd\u4f5c<pre><code>docker login hb.6o6.com\nUsername: admin\nPassword:  # \u8f93\u5165\u524d\u9762\u4fee\u6539\u7684password\ndocker pull busybox # \u8fd9\u4e2a\u662f\u4f1a\u4ece docker.io \u62c9\u53d6?\ndocker tag busybox:latest hb.6o6.com/xyz/busybox:newest\ndocker images\n    REPOSITORY                    TAG\n    busybox                       latest\n    hb.6o6.com/xyz/busybox        newest\ndocker push hb.6o6.com/xyz/busybox:newest\n# \u53ef\u4ee5\u53bb\u9875\u9762\u770b\u770b.\n</code></pre> <p>Cosign \u7b7e\u540d</p>","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/#k8s","title":"k8s\u4f7f\u7528\u79c1\u6709\u955c\u50cf\u4ed3\u5e93","text":"<p>Warning</p> <p>\u521b\u5efa\u7684secret\u9700\u8981\u548c\u4f60\u521b\u5efa\u7684pod\u5728\u540c\u4e00\u4e2anamespace</p>","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/#dockerruntime","title":"docker\u4f5c\u4e3aruntime","text":"<ol> <li> <p>\u521b\u5efasecret</p> \u901a\u8fc7docker login\u540e\u7684\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a\u7528\u6237\u5bc6\u7801 <pre><code>docker login hb.6o6.web # \u8f93\u5165\u7528\u6237\u5bc6\u7801\u540e.\nkubectl create secret generic regcred  \\\n--from-file=.dockerconfigjson=/root/.docker/config.json \\\n--type=kubernetes.io/dockerconfigjson \\\n--namespace=test\n</code></pre> <pre><code>kubectl create secret docker-registry regcred \\\n--docker-server=hb.6o6.web/6o6 \\\n--docker-username=admin \\\n--docker-password=hb123 \\\n--namespace=test\n</code></pre> </li> <li> <p>\u67e5\u770b\u751f\u6210\u7684secret <pre><code>kubectl get secret regcred --output=yaml\nkubectl get secret regcred --output=\"jsonpath={.data.\\.dockerconfigjson}\" | base64 --decode\n</code></pre></p> </li> <li>\u914d\u7f6edocker \u6240\u6709\u8282\u70b9\u4e0a/etc/docker/daemon.json\u6dfb\u52a0<pre><code>// \u4e0e \"registry-mirrors\" \u540c\u7ea7\n\"insecure-registries\": [\"hb.6o6.com\"],\n</code></pre></li> <li>\u91cd\u542fdocker <pre><code>systemctl daemon-reload\nsystemctl restart docker\n</code></pre></li> <li>\u4fee\u6539pod\u7684yaml\u6587\u4ef6 pod\u7684\u5c5e\u6027,\u4e0econtainers\u540c\u7ea7\u7684<pre><code>imagePullSecrets:\n- name: regcred\n</code></pre></li> </ol>","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/#containerd","title":"containerd","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/#aliyun","title":"aliyun \u955c\u50cf\u4ed3\u5e93","text":"<p>Tip</p> <p>\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u5b83\u6765\u6784\u5efa\u9700\u8981fq\u624d\u80fd\u5feb\u901f\u6784\u5efa\u7684\u955c\u50cf</p> <p></p>","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/#_2","title":"\u57fa\u7840\u8bbe\u7f6e","text":"<p>\u6253\u5f00\u963f\u91cc\u4e91\u955c\u50cf\u4ed3\u5e93</p> <ol> <li>\u521b\u5efa\u547d\u540d\u7a7a\u95f4</li> <li>\u8bbe\u7f6e\u8bbf\u95ee\u51ed\u8bc1</li> </ol> <pre><code># \u6d4b\u8bd5\u4e00\u4e0b\u662f\u5426\u80fd\u767b\u5f55\ndocker login --username=your-name registry.cn-hangzhou.aliyuncs.com\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/#gitdockerfile","title":"\u901a\u8fc7\u5173\u8054\u7684git\u4ed3\u5e93\u7684dockerfile","text":"","tags":["k8s"]},{"location":"devops/k8s/basics/harbor/#githubaction","title":"\u901a\u8fc7\u72ec\u7acbgithub\u4ed3\u5e93\u7684action","text":"<ol> <li>fork nfs-subdir-external-provisioner</li> <li>github forked\u7684 \u4ed3\u5e93 \u6fc0\u6d3baction</li> </ol> <pre><code>git clone https://github.com/your-fork-user/nfs-subdir-external-provisioner\ngit co -b test-br    nfs-subdir-external-provisioner-4.0.18\n# \u4fee\u6539\u90e8\u5206\u6570\u636e\nvim .github/workflows/release.yml\n\non:\n  push:\n    branches:\n      - 'test-br'  #(1)\njobs:\n  docker:\n    runs-on: ubuntu-latest\n    steps:\n      -\n        name: Prepare\n        id: prep\n        name: Login to the container registry\n        if: github.event_name != 'pull_request'\nuses: docker/login-action@v1\n        with:\n          registry: registry.cn-hangzhou.aliyuncs.com #(2)\nusername: ${{ secrets.REGISTRY_USERNAME }} #(3)\npassword: ${{ secrets.REGISTRY_TOKEN }}\n-\n        name: Build and push\n\nwith:\n          platforms: linux/amd64 #(4)\ntags: 'registry.cn-hangzhou.aliyuncs.com/your-namespace/nfs-subdir-external-provisioner:4.0.18' #(5)\ngit ci -a -m 'test'\ngit push -u origin test-br\n</code></pre> <ol> <li>\u6539\u6210\u4f60\u7684\u5206\u652f\u540d</li> <li>\u963f\u91cc\u4e91\u955c\u50cf\u4ed3\u5e93</li> <li>github forked \u5bf9\u5e94\u4ed3\u5e93\u8bbe\u7f6esecret<ol> <li>\u70b9\u51fbNew repository secret\u6309\u94ae\u521b\u5efa</li> <li>name\u8bbe\u7f6e\u4e3a REGISTRY_USERNAME , \u5185\u5bb9secret \u8bbe\u7f6e\u4e3a\u4f60\u7684 \u963f\u91cc\u4e91\u955c\u50cf\u4ed3\u5e93 \u767b\u5f55\u5e10\u53f7</li> <li>name\u8bbe\u7f6e\u4e3a REGISTRY_TOKEN, \u5185\u5bb9secret \u8bbe\u7f6e\u4e3a\u4f60\u7684 \u963f\u91cc\u4e91\u955c\u50cf\u4ed3\u5e93 \u767b\u5f55\u51ed\u8bc1</li> </ol> </li> <li>\u5148\u5f04\u6210\u4e00\u4e2a</li> <li>\u6211\u8fd9\u91cc\u4e3a\u4e86\u6d4b\u8bd5\u5148\u76f4\u63a5\u5199\u6b7b \u963f\u91cc\u4e91\u955c\u50cfurl tag.  \u963f\u91cc\u4e91\u955c\u50cf\u547d\u540d\u7a7a\u95f4\u5fc5\u987b\u5b58\u5728</li> </ol> <p>\u53bb github \u5bf9\u5e94\u9879\u76ee\u7684action \u9875\u9762\u67e5\u770b\u662f\u5426\u6210\u529f, \u6700\u540e\u786e\u8ba4\u963f\u91cc\u4e91\u955c\u50cf</p> <ol> <li> <p>harbor github \u21a9</p> </li> <li> <p>goharbor \u5b98\u7f51 \u21a9</p> </li> <li> <p>harbor\u5b89\u88c5 \u21a9</p> </li> <li> <p>\u963f\u91cc\u4e91\u955c\u50cf\u4ed3\u5e93 \u21a9</p> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/","title":"apiserver","text":"","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#_1","title":"\u4ecb\u7ecd","text":"<p>Tip</p> <ol> <li>\u96c6\u7fa4\u7684HTTP REST API\u63a5\u53e3,\u662f\u96c6\u7fa4\u63a7\u5236\u7684\u5165\u53e3,\u5305\u62ec\u8ba4\u8bc1\u6388\u6743\u3001\u6570\u636e\u6821\u9a8c\u4ee5\u53ca\u96c6\u7fa4\u72b6\u6001\u53d8\u66f4 \u7b49</li> <li>\u5c06k8s \"\u8d44\u6e90\u7ec4/\u8d44\u6e90\u7248\u672c/\u8d44\u6e90\" \u4ee5RESTful\u98ce\u683c\u7684\u5f62\u5f0f\u5bf9\u5916\u66b4\u9732\u5e76\u63d0\u4f9b\u670d\u52a1</li> <li>k8s\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u7ec4\u4ef6\u90fd\u901a\u8fc7kube-apiserver\u7ec4\u4ef6\u64cd\u4f5c\u8d44\u6e90\u5bf9\u8c61,\u4e5f\u901a\u8fc7\u5b83\u8ba9\u5404\u7ec4\u4ef6\u53ef\u4ee5\u901a\u4fe1\u548c\u4ea4\u4e92</li> <li>\u53ea\u6709API Server\u624d\u76f4\u63a5\u64cd\u4f5cetcd</li> </ol> <p></p>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#go-restful","title":"go-restful","text":"<p>github</p> <p></p> <p>\u6982\u5ff5\u4ecb\u7ecd</p> <ol> <li>Container \u76f8\u5f53\u4e8e \u4e00\u4e2ahttp server,\u4e0d\u540c\u7684container\u76d1\u63a7\u4e0d\u540c\u7684\u5730\u5740\u548c\u7aef\u53e3</li> <li>\u6bcf\u4e2acontainer\u53ef\u4ee5\u5305\u542b\u591a\u4e2aWebService,\u76f8\u5f53\u4e8e\u4e00\u7ec4\u4e0d\u540c\u670d\u52a1\u7684\u5206\u7c7b ,\u6bd4\u5982Pod\u4f5c\u4e3a\u4e00\u7ec4,configmap\u4f5c\u4e3a\u4e00\u7ec4</li> <li>\u6bcf\u4e2aWebService\u5305\u542b\u591a\u4e2aRouter(\u8def\u7531),Router\u6839\u636ehttp\u8bf7\u6c42\u7684URL\u8def\u7531\u5230\u5bf9\u5e94\u7684\u5904\u7406\u51fd\u6570(Handler)</li> </ol> <pre><code>package main\nimport (\n// v3 \u652f\u6301go mod\n\"io\"\n\"log\"\n\"net/http\"\nrestful \"github.com/emicklei/go-restful/v3\"\n)\nfunc main() {\nws := new(restful.WebService)\nws.Route(ws.GET(\"/hello\").To(hello))\n// \u8fd9\u91cc\u6709\u4e00\u4e2a\u9ed8\u8ba4\u7684Container,\u8fdb\u884c\u6dfb\u52a0WebService\u7684\u64cd\u4f5c\nrestful.Add(ws)\ngo func() {\nlog.Fatal(http.ListenAndServe(\":8080\", nil))\n}()\ncontainer2 := restful.NewContainer()\nws2 := new(restful.WebService)\nws2.Route(ws2.GET(\"/ping\").To(pong))\ncontainer2.Add(ws2)\nserver := &amp;http.Server{Addr: \":8081\", Handler: container2}\nlog.Fatal(server.ListenAndServe())\n}\nfunc hello(req *restful.Request, resp *restful.Response) {\nio.WriteString(resp, \"world\")\n}\nfunc pong(req *restful.Request, resp *restful.Response) {\nio.WriteString(resp, \"pong\")\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#_2","title":"\u8bbf\u95ee\u63a7\u5236","text":"<p>API Server \u6743\u9650\u7ba1\u7406\u6d41\u7a0b</p> <p></p>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#authentication","title":"\u8ba4\u8bc1 Authentication","text":"<p>Tip</p> <p>\u9488\u5bf9\u8bf7\u6c42\u7684\u8ba4\u8bc1,\u786e\u8ba4\u662f\u5426\u5177\u6709\u8bbf\u95eeKubernetes\u96c6\u7fa4\u7684\u6743\u9650</p> vendor/k8s.io/apiserver/pkg/endpoints/filters/authentication.go<pre><code>func withAuthentication(handler http.Handler, auth authenticator.Request, failed http.Handler, apiAuds authenticator.Audiences, metrics recordMetrics) http.Handler {\nif auth == nil {\nklog.Warning(\"Authentication is disabled\")\nreturn handler\n}\nreturn http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {\nauthenticationStart := time.Now()\nif len(apiAuds) &gt; 0 {\nreq = req.WithContext(authenticator.WithAudiences(req.Context(), apiAuds))\n}\nresp, ok, err := auth.AuthenticateRequest(req)\nauthenticationFinish := time.Now()\ndefer func() {\nmetrics(req.Context(), resp, ok, err, apiAuds, authenticationStart, authenticationFinish)\n}()\nif err != nil || !ok {\nif err != nil {\nklog.ErrorS(err, \"Unable to authenticate the request\")\n}\nfailed.ServeHTTP(w, req)\nreturn\n}\nif !audiencesAreAcceptable(apiAuds, resp.Audiences) {\nerr = fmt.Errorf(\"unable to match the audience: %v , accepted: %v\", resp.Audiences, apiAuds)\nklog.Error(err)\nfailed.ServeHTTP(w, req)\nreturn\n}\n// authorization header is not required anymore in case of a successful authentication.\nreq.Header.Del(\"Authorization\")\nreq = req.WithContext(genericapirequest.WithUser(req.Context(), resp.User))\nhandler.ServeHTTP(w, req)\n})\n}\n</code></pre> staging/src/k8s.io/apiserver/pkg/authentication/request/union/union.go<pre><code>func (authHandler *unionAuthRequestHandler) AuthenticateRequest(req *http.Request) (*authenticator.Response, bool, error) {\nvar errlist []error\nfor _, currAuthRequestHandler := range authHandler.Handlers {\nresp, ok, err := currAuthRequestHandler.AuthenticateRequest(req)\nif err != nil {\nif authHandler.FailOnError {\nreturn resp, ok, err\n}\nerrlist = append(errlist, err)\ncontinue\n}\nif ok {\n// \u6709\u5f88\u591a\u8ba4\u8bc1\u65b9\u5f0f, \u53ea\u8981\u4e00\u4e2aok\u5c31\u884c\nreturn resp, ok, err\n}\n}\nreturn nil, false, utilerrors.NewAggregate(errlist)\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#webhook","title":"\u81ea\u5b9a\u4e49Webhook","text":"<p>Tip</p> <p>\u5f53\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u8ba4\u8bc1\u8bf7\u6c42\u5230\u8fbekube-apiserver \u65f6,kube-apiserver\u56de\u8c03\u8bbe\u7f6e\u7684webhook\u65b9\u6cd5,\u5c06\u9a8c\u8bc1\u4fe1\u606f\u53d1\u9001\u7ed9\u8fdc\u7a0b\u7684Webhook\u670d\u52a1\u5668\u8fdb\u884c\u8ba4\u8bc1,\u7136\u540e\u6839\u636eWebhook\u670d\u52a1\u5668\u8fd4\u56de\u7684\u72b6\u6001\u7801\u6765\u5224\u65ad\u662f\u5426\u8ba4\u8bc1\u6210\u529f</p> \u6e90\u7801 staging/src/k8s.io/apiserver/plugin/pkg/authenticator/token/webhook/webhook.go<pre><code>func (w *WebhookTokenAuthenticator) AuthenticateToken(ctx context.Context, token string) (*authenticator.Response, bool, error) {\nr := &amp;authenticationv1.TokenReview{\nSpec: authenticationv1.TokenReviewSpec{\nToken:     token,\nAudiences: wantAuds,\n},\n}\nresult, statusCode, tokenReviewErr = w.tokenReview.Create(ctx, r, metav1.CreateOptions{})\nr.Status = result.Status\nif !r.Status.Authenticated {\nvar err error\nif len(r.Status.Error) != 0 {\nerr = errors.New(r.Status.Error)\n}\nreturn nil, false, err\n}\nvar extra map[string][]string\nif r.Status.User.Extra != nil {\nextra = map[string][]string{}\nfor k, v := range r.Status.User.Extra {\nextra[k] = v\n}\n}\nreturn &amp;authenticator.Response{\nUser: &amp;user.DefaultInfo{\nName:   r.Status.User.Username,\nUID:    r.Status.User.UID,\nGroups: r.Status.User.Groups,\nExtra:  extra,\n},\nAudiences: auds,\n}, true, nil\n}\n</code></pre> staging/src/k8s.io/apiserver/plugin/pkg/authenticator/token/webhook/webhook.go<pre><code>func (c *tokenReviewV1Client) Create(ctx context.Context, tokenReview *authenticationv1.TokenReview, opts metav1.CreateOptions) (result *authenticationv1.TokenReview, statusCode int, err error) {\nresult = &amp;authenticationv1.TokenReview{}\nrestResult := c.client.Post().\nResource(\"tokenreviews\").\nVersionedParams(&amp;opts, scheme.ParameterCodec).\n// body \u662f authenticationv1.TokenReview \u7ed3\u6784\nBody(tokenReview).\nDo(ctx)\nrestResult.StatusCode(&amp;statusCode)\nerr = restResult.Into(result)\nreturn\n}\n</code></pre> <ol> <li> <p>kubeconfig \u914d\u7f6e\u6587\u4ef6\u6dfb\u52a0\u7528\u6237 ~/.kube/config<pre><code>apiVersion: v1\nclusters:\n- cluster:\ncertificate-authority-data: ...\nserver: https://192.168.66.100:6443\nname: kubernetes\ncontexts:\n- context:\ncluster: kubernetes\nuser: kubernetes-admin\nname: kubernetes-admin@kubernetes\ncurrent-context: kubernetes-admin@kubernetes\nkind: Config\npreferences: {}\nusers:\n- name: kubernetes-admin\nuser:\nclient-certificate-data: ...\nclient-key-data: ...\n## \u6dfb\u52a0\u4e00\u4e2a\u7528\u6237\n- name: xyz\nuser:\ntoken: abc\n</code></pre> <pre><code>k get po\n# \u9ed8\u8ba4\u662f\u7528\u8fd9\u4e2a\u7528\u6237\u53bb\u8bbf\u95ee\u96c6\u7fa4\u7684. \u7528\u8fd9\u4e2a\u7528\u6237\u53bb\u8ba4\u8bc1\nk get po --user=kubernetes-admin\n# \u73b0\u5728\u6211\u4eec\u7528\u6211\u4eec\u521b\u5efa\u7684\u7528\u6237\u53bb\u8bbf\u95ee.\n# \u53d1\u73b0\u65e0\u6cd5\u8bc6\u522b\u4f60\u7684\u7528\u6237\u65f6,\u5c31\u4f1a\u53bb\u770b\u4f60\u662f\u5426\u914d\u7f6e\u4e86webhook,\u6709\u5c31\u5c06\u8fd9\u4e2a\u8f6c\u53d1\u7ed9\u5b83\u8ba4\u8bc1\n# \u8fd9\u91cc\u4f1a\u63d0\u793a\u4f60 You must be logged in to the server (Unauthorized)\nk get po --user=xyz\n</code></pre></p> </li> <li> <p>\u521b\u5efa\u4e00\u4e2awebhook\u914d\u7f6e\u6587\u4ef61 <pre><code># \u76ee\u5f55\u968f\u610f\nmkdir -p /etc/kubernetes/abc\ncd /etc/kubernetes/abc\n# 1. \u5c06\u96c6\u7fa4\u8be6\u7ec6\u4fe1\u606f\u6dfb\u52a0\u5230\u914d\u7f6e\u6587\u4ef6\u4e2d\n# --server= \u6307\u5b9a\u6211\u4eec\u5c06\u6765apiserver \u8f6c\u53d1\u53bb\u8ba4\u8bc1\u7684\u670d\u52a1\u5730\u5740\nkubectl config --kubeconfig=webhook.yaml set-cluster my-test --server=http://192.168.1.100:3000/authenticate\n# 2. \u5c06\u7528\u6237\u8be6\u7ec6\u4fe1\u606f\u6dfb\u52a0\u5230\u914d\u7f6e\u6587\u4ef6\u4e2d\n# \u521b\u5efa\u4e00\u4e2a\u7528\u6237 xyz , \u8fd9\u91cctoken \u6211\u4eec\u968f\u4fbf\u5199\u4e00\u4e2a\nkubectl config --kubeconfig=webhook.yaml set-credentials xyz  --token=abc\n# 3. \u5c06\u4e0a\u4e0b\u6587\u8be6\u7ec6\u4fe1\u606f\u6dfb\u52a0\u5230\u914d\u7f6e\u6587\u4ef6\u4e2d\n# \u6dfb\u52a0\u4e00\u4e2a\u4e0a\u4e0b\u6587, \u5c06\u96c6\u7fa4\u548c\u7528\u6237\u5173\u8054\u8d77\u6765        --namespace=default\nkubectl config --kubeconfig=webhook.yaml set-context my-hook --cluster=my-test --user=xyz\n# 4. \u8bbe\u7f6e\u5f53\u524d\u4e0a\u4e0b\u6587\nkubectl config --kubeconfig=webhook.yaml use-context my-hook\n\n# \u4f1a\u5728\u5f53\u524d\u76ee\u5f55\u751f\u6210\u4e00\u4e2a webhook.yaml\u6587\u4ef6\n</code></pre> webhook.yaml<pre><code>apiVersion: v1\nclusters:\n- cluster:\nserver: http://192.168.1.100:3000/authenticate # \u5bbf\u4e3b\u673a\u7684\u4e0a\u7684\u670d\u52a1\u5730\u5740.\nname: my-test\ncontexts:\n- context:\ncluster: my-test\nuser: xyz\nname: my-hook\ncurrent-context: my-hook\nkind: Config\npreferences: {}\nusers:\n- name: xyz\nuser:\ntoken: abc\n</code></pre></p> </li> <li> <p>\u521b\u5efa\u670d\u52a1,\u7528\u6765\u8ba4\u8bc1 <pre><code>package main\nimport (\n\"encoding/json\"\n\"fmt\"\n\"log\"\n\"net/http\"\nauthentication \"k8s.io/api/authentication/v1beta1\"\n)\nfunc main() {\nhttp.HandleFunc(\"/authenticate\", auth)\nlog.Println(http.ListenAndServe(\":3000\", nil))\n}\nfunc auth(w http.ResponseWriter, r *http.Request) {\ndecoder := json.NewDecoder(r.Body)\nvar tr authentication.TokenReview\nerr := decoder.Decode(&amp;tr)\nif err != nil {\nlog.Println(\"[Error]\", err.Error())\nw.WriteHeader(http.StatusBadRequest)\njson.NewEncoder(w).Encode(map[string]interface{}{\n\"apiVersion\": \"authentication.k8s.io/v1beta1\",\n\"kind\":       \"TokenReview\",\n\"status\": authentication.TokenReviewStatus{\nAuthenticated: false,\n},\n})\nreturn\n}\nfmt.Println(\"tr:::\", tr)\nlog.Print(\"receving request\")\n// \u8fd9\u91cc \u968f\u4fbf \u9a8c\u8bc1. (\u8fd9\u91cc\u5199\u7684\u5f88\u7c97\u7cd9,\u5c31\u4e3a\u4e86\u6d4b\u8bd5,\u4e0d\u7528\u7ba1)\nif tr.Spec.Token == \"abc\" {\nfmt.Println(888)\nw.WriteHeader(http.StatusOK)\ntrs := authentication.TokenReviewStatus{\nAuthenticated: true,\nUser: authentication.UserInfo{\nUsername: \"xyz\",\nUID:      \"xyz\",\n},\n}\njson.NewEncoder(w).Encode(map[string]interface{}{\n\"apiVersion\": \"authentication.k8s.io/v1beta1\",\n\"kind\":       \"TokenReview\",\n\"status\":     trs,\n})\nreturn\n}\nw.WriteHeader(http.StatusUnauthorized)\njson.NewEncoder(w).Encode(map[string]interface{}{\n\"apiVersion\": \"authentication.k8s.io/v1beta1\",\n\"kind\":       \"TokenReview\",\n\"status\": authentication.TokenReviewStatus{\nAuthenticated: false,\n},\n})\nreturn\n}\n</code></pre> \u5728\u4f60\u5bbf\u4e3b\u673a\u4e0a\u8fd0\u884c\u5373\u53ef.<pre><code>go run main.go\n</code></pre></p> </li> <li> <p>\u4fee\u6539kube-apiserver pod\u7684\u914d\u7f6e /etc/kubernetes/manifests/kube-apiserver.yaml<pre><code>...\nspec:\ncontainers:\n- command:\n- kube-apiserver\n- ...\n- --authentication-token-webhook-config-file=/etc/config/apiserver/webhook.yaml\n- --authentication-token-webhook-cache-ttl=2m #\u7528\u6765\u8bbe\u5b9a\u8eab\u4efd\u8ba4\u8bc1\u51b3\u5b9a\u7684\u7f13\u5b58\u65f6\u95f4,\u9ed8\u8ba4\u65f6\u957f\u5c31\u662f2\u5206\u949f\nvolumeMounts:\n- ...\n- mountPath: /etc/config/apiserver\nname: webhook\nreadOnly: true\nvolumes:\n- ...\n- hostPath:\npath: /etc/kubernetes/abc\ntype: DirectoryOrCreate\nname: webhook\n</code></pre></p> </li> <li> <p>\u7b49\u5f85apiserver \u81ea\u52a8\u91cd\u542f \u6216\u8fd9 \u624b\u52a8 <code>systemctl restart kubelet</code></p> </li> <li> <p>\u4f7f\u7528\u7528\u6237<code>xyz</code>\u6765\u8bbf\u95ee \u4f1a\u62a5\u9519,\u63d0\u793aError from server (Forbidden): pods is forbidden: User \"xyz\" cannot list resource \"pods\" in API group \"\" in the namespace \"default\" \u8fd9\u8bf4\u660e\u662fok\u4e86, \u5df2\u7ecf\u8fc7\u4e86\u8ba4\u8bc1, \u5230\u4e86\u9274\u6743\u9636\u6bb5\u4e86,\u63d0\u793a\u6ca1\u6709\u6743\u9650 <pre><code>k get po --user=xyz\n</code></pre></p> </li> </ol> <p>\u8fd9\u91cc\u5148\u5c55\u793a\u6388\u6743\u7528\u6237</p> <pre><code>k create role role-pod-reader --verb=get --verb=list --verb=watch --resource=pods\nk create rolebinding  rb-pod-reader --role=role-pod-reader --user=xyz\nk get po --user=xyz # \u53ef\u4ee5\u8bbf\u95ee\u4e86..\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#authorization","title":"\u9274\u6743 Authorization","text":"<p>Tip</p> <p>\u9488\u5bf9\u8d44\u6e90\u7684\u6388\u6743,\u786e\u8ba4\u662f\u5426\u5bf9\u8d44\u6e90\u5177\u6709\u76f8\u5173\u6743\u9650</p>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#rbac","title":"rbac","text":"<p>Tip</p> <p>\u7ed9A\u8001\u5e08\u6388\u6743\u8fdb\u529e\u516c\u5ba4\u7684\u6743\u9650, \u7ed9B\u8001\u5e08\u6388\u6743.. \u7ed9C\u5b66\u751f\u6388\u6743\u8fdb\u56fe\u4e66\u9986\u7684\u6743\u9650, \u8fd8\u6709\u597d\u591a\u5b66\u751f\u8001\u5e08 \u90fd\u8fd9\u6837\u5f04.. \u5f88\u9ebb\u70e6. \u5f88\u663e\u7136\u6211\u4eec\u660e\u767d\u4e00\u4e2a\u9053\u7406 \u662f\u5b66\u751f\u5c31\u80fd\u8fdb\u56fe\u4e66\u9986, \u5b66\u751f\u662f\u4e2a\u89d2\u8272,C\u662f\u4e2a\u4f53,\u53ea\u8981\u786e\u8ba4C\u662f\u5b66\u751f\u5373\u53ef \u8fd8\u6709\u4e00\u79cd\u60c5\u51b5, \u4e00\u73ed\u7684\u8001\u5e08\u548c\u4e8c\u73ed\u7684\u8001\u5e08 \u6bd4\u5982\u5bf9\u67d0\u4e2a\u573a\u6240\u5177\u6709\u4e0d\u540c\u7684\u6743\u9650,\u53ef\u4ee5\u5bf9\u4e00\u7ec4\u4eba\u8fdb\u884c\u6388\u6743.</p> <p></p>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#role","title":"role","text":"<p>Tip</p> <p>role\u89d2\u8272 (\u53ef\u4ee5\u770b\u6210\u662f\u4e00\u5768\u6743\u9650\u7684\u96c6\u5408) \u662f\u6709\u547d\u540d\u7a7a\u95f4\u7684, \u4e0d\u6307\u5b9a\u9ed8\u8ba4\u662fdefault, \u5b83\u6240\u62e5\u6709\u7684\u6743\u9650 \u4e5f\u53ea\u9488\u5bf9\u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u8d44\u6e90</p> \u521b\u5efa\u4e00\u4e2a\u89d2\u8272, \u8d4b\u4e88\u5b83\u8bbf\u95eetest\u547d\u540d\u7a7a\u95f4\u4e0b\u7684pod\u7684\u6743\u9650<pre><code>k create role role-pod-reader \\\n--verb=get \\\n--verb=list \\\n--verb=watch \\\n--resource=pods \\\n--resource=pods/logs \\\n-n test\nk get role -n test role-pod-reader -o yaml\n</code></pre> role-pod-reader.yaml<pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\nname: role-pod-reader\nnamespace: test\nrules:\n- apiGroups:\n- \"\"\nresources:\n- pods\nverbs:\n- get\n- list\n- watch\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#clusterrole","title":"clusterrole","text":"<p>Tip</p> <p>clusterrole \u662f\u6ca1\u6709\u547d\u540d\u7a7a\u95f4,\u8fd9\u4e2a\u89d2\u8272\u6240\u62e5\u6709\u7684\u6743\u9650\u662f\u9488\u5bf9\u96c6\u7fa4.</p> create\u805a\u5408ClusterRole\u9ed8\u8ba4\u7684\u4e00\u4e9bclusterrole <pre><code># \u770b\u4e0badmin\u7684\u6743\u9650\nk get clusterrole admin  -o yaml\nk create clusterrole clusterrole-pod-reader --verb=get,list,watch --resource=pods\n</code></pre> <p>Tip</p> <p>\u5c06\u82e5\u5e72 ClusterRole \u805a\u5408\uff08Aggregate\uff09 \u8d77\u6765\uff0c\u5f62\u6210\u4e00\u4e2a\u590d\u5408\u7684 ClusterRole\u3002 \u4f5c\u4e3a\u96c6\u7fa4\u63a7\u5236\u9762\u7684\u4e00\u90e8\u5206\uff0c\u63a7\u5236\u5668\u4f1a\u76d1\u89c6\u5e26\u6709 aggregationRule \u7684 ClusterRole \u5bf9\u8c61\u96c6\u5408\u3002aggregationRule \u4e3a\u63a7\u5236\u5668\u5b9a\u4e49\u4e00\u4e2a\u6807\u7b7e\u9009\u62e9\u7b97\u7b26\u4f9b\u540e\u8005\u5339\u914d\u5e94\u8be5\u7ec4\u5408\u5230\u5f53\u524d ClusterRole \u7684 roles \u5b57\u6bb5\u4e2d\u7684 ClusterRole \u5bf9\u8c61</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\nname: monitoring\naggregationRule:\nclusterRoleSelectors:\n- matchLabels:\nrbac.example.com/aggregate-to-monitoring: \"true\"\nrules: [] # \u63a7\u5236\u9762\u81ea\u52a8\u586b\u5145\u8fd9\u91cc\u7684\u89c4\u5219\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\nname: monitoring-endpoints\nlabels:\nrbac.example.com/aggregate-to-monitoring: \"true\"\n# \u5f53\u4f60\u521b\u5efa \"monitoring-endpoints\" ClusterRole \u65f6\uff0c\n# \u4e0b\u9762\u7684\u89c4\u5219\u4f1a\u88ab\u6dfb\u52a0\u5230 \"monitoring\" ClusterRole \u4e2d\nrules:\n- apiGroups: [\"\"]\nresources: [\"services\", \"endpointslices\", \"pods\"]\nverbs: [\"get\", \"list\", \"watch\"]\n</code></pre> <p>Tip</p> <p>\u53ef\u4ee5\u7ed1\u5b9aview \u7ed9 \u5f00\u53d1\u8005</p> <pre><code>#\u597d\u591a\u9ed8\u8ba4\u7684,\u6211\u4eec\u53ef\u4ee5\u770b\u770badmin\u8fd9\u4e2aclusterrole\nk get clusterrole\n# \u5173\u6ce8\u4e00\u4e0b\u8fd94\u4e2aclusterrole \u90fd\u662f\u96c6\u7fa4\u7684role\ncluster-admin\n    admin    # \u6743\u9650\u7a0d\u5fae\u6bd4\u4e0a\u9762\u7684\u5c0f\u70b9\nedit\n    view   #\u89c4\u5b9a\u4e86\u88ab\u4f5c\u7528\u8005\u53ea\u6709 Kubernetes API \u7684\u53ea\u8bfb\u6743\u9650\n#\u53ef\u4ee5\u770b\u770b\u6709\u54ea\u4e9b\u53ef\u4ee5\u5b9a\u4e49\u7684\u4e1c\u897f,\u53ef\u4ee5\u5b66\u5b66\nk get clusterrole admin \u00a0# \u6211\u4eec\u9ed8\u8ba4\u7684\nk get clusterrolebinding cluster-admin -o yaml\nk get clusterrole cluster-admin -o yaml\n    rules:\n    - apiGroups:\n        - '*'\nresources:\n        - '*'\nverbs:\n        - '*'\n- nonResourceURLs:\n        - '*'\nverbs:\n        - '*'\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#rolebinding","title":"rolebinding","text":"<p>Tip</p> <p>\u901a\u8fc7\u8fd9\u4e2a\u5c06\u89d2\u8272\u548c\u4e3b\u4f53(User,Group,ServiceAccount) \u8fdb\u884c\u7ed1\u5b9a. \u5c31\u662f\u8d4b\u4e88\u8fd9\u4e9b\u4e3b\u4f53\u8fd9\u4e48\u4e00\u5768\u6743\u9650(\u89d2\u8272) rolebinding \u662f\u6709\u547d\u540d\u7a7a\u95f4\u7684, \u771f\u6b63\u7684\u6743\u9650\u8303\u56f4\u662f\u7531\u8fd9\u4e2arolebinding \u547d\u540d\u7a7a\u95f4\u51b3\u5b9a\u7684.</p> \u7ed1\u5b9arole\u7ed1\u5b9aclusterrole <pre><code># -o yaml --dry-run=client \u522b\u5fd8\u8bb0\u4f7f\u7528\u8fd9\u4e2a\u770byaml\u6587\u4ef6\n# --user=admin --user=xyz \u6307\u5b9a\u591a\u4e2a \u7528\u6237, \u7528\u6237\u540d\u662f\u533a\u5206\u5927\u5c0f\u5199\u7684\n# \u53ea\u80fd\u7ed1\u5b9a\u4e00\u4e2arole   --role=role1 --role=role2  \u4f1a\u4f7f\u7528\u540e\u9762\u7684role2\nk create rolebinding  rb-pod-reader --role=role-pod-reader --user=xyz -n test\nk get rolebinding  rb-pod-reader -o yaml\nk get po --user=xyz # \u62a5\u9519\nk get po -n test --user=xyz # ok\n# \u9996\u5148 \u6307\u5b9a\u7684role \u5728 test \u547d\u540d\u7a7a\u95f4\u4e0b\u4e0d\u5b58\u5728\u662f\u4e0d\u4f1a\u62a5\u9519\u7684.\n# \u4e00\u5b9a\u8981\u6ce8\u610f\u547d\u540d\u7a7a\u95f4,\u8fd9\u91cckube-system \u547d\u540d\u7a7a\u95f4\u4e0b\u6ca1\u6709 role-pod-reader \u8fd9\u4e2a\u89d2\u8272\nk create rolebinding  rb-pod-reader --role=role-pod-reader --user=xyz  -n kube-system\nks get po --user=xyz # \u62a5\u9519 ,\u6ca1\u6709\u6743\u9650\n# \u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u521b\u5efa\u8fd9\u4e2a role\nk create role role-pod-reader \\\n--verb=get \\\n--verb=watch \\\n--verb=list \\\n--resource=pods \\\n-n kube-system\nks get po # ok\n</code></pre> -n test rb-pod-reader.yaml<pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\nname: rb-pod-reader\nnamespace: test\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: Role\nname: role-pod-reader\nsubjects:\n- apiGroup: rbac.authorization.k8s.io\nkind: User\nname: xyz\n</code></pre> <p>\u7ed1\u5b9aclusterrole\u8fd8\u662f\u53ea\u5bf9\u6307\u5b9a\u7684\u547d\u540d\u7a7a\u95f4\u4e0b\u8d44\u6e90\u6709\u6743\u9650,\u90a3\u4e48\u6709\u4ec0\u4e48\u7528\u5462?</p> <p>\u5047\u8bbe\u6211\u4eec\u9700\u8981\u572810\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b,10\u4e2a\u7528\u6237\u90fd\u7ed1\u5b9a\u4e00\u4e2a\u89d2\u8272,\u8fd9\u6837\u7684\u657410\u4e2a,\u4f60\u9700\u8981\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u521b\u5efa\u6743\u9650\u4e00\u6837\u7684role,\u73b0\u5728\u4f60\u53ea\u9700\u8981\u521b\u5efa\u4e00\u4e2aclusterrole\u6765\u8fdb\u884crolebinding\u5c31\u884c\u4e86.</p> <pre><code># k create clusterrole clusterrole-pod-reader --verb=get,list,watch --resource=pods\n# xyz \u53ea\u5bf9 test \u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u8d44\u6e90 \u62e5\u6709clusterrole-pod-reader\u91cc\u8bbe\u7f6e\u7684\u6743\u9650\nk create rolebinding  rb-clusterrole-pod-reader \\\n--clusterrole=clusterrole-pod-reader \\\n--user=xyz  \\\n-n test\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#clusterrolebinding","title":"clusterrolebinding","text":"<p>Tip</p> <p>\u5bf9\u96c6\u7fa4\u91cc\u7684\u8d44\u6e90\u751f\u6548</p> <pre><code>k create clusterrolebinding crb-xyz-clusterrole-pod-reader \\\n--clusterrole=clusterrole-pod-reader \\\n--user=xyz\n# \u7528\u6237xyz\u53ef\u4ee5list \u6240\u6709\u547d\u540d\u7a7a\u95f4\u7684pod\n</code></pre> crb-xyz-clusterrole-pod-reader.yaml<pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\nname: crb-clusterrole-pod-reader\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: ClusterRole\nname: clusterrole-pod-reader\nsubjects:\n- apiGroup: rbac.authorization.k8s.io\nkind: User\nname: xyz\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#user","title":"user","text":"<ol> <li>\u666e\u901a\u7528\u6237, \u4e0d\u53d7k8s\u7ba1\u7406, \u4e0d\u662fk8s\u6765\u6dfb\u52a0\u7528\u6237, \u524d\u9762\u6211\u4eec\u505a\u8ba4\u8bc1\u7684\u65f6\u5019\u5c31\u5916\u90e8\u76f4\u63a5\u6dfb\u52a0\u4e86\u4e00\u4e2a\u7528\u6237xyz</li> <li>\u6240\u6709\u7684\u5bf9apiserver \u7684\u8bf7\u6c42\u90fd\u9700\u8981\u7528\u6237(user \u6216 serviceaccount)</li> <li>\u65e2\u7136\u4e0d\u53d7k8s\u7ba1\u7406,\u90a3\u4e48\u5c31\u6ca1\u6709\u547d\u540d\u7a7a\u95f4\u7684\u8bf4\u6cd5, \u540d\u5b57\u5fc5\u987b\u5168\u5c40\u552f\u4e00</li> </ol>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#serviceaccountsa","title":"serviceaccount(sa)","text":"<p>\u5b98\u65b9\u6587\u6863</p> <ol> <li>\u670d\u52a1\u8d26\u6237</li> <li>k8s\u6765\u7ba1\u7406(\u521b\u5efa\u5220\u9664\u7b49), \u6240\u4ee5\u6709\u547d\u540d\u7a7a\u95f4, \u4e0d\u540c\u7684\u547d\u540d\u7a7a\u95f4\u4e0b\u53ef\u4ee5\u7528\u76f8\u540c\u7684sa\u540d</li> </ol> <pre><code># \u6bcf\u4e2ans\u4e0b\u90fd\u6709\u4e00\u4e2a\u9ed8\u8ba4\u7684default sa, \u6743\u9650\u5341\u5206\u6709\u9650, \u5982\u679c\u9700\u8981\u66f4\u591a\u6743\u9650 \u9700\u8981\u7ed1\u5b9a\u89d2\u8272\n# \u6bcf\u4e2asa \u90fd\u5bf9\u5e94\u4e00\u4e2asecret \u7528\u6765\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\nk get sa\n    NAME          SECRETS   AGE\n    default       1         31d\n\nk get sa default -o yaml\n    apiVersion: v1\n    kind: ServiceAccount\n    metadata:\n      creationTimestamp: \"2023-06-28T07:29:23Z\"\nname: default\n      namespace: default\n      resourceVersion: \"429\"\nuid: ed1b8034-f70d-4db6-9fdd-14e132bf9258\n    secrets: # \u6bcf\u4e2asa \u5bf9\u5e94\u4e00\u4e2a secret, \u53ef\u4ee5k create sa sa-test \u521b\u5efa\u770b\u770b\n- name: default-token-6tqd5\n# \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cKubernetes \u63a7\u5236\u5e73\u9762\uff08\u7279\u522b\u662f ServiceAccount \u51c6\u5165\u63a7\u5236\u5668\uff09 \u6dfb\u52a0\u4e00\u4e2a\u6295\u5c04\u5377\u5230 Pod\uff0c \u6b64\u5377\u5305\u62ec\u4e86\u8bbf\u95ee Kubernetes API \u7684\u4ee4\u724c\nk get po nginx -o yaml\n# \u6bcf\u4e2a ns\u4e0b\u90fd\u6709 \u4e00\u4e2aconfigmap kube-root-ca.crt \u6302\u8f7d\u5230pod\u4e2d\u53bb.\nk get cm\n</code></pre> <p>\u7ed9sa\u7ed1\u5b9a\u89d2\u8272<pre><code>k create rolebinding  rb-default-clusterrole-view \\\n--clusterrole=view \\\n--serviceaccount=default:default #\u547d\u540d\u7a7a\u95f4:sa\u540d\u5b57\n</code></pre> rb-default-clusterrole-view.yaml<pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\nname: rb-default-clusterrole-view\nnamespace: default\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: ClusterRole\nname: view\nsubjects:\n- kind: ServiceAccount\nname: default\nnamespace: default\n</code></pre></p>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#group","title":"group","text":"<pre><code>k get rolebinding  -A -o wide\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#admission","title":"\u51c6\u5165 Admission","text":"<p>Tip</p> <p>\u5bf9\u8c61\u88ab\u6301\u4e45\u5316\u4e4b\u524d,\u62e6\u622akube-apiserver\u7684\u8bf7\u6c42,\u62e6\u622a\u540e\u7684\u8bf7\u6c42\u8fdb\u5165\u51c6\u5165\u63a7\u5236\u5668\u4e2d\u5904\u7406,\u5bf9\u8bf7\u6c42\u7684\u8d44\u6e90\u5bf9\u8c61\u8fdb\u884c\u81ea\u5b9a\u4e49 \u524d\u9762\u63d0\u5230\u7684\u521b\u5efa\u7684pod\u9ed8\u8ba4\u4f1a\u8bbe\u7f6e\u4e00\u4e2a\u6295\u5c04\u5377, \u5c31\u662f\u51c6\u5165\u63a7\u5236\u5668\u505a\u7684. \u51c6\u5165\u63a7\u5236\u652f\u6301\u540c\u65f6\u5f00\u542f\u591a\u4e2a\u63d2\u4ef6\uff0c\u5b83\u4eec\u4f9d\u6b21\u8c03\u7528\uff0c\u53ea\u6709\u5168\u90e8\u63d2\u4ef6\u90fd\u901a\u8fc7\u7684\u8bf7\u6c42\u624d\u53ef\u4ee5\u653e\u8fc7\u8fdb\u5165\u7cfb\u7edf</p> <pre><code># \u67e5\u770b\u9ed8\u8ba4\u7684\u51c6\u5165\u63d2\u4ef6\nks exec kube-apiserver-master1 -- kube-apiserver --help|grep enable-admission-plugins\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#webhook_1","title":"\u51c6\u5165 Webhook","text":"<p>\u51c6\u5165 Webhook</p> <p>Tip</p> <ol> <li>\u9664\u9ed8\u8ba4\u7684\u51c6\u5165\u63a7\u5236\u63d2\u4ef6\u4ee5\u5916, k8s\u9884\u7559\u4e86\u51c6\u5165\u63a7\u5236\u63d2\u4ef6\u7684\u6269\u5c55\u70b9\uff0c\u7528\u6237\u53ef\u81ea\u5b9a\u4e49\u51c6\u5165\u63a7\u5236 \u63d2\u4ef6\u5b9e\u73b0\u81ea\u5b9a\u4e49\u51c6\u5165\u529f\u80fd</li> <li>\u51c6\u5165 Webhook \u662f\u4e00\u79cd\u7528\u4e8e\u63a5\u6536\u51c6\u5165\u8bf7\u6c42\u5e76\u5bf9\u5176\u8fdb\u884c\u5904\u7406\u7684 HTTP \u56de\u8c03\u673a\u5236\u3002</li> <li>\u53ef\u4ee5\u5b9a\u4e49\u4e24\u79cd\u7c7b\u578b\u7684\u51c6\u5165 webhook\uff0c\u5373 \u9a8c\u8bc1\u6027\u8d28\u7684\u51c6\u5165 Webhook(ValidatingWebhookConfiguration) \u548c \u4fee\u6539\u6027\u8d28\u7684\u51c6\u5165 Webhook (MutatingWebhookConfiguration)\u3002</li> <li>\u4fee\u6539\u6027\u8d28\u7684\u51c6\u5165 Webhook \u4f1a\u5148\u88ab\u8c03\u7528\u3002\u5b83\u4eec\u53ef\u4ee5\u66f4\u6539\u53d1\u9001\u5230 API \u670d\u52a1\u5668\u7684\u5bf9\u8c61\u4ee5\u6267\u884c\u81ea\u5b9a\u4e49\u7684\u8bbe\u7f6e\u9ed8\u8ba4\u503c\u64cd\u4f5c</li> </ol> <p>\u6211\u4eec\u901a\u8fc7\u521b\u5efa\u4e00\u4e2aMutatingWebhookConfiguration,\u91cc\u9762\u6307\u5b9a\u4e00\u4e2aservice\u670d\u52a1,\u8fd9\u4e2aservice\u5c31\u662fwebhook \u670d\u52a1,\u6211\u8fd9\u4e2aservice \u662f\u6307\u5411\u5916\u90e8\u7684\u5e94\u7528,\u975epod</p> \u8bc1\u4e66\u7f16\u5199webhook\u670d\u52a1\u521b\u5efaservice\u521b\u5efaMutatingWebhookConfiguration\u9a8c\u8bc1 <pre><code># \u76f4\u63a5\u751f\u6210 \u6839\u79c1\u94a5 \u548c \u6839\u8bc1\u4e66\n#   -nodes \u8868\u793a no des \u4e0d\u52a0\u5bc6\u7684\u610f\u601d\n#   openssl \u7684\u547d\u4ee4\u771f\u7684... ,  \u5efa\u8bae \u7528\u903b\u8f91\u4e0a \u4e00\u6b65\u4e00\u6b65\u6765, \u5148\u79c1\u94a5,\u518d\u751f\u6210\u81ea\u7b7e\u540d \u8fd9\u6837\u6765.\n#    \u8fd9\u91cc \u6211\u4e5f\u8bb0\u5f55\u4e00\u4e0b, \u4ee5\u514d\u770b\u5230\u8fd9\u6837\u7684\u4e1c\u897f \u89c9\u5f97\u964c\u751f.\nopenssl req -nodes -x509 -new -keyout ca.key -subj \"/CN=x.com\" -days 5000 -out ca.crt\n\nopenssl genrsa -out server.key 2048\ncat &gt;server.conf&lt;&lt;EOF\n[req]\nreq_extensions = v3_req\ndistinguished_name = req_distinguished_name\n# \u8868\u793a \u751f\u6210csr\u65f6,\u5c06\u76f4\u63a5\u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bfb\u53d6\u5173\u4e8e\u7533\u8bf7\u8005\u5b57\u6bb5\u7684\u4fe1\u606f,\u4e0d\u4f1a\u63d0\u793a\u8f93\u5165\n# req_distinguished_name \u91cc\u7684\u5b57\u6bb5\nprompt = no\n[req_distinguished_name]\n# CN\u662f \u5fc5\u586b\u7684, \u5176\u4ed6\u4e5f\u53ef\u4ee5\u5199, \u4ec0\u4e48\u56fd\u5bb6 \u90e8\u95e8..\nCN = svc-mutate.default.svc\n[ v3_req ]\nbasicConstraints = CA:FALSE\nkeyUsage = nonRepudiation, digitalSignature, keyEncipherment\nextendedKeyUsage = clientAuth, serverAuth\nsubjectAltName = @alt_names\n[alt_names]\nDNS.1 = svc-mutate.default.svc  # svc\nIP.1 = 10.98.140.200  # svc\u7684cluster ip\nEOF\n# -subj \"/CN=svc-mutate.default.svc\" \u53ef\u4ee5\u4e0d\u7528\u5199\nopenssl req -new -key server.key  -out server.csr -config server.conf\nopenssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial  -in server.csr -out server.crt -extensions v3_req -extfile server.conf\n</code></pre> <ol> <li>\u76ee\u5f55\u7ed3\u6784</li> </ol> <p><pre><code># go \u4ee3\u7801\ntree\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 main.go\n\u2514\u2500\u2500 pki\n    \u251c\u2500\u2500 server.crt # \u524d\u9762\u751f\u6210\u7684\n\u251c\u2500\u2500 server.csr\n    \u2514\u2500\u2500 server.key # \u524d\u9762\u751f\u6210\u7684\n</code></pre> 2. go\u4ee3\u7801</p> <p>main.go \u4e0a\u9762\u90a3\u4e2a\u8bd5\u8fc7\u6548\u679c\u518d\u6765\u7528\u8fd9\u4e2a\u5b9e\u9645\u793a\u4f8b,\u53c2\u8003\u5b98\u65b9<pre><code>package main\nimport (\n\"crypto/tls\"\n\"encoding/json\"\n\"fmt\"\n\"io/ioutil\"\n\"log\"\n\"net/http\"\nv1 \"k8s.io/api/admission/v1\"\n\"k8s.io/api/admission/v1beta1\"\nmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n\"k8s.io/apimachinery/pkg/runtime\"\n\"k8s.io/apimachinery/pkg/runtime/serializer\"\n\"k8s.io/klog/v2\"\n)\ntype Config struct {\nCertFile string\nKeyFile  string\n}\nfunc configTLS(config Config) *tls.Config {\nsCert, err := tls.LoadX509KeyPair(config.CertFile, config.KeyFile)\nif err != nil {\nklog.Fatal(err)\n}\nreturn &amp;tls.Config{\nCertificates: []tls.Certificate{sCert},\n// ClientAuth:   tls.RequireAndVerifyClientCert,\n}\n}\nfunc main() {\nconfig := Config{\nCertFile: \"./pki/server.crt\",\nKeyFile:  \"./pki/server.key\",\n}\nhttp.HandleFunc(\"/add-label\", serveAddLabel)\nserver := &amp;http.Server{\nAddr:      fmt.Sprintf(\":%d\", 443),\nTLSConfig: configTLS(config),\n}\nlog.Println(server.ListenAndServeTLS(\"\", \"\"))\n}\nfunc serveAddLabel(w http.ResponseWriter, r *http.Request) {\nadmit := admitHandler{\nv1beta1: delegateV1beta1AdmitToV1(addLabel),\nv1:      addLabel,\n}\nvar body []byte\nif r.Body != nil {\nif data, err := ioutil.ReadAll(r.Body); err == nil {\nbody = data\n}\n}\n// \u6253\u5370\u8bf7\u6c42\u7684\u6570\u636e\nfmt.Println(\"handling request:\", string(body))\n// return\n// verify the content type is accurate\ncontentType := r.Header.Get(\"Content-Type\")\nif contentType != \"application/json\" {\nklog.Errorf(\"contentType=%s, expect application/json\", contentType)\nreturn\n}\nvar admissionReviewReq v1beta1.AdmissionReview\ndeserializer := codecs.UniversalDeserializer()\n// \u9700\u8981 \u6307\u5b9a admissionReviewReq , \u5426\u5219\u62a5\u9519, \u5b98\u65b9\u4f8b\u5b50 \u8fd9\u91cc\u662f body, nil, nil,\u4f1a\u62a5\u9519\nobj, gvk, err := deserializer.Decode(body, nil, &amp;admissionReviewReq)\nif err != nil {\nmsg := fmt.Sprintf(\"Request could not be decoded: %v\", err)\nklog.Error(msg)\nhttp.Error(w, msg, http.StatusBadRequest)\nreturn\n}\nvar responseObj runtime.Object\nswitch *gvk {\ncase v1beta1.SchemeGroupVersion.WithKind(\"AdmissionReview\"):\nrequestedAdmissionReview, ok := obj.(*v1beta1.AdmissionReview)\nif !ok {\nklog.Errorf(\"Expected v1beta1.AdmissionReview but got: %T\", obj)\nreturn\n}\nresponseAdmissionReview := &amp;v1beta1.AdmissionReview{}\nresponseAdmissionReview.SetGroupVersionKind(*gvk)\nresponseAdmissionReview.Response = admit.v1beta1(*requestedAdmissionReview)\nresponseAdmissionReview.Response.UID = requestedAdmissionReview.Request.UID\nresponseObj = responseAdmissionReview\ncase v1.SchemeGroupVersion.WithKind(\"AdmissionReview\"):\nrequestedAdmissionReview, ok := obj.(*v1.AdmissionReview)\nif !ok {\nklog.Errorf(\"Expected v1.AdmissionReview but got: %T\", obj)\nreturn\n}\nresponseAdmissionReview := &amp;v1.AdmissionReview{}\nresponseAdmissionReview.SetGroupVersionKind(*gvk)\nresponseAdmissionReview.Response = admit.v1(*requestedAdmissionReview)\nresponseAdmissionReview.Response.UID = requestedAdmissionReview.Request.UID\nresponseObj = responseAdmissionReview\ndefault:\nmsg := fmt.Sprintf(\"Unsupported group version kind: %v\", gvk)\nklog.Error(msg)\nhttp.Error(w, msg, http.StatusBadRequest)\nreturn\n}\nklog.V(2).Info(fmt.Sprintf(\"sending response: %v\", responseObj))\nrespBytes, err := json.Marshal(responseObj)\nif err != nil {\nklog.Error(err)\nhttp.Error(w, err.Error(), http.StatusInternalServerError)\nreturn\n}\nw.Header().Set(\"Content-Type\", \"application/json\")\nif _, err := w.Write(respBytes); err != nil {\nklog.Error(err)\n}\n}\nconst (\naddFirstLabelPatch string = `[\n         { \"op\": \"add\", \"path\": \"/metadata/labels\", \"value\": {\"added-label\": \"yes\"}}\n     ]`\naddAdditionalLabelPatch string = `[\n         { \"op\": \"add\", \"path\": \"/metadata/labels/added-label\", \"value\": \"yes\" }\n     ]`\nupdateLabelPatch string = `[\n         { \"op\": \"replace\", \"path\": \"/metadata/labels/added-label\", \"value\": \"yes\" }\n     ]`\n)\nfunc addLabel(ar v1.AdmissionReview) *v1.AdmissionResponse {\nklog.V(2).Info(\"calling add-label\")\nobj := struct {\nmetav1.ObjectMeta `json:\"metadata,omitempty\"`\n}{}\nraw := ar.Request.Object.Raw\nerr := json.Unmarshal(raw, &amp;obj)\nif err != nil {\nklog.Error(err)\nreturn toV1AdmissionResponse(err)\n}\nreviewResponse := v1.AdmissionResponse{}\nreviewResponse.Allowed = true\npt := v1.PatchTypeJSONPatch\nlabelValue, hasLabel := obj.ObjectMeta.Labels[\"added-label\"]\nswitch {\ncase len(obj.ObjectMeta.Labels) == 0:\nreviewResponse.Patch = []byte(addFirstLabelPatch)\nreviewResponse.PatchType = &amp;pt\ncase !hasLabel:\nreviewResponse.Patch = []byte(addAdditionalLabelPatch)\nreviewResponse.PatchType = &amp;pt\ncase labelValue != \"yes\":\nreviewResponse.Patch = []byte(updateLabelPatch)\nreviewResponse.PatchType = &amp;pt\ndefault:\n// already set\n}\nreturn &amp;reviewResponse\n}\ntype admitv1beta1Func func(v1beta1.AdmissionReview) *v1beta1.AdmissionResponse\ntype admitv1Func func(v1.AdmissionReview) *v1.AdmissionResponse\nvar scheme = runtime.NewScheme()\nvar codecs = serializer.NewCodecFactory(scheme)\nfunc delegateV1beta1AdmitToV1(f admitv1Func) admitv1beta1Func {\nreturn func(review v1beta1.AdmissionReview) *v1beta1.AdmissionResponse {\nin := v1.AdmissionReview{Request: convertAdmissionRequestToV1(review.Request)}\nout := f(in)\nreturn convertAdmissionResponseToV1beta1(out)\n}\n}\ntype admitHandler struct {\nv1beta1 admitv1beta1Func\nv1      admitv1Func\n}\nfunc convertAdmissionRequestToV1(r *v1beta1.AdmissionRequest) *v1.AdmissionRequest {\nreturn &amp;v1.AdmissionRequest{\nKind:               r.Kind,\nNamespace:          r.Namespace,\nName:               r.Name,\nObject:             r.Object,\nResource:           r.Resource,\nOperation:          v1.Operation(r.Operation),\nUID:                r.UID,\nDryRun:             r.DryRun,\nOldObject:          r.OldObject,\nOptions:            r.Options,\nRequestKind:        r.RequestKind,\nRequestResource:    r.RequestResource,\nRequestSubResource: r.RequestSubResource,\nSubResource:        r.SubResource,\nUserInfo:           r.UserInfo,\n}\n}\nfunc convertAdmissionRequestToV1beta1(r *v1.AdmissionRequest) *v1beta1.AdmissionRequest {\nreturn &amp;v1beta1.AdmissionRequest{\nKind:               r.Kind,\nNamespace:          r.Namespace,\nName:               r.Name,\nObject:             r.Object,\nResource:           r.Resource,\nOperation:          v1beta1.Operation(r.Operation),\nUID:                r.UID,\nDryRun:             r.DryRun,\nOldObject:          r.OldObject,\nOptions:            r.Options,\nRequestKind:        r.RequestKind,\nRequestResource:    r.RequestResource,\nRequestSubResource: r.RequestSubResource,\nSubResource:        r.SubResource,\nUserInfo:           r.UserInfo,\n}\n}\nfunc convertAdmissionResponseToV1(r *v1beta1.AdmissionResponse) *v1.AdmissionResponse {\nvar pt *v1.PatchType\nif r.PatchType != nil {\nt := v1.PatchType(*r.PatchType)\npt = &amp;t\n}\nreturn &amp;v1.AdmissionResponse{\nUID:              r.UID,\nAllowed:          r.Allowed,\nAuditAnnotations: r.AuditAnnotations,\nPatch:            r.Patch,\nPatchType:        pt,\nResult:           r.Result,\nWarnings:         r.Warnings,\n}\n}\nfunc convertAdmissionResponseToV1beta1(r *v1.AdmissionResponse) *v1beta1.AdmissionResponse {\nvar pt *v1beta1.PatchType\nif r.PatchType != nil {\nt := v1beta1.PatchType(*r.PatchType)\npt = &amp;t\n}\nreturn &amp;v1beta1.AdmissionResponse{\nUID:              r.UID,\nAllowed:          r.Allowed,\nAuditAnnotations: r.AuditAnnotations,\nPatch:            r.Patch,\nPatchType:        pt,\nResult:           r.Result,\nWarnings:         r.Warnings,\n}\n}\nfunc toV1AdmissionResponse(err error) *v1.AdmissionResponse {\nreturn &amp;v1.AdmissionResponse{\nResult: &amp;metav1.Status{\nMessage: err.Error(),\n},\n}\n}\n</code></pre> 3. \u542f\u52a8\u670d\u52a1</p> <p><pre><code># ip\u5730\u5740\u4e3a192.168.1.104\ngo run main.go\n</code></pre> 4. curl\u7b80\u5355\u9a8c\u8bc1</p> <p>\u5173\u4e8e\u8bc1\u4e66</p> <p>ca\u8bc1\u4e66\u662f\u4e3a\u4e86\u5b89\u5168\u62ff\u5230 webhook\u670d\u52a1 \u7684\u516c\u94a5,\u5177\u4f53\u53c2\u8003https</p> <pre><code>#  \u5c06\u6839\u8bc1\u4e66 ca.crt \u590d\u5236\u5230 \u4efb\u4f55\u53ef\u4ee5\u8bbf\u95ee192.168.1.104 \u7684\u673a\u5668\u4e0a\n#  \u7528curl\u6765\u770b\u662f\u5426OK\ncurl --cacert ca.crt \\\n--resolve svc-mutate.default.svc:443:192.168.1.104 \\\nhttps://svc-mutate.default.svc/add-label\n</code></pre> service \u6307\u5b9a\u5916\u90e8\u5e94\u7528,\u6211\u4eec\u7684webhook\u670d\u52a1\u5728\u5916\u90e8<pre><code>apiVersion: v1\nkind: Service\nmetadata:\nlabels:\napp: svc-mutate\nname: svc-mutate\nspec:\nports:\n- name: abc\nport: 443\nprotocol: TCP\ntargetPort: 443\ntype: ClusterIP\n---\napiVersion: v1\nkind: Endpoints\nmetadata:\nname: svc-mutate\nnamespace: default\nsubsets:\n- addresses:\n- ip: 192.168.1.104 # \u8fd9\u4e2a\u662f\u6211\u4eecgo webhook \u670d\u52a1\u7684ip\nports:\n- port: 443\nname: abc\n</code></pre> <p>\u8fd9\u4e2aMutatingWebhookConfiguration\u4e00\u521b\u5efa, \u4f60\u518dcreate pod \u5c31\u4f1a\u53bb\u56de\u8c03\u914d\u7f6e\u91cc\u7684service\u6307\u5411\u7684webhook \u670d\u52a1</p> mutate.yaml<pre><code>apiVersion: admissionregistration.k8s.io/v1\nkind: MutatingWebhookConfiguration\nmetadata:\nname: \"pod-policy.example.com\" # \u968f\u4fbf\u8d77\nwebhooks:\n- name: my-webhook.example.com # \u968f\u4fbf\u8d77\nsideEffects: None\nadmissionReviewVersions: [\"v1\",\"v1beta1\"]\nclientConfig:\nservice: # \u6307\u5b9awebhook\u7684\u7c7b\u578b, \u8fd9\u91cc\u662f service \nnamespace: \"default\"\nname: \"svc-mutate\" # service \u540d\u79f0\npath: \"/add-label\" # \u8bbf\u95ee\u8def\u5f84\ncaBundle: &lt;openssl base64 -A &lt;ca.crt \u7684\u7ed3\u679c&gt; #(1)\nrules:\n- operations: [\"CREATE\"] # \u6240\u6709\u521b\u5efa\u7684\u64cd\u4f5c \u90fd\u4f1a\u56de\u8c03\u8fd9\u4e2a hook\napiGroups: [\"*\"]\napiVersions: [\"*\"]\nresources: [\"*\"]\nscope: \"*\"\n</code></pre> <ol> <li>caBundle \u7684\u503c\u662f  <code>openssl base64 -A &lt;ca.crt</code>      \u60f3\u8981\u548chttps\u670d\u52a1\u6253\u4ea4\u9053, \u5c31\u9700\u8981\u6839\u8bc1\u4e66(\u6216\u81ea\u7b7e\u540d\u8bc1\u4e66)</li> </ol> <pre><code>k apply -f mutate.yaml\n</code></pre> <pre><code># \u6211\u4eec\u5728k8s\u4e0a \u968f\u4fbf\u521b\u5efa\u4e00\u4e2apod ,\u770b\u770b\nk run --image=nginx:1.14.2-alpine ng-tmp\n# \u53ef\u4ee5\u770b\u5230 pod\u81ea\u52a8\u7684\u6dfb\u52a0\u4e00\u4e2alabel\nk get po ng-tmp --show-labels\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/apiserver/#apf","title":"\u9650\u6d41 APF","text":"<ol> <li> <p>define-clusters-users-and-contexts \u21a9</p> </li> <li> <p>RBAC \u21a9</p> </li> <li> <p>aggregated-clusterroles \u21a9</p> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/","title":"controller-manager","text":"<p>Danger</p> <p>\u672a\u5b8c,\u5f85\u7ee7\u7eed\u6574\u7406...</p>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_1","title":"\u9ed8\u8ba4\u63a7\u5236\u5668","text":"<p>Controller Manager \u662f\u591a\u4e2a\u63a7\u5236\u5668\u7684\u7ec4\u5408, \u53e6\u5916\u50cf\u8c03\u5ea6\u5668\u5176\u5b9e\u662f\u4e00\u79cd\u7279\u6b8a\u7684\u63a7\u5236\u5668.</p> <pre><code>ks exec kube-controller-manager-master1 \\\n-- kube-controller-manager -h \\\n|grep -iA 2 \"\\-\\-controllers\"\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_2","title":"\u63a7\u5236\u5668\u67b6\u6784\u539f\u7406","text":"","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_3","title":"\u6838\u5fc3\u903b\u8f91","text":"<p>Important</p> <p>k8s\u4e2d\u6bcf\u4e00\u4e2a\u63a7\u5236\u5668 \u90fd\u5bf9\u5e94\u8d1f\u8d23k8s\u4e2d\u7684\u4e00\u79cd\u8d44\u6e90, \u4fdd\u8bc1\u8fd9\u79cd\u8d44\u6e90\u662f\u5176\u671f\u5f85\u7684\u72b6\u6001 \u6bcf\u4e2a Controller \u4e8b\u5b9e\u4e0a\u90fd\u662f\u4e00\u4e2a control loop\u6b7b\u5faa\u73af,\u8d1f\u8d23\u4fa6\u542c\u5176\u7ba1\u63a7\u7684\u5bf9\u8c61,\u5f53\u5bf9\u8c61\u53d1\u751f\u53d8\u66f4\u65f6\u5b8c\u6210\u914d\u7f6e. Controller \u914d\u7f6e\u5931\u8d25\u901a\u5e38\u4f1a\u89e6\u53d1\u81ea\u52a8\u91cd\u8bd5,\u6574\u4e2a\u96c6\u7fa4\u4f1a\u5728\u63a7\u5236\u5668\u4e0d\u65ad\u91cd\u8bd5\u7684\u673a\u5236\u4e0b\u786e\u4fdd\u6700\u7ec8\u4e00\u81f4\u6027</p> \u63a7\u5236\u5668\u7684\u6838\u5fc3\u903b\u8f91<pre><code>for {\n\u5f53\u524d\u72b6\u6001:= \u83b7\u53d6\u96c6\u7fa4\u4e2d\u5bf9\u8c61X\u7684\u5f53\u524d\u72b6\u6001(Current State)\n\u671f\u671b\u72b6\u6001:= \u83b7\u53d6\u96c6\u7fa4\u4e2d\u5bf9\u8c61X\u7684\u671f\u671b\u72b6\u6001(Desired State)\n// \u53ea\u6709\u4e0d\u4e00\u81f4\u7684\u65f6\u5019\nif \u5f53\u524d\u72b6\u6001 != \u671f\u671b\u72b6\u6001 {\n//\u5c06\u5f53\u524d\u72b6\u6001\u8c03\u6574\u4e3a\u671f\u671b\u72b6\u6001\n}\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_4","title":"\u8bbe\u8ba1\u601d\u8def","text":"\u6211\u4eec\u7684\u7b80\u5355\u601d\u8003k8s\u7684\u5b9e\u9645\u8bbe\u8ba1","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#resourceversion","title":"ResourceVersion","text":"<p>Important</p> <p>\u5728\u770b\u6e90\u7801\u4e4b\u524d\u6211\u4eec\u5148\u5b66\u4e60\u4e00\u4e0bResourceVersion \u8d44\u6e90\u7248\u672c\u53f7\u8fd9\u4e2a\u77e5\u8bc6\u70b9 \u8bf7\u5148\u53bb\u770b\u4e0b\u535a\u6587etcd\u7684\u7248\u672c\u7ba1\u7406</p>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#etcd","title":"\u8d44\u6e90\u5bf9\u8c61\u4e0eetcd","text":"<pre><code># \u521b\u5efa\u4e00\u4e2apod nginx, \u7136\u540e\nk get po nginx -o yaml |grep -i resourceVersion\n    resourceVersion: \"2794306\"\n# \u6211\u4eec\u77e5\u9053k8s \u7684\u6570\u636e\u6301\u4e45\u5316\u5230etcd\u7684,\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u770b\u4e0b\u8fd9\u4e2apod\u5728etcd\u91cc\u7684\u5b58\u50a8\u60c5\u51b5\ne get \"\" --prefix --keys-only |grep nginx\n    /registry/pods/default/nginx\n\n# \u770b\u4e0b \u5b58\u653e\u5728etcd\u65f6\u7684\u7248\u672c\u60c5\u51b5,\u4e0e  k get po \u5f97\u5230\u7684\u7248\u672c\u662f\u4e00\u6837\u7684.\ne get /registry/pods/default/nginx -w json #(1)\n# \u7ed9pod \u589e\u52a0\u4e00\u4e2alabel \u518d\u770b\nk get po nginx -o yaml |grep -i resourceVersion\n  resourceVersion: \"2794480\"\ne get /registry/pods/default/nginx -w json #(2)\n# \u53ef\u4ee5\u770b\u5230\u8fd92\u4e2a\u7248\u672c\u7684\u6570\u636e\ne watch /registry/pods/default/nginx --rev=2794306\n</code></pre> <ol> <li>\u67e5\u770b\u7248\u672c     <pre><code>{\n\"header\": {\n\"cluster_id\": 2356888313039106048,\n\"member_id\": 14381832694777033788,\n\"revision\": 2794357,\n\"raft_term\": 10\n},\n\"kvs\": [\n{\n\"key\": \"L3JlZ2lzdHJ5L3BvZHMvZGVmYXVsdC9uZ2lueA==\",\n\"create_revision\": 2738283,\n// k8s \u901a\u8fc7etcd\u4e2d\u7684\u8fd9\u4e2a \u548c k get po \u83b7\u53d6\u7684resourceVersion\u8fdb\u884c\u5bf9\u6bd4\n// \u5982\u679c\u4e0d\u76f8\u540c\u8bf4\u660e ,\u5728\u4f60\u66f4\u65b0\u7684\u65f6\u5019,po \u5df2\u7ecf\u88ab\u66f4\u65b0\u4e86,\u5219\u62d2\u7edd\u66f4\u65b0, \u8fd9\u5c31\u662f\u4e50\u89c2\u9501\n\"mod_revision\": 2794306,\n\"version\": 10,\n\"value\": \"+=\"\n}\n],\n\"count\": 1\n}\n</code></pre></li> <li>\u67e5\u770b     <pre><code>{\n\"header\": {\n\"cluster_id\": 2356888313039106048,\n\"member_id\": 14381832694777033788,\n\"revision\": 2794941,\n\"raft_term\": 10\n},\n\"kvs\": [\n{\n\"key\": \"L3JlZ2lzdHJ5L3BvZHMvZGVmYXVsdC9uZ2lueA==\",\n\"create_revision\": 2738283,\n\"mod_revision\": 2794480,\n\"version\": 11,\n\"value\": \"+=\"\n}\n],\n\"count\": 1\n}\n</code></pre></li> </ol>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_5","title":"\u67e5\u8be2\u65f6\u5e26\u4e0a","text":"<p>\u5173\u4e8e\u67e5\u8be2\u4e2d\u5e26resourceVersion\u7684\u5177\u4f53\u8868\u73b0,\u8bf7\u770b\u5b98\u65b9\u6587\u6863\u7684\u8bf4\u660e</p> list\u4f7f\u7528resourceVersionget\u4f7f\u7528resourceVersionwatch\u4f7f\u7528resourceVersion resourceVersionMatch \u53c2\u6570 \u5206\u9875\u53c2\u6570 resourceVersion \u672a\u8bbe\u7f6e resourceVersion=\"0\" resourceVersion=\"&lt;\u975e\u96f6\u503c&gt;\" \u672a\u8bbe\u7f6e limit \u672a\u8bbe\u7f6e \u6700\u65b0\u7248\u672c \u4efb\u610f\u7248\u672c \u4e0d\u8001\u4e8e\u6307\u5b9a\u7248\u672c \u672a\u8bbe\u7f6e limit=n, continue \u672a\u8bbe\u7f6e \u6700\u65b0\u7248\u672c \u4efb\u610f\u7248\u672c \u7cbe\u786e\u5339\u914d \u672a\u8bbe\u7f6e limit=n, continue=token \u4ece token \u5f00\u59cb\u3001\u7cbe\u786e\u5339\u914d \u975e\u6cd5\u8bf7\u6c42\u89c6\u4e3a\u4ece token \u5f00\u59cb\u3001\u7cbe\u786e\u5339\u914d \u975e\u6cd5\u8bf7\u6c42\u8fd4\u56de HTTP 400 Bad Request Exact limit \u672a\u8bbe\u7f6e \u975e\u6cd5\u8bf7\u6c42 \u975e\u6cd5\u8bf7\u6c42 \u7cbe\u786e\u5339\u914d Exact limit=n, continue \u672a\u8bbe\u7f6e \u975e\u6cd5\u8bf7\u6c42 \u975e\u6cd5\u8bf7\u6c42 \u7cbe\u786e\u5339\u914d NotOlderThan limit \u672a\u8bbe\u7f6e \u975e\u6cd5\u8bf7\u6c42 \u4efb\u610f\u7248\u672c \u4e0d\u8001\u4e8e\u6307\u5b9a\u7248\u672c NotOlderThan limit=n, continue \u672a\u8bbe\u7f6e \u975e\u6cd5\u8bf7\u6c42 \u4efb\u610f\u7248\u672c \u4e0d\u8001\u4e8e\u6307\u5b9a\u7248\u672c <p>Info</p> <p>resourceVersionMatch \u5982\u679c\u8bbe\u7f6e\u7684\u8bdd,\u503c=Exact\u6216NotOlderThan <code>http://localhost:8001/api/v1/pods?resourceVersion=2196120&amp;resourceVersionMatch=NotOlderThan&amp;limit=1</code> \u7ed3\u679c\u91cc\u80fd\u770b\u5230metadata\u91cc continue\u7684\u503cxxx, \u7136\u540e \u8bf7\u6c42\u5e26\u4e0a &amp;continue=xxx ,\u5c31\u662f\u5206\u9875\u4e00\u6837,\u7b2c\u4e8c\u9875\u4e86. \u6700\u65b0\u7248\u672c\u7684\u610f\u601d: \u4ece etcd \u8bfb\u53d6 \u4efb\u610f\u7248\u672c\u7684\u610f\u601d: \u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6,\u56e0\u4e3a\u7f13\u5b58\u4e2d\u53ef\u80fd\u662f\u65e7\u7684,\u4e5f\u53ef\u80fd\u662f\u548cetcd\u4e2d\u4e00\u81f4\u7684\u6570\u636e, \u6240\u4ee5\u8fd9\u91cc\u79f0\u4e3a\u4efb\u610f\u7248\u672c</p> resourceVersion \u672a\u8bbe\u7f6e resourceVersion=\"0\" resourceVersion=\"&lt;\u975e\u96f6\u503c&gt;\" \u6700\u65b0\u7248\u672c \u4efb\u4f55\u7248\u672c \u4e0d\u8001\u4e8e\u7ed9\u5b9a\u7248\u672c resourceVersion \u672a\u8bbe\u7f6e resourceVersion=\"0\" resourceVersion=\"&lt;\u975e\u96f6\u503c&gt;\" \u8bfb\u53d6\u72b6\u6001\u5e76\u4ece\u6700\u65b0\u7248\u672c\u5f00\u59cb \u8bfb\u53d6\u72b6\u6001\u5e76\u4ece\u4efb\u610f\u7248\u672c\u5f00\u59cb \u4ece\u6307\u5b9a\u7248\u672c\u5f00\u59cb <p>\u6e90\u7801\u8bf4\u660e\u4ec0\u4e48\u65f6\u5019\u4eceetcd\u83b7\u53d6,\u4ec0\u4e48\u65f6\u5019\u4eceetcd\u4e2d\u83b7\u53d6</p> <p>\u5f85\u786e\u8ba4...</p> staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go<pre><code>func (c *Cacher) List(ctx context.Context, key string, opts storage.ListOptions, listObj runtime.Object) error {\nresourceVersion := opts.ResourceVersion\npred := opts.Predicate\nif shouldDelegateList(opts) {\n// \u4eceetcd \u83b7\u53d6\nreturn c.storage.List(ctx, key, opts, listObj)\n}\n//...\n}\nfunc shouldDelegateList(opts storage.ListOptions) bool {\nresourceVersion := opts.ResourceVersion\npred := opts.Predicate\npagingEnabled := utilfeature.DefaultFeatureGate.Enabled(features.APIListChunking)\nhasContinuation := pagingEnabled &amp;&amp; len(pred.Continue) &gt; 0\n// resourceVersion \u4e0d\u7b49\u4e8e0\nhasLimit := pagingEnabled &amp;&amp; pred.Limit &gt; 0 &amp;&amp; resourceVersion != \"0\"\nreturn resourceVersion == \"\" || hasContinuation || hasLimit || opts.ResourceVersionMatch == metav1.ResourceVersionMatchExact\n}\n</code></pre> resourceVersion \u7a7ahasLimithasContinuation\u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6 <pre><code># list\u64cd\u4f5c \u8fd4\u56de\u7684\u7ed3\u679c\u91cc\u6700\u5916\u5c42\u7684resourceVersion \u662f list \u54cd\u5e94\u88ab\u6784\u9020\u65f6\u7684reversion\n# \u5c31\u662f \u62c9\u53d6\u7684\u6570\u636e\u662f  etcd\u5168\u5c40reversion = \u6700\u5916\u5c42\u7684resourceVersion\u8fd9\u4e2a\u503c\u7684\u65f6\u5019\u7684\u6570\u636e\n# \u6240\u4ee5 \u4e0b\u6b21\u62c9\u53d6\u7684\u65f6\u5019, \u4f7f\u7528watch ,\u7136\u540e\u8bbe\u7f6e\u4e0d\u8001\u4e8e \u8fd9\u4e2aresourceVersion, \u8fd9\u6837\u5c31\u5168\u91cf+\u589e\u91cf\u83b7\u53d6\u6570\u636e\u4e86\n# \u4e0d\u5e26resourceVersion \u7684\u65f6\u5019, \u4f1a\u4eceetcd \u8bfb\u53d6,\u6240\u4ee5 \u8fd9\u4e2a\u65f6\u5019\u7684 \u503c= \u62c9\u53d6\u7684\u65f6\u5019etcd\u5168\u5c40\u7684reversion\ncurl localhost:8001/api/v1/namespaces/default/pods\n# \u6216\u76f4\u63a5\u5728\u6d4f\u89c8\u5668\u6253\u5f00\nlocalhost:8001/api/v1/namespaces/default/pods #(1)\n</code></pre> <ol> <li> <p>\u7ed3\u679c</p> <pre><code>{\n\"kind\": \"PodList\",\n\"apiVersion\": \"v1\",\n\"metadata\": {\n\"resourceVersion\": \"...\"\n},\n\"items\": [\n{\n\"metadata\": {\n\"name\": \"...\",\n\"namespace\": \"...\",\n\"resourceVersion\": \"....\",\n},\n\"spec\": {},\n\"status\": {}\n},\n{...},\n{...},\n{...}\n]\n}\n</code></pre> </li> </ol> <pre><code># \u4e0b\u9762\u8fd9\u4e2a\u64cd\u4f5c \u4f1a\u83b7\u53d6pod\u662fnginx \u7248\u672c\u4e3a2794306\u7684\u4fe1\u606f\n# \u5982\u679c\u6307\u5b9a\u7684\u7248\u672c\u88ab\u538b\u7f29\u8fc7,\u4f1a\u62a5\u9519,\u56e0\u4e3a\u8fd9\u4e2a\u662f\u7cbe\u786e\u5339\u914d,\u8868\u793a\u5168\u5c40reversion=2794306\u65f6\u7684\u6570\u636e,\u800c\u8fd9\u4e2a\u7248\u672c\u4e0d\u5728\u4e86\n# \u4eceetcd\u83b7\u53d6\nlocalhost:8001/api/v1/namespaces/default/pods?resourceVersion=2794306&amp;limit=5\n</code></pre> <pre><code># continue \u5206\u9875, \u4eceetcd \u83b7\u53d6\nlocalhost:8001/api/v1/namespaces/default/pods?limit=1 #(1)\n# \u4f7f\u7528 continue \u7ee7\u7eed\u83b7\u53d6\u4e0b\u4e00\u9875\nlocalhost:8001/api/v1/namespaces/default/pods?limit=1&amp;continue=XXXXXXXXXXXXX\n</code></pre> <ol> <li> <p>\u7ed3\u679c\u663e\u793a</p> <pre><code>{\n\"kind\": \"PodList\",\n\"apiVersion\": \"v1\",\n\"metadata\": {\n\"resourceVersion\":    \"2840267\",\n\"continue\":           \"XXXXXXXXXXXXX\",\n\"remainingItemCount\": 3 // \u5269\u4f59\u8fd8\u6709\u51e0\u6761\u6570\u636e\n},\n\"items\": []\n}\n</code></pre> </li> </ol> <pre><code># \u4e0d\u8001\u4e8e\u6307\u5b9a\u7248\u672c, \u8fd4\u56de\u7684\u7ed3\u679c\u91cc\u6700\u5916\u5c42\u7684resourceVersion \u662f list \u54cd\u5e94\u88ab\u6784\u9020\u65f6\u7684reversion\n# \u7531\u4e8e\u662f\u4ece\u7f13\u5b58(apiserver\u7684\u7f13\u5b58)\u4e2d\u83b7\u53d6,\u6240\u4ee5\u83b7\u53d6\u7684\u65f6\u5019,\u662f\u7f13\u5b58\u4e2d\u6700\u65b0\u7248\u672c\u7684\u6570\u636e,\u4f46\u662f\u56e0\u4e3a\u662f\u7f13\u5b58\n# \u663e\u793a\u7684resourceVersion \u53ef\u80fd\u5728\u5b9e\u9645etcd\u91cc\u662f\u5df2\u7ecf\u88ab\u538b\u7f29\u8fc7\u800c\u4e0d\u5b58\u5728\u7684\u503c\n# \u5b9e\u9645\u6d4b\u8bd5,\u53ef\u4ee5\u6d4b\u5230, \u8fd9\u4e2aresourceVersion \u7528\u4e0b\u9762\u7684 \u53ef\u4ee5\u8bbf\u95ee, \u53bbetcd \u547d\u4ee4\u8bbf\u95ee\u4f1a\u63d0\u793atoo old\nlocalhost:8001/api/v1/namespaces/default/pods?resourceVersion=2794306\n# \u540c\u4e0a\nlocalhost:8001/api/v1/namespaces/default/pods?resourceVersion=2794306&amp;resourceVersionMatch=NotOlderThan\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_6","title":"\u4ee3\u7801\u6d41\u7a0b","text":"<p>Tip</p> <p>\u6211\u4eec\u4ee5ReplicaSet\u8d44\u6e90\u7684\u63a7\u5236\u5668\u4e3a\u4f8b</p>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_7","title":"\u6d41\u7a0b\u7b80\u56fe","text":"","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_8","title":"\u5165\u53e3","text":"controllermanager#run cmd/kube-controller-manager/app/controllermanager.go#run<pre><code>func Run(c *config.CompletedConfig, stopCh &lt;-chan struct{}) error {\nrun := func(ctx context.Context, startSATokenController InitFunc, initializersFunc ControllerInitializersFunc) {\ncontrollerContext, err := CreateControllerContext(c, rootClientBuilder, clientBuilder, ctx.Done())\nif err != nil {\n}\n// 3. \u6765\u81f3NewControllerInitializers\u91cc\u4e00\u4e2a\u4e2a startXXXController\n// \u6bcf\u4e2astartXXXController \u91cc\u90fd\u7528\u5de5\u5382\u65b9\u6cd5\u5b9e\u4f8b\u5316 \u5bf9\u5e94\u7c7b\u578b\u7684informer\ncontrollerInitializers := initializersFunc(controllerContext.LoopMode)\n// 4. \u6267\u884c\u6bcf\u4e2a startXXXController()  (2)\n// \u90fd\u4f7f\u7528controllerContext.InformerFactory \u6765\u521b\u5efa\u5bf9\u5e94\u8d44\u6e90informer\n// \u90fd\u5b58\u4e8econtrollerContext.InformerFactory.informers\u4e2d\nif err := StartControllers(ctx, controllerContext, startSATokenController, controllerInitializers, unsecuredMux, healthzHandler); err != nil {\n}\n// 5. \u7136\u540e\u8fd9\u91cc\u542f\u52a8\u6240\u6709\u7684informer (1)\ncontrollerContext.InformerFactory.Start(stopCh)\ncontrollerContext.ObjectOrMetadataInformerFactory.Start(stopCh)\nclose(controllerContext.InformersStarted)\nselect {}\n}\n// Start the main lock\ngo leaderElectAndRun(c, id, electionChecker,\nc.ComponentConfig.Generic.LeaderElection.ResourceLock,\nc.ComponentConfig.Generic.LeaderElection.ResourceName,\nleaderelection.LeaderCallbacks{\nOnStartedLeading: func(ctx context.Context) {\n// 1. NewControllerInitializers \u5404\u79cd\u4e0d\u540c\u8d44\u6e90\u63a7\u5236\u5668\u7684\u5b9a\u4e49 (3)\ninitializersFunc := NewControllerInitializers\nif leaderMigrator != nil {\ninitializersFunc = createInitializersFunc(leaderMigrator.FilterFunc, leadermigration.ControllerNonMigrated)\n}\n// 2. run \u53bb\u770b\u4e0a\u65b9\u7684run\u5b9a\u4e49\nrun(ctx, startSATokenController, initializersFunc)\n},\nOnStoppedLeading: func() {\n},\n})\n}\n</code></pre> <ol> <li> <p>\u4ee3\u7801</p> <pre><code>// Start initializes all requested informers.\nfunc (f *sharedInformerFactory) Start(stopCh &lt;-chan struct{}) {\nf.lock.Lock()\ndefer f.lock.Unlock()\nfor informerType, informer := range f.informers {\nif !f.startedInformers[informerType] {\ngo informer.Run(stopCh)\nf.startedInformers[informerType] = true\n}\n}\n}\n</code></pre> </li> <li> <p>StartControllers</p> <pre><code>func StartControllers(ctx context.Context, controllerCtx ControllerContext, startSATokenController InitFunc, controllers map[string]InitFunc,...){\nfor controllerName, initFn := range controllers {\n// ...\nctrl, started, err := initFn(ctx, controllerCtx)\n// ...\n}\n}\n</code></pre> </li> <li> <p>NewControllerInitializers</p> <pre><code>func NewControllerInitializers(loopMode ControllerLoopMode) map[string]InitFunc {\ncontrollers := map[string]InitFunc{}\ncontrollers[\"endpoint\"] = startEndpointController\ncontrollers[\"endpointslice\"] = startEndpointSliceController\ncontrollers[\"endpointslicemirroring\"] = startEndpointSliceMirroringController\ncontrollers[\"replicationcontroller\"] = startReplicationController\ncontrollers[\"podgc\"] = startPodGCController\ncontrollers[\"resourcequota\"] = startResourceQuotaController\ncontrollers[\"namespace\"] = startNamespaceController\ncontrollers[\"serviceaccount\"] = startServiceAccountController\ncontrollers[\"garbagecollector\"] = startGarbageCollectorController\ncontrollers[\"daemonset\"] = startDaemonSetController\ncontrollers[\"job\"] = startJobController\ncontrollers[\"deployment\"] = startDeploymentController\ncontrollers[\"replicaset\"] = startReplicaSetController\n//....\n//....\nreturn controllers\n}\n</code></pre> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_9","title":"\u5b9e\u4f8b\u5316\u63a7\u5236\u5668","text":"startReplicaSetController.Informer()AddEventHandler <pre><code>func startReplicaSetController(ctx context.Context, controllerContext ControllerContext) (controller.Interface, bool, error) {\ngo replicaset.NewReplicaSetController(\ncontrollerContext.InformerFactory.Apps().V1().ReplicaSets(), //\u5b9a\u4e49rs\u7684informer\ncontrollerContext.InformerFactory.Core().V1().Pods(),  // rs \u76d1\u63a7pod\u8d44\u6e90, \u6240\u4ee5\u4e5f\u9700\u8981pod\u7684\ncontrollerContext.ClientBuilder.ClientOrDie(\"replicaset-controller\"),\nreplicaset.BurstReplicas,\n).Run(ctx, int(controllerContext.ComponentConfig.ReplicaSetController.ConcurrentRSSyncs))\nreturn nil, true, nil\n}\nfunc NewReplicaSetController(rsInformer appsinformers.ReplicaSetInformer, podInformer coreinformers.PodInformer, kubeClient clientset.Interface, burstReplicas int) *ReplicaSetController {\nreturn NewBaseController(rsInformer, podInformer,...)\n}\nfunc NewBaseController(...) *ReplicaSetController {\n// ...\nrsc := &amp;ReplicaSetController{\nGroupVersionKind: gvk,\nkubeClient:       kubeClient,\npodControl:       podControl,\nburstReplicas:    burstReplicas,\nexpectations:     controller.NewUIDTrackingControllerExpectations(controller.NewControllerExpectations()),\n// \u5de5\u4f5c\u961f\u5217, \u6d88\u8d39DeltaFifo \u65f6, \u4f1a\u5148\u5c06\u6570\u636e\u653e\u5230\u8fd9\u4e2a\u5de5\u4f5c\u961f\u5217\nqueue:            workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), queueName),\n}\n// .Informer() \u5c06\u4f1a\u5728 controllerContext.InformerFactory.informers \u8bbe\u7f6e .informers[informerType]=...\n// \u6d88\u8d39DeltaFifo\u91ccrs\u8d44\u6e90\u65f6, \u5bf9\u5e94\u7684\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5\nrsInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{\nAddFunc:    rsc.addRS,\nUpdateFunc: rsc.updateRS,\nDeleteFunc: rsc.deleteRS,\n})\nrsc.rsLister = rsInformer.Lister()\nrsc.rsListerSynced = rsInformer.Informer().HasSynced\n// \u6d88\u8d39DeltaFifo\u91ccpod\u8d44\u6e90\u65f6, \u5bf9\u5e94\u7684\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5\npodInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{\nAddFunc: rsc.addPod,\nUpdateFunc: rsc.updatePod,\nDeleteFunc: rsc.deletePod,\n})\nrsc.podLister = podInformer.Lister()\nrsc.podListerSynced = podInformer.Informer().HasSynced\nrsc.syncHandler = rsc.syncReplicaSet\nreturn rsc\n}\n</code></pre> <pre><code>func (f *podInformer) Informer() cache.SharedIndexInformer {\nreturn f.factory.InformerFor(&amp;corev1.Pod{}, f.defaultInformer)\n}\nfunc (f *podInformer) defaultInformer(client kubernetes.Interface, resyncPeriod time.Duration) cache.SharedIndexInformer {\nreturn NewFilteredPodInformer(client,f.namespace,resyncPeriod,cache.Indexers{cache.NamespaceIndex: cache.MetaNamespaceIndexFunc},f.tweakListOptions)\n}\nfunc NewFilteredIngressInformer(client kubernetes.Interface, namespace string, resyncPeriod time.Duration, indexers cache.Indexers, tweakListOptions internalinterfaces.TweakListOptionsFunc) cache.SharedIndexInformer {\nreturn cache.NewSharedIndexInformer(\n&amp;cache.ListWatch{\nListFunc: func(options metav1.ListOptions) (runtime.Object, error) {\nif tweakListOptions != nil {\ntweakListOptions(&amp;options)\n}\nreturn client.NetworkingV1().Ingresses(namespace).List(context.TODO(), options)\n},\nWatchFunc: func(options metav1.ListOptions) (watch.Interface, error) {\nif tweakListOptions != nil {\ntweakListOptions(&amp;options)\n}\nreturn client.NetworkingV1().Ingresses(namespace).Watch(context.TODO(), options)\n},\n},\n&amp;networkingv1.Ingress{},\nresyncPeriod,\nindexers,\n)\n}\nfunc NewSharedIndexInformer(lw ListerWatcher, exampleObject runtime.Object, defaultEventHandlerResyncPeriod time.Duration, indexers Indexers) SharedIndexInformer {\nrealClock := &amp;clock.RealClock{}\nsharedIndexInformer := &amp;sharedIndexInformer{\nprocessor:                       &amp;sharedProcessor{clock: realClock},\nindexer:                         NewIndexer(DeletionHandlingMetaNamespaceKeyFunc, indexers),\nlisterWatcher:                   lw,\nobjectType:                      exampleObject,\nresyncCheckPeriod:               defaultEventHandlerResyncPeriod,\ndefaultEventHandlerResyncPeriod: defaultEventHandlerResyncPeriod,\ncacheMutationDetector:           NewCacheMutationDetector(fmt.Sprintf(\"%T\", exampleObject)),\nclock:                           realClock,\n}\nreturn sharedIndexInformer\n}\nfunc NewIndexer(keyFunc KeyFunc, indexers Indexers) Indexer {\nreturn &amp;cache{\ncacheStorage: NewThreadSafeStore(indexers, Indices{}),\nkeyFunc:      keyFunc,\n}\n}\nfunc NewThreadSafeStore(indexers Indexers, indices Indices) ThreadSafeStore {\nreturn &amp;threadSafeMap{\nitems:    map[string]interface{}{},\nindexers: indexers,\nindices:  indices,\n}\n}\n</code></pre> <p>\u6211\u4eec\u5728.Informer() \u4e2d\u521d\u59cb\u5316\u4e86 processor \u5728AddEventHandler \u6dfb\u52a0\u4e86 Listener</p> <pre><code>func (s *sharedIndexInformer) AddEventHandler(handler ResourceEventHandler) {\ns.AddEventHandlerWithResyncPeriod(handler, s.defaultEventHandlerResyncPeriod)\n}\nfunc (s *sharedIndexInformer) AddEventHandlerWithResyncPeriod(handler ResourceEventHandler, resyncPeriod time.Duration) {\ns.startedLock.Lock()\ndefer s.startedLock.Unlock()\nif s.stopped {\nklog.V(2).Infof(\"Handler %v was not added to shared informer because it has stopped already\", handler)\nreturn\n}\nif resyncPeriod &gt; 0 {\nif resyncPeriod &lt; minimumResyncPeriod {\nklog.Warningf(\"resyncPeriod %v is too small. Changing it to the minimum allowed value of %v\", resyncPeriod, minimumResyncPeriod)\nresyncPeriod = minimumResyncPeriod\n}\nif resyncPeriod &lt; s.resyncCheckPeriod {\nif s.started {\nklog.Warningf(\"resyncPeriod %v is smaller than resyncCheckPeriod %v and the informer has already started. Changing it to %v\", resyncPeriod, s.resyncCheckPeriod, s.resyncCheckPeriod)\nresyncPeriod = s.resyncCheckPeriod\n} else {\n// if the event handler's resyncPeriod is smaller than the current resyncCheckPeriod, update\n// resyncCheckPeriod to match resyncPeriod and adjust the resync periods of all the listeners\n// accordingly\ns.resyncCheckPeriod = resyncPeriod\ns.processor.resyncCheckPeriodChanged(resyncPeriod)\n}\n}\n}\nlistener := newProcessListener(handler, resyncPeriod, determineResyncPeriod(resyncPeriod, s.resyncCheckPeriod), s.clock.Now(), initialBufferSize)\nif !s.started {\ns.processor.addListener(listener)\nreturn\n}\ns.blockDeltas.Lock()\ndefer s.blockDeltas.Unlock()\ns.processor.addListener(listener)\nfor _, item := range s.indexer.List() {\nlistener.add(addNotification{newObj: item})\n}\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#run","title":"\u63a7\u5236\u5668.Run()","text":"Run()worker()processNextWorkItem() <pre><code>func (rsc *ReplicaSetController) Run(ctx context.Context, workers int) {\n// ...\nif !cache.WaitForNamedCacheSync(rsc.Kind, ctx.Done(), rsc.podListerSynced, rsc.rsListerSynced) {\nreturn\n}\nfor i := 0; i &lt; workers; i++ {\n// worker\ngo wait.UntilWithContext(ctx, rsc.worker, time.Second)\n}\n&lt;-ctx.Done()\n}\n</code></pre> <pre><code>// worker runs a worker thread that just dequeues items, processes them, and marks them done.\n// It enforces that the syncHandler is never invoked concurrently with the same key.\nfunc (rsc *ReplicaSetController) worker(ctx context.Context) {\nfor rsc.processNextWorkItem(ctx) {\n}\n}\n</code></pre> <pre><code>func (rsc *ReplicaSetController) processNextWorkItem(ctx context.Context) bool {\nkey, quit := rsc.queue.Get()\nif quit {\nreturn false\n}\ndefer rsc.queue.Done(key)\nerr := rsc.syncHandler(ctx, key.(string))\nif err == nil {\nrsc.queue.Forget(key)\nreturn true\n}\nutilruntime.HandleError(fmt.Errorf(\"sync %q failed with %v\", key, err))\nrsc.queue.AddRateLimited(key)\nreturn true\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#informerrun","title":"informer.run()","text":"informer.Run<pre><code>func (s *sharedIndexInformer) Run(stopCh &lt;-chan struct{}) {\n// ...\nif s.HasStarted() {\n// \u53ef\u4ee5 \u60f3\u5230, \u8fd9\u5c31\u548c\u524d\u9762\u7684 \u8bbe\u8ba1\u662f\u4e00\u81f4\u7684\n// \u540c\u7c7b\u578b\u8d44\u6e90\u7684informer \u5982\u679c\u5df2\u7ecf\u542f\u52a8\u4e86, \u5c31\u4e0d\u7528\u542f\u52a8\u4e86.\nreturn\n}\n// \u521d\u59cb\u5316 DeltaFIFO\nfifo := NewDeltaFIFOWithOptions(DeltaFIFOOptions{\nKnownObjects:          s.indexer,\nEmitDeltaTypeReplaced: true,\n})\ncfg := &amp;Config{\nQueue:            fifo,\nListerWatcher:    s.listerWatcher,\nObjectType:       s.objectType,\nFullResyncPeriod: s.resyncCheckPeriod,\nRetryOnError:     false,\nShouldResync:     s.processor.shouldResync,\nProcess:           s.HandleDeltas,\nWatchErrorHandler: s.watchErrorHandler,\n}\nfunc() {\ns.startedLock.Lock()\ndefer s.startedLock.Unlock()\ns.controller = New(cfg)\ns.controller.(*controller).clock = s.clock\ns.started = true // HasStarted()\n}()\n// Separate stop channel because Processor should be stopped strictly after controller\nprocessorStopCh := make(chan struct{})\nvar wg wait.Group\ndefer wg.Wait()              // Wait for Processor to stop\ndefer close(processorStopCh) // Tell Processor to stop\nwg.StartWithChannel(processorStopCh, s.cacheMutationDetector.Run)\nwg.StartWithChannel(processorStopCh, s.processor.run) //\ndefer func() {\ns.startedLock.Lock()\ndefer s.startedLock.Unlock()\ns.stopped = true // Don't want any new listeners\n}()\ns.controller.Run(stopCh)\n}\n</code></pre> controller.Runs.processor.run <pre><code>func (c *controller) Run(stopCh &lt;-chan struct{}) {\n// ...\nr := NewReflector(\nc.config.ListerWatcher,\nc.config.ObjectType,\nc.config.Queue,  // \u8fd9\u662fr.store \u662f \u524d\u9762\u5b9a\u4e49\u7684DeltaFIFO\nc.config.FullResyncPeriod,\n)\nr.ShouldResync = c.config.ShouldResync\nr.WatchListPageSize = c.config.WatchListPageSize\nr.clock = c.clock\nif c.config.WatchErrorHandler != nil {\nr.watchErrorHandler = c.config.WatchErrorHandler\n}\nc.reflectorMutex.Lock()\nc.reflector = r\nc.reflectorMutex.Unlock()\nvar wg wait.Group\nwg.StartWithChannel(stopCh, r.Run)\n// processLoop \u6d88\u8d39DeltaFifo\u7684\u65b9\u6cd5\nwait.Until(c.processLoop, time.Second, stopCh)\nwg.Wait()\n}\n</code></pre> r.Runcontroller.processLoop <p><pre><code>func (g *Group) StartWithChannel(stopCh &lt;-chan struct{}, f func(stopCh &lt;-chan struct{})) {\ng.Start(func() {\nf(stopCh)\n})\n}\n</code></pre> <pre><code>func (r *Reflector) Run(stopCh &lt;-chan struct{}) {\nwait.BackoffUntil(func() {\nif err := r.ListAndWatch(stopCh); err != nil {\nr.watchErrorHandler(r, err)\n}\n}, r.backoffManager, true, stopCh)\n}\n</code></pre></p> r.ListAndWatchr.listerWatcher.List/Watchpager.List()r.watchHandler <pre><code>func (r *Reflector) ListAndWatch(stopCh &lt;-chan struct{}) error {\nvar resourceVersion string\noptions := metav1.ListOptions{ResourceVersion: r.relistResourceVersion()}\nif err := func() error {\ndefer initTrace.LogIfLong(10 * time.Second)\nvar list runtime.Object\nvar paginatedResult bool\nvar err error\nlistCh := make(chan struct{}, 1)\npanicCh := make(chan interface{}, 1)\ngo func() {\ndefer func() {\nif r := recover(); r != nil {\npanicCh &lt;- r\n}\n}()\npager := pager.New(pager.SimplePageFunc(func(opts metav1.ListOptions) (runtime.Object, error) {\n// r.listerWatcher \u6765\u81f3c.config.ListerWatcher\n// c.config.ListerWatcher \u6765\u81f3 sharedIndexInformer.listerWatcher\n// \u5168\u91cf\u62c9\u53d6\u6570\u636e, \u914d\u5408\u540e\u9762\u7684Watch \u83b7\u53d6\u589e\u91cf\u66f4\u65b0\nreturn r.listerWatcher.List(opts)\n}))\nswitch {\ncase r.WatchListPageSize != 0:\npager.PageSize = r.WatchListPageSize\ncase r.paginatedResult:\ncase options.ResourceVersion != \"\" &amp;&amp; options.ResourceVersion != \"0\":\npager.PageSize = 0\n}\nlist, paginatedResult, err = pager.List(context.Background(), options)\nif isExpiredError(err) || isTooLargeResourceVersionError(err) {\n// \u8bbe\u7f6e true\u65f6, \u4e0b\u9762\u7684 r.relistResourceVersion() \u5c06\u5f97\u5230ResourceVersion=\"\"\nr.setIsLastSyncResourceVersionUnavailable(true)\nlist, paginatedResult, err = pager.List(context.Background(), metav1.ListOptions{ResourceVersion: r.relistResourceVersion()})\n}\nclose(listCh)\n}()\nselect {\ncase &lt;-stopCh:\nreturn nil\ncase r := &lt;-panicCh:\npanic(r)\ncase &lt;-listCh:\n}\nif err != nil {\nreturn }\nif options.ResourceVersion == \"0\" &amp;&amp; paginatedResult {\nr.paginatedResult = true\n}\nr.setIsLastSyncResourceVersionUnavailable(false) // list was successful\nlistMetaInterface, err := meta.ListAccessor(list)\nif err != nil {\nreturn\n}\nresourceVersion = listMetaInterface.GetResourceVersion()\nitems, err := meta.ExtractList(list)\nif err != nil {\nreturn\n}\n// \u5c06\u8d44\u6e90\u5bf9\u8c61\u5217\u8868\u4e2d\u7684\u8d44\u6e90\u5bf9\u8c61\u548c\u8d44\u6e90\u7248\u672c\u53f7\u5b58\u50a8\u81f3DeltaFIFO\u4e2d,\u4f1a\u66ff\u6362\u5df2\u5b58\u5728\u7684\u5bf9\u8c61\nif err := r.syncWith(items, resourceVersion); err != nil {\nreturn\n}\n// \u8bbe\u7f6e\u6700\u540e\u540c\u6b65\u7684\u8d44\u6e90\u7248\u672c\u53f7\nr.setLastSyncResourceVersion(resourceVersion)\nreturn nil\n}(); err != nil {\nreturn err\n}\nresyncerrc := make(chan error, 1)\ncancelCh := make(chan struct{})\ndefer close(cancelCh)\ngo func() {\nresyncCh, cleanup := r.resyncChan()\ndefer func() {\ncleanup() // Call the last one written into cleanup\n}()\nfor {\nselect {\ncase &lt;-resyncCh:\ncase &lt;-stopCh:\nreturn\ncase &lt;-cancelCh:\nreturn\n}\nif r.ShouldResync == nil || r.ShouldResync() {\nif err := r.store.Resync(); err != nil {\nresyncerrc &lt;- err\nreturn\n}\n}\ncleanup()\nresyncCh, cleanup = r.resyncChan()\n}\n}()\nfor {\nselect {\ncase &lt;-stopCh:\nreturn nil\ndefault:\n}\ntimeoutSeconds := int64(minWatchTimeout.Seconds() * (rand.Float64() + 1.0))\noptions = metav1.ListOptions{\nResourceVersion: resourceVersion,\nTimeoutSeconds: &amp;timeoutSeconds,\nAllowWatchBookmarks: true,\n}\n// watch, \u7528\u4e0a\u9762\u5168\u91cf\u83b7\u53d6\u540e\u7684 \u8d44\u6e90\u7248\u672c\u53f7, \u8868\u793a\u76d1\u542c\u8fd9\u4e4b\u540e\u7684\n// \u589e\u91cf\u66f4\u65b0\nw, err := r.listerWatcher.Watch(options)\nif err != nil {\nif utilnet.IsConnectionRefused(err) || apierrors.IsTooManyRequests(err) {\n&lt;-r.initConnBackoffManager.Backoff().C()\ncontinue\n}\nreturn err\n}\n// \u5bf9\u76d1\u542c\u5230\u7684\u4e8b\u4ef6\u8fdb\u884c\u5904\u7406\nif err := r.watchHandler(start, w, &amp;resourceVersion, resyncerrc, stopCh); err != nil {\nif err != errorStopRequested {\nswitch {\ncase isExpiredError(err):\ncase apierrors.IsTooManyRequests(err):\n&lt;-r.initConnBackoffManager.Backoff().C()\ncontinue\ndefault:\n}\n}\nreturn nil\n}\n}\n}\n</code></pre> <p>\u5728\u5b9e\u4f8b\u5316Informer\u7684\u65f6\u5019, \u8bbe\u7f6e\u4e86\u5bf9\u5e94\u7684list\u548cwatch\u65b9\u6cd5 \u5173\u4e8e pod\u7684list\u548cwatch \u64cd\u4f5c \u53c2\u8003 \u535a\u6587</p> <pre><code>informer := sharedInformers.Core().V1().Pods().Informer()\nfunc (f *podInformer) Informer() cache.SharedIndexInformer {\nreturn f.factory.InformerFor(&amp;corev1.Pod{}, f.defaultInformer)\n}\n// f.defaultInformer\nfunc (f *podInformer) defaultInformer(client kubernetes.Interface, resyncPeriod time.Duration) cache.SharedIndexInformer {\nreturn NewFilteredPodInformer(client, f.namespace, resyncPeriod, cache.Indexers{cache.NamespaceIndex: cache.MetaNamespaceIndexFunc}, f.tweakListOptions)\n}\n// NewFilteredPodInformer\nfunc NewFilteredPodInformer(client kubernetes.Interface, namespace string, resyncPeriod time.Duration, indexers cache.Indexers, tweakListOptions internalinterfaces.TweakListOptionsFunc) cache.SharedIndexInformer {\nreturn cache.NewSharedIndexInformer(\n&amp;cache.ListWatch{\nListFunc: func(options metav1.ListOptions) (runtime.Object, error) {\nif tweakListOptions != nil {\ntweakListOptions(&amp;options)\n}\n// \u8fd9\u4e2a\u5c31\u662f\u83b7\u53d6\u6240\u6709pod\u7684\u64cd\u4f5c\nreturn client.CoreV1().Pods(namespace).List(context.TODO(), options)\n},\nWatchFunc: func(options metav1.ListOptions) (watch.Interface, error) {\nif tweakListOptions != nil {\ntweakListOptions(&amp;options)\n}\n// watch\u64cd\u4f5c\nreturn client.CoreV1().Pods(namespace).Watch(context.TODO(), options)\n},\n},\n&amp;corev1.Pod{},\nresyncPeriod,\nindexers,\n)\n}\n</code></pre> <pre><code>func (p *ListPager) List(ctx context.Context, options metav1.ListOptions) (runtime.Object, bool, error) {\nif options.Limit == 0 {\noptions.Limit = p.PageSize\n}\nrequestedResourceVersion := options.ResourceVersion\nrequestedResourceVersionMatch := options.ResourceVersionMatch\nvar list *metainternalversion.List\npaginatedResult := false\nfor {\nselect {\ncase &lt;-ctx.Done():\nreturn nil, paginatedResult, ctx.Err()\ndefault:\n}\nobj, err := p.PageFn(ctx, options)\nif err != nil {\n// Expired #(1)\nif !errors.IsResourceExpired(err) || !p.FullListIfExpired || options.Continue == \"\" {\nreturn nil, paginatedResult, err\n}\n// \u6211\u4eec\u91cd\u65b0\u53d1\u8d77\u8bf7\u6c42\noptions.Limit = 0\noptions.Continue = \"\"\noptions.ResourceVersion = requestedResourceVersion\noptions.ResourceVersionMatch = requestedResourceVersionMatch\nresult, err := p.PageFn(ctx, options)\nreturn result, paginatedResult, err\n}\nm, err := meta.ListAccessor(obj)\nif err != nil {\nreturn nil, paginatedResult, fmt.Errorf(\"returned object must be a list: %v\", err)\n}\nif len(m.GetContinue()) == 0 &amp;&amp; list == nil {\nreturn obj, paginatedResult, nil\n}\nif list == nil {\nlist = &amp;metainternalversion.List{Items: make([]runtime.Object, 0, options.Limit+1)}\nlist.ResourceVersion = m.GetResourceVersion()\nlist.SelfLink = m.GetSelfLink()\n}\n// \u8fd9\u91cc\u5927\u4f53\u4e0a\u662f\u8fd9\u6837\u7684 #(2)\nif err := meta.EachListItem(obj, func(obj runtime.Object) error {\nlist.Items = append(list.Items, obj)\nreturn nil\n}); err != nil {\nreturn nil, paginatedResult, err\n}\nif len(m.GetContinue()) == 0 {\nreturn list, paginatedResult, nil\n}\noptions.Continue = m.GetContinue()\noptions.ResourceVersion = \"\"\noptions.ResourceVersionMatch = \"\"\npaginatedResult = true\n}\n}\n</code></pre> <ol> <li> <p>\u6bd4\u5982\u81ea\u5df1\u6d4b\u8bd5,\u4f60\u5206\u9875\u8bf7\u6c42 \u4f7f\u7528continue \u7b2c\u4e8c\u9875\u7684\u65f6\u5019,\u7b49\u5f85\u4e00\u4e9b\u65f6\u95f4, \u518d\u53d1\u8d77\u8bf7\u6c42</p> <pre><code>{\n\"kind\": \"Status\",\n\"apiVersion\": \"v1\",\n\"metadata\": {\n\"continue\": \"XXXXXXXXXXXXX\"\n},\n\"status\": \"Failure\",\n\"message\": \"The provided continue parameter is too old to display a consistent list result.\n    You can start a new list without the continue parameter, or use the continue token \n    in this response to retrieve the remainder of the results. \n    Continuing with the provided token results in an inconsistent list - objects that were created,\n    modified, or deleted between the time the first chunk was returned and now may show up in the list.\",\n\"reason\": \"Expired\",\n\"code\": 410\n}\n</code></pre> </li> <li> <p>list()\u83b7\u53d6\u7684\u5217\u8868,\u5c06items\u91cc\u6bcf\u4e2a\u6dfb\u52a0\u5230list\u4e2d</p> <pre><code>{\n\"kind\": \"PodList\",\n\"apiVersion\": \"v1\",\n\"metadata\": {\n\"resourceVersion\": \"2871322\"\n},\n\"items\": [\n{},\n{},\n{},\n{}\n]\n}\n</code></pre> </li> </ol> <pre><code>// watchHandler watches w and keeps *resourceVersion up to date.\nfunc (r *Reflector) watchHandler(start time.Time, w watch.Interface, resourceVersion *string, errc chan error, stopCh &lt;-chan struct{}) error {\neventCount := 0\n// Stopping the watcher should be idempotent and if we return from this function there's no way\n// we're coming back in with the same watch interface.\ndefer w.Stop()\nloop:\nfor {\nselect {\ncase &lt;-stopCh:\nreturn errorStopRequested\ncase err := &lt;-errc:\nreturn err\ncase event, ok := &lt;-w.ResultChan():\nif !ok {\nbreak loop\n}\nif event.Type == watch.Error {\nreturn }\nif r.expectedType != nil {\nif e, a := r.expectedType, reflect.TypeOf(event.Object); e != a {\ncontinue\n}\n}\nif r.expectedGVK != nil {\nif e, a := *r.expectedGVK, event.Object.GetObjectKind().GroupVersionKind(); e != a {\ncontinue\n}\n}\nmeta, err := meta.Accessor(event.Object)\nif err != nil {\ncontinue\n}\nnewResourceVersion := meta.GetResourceVersion()\nswitch event.Type {\n// \u6dfb\u52a0\u5230DeltaFIFO \u4e2d\ncase watch.Added:\nerr := r.store.Add(event.Object)\nif err != nil {\n}\ncase watch.Modified:\nerr := r.store.Update(event.Object)\nif err != nil {\n}\ncase watch.Deleted:\nerr := r.store.Delete(event.Object)\nif err != nil {\n}\ncase watch.Bookmark:\n// A `Bookmark` means watch has synced here, just update the resourceVersion\ndefault:\n}\n*resourceVersion = newResourceVersion\nr.setLastSyncResourceVersion(newResourceVersion)\nif rvu, ok := r.store.(ResourceVersionUpdater); ok {\nrvu.UpdateResourceVersion(newResourceVersion)\n}\neventCount++\n}\n}\nwatchDuration := r.clock.Since(start)\nif watchDuration &lt; 1*time.Second &amp;&amp; eventCount == 0 {\nreturn\n}\nreturn nil\n}\n</code></pre> <pre><code>func (c *controller) processLoop() {\nfor {\nobj, err := c.config.Queue.Pop(PopProcessFunc(c.config.Process))\nif err != nil {\nif err == ErrFIFOClosed {\nreturn\n}\nif c.config.RetryOnError {\nc.config.Queue.AddIfNotPresent(obj)\n}\n}\n}\n}\n</code></pre> Pop()c.config.processs.processor.distribute <pre><code>func (f *DeltaFIFO) Pop(process PopProcessFunc) (interface{}, error) {\nf.lock.Lock()\ndefer f.lock.Unlock()\nfor {\nfor len(f.queue) == 0 {\nif f.closed {\nreturn nil, ErrFIFOClosed\n}\nf.cond.Wait()\n}\nid := f.queue[0] // \u5f39\u51fa\u4e00\u4e2a\nf.queue = f.queue[1:] // \u961f\u5217=\u5269\u4f59\u7684\ndepth := len(f.queue)\nif f.initialPopulationCount &gt; 0 {\nf.initialPopulationCount--\n}\nitem, ok := f.items[id]\nif !ok {\ncontinue\n}\ndelete(f.items, id)\nerr := process(item)\nif e, ok := err.(ErrRequeue); ok {\nf.addIfNotPresent(id, item)\nerr = e.Err\n}\nreturn item, err\n}\n}\n</code></pre> process() \u5904\u7406\u65b9\u6cd5<pre><code>func (s *sharedIndexInformer) Run(stopCh &lt;-chan struct{}) {\n// ...\ncfg := &amp;Config{\nQueue:            fifo,\n//...\nProcess:           s.HandleDeltas,\nWatchErrorHandler: s.watchErrorHandler,\n}\n}\nfunc (s *sharedIndexInformer) HandleDeltas(obj interface{}) error {\ns.blockDeltas.Lock()\ndefer s.blockDeltas.Unlock()\n// from oldest to newest\nfor _, d := range obj.(Deltas) {\nswitch d.Type {\ncase Sync, Replaced, Added, Updated:\ns.cacheMutationDetector.AddObject(d.Object)\nif old, exists, err := s.indexer.Get(d.Object); err == nil &amp;&amp; exists {\n// \u66f4\u65b0\u7f13\u5b58\nif err := s.indexer.Update(d.Object); err != nil {\nreturn err\n}\nisSync := false\nswitch {\ncase d.Type == Sync:\n// Sync events are only propagated to listeners that requested resync\nisSync = true\ncase d.Type == Replaced:\nif accessor, err := meta.Accessor(d.Object); err == nil {\nif oldAccessor, err := meta.Accessor(old); err == nil {\n// Replaced events that didn't change resourceVersion are treated as resync events\n// and only propagated to listeners that requested resync\nisSync = accessor.GetResourceVersion() == oldAccessor.GetResourceVersion()\n}\n}\n}\ns.processor.distribute(updateNotification{oldObj: old, newObj: d.Object}, isSync)\n} else {\nif err := s.indexer.Add(d.Object); err != nil {\nreturn err\n}\ns.processor.distribute(addNotification{newObj: d.Object}, false)\n}\ncase Deleted:\nif err := s.indexer.Delete(d.Object); err != nil {\nreturn err\n}\ns.processor.distribute(deleteNotification{oldObj: d.Object}, false)\n}\n}\nreturn nil\n}\n</code></pre> <pre><code>func (p *sharedProcessor) distribute(obj interface{}, sync bool) {\np.listenersLock.RLock()\ndefer p.listenersLock.RUnlock()\nif sync {\nfor _, listener := range p.syncingListeners {\n// \nlistener.add(obj)\n}\n} else {\nfor _, listener := range p.listeners {\nlistener.add(obj)\n}\n}\n}\n</code></pre> <p>\u524d\u9762informer.run\u4e2d  wg.StartWithChannel(processorStopCh, s.processor.run)</p> <pre><code>func (p *sharedProcessor) run(stopCh &lt;-chan struct{}) {\nfunc() {\np.listenersLock.RLock()\ndefer p.listenersLock.RUnlock()\nfor _, listener := range p.listeners {\np.wg.Start(listener.run)  //(1)\np.wg.Start(listener.pop)\n}\np.listenersStarted = true\n}()\n&lt;-stopCh\np.listenersLock.RLock()\ndefer p.listenersLock.RUnlock()\nfor _, listener := range p.listeners {\nclose(listener.addCh) // Tell .pop() to stop. .pop() will tell .run() to stop\n}\np.wg.Wait() // Wait for all .pop() and .run() to stop\n}\n</code></pre> <ol> <li> <p>listener.run</p> <pre><code>func (p *processorListener) run() {\n// this call blocks until the channel is closed.  When a panic happens during the notification\n// we will catch it, **the offending item will be skipped!**, and after a short delay (one second)\n// the next notification will be attempted.  This is usually better than the alternative of never\n// delivering again.\nstopCh := make(chan struct{})\nwait.Until(func() {\nfor next := range p.nextCh {\nswitch notification := next.(type) {\ncase updateNotification:\n// OnUpdate\u8fd9\u4e9b\u5c31\u662f\u6211\u4eec\u524d\u9762.Informer().AddEventHandler(..)\np.handler.OnUpdate(notification.oldObj, notification.newObj)\ncase addNotification:\np.handler.OnAdd(notification.newObj)\ncase deleteNotification:\np.handler.OnDelete(notification.oldObj)\ndefault:\nutilruntime.HandleError(fmt.Errorf(\"unrecognized notification: %T\", next))\n}\n}\n// the only way to get here is if the p.nextCh is empty and closed\nclose(stopCh)\n}, 1*time.Second, stopCh)\n}\n</code></pre> </li> </ol> <p><code>staging/src/k8s.io/client-go/informers/</code> \u6709\u5404\u79cd\u8d44\u6e90\u7684informer</p>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#informer","title":"informer","text":"<p>Tip</p> <p>inform: \u901a\u77e5 \u7684\u610f\u601d \u6bcf\u4e00\u4e2ak8s\u8d44\u6e90\u4e0a\u90fd\u5b9e\u73b0\u4e86Informer\u673a\u5236 \u901a\u8fc7informer\u4e0eapiserver\u8fdb\u884c\u901a\u4fe1,\u4fdd\u8bc1\u901a\u4fe1\u7684\u5b9e\u65f6\u6027\u3001\u53ef\u9760\u6027\u3001\u987a\u5e8f\u6027\u7b49 informer\u5230\u5e95\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u5462?</p>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_10","title":"\u5148\u770b\u770b\u4e00\u4e2a\u7b80\u5355\u4f8b\u5b50","text":"<pre><code>package main\nimport (\n\"flag\"\n\"fmt\"\n\"path/filepath\"\n\"time\"\n// corev1 \"k8s.io/api/core/v1\"\nmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n\"k8s.io/client-go/informers\"\n\"k8s.io/client-go/kubernetes\"\n\"k8s.io/client-go/tools/cache\"\n\"k8s.io/client-go/tools/clientcmd\"\n\"k8s.io/client-go/util/homedir\"\n)\nfunc main() {\n// fmt.Println(reflect.TypeOf(&amp;corev1.Pod{}))\n// return\nvar kubeconfig *string\nif home := homedir.HomeDir(); home != \"\" {\n// ~/.kube/config \u786e\u4fdd\u4f60\u5bb6\u76ee\u5f55\u4e0b\u6709k8s\u7684\u914d\u7f6e\u6587\u4ef6\n// \u4f60\u672c\u5730\u53ef\u4ee5\u7528kubectl get po \u8fdb\u884c\u67e5\u8be2.\nkubeconfig = flag.String(\"kubeconfig\", filepath.Join(home, \".kube\", \"config\"), \"(optional) absolute path to the kubeconfig file\")\n} else {\nkubeconfig = flag.String(\"kubeconfig\", \"\", \"absolute path to the kubeconfig file\")\n}\nflag.Parse()\n// \u4f7f\u7528\u6307\u5b9a\u7684kubeconfig\u6587\u4ef6\u521b\u5efa\u4e00\u4e2aConfig\u5bf9\u8c61\nconfig, err := clientcmd.BuildConfigFromFlags(\"\", *kubeconfig)\nif err != nil {\npanic(err.Error())\n}\n// \u521b\u5efa\u4e00\u4e2a\u65b0\u7684Kubernetes\u5ba2\u6237\u7aef\nclientset, err := kubernetes.NewForConfig(config)\nif err != nil {\npanic(err.Error())\n}\nstopCh := make(chan struct{})\ndefer close(stopCh)\nsharedInformerFactory := informers.NewSharedInformerFactory(\n// \u9700\u8981\u8fd9\u4e2a \u4e0eapiserver \u4ea4\u4e92\nclientset,\ntime.Minute,\n)\n// \u83b7\u53d6pod\u8d44\u6e90\u7684informer \u5bf9\u8c61,\u76d1\u542c\u8c01\ninformer := sharedInformerFactory.Core().V1().Pods().Informer()\n// informer2 := sharedInformers.Core().V1().Pods().Informer()\ninformer.AddEventHandler(cache.ResourceEventHandlerFuncs{\n// \u521b\u5efapod \u8d44\u6e90\u65f6\u89e6\u53d1\u7684\u4e8b\u4ef6\u56de\u8c03\u65b9\u6cd5\nAddFunc: func(obj interface{}) {\n// k8s\u5b9e\u9645\u8fd9\u91cc\u662f\u5c06 \u4e8b\u4ef6\u63a8\u9001\u5230 workQueue\n// \u6211\u4eec\u4f8b\u5b50\u76f4\u63a5\u6253\u5370\u770b\u770b\nmetav1Obj := obj.(metav1.Object)\nfmt.Println(\"\u65b0\u7684pod\u88ab\u6dfb\u52a0\u5230\u7f13\u5b58\u4e2d\", metav1Obj.GetName())\n},\nDeleteFunc: func(obj interface{}) {\nmetav1Obj := obj.(metav1.Object)\nfmt.Println(\"pod\u4ece\u7f13\u5b58\u4e2d\u5220\u9664\", metav1Obj.GetName())\n},\nUpdateFunc: func(oldObj, newObj interface{}) {\noObj := oldObj.(metav1.Object)\nnObj := newObj.(metav1.Object)\nfmt.Printf(\"%s pod updated to %s\\n\", oObj.GetName(), nObj.GetName())\n},\n})\ninformer.Run(stopCh)\n// sharedInformerFactory.Start(stopCh)\n}\n</code></pre> SharedInformer<pre><code>func (f *podInformer) Informer() cache.SharedIndexInformer {\nreturn f.factory.InformerFor(&amp;corev1.Pod{}, f.defaultInformer)\n}\nfunc (f *sharedInformerFactory) InformerFor(obj runtime.Object, newFunc internalinterfaces.NewInformerFunc) cache.SharedIndexInformer {\ninformerType := reflect.TypeOf(obj)\ninformer, exists := f.informers[informerType]\n// \u5bf9\u4e8e\u540c\u4e00\u4e2a\u7c7b\u578b\u7684\u8d44\u6e90 ,\u4e0d\u9700\u8981\u91cd\u590d\u521b\u5efa\n// \u5b58\u5728\u5c31\u76f4\u63a5\u8fd4\u56de\nif exists {\nreturn informer\n}\nresyncPeriod, exists := f.customResync[informerType]\nif !exists {\nresyncPeriod = f.defaultResync\n}\ninformer = newFunc(f.client, resyncPeriod)\n// \u7b2c\u4e00\u6b21 \u8bbe\u7f6e\nf.informers[informerType] = informer\nreturn informer\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#reflector","title":"Reflector","text":"","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#bookmark-event","title":"Bookmark event","text":"<p>watch bookmark</p> <p>pod list \u540e, watch \u91cc\u6bd4\u5982\u4e00\u76f4\u6ca1\u6709pod\u8d44\u6e90\u7684\u4e8b\u4ef6, \u5176\u4ed6\u8d44\u6e90\u7684\u4e8b\u4ef6\u5f88\u591a\u5bfc\u81f4 resourceVersion \u53d8\u5927\u4e86\u5f88\u591a, \u7136\u540e\u7531\u4e8ek8s etcd 5\u5206\u949f\u5c31\u4f1acompact, \u7136\u540e\u67d0\u4e2a\u65f6\u5019 pod \u7684informer \u51fa\u4e86\u95ee\u9898,\u540e\u91cd\u65b0\u8fde\u63a5, \u6211\u4eec\u9700\u8981\u91cd\u65b0\u5f00\u59cb\u540c\u6b65 ,\u4f7f\u7528list, \u4f1a\u7528\u4e4b\u524d\u5b58\u7684\u6bd4\u8f83\u8001\u7684resourceVersion,\u4f46\u662f\u8fd9\u4e2a\u53ef\u80fd\u5df2\u7ecf\u88abcompact\u8fc7\u7684, \u8fd9\u6837\u4f1a\u5bfc\u81f4\u9519\u8bef,\u7136\u540e\u91cd\u65b0 \u4eceetcd \u5168\u91cf\u62c9\u53d6</p> <p>\u91cd\u8981\u8bf4\u660e</p> <p>\u5b98\u65b9\u6587\u6863\u91cc\u5199\u4e86, \u5c31\u7b97\u4f60\u6307\u5b9a\u4e86allowWatchBookmarks=true \u67e5\u8be2\u53c2\u6570\u6765\u8bf7\u6c42 BOOKMARK \u4e8b\u4ef6, \u4f60\u4e5f\u4e0d\u80fd\u8ba4\u4e3abookmark\u4e8b\u4ef6\u4f1a\u5728\u67d0\u4e00\u4e2a\u7279\u5b9a\u7684\u65f6\u95f4\u95f4\u9694\u89e6\u53d1 http://localhost:8001/api/v1/namespaces/default/pods?watch=1&amp;allowWatchBookmarks=true</p> <pre><code>package main\nimport (\n\"context\"\n\"flag\"\n\"fmt\"\n\"log\"\n\"path/filepath\"\n\"time\"\ncorev1 \"k8s.io/api/core/v1\"\nmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n\"k8s.io/apimachinery/pkg/watch\"\n\"k8s.io/client-go/kubernetes\"\n\"k8s.io/client-go/tools/clientcmd\"\n\"k8s.io/client-go/util/homedir\"\n)\nfunc main() {\nvar kubeconfig *string\nif home := homedir.HomeDir(); home != \"\" {\nkubeconfig = flag.String(\"kubeconfig\", filepath.Join(home, \".kube\", \"config\"), \"(optional) absolute path to the kubeconfig file\")\n} else {\nkubeconfig = flag.String(\"kubeconfig\", \"\", \"absolute path to the kubeconfig file\")\n}\nflag.Parse()\nconfig, err := clientcmd.BuildConfigFromFlags(\"\", *kubeconfig)\nif err != nil {\npanic(err.Error())\n}\nclientset, err := kubernetes.NewForConfig(config)\nif err != nil {\npanic(err.Error())\n}\nwatcher, err := clientset.CoreV1().Pods(\"\").Watch(context.TODO(), metav1.ListOptions{\n// LabelSelector: \"app=pod-vol,run=test\",\nAllowWatchBookmarks: true,\nResourceVersion:     \"2937860\", // ResourceVersion \u5982\u679c\u5df2\u7ecf\u88ab\u538b\u7f29\u8fc7, \u4e0d\u4f1a\u62a5\u9519\n})\nif err != nil {\nlog.Fatal(err)\n}\nLoop:\nfor {\nselect {\ncase event := &lt;-watcher.ResultChan():\n// meta, err := meta.Accessor(event.Object)\n// newResourceVersion := meta.GetResourceVersion()\n// meta, _ := meta.Accessor(event.Object)\npod, ok := event.Object.(*corev1.Pod)\nnewResourceVersion := pod.GetResourceVersion()\nif !ok {\nfmt.Println(\"xxxx::\", pod)\n}\nswitch event.Type {\ncase watch.Added:\nfmt.Printf(\"Pod %s added: %s,%s\\n\", pod.Name, pod.GetResourceVersion(), pod.ResourceVersion)\ncase watch.Modified:\nfmt.Printf(\"Pod %s modified: %s,%s\\n\", pod.Name, pod.GetResourceVersion(), pod.ResourceVersion)\ncase watch.Deleted:\nfmt.Printf(\"Pod deleted: %s\\n\", pod.Name)\ncase watch.Bookmark:\nfmt.Println(\"book:\", pod.Name, time.Now().Format(\"15:04:05\"), newResourceVersion)\n}\ncase &lt;-time.After(6660 * time.Second):\nfmt.Println(9999)\nbreak Loop\n}\n}\n}\n</code></pre> \u6267\u884c\u7684\u7ed3\u679c...<pre><code>book:  16:15:22 2939960\n\nbook:  16:16:22 2939960\n\nbook:  16:17:22 2939960\n\nbook:  16:18:22 2939960\n\nbook:  16:19:22 2939960\n</code></pre> <p>\u4ee3\u7801\u8fd8\u6ca1\u6709\u7ec6\u770b,\u56de\u7b54\u6682\u65f6\u90fd\u662f\u6211\u7684\u731c\u6d4b</p> <ul> <li>\u95ee:<ul> <li>\u6839\u636e\u4ee3\u7801\u6d4b\u8bd5, \u53d1\u73b0\u5927\u69821\u5206\u949f(\u6839\u636e\u4e0a\u9762\u7684\u91cd\u8981\u8bf4\u660e,\u8fd9\u4e2a\u4e0d\u7528\u7ea0\u7ed3\u5b83)\u80fd\u63a5\u6536\u5230bookmark \u4e8b\u4ef6, \u4f46\u662f\u6536\u5230\u7684resourceVersion \u4e00\u76f4\u90fd\u662f\u65e7\u7684, \u5f88\u4e45\u540e\u7684bookmark\u4e8b\u4ef6\u6536\u5230\u7684resourceVersion \u624d\u662f\u7a0d\u5fae\u65b0\u4e00\u70b9\u7684, \u8fd9\u548c\u6211\u4eec\u4e0a\u9762\u8bf4\u7684bookmark\u7684\u76ee\u7684\u6709\u70b9\u76f8\u8fdd\u80cc\u4e86?</li> </ul> </li> <li>\u7b54:<ul> <li>\u6211\u4eec\u8bbf\u95ee\u7684\u662f\u5b9e\u9645\u662fAPIServer(\u6570\u636e\u5b83\u7ed9\u7684), APIServer \u4e5f\u6709 listAndWatch, \u4eceetcd\u90a3\u91cc\u83b7\u53d6\u6570\u636e\u7f13\u5b58\u5230\u5b83\u7684\u672c\u5730, \u800c\u5982\u679c\u6ca1\u6709\u5bf9\u5e94\u7684\u4e8b\u4ef6, apiserver\u7f13\u5b58\u5c31\u4e0d\u4f1a\u66f4\u65b0resourceVersion, etcd\u662f\u6ca1\u6709bookmark \u4e8b\u4ef6\u7684, bookmark\u662fapiserver\u8bbe\u8ba1\u63d0\u4f9b\u7ed9\u5176\u4ed6\u5ba2\u6237\u7aef\u7684\u4e00\u79cd\u4e8b\u4ef6.</li> <li>\u6211\u4eec\u8bbf\u95ee <code>http://localhost:8001/api/v1/namespaces/default/pods?resourceVersion=2939961</code> \u4f1a\u53d1\u73b0\u63d0\u793aToo large resource version,\u6240\u4ee5\u9996\u5148\u4e0a\u9762\u7684\u7ed3\u679c\u4e00\u76f4\u6ca1\u53d8\u662f\u5bf9\u7684,\u56e0\u4e3aapiserver\u672c\u8eab\u5c31\u6ca1\u6709\u66f4\u65b0resourceVersion, \u7136\u800c\u5b9e\u9645\u4e0a etcd\u5df2\u7ecfcompact\u4e86, \u8fd9\u4e2a\u7248\u672c\u5728etcd\u91cc\u5df2\u7ecf\u4e0d\u5b58\u5728\u4e86.</li> <li>\u4e0d\u540c\u8d44\u6e90\u66f4\u65b0\u540e\u8bbe\u7f6e\u81ea\u5df1\u66f4\u65b0\u65f6\u7684resourceVersion,\u5728\u4e0a\u9762\u7684\u73af\u5883\u4e2d,<code>k create sa sa-test ,\u518d\u83b7\u53d6\u5b83\u7684resourceVersion rv</code>,<code>http://localhost:8001/api/v1/namespaces/default/serviceaccounts?resourceVersion=rv</code> ok, \u53bb <code>pods?resourceVersion=rv</code> \u62a5\u9519Too large resource version</li> <li>\u9700\u8981\u518d\u786e\u8ba4</li> </ul> </li> <li>\u95ee:<ul> <li>\u5982\u679c\u4e00\u76f4\u6ca1\u6709\u5bf9\u5e94\u4e8b\u4ef6, apiserver\u4e0d\u53ef\u80fd\u4e00\u76f4\u4e0d\u66f4\u65b0resourceVersion, \u90a3\u4e48\u5927\u6982\u591a\u4e45?</li> </ul> </li> <li>\u7b54:<ul> <li>10\u5206\u949f?  <code>cmd/kube-apiserver/app/server.go</code></li> <li><code>versionedInformers = clientgoinformers.NewSharedInformerFactory(clientgoExternalClient, 10*time.Minute)</code></li> <li>\u6211\u7ed9\u51fa\u7684\u7b54\u6848\u53ef\u80fd\u662f\u4e0d\u5bf9\u7684, \u6211\u5148\u6807\u8bb0\u4e00\u4e0b,\u540e\u7eed\u7b49\u770bapiserver \u6e90\u7801\u518d\u4fee\u6539.</li> </ul> </li> </ul> \u5173\u4e8e\u95f4\u96941\u5206\u949f<pre><code>// staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go\nfunc (t *watcherBookmarkTimeBuckets) addWatcher(w *cacheWatcher) bool {\nnextTime, ok := w.nextBookmarkTime(t.clock.Now(), t.bookmarkFrequency)\n//...\n}\nfunc newTimeBucketWatchers(clock clock.Clock, bookmarkFrequency time.Duration) *watcherBookmarkTimeBuckets {\nreturn &amp;watcherBookmarkTimeBuckets{\nwatchersBuckets:   make(map[int64][]*cacheWatcher),\ncreateTime:        clock.Now(),\nstartBucketID:     0,\nclock:             clock,\nbookmarkFrequency: bookmarkFrequency,\n}\n}\nfunc NewCacherFromConfig(config Config) (*Cacher, error) {\n//...\ncacher := &amp;Cacher{\n// ...\nbookmarkWatchers: newTimeBucketWatchers(config.Clock, defaultBookmarkFrequency),\n}\n}\nvar (\ndefaultBookmarkFrequency = time.Minute\n)\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#deltafifo","title":"DeltaFIFO","text":"<p>Tip</p> <p>\u524d\u9762\u6211\u4eec\u770b\u5230, Reflector \u901a\u8fc7 ListAndWatch \u5c06\u6570\u636e\u5148\u90fd\u6dfb\u52a0\u5230 DeltaFIFO \u8fd9\u4e2a\u961f\u5217\u4e2d\u53bb\u4e86  \u63a5\u4e0b\u6765\u770b\u770b\u8fd9\u4e2a\u7684\u5177\u4f53\u60c5\u51b5 delta: \u5728\u6570\u5b66\u4e2d\u8868\u793a\u53d8\u5316\u91cf</p> <p></p> DeltaFIFO <ol> <li>items\u5b58\u653e\u7684</li> </ol> <p><pre><code>type Deltas []Delta\n// \u5b58\u653e\u7684\u8d44\u6e90\u5bf9\u8c61\u7684\u53d8\u5316\ntype Delta struct {\nType   DeltaType // \u53d8\u5316\u7684\u7c7b\u578b\nObject interface{}\n}\ntype DeltaType string\nconst (\nAdded   DeltaType = \"Added\"\nUpdated DeltaType = \"Updated\"\nDeleted DeltaType = \"Deleted\"\nReplaced DeltaType = \"Replaced\"\nSync DeltaType = \"Sync\"\n)\n</code></pre> 2. keyFunc</p> <pre><code>func NewDeltaFIFOWithOptions(opts DeltaFIFOOptions) *DeltaFIFO {\nif opts.KeyFunction == nil {\n// \u83b7\u53d6key\u7684\u65b9\u6cd5\nopts.KeyFunction = MetaNamespaceKeyFunc\n}\nf := &amp;DeltaFIFO{\nitems:        map[string]Deltas{},\nqueue:        []string{},\nkeyFunc:      opts.KeyFunction,\nknownObjects: opts.KnownObjects,\nemitDeltaTypeReplaced: opts.EmitDeltaTypeReplaced,\n}\nf.cond.L = &amp;f.lock\nreturn f\n}\nfunc MetaNamespaceKeyFunc(obj interface{}) (string, error) {\nif key, ok := obj.(ExplicitKey); ok {\nreturn string(key), nil\n}\nmeta, err := meta.Accessor(obj)\nif err != nil {\nreturn \"\", fmt.Errorf(\"object has no meta: %v\", err)\n}\nif len(meta.GetNamespace()) &gt; 0 {\n// \u5982\u679c\u6709\u547d\u540d\u7a7a\u95f4 \u5219key = \u547d\u540d\u7a7a\u95f4/\u8d44\u6e90\u5b9a\u4e49\u91cc\u7684name\nreturn meta.GetNamespace() + \"/\" + meta.GetName(), nil\n}\n// \u6709\u4e9b\u8d44\u6e90\u662f\u6ca1\u6709\u547d\u540d\u7a7a\u95f4\u7684\nreturn meta.GetName(), nil\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#workqueue","title":"Workqueue","text":"","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#indexer","title":"indexer","text":"","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_11","title":"\u81ea\u5b9a\u4e49\u63a7\u5236\u5668","text":"<p>\u53c2\u8003 <code>pkg/controller/replicaset/replica_set.go</code></p> <p>Tip</p> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u662f\u5f53\u4f60\u521b\u5efa\u4e00\u4e2aservice ,\u6ca1\u6709\u5173\u8054\u7684pod \u65f6,\u81ea\u52a8\u521b\u5efapod, \u7b80\u5355\u7684demo,\u8f83\u7c97\u7cd9</p>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#_12","title":"\u4ee3\u7801","text":"<pre><code>\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 main.go\n\u2514\u2500\u2500 pkg\n    \u2514\u2500\u2500 controller.go\n</code></pre> <p>main.go<pre><code>package main\nimport (\n\"ctrl01/pkg\"\n\"flag\"\n\"path/filepath\"\n\"time\"\n// corev1 \"k8s.io/api/core/v1\"\n\"k8s.io/client-go/informers\"\n\"k8s.io/client-go/kubernetes\"\n\"k8s.io/client-go/rest\"\n\"k8s.io/client-go/tools/clientcmd\"\n\"k8s.io/client-go/util/homedir\"\n)\nfunc main() {\nvar kubeconfig *string\nif home := homedir.HomeDir(); home != \"\" {\n// ~/.kube/config \u786e\u4fdd\u4f60\u5bb6\u76ee\u5f55\u4e0b\u6709k8s\u7684\u914d\u7f6e\u6587\u4ef6\n// \u4f60\u672c\u5730\u53ef\u4ee5\u7528kubectl get po \u8fdb\u884c\u67e5\u8be2.\nkubeconfig = flag.String(\"kubeconfig\", filepath.Join(home, \".kube\", \"config\"), \"(optional) absolute path to the kubeconfig file\")\n} else {\nkubeconfig = flag.String(\"kubeconfig\", \"\", \"absolute path to the kubeconfig file\")\n}\nflag.Parse()\n// \u4f7f\u7528\u6307\u5b9a\u7684kubeconfig\u6587\u4ef6\u521b\u5efa\u4e00\u4e2aConfig\u5bf9\u8c61\nconfig, err := clientcmd.BuildConfigFromFlags(\"\", *kubeconfig)\nif err != nil {\n// \u6211\u4eec\u5f53\u8fd9\u79cd\u60c5\u51b5\u662f\u5728\u96c6\u7fa4\u5185\u90e8, \u4f7f\u7528\u96c6\u7fa4\u5185\u90e8\u7684\u914d\u7f6e\n// \u5c31\u662fpod \u7684\u5f62\u5f0f \u8fd0\u884c\u6211\u4eec\u8fd9\u4e2acontroller \u4f1a\u7528\u5230\u7684\u914d\u7f6e\u8def\u5f84\nconfig, err = rest.InClusterConfig()\nif err != nil {\npanic(err.Error())\n}\n}\n// \u521b\u5efa\u4e00\u4e2a\u65b0\u7684Kubernetes\u5ba2\u6237\u7aef\nclientset, err := kubernetes.NewForConfig(config)\nif err != nil {\npanic(err.Error())\n}\nstopCh := make(chan struct{})\ndefer close(stopCh)\nsharedInformerFactory := informers.NewSharedInformerFactory(\n// \u9700\u8981\u8fd9\u4e2a \u4e0eapiserver \u4ea4\u4e92\nclientset,\ntime.Minute,\n)\n// \u83b7\u53d6pod\u8d44\u6e90\u7684informer \u5bf9\u8c61,\u76d1\u542c\u8c01\nserviceInformer := sharedInformerFactory.Core().V1().Services()\npodInformer := sharedInformerFactory.Core().V1().Pods()\nc := pkg.NewController(clientset, serviceInformer, podInformer)\nsharedInformerFactory.Start(stopCh)\n// \u7b49\u5f85\u6570\u636e\u540c\u6b65\u5230DeltaFifo \u5b8c\u6210\u540e\nsharedInformerFactory.WaitForCacheSync(stopCh)\n// \u6211\u4eec\u624d\u6267\u884c\u8fd9\u4e2a\nc.Run(stopCh)\n}\n</code></pre> controller.go<pre><code>package pkg\nimport (\n\"context\"\n\"fmt\"\n\"reflect\"\n\"time\"\ncorev1 \"k8s.io/api/core/v1\"\nmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n\"k8s.io/apimachinery/pkg/labels\"\n\"k8s.io/apimachinery/pkg/selection\"\nutilruntime \"k8s.io/apimachinery/pkg/util/runtime\"\n\"k8s.io/apimachinery/pkg/util/sets\"\n\"k8s.io/apimachinery/pkg/util/wait\"\ncoreInformerV1 \"k8s.io/client-go/informers/core/v1\"\n\"k8s.io/client-go/kubernetes\"\ncoreListerV1 \"k8s.io/client-go/listers/core/v1\"\n\"k8s.io/client-go/tools/cache\"\n\"k8s.io/client-go/util/workqueue\"\n)\ntype controller struct {\nclient        kubernetes.Interface\npodLister     coreListerV1.PodLister\nserviceLister coreListerV1.ServiceLister\nqueue         workqueue.RateLimitingInterface\n}\n/*\n\u6211\u4eec\u4e3b\u8981\u5c31\u662f\u7f16\u5199\u63a7\u5236\u5668\n\u5b9a\u4e49\u76f8\u5173\u7684informer \u8868\u793a\u7528\u6765\u83b7\u53d6\u4ec0\u4e48\u7c7b\u578b\u7684\u8d44\u6e90\n\u7136\u540e\u5173\u5fc3\u8fd9\u4e9b\u8d44\u6e90\u53d8\u5316, \u5c06\u76d1\u542c\u5230\u7684\u5bf9\u5e94\u4e8b\u4ef6\u5904\u7406\u51fd\u6570\u5199\u4e0a\n*/\nfunc NewController(client kubernetes.Interface, serviceInformer coreInformerV1.ServiceInformer, podInformer coreInformerV1.PodInformer) controller {\nc := controller{\nclient,\npodInformer.Lister(),\nserviceInformer.Lister(),\n// \u524d\u9762 controller-manager \u67b6\u6784\u91cc \u8bf4\u8fc7\n// DeltaFifo \u6d88\u8d39\u65f6 \u6570\u636e\u6ca1\u6709\u76f4\u63a5\u5904\u7406,\u800c\u662f\u5148\u653e\u5230\u5de5\u4f5c\u961f\u5217\u4e2d\nworkqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), \"serviceWorkqueue\"),\n}\nserviceInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{\nAddFunc:    c.addService,\nUpdateFunc: c.updateService,\n})\n// podInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{\n//  DeleteFunc: c.deletePod,\n// })\nreturn c\n}\nfunc (c *controller) addService(obj interface{}) {\nmetav1Obj := obj.(metav1.Object)\nfmt.Println(\"\u65b0\u7684service\u88ab\u6dfb\u52a0\u5230\u7f13\u5b58\u4e2d\", metav1Obj.GetName())\nc.enqueue(obj)\n}\nfunc (c *controller) updateService(oldObj, newObj interface{}) {\nmetav1Obj := oldObj.(metav1.Object)\nmetav1NewObj := newObj.(metav1.Object)\nfmt.Println(\"service update\", metav1Obj.GetName(), metav1NewObj.GetName())\n// \u5982\u679c\u66f4\u65b0\u6765\u7684\u6570\u636e\u548c\u65e7\u7684\u4e00\u6837, \u5c31\u4e0d\u505a\u64cd\u4f5c\nif reflect.DeepEqual(oldObj, newObj) {\nreturn\n}\nfmt.Println(\"\u66f4\u65b0\u6709\u53d8\u5316, \u6dfb\u52a0\u5230\u5de5\u4f5c\u961f\u5217: \", metav1NewObj.GetName())\nc.enqueue(newObj)\n}\nfunc (c *controller) deletePod(obj interface{}) {\n// todo\n}\nvar workers = 5\n// \u5904\u7406\u5de5\u4f5c\u961f\u5217\nfunc (c *controller) Run(stopCh chan struct{}) {\nfor i := 0; i &lt; workers; i++ {\ngo wait.Until(c.worker, time.Minute, stopCh)\n}\n&lt;-stopCh\n}\nfunc (c *controller) worker() {\nfor c.processNextItem() {\n}\n}\nfunc (c *controller) processNextItem() bool {\n// \u4ece\u961f\u5217\u4e2d\nitem, shutdown := c.queue.Get()\nif shutdown {\nreturn false\n}\ndefer c.queue.Done(item)\nkey := item.(string)\nerr := c.syncService(key)\nif err == nil {\nc.queue.Forget(key)\nreturn true\n}\nutilruntime.HandleError(fmt.Errorf(\"sync %q failed with %v\", key, err))\nc.queue.AddRateLimited(key)\nreturn true\n}\n// syncService \u8fd9\u91cc\u5c31\u662f\u7b80\u5355\u6d4b\u8bd5, \u5199\u7684\u5f88\u968f\u610f\n// \u8fd9\u91cc\u4e3b\u8981\u529f\u80fd\u662f \u6839\u636e\u521b\u5efa\u7684service \u7684label selector,\u5982\u679c\u6ca1\u6709\u5bf9\u5e94\u7684pod, \u5219\u521b\u5efa\u4e00\u4e2a\u5173\u8054\u7684pod.\n//  \u8bf7\u53c2\u8003k8s\u6e90\u7801 \u6bd4\u5982 ReplicaSetController.syncReplicaSet()\nfunc (c *controller) syncService(key string) error {\n// \u4ecekey \u4e2d\u83b7\u53d6 namespace \u548c name\nnamespace, name, err := cache.SplitMetaNamespaceKey(key)\nif err != nil {\nreturn err\n}\n// \u83b7\u53d6service \u5bf9\u8c61\nservice, err := c.serviceLister.Services(namespace).Get(name)\nselectorLabelValue, ok := service.Spec.Selector[\"nginx-pod\"]\nif !ok {\nreturn nil\n}\n//\nservicePodsRequire, err := labels.NewRequirement(\"nginx-pod\",\nselection.Equals,\nsets.NewString(selectorLabelValue).List())\nif err != nil {\nreturn err\n}\nservicePodsRequires := []labels.Requirement{\n*servicePodsRequire,\n}\n// \u4ece\u7f13\u5b58 \u4e2d\u83b7\u53d6pod\npods, err := c.podLister.\nPods(namespace).\nList(labels.NewSelector().Add(servicePodsRequires...))\nif err != nil {\nreturn err\n}\nfmt.Println(\"len\", len(pods))\nif len(pods) &gt; 0 {\nfmt.Println(\"exists\", pods[0].GetName())\nreturn nil\n}\npod := &amp;corev1.Pod{\nObjectMeta: metav1.ObjectMeta{\nName:      name + \"-pod\",\nNamespace: namespace,\nLabels: map[string]string{\n\"nginx-pod\": selectorLabelValue,\n},\n},\nSpec: corev1.PodSpec{\nContainers: []corev1.Container{\n{\nName:            \"my-container\",\nImage:           \"nginx:1.14.2\",\nImagePullPolicy: corev1.PullIfNotPresent,\n},\n},\n},\n}\np, err := c.client.CoreV1().\nPods(namespace).\nCreate(context.TODO(), pod, metav1.CreateOptions{})\nif err != nil {\nreturn err\n}\nfmt.Printf(\"\u521b\u5efa\u4e86 service %s \u5173\u8054\u7684 pod: %s\\n\", name, p.Name)\nreturn nil\n}\n// \u6dfb\u52a0\u5230\u5de5\u4f5c\u961f\u5217\nfunc (c *controller) enqueue(obj interface{}) {\n// o := obj.(*corev1.Service)\n// \u83b7\u53d6key, \u8fd9\u4e2a\u9ed8\u8ba4\u65b9\u6cd5\u662f  namespace/name \u4f5c\u4e3akey\nkey, err := cache.MetaNamespaceKeyFunc(obj)\nif err != nil {\nutilruntime.HandleError(err)\nreturn\n}\nfmt.Println(\"enqueue:\", key)\nc.queue.Add(key)\n}\n</code></pre></p> svc-controller.yaml<pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: svc-controller\nspec:\nselector:\nnginx-pod: abc\ntype: ClusterIP\nports:\n- protocol: TCP\nport: 80\ntargetPort: 80\n</code></pre> <pre><code>go run main.go\nk apply -f svc-controller.yaml\nk get po # \u67e5\u770b\u662f\u5426\u521b\u5efa\u4e86pod\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/controller-manager/#k8s","title":"\u90e8\u7f72\u5230k8s","text":"<p><pre><code>FROM golang:1.18.10-alpine as base\nWORKDIR /test\nCOPY . .\nRUN go env -w GOPROXY=https://goproxy.cn,http://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct \\\n&amp;&amp; go mod tidy \\\n&amp;&amp; GOOS=linux GOARCH=amd64 go build -o my-controller  main.go\nFROM alpine:3.16\nCOPY --from=base /test/my-controller /my-controller\nCMD [\"/my-controller\"]\n</code></pre> <pre><code>docker build -t hb.6o6.com/xyz/mycontroller:1.0 .\n# push \u5230\u4f60\u7684harbor\n# \u5982\u679c\u662f dockerhub , \u8bb0\u5f97 tag \u53d8\u4e0b\n</code></pre></p> <p>\u6ce8\u610f</p> <p>\u56e0\u4e3a\u9ed8\u8ba4\u4f7f\u7528\u7684default sa ,\u53ea\u6709\u547d\u540d\u7a7a\u95f4\u4e0b\u7684view \u6743\u9650, \u5176\u4ed6\u547d\u540d\u7a7a\u95f4\u5c31\u6ca1\u6709\u4e86, \u800c\u6211\u4eec\u4ee3\u7801\u662flist watch\u6240\u6709\u547d\u540d\u7a7a\u95f4,\u4ee5\u53ca\u8fd8\u6709\u521b\u5efapod\u7684\u64cd\u4f5c\u4f7f\u7528 k logs \u53ef\u4ee5\u770b\u5230\u62a5\u9519\u4fe1\u606f \u8fd9\u91cc\u6211\u76f4\u63a5\u7ed9 pod\u9ed8\u8ba4\u4f7f\u7528\u7684sa \u7528\u6237 clusterrolebinding \u7ed1\u5b9a\u4e00\u4e2aclusterrole cluster-admin, \u5f53\u7136\u4e5f\u53ef\u4ee5\u81ea\u5df1\u521b\u5efaclusterrole</p> <p><pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\ncreationTimestamp: null\nname: crb-default-clusterrole-view\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: ClusterRole\nname: cluster-admin\nsubjects:\n- kind: ServiceAccount\nname: default\nnamespace: default\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: deploy-my-controller\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: pod-my-controller\ntemplate:\nmetadata:\nlabels:\napp: pod-my-controller\nspec:\ncontainers:\n- name: c-deploy-controller\nimage: hb.6o6.com/xyz/mycontroller:1.0\nimagePullPolicy: IfNotPresent\nimagePullSecrets:\n- name: regcred\n</code></pre> <pre><code>k apply -f svc-controller.yaml\n</code></pre></p> <ol> <li> <p>get list resourceVersion \u21a9</p> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/component/etcd/","title":"etcd","text":"<p>Tip</p> <p>Etcd\u662fCoreOS\u57fa\u4e8eRaft\u5f00\u53d1\u7684\u5206\u5e03\u5f0fkey-value\u5b58\u50a8\uff0c\u53ef\u7528\u4e8e\u670d\u52a1\u53d1\u73b0\u3001\u5171\u4eab\u914d\u7f6e\u4ee5\u53ca\u4e00\u81f4\u6027\u4fdd\u969c(\u5982\u6570\u636e\u5e93\u9009\u4e3b\u3001\u5206\u5e03\u5f0f\u9501\u7b49)  \u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\uff0c\u5982\u4f55\u7ba1\u7406\u8282\u70b9\u95f4\u7684\u72b6\u6001\u4e00\u76f4\u662f\u4e00\u4e2a\u96be\u9898\uff0cetcd\u50cf\u662f\u4e13\u95e8\u4e3a\u96c6\u7fa4\u73af\u5883\u7684\u670d\u52a1\u53d1\u73b0 \u548c\u6ce8\u518c\u800c\u8bbe\u8ba1\uff0c\u5b83 \u63d0\u4f9b\u4e86\u6570\u636eTTL\u5931\u6548\u3001\u6570\u636e\u6539\u53d8\u76d1\u89c6\u3001\u591a\u503c\u3001\u76ee\u5f55\u76d1\u542c\u3001\u5206\u5e03\u5f0f\u9501\u539f\u5b50\u64cd\u4f5c\u7b49 \u529f\u80fd\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7684\u8ddf\u8e2a\u5e76\u7ba1\u7406\u96c6\u7fa4\u8282\u70b9\u7684\u72b6\u6001</p> <p>Warning</p> <p>todo</p>","tags":["k8s"]},{"location":"devops/k8s/component/etcd/#raft","title":"raft \u534f\u8bae","text":"","tags":["k8s"]},{"location":"devops/k8s/component/etcd/#_1","title":"\u5b89\u88c5","text":"<pre><code>ETCD_VER=v3.4.17\n# DOWNLOAD_URL=https://github.com/etcd-io/etcd/releases/download\nDOWNLOAD_URL=https://repo.huaweicloud.com/etcd/\nrm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz\nrm -rf /tmp/etcd-download-test &amp;&amp; mkdir -p /tmp/etcd-download-test\ncurl -L ${DOWNLOAD_URL}/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz -o /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz\ntar xzvf /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz -C /tmp/etcd-download-test --strip-components=1\n#rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz\n#rm -rf /tmp/etcd-download-test\n# client \u76f8\u5173\u7684 \u662f\u7ed9\u5ba2\u6237\u7aef \u7528\u7684url\n# peer \u662f\u7ed9\u96c6\u7fa4\u8282\u70b9\u4e4b\u95f4\u901a\u4fe1\u7528\u7684\n#\u6211\u4eec\u53ef\u4ee5 \u542f\u52a8, \u4f7f\u7528\u522b\u7684\u7aef\u53e3, \u56e0\u4e3a\u8fd9\u91cc\u6211\u4eec k8s\u5df2\u7ecf\u542f\u52a8\u4e86etcd \u4e86.\n# \u4f1a\u5728\u5f53\u524d\u76ee\u5f55\u4e0b\u521b\u5efa \u4e00\u4e2a default.etcd , \u6765\u5b58\u50a8\u6570\u636e\netcd --listen-client-urls 'http://localhost:12379' \\\n--advertise-client-urls 'http://localhost:12379' \\\n--listen-peer-urls 'http://localhost:12380' \\\n--initial-advertise-peer-urls 'http://localhost:12380' \\\n--initial-cluster 'default=http://localhost:12380'\n# \u5176\u4ed6\u53c2\u6570\n# \u8282\u70b9\u540d\u79f0, \u4e0d\u6307\u5b9a\u7684\u8bdd,\u9ed8\u8ba4\u662fdefault\n--name 'default'\n--data-dir #\u4e0d\u6307\u5b9a\u7684\u8bdd,\u9ed8\u8ba4\u4f1a\u5728\u5f53\u524d\u76ee\u5f55\u4e0b \u7684 default.etcd \u76ee\u5f55\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/etcd/#_2","title":"\u96c6\u7fa4","text":"","tags":["k8s"]},{"location":"devops/k8s/component/etcd/#etcdctl","title":"etcdctl\u4f7f\u7528","text":"\u522b\u540d\u914d\u7f6e<pre><code># etcdctl --endpoints=http://localhost:12379 put a b\n# pod \u5b89\u88c5\u7684etcd ,\u6211\u4eec\u7684\u5bbf\u4e3b\u673a\u4e0a \u8fde\u63a5\nexport ETCDCTL_API=3\netcdctl member list -w table --endpoints=https://localhost:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt  --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key\n\ncat &gt;&gt; /etc/profile &lt;&lt;EOF\nexport ETCDCTL_API=3\nalias e=\"etcdctl --endpoints=https://localhost:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt  --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key\"\nEOF\n# \u542f\u52a8\u4e00\u4e2a\u6d4b\u8bd5\u7528etcd, \u4f7f\u7528\u8fd9\u4e2a\u522b\u540d\u6765\u6d4b\u8bd5\nalias ee=\"etcdctl --endpoints=http://localhost:12379\"\n</code></pre> \u8282\u70b9\u589e\u6539\u67e5\u5220 <pre><code># \u8282\u70b9\u6210\u5458 table \u683c\u5f0f\nee member list -w table\n# json \u683c\u5f0f\u663e\u793a\nee member list -w json\n# \u72b6\u6001\nee endpoint status -w table\n</code></pre> <pre><code>ee put name tom #\u8bbe\u7f6ekey value\nee get name # \u663e\u793akey \u548cvalue\nname\n    tom\nee put name jack # \u6709\u5219\u4fee\u6539,\u65e0\u5219\u589e\u52a0\nee get name -w json\n# etcd \u7684key \u91c7\u7528\u5c42\u6b21\u5316\u7684\u7a7a\u95f4\u7ed3\u6784, \u50cf linux\u7684\u76ee\u5f55\u4e00\u6837\nee put /a a1 --debug # debug\u4fe1\u606f\nee put /a/b ab1\n# \u5e26\u4e0a\u524d\u7f00\u7684 \u67e5\u8be2\nee get --prefix /a # /a \u548c/a/b \u90fd\u4f1a\u67e5\u8be2\u5230\n</code></pre> <pre><code># \u67e5\u770bkey  --keys-only\u53ea\u663e\u793akey\nee get / --prefix  --keys-only\n# \u8fd9\u4e2a\u624d\u4f1a\u663e\u793a\u6240\u6709\u7684key,  put name tom \u8fd9\u79cd\u7684key \u4e5f\u4f1a\u663e\u793a\u51fa\u6765\nee get \"\" --prefix  --keys-only\n</code></pre> <pre><code>ee del name # \u7ed3\u679c\u663e\u793a \u5220\u9664\u7684key\u7684\u4e2a\u6570\nee put /person1/age 11\nee del /person1/age\n# \u4f1a\u5220\u9664\u4ee5/a \u4e3a\u524d\u7f00 \u7684key \u5305\u62ec/a\nee del /a --prefix\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/etcd/#_3","title":"\u7248\u672c\u7ba1\u7406","text":"","tags":["k8s"]},{"location":"devops/k8s/component/etcd/#_4","title":"\u5404\u4e2a\u7248\u672c\u53f7\u7684\u542b\u4e49","text":"<pre><code># \u5168\u65b0,\u6ca1\u6709\u6dfb\u52a0\u8fc7\u4efb\u4f55\u6570\u636e\u7684etcd\n# \u6211\u4eec\u5220\u9664 \u542f\u52a8etcd\u7684\u76ee\u5f55\u4e0b\u7684 default.etcd \u7136\u540e\u91cd\u65b0\u542f\u52a8etcd \u5373\u53ef\n# \u968f\u4fbf get \u4e00\u4e2akey, \u4e0b\u9762\u7684 key a \u662f\u4e0d\u5b58\u5728\u7684\nee get a -w json\n{\"header\":\n    {\n\"cluster_id\":17478742799590499669,\n        \"member_id\":14532165781622267127,\n        \"revision\":1,  #\u4f5c\u7528\u57df\u4e3a\u96c6\u7fa4\uff0c\u903b\u8f91\u65f6\u95f4\u6233\uff0c\u5168\u5c40\u5355\u8c03\u9012\u589e\uff0c\u4efb\u4f55 key \u7684\u589e\u5220\u6539\u90fd\u4f1a\u4f7f\u5176\u81ea\u589e\n\"raft_term\":2\n    }\n}\n# \u6dfb\u52a0\nee put a b\nee get a -w json\n{\n\"header\": {\n\"cluster_id\": 17478742799590499669,\n    \"member_id\": 14532165781622267127,\n    \"revision\": 2, #\u5168\u5c40 \u7248\u672c+1, \u4efb\u4f55\u6dfb\u52a0\u4fee\u6539\u7684\u64cd\u4f5c\u90fd\u4f1a\u81ea\u589e, \u5373\u4f7f\u503c\u6ca1\u6709\u4fee\u6539,\u6bd4\u59822\u6b21 ee put a bb\n\"raft_term\": 2\n},\n  \"kvs\": [\n{\n\"key\": \"YQ==\", # echo YQ== |base64 -d  ==&gt; a\n#\u4f5c\u7528\u57df\u4e3a key, \u503c\u4e3a: \u521b\u5efa\u8fd9\u4e2akey\u65f6\u96c6\u7fa4\u7684\u5168\u5c40Revision, \u76f4\u5230\u5220\u9664\u524d\u90fd\u4fdd\u6301\u4e0d\u53d8\n\"create_revision\": 2,\n      #\u4f5c\u7528\u57df\u4e3a key, \u503c\u4e3a: \u6700\u540e\u4fee\u6539\u8fd9\u4e2akey\u65f6 \u96c6\u7fa4\u7684\u5168\u5c40Revision\n\"mod_revision\": 2,\n      # \u4f5c\u7528\u57df\u4e3a key, \u8fd9\u4e2akey\u521a\u521b\u5efa\u65f6Version\u4e3a1\uff0c\u4e4b\u540e\u6bcf\u6b21\u66f4\u65b0\u90fd\u4f1a\u81ea\u589e\uff0c\u5373\u8fd9\u4e2akey\u4ece\u521b\u5efa\u4ee5\u6765\u66f4\u65b0\u7684\u603b\u6b21\u6570\n\"version\": 1,\n      \"value\": \"Yg==\"  # echo Yg== |base64 -d  ==&gt; b\n}\n],\n  \"count\": 1\n}\n# \u4fee\u6539\nee put a abc\nee get a -w json\n{\n\"header\": {\n\"cluster_id\": 17478742799590499669,\n    \"member_id\": 14532165781622267127,\n    \"revision\": 3,\n    \"raft_term\": 2\n},\n  \"kvs\": [\n{\n\"key\": \"YQ==\",\n      \"create_revision\": 2,\n      \"mod_revision\": 3,\n      \"version\": 2,  #\u8fd9\u4e2akey\u7684\u7b2c2\u4e2a\u7248\u672c\n\"value\": \"YWJj\"\n}\n],\n  \"count\": 1\n}\nee put a hello\nee get a -w json\n{\n\"header\": {\n\"cluster_id\": 17478742799590499669,\n    \"member_id\": 14532165781622267127,\n    \"revision\": 4,\n    \"raft_term\": 2\n},\n  \"kvs\": [\n{\n\"key\": \"YQ==\",\n      \"create_revision\": 2,\n      \"mod_revision\": 4,\n      \"version\": 3,\n      \"value\": \"aGVsbG8=\"\n}\n],\n  \"count\": 1\n}\nee put hello world\nee get hello -w json\n{\n\"header\": {\n\"cluster_id\": 17478742799590499669,\n    \"member_id\": 14532165781622267127,\n    \"revision\": 5,\n    \"raft_term\": 2\n},\n  \"kvs\": [\n{\n\"key\": \"aGVsbG8=\",\n      \"create_revision\": 5, #\u7b49\u4e8e \u5f53\u524d\u7684\u5168\u5c40revision\n\"mod_revision\": 5, #\u7b49\u4e8e \u5f53\u524d\u7684\u5168\u5c40revision\n\"version\": 1,\n      \"value\": \"d29ybGQ=\"\n}\n],\n  \"count\": 1\n}\nee put b bb\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/etcd/#_5","title":"\u83b7\u53d6\u5bf9\u5e94\u7248\u672c\u7684\u6570\u636e","text":"<pre><code># rev=0 \u8868\u793a\u83b7\u53d6\u5f53\u524d\u7248\u672c\u7684k v\nee get a --rev=0\na\n    hello\n# rev \u6307\u5b9a\u7684\u662f\u5168\u5c40\u7248\u672c , \u610f\u601d\u662f\u5728\u90a3\u4e2a\u7248\u672c\u7684\u65f6\u5019, \u8fd9\u4e2akey a \u7684\u503c\u662f\u591a\u5c11\nee get a --rev=2\na\n    b\n# \u6240\u4ee5 \u8fd9\u4e2a\u5f97\u5230\u7684\u662f\u7a7a. \u5168\u5c40rev=1\u7684\u65f6\u5019 a \u8fd8\u6ca1\u521b\u5efa. \u521b\u5efa\u7684\u65f6\u5019revision=2\nee get a --rev=1\n# \u7b49\u5230\u7684\u662f hello, \u56e0\u4e3a\u8fd9\u4e2a\u7248\u672c\u4e0b\nee get a --rev=5\na\n    hello\nee get a --rev=6 # \u8fd9\u4e2a\u4e5f\u662fhello ,\u663e\u7136 \u5168\u5c40\u7248\u672c\u662f6\u7684\u65f6\u5019, a\u7684\u503c\u80af\u5b9a\u662fhello\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/etcd/#_6","title":"\u4ece\u6307\u5b9a\u7248\u672c\u53f7\u8d77\u76d1\u542c","text":"<pre><code># \u53ef\u4ee5\u770b\u5230\u6307\u5b9a\u7248\u672c\u53f7\u4ee5\u53ca\u4e4b\u540e\u7684\u6240\u6709\u7248\u672c\u6570\u636e, \u5982\u679c\u7248\u672c\u5df2\u7ecf\u88abcompact\n# \u4f1a\u63d0\u793a required revision has been compacted\n# \u770b\u540e\u9762\u7684\u5bb9\u91cf\u7ba1\u7406\nee watch a --rev=1 -w json\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/etcd/#_7","title":"\u5bb9\u91cf\u7ba1\u7406","text":"<pre><code># \u5220\u9664 default.etcd\n# \u542f\u52a8\u65f6\u6211\u4eec \u8bbe\u7f6eetcd\u5b58\u50a8\u5927\u5c0f 16M\netcd --listen-client-urls 'http://localhost:12379' \\\n--advertise-client-urls 'http://localhost:12379' \\\n--listen-peer-urls 'http://localhost:12380' \\\n--initial-advertise-peer-urls 'http://localhost:12380' \\\n--initial-cluster 'default=http://localhost:12380' \\\n--quota-backend-bytes=$((16*1024*1024))\nee put a b\n# \u4fee\u6539key x ,\u56e0\u4e3a\u7248\u672c\u7684\u539f\u56e0,\u6bcf\u6b21\u4fee\u6539\u6570\u636e\u90fd\u4f1a\u4fdd\u5b58,\u8fd9\u6837\u5b58\u50a8\u5c31\u6ee1\u4e86\n# \u6ee1\u4e86\u540e\u518dput ,\u4f1a\u62a5\u9519\nwhile true\ndo\ndd if=/dev/urandom bs=1M count=1 | ee put x || break\ndone\n# \u67e5\u770b\u72b6\u6001 , \u53ef\u4ee5\u770b\u5230Errors alarm:NOSPACE\nee endpoint status -w table\n\nee alarm list # \u67e5\u770b\u62a5\u8b66\u4fe1\u606f\nmemberID:14532165781622267127 alarm:NOSPACE\n\n# \u538b\u7f29\u7248\u672c\n# \u8868\u793a\u538b\u7f29\u5230 \u5168\u5c40\u7248\u672c\u7684\u7b2c10\u4e2a\u7248\u672c, \u4e5f\u5c31\u662f, 10\u7248\u672c\u524d\u7684key,\u53ea\u4fdd\u7559\u91cc\u9762\u6700\u65b0\u7248\u672c\u7684\u90a3\u4e2a\u503c\n# \u7136\u540e\u7248\u672c\u5f52\u4e3a 10\n# \u5982\u679c\u662fcompact \u5f53\u524d\u7248\u672c, \u90a3\u4e48\u5c31\u662f\u538b\u7f29\u6210\u5230\u6700\u65b0\u7684\u7248\u672c,key\u5bf9\u5e94\u65e7\u7248\u672c\u7684\u6570\u636e\u5c31\u90fd\u5220\u9664\u4e86,\u53ea\u4fdd\u7559\u6700\u65b0\u7248\u672c\u7684\u503c.\nee compact 10\nee get a --rev 10 # \u5982\u679c\u6307\u5b9a\u7248\u672c\u7684\u8bdd, \u662f\u6307\u5b9a10 \u4e0d\u662f2\n# \u6e05\u7406\u788e\u7247\nee defrag\n\n# \u6e05\u7406alarm  \u89e3\u9664\u62a5\u8b66,\u6ca1\u6709errors\nee alarm disarm\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/etcd/#compact","title":"compact\u914d\u7f6e","text":"<p>\u5355\u72ec\u7684etcd</p> <p><code>/etc/kubernetes/manifests/etcd.yaml</code> \u6dfb\u52a02\u4e2a\u914d\u7f6e\u53ef\u4ee5\u63a7\u5236\u538b\u7f29</p> <pre><code>--auto-compaction-retention=1  # \u6bcf\u4e00\u4e2a\u5c0f\u65f6\u81ea\u52a8\u538b\u7f29\n--auto-compaction-mode=periodic # \u6a21\u5f0f\u662f\u65f6\u95f4\u95f4\u9694, \u53e6\u5916\u4e00\u4e2a\u6a21\u5f0f\u662freversion\u6570\u91cf\n</code></pre> <p>k8s\u4e2d\u7684etcd</p> <p>\u4e0a\u9762\u90a3\u6837\u4fee\u6539\u662f\u65e0\u6548\u7684, \u8fd9\u4e2a\u538b\u7f29\u7684\u64cd\u4f5c,k8s\u4ee3\u7801\u91cc\u7ed9\u5199\u4e861 <code>staging/src/k8s.io/apiserver/pkg/storage/storagebackend/factory/etcd3.go#startCompactorOnce</code></p> cmd/kube-apiserver/app/options/options.go<pre><code>func NewServerRunOptions() *ServerRunOptions {\ns := ServerRunOptions{\nGenericServerRunOptions: genericoptions.NewServerRunOptions(),\nEtcd:                    genericoptions.NewEtcdOptions(\n// NewDefaultConfig() \u91cc\u4f1a\u770b\u5230 DefaultCompactInterval = 5 * time.Minute\nstoragebackend.NewDefaultConfig(kubeoptions.DefaultEtcdPathPrefix, nil)\n),\n..\n}\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/component/etcd/#k8s","title":"\u5173\u4e8ek8s\u4e2d\u7684\u76f8\u5173","text":"<ol> <li> <p>\u6709\u5173k8s\u4e2detcd compact\u7684\u8ba8\u8bba \u21a9</p> </li> <li> <p>etcdctl \u21a9</p> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/component/kubectl/","title":"kubectl","text":"<p>Tip</p> <p>kubectl\u662f\u4e00\u4e2ak8s\u7684\u547d\u4ee4\u884c\u5de5\u5177,\u5b83\u5141\u8bb8\u7528\u6237\u4ee5\u547d\u4ee4\u884c\u7684\u65b9\u5f0f\u4e0ek8s\u4ea4\u4e92,\u9ed8\u8ba4\u8bfb\u53d6\u914d\u7f6e\u6587\u4ef6~/.kube/config kubectl\u4f1a\u5c06\u63a5\u6536\u5230\u7684\u7528\u6237\u8bf7\u6c42\u8f6c\u5316\u4e3arest\u8c03\u7528\u4ee5 rest \u7684\u5f62\u5f0f\u4e0e apiserver \u901a\u8baf</p> <pre><code># \u52a0\u4e0a -v 8\u62169 \u53ef\u4ee5\u770b\u5230 \u52a0\u8f7d\u7684\u54ea\u4e2a\u914d\u7f6e\u6587\u4ef6 \u548c\u5b9e\u9645\u7528\u7684http\u8bf7\u6c42url \u4ee5\u53ca\u8bf7\u6c42\u7684\u53c2\u6570\u548c\u8fd4\u56de\u7ed3\u679c\n# -v 6/7 \u90fd\u53ef\u4ee5\u8bd5\u8bd5.\nk get ns -v 8\nk get ns -v 9\n</code></pre> <pre><code># \u5728\u4efb\u610f\u53ef\u4ee5 \u901a\u8fc7kubectl \u5bf9k8s \u8fdb\u884c\u64cd\u4f5c\u7684\u673a\u5668\u4e0a\nk proxy --accept-hosts=\".*\" --address=0.0.0.0\n# \u7136\u540e\u5c31\u80fd\u76f4\u63a5 curl localhost:8001/...\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/api-resource/","title":"API\u8d44\u6e90","text":"<p>Tip</p> <p>\u672c\u673a(\u5b89\u88c5kubectl\u5e76\u914d\u7f6e\u53ef\u8bbf\u95eek8s\u7684\u4efb\u4f55\u673a\u5668)\u4ee3\u7406\u5230apiserver</p> <pre><code>k proxy --accept-hosts=\".*\" --address=0.0.0.0\n# \u8fd9\u6837\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\ncurl localhost:8001/api/v1/namespaces\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/api-resource/#api","title":"API\u7ec4\u7ec7\u65b9\u5f0f","text":"\u6838\u5fc3\u5bf9\u8c61\u975e\u6838\u5fc3\u5bf9\u8c61 <p>Info</p> <p>\u652f\u6491k8s\u6700\u57fa\u672c\u529f\u80fd\u7684\u5bf9\u8c61,\u6bd4\u5982pod, group\u662f\u7a7a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: nginx\nnamespace: test\nlabels:\napp: nginx\nspec:\ncontainers:\n- name: nginx1\nimage: nginx:1.14.2\nimagePullPolicy: IfNotPresent\n</code></pre> <p>Info</p> <p>\u6bd4\u5982\u5e94\u7528\u90e8\u7f72\u6709\u5173\u7684\u5bf9\u8c61,deployment,group\u662fapps</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: deploy-nginx\nlabels:\napp: nginx\nspec:\nreplicas: 3\nselector:\nmatchLabels:\napp: pod-deploy-nginx\ntemplate:\nmetadata:\nlabels:\napp: pod-deploy-nginx\nspec:\ncontainers:\n- name: c-deploy-nginx\nimage: nginx:1.14.2\nports:\n- containerPort: 80\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/api-resource/#_1","title":"\u5c5e\u6027","text":"<ol> <li> <p>api\u5bf9\u8c61 \u21a9</p> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/core/config/","title":"\u914d\u7f6e\u7ba1\u7406","text":"","tags":["k8s"]},{"location":"devops/k8s/core/config/#configmap","title":"configmap","text":"<p>Tip</p> <p>\u5c31\u662f\u4e3a\u4e86\u914d\u7f6e\u4e0e\u4ee3\u7801\u5206\u79bb. \u4e0d\u540c\u7684pod \u91cc\u67d0\u4e9b\u4e1c\u897f\u53ef\u80fd\u4f7f\u7528\u76f8\u540c\u7684\u914d\u7f6e, \u8fd9\u6837\u53ea\u8981\u5199\u4e00\u6b21, pod\u91cc\u76f4\u63a5\u7528\u5c31\u884c. secret &amp;&amp; configmap \u53ef\u4ee5\u7406\u89e3\u4e3a2\u4e2d\u7279\u6b8a\u7c7b\u578b\u7684\u5b58\u50a8\u5377 configmap\u5b58\u653e\u7684\u65f6\u5019\u660e\u6587\u6570\u636e \u7b80\u79f0 cm</p> <p>configmap</p> <pre><code>k explain cm\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/config/#_1","title":"\u521b\u5efa","text":"","tags":["k8s"]},{"location":"devops/k8s/core/config/#_2","title":"\u57fa\u4e8e\u76ee\u5f55\u6216\u6587\u4ef6","text":"\u73af\u5883\u51c6\u5907<pre><code>cat &gt;game.properties &lt;&lt;EOF\nenemies=aliens\nlives=3\nenemies.cheat=true\nenemies.cheat.level=noGoodRotten\nsecret.code.passphrase=UUDDLRLRBABAS\nsecret.code.allowed=true\nsecret.code.lives=30\nEOF\ncat &gt;ui.properties&lt;&lt;EOF\ncolor.good=purple\ncolor.bad=yellow\nallow.textmode=true\nhow.nice.to.look=fairlyNice\nEOF\ntree\n.\n\u2514\u2500\u2500 cfg\n    \u251c\u2500\u2500 game.properties\n    \u2514\u2500\u2500 ui.properties\n</code></pre> <p>\u521b\u5efa<pre><code># \u57fa\u4e8e\u76ee\u5f55,\u5c31\u662f\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\nk create cm game-all-config --from-file=./cfg/\n# \u57fa\u4e8e\u6587\u4ef6 ,\u9ed8\u8ba4\u662fdefault \u547d\u540d\u7a7a\u95f4, -n \u6307\u5b9a\nk create cm ui-config --from-file=./cfg/ui.properties -n test\n# \u9ed8\u8ba4\u662f\u7528\u6587\u4ef6\u540d\u4f5c\u4e3akey, \u53ef\u4ee5\u6307\u5b9a\nk create cm ui-config-with-key --from-file=ui=./cfg/ui.properties\n# \u57fa\u4e8e\u591a\u4e2a\u6587\u4ef6\nk create cm game-all-config-with-multi \\\n--from-file=./cfg/ui.properties \\\n--from-file=./cfg/game.properties\n</code></pre> \u67e5\u770b<pre><code>k get cm #(1)\nk describe cm game-all-config\nk get cm game-all-config  -o yaml # \u67e5\u770b(2)\n</code></pre></p> <ol> <li>\u7ed3\u679c     <pre><code>NAME                  DATA    AGE\ngame-all-config        2      113s\n</code></pre></li> <li>\u7ed3\u679c     <pre><code>apiVersion: v1\ndata:\ngame.properties: |\nenemies=aliens\nlives=3\nenemies.cheat=true\nenemies.cheat.level=noGoodRotten\nsecret.code.passphrase=UUDDLRLRBABAS\nsecret.code.allowed=true\nsecret.code.lives=30\nui.properties: |\ncolor.good=purple\ncolor.bad=yellow\nallow.textmode=true\nhow.nice.to.look=fairlyNice\nkind: ConfigMap\nmetadata:\ncreationTimestamp: \"2023-07-17T08:16:36Z\"\nname: game-config\nnamespace: default\nresourceVersion: \"906578\"\nuid: a8341d85-c916-40cd-bb5e-0ef334cc31f6\n</code></pre></li> </ol>","tags":["k8s"]},{"location":"devops/k8s/core/config/#env","title":"\u57fa\u4e8e\u6587\u4ef6\u4ee5env\u5f62\u5f0f","text":"<p>Tip</p> <ul> <li>Env \u6587\u4ef6\u5305\u542b\u73af\u5883\u53d8\u91cf\u5217\u8868<ul> <li>Env \u6587\u4ef6\u4e2d\u7684\u6bcf\u4e00\u884c\u5fc5\u987b\u4e3a VAR=VAL \u683c\u5f0f\u3002</li> <li>\u4ee5\uff03\u5f00\u5934\u7684\u884c\uff08\u5373\u6ce8\u91ca\uff09\u5c06\u88ab\u5ffd\u7565\u3002</li> <li>\u7a7a\u884c\u5c06\u88ab\u5ffd\u7565\u3002</li> <li>\u5f15\u53f7\u4e0d\u4f1a\u88ab\u7279\u6b8a\u5904\u7406\uff08\u5373\u5b83\u4eec\u5c06\u6210\u4e3a ConfigMap \u503c\u7684\u4e00\u90e8\u5206\uff09</li> </ul> </li> </ul> \u73af\u5883\u51c6\u5907<pre><code>cat &gt;game-env-file.properties&lt;&lt;EOF\nenemies=aliens\nlives=3\nallowed=\"true\"\nEOF\n</code></pre> \u521b\u5efa<pre><code>#\u4ece k8s 1.23 \u7248\u672c\u5f00\u59cb\uff0ckubectl \u652f\u6301\u591a\u6b21\u6307\u5b9a --from-env-file \u53c2\u6570\u6765\u4ece\u591a\u4e2a\u6570\u636e\u6e90\u521b\u5efa\nk create cm game-env-file \\\n--from-env-file=./cfg/game-env-file.properties\n</code></pre> \u67e5\u770b<pre><code>k get cm game-env-file -o yaml #(1)\n</code></pre> <ol> <li> <p>\u7ed3\u679c</p> <p>\u6ce8\u610f allowed: '\"true\"' \u7684true \u6570\u5b57\u4f1a\u7528\u53cc\u5f15\u53f7</p> <pre><code>apiVersion: v1\ndata:\nallowed: '\"true\"'\nenemies: aliens\nlives: \"3\"\nkind: ConfigMap\nmetadata:\ncreationTimestamp: \"2023-07-17T08:43:55Z\"\nname: game-env-file\nnamespace: default\nresourceVersion: \"908873\"\nuid: 5f8c87a6-9af0-4b7b-8ed3-9018667c338f\n</code></pre> </li> </ol> <pre><code>k create cm mysql-config \\\n--from-literal=mysql.user=root \\\n--from-literal=mysql.port=3306\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/config/#_3","title":"\u57fa\u4e8e\u5b57\u9762\u503c","text":"","tags":["k8s"]},{"location":"devops/k8s/core/config/#yaml","title":"\u57fa\u4e8eyaml\u6587\u4ef6","text":"mysql-cm.yaml<pre><code>apiVersion: v1\nkind: ConfigMap\nimmutable: true #(1)\nmetadata:\nname: mysql-config2\nnamespace: default\ndata: #\u540c\u547d\u4ee4\u521b\u5efa\u7684 --from-literal=database=test --from-literal=port=3306\ndatabase: \"test\"\nport: \"3306\" #(2)\n</code></pre> <ol> <li>\u8bbe\u7f6e\u6210\u4e0d\u53ef\u53d8     <pre><code>\u8fd9\u6837\u4f60\u65e0\u6cd5\u901a\u8fc7`k edit cm` \u4fee\u6539\n\u65e0\u6cd5\u901a\u8fc7\u4fee\u6539yaml\u6587\u4ef6,\u7136\u540eapply -f \u6216 k replace -f\n\u53ef\u4ee5\u7528`k replace --force -f`\n</code></pre></li> <li>\u6570\u5b57\u5fc5\u987b\u7528\u5f15\u53f7\u62ec\u8d77\u6765!!!</li> </ol> <pre><code>k create -f mysql-cm.yaml\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/config/#_4","title":"\u4f7f\u7528","text":"<p>Tip</p> <p>ConfigMap \u4f4d\u4e8e\u786e\u5b9a\u7684\u547d\u540d\u7a7a\u95f4\u4e2d. \u6bcf\u4e2a ConfigMap \u53ea\u80fd\u88ab\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Pod \u5f15\u7528</p>","tags":["k8s"]},{"location":"devops/k8s/core/config/#valuefrom","title":"valueFrom","text":"<p>Tip</p> <p>\u9002\u7528\u4e8e\u4f7f\u7528\u51e0\u4e2a\u73af\u5883\u53d8\u91cf, \u76f4\u63a5\u6ce8\u5165,  \u5982\u679c\u4f60\u540e\u7eed\u4fee\u6539\u4e86configmap, \u662f\u4e0d\u4f1a\u540c\u6b65\u5230pod\u91cc\u7684</p> pod-cm-valuefrom.yaml<pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\nname: special-config\nnamespace: default\ndata:\nhello: world\npython: good\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\nname: cm-mysql\nnamespace: default\ndata:\nmysql_port: \"3306\"\n---\napiVersion: v1\nkind: Pod\nmetadata:\nname: pod-cm-valuefrom\nspec:\ncontainers:\n- name: test-container\nimage: busybox\nimagePullPolicy: IfNotPresent\ncommand: [ \"/bin/sh\", \"-c\", \"env\" ]\nenv:\n- name: tom\nvalue: cat # env\u73af\u5883\u53d8\u91cf,\u6211\u4eec\u5f53\u7136\u53ef\u4ee5\u76f4\u63a5\u8d4b\u503c\n- name: WELCOME\nvalueFrom: # \u4f7f\u7528\u6765\u81eacm\u7684key\nconfigMapKeyRef:\n# \u6307\u5b9a \u5305\u542b\u4f60\u8981\u8d4b\u7ed9 WELCOME \u503c \u7684ConfigMap\nname: special-config\n# \u6307\u5b9a\u4e0e\u53d6\u503c\u76f8\u5173\u7684\u952e\u540d\nkey: hello\n- name: MYSQL_PORT\nvalueFrom:\nconfigMapKeyRef:\nname: cm-mysql\nkey: mysql-port\noptional: false  #(1)\nrestartPolicy: Never\n</code></pre> <ol> <li>\u9ed8\u8ba4\u662ffalse<ul> <li>false:<ul> <li>\u6307\u5b9a\u7684configmap\u4e0d\u5b58\u5728,\u5219pod\u65e0\u6cd5\u542f\u52a8</li> <li>\u6307\u5b9a\u7684key\u4e0d\u5b58\u5728, pod \u4e5f\u65e0\u6cd5\u542f\u52a8</li> </ul> </li> <li>true:  \u8868\u793a\u5982\u679c\u6307\u5b9a\u7684configmap\u6216key \u4e0d\u5b58\u5728, \u53ef\u4ee5\u542f\u52a8pod,\u53ea\u4e0d\u8fc7\u5c31\u662f\u6ca1\u6709\u7528\u5230,key\u65e0\u6548</li> </ul> </li> </ol> <pre><code>k create -f pod-cm-valuefrom.yaml\n# \u6253\u5370 env \u73af\u5883\u53d8\u91cf ,\u53ef\u4ee5\u770b\u5230 WELCOME = world, MYSQL_PORT\u7b49\nk logs pod-cm-valuefrom\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/config/#envfrom","title":"envFrom","text":"<p>Tip</p> <p>\u5c06configmap\u91cc\u6240\u6709\u7684\u4f5c\u4e3a\u73af\u5883\u53d8\u91cf,\u4e5f\u662f\u6ce8\u5165\u7684\u65b9\u5f0f, \u4fee\u6539configmap,\u540c\u6837\u4e0d\u4f1a\u540c\u6b65\u5230pod\u91cc</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\nname: special-config\nnamespace: default\ndata:\nhello: world\npython: good\n---\napiVersion: v1\nkind: Pod\nmetadata:\nname: pod-cm-envfrom\nspec:\ncontainers:\n- name: test-container\nimage: busybox\nimagePullPolicy: IfNotPresent\ncommand: [ \"/bin/sh\", \"-c\", \"env\" ]\nenvFrom:\n- prefix: TEST_ #(1)\nconfigMapRef:\nname: special-config\noptional: true #(2)\nrestartPolicy: Never\n</code></pre> <ol> <li>\u73af\u5883\u53d8\u91cf\u52a0\u4e0a\u524d\u7f00</li> <li>\u9ed8\u8ba4\u662ffalse<ul> <li>false: \u5982\u679c\u6307\u5b9a\u7684configmap\u4e0d\u5b58\u5728,\u5219pod\u65e0\u6cd5\u542f\u52a8</li> <li>true:  \u8868\u793a\u5982\u679c\u6307\u5b9a\u7684cm \u4e0d\u5b58\u5728, \u53ef\u4ee5\u542f\u52a8pod,\u53ea\u4e0d\u8fc7\u5c31\u662f\u6ca1\u6709\u7528\u5230cm</li> </ul> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/core/config/#_5","title":"\u6587\u4ef6\u6302\u8f7d","text":"<p>my.conf<pre><code>server {\n    listen       8099;\n    listen       [::]:8099;\n    server_name  _;\n    root         /usr/share/nginx/html;\n    include /etc/nginx/default.d/*.conf;\n    error_page 404 /404.html;\n    location = /404.html {\n    }\n    error_page 500 502 503 504 /50x.html;\n    location = /50x.html {\n    }\n}\n</code></pre> <pre><code># \u6df7\u5408 \u6765\u521b\u5efa\u4e00\u4e2acm\nk create cm cm-nginx-8099 --from-file=my.conf  --from-literal=mysql.port=3306\n</code></pre></p> <p><pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: cm-vol-1\nnamespace: default\nspec:\ncontainers:\n- image: nginx:alpine\nname: web-server\nvolumeMounts:\n- name: vol-cm-nginx-8099 #\u4f7f\u7528\u7684volume\u7684\u540d\u79f0\nmountPath: /etc/nginx/conf.d/  #\u6302\u8f7d\u5230\u5bb9\u5668\u91cc\u7684\u54ea\u4e2a\u76ee\u5f55, \u6302\u8f7d\u540e\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u539f\u6765\u7684\u6240\u6709\u6587\u4ef6\u5c06\u88ab\u5220\u9664\nreadOnly: true\n- name: vol-cm-nginx-8099 #\u53ef\u4ee5\u6302\u8f7d\u5230\u591a\u4e2a\u76ee\u5f55 ,\u6ca1\u6709\u7684\u8bdd,\u4f1a\u81ea\u52a8\u521b\u5efa\u76ee\u5f55\nmountPath: /etc/nginx/abc/\nreadOnly: true\nvolumes:\n- name: vol-cm-nginx-8099  #volume\u7684\u540d\u79f0\nconfigMap: # \u5b58\u50a8\u5377\u7c7b\u578b\nname: cm-nginx-8099 #cm\u540d\u5b57\nitems: #\u4fee\u6539\u6302\u8f7d\u5230\u5bb9\u5668\u91cc\u7684\u540d\u79f0,\u9ed8\u8ba4\u662fkey\u540d, \u6709\u591a\u4e2akey \u5c31\u6709\u591a\u4e2a\u6587\u4ef6 (\u770b\u4e0b\u9762\u8bf4\u9053\u7684 2\u4e2a\u6587\u4ef6\u8f6f\u8fde\u63a5 )\n- key: my.conf #cm\u91cc\u7684key\u540d\npath: my2.conf    # \u6302\u8f7d\u5230\u5bb9\u5668\u91cc\u7684\u540d\u79f0 \u6700\u7ec8\u662f\u5728 \u4e0a\u9762\u8bbe\u7f6e\u7684mountPath /etc/nginx/conf.d/my2.conf\n- key: mysql.port\npath: mysql_port\nmode: 0666 # \u5355\u72ec\u8bbe\u7f6e\u6743\u9650\ndefaultMode: 0666  #8\u8fdb\u5236   \u6302\u8f7d\u5230\u5bb9\u5668\u91cc\u7684\u6587\u4ef6\u7684\u6743\u9650  \u8bb0\u5f97\u53bb\u770b\u8f6f\u8fde\u63a5\u7684\u539f\u59cb\u6587\u4ef6\u7684\u6743\u9650\u6765\u9a8c\u8bc1\n</code></pre> <pre><code>k exec -it configmap-volume-demo -- ls -l /etc/nginx/conf.d\nlrwxrwxrwx    1 root     root  15 Jul 17 14:27 my2.conf -&gt; ..data/my2.conf  \u5185\u5bb9\u5c31\u662fmy.conf\u6587\u4ef6\u5185\u5bb9\nlrwxrwxrwx    1 root     root  17 Jul 17 14:27 mysql_port -&gt; ..data/mysql_port \u5185\u5bb9\u662f3306\n</code></pre></p> <p>Warning</p> <p>\u8fd9\u79cd\u6587\u4ef6\u6302\u8f7d\u7684\u65b9\u5f0f, \u5982\u679c\u4f60\u7684configmap\u4fee\u6539\u4e86,pod\u91cc\u770b\u5230\u7684\u914d\u7f6e\u4e5f\u4f1a\u662f\u4fee\u6539\u540e\u7684, \u4e0d\u8fc7 \u8fd9\u8fd8\u4e0d\u884c, \u4f60\u7684pod\u91cc\u7684\u7a0b\u5e8f\u5fc5\u987b\u4e5f\u80fd\u591f \u70ed\u52a0\u8f7d\u624d\u884c, (\u5c31\u662f\u80fd\u76d1\u63a7\u914d\u7f6e\u6587\u4ef6\u7684\u53d8\u5316,\u81ea\u52a8\u91cd\u542f)</p>","tags":["k8s"]},{"location":"devops/k8s/core/config/#secret","title":"secret","text":"<p>\u5b98\u65b9\u6587\u6863</p> <p>Tip</p> <p>\u7531\u4e8econfigmap \u662f\u660e\u6587, \u56e0\u6b64\u4e0econfigmap \u6709\u7740\u540c\u6837\u529f\u80fd\u7684 secret \u5c31\u76f8\u5e94\u7684\u8bbe\u8ba1\u51fa\u6765\u4e86. \u4f7f\u7528\u65b9\u6cd5\u4e0e configmap \u7c7b\u4f3c,\u5728yaml\u6587\u4ef6\u4e0a\u628aconfigmap \u6539\u6210 secret,\u5927\u90e8\u5206\u5c31ok\u4e86</p> secret \u7684\u7c7b\u578b \u7c7b\u578b \u63cf\u8ff0 Opaque \u901a\u7528\u578bSecret,\u7528\u6237\u81ea\u5b9a\u4e49\uff0c\u9ed8\u8ba4\u7c7b\u578b kubernetes.io/service-account-token \u4f5c\u7528\u4e8eServiceAccount\uff0c\u5305\u542b\u4e00\u4e2a\u4ee4\u724c\uff0c\u7528\u4e8e\u6807\u8bc6API\u670d\u52a1\u8d26\u6237 kubernetes.io/dockercfg serialized ~/.dockercfg file kubernetes.io/dockerconfigjson \u4e0b\u8f7d\u79c1\u6709\u4ed3\u5e93\u955c\u50cf\u4f7f\u7528\u7684Secret, \u548c\u5bbf\u4e3b\u673a\u7684 ~/.docker/config.json\u4e00\u81f4 ,\u5bbf\u4e3b\u673adocker login\u540e\u5373\u53ef\u4ea7\u751f\u8be5\u6587\u4ef6 kubernetes.io/basic-auth \u7528\u4e8e\u4f7f\u7528\u57fa\u672c\u8ba4\u8bc1(\u8d26\u53f7\u5bc6\u7801)\u7684Secret\uff0c\u53ef\u4ee5\u4f7f\u7528**Opaque**\u53d6\u4ee3 kubernetes.io/ssh-auth \u7528\u4e8e\u5b58\u50a8ssh\u5bc6\u94a5\u7684Secret kubernetes.io/tls \u7528\u4e8e\u5b58\u50a8HTTPS\u57df\u540d\u8bc1\u4e66\u6587\u4ef6\u7684Secret\uff0c\u53ef\u4ee5\u88abIngress\u4f7f\u7528 bootstrap.kubernetes.io/token \u4e00\u79cd\u7b80\u5355\u7684 bearer token,\u7528\u4e8e\u521b\u5efa\u65b0\u96c6\u7fa4\u6216\u5c06\u65b0\u8282\u70b9\u6dfb\u52a0\u5230\u73b0\u6709\u96c6\u7fa4,\u5728\u96c6\u7fa4\u5b89\u88c5\u65f6\u53ef\u7528\u4e8e\u81ea\u52a8\u9881\u53d1\u96c6\u7fa4\u7684\u8bc1\u4e66 <pre><code>kubectl create secret generic mysql-root-password \\\n--from-literal=password=123456  \\\n--from-literal=username=root\nk get secret  #(1)\nk describe secrets  mysql-root-password  #(2)\nk get secrets mysql-root-password  -o yaml #(3)\n#\u6587\u4ef6\u5f62\u5f0f\u521b\u5efa\ncat user.txt\n    root\ncat pass.txt\n    123456\nkubectl create secret generic mysql-root-password2 --from-file=user.txt --from-file=pass.txt\n</code></pre> <ol> <li>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a secret \u7684\u7c7b\u578b\u662f Opaque     <pre><code>NAME                  TYPE    DATA   AGE\nmysql-root-password   Opaque  2      12s\n</code></pre></li> <li>Data \u91cc\u53ea\u663e\u793a\u51e0\u4e2a\u5b57\u8282!     <pre><code>Name:         mysql-root-password\nNamespace:    default\nLabels:       &lt;none&gt;\nAnnotations:  &lt;none&gt;\nType:  Opaque\nData\n====\npassword:  6 bytes\nusername:  4 bytes\n</code></pre></li> <li>Data \u663e\u793a\u7684\u662f\u52a0\u5bc6\u7684     <pre><code>apiVersion: v1\ndata:\npassword: MTIzNDU2\nusername: cm9vdA==\nkind: Secret\nmetadata:\ncreationTimestamp: \"2023-07-18T01:56:16Z\"\nname: mysql-root-password\nnamespace: default\nresourceVersion: \"941954\"\nuid: 51b42a5f-02c8-4cc1-a482-2c6c0eceb3eb\ntype: Opaque\n</code></pre> <pre><code># \u7136\u800c\u90a3\u8fd9\u4e2a\u52a0\u5bc6\u4ec5\u4ec5\u662fbase64 \u53ef\u4ee5\u89e3\u5bc6\n# \u80fd\u591f\u5f97\u5230 \u5bc6\u7801 123456\necho MTIzNDU2 |base64 -d\n</code></pre></li> </ol>","tags":["k8s"]},{"location":"devops/k8s/core/config/#_6","title":"\u6ce8\u610f","text":"<p>\u6211\u4eec\u4e00\u822c\u662f\u7528\u914d\u7f6e\u6587\u4ef6\u6765\u521b\u5efaconfigmap \u524d\u9762\u63d0\u5230\u8fc7,\u771f\u6b63\u7684\u70ed\u66f4\u65b0,\u8fd8\u9700\u8981\u7a0b\u5e8f\u68c0\u6d4b\u81ea\u52a8\u91cd\u542f\u7684\u652f\u6301 \u4f7f\u7528envFrom\u548cvalueFrom\u662f\u65e0\u6cd5\u66f4\u65b0\u73af\u5883\u53d8\u91cf\u7684. \u73af\u5883\u53d8\u91cf\u662f\u542f\u52a8\u5bb9\u5668\u5c31\u5b9a\u4e86\u7684.\u9700\u8981\u91cd\u542f\u5bb9\u5668</p>","tags":["k8s"]},{"location":"devops/k8s/core/controller/","title":"\u63a7\u5236\u5668","text":"","tags":["k8s"]},{"location":"devops/k8s/core/controller/#_1","title":"\u4e3a\u4ec0\u4e48\u6709\u8fd9\u6837\u7684\u8bbe\u8ba1","text":"<ol> <li>\u5047\u8bbe\u4f60\u9700\u8981\u56fa\u5b9a\u6570\u91cf\u7684pod \u8fd0\u884c,\u5982\u679c\u67d0\u4e2a Pod \u5931\u6548\u6216\u88ab\u5220\u9664\uff0c\u4f60\u60f3\u8981\u81ea\u52a8\u521b\u5efa\u65b0\u7684 Pod \u6765\u66ff\u4ee3,\u4ece\u800c\u4fdd\u6301\u5e94\u7528\u7a0b\u5e8f\u7684\u9ad8\u53ef\u7528\u6027</li> <li>\u5047\u5982\u4f60\u60f3\u8981\u6eda\u52a8\u66f4\u65b0, \u60f3\u5e73\u6ed1\u5730\u66f4\u65b0\u5e94\u7528\u7a0b\u5e8f\u7684\u526f\u672c. \u9700\u8981\u5b83\u53ef\u4ee5\u63a7\u5236\u65e7 Pod \u548c\u65b0 Pod \u7684\u5e76\u884c\u8fd0\u884c\u6570\u91cf,\u4ee5\u53ca\u66f4\u65b0\u7684\u901f\u7387,\u4ece\u800c\u907f\u514d\u5e94\u7528\u7a0b\u5e8f\u7684\u4e2d\u65ad\u6216\u8fc7\u8f7d</li> <li>...</li> </ol>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#replicationcontroller","title":"ReplicationController","text":"<p>Warning</p> <p>\u5df2\u7ecf\u4e0d\u63a8\u8350\u7528, \u63a8\u8350\u4f7f\u7528 ReplicaSet</p> \u4f8b\u5b50 <pre><code>apiVersion: v1\nkind: ReplicationController metadata:\nname: nginx\nspec:\nreplicas: 3\nselector:\napp: nginx\ntemplate:\nmetadata:\nname: nginx\nlabels:\napp: nginx\nspec:\ncontainers:\n- name: nginx\nimage: nginx\nports:\n- containerPort: 80\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#replicasetrs","title":"ReplicaSet(RS)","text":"<p>Tip</p> <p>RS\u786e\u4fdd\u4efb\u4f55\u65f6\u95f4\u90fd\u6709\u6307\u5b9a\u6570\u91cf\u7684 Pod \u526f\u672c\u5728\u8fd0\u884c \u4e00\u822c\u4e0d\u4f1a\u5355\u72ec\u53bb\u7528\u7684</p> <p>\u5b98\u65b9\u6587\u6863</p>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#_2","title":"\u521b\u5efa","text":"<pre><code>kubectl explain rs # ReplicaSet\u53ef\u4ee5\u7b80\u5199\u4e3ars\n# \u6211\u4eec\u53d1\u73b0 rs \u5185\u90e8\u6709\u4e2a\u6a21\u677f\u5c5e\u6027,\u770b\u4e0b\u91cc\u9762\u7684,\u5176\u5b9e\u5c31\u662fpod\u7684\u5c5e\u6027\n# pod \u6a21\u677f\u5bf9\u8c61\nkubectl explain rs.spec.template\n\nkubectl api-resources |grep ReplicaSet\n</code></pre> rs-nginx.yaml<pre><code>apiVersion: apps/v1\nkind: ReplicaSet\nmetadata:\nname: rs-nginx\nspec:\nreplicas: 2 #(1)\nselector:     #(2)\nmatchLabels:\napp: rs-pod\ntemplate:  #(3)\nmetadata:\nlabels:\napp: rs-pod   #(4)\nspec:\nrestartPolicy: Always # (5)\ncontainers:\n- name: c-nginx\nimage: nginx:1.14.2\nports:\n- name: http\ncontainerPort: 80\n</code></pre> <ol> <li>\u521b\u5efa\u51e0\u4e2apod\u8d44\u6e90,2\u4e2a\u90fd\u662f\u6309\u7167\u4e0b\u9762\u8bbe\u7f6e\u7684\u6a21\u677f\u6765\u521b\u5efa\u7684,\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e,\u9ed8\u8ba4\u5c31\u662f1</li> <li>\u4f7f\u7528\u4ec0\u4e48\u6837\u7684\u6807\u7b7e \u6765\u9009\u62e9 pod\u5462,\u7b26\u5408\u8fd9\u6837\u7684\u6807\u7b7e\u7684pod \u90fd\u4f1a\u88abrs\u6240\u7ba1\u7406</li> <li>\u5b9a\u4e49pod\u7684\u6a21\u677f</li> <li>\u8fd9\u91cc\u5b9a\u4e49\u7684\u6807\u7b7e\u4e00\u5b9a\u8981\u548c \u4e0a\u9762selector\u5b9a\u4e49\u7684matchlabels\u4e00\u6837</li> <li>Always \u552f\u4e00\u5141\u8bb8\u7684\u53d6\u503c,\u4e5f\u662f\u9ed8\u8ba4\u503c</li> </ol> <pre><code>k create -f rs-nginx.yaml\nk get rs -o wide #(1)\nk get po #(2)\nk get po rs-nginx-hn2jl -o yaml|grep ownerReferences -A 8 -B 10 #(3)\n# \u6211\u4eec\u5220\u9664\u5176\u4e2d\u4e00\u4e2apod \u6765\u770b\u770b\nk delete pod rs-nginx-hn2jl\nk get po # \u53d1\u73b0 \u53c8\u91cd\u65b0\u521b\u5efa\u4e86\u4e00\u4e2apod\n</code></pre> <ol> <li>\u7ed3\u679c     <pre><code>NAME       DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR\nrs-nginx   2         2         2       34s   c-nginx      nginx:1.14.2   app=rs-pod\n</code></pre></li> <li>\u7ed3\u679c \u4f1a\u67092\u4e2apod \u8fd0\u884c     <pre><code>rs-nginx-hn2jl       1/1     Running   0          7m21s\nrs-nginx-xqznf       1/1     Running   0          7m21s\n</code></pre></li> <li>ReplicaSet \u7684\u4fe1\u606f\u88abpod\u8bbe\u7f6e\u5728 metadata \u7684 ownerReferences \u5b57\u6bb5\u4e2d</li> </ol>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#pod","title":"\u8131\u79bb\u6a21\u677f\u7684pod","text":"<p>Tip</p> <p>\u5982\u679c\u6211\u4eec\u521b\u5efa\u4e86\u7b26\u5408rs \u6807\u7b7e\u9009\u62e9\u5668\u7684pod ,\u4f1a\u5982\u4f55\u5462?</p> <ul> <li>\u5148\u521b\u5efars ,\u540e\u521b\u5efa\u8131\u79bb\u6a21\u677f\u7684pod</li> </ul> pod-nginx-single-match-rs.yaml<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nlabels:\napp: rs-pod\nname: pod-nginx-single-match-rs\nnamespace: default\nspec:\ncontainers:\n- image: nginx:1.14.2\nimagePullPolicy: IfNotPresent\nname: c-nginx\nports:\n- containerPort: 80\nname: http\nprotocol: TCP\n</code></pre> <pre><code># \u5b9e\u65f6\u76d1\u63a7pod\u7684\u521b\u5efa\u60c5\u51b5\n# \u6211\u4eec\u4f1a\u53d1\u73b0 \u521b\u5efa\u540e\u4f1a\u5f00\u59cb\u5220\u9664\nk get po -w\n</code></pre> <p>Note</p> <p>\u7531\u4e8e\u8fd9\u4e9b Pod \u6ca1\u6709\u63a7\u5236\u5668\u4f5c\u4e3a\u5176\u5c5e\u4e3b\u5f15\u7528(ownerReferences \u5c5e\u6027),\u5e76\u4e14 \u5176\u6807\u7b7e\u4e0e ReplicaSet \u7684\u9009\u62e9\u7b97\u7b26\u5339\u914d,\u5b83\u4eec\u4f1a\u7acb\u5373\u88ab\u8be5 ReplicaSet \u83b7\u53d6, \u4f46\u662f\u8be5pod \u4f1a\u7acb\u5373\u88ab ReplicaSet \u7ec8\u6b62,\u56e0\u4e3a \u5b83\u4eec\u7684\u5b58\u5728\u4f1a\u4f7f\u5f97 ReplicaSet \u4e2d Pod \u4e2a\u6570\u8d85\u51fa\u5176\u671f\u671b\u503c</p> <ul> <li>\u5148\u521b\u5efa\u7b26\u5408rs\u7684pod, \u518d\u521b\u5efars</li> </ul> <p>\u4f1a\u88abrs \u7ba1\u7406, rs\u6839\u636e\u4f60\u7b26\u5408\u6761\u4ef6\u7684pod\u6570\u91cf,\u518d\u770b\u662f\u5426\u9700\u8981\u521b\u5efars\u4e2d\u6a21\u677f\u7684pod.</p>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#_3","title":"\u5220\u9664","text":"<pre><code># \u53ea\u5220\u9664rs, \u4e0d\u5220\u9664pod\nk delete --cascade=orphan -f rs-nginx.yaml\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#deployment-deploy","title":"Deployment (deploy)","text":"<p>Tip</p> <p>\u4e00\u4e2a Deployment \u4e3a Pod \u548c ReplicaSet \u63d0\u4f9b\u58f0\u660e\u5f0f\u7684\u66f4\u65b0\u80fd\u529b\u3002 \u4f60\u8d1f\u8d23\u63cf\u8ff0 Deployment \u4e2d\u7684 \u76ee\u6807\u72b6\u6001\uff0c\u800c Deployment \u63a7\u5236\u5668\uff08Controller\uff09 \u4ee5\u53d7\u63a7\u901f\u7387\u66f4\u6539\u5b9e\u9645\u72b6\u6001\uff0c \u4f7f\u5176\u53d8\u4e3a\u671f\u671b\u72b6\u6001 \u65e0\u72b6\u6001\u8d44\u6e90\u7ba1\u7406,\u6700\u5e38\u7528\u7684\u63a7\u5236\u5668, \u7ee7\u627f\u4e86rs,\u901a\u8fc7\u63a7\u5236 replicaSet\u6765\u63a7\u5236\u7ba1\u7406pod. \u4ec0\u4e48\u53eb\u65e0\u72b6\u6001? \u65e0\u72b6\u6001\u6307\u7684\u662f\u5bf9\u4e8e\u8bf7\u6c42\u65b9\u7684\u6bcf\u4e2a\u8bf7\u6c42\uff0c\u63a5\u6536\u65b9\u90fd\u5f53\u8fd9\u6b21\u8bf7\u6c42\u662f\u7b2c\u4e00\u6b21\u8bf7\u6c42</p> <p>\u5b98\u65b9\u6587\u6863</p>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#_4","title":"\u521b\u5efa","text":"<pre><code>k get deploy\n# \u8fd9\u6837\u53ef\u4ee5\u5bfc\u51fa \u914d\u7f6e\u6587\u4ef6, \u505a\u4e9b\u4fee\u6539\nk create deploy deploy-nginx \\\n--image=nginx:1.14.2 \\\n--dry-run=client -o yaml &gt; deploy-nginx.yaml </code></pre> deploy-nginx.yaml<pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: deploy-nginx\nlabels:\napp: nginx\nspec:\nreplicas: 3\nselector:\nmatchLabels:\napp: pod-deploy-nginx\ntemplate:\nmetadata:\nlabels:\napp: pod-deploy-nginx\nspec:\ncontainers:\n- name: c-deploy-nginx\nimage: nginx:1.14.2\nports:\n- containerPort: 80\n</code></pre> <pre><code>k create -f deploy-nginx.yaml\nk get deploy #(1)\n# \u6bcf\u4e2adeploy \u90fd\u4f1a\u6709\u4e00\u4e2ars\u63a7\u5236\u5668,\u6765\u5b9e\u9645\u521b\u5efapod\nk get rs #(2)\n</code></pre> <ol> <li>\u7ed3\u679c    <pre><code>NAME           READY   UP-TO-DATE   AVAILABLE   AGE\ndeploy-nginx   3/3     3            3           15s\n</code></pre></li> <li>\u7ed3\u679c    <pre><code>NAME                      DESIRED   CURRENT   READY   AGE\ndeploy-nginx-77d87b4b6c   3         3         3       2m34s \n</code></pre></li> </ol>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#_5","title":"\u66f4\u65b0","text":"<p>\u5982\u4f55\u66f4\u65b0</p> <ol> <li>\u5047\u8bbe\u6211\u4eecdeploy \u7ba1\u7406\u77403\u4e2apod ,3\u4e2anginx pod \u8ba9\u7528\u6237\u8bbf\u95ee, \u8d1f\u8f7d\u5747\u8861</li> <li>\u73b0\u5728\u6211\u4eec\u8981\u66f4\u65b0\u91cc\u9762nginx \u7684\u7248\u672c</li> <li>\u95ee\u9898<ol> <li>\u56e0\u4e3a\u53ea\u6709\u597d\u50cf\u53ea\u80fd\u67093\u4e2a, \u4e0d\u80fd\u8d85\u8fc7, \u6240\u4ee5\u66f4\u65b0\u7684\u65f6\u5019\u5148\u5220\u9664\u4e00\u4e2apod? </li> <li>\u4f46\u662f\u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u56e0\u4e3a\u5220\u9664\u4e00\u4e2apod\u5bfc\u81f4\u7528\u6237\u8bbf\u95ee\u6ee1\u8f7d... \u5c31\u6709\u95ee\u9898\u4e86</li> </ol> </li> <li>\u89e3\u51b3<ol> <li>deploy \u652f\u6301\u4e34\u65f6\u6dfb\u52a0pod, \u652f\u6301\u5728\u6eda\u52a8\u66f4\u65b0\u524d,\u8bbe\u7f6e\u6700\u591a\u591a\u51e0\u4e2a(\u6bd4\u5982\u539f\u6765\u662f3\u4e2a,\u73b0\u5728\u53ef\u4ee5\u662f4\u4e2a),\u548c\u6700\u591a\u5c11\u51e0\u4e2a(\u6bd4\u5982\u539f\u51483\u4e2a,\u73b0\u5728\u81f3\u5c11\u9700\u89812\u4e2apod\u8fd0\u884c)</li> </ol> </li> </ol> \u770b\u4e00\u4e0b\u521b\u5efa\u7684deploy\u7684\u66f4\u65b0\u7b56\u7565<pre><code># \u6211\u4eecyaml\u6ca1\u6709\u6307\u5b9a, \u8fd9\u91cc\u663e\u793a\u7684\u5c31\u662f\u9ed8\u8ba4\u7684.\nk get deployments.apps  deploy-nginx  -o yaml |grep strategy -A 5\nstrategy:\n    rollingUpdate:\n      maxSurge: 25%\n      maxUnavailable: 25%\n    type: RollingUpdate\n\nkubectl explain deploy.spec.strategy\n</code></pre> \u5c5e\u6027 \u503c/\u5b50\u5c5e\u6027 \u63cf\u8ff0 type Recreate \u8fd9\u4e2a\u7b56\u7565\u5c31\u662f\u5148\u5220\u9664,\u518d\u91cd\u5efa,\u8bbe\u7f6e\u8fd9\u4e2a\u503c\u540e rollingUpdate\u5c5e\u6027\u65e0\u6548\u4e86 RollingUpdate \u6eda\u52a8\u66f4\u65b0,\u518d\u53bb\u8bbe\u7f6e \u8bbe\u7f6e rollingUpdate\u5c5e\u6027 RollingUpdate maxSurge \u5728\u66f4\u65b0\u671f\u95f4,\u6700\u591a\u53ef\u4ee5\u591a\u51e0\u4e2a\u53ef\u7528\u6bd4\u5982\u539f\u51483\u4e2a,\u8bbe\u7f6e1,\u5219\u8868\u793a\u6700\u591a\u53ef\u4ee5\u67094\u4e2apod\u4fdd\u6301\u8fd0\u884c,\u539f\u51483\u4e2a,\u8bbe\u7f6e25%,\u5c31\u662f\u80fd\u591a4*25%\u4e5f\u662f1, \u5982\u679c\u4e0d\u8db31,\u5f53\u62101, \u4e5f\u662f\u8868\u793a\u6700\u591a\u53ef\u4ee5\u67094\u4e2apod\u8fd0\u884c maxUnavailable \u5728\u66f4\u65b0\u671f\u95f4,\u6700\u591a\u6709\u51e0\u4e2a\u4e0d\u53ef\u7528,\u539f\u5148\u662f5,\u8fd9\u91cc\u8bbe\u7f6e1,\u5219\u8868\u793a\u81f3\u5c11\u9700\u8981\u67094\u4e2apod\u4fdd\u6301\u8fd0\u884c <pre><code># \u76f4\u63a5\u4fee\u6539 deploy \u4e2dpod\u4f7f\u7528\u7684image\n# --record \u8bb0\u5f55 \u4f1a\u5728 kubectl rollout history deployment demo-nginx \u547d\u4ee4\u4e2d\u663e\u793a,\n# \u4f1a\u5728 CHANGE-CAUSE \u91cc\u663e\u793a \u4f60\u7684\u547d\u4ee4,\u5426\u5219\u663e\u793anone\n# --record will be removed in the future ,\u672a\u6765\u4f1a\u88ab\u79fb\u9664\n# pod-deploy-nginx \u662f\u6a21\u677f\u4e2dpod\u7684\u540d\u5b57 , nginx:1.9.1 \u662f\u65b0\u7684\u955c\u50cf\u540d\nkubectl set image deploy deploy-nginx pod-deploy-nginx=nginx:1.9.1 --record=true\n#  annotations \u91cc\u6709kubernetes.io/change-cause \u4f1a\u663e\u793a\u4e3a\u6700\u65b0\u53d8\u66f4\u7684\u539f\u56e0\n# \u5982\u679c\u4e0a\u9762\u4e0d\u52a0 --record \u5c31\u4e0d\u4f1a\u8bb0\u5f55\u65b0\u7684,\u4f1a\u663e\u793a\u65e7\u7684\nk get deployments.apps deploy-nginx -o yaml|grep annotations -A 5 #(1)\n# \u6216\u4f7f\u7528edit\nkubectl edit deploy deploy-nginx\n# \u6216\nkubectl apply -f deploy-nginx.yaml --record=true\n</code></pre> <ol> <li>\u6ce8\u91ca\u6709\u6dfb\u52a0\u76f8\u5173\u4fe1\u606f     <pre><code>  annotations:\n    deployment.kubernetes.io/revision: \"4\"\n    kubernetes.io/change-cause: kubectl set image deploy deploy-nginx pod-deploy-nginx=nginx:1.9.1\n  --record=true\n</code></pre></li> </ol> <pre><code>k get rs -w\n  # \u4e3a\u4e86 \u65b9\u4fbf\u770b,\u6211\u5c06\u65b0\u7684rs \u540d\u5b57\u4e0b\u9762\u663e\u793a\u4e3a deploy-nginx-new\nNAME                      DESIRED   CURRENT   READY   AGE\n  deploy-nginx-77d87b4b6c   3         3         3       7m38s\n  deploy-nginx--------new   1         0         0       0s\n  deploy-nginx--------new   1         1         0       0s\n  deploy-nginx--------new   1         1         1       85s\n  deploy-nginx-77d87b4b6c   2         3         3       9m52s\n  deploy-nginx--------new   2         1         1       85s\n  deploy-nginx-77d87b4b6c   2         2         2       9m52s\n  deploy-nginx--------new   2         2         1       85s\n  deploy-nginx--------new   2         2         2       2m47s\n  deploy-nginx-77d87b4b6c   1         2         2       11m\n  deploy-nginx--------new   3         2         2       2m47s\n  deploy-nginx-77d87b4b6c   1         1         1       11m\n  deploy-nginx--------new   3         3         2       2m47s\n  deploy-nginx--------new   3         3         3       2m48s\n  deploy-nginx-77d87b4b6c   0         1         1       11m\n  deploy-nginx-77d87b4b6c   0         0         0       11m\n</code></pre> <ol> <li>\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684rs, \u65b0rs\u521b\u5efa\u4e00\u4e2apod, \u65e7\u7684rs \u7f29\u5bb9,\u51cf\u5c11\u4e00\u4e2apod</li> <li>\u7ee7\u7eed\u4ee5\u4e0a\u64cd\u4f5c, \u6700\u7ec8\u65b0\u7684rs \u521b\u5efa\u4e863\u4e2a, \u65e7\u7684\u7f29\u5bb9\u4e3a0</li> </ol> <pre><code>k get deploy  -w\n  NAME           READY   UP-TO-DATE   AVAILABLE   AGE\n  deploy-nginx   3/3     3            3           20m\n  deploy-nginx   3/3     0            3           20m\n  deploy-nginx   3/3     1            3           20m\n  deploy-nginx   4/3     1            4           20m\n  deploy-nginx   3/3     1            3           20m\n  deploy-nginx   3/3     2            3           20m\n  deploy-nginx   4/3     2            4           20m\n  deploy-nginx   3/3     2            3           20m\n  deploy-nginx   3/3     3            3           20m\n  deploy-nginx   4/3     3            4           20m\n  deploy-nginx   3/3     3            3           20m\n\n# \u4e5f\u53ef\u4ee5\u770b\u5230\u76f8\u5173\u7684\u4fe1\u606f, \u901a\u8fc7\u63a7\u5236rs\u7684replicas\u7684\u6570\u91cf\n# \u65b0rs\u5148\u521b\u5efa\u4e00\u4e2apod,\u662f\u56e0\u4e3a \u4e00\u5f00\u59cbreplicas=1\nk describe deploy deploy-nginx\n# \u4e0a\u7ebf\u7684\u72b6\u6001\u5982\u4f55,\u662f\u5426\u66f4\u65b0\u6210\u529f\nk rollout status deploy deploy-nginx\n</code></pre> \u9879\u76ee \u63cf\u8ff0 DESIRED \u7528\u6237\u671f\u671b\u7684 Pod \u526f\u672c\u4e2a\u6570 (spec.replicas \u7684\u503c) CURRENT \u5f53\u524d\u5904\u4e8e Running \u72b6\u6001\u7684 Pod \u7684\u4e2a\u6570, pull image \u65f6\u671f\u5c31\u5c5e\u4e8erunning\u72b6\u6001 READY pod\u5df2\u7ecf\u542f\u52a8\u53ef\u4ee5\u63d0\u4f9b\u670d\u52a1\u7684\u72b6\u6001 UP-TO-DATE \u5f53\u524d\u5904\u4e8e\u6700\u65b0\u7248\u672c\u7684 Pod \u7684\u4e2a\u6570(\u6240\u8c13\u6700\u65b0\u7248\u672c\u6307\u7684\u662fPod\u7684Spec\u90e8\u5206\u4e0eDeployment\u91cc Pod \u6a21\u677f\u91cc\u5b9a\u4e49\u7684\u5b8c\u5168\u4e00\u81f4) AVAILABLE \u5f53\u524d\u5df2\u7ecf\u53ef\u7528\u7684 Pod \u7684\u4e2a\u6570(Running \u72b6\u6001,\u53c8\u662f\u6700\u65b0\u7248\u672c,\u5e76\u4e14\u5df2\u7ecf\u5904\u4e8e Ready(\u5065\u5eb7\u68c0\u67e5\u6b63\u786e)\u72b6\u6001\u7684 Pod \u7684\u4e2a\u6570)\u5e94\u7528\u53ef\u4f9b\u7528\u6237\u4f7f\u7528\u7684\u526f\u672c\u6570","tags":["k8s"]},{"location":"devops/k8s/core/controller/#_6","title":"\u56de\u6eda","text":"<p>Tip</p> <p>\u524d\u9762\u66f4\u65b0\u90a3\u91cc\u6211\u4eec\u4f1a\u770b\u5230,\u66f4\u65b0\u6210\u529f\u540e, \u65e7\u7684rs \u4e0d\u4f1a\u88ab\u5220\u9664. \u6709\u4ec0\u4e48\u7528\u5462?</p> <pre><code># \u6211\u4eec\u518d\u770b\u770b \nk describe deployments.apps deploy-nginx  | grep  annotation -iA 3\nAnnotations:            deployment.kubernetes.io/revision: 9\nkubernetes.io/change-cause: kubectl set image deploy deploy-nginx pod-deploy-nginx=nginx:1.9.1 --record=true\n# \u67e5\u770bdeploy-nginx \u7684\u4e0a\u7ebf\u5386\u53f2, \u663e\u793a\u7684\u76f8\u5173\u4fe1\u606f\u5bf9\u5e94\u4e0a\u9762\u7684\u7248\u672c\u53f7\u548c change-cause\nk  rollout history deployment deploy-nginx\n  1         kubectl set image deploy deploy-nginx pod-deploy-nginx=nginx:1.9.1 --record=true\n2         kubectl set image deploy deploy-nginx pod-deploy-nginx=nginx:1.14.1 --record=true\n# \u8868\u793a\u9ed8\u8ba4\u4fdd\u755910\u4e2a\u5386\u53f2\u8bb0\u5f55 \u53ef\u4ee5\u7528\u4e8e\u56de\u6eda, \u53ef\u4ee5\u5728\u521b\u5efadeploy\u65f6\u6307\u5b9a\n# 0 \u7684\u8bdd,\u8868\u793a\u4e0d\u4fdd\u7559\nk get deployments.apps deploy-nginx  -o yaml  | grep revisionHistoryLimit\n  revisionHistoryLimit: 10 #\u6211\u4eec\u518d\u505a\u4e00\u6b21\u66f4\u65b0, \u6ca1\u6709record,\nkubectl set image deploy deploy-nginx pod-deploy-nginx=nginx:latest\nk  rollout history deployment deploy-nginx\n  REVISION  CHANGE-CAUSE\n  1         kubectl set image deploy deploy-nginx pod-deploy-nginx=nginx:1.9.1 --record=true\n2         kubectl set image deploy deploy-nginx pod-deploy-nginx=nginx:1.14.2 --record=true\n3        kubectl set image deploy deploy-nginx pod-deploy-nginx=nginx:1.14.2 --record=true # \u8fd9\u91cc\u8fd8\u662f\u7528\u7684\u65e7\u7684.\n# \u524d\u9762\u8bf4\u5230 --record \u4f1a\u5e9f\u5f03, \u90a3\u4e48\u5b9e\u9645\u4e0a\u5c31\u662f\u7ed9deploy \u6dfb\u52a0\u4e00\u4e2aannotation\n# \u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u6dfb\u52a0\u4f60\u8fd9\u4e2a\u66f4\u65b0\u7684\u539f\u56e0. \u4ec5\u4f5c\u4e3a\u6ce8\u91ca.\nk annotate deploy deploy-nginx  kubernetes.io/change-cause='kubectl set image deploy deploy-nginx pod-deploy-nginx=nginx:latest'\n# \u4f1a\u5148\u662f3\u4e2ars. \u90fd\u4fdd\u7559\u7740 \u7528\u6765\u56de\u6eda\u7528\u7684.\n# rs \u7684\u914d\u7f6e\u91cc\u9762image\u7528\u7684\u4e4b\u524d\u7684nginx \u7248\u672c.\nk get rs\n\n# \u67e5\u770b\u67d0\u4e2a\u7248\u672c\u7684\u8be6\u60c5\nk rollout history deployment deploy-nginx --revision=1\n# \u56de\u6eda\u5230\u4e0a\u4e00\u4e2a\u7248\u672c\nk rollout undo deploy deploy-nginx\nk get rs # \u5bf9\u5e94\u7684rs\u5c31\u4f1a\u521b\u5efapod\u4e86.\n# \u56de\u6eda\u5230\u6307\u5b9a\u7248\u672c\nk rollout undo deploy deploy-nginx  --to-revision=2\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#_7","title":"\u6269\u5bb9","text":"<pre><code>k scale deployment deploy-nginx --replicas=4\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#_8","title":"\u6682\u505c\u548c\u6062\u590d","text":"<p>Tip</p> <p>\u5982\u679c\u4f60\u662f\u7528\u547d\u4ee4\u4fee\u6539, \u9700\u8981\u591a\u6b21\u64cd\u4f5c,\u6bd4\u5982\u4e00\u6b21\u4fee\u6539\u4e86image,\u4e00\u6b21\u4fee\u6539\u4e86cpu\u4ec0\u4e48\u7684. \u4f60\u4e0d\u5e0c\u671b\u4fee\u6539\u540e\u5c31\u9a6c\u4e0a\u91cd\u5efapod,\u5219\u53ef\u4ee5\u5148\u6682\u505c, \u5f53\u7136\u4f60\u76f4\u63a5edit \u4e00\u6b21\u5168\u90e8\u4fee\u6539\u5c31\u5f97\u4e86.  \u8fd9\u4e2a\u5c31\u662f\u4f60\u81ea\u52a8\u5316\u64cd\u4f5c\u7684\u65f6\u5019\u53ef\u80fd\u5c31\u6709\u7528\u4e86. \u6211\u4eec\u4e00\u822c\u4f1a\u5728cicd\u91cc\u4f7f\u7528\u8bf8\u5982 kubectl set ...</p> <pre><code>kubectl rollout pause deploy deploy-nginx\n\n..... \u505a\u4e86\u4fee\u6539\u540e\n\nkubectl rollout resume deploy deploy-nginx\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#statefulsetsts","title":"statefulset(sts)","text":"<p>Tip</p> <p>\u524d\u9762\u6211\u4eec\u8bf4\u5230\u7684pod\u63a7\u5236\u5668\u90fd\u662f\u65e0\u72b6\u6001\u7684,\u5173\u6ce8\u7684\u662f\u7fa4\u4f53(\u7fa4\u4f53\u91cc\u7684\u4e2a\u4f53\u90fd\u662f\u4e00\u6837\u7684,\u6240\u4ee5\u628a\u6574\u4e2a\u7fa4\u4f53\u5f53\u6210\u4e00\u4e2a\u4e2a\u4f53) statefulset \u5173\u6ce8\u4e2a\u4f53 StatefulSet(\u6709\u72b6\u6001\u96c6)\u5e38\u7528\u4e8e\u90e8\u7f72\u6709\u72b6\u6001\u7684\u4e14\u9700\u8981\u6709\u5e8f\u542f\u52a8\u7684\u5e94\u7528\u7a0b\u5e8f</p> <p>StatefulSet \u7684\u6838\u5fc3\u529f\u80fd,\u5c31\u662f\u901a\u8fc7\u67d0\u79cd\u65b9\u5f0f\u8bb0\u5f55\u8fd9\u4e9b\u72b6\u6001,\u7136\u540e\u5728 Pod \u88ab\u91cd\u65b0\u521b \u5efa\u65f6\uff0c\u80fd\u591f\u4e3a\u65b0 Pod \u6062\u590d\u8fd9\u4e9b\u72b6\u6001.</p>","tags":["k8s"]},{"location":"devops/k8s/core/controller/#daemonset-ds","title":"daemonSet (ds)","text":"","tags":["k8s"]},{"location":"devops/k8s/core/controller/#job","title":"job","text":"","tags":["k8s"]},{"location":"devops/k8s/core/controller/#cronjob","title":"cronjob","text":"","tags":["k8s"]},{"location":"devops/k8s/core/persistence/","title":"\u5b58\u50a8\u7ba1\u7406","text":"","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#_1","title":"\u5377\u6302\u8f7d","text":"<p>Tip</p> <ol> <li>\u5bb9\u5668\u4e2d\u7684\u78c1\u76d8\u6587\u4ef6\u662f\u77ed\u6682\u7684,\u5bb9\u5668\u91cd\u542f\u540e,\u4f1a\u4ee5\u6700\u5e72\u51c0\u7684\u72b6\u6001\u542f\u52a8,\u4e4b\u524d\u7684\u6587\u4ef6\u5c31\u4f1a\u4e22\u5931</li> <li>\u4e00\u4e2apod\u91cc\u6709\u591a\u4e2a\u5bb9\u5668,\u53ef\u80fd\u9700\u8981\u5171\u4eab\u4e00\u4e9b\u6587\u4ef6\u7684\u60c5\u51b5</li> <li>\u6570\u636e\u9700\u8981\u6301\u4e45\u5316\u7684\u60c5\u51b5</li> </ol> <pre><code>kubectl explain pod.spec.volumes\n# \u6ce8\u610f\u8fd9\u4e2a\u662f pod\u7684\nkubectl explain pod.spec.volumes.emptyDir\n# \u5b9a\u4e49\u5b8c pod\u7684\u540e,\u6211\u4eec\u9700\u8981\u5b9a\u4e49pod\u4e2d\u5bb9\u5668\u7684 volume mount\nkubectl explain pod.spec.containers.volumeMounts\n</code></pre> <p>\u5b98\u65b9\u6587\u6863</p>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#emptydir","title":"emptyDir","text":"<p>Tip</p> <ol> <li>\u5f53 Pod \u56e0\u4e3a\u67d0\u4e9b\u539f\u56e0\u88ab\u4ece\u8282\u70b9\u4e0a\u5220\u9664\u65f6\uff0cemptyDir \u5377\u4e2d\u7684\u6570\u636e\u4e5f\u4f1a\u88ab\u6c38\u4e45\u5220\u9664</li> <li>\u5bb9\u5668\u5d29\u6e83\u91cd\u542f\u5e76\u4e0d\u4f1a\u5bfc\u81f4 Pod \u88ab\u4ece\u8282\u70b9\u4e0a\u79fb\u9664\uff0c\u56e0\u6b64\u5bb9\u5668\u5d29\u6e83\u671f\u95f4 emptyDir \u5377\u4e2d\u7684\u6570\u636e\u662f\u5b89\u5168</li> <li>\u5b9e\u9645\u662f\u5c06\u8282\u70b9\u4e0a\u7684\u76ee\u5f55\u6302\u8f7d\u5230 Pod \u4e2d\u7684\u4e0d\u540c\u5bb9\u5668\u7684\u4e0d\u540c\u6216\u76f8\u540c\u4f4d\u7f6e,\u6240\u4ee5\u4ed6\u4eec\u53ef\u4ee5\u5171\u4eab\u6570\u636e,\u56e0\u4e3a\u5b9e\u9645\u8bfb\u7684\u662f\u8282\u70b9\u4e0a\u7684\u76ee\u5f55</li> </ol> <pre><code># \u521b\u5efa\u4e00\u4e2apod ,\u91cc\u9762\u67092\u4e2a\u5bb9\u5668,\u4e00\u4e2a\u5199\u5165\u6570\u636e\u5230index.html\n# \u4e00\u4e2a\u8bfb\u53d6\napiVersion: v1\nkind: Pod\nmetadata:\nname: pod-vol-empty-dir\n# namespace: test\nspec:\nvolumes:\n- name: html\nemptyDir: {}\n#emptyDir:\n#   medium: Memory\ncontainers: # \u8fd9\u91cc\u914d\u7f6e\u4e862\u4e2a\u5bb9\u5668,\u6302\u8f7d\u5230\u81ea\u5df1\u5bb9\u5668\u91cc\u4e0d\u540c\u7684\u76ee\u5f55\n- name: nginx-c\nimage: nginx:1.12-alpine\nvolumeMounts:\n- name: html          # \u8fd9\u4e2a\u5fc5\u987b\u662f\u4e0a\u9762\u5b9a\u4e49\u7684volumes\u4e2d\u7684name\nmountPath: /usr/share/nginx/html # \u6302\u8f7d\u5230\u5bb9\u5668\u91cc\u7684\u54ea\u4e2a\u76ee\u5f55\n- name: make-page-c\nimage: alpine\nvolumeMounts:\n- name: html\nmountPath: /html # \u6302\u8f7d\u5230\u4e0d\u540c\u7684\u76ee\u5f55\ncommand: [\"/bin/sh\", \"-c\"]\nargs:\n- while true; do\necho $(hostname) $(date) &gt;&gt; /html/index.html;\nsleep 10;\ndone\n</code></pre> \u67e5\u770b\u5377\u5728\u8282\u70b9\u4e2d\u7684\u4f4d\u7f6e<pre><code>k get po -o wide # \u5148\u770b\u5728\u54ea\u4e2a\u8282\u70b9\nk get po pod-vol-empty-dir -o yaml\n    uid: 8c809c4c-6b74-4088-b416-d7dd11743cdb\n# \u53bb\u5bf9\u5e94\u7684\u8282\u70b9\u4e0a\ncd /var/lib/kubelet/pods/8c809c4c-6b74-4088-b416-d7dd11743cdb\ntree -L 2\n.\n  \u251c\u2500\u2500 containers\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 make-page-c\n  \u2502\u00a0\u00a0 \u2514\u2500\u2500 nginx-c\n  \u251c\u2500\u2500 etc-hosts\n  \u251c\u2500\u2500 plugins\n  \u2502\u00a0\u00a0 \u2514\u2500\u2500 kubernetes.io~empty-dir\n  \u2514\u2500\u2500 volumes\n      \u251c\u2500\u2500 kubernetes.io~empty-dir\n      \u2514\u2500\u2500 kubernetes.io~projected\ntree volumes/kubernetes.io~empty-dir\n  volumes/kubernetes.io~empty-dir\n  \u2514\u2500\u2500 html\n      \u2514\u2500\u2500 index.html\n# \u5728 \u8fd9\u4e2a\u8282\u70b9\u4e0a\u7684html\u76ee\u5f55\u589e\u52a0\u6587\u4ef6, 2\u4e2a\u5bb9\u5668\u90fd\u80fd\u770b\u5230\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#hostpath","title":"hostPath","text":"<p>Tip</p> <p>\u5c06\u4e3b\u673a\u8282\u70b9\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u6302\u8f7d\u5230\u4f60\u7684 Pod \u4e2d</p> <p>hostPath</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: test-pd\nspec:\ncontainers:\n- image: nginx:1.14.2\nname: test-container\nvolumeMounts:\n- mountPath: /usr/share/nginx/html\nname: test-volume\nvolumes:\n- name: test-volume\nhostPath:\n# \u5bbf\u4e3b\u4e0a\u76ee\u5f55\u4f4d\u7f6e\npath: /nginx_html\n#  \u5982\u679c\u5bbf\u4e3b\u673a\u4e0a\u6ca1\u6709 \u8be5\u76ee\u5f55\u5219\u521b\u5efa\ntype: DirectoryOrCreate\n</code></pre> <pre><code>k get po -o wide\n  test-pd             1/1     Running   0          78s   10.244.1.45   node1\n# \u5230\u76f8\u5e94\u7684\u8282\u70b9\u4e0a\necho hello &gt; /nginx_html/index.html\ncurl 10.244.1.45 # \u663e\u793ahello\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#nfs","title":"nfs","text":"<p>Tip</p> <p>nfs \u5377\u80fd\u5c06 NFS (\u7f51\u7edc\u6587\u4ef6\u7cfb\u7edf) \u6302\u8f7d\u5230\u4f60\u7684 Pod \u4e2d\u3002 \u4e0d\u50cf emptyDir \u90a3\u6837\u4f1a\u5728\u5220\u9664 Pod \u7684\u540c\u65f6\u4e5f\u4f1a\u88ab\u5220\u9664\uff0cnfs \u5377\u7684\u5185\u5bb9\u5728\u5220\u9664 Pod \u65f6\u4f1a\u88ab\u4fdd\u5b58\uff0c\u5377\u53ea\u662f\u88ab\u5378\u8f7d\u3002 \u8fd9\u610f\u5473\u7740 nfs \u5377\u53ef\u4ee5\u88ab\u9884\u5148\u586b\u5145\u6570\u636e\uff0c\u5e76\u4e14\u8fd9\u4e9b\u6570\u636e\u53ef\u4ee5\u5728 Pod \u4e4b\u95f4\u5171\u4eab</p> \u670d\u52a1\u7aef\u5b89\u88c5<pre><code>#\u5728\u4e00\u53f0\u4e3b\u673a\u4e0a\u5b89\u88c5 ,\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u7528\u4e00\u4e2a\u8282\u70b9\u6765. (\u5f53\u7136\u5982\u679c\u4f60\u670d\u52a1\u5668\u591a.\u5c31\u7528\u4e00\u4e2a\u65b0\u7684.)\n# \u8fd9\u91cc\u6211\u4eec\u7528node1\u8282\u70b9\nyum install nfs-utils rpcbind -y\nsystemctl start nfs-server\n# \u67e5\u770b\u5f53\u524dnf\u670d\u52a1\u6240\u652f\u6301\u7684\u7248\u672c\ncat /proc/fs/nfsd/versions\n\n# 1. \u521b\u5efa\u4e00\u4e2a\u4f60\u8981\u5171\u4eab\u7684\u76ee\u5f55\nmkdir -p /data/nfs\nchown 755 /data/nfs\n#nfsnobody \u5b89\u88c5\u542f\u52a8nfs\u670d\u52a1\u540e\u6709\u7684\u4e00\u4e2a\u7528\u6237\nchown -R nfsnobody.nfsnobody /data/nfs\nsystemctl start nfs systemctl start  rpcbind\n\n# *\u53f7 \u4f4d\u53ef\u4ee5\u8bbe\u7f6e\u6210ip\u6bb5 192.168.124.0/24 \u8868\u793a\u8fd9\u4e9bip\u6bb5\u7684\u624d\u53ef\u4ee5\u8bbf\u95ee\necho \"/data/nfs *(rw,sync,no_subtree_check,no_root_squash)\" &gt;&gt; /etc/exports\n# \u8fd9\u4e2a\u4e0d\u884c...\n#echo \"/data/nfs *(rw,sync,all_squash)\" &gt;&gt; /etc/exports\nexportfs -r # \u66f4\u65b0\u914d\u7f6e,\u91cd\u65b0\u8bfb\u53d6\u914d\u7f6e\nexportfs #\u663e\u793a\u5171\u4eab\u4e86\u54ea\u4e9b\u76ee\u5f55\nsystemctl restart nfs\nsystemctl restart  rpcbind\necho \"hello\" &gt; /data/nfs/index.html\n</code></pre> \u5176\u4ed6\u8282\u70b9\u4e0a\u6302\u8f7d<pre><code># node1 \u7684ip\u5730\u5740 192.168.66.110\n# /nfs \u4f60\u672c\u5730\u60f3\u8981\u6302\u8f7d\u5230\u7684\u76ee\u5f55, \u968f\u4fbf\u521b\u5efa\u4e00\u4e2a, \u9700\u8981\u6709\nmkdir /nfs\nmount -t nfs -o rw,nosuid,noexec,nodev 192.168.66.110:/data/nfs /nfs\nll /nfs # \u80fd\u770b\u5230index.html\n</code></pre> pod-vol-nfs.yaml<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pod-vol-nfs\nlabels:\napp: nginx\nspec:\ncontainers:\n- name: nginx\nimage: nginx:1.14.2\nvolumeMounts:\n- mountPath: /usr/share/nginx/html\nname: nginx-data\nvolumes:\n- name: nginx-data\nnfs:\nserver: 192.168.66.110 # \u5c31\u662fnfs\u670d\u52a1\u7aef\u7684ip\npath: /data/nfs  #nfs\u670d\u52a1\u5668\u91cc \u5171\u4eab\u7684\u76ee\u5f55\n</code></pre> <pre><code>k create -f  pod-vol-nfs.yaml\n# curl pod ip \u53ef\u4ee5\u770b\u5230hello\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#downwardapi","title":"downwardAPI","text":"","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#_2","title":"\u6295\u5c04\u5377","text":"<p>\u5b98\u65b9\u6587\u6863</p>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#pv-pvc","title":"pv pvc","text":"","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#_3","title":"\u6982\u5ff5","text":"<p>Tip</p> <ul> <li>\u4e00\u4e2apod \u53ef\u4ee5\u5173\u8054\u591a\u4e2apvc, \u4e00\u4e2apvc \u53ea\u80fd\u7ed1\u5b9a\u4e00\u4e2apv, \u4e00\u4e2apv \u53ef\u4ee5\u88ab\u591a\u4e2apvc \u7ed1\u5b9a</li> </ul>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#pv","title":"\u521b\u5efapv","text":"pv-nfs-1.yaml<pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\nname: pv-nfs-1\nlabels:\nrelease: stable\nspec:\ncapacity: #(1)\nstorage: 100Mi #(2)\nvolumeMode: Filesystem #(9)\naccessModes: #(3)\n- ReadWriteMany\n# storageClassName: nfsslow  #(4)\npersistentVolumeReclaimPolicy: Retain #(5)\nnfs: #(6)\npath:  \"/data/nfs\" #(7)\nserver: 192.168.66.110 #(8)\n</code></pre> <ol> <li>\u5bb9\u91cf\u914d\u7f6e,\u5e76\u4e0d\u662f\u8bf4\u4f60\u8bbe\u7f6e\u591a\u5c11,\u5c31\u53ea\u80fd\u7ed9\u8fd9\u4e48\u591a, \u8fd9\u9700\u8981\u4f60\u7684\u540e\u7aef\u5b58\u50a8\u7684\u652f\u6301</li> <li>Gi\u8868\u793a\u4ee51024 \u6765\u7b97\u7684, \u5982\u679c\u51995G\u8868\u793a\u4ee51000\u6765\u7b97</li> <li>\u8be5PV\u7684\u8bbf\u95ee\u6a21\u5f0f, ReadWriteMany(\u8868\u793a\u53ef\u4ee5\u88ab\u591a\u4e2anode\u8282\u70b9\u8bfb\u5199,\u6709\u4e9b\u652f\u6301,\u6709\u4e9b\u4e0d\u652f\u6301) ReadWriteOnce \u7b49</li> <li>pv\u7684\u7c7b\u578b,\u591a\u4e2a\u4e0d\u540c\u7684pv\u53ef\u4ee5\u6709\u76f8\u540c\u7684\u7c7b\u578b,\u7528\u4e8ePVC \u60f3\u8981\u7ed1\u5b9a\u4ec0\u4e48\u7c7b\u578b\u7684pv,pvc\u8bbe\u7f6e\u7684\u65f6\u5019\u4e5f\u6709\u8fd9\u4e2a\u5b57\u6bb5,\u5199\u4e0a\u5b83\u60f3\u8981\u7684pv\u7c7b\u578b</li> <li> <p>pv\u56de\u6536\u7b56\u7565</p> \u7b56\u7565 \u63cf\u8ff0 Retain \u9ed8\u8ba4\u5c31\u662fRetain,\u5c31\u662f\u8bf4\u5220\u9664pvc\u7684\u65f6\u5019,\u4ed6\u7ed1\u5b9a\u7684pv\u4fdd\u7559,\u6570\u636e\u4e5f\u4fdd\u7559 Recycle \u8868\u793apv\u91cc\u6570\u636e\u5220\u9664,\u4f46\u662fpv\u8fd8\u662f\u4fdd\u7559\u7684. k8s\u4f1a\u521b\u5efa\u4e00\u4e2apod .\u91cc\u9762\u6709rm \u547d\u4ee4 \u6765\u8fdb\u884c\u5bf9\u6570\u636e\u5220\u9664 delete \u5220\u9664pvc\u65f6, \u540c\u65f6\u5220\u9664pv (deprecated: \u8868\u793a\u5f3a\u70c8\u7684\u4e0d\u63a8\u8350) </li> <li> <p>pv \u7533\u8bf7\u7684\u7a7a\u95f4\u4ece\u54ea\u91cc\u6765</p> </li> <li>NFS\u4e0a\u7684\u5171\u4eab\u76ee\u5f55</li> <li>NFS\u7684IP\u5730\u5740</li> <li>\u5377\u7684\u6a21\u5f0f, \u76ee\u524d\u652f\u6301Filesystem(\u6587\u4ef6\u7cfb\u7edf)\u548cBlock(\u5757),\u5176\u4e2dBlock\u7c7b\u578b\u9700\u8981\u540e\u7aef\u5b58\u50a8\u652f\u6301,\u9ed8\u8ba4\u4e3a\u6587\u4ef6\u7cfb\u7edf</li> </ol> pv \u7684STATUS \u63cf\u8ff0 Available \u53ef\u7528\uff0c\u6ca1\u6709\u88abPVC\u7ed1\u5b9a\u7684\u7a7a\u95f2\u8d44\u6e90 Bound \u5df2\u7ed1\u5b9a\uff0c\u5df2\u7ecf\u88abPVC\u7ed1\u5b9a Released \u5df2\u91ca\u653e\uff0cPVC\u88ab\u5220\u9664\uff0c\u4f46\u662f\u8d44\u6e90\u8fd8\u672a\u88ab\u91cd\u65b0\u4f7f\u7528 Failed \u5931\u8d25\uff0c\u81ea\u52a8\u56de\u6536\u5931\u8d25 <pre><code>k get pv\nNAME          CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE\npv-nfs-1   100Mi      RWX            Retain           Available                                   1s\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#pvc","title":"\u521b\u5efapvc","text":"pvc-nfs-1.yaml<pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\nname: pvc-nfs-1\nspec:\naccessModes:\n- ReadWriteMany # (1)\nvolumeMode: Filesystem\nresources:\nrequests:\nstorage: 100Mi #(2)\n# storageClassName:  #(3)\nselector: #(3)\nmatchLabels:\nrelease: \"stable\"\n</code></pre> <ol> <li>\u6ce8\u610f \u8fd9\u4e2a\u8981\u4e0e pv\u4e00\u81f4</li> <li>\u5bf9\u5e94\u7684pv \u5fc5\u987b\u5927\u4e8e\u7b49\u4e8e\u8fd9\u4e2a\u5927\u5c0f</li> <li>\u6807\u7b7e\u8fc7\u6ee4\u9009\u62e9\u54ea\u4e2a pv,\u4e5f\u53ef\u4ee5\u4e0d\u7528\u5199,\u8fd9\u6837pvc\u9009\u62e9\u7684\u65f6\u5019\u53ef\u80fd\u5c31\u662f\u770b\u9700\u8981\u7684\u5bb9\u91cf\u4e86</li> </ol> <pre><code># pvc \u7684\u72b6\u6001 Bound\nk get pvc\n# \u53ef\u4ee5\u770b\u5230 pvc\u5bf9\u8c61\u7684volumeName\u5b57\u6bb5 \u8bbe\u7f6e\u4e3a\u4e86pv\u7684\u540d\u5b57pv-nfs-1,\u8fd9\u5c31\u662f\u8868\u793apvc\u7ed1\u5b9a\u4e86pv\nk get pvc pvc-nfs-1 -o yaml  |grep volumeName\n# pv \u7684\u72b6\u6001\u53d8\u6210Bound, CLAIM \u663e\u793a\u6210 pvc\u7684name\nk get pv\nNAME          CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   REASON   AGE\npv-nfs-1       100Mi      RWX            Retain          Bound    default/pvc-nfs-1                           101s\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#podpvc","title":"\u521b\u5efapod\u7ed1\u5b9apvc","text":"<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pod-pv-pvc\nspec:\ncontainers:\n- name: nginx\nimage: nginx:1.14.2\nvolumeMounts:\n- name: ng-data\nmountPath: /usr/share/nginx/html\nvolumes:\n- name: ng-data\npersistentVolumeClaim: # \u6307\u5b9apvc\u7684name\nclaimName: pvc-nfs-1\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#storageclass","title":"storageClass","text":"<p>\u5b98\u65b9\u6587\u6863</p> <p>Tip</p> <p>storageClass \u6ca1\u6709\u547d\u540d\u7a7a\u95f4\u4e00\u8bf4. \u53ea\u80fd\u6709\u4e00\u4e2a\u9ed8\u8ba4\u7684 sc, \u5982\u679c\u8bbe\u7f6e\u591a\u4e2a, \u90a3\u4e48\u521b\u5efapvc \u672a\u6307\u5b9a storageClassName \u4f1a\u62a5\u9519 <code>Internal error occurred: 2 default StorageClasses were found</code></p> <pre><code>k get storageclass -A\nk get sc -A  #(1)\n</code></pre> <ol> <li>\u4e0b\u9762\u7684\u663e\u793a\u662f\u4e3e\u4e2a\u4f8b\u5b50, \u9ed8\u8ba4\u7684\u4f1a\u663e\u793a (default)     \u6211\u4eec\u524d\u9762\u521b\u5efa\u65f6\u6ca1\u6709\u6307\u5b9astorageClassName ,\u5b9e\u9645\u4e0a\u4f1a\u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\u7684\u90a3\u4e2asc. \u9664\u975e\u4f60\u8bbe\u7f6e\u4e3a \"\" \u7a7a\u5b57\u7b26\u4e32     <pre><code>NAME                 PROVISIONER               AGE\nstandard (default)   kubernetes.io/gce-pd      1d\ngold                 kubernetes.io/gce-pd      1d\n</code></pre> <pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\nname: example-nfs\nprovisioner: example.com/external-nfs\nparameters:\nserver: nfs-server.example.com\npath: /share\nreadOnly: \"false\"\n</code></pre></li> </ol> <pre><code># \u6b63\u5e38\u60c5\u51b5\u4e0b\u4f60\u8981\u521b\u5efa\u4e00\u4e2a\u80fd\u7528\u7684 sc, provisioner \u8981\u6709,\u8fd9\u91cc\u6211\u505a\u4e2a\u6d4b\u8bd5.\n# \u521b\u5efa\u5b8c\u6bd4\u540e, \u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\nk annotate sc example-nfs storageclass.kubernetes.io/is-default-class=true\n</code></pre> <p>pvc-nfs-2.yaml<pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\nname: pvc-nfs-2\nspec:\naccessModes:\n- ReadWriteMany # (1)\nvolumeMode: Filesystem\nresources:\nrequests:\nstorage: 500Mi\n</code></pre> <pre><code>k create -f pvc-nfs-2.yaml\nk get pvc #\u53d1\u73b0\u662fpending \u72b6\u6001\n# storageClassName: example-nfs pv\u7684storageClassName\u5df2\u7ecf\u88ab\u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\u7684\u4e86.\n# \u56e0\u4e3a\u8fd9\u4e2a sc \u4e0dok, \u6240\u4ee5\u6ca1\u6709\u52a8\u6001\u521b\u5efapv\nk get pvc pvc-nfs-2 -o yaml </code></pre></p> pv-2.yaml<pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\nname: pv-nfs-0002\nlabels:\nrelease: stable\nspec:\ncapacity: #\nstorage: 500Mi #\nvolumeMode: Filesystem\naccessModes: #\n- ReadWriteMany\npersistentVolumeReclaimPolicy: Recycle\nstorageClassName: example-nfs\nnfs:\npath:  \"/data/nfs/abc\"\nserver: 192.168.66.110\n</code></pre> <p>\u521b\u5efa\u8fd9\u4e2apv\u540e, \u6211\u4eec\u53d1\u73b0\u4e0a\u9762\u7684 pvc \u4e0epv \u7ed1\u5b9a\u4e86, \u8bf4\u660e\u6709\u8fd9\u4e2astorageClassName\u7684pv \u7684\u5e94\u8be5\u4f18\u5148\u7ea7\u66f4\u9ad8</p>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#nfs_1","title":"nfs","text":"<p>nfs storage class</p> <p>NFS subdir \u5916\u90e8\u9a71\u52a8</p> <p><pre><code>helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/\n# \u5148 pull  \u770b\u662f\u5426\u80fd\u4e0b\u8f7d\u4e0b\u6765,  / \u5de6\u8fb9\u662f \u4e0a\u9762\u6dfb\u52a0\u7684repo\u540d\nhelm pull nfs-subdir-external-provisioner/nfs-subdir-external-provisioner\n# \u4f1a\u5728\u5f53\u524d\u76ee\u5f55\u4e0b \u770b\u5230  \u4e0b\u8f7d\u7684\u6587\u4ef6 nfs-subdir-external-provisioner-4.0.18.tgz\ntar xf nfs-subdir-external-provisioner-4.0.18.tgz\ncd nfs-subdir-external-provisioner\ntree\n  .\n  \u251c\u2500\u2500 Chart.yaml\n  \u251c\u2500\u2500 ci\n  \u2502\u00a0\u00a0 \u2514\u2500\u2500 test-values.yaml\n  \u251c\u2500\u2500 README.md\n  \u251c\u2500\u2500 templates\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 clusterrolebinding.yaml\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 clusterrole.yaml\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 deployment.yaml\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 _helpers.tpl\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 persistentvolumeclaim.yaml\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 persistentvolume.yaml\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 poddisruptionbudget.yaml\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 podsecuritypolicy.yaml\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 rolebinding.yaml\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 role.yaml\n  \u2502\u00a0\u00a0 \u251c\u2500\u2500 serviceaccount.yaml\n  \u2502\u00a0\u00a0 \u2514\u2500\u2500 storageclass.yaml\n  \u2514\u2500\u2500 values.yaml  #\u4fee\u6539\u8fd9\u4e2a\u6587\u4ef6\n</code></pre> \u81ea\u5df1\u6784\u5efanfs-subdir-external-provisioner\u955c\u50cf value.yaml \u90e8\u5206\u8981\u4fee\u6539\u7684\u5185\u5bb9<pre><code>replicaCount: 1\nstrategyType: Recreate\nimage:\nrepository: registry.cn-hangzhou.aliyuncs.com/your-namespace/nfs-subdir-external-provisioner #(1)\ntag: v4.0.18 #(2)\npullPolicy: IfNotPresent\nimagePullSecrets: [\n{\"name\":\"regcred\"}  #(3)\n]\nnfs:\nserver: 192.168.66.110  #(4)\npath: /data/nfs  #(5)\nmountOptions:\nvolumeName: nfs-subdir-external-provisioner-root\n# Reclaim policy for the main nfs volume\nreclaimPolicy: Retain\n</code></pre></p> <ol> <li>\u81ea\u5df1\u6784\u5efa\u7684\u955c\u50cf\u5730\u5740</li> <li>\u955c\u50cf\u7248\u672c</li> <li>docker login aliyun \u540e\u521b\u5efa\u7684secret \u540d     <pre><code># \u4e0a\u9762\u4f7f\u7528\u4e86\u81ea\u5df1\u7684aliyun \u955c\u50cf\u4ed3\u5e93\ndocker login --username=your-name registry.cn-hangzhou.aliyuncs.com\nkubectl create secret generic regcred \\\n--from-file=.dockerconfigjson=/root/.docker/config.json  \\\n--type=kubernetes.io/dockerconfigjson  \\\n--namespace=kube-system\n</code></pre></li> </ol> <pre><code># \u5b89\u88c5\nhelm install nfs-subdir-external-provisioner . -n kube-system --debug\n# \u67e5\u770b\nks get po\n    nfs-subdir-external-provisioner-6db4fd89d9-nwqfv   1/1     Running   0  17h\nhelm list -A\nk get sc\nk get sc nfs-client -o yaml #(1)\n</code></pre> <ol> <li> <p>storageClass \u7684yaml \u91ccprovisioner     \u53ef\u4ee5\u8fd9\u6837\u83b7\u53d6<pre><code>ks get po nfs-subdir-external-provisioner-6db4fd89d9-nwqfv -oyaml |grep PROVISIONER_NAME -A 1\nks describe po nfs-subdir-external-provisioner-6db4fd89d9-nwqfv  |grep PROVISIONER_NAME -A 1\n</code></pre></p> <pre><code>allowVolumeExpansion: true\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\nannotations:\nmeta.helm.sh/release-name: nfs-subdir-external-provisioner\nmeta.helm.sh/release-namespace: kube-system\ncreationTimestamp: \"2023-07-19T08:37:44Z\"\nlabels:\napp: nfs-subdir-external-provisioner\napp.kubernetes.io/managed-by: Helm\nchart: nfs-subdir-external-provisioner-4.0.18\nheritage: Helm\nrelease: nfs-subdir-external-provisioner\nname: nfs-client\nresourceVersion: \"1055715\"\nuid: 5ae9beff-7646-4022-8acc-52396ea9723b\nparameters:\narchiveOnDelete: \"true\"\nprovisioner: cluster.local/nfs-subdir-external-provisioner\nreclaimPolicy: Delete\n</code></pre> </li> </ol> pod-pvc-with-sc.yaml<pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\nname: pvc-nfs-with-sc\nspec:\naccessModes:\n- ReadWriteMany\nvolumeMode: Filesystem\nresources:\nrequests:\nstorage: 200Mi\nstorageClassName: nfs-client #(1)\n---\napiVersion: v1\nkind: Pod\nmetadata:\nname: pod-pv-pvc-with-sc\nspec:\ncontainers:\n- name: nginx\nimage: nginx:1.14.2\nvolumeMounts:\n- name: ng-data\nmountPath: /usr/share/nginx/html\nvolumes:\n- name: ng-data\npersistentVolumeClaim: # \u6307\u5b9apvc\u7684name\nclaimName: pvc-nfs-with-sc\n</code></pre> <ol> <li>\u524d\u9762\u5df2\u7ecf\u81ea\u52a8\u521b\u5efa\u4e86sc, \u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u624b\u52a8\u521b\u5efa\u4e00\u4e2a.     \u5229\u7528\u8fd9\u4e2asc\u5bf9\u5e94\u7684provisioner\u7ec4\u4ef6\u81ea\u52a8\u521b\u5efapv  \u8fd8\u6709\u5982\u679c\u6ca1\u6709\u6307\u5b9a\u7684sc\u4e0d\u5b58\u5728, \u90a3\u4e48\u5b83\u4f1a\u627e\u5bf9\u5e94pv,\u4f1a\u4e0e\u6709\u8bbe\u7f6e\u8fd9\u4e2astorageClassName\u7684pv\u8fdb\u884c\u7ed1\u5b9a</li> </ol> <pre><code>k create -f pod-pvc-with-sc.yaml\nk get pvc #(1)\nk get pv #(2)\n# \u83b7\u53d6\u8fd9\u4e2apv \u4f7f\u7528\u7684 nfs \u5171\u4eab\u76ee\u5f55\nk get pv pvc-c5aebbf9-cd9e-43ba-866c-33bef06b4c2a -o yaml |grep nfs: -A 3\n# \u6700\u540e\u5230nfs\u670d\u52a1\u5668node1 \u4e0a ,\u770b\u5230 \u5171\u4eab\u76ee\u5f55\u6709\u5e26pvc\u7684\u540d\u5b57\n/data/nfs/default-pvc-nfs-with-sc-pvc-c5aebbf9-cd9e-43ba-866c-33bef06b4c2a\n</code></pre> <ol> <li>\u7ed3\u679c \u770b\u5230pvc\u5df2\u7ecfbound, \u6709pv \u7ed1\u5b9a\u4e86.     <pre><code>NAME              STATUS   VOLUME                                     CAPACITY  ACCESS MODES  STORAGECLASS\npvc-nfs-with-sc   Bound    pvc-c5aebbf9-cd9e-43ba-866c-33bef06b4c2a   200Mi     RWX           nfs-client\n</code></pre></li> <li>\u7ed3\u679c pv \u5df2\u7ecf\u88ab\u521b\u5efa\u51fa\u6765\u4e86     <pre><code>NAME                                       CAPACITY STATUS   CLAIM                     STORAGECLASS\npvc-c5aebbf9-cd9e-43ba-866c-33bef06b4c2a   200Mi    Bound    default/pvc-nfs-with-sc   nfs-client\n</code></pre></li> </ol>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#_4","title":"\u95ee\u9898","text":"","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#pvc-pending","title":"pvc \u5904\u4e8epending","text":"<ul> <li>PVC\u7684\u7a7a\u95f4\u7533\u8bf7\u5927\u5c0f\u5927\u4e8ePV\u7684\u5927\u5c0f</li> <li>PVC\u7684StorageClassName\u6ca1\u6709\u548cPV\u7684\u4e00\u81f4</li> <li>PVC\u7684accessModes\u548cPV\u7684\u4e0d\u4e00\u81f4</li> </ul>","tags":["k8s"]},{"location":"devops/k8s/core/persistence/#pvcpodpending","title":"\u6302\u8f7dPVC\u7684Pod\u4e00\u76f4\u5904\u4e8ePending","text":"<ul> <li>PVC\u6ca1\u6709\u521b\u5efa\u6210\u529f/PVC\u4e0d\u5b58\u5728</li> <li>PVC\u548cPod\u4e0d\u5728\u540c\u4e00\u4e2aNamespace</li> </ul>","tags":["k8s"]},{"location":"devops/k8s/core/pod/","title":"pod","text":"","tags":["k8s"]},{"location":"devops/k8s/core/pod/#pod","title":"\u4ec0\u4e48\u662fpod","text":"<p>\u5b83\u7531\u4e00\u7ec4\u3001\u4e00\u4e2a\u6216\u591a\u4e2a\u5bb9\u5668\u7ec4\u6210\uff0c \u6bcf\u4e2a\u5bb9\u5668\u90fd\u6709\u81ea\u5df1\u7684 pid mount user \u6bcf\u4e2aPod\u8fd8\u5305\u542b\u4e86\u4e00\u4e2aPause\u5bb9\u5668\uff0cPause\u5bb9\u5668\u662fPod\u7684\u7236\u5bb9\u5668\uff0c\u57fa\u7840\u5bb9\u5668, \u4e3b\u8981\u8d1f\u8d23\u50f5\u5c38\u8fdb\u7a0b\u7684\u56de\u6536\u7ba1\u7406 pod\u91cc\u7684\u6bcf\u4e2a\u5bb9\u5668\u90fd\u7ee7\u627f\u8be5\u5bb9\u5668, \u901a\u8fc7Pause\u5bb9\u5668\u53ef\u4ee5\u4f7f\u540c\u4e00\u4e2aPod\u91cc\u9762\u7684\u591a\u4e2a\u5bb9\u5668\u5171\u4eab\u5b58\u50a8\u3001\u7f51\u7edc\u3001PID\u3001IPC\u7b49</p> <p>pod\u91cc\u7684\u5bb9\u5668 IPC,UTS,network \u5c31\u662f\u5171\u4eab\u7684. pid \u662f\u5426\u9700\u8981\u5171\u4eab\u9700\u8981\u8bbe\u7f6e</p> <p>Tip</p> <p>\u628apod \u770b\u6210\u4e00\u53f0\u8ba1\u7b97\u673a, \u5bb9\u5668\u770b\u6210\u91cc\u9762\u7684\u8fdb\u7a0b</p>","tags":["k8s"]},{"location":"devops/k8s/core/pod/#pod_1","title":"\u4e3a\u4ec0\u4e48\u5f15\u5165pod","text":"<p>\u5f3a\u4f9d\u8d56\u7684\u670d\u52a1\u9700\u8981\u90e8\u7f72\u5728\u4e00\u8d77 nginx \u4e0ephp,\u591a\u4e2a\u670d\u52a1\u9700\u8981\u76f8\u4e92\u534f\u4f5c,pod\u5185\u5bb9\u5668\u4e4b\u95f4\u7528localhost:port\u6765\u8bbf\u95ee\u5f7c\u6b64,\u56e0\u4e3a\u4ed6\u4eec\u5171\u7528\u4e00\u4e2a\u7f51\u7edc\u7a7a\u95f4</p> <p>\u517c\u5bb9\u5176\u4ed6cri\u6807\u51c6</p>","tags":["k8s"]},{"location":"devops/k8s/core/pod/#podyaml","title":"pod\u7684yaml\u5b9a\u4e49","text":"simple.yaml <p>Warning</p> <ol> <li>\u4e0b\u9762\u8fd9\u4e2apod, \u4f1a\u6709\u4e00\u4e2a\u5bb9\u5668\u542f\u52a8\u5931\u8d25\u7684,\u56e0\u4e3a80\u7aef\u53e3\u5df2\u7ecf\u6709\u88ab\u5360\u7528</li> <li>nginx1 \u6267\u884c\u5b8c\u540e\u9000\u51fa</li> <li>nginx2 ok, \u4f7f\u7528pod ip\u7684\u7aef\u53e380</li> <li>nginx3 \u53d1\u73b080 \u7aef\u53e3\u88ab\u5360\u7528...</li> </ol> <pre><code>apiVersion: v1 #(1)\nkind: Pod #(2)\nmetadata:\nname: nginx #(3)\nnamespace: test #(4)\nlabels:  # (5)\napp: nginx\nspec: #(6)\ncontainers:\n- name: nginx1\nimage: nginx:1.14.2\nimagePullPolicy: IfNotPresent # (7)\nsecurityContext: # (8)\nprivileged: true\nenv: #(9)\n- name: HELLO\nvalue: world\nports:\n- containerPort: 80\nhostPort: 8901\ncommand: ['echo'] #(10)\nargs: [\"$(HELLO)\"] #(11)\nworkingDir: /test #(12)\nresources: #(13)\nrequests:\nmemory: \"64Mi\"\ncpu: \"250m\"\nlimits:\nmemory: \"128Mi\"\ncpu: \"500m\"\n- name: nginx2\nimage: nginx:1.14.2\nimagePullPolicy: IfNotPresent\nports:\n- containerPort: 80\nhostPort: 8901\n- name: nginx3\nimage: nginx:1.14.2\nimagePullPolicy: IfNotPresent\nports: #(14)\n- containerPort: 80\nhostPort: 8902\nhostAliases: #(15)\n- ip: \"180.101.50.188\"\nhostnames:\n- \"abc\"\n- \"baidu\"\nrestartPolicy: Never #(16)\n# hostNetwork: true\ndnsPolicy: Default #(17)\ndnsConfig:\nnameservers:\n- 8.8.8.8\n</code></pre> <ol> <li>\u7248\u672c</li> <li>\u8d44\u6e90\u7c7b\u578b</li> <li>pod\u7684\u540d\u5b57</li> <li>\u547d\u540d\u7a7a\u95f4,\u4e0d\u6307\u5b9a\u7684\u8bdd,\u9ed8\u8ba4\u662fdefault, \u6307\u5b9a\u7684\u8bdd,\u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u5fc5\u987b\u5b58\u5728</li> <li>\u6807\u7b7e,\u53ef\u4ee5\u591a\u4e2a, \u5c06\u6765\u7528\u6765\u8fc7\u6ee4\u9009\u62e9\u6307\u5b9apod</li> <li>spec : specification \u8868\u793a\u89c4\u683c,\u89c4\u8303,\u660e\u7ec6\u5355,\u6307\u5b9apod\u91cc\u521b\u5efa\u4ec0\u4e48\u6837\u7684\u5bb9\u5668</li> <li>\u955c\u50cf\u62c9\u53d6\u7b56\u7565<ol> <li>Always: \u603b\u662f\u62c9\u53d6,\u5982\u679c\u5bb9\u5668\u955c\u50cf\u7684tag\u6ca1\u6709\u5199,\u90a3\u4e48\u955c\u50cf\u7684tag\u5c31\u662flatest,\u5982\u679cimagePullPolicy\u6ca1\u6709\u914d\u7f6e,\u5219\u9ed8\u8ba4\u662f\u8fd9\u4e2a</li> <li>Never: \u4e0d\u7ba1\u662f\u5426\u5b58\u5728\u90fd\u4e0d\u4f1a\u62c9\u53d6</li> <li>IfNotPresent: tag\u662f\u975elatest, imagePullPolicy\u6ca1\u6709\u914d\u7f6e,\u5219\u9ed8\u8ba4\u662f\u8fd9\u4e2a</li> </ol> </li> <li>\u8fd9\u4e2a\u8868\u793a\u7279\u6743\u6a21\u5f0f,\u76f8\u5f53\u4e8e\u7528root \u6267\u884c     security-context</li> <li>\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf, \u901a\u8fc7env\u8bbe\u7f6e\u7684\u73af\u5883\u53d8\u91cf\u5c06\u8986\u76d6\u5bb9\u5668\u955c\u50cf\u4e2d\u6307\u5b9a\u7684\u6240\u6709\u73af\u5883\u53d8\u91cf</li> <li>\u76f8\u5f53\u4e8edockerfile\u91cc\u7684entrypoint, \u53ef\u4ee5\u4fee\u6539\u5bb9\u5668\u7684\u542f\u52a8\u547d\u4ee4,\u5982\u679c\u672a\u63d0\u4f9b\uff0c\u5219\u4f7f\u7528\u955c\u50cf\u7684 ENTRYPOINT</li> <li>\u76f8\u5f53\u4e8edockerfile\u91cc\u7684CMD,\u4f20\u9012\u53c2\u6570,\u5982\u679c\u672a\u63d0\u4f9b\uff0c\u5219\u4f7f\u7528\u955c\u50cf\u7684 CMD,\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86\u4e0a\u9762\u914d\u7f6e\u7684\u73af\u5883\u53d8\u91cf</li> <li>dockerfile\u4e2d\u7684Dir ,\u5982\u679c\u672a\u6307\u5b9a\uff0c\u5c06\u4f7f\u7528\u5bb9\u5668\u7684\u9ed8\u8ba4\u503c</li> <li>\u5bf9\u5bb9\u5668\u8d44\u6e90\u7684\u8981\u6c42\u548c\u9650\u5236,\u8c03\u5ea6\u7684\u65f6\u5019\u4f1a\u770b\u4f60\u7684\u9700\u6c42\u518d\u9009\u62e9\u5408\u9002\u7684\u8282\u70b9<ol> <li>\u5bb9\u5668\u7684\u8bf7\u6c42\u4e3a 0.25 CPU \u548c 64MiB\uff08226 \u5b57\u8282\uff09\u5185\u5b58</li> <li>\u5bb9\u5668\u7684\u8d44\u6e90\u7ea6\u675f\u4e3a 0.5 CPU \u548c 128MiB \u5185\u5b58</li> <li>1000m \u4e3a\u4e00\u4e2a\u6838\u7684cpu</li> </ol> </li> <li>ports\u7aef\u53e3<ol> <li>containerPort: \u5bb9\u5668\u66b4\u9732\u7684\u7aef\u53e3,\u8fd9\u91cc\u8bf4\u660e\u6211\u8fd9\u4e2a\u5bb9\u5668\u63d0\u4f9b\u670d\u52a1\u7684\u7aef\u53e3\u662f\u4ec0\u4e48, \u7c7b\u4f3c\u6211\u4eecdockerfile\u91ccEXPOSE<ol> <li>\u4e0d\u7ba1\u4f60\u5199\u4e0d\u5199, \u4f60\u90fd\u53ef\u4ee5\u901a\u8fc7 pod\u7684ip \u8bbf\u95ee\u8fd9\u4e2a\u7aef\u53e3</li> <li>\u5982\u679c2\u4e2a\u5bb9\u5668\u4f7f\u7528\u4e86\u76f8\u540c\u7684\u955c\u50cf ,\u6bd4\u5982\u8fd9\u91cc\u7684nginx\u63d0\u4f9b\u670d\u52a1\u7684 \u7aef\u53e3\u90fd\u662f80, \u90a3\u4e48\u7b2c\u4e8c\u4e2a\u5bb9\u5668\u4f1a\u63d0\u793a80: bind: address already in use</li> <li>\u56e0\u4e3apod\u91cc\u7684\u591a\u4e2a\u5bb9\u5668\u5171\u4eab\u7f51\u7edc,\u7528\u7684\u662f\u540c\u4e00\u4e2aip\u7684, pod\u76f8\u5f53\u4e8e\u8ba1\u7b97\u673a,\u7136\u540e\u5bb9\u5668\u662f\u8fdb\u7a0b,\u4f602\u4e2a\u8fdb\u7a0b\u4f7f\u7528\u4e86\u540c\u4e00\u4e2a\u7aef\u53e3,\u5c31\u62a5\u9519\u4e86.</li> </ol> </li> <li>hostPort: \u6620\u5c04\u4e3b\u673a\u7684\u7aef\u53e3,\u8fd9\u91cc\u4f60\u9700\u8981\u5230\u5bf9\u5e94\u7684node\u8282\u70b9\u4e0a\u53bbcurl localhost:8901</li> </ol> </li> <li>\u524d\u9762\u662f\u7684pod\u91cc\u5bb9\u5668\u7684\u914d\u7f6e,\u8fd9\u91cc\u662fpod\u7684\u5176\u4ed6\u914d\u7f6e, \u4e0econtainers \u5e73\u7ea7<ol> <li>\u8fd9\u4e2a\u662f \u76f8\u5f53\u4e8e \u5728/etc/hosts\u91cc\u6dfb\u52a0\u57df\u540d\u6620\u5c04</li> </ol> </li> <li>\u5bb9\u5668\u91cd\u542f\u7b56\u7565<ol> <li>Always (\u9ed8\u8ba4\u503c): \u4efb\u4f55\u65f6\u5019\u8fd9\u4e2a\u5bb9\u5668\u53d1\u751f\u4e86\u5f02\u5e38,\u5b83\u4e00\u5b9a\u4f1a\u88ab\u91cd\u65b0\u521b\u5efa</li> <li>OnFailure: pod\u5bf9\u8c61\u51fa\u73b0\u9519\u8bef(\u4e0d\u4ee50\u7684\u72b6\u6001\u7801\u9000\u51fa)\u65f6\u91cd\u542f,  \u662f\u4e0d\u65ad\u7684\u91cd\u542f\u91cc\u9762\u7684\u5bb9\u5668</li> <li>Never:<ol> <li>\u4ece\u4e0d\u91cd\u542f,(job\u7684\u60c5\u51b5. \u5982\u679cpod\u5f02\u5e38,\u4f1a\u4e0d\u65ad\u7684\u91cd\u65b0\u521b\u5efapod)</li> <li>\u800c\u5982\u679c\u4f60\u8981\u5173\u5fc3\u8fd9\u4e2a\u5bb9\u5668\u9000\u51fa\u540e\u7684\u4e0a\u4e0b\u6587\u73af\u5883,\u6bd4\u5982\u5bb9\u5668\u9000\u51fa\u540e\u7684\u65e5\u5fd7,\u6587\u4ef6\u548c\u76ee\u5f55\uff0c\u5c31\u9700\u8981\u5c06restartPolicy\u8bbe\u7f6e\u4e3aNever.\u56e0\u4e3a\u4e00\u65e6\u5bb9\u5668\u88ab\u81ea\u52a8\u91cd\u65b0\u521b\u5efa,\u8fd9\u4e9b\u5185\u5bb9\u5c31\u6709\u53ef\u80fd\u4e22\u5931 \u6389\u4e86(\u88ab\u5783\u573e\u56de\u6536\u4e86)</li> </ol> </li> </ol> </li> <li>pod\u7684dns\u7b56\u7565</li> </ol> <pre><code>k get po -n test\nNAME    READY   STATUS     RESTARTS   AGE\n  nginx   1/3     NotReady   0          9m43s\nk logs nginx nginx1 -n test\nworld\nk logs nginx nginx3 -n test\n0.0.0.0:80 failed (98: Address already in use)\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/pod/#_1","title":"\u63a2\u9488","text":"","tags":["k8s"]},{"location":"devops/k8s/core/pod/#livenessprobe","title":"LivenessProbe \u5b58\u6d3b\u63a2\u9488","text":"<ul> <li>\u7528\u4e8e\u63a2\u6d4b\u5bb9\u5668\u662f\u5426\u6b63\u5e38\u8fd0\u884c</li> <li>\u82e5\u6ca1\u6709\u914d\u7f6e\u8be5\u63a2\u9488\uff0c\u9ed8\u8ba4\u5c31\u662fsuccess.</li> <li>\u914d\u7f6e\u540e\u5982\u679c \u63a2\u6d4b\u5931\u8d25,kubelet\u4f1a\u6740\u6b7b\u5bb9\u5668,\u5e76\u6839\u636e\u91cd\u542f\u7b56\u7565\u505a\u76f8\u5e94\u7684\u5904\u7406</li> </ul> <p>\u57fa\u4e8e\u5b98\u65b9\u4ee3\u7801\u4fee\u6539 liveness.go<pre><code>package main\nimport (\n\"fmt\"\n\"log\"\n\"net/http\"\n\"time\"\n)\nfunc main() {\nstarted := time.Now()\nhttp.HandleFunc(\"/started\", func(w http.ResponseWriter, r *http.Request) {\nw.WriteHeader(200)\ndata := (time.Since(started)).String()\nw.Write([]byte(data))\n})\nhttp.HandleFunc(\"/healthz\", func(w http.ResponseWriter, r *http.Request) {\nduration := time.Since(started)\nif duration.Seconds() &gt; 30 {\nw.WriteHeader(500)\nw.Write([]byte(fmt.Sprintf(\"error: %v\", duration.Seconds())))\n} else {\nw.WriteHeader(200)\nw.Write([]byte(\"ok\"))\n}\n})\nlog.Fatal(http.ListenAndServe(\":8080\", nil))\n}\n</code></pre> <pre><code>FROM golang:alpine as base\nWORKDIR /test\nCOPY . .\nRUN go env -w GOPROXY=https://goproxy.cn,http://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct \\\n&amp;&amp; go mod init go-liveness \\\n&amp;&amp; go mod tidy \\\n&amp;&amp; go build\nFROM alpine:3.16\nCOPY --from=base /test/go-liveness /go-liveness\nEXPOSE 8080\nCMD [\"/go-liveness\"]\n</code></pre> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nlabels:\ntest: liveness\nname: liveness-exec\nnamespace: test\nspec:\nimagePullSecrets:\n- name: regcred3\ncontainers:\n- name: go-liveness\nimage: hb.6o6.com/6o6/go-liveness\nimagePullPolicy: IfNotPresent\nlivenessProbe:\nhttpGet: #(1)\npath: /healthz\nport: 8080\nhttpHeaders:\n- name: Custom-Header\nvalue: Awesome\ninitialDelaySeconds: 5 #(2)\nperiodSeconds: 5 #(3)\ntimeoutSeconds: 1 #(4)\nsuccessThreshold: 1 #(5)\nfailureThreshold: 3 #(6)\n</code></pre></p> <ol> <li>abc</li> <li>\u5bb9\u5668\u542f\u52a8\u540e\u8981\u7b49\u5f85\u591a\u5c11\u79d2\u540e\u624d\u542f\u52a8\u5b58\u6d3b\u548c\u5c31\u7eea\u63a2\u6d4b\u5668</li> <li>\u6267\u884c\u63a2\u6d4b\u7684\u65f6\u95f4\u95f4\u9694(\u5355\u4f4d\u662f\u79d2),\u9ed8\u8ba4\u662f 10 \u79d2.\u6700\u5c0f\u503c\u662f 1. \u8fd9\u91cc\u6bcf\u96945s\u5c31\u6267\u884c\u4e00\u6b21\u63a2\u6d4b</li> <li>\u63a2\u6d4b\u7684\u8d85\u65f6\u540e\u7b49\u5f85\u591a\u5c11\u79d2\u3002\u9ed8\u8ba4\u503c\u662f 1 \u79d2\u3002\u6700\u5c0f\u503c\u662f 1</li> <li>\u63a2\u6d4b\u5668\u5728\u5931\u8d25\u540e\uff0c\u88ab\u89c6\u4e3a\u6210\u529f\u7684\u6700\u5c0f\u8fde\u7eed\u6210\u529f\u6570\u3002\u9ed8\u8ba4\u503c\u662f 1\u3002 \u5b58\u6d3b\u548c\u542f\u52a8\u63a2\u6d4b\u7684\u8fd9\u4e2a\u503c\u5fc5\u987b\u662f 1\u3002\u6700\u5c0f\u503c\u662f 1</li> <li>\u5f53\u63a2\u6d4b\u5931\u8d25\u65f6\uff0cKubernetes \u7684\u91cd\u8bd5\u6b21\u6570\u3002 \u5bf9\u5b58\u6d3b\u63a2\u6d4b\u800c\u8a00\uff0c\u653e\u5f03\u5c31\u610f\u5473\u7740\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\u3002 \u5bf9\u5c31\u7eea\u63a2\u6d4b\u800c\u8a00\uff0c\u653e\u5f03\u610f\u5473\u7740 Pod \u4f1a\u88ab\u6253\u4e0a\u672a\u5c31\u7eea\u7684\u6807\u7b7e\u3002\u9ed8\u8ba4\u503c\u662f 3\u3002\u6700\u5c0f\u503c\u662f 1</li> </ol> <p>Note</p> <p>\u5b58\u6d3b\u63a2\u9488\u4f1a\u4e0d\u65ad\u7684\u53bb\u63a2\u6d4b. \u50cf\u670d\u52a1\u5fc3\u8df3\u5305, \u50cf icu\u7684\u5fc3\u7535\u56fe\u4e00\u6837. \u5982\u679c\u63a2\u6d4b\u5931\u8d25,\u6839\u636e\u4f60\u7684restartPolicy \u505a\u76f8\u5e94\u7684\u64cd\u4f5c</p>","tags":["k8s"]},{"location":"devops/k8s/core/pod/#readinessprobe","title":"ReadinessProbe \u5c31\u7eea\u63a2\u9488","text":"<p>Warning</p> <p>\u5c31\u7eea\u63a2\u9488\u4e5f\u4f1a\u4e0d\u65ad\u7684\u53bb\u63a2\u6d4b, \u5982\u679c\u63a2\u6d4b\u5931\u8d25, \u4e0d\u4f1a\u91cd\u542f\u5bb9\u5668,\u8fd9\u662f\u56e0\u4e3a\u5c31\u7eea\u63a2\u9488\u7684\u76ee\u7684\u662f\u770bpod\u662f\u5426\u51c6\u5907\u5b8c\u6bd5,\u662f\u5426\u53ef\u4ee5\u63d0\u4f9b\u670d\u52a1\u4e86,\u63a2\u6d4b\u5931\u8d25\u53ea\u662f\u8bf4\u5b83\u8fd8\u6ca1\u51c6\u5907\u597d <code>k get po</code> READY \u663e\u793a0/1, \u5bb9\u5668\u6240\u5728 Pod \u4e0a\u62a5\u8fd8\u672a\u5c31\u7eea\u7684\u4fe1\u606f\uff0c\u5e76\u4e14\u4e0d\u63a5\u53d7\u901a\u8fc7 Kubernetes Service(svc,\u540e\u7eed\u4f1a\u8bf4\u5230) \u7684\u6d41\u91cf,\u5c31\u662f\u4e0d\u63d0\u4f9b\u670d\u52a1\u4e86. Endpoints Controller\u5c06\u4ece\u6240\u6709\u7684Service\u7684Endpoints \u4e2d\u5220\u9664\u6b64\u5bb9\u5668\u6240\u5728Pod\u7684IP\u5730\u5740(\u8fd9\u4e2a\u540e\u7eed\u8bf4) \u5c31\u7eea\u63a2\u9488\u8fd4\u56de\u6210\u529f\uff0c\u8fd9\u4e2a\u5bb9\u5668\u5df2\u7ecf\u5b8c\u6210\u542f\u52a8\uff0c\u5e76\u4e14\u7a0b\u5e8f\u5df2\u7ecf\u662f\u53ef\u4ee5\u63a5\u53d7\u6d41\u91cf\u7684\u72b6\u6001 ,\u5c31\u662f\u53ef\u4ee5\u5904\u7406\u8bf7\u6c42\u4e86, \u4f1a\u901a\u77e5Kubernetes\u8be5\u5bb9\u5668\u5df2\u7ecf\u53ef\u4ee5\u63a5\u6536\u6d41\u91cf\u3002\u8fd9\u6837\u53ef\u4ee5\u786e\u4fdd\u5728\u5bb9\u5668\u5b8c\u5168\u5c31\u7eea\u4e4b\u524d\uff0c\u4e0d\u4f1a\u5c06\u6d41\u91cf\u8def\u7531\u5230\u8be5\u5bb9\u5668\uff0c\u907f\u514d\u4e86\u6d41\u91cf\u8fc7\u65e9\u8fdb\u5165\u4e0d\u7a33\u5b9a\u7684\u5bb9\u5668 \u4e3b\u8981\u7684\u4f5c\u7528\u5c31\u662f \u6211\u4ec0\u4e48\u65f6\u5019\u8ba4\u4e3a\u8fd9\u4e2apod \u53ef\u4ee5\u63d0\u4f9b\u670d\u52a1\u4e86,\u53ef\u4ee5\u5904\u7406\u8bf7\u6c42\u4e86. (\u6bd4\u5982nginx web\u670d\u52a1\u5668\u8d1f\u8f7d\u5747\u8861, \u4f60\u8fd9\u4e2apod\u662f\u5426\u53ef\u4ee5\u63a5\u6536\u6d41\u91cf\u4e86.)</p> pod-no-probe-nginx-sleep.yaml<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nlabels:\nrun: nginx-test\nname: nginx-test\nnamespace: test\nspec:\ncontainers:\n- image: nginx:1.14.2\nname: nginx-test\ncommand:\n- sh\n- -c\n- sleep 30;nginx -g \"daemon off;\"\n</code></pre> <pre><code>k apply -f pod-no-probe-nginx-sleep.yaml\n\nk get po -n test\nNAME         READY   STATUS    RESTARTS   AGE\n  nginx-test   1/1     Running   0          13s\n</code></pre> <p>Warning</p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 \u8fd9\u4e2a\u65f6\u5019pod \u5df2\u7ecf\u662frunning \u4e14ready\u4e86, \u4f46\u662f\u6211\u4eec\u77e5\u9053\u4e0d\u5e94\u8be5\u8ba9\u8fd9\u4e2apod\u63a5\u6536\u6d41\u91cf,\u5c31\u662f\u63a5\u6536\u8bf7\u6c42,\u56e0\u4e3a\u5b9e\u9645nginx\u8fd8\u6ca1\u6709\u771f\u6b63\u542f\u52a8. \u6240\u4ee5\u5982\u4f55\u6765\u5904\u7406\u8fd9\u4e2a\u95ee\u9898\u5462?</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nlabels:\nrun: nginx-test\nname: nginx-readiness\nnamespace: test\nspec:\ncontainers:\n- image: nginx:1.14.2\nname: nginx-readiness-c\ncommand:\n- sh\n- -c\n- sleep 30;nginx -g \"daemon off;\"\nreadinessProbe:\nhttpGet:\npath: /\nport: 80\ninitialDelaySeconds: 5\nperiodSeconds: 5\ntimeoutSeconds: 1\nsuccessThreshold: 1\nfailureThreshold: 3\n</code></pre> <p><pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nlabels:\ntest: readiness-liveness\nname: readiness-liveness\nnamespace: test\nspec:\ncontainers:\n- name: readiness-liveness-c\nimage: busybox\nimagePullPolicy: IfNotPresent\nargs:\n- /bin/sh\n- -c\n- touch /tmp/healthy; sleep 60; rm -f /tmp/healthy; sleep 600\nreadinessProbe:\nexec: command:\n- sh\n- -c\n- echo readiness-$(date +\"%Y/%m/%d %H:%M:%S\")&gt;&gt;/probe.log;cat /tmp/healthy\ninitialDelaySeconds: 5\nperiodSeconds: 5\ntimeoutSeconds: 1\nsuccessThreshold: 1\nfailureThreshold: 3\nlivenessProbe:\nexec:\ncommand:\n- sh\n- -c\n- echo liveness-$(date +\"%Y/%m/%d %H:%M:%S\")&gt;&gt;/probe.log;cat /tmp/healthy\ninitialDelaySeconds: 5\nperiodSeconds: 5\ntimeoutSeconds: 1\nsuccessThreshold: 1\nfailureThreshold: 3\n</code></pre> <pre><code>k exec -n test readiness-liveness -- tail -f /probe.log\n</code></pre></p> <p>2\u4e2a\u63a2\u9488\u90fd\u4f1a\u4e00\u76f4\u6267\u884c.</p> <p>\u5c31\u7eea\u548c\u5b58\u6d3b\u80fd\u4e0d\u80fd\u5408\u6210\u4e00\u4e2a?</p> <p>\u4e0d\u884c! \u5982\u4f55\u5408\u6210\u4e00\u4e2a, \u90a3\u4e48\u5982\u679c\u63a2\u6d4b3\u6b21\u90fd\u6ca1\u6709\u6210\u529f, \u610f\u5473\u7740\u6ca1\u5c31\u7eea,\u4f60\u662f\u51c6\u5907\u91cd\u542f\u5bb9\u5668? \u8fd9\u6837\u6b7b\u5faa\u73af? \u5c31\u7eea\u662f\u770b\u662f\u5426\u51c6\u5907\u63d0\u4f9b\u670d\u52a1, \u63a5\u6536\u8bf7\u6c42, \u4e0d\u662f\u8bf4\u5bb9\u5668\u6709\u95ee\u9898\u4e86, \u53ea\u662f\u6ca1\u51c6\u5907\u597d \u5b58\u6d3b\u662f\u770b\u662f\u5426\u8fd0\u884c\u6b63\u5e38, \u4e0d\u6b63\u5e38\u8981\u91cd\u542f\u5565\u7684.</p>","tags":["k8s"]},{"location":"devops/k8s/core/pod/#startupprobe","title":"StartupProbe \u542f\u52a8\u63a2\u9488","text":"<p>Tip</p> <ol> <li>k8s1.16\u7248\u672c\u540e\u65b0\u52a0\u7684\u63a2\u6d4b\u65b9\u5f0f,\u7528\u4e8e\u5224\u65ad\u5bb9\u5668\u5185\u5e94\u7528\u7a0b\u5e8f\u662f\u5426\u5df2\u7ecf\u542f\u52a8</li> <li>\u5982\u679c\u914d\u7f6e\u4e86startupProbe,\u5c31\u4f1a\u5148\u7981\u6b62\u5176\u4ed6\u7684\u63a2\u6d4b,\u76f4\u5230\u5b83\u6210\u529f\u4e3a\u6b62,\u5931\u8d25\u5219\u4f1a\u6839\u636erestartPolicy\u7b56\u7565\u8fdb\u884c\u76f8\u5e94\u64cd\u4f5c,\u6210\u529f\u5219\u542f\u52a8\u63a2\u9488\u5c06\u4e0d\u518d\u63a2\u6d4b,\u5f00\u59cb\u540e\u7eed\u7684\u5c31\u7eea\u548c\u5b58\u6d3b\u63a2\u6d4b</li> </ol> <p>\u4e3a\u4ec0\u4e48\u9700\u8981,\u76f4\u63a5\u7528\u5b58\u6d3b\u63a2\u9488\u4e0d\u884c\u5417?</p> <ol> <li>\u6709\u4e9b\u5e94\u7528\u5728\u542f\u52a8\u7684\u65f6\u5019\u9700\u8981\u6bd4\u8f83\u957f\u7684\u65f6\u95f4,</li> <li>\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u5c31\u7eea\u63a2\u9488\u6211\u4eec\u65e0\u6240\u8c13, \u5b83\u4e00\u76f4\u63a2,\u6ca1\u6210\u529f\u6ca1\u5173\u7cfb</li> <li>\u5b58\u6d3b\u63a2\u9488<ol> <li>\u4f60\u8bf4\u5230\u5e95\u7b49\u5f85\u591a\u4e45\u624d\u5f00\u59cb\u63a2\u6d4b, \u8fd9\u9700\u8981\u4f60\u5148\u5224\u65ad\u4f60\u7684\u7a0b\u5e8f\u542f\u52a8\u8981\u591a\u4e45,\u6bd4\u598290s, \u7136\u540einitialDelaySeconds\u8bbe\u7f6e\u4e3a90s,\u597d\u50cf\u53ef\u4ee5\u89e3\u51b3\u95ee\u9898</li> <li>\u5047\u8bbe\u6709\u4e00\u6b21\u5931\u8d25\u4e86,\u8981\u91cd\u542f\u6216\u91cd\u5efa\u5bb9\u5668, \u8fd9\u6b21\u504f\u504f\u542f\u52a8\u65f6\u95f4\u66f4\u957f\u4e86,\u76f4\u63a5\u8ba9\u4f60 \u5b58\u6d3b\u63a2\u9488\u5931\u8d25, \u7136\u540e\u91cd\u542f... \u6b7b\u5faa\u73af\u4e86.</li> <li>\u9996\u5148initialDelaySeconds\u4e0d\u53ef\u80fd\u6539\u6765\u6539\u53bb, \u4f60\u53ef\u80fd\u4f1a\u8bf4, \u589e\u52a0\u63a2\u6d4b\u6b21\u6570\u548c\u63a2\u6d4b\u95f4\u9694\u600e\u4e48\u6837, \u5047\u8bbe\u4f60\u6539\u6210failureThreshold=5,periodSeconds=10, \u90a3\u4e48\u5982\u679c\u5bb9\u5668\u5f02\u5e38, \u53ef\u80fd\u9700\u898150s\u7684\u65f6\u95f4 \u624d\u4f1a\u5224\u5b9a\u5bb9\u5668\u5f02\u5e38, \u624d\u4f1a\u91cd\u542f\u6216\u91cd\u5efa\u5bb9\u5668,\u767d\u767d\u7b49\u5f85\u8fd9\u4e48\u4e45.</li> </ol> </li> <li>\u8bbe\u8ba1\u4e86 \u542f\u52a8\u63a2\u9488<ol> <li>\u5047\u8bbe\u4f60\u7684\u7a0b\u5e8f\u542f\u52a8\u5927\u6982\u898190s</li> <li>\u8bbe\u7f6efailureThreshold=10, periodSeconds=10,initialDelay=10<ol> <li>\u8fd9\u4e2a\u5982\u679c\u5728110s\u5185\u6210\u529f\u4e86, \u5c31ok</li> <li>\u53ef\u80fd10s\u5c31ok\u4e86, \u4e0d\u9700\u8981\u50cf\u5b58\u6d3b\u63a2\u9488\u90a3\u6837\u56fa\u5b9a\u7684\u6b7b\u7b4990s\u65f6\u95f4</li> <li>\u4f60\u53ef\u80fd\u4f1a\u8bf4,110s\u6ca1\u6210\u529f,\u91cd\u542f\u4e86, \u4e5f\u8fd9\u4e2a\u53ef\u80fd. \u6240\u4ee5\u4f60\u5f53\u521d\u8bbe\u7f6e\u65f6\u6839\u636e\u5177\u4f53\u60c5\u51b5,\u53ef\u4ee5\u5c06failureThreshold\u589e\u52a0, \u4e00\u822c\u60c5\u51b5\u4e0b\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5</li> </ol> </li> </ol> </li> </ol> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\ncreationTimestamp: null\nlabels:\nrun: nginx-test\nname: nginx-start-probe\nspec:\nrestartPolicy: Always\ncontainers:\n- image: nginx\nname: nginx-start-probe-c\ncommand:\n- sh\n- -c\n- sleep 10;nginx -g \"daemon off;\"\nstartProbe:\nfailureThreshold: 3\nsuccessThreshold: 1\nperiodSeconds: 5\ninitialDelaySeconds: 2\ntimeoutSeconds: 2\ntcpSocket:\nport: 80\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/pod/#poststart","title":"postStart","text":"<p>Tip</p> <ul> <li>\u5728\u5bb9\u5668\u542f\u52a8\u540e,\u7acb\u523b\u6267\u884c\u4e00\u4e2a\u6307\u5b9a\u7684\u64cd\u4f5c</li> <li>\u867d\u7136\u662f\u5728\u5bb9\u5668command\u6267\u884c\u4e4b\u540e\uff0c\u5b9e\u9645\u4e0a\u548c\u5b83\u662f\u5f02\u6b65\u7684, \u5c31\u662f\u8bf4\u53ef\u80fd\u5728postStart\u542f\u52a8\u65f6,command\u6709\u53ef\u80fd\u8fd8\u6ca1\u6709\u6267\u884c\u7ed3\u675f</li> <li>\u5728postStart\u6267\u884c\u5b8c\u6bd5\u524d, pod\u8fd8\u4e0d\u662frunning\u72b6\u6001</li> </ul> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: lifecycle-post-start\nspec:\ncontainers:\n- name: lifecycle-post-start-c\nimage: nginx:1.14.2\nimagePullPolicy: IfNotPresent\nlifecycle:\npostStart:\nexec:\ncommand: [\"/bin/sh\", \"-c\", \"sleep 20;echo postStart... &gt; /tmp.log\"]\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/pod/#prestop","title":"preStop","text":"<p>Tip</p> <ul> <li>preStop\u64cd\u4f5c\u7684\u6267\u884c\u662f\u540c\u6b65\u7684. \u6240\u4ee5\u5b83\u4f1a\u963b\u585e\u5f53\u524d\u7684\u5bb9\u5668\u6740\u6b7b\u6d41\u7a0b\uff0c\u76f4\u5230\u8fd9\u4e2a\u64cd\u4f5c\u5b8c\u6210\u624d\u5141\u8bb8\u5bb9\u5668\u88ab\u6740\u6b7b</li> <li>\u6211\u4eec\u53ef\u4ee5\u5728\u91cc\u9762\u5199\u4f18\u96c5\u9000\u51fa\u7684\u4e1c\u897f</li> <li>terminationGracePeriodSeconds \u4e2d\u6b62\u5bbd\u9650\u65f6\u95f4,preStop \u6267\u884c\u524d \u5c31\u4f1a\u5f00\u59cb\u8ba1\u7b97</li> </ul> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: lifecycle-pre-stop\nspec:\nterminationGracePeriodSeconds: 30  # \u9ed8\u8ba4\u662f30s\ncontainers:\n- name: lifecycle-pre-stop-c\nimage: nginx\nimagePullPolicy: IfNotPresent\nlifecycle:\npreStop:\nexec:\ncommand: [\"/bin/sh\", \"-c\", \"sleep 45;echo Hello\"]\n# \u53ef\u4ee5\u5199\u4f18\u96c5\u9000\u51fanginx\n# command: [\"/bin/sh\",\"-c\",\"echo preStop...; nginx -s quit; while killall -0 nginx; do sleep 1; done\"]\n</code></pre> <pre><code>k delete lifecycle-pre-stop\n# \u770b\u6548\u679c\nk logs -f lifecycle-pre-stop\n</code></pre> <p></p>","tags":["k8s"]},{"location":"devops/k8s/core/pod/#init","title":"init\u5bb9\u5668","text":"<p>init-container</p> <p>Tip</p> <p>\u76f8\u6bd4\u666e\u901a\u7684container,Init Containers \u7684\u751f\u547d\u5468\u671f\u4f1a\u5148\u4e8e\u6240\u6709\u7684 Containers\u8fd0\u884c,\u5e76\u4e14\u4e25\u683c\u6309\u7167\u5b9a\u4e49\u7684\u987a\u5e8f\u6267\u884c.</p> <ul> <li>Init\u5bb9\u5668\u53ef\u4ee5\u5305\u542b\u4e00\u4e9b\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u5e94\u7528\u5bb9\u5668\u4e2d\u4e0d\u5b58\u5728\u7684\u5b9e\u7528\u5de5\u5177\u6216\u4e2a\u6027\u5316\u4ee3\u7801</li> <li>Init\u5bb9\u5668\u53ef\u4ee5\u5b89\u5168\u5730\u8fd0\u884c\u8fd9\u4e9b\u5de5\u5177\uff0c\u907f\u514d\u8fd9\u4e9b\u5de5\u5177\u5bfc\u81f4\u5e94\u7528\u955c\u50cf\u7684\u5b89\u5168\u6027\u964d\u4f4e</li> <li>Init\u5bb9\u5668\u53ef\u4ee5\u4ee5root\u8eab\u4efd\u8fd0\u884c\uff0c\u6267\u884c\u4e00\u4e9b\u9ad8\u6743\u9650\u547d\u4ee4</li> <li>Init\u5bb9\u5668 \u76f8\u5173\u64cd\u4f5c\u6267\u884c\u5b8c\u6210\u4ee5\u540e\u5373\u9000\u51fa\uff0c\u4e0d\u4f1a\u7ed9\u4e1a\u52a1\u5bb9\u5668\u5e26\u6765\u5b89\u5168\u9690\u60a3</li> </ul> <p>\u5728\u4e3b\u5e94\u7528\u542f\u52a8\u4e4b\u524d\uff0c\u505a\u4e00\u4e9b\u521d\u59cb\u5316\u7684\u64cd\u4f5c\uff0c\u6bd4\u5982\u521b\u5efa\u6587\u4ef6\u3001\u4fee\u6539\u5185\u6838\u53c2\u6570\u3001\u7b49\u5f85 \u4f9d\u8d56\u7a0b\u5e8f\u542f\u52a8\u6216\u5176\u4ed6\u9700\u8981\u5728\u4e3b\u7a0b\u5e8f\u542f\u52a8\u4e4b\u524d\u9700\u8981\u505a\u7684\u5de5\u4f5c</p> <p>postStart\u4e0einit\u7684\u5bf9\u6bd4</p> <ul> <li>PostStart:\u4f9d\u8d56\u4e3b\u5e94\u7528\u7684\u73af\u5883\uff0c\u800c\u4e14\u5e76\u4e0d\u4e00\u5b9a\u5148\u4e8eCommand\u8fd0\u884c</li> <li>InitContainer:\u4e0d\u4f9d\u8d56\u4e3b\u5e94\u7528\u7684\u73af\u5883\uff0c\u53ef\u4ee5\u6709\u66f4\u9ad8\u7684\u6743\u9650\u548c\u66f4\u591a\u7684\u5de5\u5177\uff0c\u4e00\u5b9a\u4f1a\u5728\u4e3b\u5e94\u7528\u542f\u52a8\u4e4b\u524d\u5b8c\u6210</li> </ul> <p>\u521d\u59cb\u5316\u5bb9\u5668\u548c\u666e\u901a\u5bb9\u5668\u7684\u533a\u522b</p> <ul> <li>Init \u5bb9\u5668\u4e0e\u666e\u901a\u7684\u5bb9\u5668\u975e\u5e38\u50cf\uff0c\u9664\u4e86\u5982\u4e0b\u51e0\u70b9:<ul> <li>\u5982\u679c\u4e3a\u4e00\u4e2a Pod \u6307\u5b9a\u4e86\u591a\u4e2a Init \u5bb9\u5668\uff0c\u8fd9\u4e9b\u5bb9\u5668\u4f1a\u6309\u987a\u5e8f\u9010\u4e2a\u8fd0\u884c\u3002 \u6bcf\u4e2a Init \u5bb9\u5668\u5fc5\u987b\u8fd0\u884c\u6210\u529f\uff0c\u4e0b\u4e00\u4e2a\u624d\u80fd\u591f\u8fd0\u884c\u3002\u5f53\u6240\u6709\u7684 Init \u5bb9\u5668\u8fd0\u884c\u5b8c\u6210\u65f6\uff0c Kubernetes \u624d\u4f1a\u4e3a Pod \u521d\u59cb\u5316\u5e94\u7528\u5bb9\u5668\u5e76\u50cf\u5e73\u5e38\u4e00\u6837\u8fd0\u884c</li> <li>\u5982\u679cpod\u7684Init \u5bb9\u5668\u5931\u8d25\uff0cKubernetes \u4f1a\u4e0d\u65ad\u5730\u91cd\u542f\u8be5 Pod\uff0c\u76f4\u5230 Init \u5bb9\u5668\u6210\u529f\u4e3a\u6b62</li> <li>\u5982\u679cPod \u5bf9\u5e94\u7684 restartPolicy \u503c\u4e3a Never\uff0cinit\u5931\u8d25\u4e86.\u5219Kubernetes \u4e0d\u4f1a \u91cd\u65b0\u542f\u52a8 Pod\u3002</li> <li>Init \u5bb9\u5668\u4e0d\u652f\u6301 lifecycle\u3001livenessProbe\u3001 readinessProbe \u548c startupProbe</li> </ul> </li> </ul> <p>Init \u5bb9\u5668\u662f\u4e00\u79cd\u7279\u6b8a\u5bb9\u5668\uff0c\u5728 Pod \u5185\u7684\u5e94\u7528\u5bb9\u5668\u542f\u52a8\u4e4b\u524d\u8fd0\u884c\u3002Init \u5bb9\u5668\u53ef\u4ee5\u5305\u62ec\u4e00\u4e9b\u5e94\u7528\u955c\u50cf\u4e2d\u4e0d\u5b58\u5728\u7684\u5b9e\u7528\u5de5\u5177\u548c\u5b89\u88c5\u811a\u672c</p> <p><pre><code># \u901a\u8fc7\u8fd9\u4e2a\u53ef\u4ee5\u627e\u5230\u5bf9\u5e94\u7684\u6587\u6863url\nkubectl explain pods.spec.initContainers\n</code></pre> pod-with-2init.yaml<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pod-with-2init\nlabels:\napp: pod-with-2init\nspec:\ncontainers:\n- name: c-main\nimage: busybox:1.28\ncommand: ['sh', '-c', 'echo The app is running! &amp;&amp; sleep 3600']\ninitContainers:\n- name: c-init-wait-service\nimage: busybox:1.28\ncommand: ['sh', '-c', 'until nslookup wait-service; do echo waiting for wait-service; sleep 2; done;']\n- name: c-init-wait-db\nimage: busybox:1.28\ncommand: ['sh', '-c', 'until nslookup wait-db; do echo waiting for wait-db; sleep 2; done;']\n---\napiVersion: v1\nkind: Service\nmetadata:\nname: wait-service\nlabels:\napp: wait-service\nspec:\nports:\n- protocol: TCP\nport: 80\ntargetPort: 9376\n---\napiVersion: v1\nkind: Service\nmetadata:\nname: wait-db\nlabels:\napp: wait-service\nspec:\nports:\n- protocol: TCP\nport: 80\ntargetPort: 9377\n</code></pre></p> <pre><code># \u521b\u5efapod\nk apply -f pod-with-2init.yaml  -l app=pod-with-2init\nk get po\n  NAME                             READY   STATUS     RESTARTS   AGE\n  pod-with-2init                   0/1     Init:0/2   0          3m7s\n# \u53ef\u4ee5\u770b\u52302\u4e2ainit \u5bb9\u5668\u90fd\u5728waiting\n# \u56e0\u4e3a\u6211\u4eec\u7684svc ,\u8fd8\u6ca1\u521b\u5efa, nslookup wait-service\n# \u663e\u793a\u7684\u65f6\u5019\u6309\u7167\u987a\u5e8f\u663e\u793a, \nk describe po pod-with-2init |grep -E 'c-|state' -i\n  c-init-wait-service: # \u542f\u52a8\u4e86 \u5728\u8fd0\u884c\nState:          Running\n  c-init-wait-db: #  \u7531\u4e8e c-init-wait-service \u8fd9\u4e2a\u5bb9\u5668\u6ca1\u6709\u8fd0\u884c\u6210\u529f,\u6240\u4ee5\u7b49\u5f85\nState:          Waiting\n  c-main:\n    State:          Waiting\nk logs pod-with-2init -c c-init-wait-service\nk logs pod-with-2init -c c-init-wait-db\n\n# \u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u521b\u5efa\u5bf9\u5e94\u7684svc, \u5148\u8ba9c-init-wait-service \u8fd0\u884c\u6210\u529f\nk apply -f pod-with-2init.yaml  -l app=wait-service\n# \u518d\u770bpod \u72b6\u6001\nk describe po pod-with-2init |grep -E 'c-|state' -i\n  c-init-wait-service:\n    State:          Terminated\n  c-init-wait-db: # \u524d\u9762\u7684\u8fd0\u884c\u5b8c\u6bd5\u4e86,\u8fd9\u4e2a\u624d\u5f00\u59cb\u8fd0\u884c\nState:          Running\n  c-main:\n    State:          Waiting\nk apply -f pod-with-2init.yaml  -l app=wait-db\n# \u6700\u540e\u67e5\u770b\nk describe po pod-with-2init |grep -E 'c-|state' -i\n  c-init-wait-service:\n    State:          Terminated\n  c-init-wait-db:\n    State:          Terminated\n  c-main:\n    State:          Running\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/pod/#debug","title":"\u4e34\u65f6\u5bb9\u5668(debug)","text":"<p>\u5bb9\u5668\u7684\u5b89\u5168\u8003\u8651,\u5982\u679c\u4f60\u7684\u5bb9\u5668\u91cc\u5b89\u88c5\u4e86\u592a\u591a\u7684\u4e1c\u897f, \u6bd4\u5982ssh,\u53ef\u80fd\u8ba9\u9ed1\u5ba2\u8d8a\u6743\u8bbf\u95ee\u4f60\u7684\u8282\u70b9, \u6240\u4ee5\u4e00\u822c\u7528\u6700\u5c0f\u7684\u955c\u50cf\u6765\u51cf\u5c11\u653b\u51fb\u9762\u5e76\u51cf\u5c11\u6545\u969c\u548c\u6f0f\u6d1e\u7684\u66b4\u9732</p> <p>Distroless \u955c\u50cf \u5141\u8bb8\u7528\u6237\u90e8\u7f72\u6700\u5c0f\u7684\u5bb9\u5668\u955c\u50cf</p> <p>\u4f46\u662f\u5982\u679c\u6211\u4eec\u7ed9\u5bb9\u5668\u5b89\u88c5\u6700\u5c0f\u7684\u4e1c\u897f, \u5982\u679c\u4f60\u7684\u5bb9\u5668\u51fa\u4e86\u95ee\u9898\u9700\u8981\u8c03\u8bd5, \u91cc\u9762\u4ec0\u4e48\u547d\u4ee4\u90fd\u6ca1\u6709... \u5c31\u9ebb\u70e6\u4e86</p> <p>\u53ef\u4ee5\u5728\u73b0\u6709 Pod \u4e2d\u8fd0\u884c\u4e34\u65f6\u5bb9\u5668\u6765\u68c0\u67e5\u5176\u72b6\u6001\u5e76\u8fd0\u884c\u4efb\u610f\u547d\u4ee4</p> <p>\u5b98\u65b9\u6587\u6863</p> <p>\u4e0e\u5e38\u89c4\u5bb9\u5668\u4e00\u6837\uff0c\u5c06\u4e34\u65f6\u5bb9\u5668\u6dfb\u52a0\u5230 Pod \u540e\uff0c\u5c06\u4e0d\u80fd\u66f4\u6539\u6216\u5220\u9664\u4e34\u65f6\u5bb9\u5668</p> <pre><code># \u4f1a\u62a5\u9519,\u56e0\u4e3acorednspod \u91cc\u57fa\u672c\u4e1c\u897f\u6ca1\u6709.\nks exec -it coredns-65c54cc984-4p2zj -- sh\n# \u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u5bb9\u5668 \u540d\u5b57\u53ebdebugger-x, \u5e76\u8fdb\u5165\u4ea4\u4e92\n# \u7531\u4e8ecoredns \u9ed8\u8ba4\u6ca1\u6709\u5f00\u542f\u8fdb\u7a0b\u547d\u540d\u7a7a\u95f4\u5171\u4eab. \u6240\u4ee5\u8fd9\u91cc\u9700\u8981 \u4f7f\u7528--target=pod\u91cc\u4f60\u60f3\u8fdb\u884c\u8c03\u8bd5\u7684\u5bb9\u5668\u540d\nks debug coredns-65c54cc984-4p2zj -it -c debugger-x --image=busybox --target=coredns\n# \u9000\u51fa\u540e,\u4e34\u65f6\u5bb9\u5668\u5c31\u6ca1\u4e86\n# \u4e0d\u6307\u5b9a\u4e34\u65f6\u5bb9\u5668\u540d,\u540d\u5b57\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u540d\u5b57\nks debug coredns-65c54cc984-4p2zj -it  --image=busybox --target=coredns\n# \u8fdb\u5165\u4e34\u65f6\u5bb9\u5668\u540e \u6267\u884c\u547d\u4ee4\u770b\u770b\nps  # \u4f60\u624d\u4f1a\u770b\u5230, coredns \u5bb9\u5668\u8fd0\u884c\u7684\u8fdb\u7a0b. --target \u8ba9\u4ed6\u4eec\u5171\u4eab\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4e86\nUSER     TIME  COMMAND\n    1 root      1:52 /coredns -conf /etc/coredns/Corefile\n   15 root      0:00 sh\n   21 root      0:00 ps\n\n# \u4f1a\u770b\u5230\u91cc\u9762\u62c9\u53d6\u955c\u50cf,\u521b\u5efa\u5e76\u542f\u52a8\u4e86\u4e00\u4e2a\u5bb9\u5668,\u540d\u5b57debugger-xxx\nks describe  po  coredns-65c54cc984-4p2zj\n\n# \u9000\u51fa\u4e34\u65f6\u4ea4\u4e92\u540e\nks describe  po  coredns-65c54cc984-4p2zj|grep -E 'Containers|debugger|State|coredns:$'\nContainers:\n    coredns:\n      State:          Running\n  Ephemeral Containers:\n    debugger-x7ld5:\n      State:          Terminated\n    debugger-x:\n      State:          Terminated\n</code></pre> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pod-nginx\nlabels:\napp: pod-nginx\nspec:\nshareProcessNamespace: true\ncontainers:\n- name: c-main\nimage: nginx:1.14.2\n</code></pre> <pre><code># \u672c\u8eab\u5f00\u542f pid\u547d\u540d\u7a7a\u95f4\u5171\u4eab\u7684 pod, \u4e0d\u9700\u8981 --target\nk debug pod-nginx  -it --image=busybox\nps\n  PID   USER     TIME  COMMAND\n    1 65535     0:00 /pause\n    7 root      0:00 nginx: master process nginx -g daemon off;\n13 101       0:00 nginx: worker process\n   14 root      0:00 sh\n   20 root      0:00 ps\n</code></pre> <p>\u5b9e\u9645\u7684\u539f\u7406 \u5e94\u8be5\u7c7b\u4f3c\u4e0b\u9762\u8fd9\u6837, \u7ed9pod \u6ce8\u5165\u4e00\u4e2a\u5bb9\u5668. pod \u91cc\u7684\u5bb9\u5668\u662f\u5171\u4eab \u547d\u540d\u7a7a\u95f4\u7b49\u7684</p> <p>Share Process Namespace between Containers in a Pod | Kubernetes</p> <p><pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: nginx\nspec:\nshareProcessNamespace: true    # \u9700\u8981\u6253\u5f00\ncontainers:\n- name: nginx\nimage: nginx\n- name: shell\nimage: busybox:1.28\nsecurityContext:\ncapabilities:\nadd:\n- SYS_PTRACE\nstdin: true\ntty: true\n</code></pre> <pre><code># 1. Create the pod\u00a0`nginx`\u00a0on your cluster:\n# 2. Attach to the\u00a0`shell`\u00a0container and run\u00a0`ps`:\nkubectl attach -it nginx -c shell\n</code></pre></p> <p>kubectl-debug</p> <ol> <li> <p>distroless \u21a9</p> </li> <li> <p>configure-pod-container \u21a9</p> </li> <li> <p>\u5bb9\u5668\u751f\u547d\u5468\u671fpreStop \u21a9</p> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/","title":"\u8c03\u5ea6\u5668","text":"<p>Tip</p> <p>kube-scheduler\u8d1f\u8d23\u8c03\u5ea6Pod\u5230\u96c6\u7fa4\u5185\u7684\u8282\u70b9\u4e0a,\u5b83\u76d1\u542ckube-apiserver,\u67e5\u8be2\u8fd8\u672a\u5206\u914dNode\u7684Pod, \u7136\u540e\u6839\u636e\u8c03\u5ea6\u7b56\u7565\u4e3a\u8fd9\u4e9bPod\u5206\u914d\u8282\u70b9(\u6700\u7ec8\u4f53\u73b0\u4e3a\u66f4\u65b0Pod\u7684spec.nodeName\u5b57\u6bb5)</p> <p>kube-scheduler</p> <p><code>pkg/scheduler/scheduler.go#New</code> snapshot := internalcache.NewEmptySnapshot()</p>","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#nodename","title":"nodeName","text":"<p>\u91cd\u8981</p> <p>\u76f4\u63a5\u6307\u5b9a\u8282\u70b9\u540d\u5b57,\u8df3\u8fc7\u8c03\u5ea6\u5668, \u5b9e\u9645\u5c31\u6ca1\u6709\u8d70\u8c03\u5ea6\u6d41\u7a0b.</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: nginx\nspec:\ncontainers:\n- name: nginx\nimage: nginx\nnodeName: kube-01\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#nodeselector","title":"nodeSelector","text":"<p>Tip</p> <p>\u76f4\u63a5\u901a\u8fc7\u952e\u503c\u5bf9\u5c06Pod\u8c03\u5ea6\u5230\u5177\u6709\u7279\u5b9a<code>label</code>\u7684Node\u4e0a</p> <p>nodeSelector <pre><code>k get no\n# \u7ed9\u8282\u70b9\u6253\u4e0a\u6807\u7b7e\nk label nodes node1 disk-type=ssd\n# \u67e5\u770b\u8282\u70b9\u6807\u7b7e\nk get nodes --show-labels\n</code></pre> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: nginx\nlabels:\nenv: test\nspec:\ncontainers:\n- name: nginx\nimage: nginx\nimagePullPolicy: IfNotPresent\nnodeSelector:\ndisk-type: ssd\n</code></pre></p>","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#affinity","title":"Affinity","text":"","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#_1","title":"\u57fa\u7840\u4ecb\u7ecd","text":"<p>Tip</p> <ul> <li>\u4eb2\u548c: \u4eb2\u8fd1</li> <li>requiredDuringSchedulingIgnoredDuringExecution \u786c\u4eb2\u548c<ul> <li>requiredDuringScheduling<ul> <li>\u8c03\u5ea6\u65f6\u5fc5\u987b\u6ee1\u8db3, \u6bd4\u5982\u4f60\u8bbe\u7f6e\u4e86\u60f3\u8981\u8c03\u5ea6\u5230\u6709\u6807\u7b7e\u662fapp=web\u7684\u8282\u70b9,\u90a3\u4e48\u8282\u70b9\u4e0a\u5fc5\u987b\u6709\u8fd9\u6837\u7684\u6807\u7b7e</li> </ul> </li> <li>IgnoredDuringExecution<ul> <li>\u6267\u884c\u65f6\u5ffd\u7565, \u6bd4\u5982\u4f60pod\u5df2\u7ecf\u8c03\u5ea6\u5b8c\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e86, \u7136\u540e\u73b0\u5728\u5c06\u8282\u70b9\u4e0a\u7684\u6807\u7b7eapp=web \u5220\u9664\u4e86, \u90a3\u4e48\u4e0d\u4f1a\u5f71\u54cd\u8fd9\u4e2apod</li> </ul> </li> </ul> </li> <li>preferredDuringSchedulingIgnoredDuringExecution \u8f6f\u4eb2\u548c<ul> <li>preferredDuringScheduling<ul> <li>\u8c03\u5ea6\u65f6\u6700\u597d\u6ee1\u8db3, \u9996\u9009\u8fd9\u6837\u7684\u8282\u70b9.</li> </ul> </li> <li>IgnoredDuringExecution<ul> <li>\u540c\u786c\u4eb2\u548c</li> </ul> </li> </ul> </li> </ul> <pre><code>k explain pod.spec.affinity.nodeAffinity\nk explain pod.spec.affinity.podAffinity\nk explain pod.spec.affinity.podAntiAffinity\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#_2","title":"\u8282\u70b9\u4eb2\u548c\u6027","text":"<p>Tip</p> <p>NodeSelector \u7684\u5347\u7ea7\u7248,\u4e5f\u662f\u7528labels\u6765\u7ea6\u675f, \u652f\u6301\u66f4\u4e30\u5bcc\u7684\u914d\u7f6e\u89c4\u5219,\u4f7f\u7528\u66f4\u7075\u6d3b \u5982\u679c\u00a0<code>nodeSelector</code>\u00a0\u548c\u00a0<code>nodeAffinity</code>\u00a0\u4e24\u8005\u90fd\u6307\u5b9a\uff0c\u90a3 node \u9700\u8981\u4e24\u4e2a\u6761\u4ef6\u90fd\u6ee1\u8db3\uff0cpod \u624d\u80fd\u8c03\u5ea6</p> <p>\u8282\u70b9\u4eb2\u548c\u6027</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: nginx\nspec:\naffinity:\nnodeAffinity:\nrequiredDuringSchedulingIgnoredDuringExecution: #(1)\nnodeSelectorTerms: #(2)\n- matchExpressions: #(3)\n- key: disk-type\noperator: In #(4)\nvalues:\n- ssd\npreferredDuringSchedulingIgnoredDuringExecution: #(5)\n- weight: 1 #(6)\npreference: #(7)\nmatchExpressions:\n- key: label-1\noperator: In\nvalues:\n- key-1\n- weight: 50\npreference:\nmatchExpressions:\n- key: label-2\noperator: In\nvalues:\n- key-2\ncontainers:\n- name: nginx\nimage: nginx\nimagePullPolicy: IfNotPresent\n</code></pre> <ol> <li>\u786c\u4eb2\u548c\u529b\u914d\u7f6e,\u5fc5\u987b\u7b26\u5408</li> <li>\u8282\u70b9\u9009\u62e9\u5668\u914d\u7f6e, \u53ef\u4ee5\u914d\u7f6e\u591a\u4e2amatchExpressions,\u6ee1\u8db3\u4e00\u4e2a\u5373\u53ef</li> <li>\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2akey, \u5fc5\u987b\u90fd\u6ee1\u8db3</li> <li>\u8fd9\u91cc\u8868\u793a\u8282\u70b9\u5fc5\u987b\u5305\u542b\u952e\u540d\u4e3a disk-type \u7684\u6807\u7b7e,\u5e76\u4e14\u5176\u503c\u4e3assd</li> <li>\u8f6f\u4eb2\u548c\u529b\u914d\u7f6e,\u8868\u793a\u6700\u597d\u7b26\u5408</li> <li>\u8f6f\u4eb2\u548c\u529b\u7684\u6743\u91cd, \u6743\u91cd\u8d8a\u9ad8\u4f18\u5148\u7ea7\u8d8a\u5927,\u8303\u56f41-100</li> <li>\u8f6f\u4eb2\u548c\u529b\u914d\u7f6e\u9879,\u548cweight\u540c\u7ea7</li> </ol> <p>\u5982\u679c\u5b58\u5728\u4e24\u4e2a\u5019\u9009\u8282\u70b9,\u90fd\u6ee1\u8db3 requiredDuringSchedulingIgnoredDuringExecution \u89c4\u5219,\u5176\u4e2d\u4e00\u4e2a\u8282\u70b9\u5177\u6709\u6807\u7b7e label-1:key-1,\u53e6\u4e00\u4e2a\u8282\u70b9\u5177\u6709\u6807\u7b7e label-2:key-2, \u8c03\u5ea6\u5668\u4f1a\u8003\u5bdf\u5404\u4e2a\u8282\u70b9\u7684 weight \u53d6\u503c\uff0c\u5e76\u5c06\u8be5\u6743\u91cd\u503c\u6dfb\u52a0\u5230\u8282\u70b9\u7684\u5176\u4ed6\u5f97\u5206\u503c\u4e4b\u4e0a</p>","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#pod","title":"pod\u95f4 \u4eb2\u548c\u6027\u548c\u53cd\u4eb2\u548c\u6027","text":"<p>Tip</p> <p>PodAffinity : \u60f3\u8981\u548c\u542b\u6709\u67d0\u4e9b\u6807\u7b7e\u7684pod \u90e8\u7f72\u5728\"\u4e00\u8d77\" (\u4e00\u4e2atopology\u4e2d)  podAntiAffinity: \u4e0ePodAffinity \u76f8\u53cd.</p> <p>pod-affinity</p> \u4ec0\u4e48\u662ftopologyKey <ul> <li>\u62d3\u6251\u57df,\u4e3b\u8981\u9488\u5bf9\u8282\u70b9\u8fdb\u884c\u533a\u57df\u7684\u5212\u5206,\u6bd4\u5982\u670d\u52a1\u5668\u6709\u534e\u4e1c\u533a\u8fd9\u7c7b\u7684,\u7528\u8282\u70b9\u7684label\u8fdb\u884c\u5224\u65ad,key\u76f8\u540c\u4e14value\u4e5f\u76f8\u540c\u624d\u662f\u5c5e\u4e8e\u540c\u4e00\u4e2a\u7684\u62d3\u6251\u57df</li> <li>\u5bf9\u4e8e Pod \u4eb2\u548c\u6027\u800c\u8a00,\u5728 requiredDuringSchedulingIgnoredDuringExecution \u548c preferredDuringSchedulingIgnoredDuringExecution \u4e2d,topologyKey \u4e0d\u5141\u8bb8\u4e3a\u7a7a</li> <li>\u5bf9\u4e8e requiredDuringSchedulingIgnoredDuringExecution \u8981\u6c42\u7684 Pod \u53cd\u4eb2\u548c\u6027, \u51c6\u5165\u63a7\u5236\u5668 LimitPodHardAntiAffinityTopology \u8981\u6c42 topologyKey \u53ea\u80fd\u662f kubernetes.io/hostname. \u5982\u679c\u4f60\u5e0c\u671b\u4f7f\u7528\u5176\u4ed6\u5b9a\u5236\u62d3\u6251\u903b\u8f91,\u4f60\u53ef\u4ee5\u66f4\u6539\u51c6\u5165\u63a7\u5236\u5668\u6216\u8005\u7981\u7528\u4e4b</li> </ul> <pre><code>k explain pod.spec.affinity.podAffinity.requiredDuringSchedulingIgnoredDuringExecution.topologyKey\n# \u8282\u70b9\u9ed8\u8ba4\u90fd\u6709\u4e00\u4e2a \u6807\u7b7e\nk get no --show-labels\n\n#\u6211\u4eec\u80fd\u770b\u5230\u5404\u4e2a\u8282\u70b9\u5e94\u8be5\u90fd\u6709\u8fd9\u6837\u4e00\u4e2a\u6807\u7b7e\nkubernetes.io/hostname=xxx\n#  \u6211\u4eec\u53ef\u4ee5\u7ed9\u4e0d\u540c\u7684\u8282\u70b9\u8bbe\u7f6e\u76f8\u540c\u7684\u6807\u7b7e, \u540e\u7eed\u53ef\u4ee5\u7528\u4ee5\u8868\u793a\u5b83\u4eec\u5728\u540c\u4e00\u4e2atopology\nk label no node1 node2 area=north\n</code></pre> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: redis-cache\nspec:\nselector:\nmatchLabels:\napp: store\nreplicas: 3\ntemplate:\nmetadata:\nlabels:\napp: store\nspec:\naffinity:\npodAntiAffinity:\nrequiredDuringSchedulingIgnoredDuringExecution:\n- labelSelector:\nmatchExpressions:\n- key: app\noperator: In\nvalues:\n- store\ntopologyKey: \"kubernetes.io/hostname\"\ncontainers:\n- name: redis-server\nimage: redis:3.2-alpine\n</code></pre> <ol> <li>\u53cd\u4eb2\u548c\u6027\u89c4\u5219\u8868\u793a: Pod \u4e0d\u80fd\u88ab\u8c03\u5ea6\u5230\u8fd9\u6837\u7684\u8282\u70b9(\u96c6\u7fa4/\u57df)\u4e2d<ol> <li>\u5177\u6709\u6807\u7b7e<code>kubernetes.io/hostname=xxx</code>\u7684\u8282\u70b9\u4eec(\u96c6\u7fa4),\u6216\u8bf4\u5728\u8fd9\u6837\u4e00\u4e2a\u540d\u5b57\u53eb<code>kubernetes.io/hostname=xxx</code>\u7684\u57df\u4e2d</li> <li>\u4e14 \u96c6\u7fa4(\u6216\u57df)\u4e2d\u81f3\u5c11\u6709\u4e00\u4e2a\u8282\u70b9\u8fd0\u884c\u7740\u4e00\u4e2a\u5e26\u6709 app=store \u6807\u7b7e\u7684 Pod</li> </ol> </li> <li>\u9996\u5148\u7b2c\u4e00\u4e2aredis\u526f\u672c, \u56e0\u4e3a\u73b0\u5728\u867d\u7136\u6bcf\u4e2a\u8282\u70b9\u90fd\u6709kubernetes.io/hostname\u7684\u6807\u7b7e,\u4f46\u662f\u6ca1\u6709\u8fd0\u884c\u7740 app=store\u6807\u7b7e \u7684pod,\u6240\u4ee5\u968f\u4fbf\u9009\u4e00\u4e2a\u8282\u70b9\u90e8\u7f72\u7b2c\u4e00\u4e2aredis\u526f\u672c,\u6bd4\u5982node1</li> <li>\u90e8\u7f72\u7b2c\u4e00\u4e2aredis\u526f\u672c\u540e, \u8fd9\u4e2a\u65f6\u5019\u51fa\u73b0\u4e86\u8fd9\u6837\u7684\u8282\u70b9<ol> <li>\u8fd0\u884c\u7740\u5e26\u6709 app=store \u6807\u7b7e\u7684 Pod,\u4e14\u8282\u70b9\u5177\u6709\u6807\u7b7ekubernetes.io/hostname=node1</li> </ol> </li> <li>\u90e8\u7f72\u7b2c\u4e8c\u4e2aredis\u526f\u672c, \u8fd9\u4e2a\u65f6\u5019\u53d1\u73b0 node1 \u662f\u4e0d\u7b26\u5408\u7684, \u56e0\u4e3a\u6709 app=store \u7684pod \u4e14\u8282\u70b9\u6709\u6807\u7b7e\u662fkubernetes.io/hostname,\u90a3\u4e48\u5c31\u5728\u5176\u4ed6\u8282\u70b9\u4e0a\u968f\u4fbf\u9009\u4e00\u4e2a</li> <li>\u90e8\u7f72\u7b2c\u4e09\u4e2a\u540c\u7406, \u8fd9\u6837\u5c31\u4f1a\u5c063\u4e2aredis \u90e8\u7f72\u5230\u4e0d\u540c\u7684\u8282\u70b9\u4e0a\u53bb\u4e86.</li> </ol> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: web-server\nspec:\nselector:\nmatchLabels:\napp: web-store\nreplicas: 3\ntemplate:\nmetadata:\nlabels:\napp: web-store\nspec:\naffinity:\npodAntiAffinity:\nrequiredDuringSchedulingIgnoredDuringExecution:\n- labelSelector:\nmatchExpressions:\n- key: app\noperator: In\nvalues:\n- web-store\ntopologyKey: \"kubernetes.io/hostname\"\npodAffinity:\nrequiredDuringSchedulingIgnoredDuringExecution:\n- labelSelector:\nmatchExpressions:\n- key: app\noperator: In\nvalues:\n- store\ntopologyKey: \"kubernetes.io/hostname\"\ncontainers:\n- name: web-app\nimage: nginx:1.16-alpine\n</code></pre> <ol> <li>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u9a6c\u4e0a\u7406\u89e3,\u6839\u636e\u53cd\u4eb2\u548c\u6027\u89c4\u5219 ,\u5b83\u4eec3\u4e2a\u526f\u672c\u80af\u5b9a\u4f1a\u90e8\u7f72\u5230\u4e0d\u540c\u7684\u8282\u70b9\u4e0a</li> <li>\u63a5\u7740\u6839\u636e\u4eb2\u548c\u6027\u89c4\u5219: pod\u8981\u88ab\u8c03\u5ea6\u5230\u8fd9\u6837\u7684\u8282\u70b9(\u96c6\u7fa4/\u57df)\u4e2d<ol> <li>\u5177\u6709\u6807\u7b7e<code>kubernetes.io/hostname=xxx</code>\u7684\u8282\u70b9\u4eec(\u96c6\u7fa4),\u6216\u8bf4\u5728\u8fd9\u6837\u4e00\u4e2a\u540d\u5b57\u53eb<code>kubernetes.io/hostname=xxx</code>\u7684\u57df\u4e2d</li> <li>\u4e14 \u96c6\u7fa4(\u6216\u57df)\u4e2d\u81f3\u5c11\u6709\u4e00\u4e2a\u8282\u70b9\u8fd0\u884c\u7740\u4e00\u4e2a\u5e26\u6709 <code>app=store</code> \u6807\u7b7e\u7684 Pod</li> </ol> </li> <li>\u6839\u636e\u524d\u9762\u7684redis\u526f\u672c, \u73b0\u57283\u4e2a\u8282\u70b9\u662f \u6709<code>app=store</code>\u6807\u7b7e\u7684pod\u8fd0\u884c,\u7136\u540e\u8282\u70b9\u6807\u7b7e\u5177\u6709<code>kubernetes.io/hostname=xxx</code>,\u5b83\u4eec\u7b26\u5408\u4eb2\u548c\u6027\u89c4\u5219</li> <li>\u7b2c\u4e00\u4e2a\u526f\u672c\u968f\u673a\u9009\u62e9\u4e00\u4e2a redis\u6240\u5728\u7684\u8282\u70b9, \u7136\u540e\u7b2c\u4e8c\u4e2a\u6839\u636e\u53cd\u4eb2\u548c\u4f1a\u9009\u62e9\u53e6\u5916\u4e00\u4e2a redis\u6240\u5728\u7684\u8282\u70b9, \u7b2c\u4e09\u4e2a\u540c\u7406</li> </ol> <p>\u6700\u540e\u7684\u7ed3\u679c</p> node-1 node-2 node-3 web-server-1 web-server-2 web-server-3 redis-cache-1 redis-cache-2 redis-cache-3","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#tainttoleration","title":"Taint\u4e0eToleration","text":"","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#_3","title":"\u57fa\u7840\u4ecb\u7ecd","text":"<p>Tip</p> <p>Taint: \u6c61\u70b9  Toleration: \u5bb9\u5fcd  \u539f\u7406:\u4e00\u65e6\u67d0\u4e2a\u8282\u70b9\u88ab\u52a0\u4e0a\u4e86\u4e00\u4e2aTaint(\u7406\u89e3\u4e3a\u88ab\u6253\u4e0a\u4e86\"\u6c61\u70b9\"),\u90a3\u4e48\u6b63\u5e38\u60c5\u51b5\u4e0b\u6240\u6709Pod\u90fd\u5acc\u8fd9\u6837\u7684\u8282\u70b9\"\u810f\",\u90fd\u4e0d\u4f1a\u5728\u8fd9\u6837\u7684\u8282\u70b9\u4e0a\u8fd0\u884c \u9664\u975e\u6709\u4e2a\u522b\u7684Pod\u58f0\u660e\u81ea\u5df1\u80fd\u201c\u5bb9\u5fcd\u201d\u8fd9\u4e2a\u201c\u6c61\u70b9\u201d,\u5373\u58f0\u660e\u4e86Toleration, \u8fd9\u6837\u5b83\u53ef\u4ee5\u5728\u8fd9\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c. Toleration\u662f\u8ba9Pod\u5bb9\u5fcd\u8282\u70b9\u4e0a\u8bbe\u7f6e\u7684\u6c61\u70b9Taint pod\u6709\u5bb9\u5fcd\u4e0d\u662f\u8bf4\u4f60\u5c31\u4f1a\u8c03\u5ea6\u5230\u6709\u4e2a\u6c61\u70b9\u7684\u8282\u70b9, \u53ea\u662f\u8bf4\u4f60\u8fd9\u4e2apod\u53ef\u4ee5\u8c03\u5ea6\u5230\u6709\u8fd9\u4e2a\u6c61\u70b9\u7684\u8282\u70b9 \u8282\u70b9\u53ef\u4ee5\u6709\u591a\u4e2a\u6c61\u70b9, pod\u5fc5\u987b\u5168\u90e8\u5bb9\u5fcd\u8fd9\u4e9b\u6c61\u70b9\u624d\u80fd\u591f\u8c03\u5ea6\u5230\u8be5\u8282\u70b9</p> <p>Note</p> <p>\u5c31\u50cf\u627e\u7537/\u5973\u670b\u53cb, \u4e0d\u80fd\u5bb9\u5fcd\u5bf9\u65b9\u7684\u7f3a\u70b9,pass, \u53ef\u4ee5\u5bb9\u5fcd,ok</p> Taint \u6548\u679c(\u7c7b\u578b) \u89e3\u91ca NoSchedule 1. \u8282\u70b9\u6253\u4e0a\u6c61\u70b9\u540e,\u7981\u6b62\u8c03\u5ea6\u5230\u8be5\u8282\u70b92. \u5df2\u7ecf\u5728\u8be5\u8282\u70b9\u4e0a\u7684Pod\u4e0d\u53d7\u5f71\u54cd,\u5bb9\u5fcd\u8fd9\u4e2a\u6c61\u70b9\u7684pod\u53ef\u4ee5\u88ab\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9 NoExecute 1. \u8282\u70b9\u6253\u4e0a\u6c61\u70b9\u540e,\u7981\u6b62\u8c03\u5ea6\u5230\u8be5\u8282\u70b92. \u5df2\u7ecf\u5728\u8be5\u8282\u70b9\u4e0a\u7684,\u4f46\u6ca1\u6709\u5bb9\u5fcd\u8fd9\u4e2a\u6c61\u70b9\u7684pod\uff0c\u4f1a\u7acb\u9a6c\u88ab\u9a71\u9010  3. \u5982\u679cpod\u5bb9\u5fcd\u4e86\u6c61\u70b9\u4f46\u662f\u8bbe\u7f6e\u4e86tolerationSeconds,\u5219\u8868\u793apod\u5bb9\u5fcd\u542b\u8fd9\u4e2a\u6c61\u70b9\u7684\u8282\u70b9tolerationSeconds\u79d2\u540e(\u5bb9\u5fcd\u4e5f\u6709\u4e2a\u9650\u5ea6),\u88ab\u9a71\u90104. \u5982\u679cpod\u5bb9\u5fcd\u4e86\u6c61\u70b9,\u4e14\u6ca1\u6709\u8bbe\u7f6etolerationSeconds,\u90a3\u4e48\u53ef\u4ee5\u88ab\u8c03\u5ea6\u5230\u8be5\u8282\u70b9,\u4e0d\u4f1a\u88ab\u9a71\u90105. \u5355\u72ec\u7684pod\u88ab\u9a71\u9010\u540e\u4e0d\u4f1a\u91cd\u65b0\u8c03\u5ea6 PreferNoSchedule \u8282\u70b9\u88ab\u6253\u4e0akey=value:PreferNoSchedule \u7684\u6c61\u70b9, \u4f60\u60f3\u8981pod\u8c03\u5ea6\u5230\u8fd9\u6837\u7684\u8282\u70b9, pod\u662f\u65e0\u9700\u6709\u5bf9\u8fd9\u4e2a\u6c61\u70b9\u7684\u5bb9\u5fcd \u8fd9\u4e2aPreferNoSchedule\u8868\u793a\u5c3d\u91cf\u907f\u514d\u5c06Pod\u8c03\u5ea6\u5230\u8fd9\u6837\u7684\u8282\u70b9\u4e0a\uff0c\u5982\u679c\u6ca1\u6709\u66f4\u5408\u9002\u7684\u8282\u70b9\uff0c\u53ef\u4ee5\u90e8\u7f72\u5230\u8be5\u8282\u70b9","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#_4","title":"\u6c61\u70b9\u64cd\u4f5c\u547d\u4ee4","text":"<p>Important</p> <p>key \u548ceffect\u4e00\u8d77 \u624d\u80fd\u8868\u793a \u662f\u5426\u662f\u540c\u4e00\u4e2a \u6c61\u70b9</p> \u589e\u67e5\u5220\u6539 <pre><code>#\u521b\u5efa\u4e00\u4e2a\u6c61\u70b9(\u4e00\u4e2a\u8282\u70b9\u53ef\u4ee5\u6709\u591a\u4e2a\u6c61\u70b9):\n# TAINT_VALUE\u53ef\u4ee5\u4e0d\u5199, \u5c31\u662f =TAINT_VALUE  \u4e0d\u5199\nk taint nodes NODE_NAME TAINT_KEY=TAINT_VALUE:EFFECT\nk taint nodes node01 ssd=true:PreferNoSchedule\n</code></pre> <pre><code>k describe no node1 |grep taint -iA 10\nk describe no master1 |grep taint -iA 10\n# master \u9ed8\u8ba4\u662f\u4e0d\u4f1a\u88ab\u8c03\u5ea6\u5230\u7684.\nTaints:             node-role.kubernetes.io/master:NoSchedule\n</code></pre> <pre><code>k taint no node1 hello=tomcat:NoSchedule-\nk taint no node1 hello:NoSchedule- # \u8fd9\u6837\u5c31\u53ef\u4ee5\u4e86. \u56e0\u4e3a\u540c\u6837\u7684key\u53ea\u4f1a\u6709\u4e00\u4e2a\nk taint no node1 hello-\u00a0 #\u5220\u9664\u8fd9\u4e2akey\u7684\u6240\u6709\u6c61\u70b9 (\u4e0d\u540c\u7684effect)\n</code></pre> <pre><code># key \u548ceffect \u4f5c\u4e3a \u533a\u5206\u4e0d\u540c\u7684 \u6c61\u70b9\n# \u4fee\u6539 key\u4e3ahello effect\u4e3aNoSchedule \u7684\u6c61\u70b9\u7684 value\u503c, \u6ca1\u6709\u5c31\u521b\u5efa\u8be5\u6c61\u70b9\nk taint no node1 hello=world:NoSchedule --overwrite\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#_5","title":"\u6c61\u70b9\u76f8\u5173\u914d\u7f6e","text":"","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#_6","title":"\u5185\u7f6e\u6c61\u70b9","text":"<pre><code>node.kubernetes.io/not-ready:\u8282\u70b9\u672a\u51c6\u5907\u597d\uff0c\u76f8\u5f53\u4e8e\u8282\u70b9\u72b6\u6001Ready\u7684\u503c\u4e3aFalse\u3002\nnode.kubernetes.io/unreachable:Node Controller\u8bbf\u95ee\u4e0d\u5230\u8282\u70b9\uff0c\u76f8\u5f53\u4e8e\u8282\u70b9\u72b6\u6001Ready\u7684\u503c\u4e3aUnknown\u3002\nnode.kubernetes.io/out-of-disk:\u8282\u70b9\u78c1\u76d8\u8017\u5c3d\u3002\nnode.kubernetes.io/memory-pressure:\u8282\u70b9\u5b58\u5728\u5185\u5b58\u538b\u529b\u3002\nnode.kubernetes.io/disk-pressure:\u8282\u70b9\u5b58\u5728\u78c1\u76d8\u538b\u529b\u3002\nnode.kubernetes.io/network-unavailable:\u8282\u70b9\u7f51\u7edc\u4e0d\u53ef\u8fbe\u3002\nnode.kubernetes.io/unschedulable:\u8282\u70b9\u4e0d\u53ef\u8c03\u5ea6\u3002\nnode.cloudprovider.kubernetes.io/uninitialized:\u5982\u679cKubelet\u542f\u52a8\u65f6\u6307\u5b9a\u4e86\u4e00\u4e2a\u5916\u90e8\u7684cloudprovider,\u5b83\n\u5c06\u7ed9\u5f53\u524d\u8282\u70b9\u6dfb\u52a0\u4e00\u4e2aTaint\u5c06\u5176\u6807\u8bb0\u4e3a\u4e0d\u53ef\u7528\u3002\u5728cloud-controller-manager\u7684\u4e00\u4e2acontroller\u521d\u59cb\u5316\u8fd9\u4e2a \u8282\u70b9\u540e\uff0cKubelet\u5c06\u5220\u9664\u8fd9\u4e2aTaint\u3002\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#_7","title":"\u4e0d\u53ef\u7528\u591a\u4e45\u624d\u4f1a\u88ab\u6253\u4e0a\u6c61\u70b9","text":"<p>kube-controller-manager \u53c2\u6570</p> /etc/kubernetes/manifests/kube-controller-manager.yaml \u76f8\u5173\u914d\u7f6e<pre><code>spec:\ncontainers:\n- command:\n- kube-controller-manager\n- ...\n- --node-monitor-grace-period=40s #(1)\n- --node-monitor-period=5s #(2)\n- ...\n</code></pre> <ol> <li>\u6dfb\u52a0\u8fd9\u4e2a \u9ed8\u8ba4\u662f40s, \u8868\u793a40s \u5185\u4e00\u76f4\u4e0d\u53ef\u7528,\u5c31\u4f1a\u88ab\u6253\u4e0a\u6c61\u70b9</li> <li>5s\u4f1a\u53bb\u63a2\u6d4b\u4e00\u6b21\u8282\u70b9\u662f\u5426\u53ef\u7528</li> </ol> <p>Tip</p> <p>\u4f60\u7684\u8282\u70b9\u53d1\u751f\u6545\u969c, pod\u9700\u8981\u7b49\u5f8540s+pod\u5bf9\u6c61\u70b9\u7684\u5bb9\u5fcd\u65f6\u95f4tolerationSeconds \u53ef\u4ee5\u51c6\u59072\u4e2a\u8282\u70b9,\u5c06node1 \u5173\u673a, \u67e5\u770b <code>k get no</code> \u770b\u72b6\u6001, \u5927\u698240s \u624d\u4f1a\u770b\u5230 not_ready</p>","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#pod_1","title":"pod\u9ed8\u8ba4\u5bb9\u5fcd","text":"<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: nginx\nlabels:\nenv: test\nspec:\ncontainers:\n- name: nginx\nimage: nginx:1.14.2\nimagePullPolicy: IfNotPresent\n</code></pre> <pre><code># \u521b\u5efa\u540e\nk get pod nginx2 -o yaml|grep tolerations: -iA 10\ntolerations:\n  - effect: NoExecute\n    key: node.kubernetes.io/not-ready # (1)\noperator: Exists\n    tolerationSeconds: 300\n- effect: NoExecute\n    key: node.kubernetes.io/unreachable\n    operator: Exists\n    tolerationSeconds: 300\n</code></pre> <ol> <li>\u8282\u70b9\u6ca1\u6709ready\u65f6\u4f1a\u6253\u4e0a\u8fd9\u6837\u7684\u6c61\u70b9,\u5728\u8282\u70b9\u4e0a\u7684pod(\u88ab\u63a7\u5236\u5668\u7ba1\u7406\u7684pod)\u9ed8\u8ba4\u4f1a\u7b49\u5f855m\u4e2d\u624d\u4f1a\u88ab\u9a71\u9010,\u91cd\u65b0\u8c03\u5ea6</li> </ol> <p>Tip</p> <p>\u4f60\u53ef\u80fd\u4f1a\u7591\u95ee, \u51fa\u4e86\u95ee\u9898, pod 5m\u540e\u624d\u4f1a\u88ab\u91cd\u65b0\u8c03\u5ea6, \u662f\u4e0d\u662f\u6709\u70b9\u957f\u4e86.  \u8fd9\u4e2a\u8bbe\u7f6e\u7684\u539f\u56e0\u662f\u4e00\u822c\u60c5\u51b5\u4e0b\u8282\u70b9\u662f\u77ed\u6682\u7684\u7f51\u7edc\u4e2d\u65ad\u6216\u4e34\u65f6\u6545\u969c,\u65f6\u95f4\u4e0d\u4f1a\u592a\u957f,\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u907f\u514d\u5728\u8282\u70b9\u6682\u65f6\u4e0d\u53ef\u7528\u7684\u60c5\u51b5\u4e0b\u9891\u7e41\u5730\u9a71\u9010\u548c\u91cd\u5efa Pod\uff0c\u4ee5\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684\u670d\u52a1\u4e2d\u65ad\u548c\u8d44\u6e90\u6d6a\u8d39</p> <p>\u5982\u679c\u4f60\u786e\u5b9a\u8282\u70b9\u4f1a\u6545\u969c\u8f83\u957f\u4e00\u6bb5\u65f6\u95f4</p> <p>toleration-patch.yaml<pre><code>spec:\ntolerations:\n- effect: NoExecute\nkey: node.kubernetes.io/not-ready\noperator: Exists\ntolerationSeconds: 60\n</code></pre> <pre><code># \u66f4\u65b0\nk patch po nginx2 --patch \"$(cat toleration-patch.yaml)\"\n</code></pre></p>","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#pod_2","title":"pod\u5bb9\u5fcd\u5ea6\u64cd\u4f5c\u547d\u4ee4","text":"key value effect\u5b8c\u5168\u5339\u914d\u5bb9\u5fcdkey,effect\u5339\u914d\u7684\u8282\u70b9\u5bb9\u5fcdkey\u5339\u914d\u7684\u8282\u70b9\u5bb9\u5fcd\u6240\u6709\u6c61\u70b9 <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: nginx\nlabels:\nenv: test\nspec:\ncontainers:\n- name: nginx\nimage: nginx\nimagePullPolicy: IfNotPresent\ntolerations:\n- key: \"key1\"\noperator: \"Equal\"\nvalue: \"value1\"\neffect: \"NoExecute\"\ntolerationSeconds: 3600 #(1)\n</code></pre> <ol> <li>\u5982\u679c\u6709\u8fd9\u4e2a\u8bbe\u7f6e,\u8868\u793a\u5bb9\u5fcd\u8fd9\u4e2a\u8282\u70b93600s\u540e,\u9a71\u9010</li> </ol> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: nginx\nlabels:\nenv: test\nspec:\ncontainers:\n- name: nginx\nimage: nginx\nimagePullPolicy: IfNotPresent\ntolerations:\n- key: \"key1\"\noperator: \"Exists\"\neffect: \"NoSchedule\"\n</code></pre> <p>Tip</p> <p>\u65e0\u9700\u6548\u679ceffect \u5339\u914d</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: nginx\nlabels:\nenv: test\nspec:\ncontainers:\n- name: nginx\nimage: nginx\nimagePullPolicy: IfNotPresent\ntolerations:\n- key: \"key1\"\noperator: \"Exists\"\n</code></pre> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: nginx\nlabels:\nenv: test\nspec:\ncontainers:\n- name: nginx\nimage: nginx\nimagePullPolicy: IfNotPresent\ntolerations:\n- operator: \"Exists\"\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/scheduler/#_8","title":"\u95ee\u9898\u7b54\u7591","text":"<p>\u6307\u5b9a\u6709\u6c61\u70b9\u7684nodeName\u7684pod \u4f1a\u5982\u4f55</p> <ul> <li>\u6ca1\u6709\u8bbe\u7f6e\u5bb9\u5fcd\u7684\u60c5\u51b5\u4e0b,\u4e5f\u4f1a\u5148\u521b\u5efapod,\u56e0\u4e3a\u6307\u5b9a\u4e86nodeName\u5c31\u4f1a\u8df3\u8fc7\u8c03\u5ea6\u5668,\u7136\u540e\u624d\u4f1a\u6839\u636e\u8282\u70b9\u4e0a\u6c61\u70b9\u7684effect\u505a\u76f8\u5173\u884c\u4e3a</li> <li>\u6bd4\u5982<ol> <li>node1\u6709 k=v:NoExecute, pod \u8bbe\u7f6enodeName=node1</li> <li>\u901a\u8fc7describe pod  \u53ef\u4ee5\u770b\u5230pod \u521b\u5efa \u5e76Started , \u540e\u9a6c\u4e0a\u5c31\u88ab\u9a71\u9010\u4e86(\u4f46\u662fdescribe \u770b\u4e0d\u5230)</li> <li>\u53ef\u4ee5\u7ed9pod \u8bbe\u7f6e\u4e00\u4e2apreStop sleep 20 \u8fd9\u6837\u53ef\u4ee5\u770b\u5230...</li> </ol> </li> </ul>","tags":["k8s"]},{"location":"devops/k8s/core/service/ingress/","title":"ingress","text":""},{"location":"devops/k8s/core/service/ingress/#_1","title":"\u4e3a\u4ec0\u4e48\u9700\u8981?","text":"<ol> <li>\u5916\u90e8\u8bbf\u95ee\u6211\u4eec\u7684pod\u63d0\u4f9b\u7684\u670d\u52a1, \u600e\u4e48\u529e?</li> <li>\u76f4\u63a5\u4f7f\u7528svc \u4e0d\u884c\u5417? \u76f4\u63a5 nodePort\u7c7b\u578b?</li> <li>\u9700\u8981\u641e\u597d\u591a\u7aef\u53e3, \u7ba1\u7406\u9ebb\u70e6</li> </ol>"},{"location":"devops/k8s/core/service/ingress/#_2","title":"\u4ecb\u7ecd","text":"<p>ingress  \u7528\u4e8e\u5b9e\u73b0 \u7528\u57df\u540d\u7684\u65b9\u5f0f\u8bbf\u95ee k8s \u5185\u90e8\u5e94\u7528</p> <p>ingress \u4e3ak8s\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u63d0\u4f9b\u4e86\u5165\u53e3, \u53ef\u4ee5\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u3001SsL\u7ec8\u6b62\u548c\u57fa\u4e8e\u57df\u540d\u7684\u865a\u62df\u4e3b\u673a\u3001\u5e94\u7528\u7684\u7070\u5ea6\u53d1\u5e03\u7b49\u529f\u80fd</p> <p></p>"},{"location":"devops/k8s/core/service/ingress/#_3","title":"\u5b9e\u6218","text":"<p>\u90e8\u7f72 \u624b\u52a8\u5b89\u88c5k8s\u96c6\u7fa4\u7684\u7cfb\u7edf\u90e8\u7f72\u65b9\u5f0f</p> <pre><code>wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/baremetal/deploy.yaml\n\nkubectl apply -f  deploy.yaml\n</code></pre>"},{"location":"devops/k8s/core/service/service/","title":"service","text":"","tags":["k8s"]},{"location":"devops/k8s/core/service/service/#_1","title":"\u4e3a\u4ec0\u4e48\u6709\u8fd9\u4e2a\u8bbe\u8ba1","text":"<p>Tip</p> <p>\u6211\u4eec\u524d\u9762\u8fd9\u4e2a\u90a3\u4e2a\u7684pod \u5404\u79cd\u641e, \u662f\u65f6\u5019\u8ba9\u5916\u9762\u7684\u7528\u6237\u6765\u8bbf\u95ee\u6211\u4eec\u901a\u8fc7pod \u63d0\u4f9b\u7684\u670d\u52a1\u4e86</p> <p>\u4e3a\u4ec0\u4e48</p> <ol> <li>\u50cfdeploy \u90e8\u7f72\u7684\u4e00\u7ec4pod \u4e3a\u6211\u4eec\u63d0\u4f9b\u670d\u52a1, \u5982\u679c\u5176\u4e2d\u4e00\u4e2apod \u91cd\u5efa\u4e86,ip\u4fee\u6539\u4e86, \u5982\u4f55\u8bbf\u95ee\u5230\u5462?</li> <li>\u5c31\u50cf\u6211\u4eec\u53bb\u5c31\u9910, \u6211\u4eec\u4e0d\u9700\u8981\u77e5\u9053\u5177\u4f53\u4e3a\u4f60\u63d0\u4f9b\u670d\u52a1\u7684\u4eba\u7684\u540d\u5b57, \u53ea\u9700\u8981\u53eb\u670d\u52a1\u5458,\u5c31\u4f1a\u6709\u4eba\u6765\u63d0\u4f9b\u670d\u52a1.</li> </ol> <p>\u5c31\u662f\u5f88\u591apod\u5728\u524d\u7aef\u7684\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u8c03\u5ea6\u5668 service \u5148\u5230\u7684endpoint controller \u7136\u540e\u901a\u8fc7\u627e\u5230\u5bf9\u5e94\u7684pod</p>","tags":["k8s"]},{"location":"devops/k8s/core/service/service/#clusterip","title":"clusterIP","text":"<p>Tip</p> <p>Service\u7684\u9ed8\u8ba4\u7c7b\u578b\uff0c\u670d\u52a1\u88ab\u53d1\u5e03\u81f3\u4ec5\u96c6\u7fa4\u5185\u90e8\u53ef\u89c1\u7684\u865a\u62dfIP\u5730\u5740\u4e0a</p> <p>deploy-nginx2.yaml<pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: deploy-nginx\nname: deploy-nginx2\nspec:\nreplicas: 2\nrevisionHistoryLimit: 10\nselector:\nmatchLabels:\napp: pod-deploy-nginx2\nstrategy:\nrollingUpdate:\nmaxSurge: 1\nmaxUnavailable: 1\ntype: RollingUpdate\ntemplate:\nmetadata:\nlabels:\napp: pod-deploy-nginx2\nspec:\nrestartPolicy: Always\ncontainers:\n- image: nginx:1.14.2-alpine\nimagePullPolicy: IfNotPresent\nname: c-deploy-nginx\nports:\n- containerPort: 80\nname: web\nprotocol: TCP\n</code></pre> <pre><code>k apply -f deploy-nginx2.yaml\n</code></pre> svc-deploy-nginx.yaml<pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: svc-deploy-nginx\nspec:\nselector: # \u5173\u8054\u54ea\u4e9b pod ,\u4e0a\u9762\u6211\u4eecdeploy \u521b\u5efa\u7684pod \u5c31\u6709\u8fd9\u4e2a\u6807\u7b7e\napp: pod-deploy-nginx2\n# clusterIP: 10.96.1.11 # \u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u4f60\u8981\u7684ip,\u9ed8\u8ba4\u662f\u968f\u673a\u5206\u914d\u7684\u4e00\u4e2a\ntype: ClusterIP\nports:\n- protocol: TCP\nport: 8800   # service \u7aef\u53e3\ntargetPort: web  # \u60f3\u8981\u5173\u8054\u7684pod \u5b83\u4eec\u66b4\u9732\u7684\u7aef\u53e3  \u53ef\u4ee5\u519980 , \u6216\u8005\u50cf\u8fd9\u6837 \u4f7f\u7528\u4e0a\u9762pod\u5b9a\u4e49\u7684\u7aef\u53e3\u540d\u79f0\n</code></pre></p> <pre><code># \u521b\u5efa svc, \u5fc5\u987b\u548cpod \u5728\u540c\u4e00\u4e2anamespace\nk apply -f svc-deploy-nginx.yaml\nk get svc\n    NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE\n    svc-deploy-nginx   ClusterIP   10.99.229.242   &lt;none&gt;        80/TCP    6m38s\n# \u670d\u52a1\u9009\u62e9pod\u7684\u63a7\u5236\u5668\u4e0d\u65ad\u626b\u63cf\u4e0e\u6807\u7b7e\u9009\u62e9\u5339\u914d\u7684 Pod\uff0c\u7136\u540e\u5c06\u6240\u6709\u66f4\u65b0\u53d1\u5e03\u5230\u4e5f\u79f0\u4e3a \u201csvc-deploy-nginx\u201d \u540c\u540d\u7684 Endpoint \u5bf9\u8c61\n# ep endpoint\nk get ep\n    NAME               ENDPOINTS                       AGE\n    svc-deploy-nginx   10.244.1.77:80,10.244.2.78:80   2m59s\n# \u540c\u540dep\u4e2d\u5173\u8054\u76842\u4e2a ip\u5730\u5740 \u6b63\u662f 2\u4e2apod\u7684ip\nk get po -l app=pod-deploy-nginx2 -o wide\n    NAME                             READY   STATUS    RESTARTS   AGE   IP            NODE\n    deploy-nginx2-57cfcdb8c7-6nhzj   1/1     Running   0          11m   10.244.2.78   node2\n    deploy-nginx2-57cfcdb8c7-sqpr4   1/1     Running   0          11m   10.244.1.77   node1\n\n# \u76f4\u63a5\u8bbf\u95ee svc\u7684ip\u548c\u7aef\u53e3 ,\u5c31\u80fd\u8bbf\u95ee\u5230\u540e\u9762\u5b9e\u9645pod\u91cc\u7684nginx \u670d\u52a1\u4e86. \u800c\u4e14\u8d1f\u8f7d\u5747\u8861\n# \u8bbf\u95eesvc, \u4f1a\u901a\u8fc7ep \u627e\u5230\u5bf9\u5e94\u7684pod ip\u5730\u5740\ncurl 10.99.229.242:8800\n\n# \u8fdb\u5165pod \u5bb9\u5668\ncat /etc/resolv.conf\n    nameserver 10.96.0.10\n    search default.svc.cluster.local svc.cluster.local cluster.local\n    options ndots:5\nping svc-deploy-nginx\nwget svc-deploy-nginx:8800 #ok\u7684\nwget svc-deploy-nginx.default.svc.cluster.local:8800\n# \u5220\u9664pod \u540e, deploy \u91cd\u5efa\u4e86pod ,\u7136\u540eep \u4f1a\u91cd\u73b0\u5173\u8054\u65b0\u7684pod ip\n# \u5220\u9664svc \u4f1a\u5c06\u5173\u8054\u7684ep\u4e5f\u5220\u9664\n</code></pre> svc-nginx-multi-port.yaml<pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: svc-nginx-multi-port\nspec:\nselector:\napp: pod-deploy-nginx\ntype: ClusterIP\nports:\n- protocol: TCP\nport: 80\ntargetPort: web\n- protocol: TCP\nport: 8080\ntargetPort: web2\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/service/service/#nodeport","title":"nodePort","text":"<p>ClusterIP \u53ea\u80fd\u5728\u96c6\u7fa4\u5185\u90e8\u8bbf\u95ee (\u9ed8\u8ba4)</p> <p>\u6620\u5c04\u4e00\u4e2a\u7aef\u53e3 \u7ed9node, \u5916\u90e8\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95eenode\u7684\u7aef\u53e3</p> svc-nginx-node-port.yaml<pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: svc-nginx-node-port\nspec:\nselector:\napp: pod-deploy-nginx2\n# clusterIP: 10.96.1.11 # \u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u4f60\u8981\u7684ip,\u9ed8\u8ba4\u662f\u968f\u673a\u5206\u914d\u7684\u4e00\u4e2a\ntype: NodePort\nports:\n- protocol: TCP\nport: 80\ntargetPort: web\n#nodePort: 30192 # \u53ef\u4ee5\u6307\u5b9a \u4e5f\u53ef\u4ee5\u4e0d\u5199, \u4e0d\u5199\u5c31\u4f1a\u968f\u673a\n</code></pre> <pre><code># \u770b\u5230\u968f\u673a\u7aef\u53e3\nk get svc\n    NAME                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE\n    svc-nginx-node-port   NodePort    10.105.50.239   &lt;none&gt;        80:30046/TCP   1s\n\nk get no -o wide\n# \u73b0\u5728\u53ef\u4ee5\u7528\u4efb\u610f\u4e00\u4e2anode \u7684ip :30046 \u6765\u8bbf\u95eepod\u670d\u52a1\n</code></pre> <p>\u63a7\u5236\u968f\u673a\u4f7f\u7528\u7684nodePort</p> <p>/etc/kubernetes/manifests/kube-apiserver.yaml \u5728spec.containers.command \u6700\u540e\u4e00\u884c\u6dfb\u52a0,\u6bd4\u5982<code>- --service-node-port-range=40000-40100</code>  \u7b49\u5f85 kube-apiserver \u91cd\u542f\u5b8c\u6210,\u7a0d\u5fae\u7b49\u7b49, <code>systemctl status kubelet</code></p>","tags":["k8s"]},{"location":"devops/k8s/core/service/service/#k8s","title":"\u4ee3\u7406 k8s \u5916\u90e8\u5e94\u7528","text":"<p>Tip</p> <ol> <li>\u6bd4\u5982\u6211\u4eec\u4e00\u4e2agolang web\u670d\u52a1, \u9700\u8981\u8fde\u63a5\u5916\u90e8\u7684mysql\u6216redis ,\u8fd9\u5c31\u9700\u8981\u7ef4\u62a4\u5b83\u4eec\u7684ip\u5730\u5740</li> <li>\u6211\u4eec\u5e0c\u671b\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\u67d0\u4e2a\u56fa\u5b9a\u7684\u540d\u79f0\u800c\u975eIP\u5730\u5740\u6765\u8bbf\u95ee\u8fd9\u4e9b\u5916\u90e8\u7684\u4e2d\u95f4\u4ef6\u670d\u52a1</li> <li>\u67d0\u4e2a\u9879\u76ee\u6b63\u5728\u8fc1\u79fb\u81f3k8s\u96c6\u7fa4\uff0c\u4f46\u662f\u4e00\u90e8\u5206\u670d\u52a1\u4ecd\u7136\u5728\u96c6\u7fa4\u5916\u90e8\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528service\u4ee3\u7406\u81f3 k8s \u96c6\u7fa4\u5916\u90e8\u7684\u670d\u52a1<ul> <li>\u5047\u5b9a\u4e00\u4e2a\u573a\u666f. \u6211\u4eec\u8981\u4ece\u539f\u5148\u4f20\u7edf\u7684\u670d\u52a1\u8fc1\u79fb\u5230k8s, a\u670d\u52a1\u548cb\u670d\u52a1, \u91cc\u9762a\u8bbf\u95eeb \u662f\u76f4\u63a5\u7528\u7684ip\u5730\u5740\u6bd4\u5982192.168.1.100:8080 (\u6bd4\u5982\u5728a\u7684\u914d\u7f6e\u6587\u4ef6\u91cc\u6709\u8fd9\u4e2aip\u5730\u5740 )</li> <li>\u6211\u4eec\u5148\u8fc1\u79fb\u4e86a, b\u670d\u52a1\u6682\u65f6\u8fd8\u5728\u5916\u90e8,\u672a\u6765\u67d0\u4e00\u4e2a\u65f6\u95f4\u53ef\u80fd\u624d\u4f1a\u8fc1\u79fb\u5230k8s, \u6211\u4eec\u5927\u6982\u5c31\u4f1a\u4fee\u6539a\u7684\u914d\u7f6e\u91cc\u7684b ip\u5730\u5740, \u8fc7\u6bb5\u65f6\u95f4 b\u8fc1\u79fb\u5230 k8s,\u6211\u4eec\u53c8\u8981\u4fee\u6539 \u8fd9\u4e2aip\u5730\u5740, \u7136\u540e\u91cd\u542f a\u670d\u52a1,,, \u6211\u4eec\u4e0d\u60f3\u8981\u8fd9\u4e48\u9ebb\u70e6,</li> </ul> </li> </ol> svc-nginx-external.yaml<pre><code>apiVersion: v1\nkind: Service\nmetadata:\nlabels:\napp: svc-nginx-external\nname: svc-nginx-external\nspec:\nports:\n- name: abc # \u6ce8\u610f\u5982\u679c\u7528\u4e86name,\u90a3\u4e48\u4f60ep\u91cc\u7684ports name\u5fc5\u987b\u548c\u8fd9\u4e2a\u4e00\u6837\nport: 80\nprotocol: TCP\ntargetPort: 80 # \u540e\u7aefpod\u63d0\u4f9b\u670d\u52a1\u7684\u7aef\u53e3, \u540e\u9762ep\u914d\u7f6e\u91cc\u7684ip\u5730\u5740\u63d0\u4f9b\u7684\u670d\u52a1\u7684\u7aef\u53e3\ntype: ClusterIP\n</code></pre> <pre><code>kubectl apply -f svc-nginx-external.yaml\n# \u67e5\u770b\u662f\u5426\u6709\u5173\u8054\u7684ep , \u8fd9\u91cc\u6211\u4eec\u8fd8\u6ca1\u5173\u8054ep\nk describe svc svc-nginx-external |grep -i endpoint\n# kubectl get ep \u662f\u6ca1\u6709\u81ea\u52a8\u521b\u5efa\u7684. \u56e0\u4e3a\u6211\u4eec\u521b\u5efa\u7684svc\u6ca1\u6709\u6ca1\u6709selector, \u5c31\u6ca1\u5173\u8054pod\n# \u4e4b\u6240\u4ee5\u6211\u4eec\u4ee5\u524d\u80fd\u901a\u8fc7svc  \u8bbf\u95ee\u5230 pod \u7684ip ,\u662f\u6839\u636e ep\u7684\u8bbe\u7f6e\n# \u90a3\u4e48\u73b0\u5728\u6211\u4eec\u624b\u52a8\u521b\u5efa\u4e00\u4e2aep,\u8ba9ep\u6307\u5411\u5916\u90e8\u7684ip ,\u4e0d\u5c31\u884c\u4e86.\n</code></pre> ep-single.yaml<pre><code>apiVersion: v1\nkind: Endpoints\nmetadata:\nname: svc-nginx-external\nnamespace: default\nsubsets:\n- addresses:\n- ip: 10.244.1.79 # \u5199\u4e0a\u4f60\u5916\u90e8\u670d\u52a1\u7684ip, \u6211\u8fd9\u91cc\u76f4\u63a5\u7528pod\u7684ip\u6765\u6d4b\u8bd5\n- ip: 10.244.2.81\nports:\n- port: 80 # \u5916\u90e8\u670d\u52a1\u7684\u7aef\u53e3\nname: abc\n</code></pre> <pre><code>k apply -f ep-single.yaml\n# \u6709\u4e86 \u5173\u8054\u7684ep\u4e86\nk get svc svc-nginx-external |grep -i endpoint\n</code></pre> <p>\u4e4b\u524d\u5f04\u5b8c\u540e\u4e00\u76f4\u8fde\u63a5\u4e0d\u4e86</p> <p>\u539f\u56e0\u662f svc ports \u91cc\u8bbe\u7f6e\u4e86name, ep\u91cc\u6ca1\u6709\u8bbe\u7f6e, \u5fc5\u987b\u8bbe\u7f6e,\u4e14name\u540d\u5b57\u4e00\u6837\u624d\u53ef\u4ee5.</p>","tags":["k8s"]},{"location":"devops/k8s/core/service/service/#externalname","title":"ExternalName","text":"","tags":["k8s"]},{"location":"devops/k8s/core/service/service/#_2","title":"\u5916\u90e8\u57df\u540d","text":"<p>Tip</p> <p>\u901a\u8fc7svc\u8bbf\u95ee\u5916\u90e8\u7684\u57df\u540d(\u5c31\u662f\u7ed9\u5916\u90e8\u670d\u52a1\u57df\u540d\u8d77\u4e00\u4e2a\u522b\u540d)   ports \u5b57\u6bb5\u8bbe\u7f6e\u662f\u65e0\u6548\u7684,\u56e0\u4e3a\u8fd9\u91cc\u5c31\u662f\u57df\u540d\u7684\u6620\u5c04</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: svc-external-name-baidu\nspec:\ntype: ExternalName\nexternalName: www.baidu.com\n</code></pre> <pre><code>k get svc\n    NAME                 TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE\n    svc-external-name-baidu   ExternalName   &lt;none&gt;          www.baidu.com   &lt;none&gt;       6s\n\n# \u8fdb\u5165\u4e00\u4e2a\u5bb9\u5668.\nkubectl exec -it dep-nginx-cc78676bc-ncrxb -- ping svc-external-name-baidu\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/service/service/#svc","title":"\u5185\u90e8svc \u8d77\u4e2a\u522b\u540d","text":"<pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: svc-external-name-another-svc\nnamespace: test\nspec:\ntype: ExternalName\n# \u8fd9\u91cc\u5199\u6211\u4eec\u5df2\u7ecf\u521b\u5efa\u7684svc\u7684name, \u4f5c\u4e3a\u5df2\u7ecf\u5b83\u7684\u4e00\u4e2asvc\u522b\u540d\n#externalName: svc-deploy-nginx.default.svc.cluster.local \u8fd9\u91cc\u8fd9\u6837 \u5c31\u76f8\u5f53\u4e8e\u7ed9\u4e0d\u540cns\u7684svc \u8d77\u4e2a\u522b\u540d\u4e00\u6837.\n# \u8981\u5168, svc.cluster.local \u4e0d\u80fd\u7701\u7565, \u672c\u8eab\u5168\u7684 ,\u4f60\u5728\u54ea\u4e2ans\u4e0b\u7684pod \u90fd\u80fd\u8bbf\u95ee ,\u6bcf\u4e2apod\u91cc\u7684 /etc/resolv.conf\nexternalName: svc-deploy-nginx.default.svc.cluster.local\n</code></pre> <pre><code># \u9996\u5148 pod \u91cc\u80fd\u901a\u8fc7 svc-deploy-nginx \u8bbf\u95ee\nk exec -it deploy-nginx2-667f55f99f-frtxh -- wget svc-deploy-nginx:8800\n# test \u547d\u540d\u7a7a\u95f4\u4e0b\u7684pod\u91cc\u8bbf\u95eedefault\u547d\u540d\u7a7a\u95f4\u4e0b\u7684 svc name, \u4f60\u9700\u8981 \u6307\u5b9a \u547d\u540d\u7a7a\u95f4, .default\nk exec -n test -it deploy-nginx-test-65cb6bf5f6-8mrxw -- wget svc-deploy-nginx.default:8800\n# \u76f4\u63a5\u8bbf\u95ee, \u5176\u5b83namespace\u7684svc \u7684\u522b\u540d, \u5c31\u4e0d\u9700\u8981\u5e26\u4e0a namespace\nk exec -n test deploy-nginx-test-65cb6bf5f6-8mrxw  -- wget svc-external-name-another-svc:8800\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/service/service/#headless-svc","title":"headless svc","text":"<p>svc-headless-nginx.yaml<pre><code>apiVersion: v1\nkind: Service\nmetadata:\nname: svc-headless-nginx\nlabels:\napp: svc-headless-nginx\nspec:\nports:\n- port: 80\nname: web\n#\u5b83\u7684 clusterIP \u5b57\u6bb5\u7684\u503c\u662f:None\uff0c\u5373:\u8fd9\u4e2a Service\uff0c\u6ca1\u6709\u4e00\u4e2a VIP \u4f5c\u4e3a\u201c\u5934\u201d\u3002 \n#\u8fd9\u4e5f\u5c31\u662f Headless \u7684\u542b\u4e49\u3002\u6240\u4ee5\uff0c\u8fd9\u4e2a Service \u88ab\u521b\u5efa\u540e\u5e76\u4e0d\u4f1a\u88ab\u5206\u914d\u4e00\u4e2a VIP\uff0c\n#\u800c\u662f\u4f1a \u4ee5 DNS \u8bb0\u5f55\u7684\u65b9\u5f0f\u66b4\u9732\u51fa\u5b83\u6240\u4ee3\u7406\u7684 Pod\u3002\nclusterIP: None\nselector:\napp: pod-deploy-nginx2\n</code></pre> <pre><code>k get svc\n    NAME                      TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)    AGE\n    svc-headless-nginx        ClusterIP      None             &lt;none&gt;          80/TCP     1s\n\nk get ep\n    NAME                  ENDPOINTS                       AGE\n    svc-headless-nginx    10.244.1.82:80,10.244.2.81:80   11s\n\n# \u6bcf\u6b21\u90fd\u4f1a\u76f4\u63a5 ping \u4e3a \u540e\u7aef\u67d0\u4e00\u4e2apod\u7684ip ,\u5c31\u662fep\u4e0a\u8bbe\u7f6e\u7684\u67d0\u4e00\u4e2aip\nk exec deploy-nginx2-667f55f99f-frtxh -- ping svc-headless-nginx\n</code></pre></p>","tags":["k8s"]},{"location":"devops/k8s/core/service/service/#_3","title":"\u51e0\u4e2a\u6ce8\u610f\u7684\u95ee\u9898","text":"","tags":["k8s"]},{"location":"devops/k8s/core/service/service/#pod","title":"pod \u5065\u5eb7\u68c0\u67e5\u5931\u8d25","text":"<p>Tip</p> <p>\u524d\u9762\u6211\u4eec\u8bf4\u8fc7, pod \u5c31\u7eea\u63a2\u9488\u5931\u8d25, \u4f1a\u5c06pod \u5207\u65ad\u6d41\u91cf</p> svc-pod-readiness.yaml<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nlabels:\ntest: pod-readiness-liveness\nname: pod-readiness-liveness\nspec:\ncontainers:\n- name: c-readiness-liveness\nimage: busybox\nimagePullPolicy: IfNotPresent\nargs:\n- /bin/sh\n- -c\n- touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 600\nreadinessProbe:\nexec:\ncommand:\n- sh\n- -c\n- cat /tmp/healthy\ninitialDelaySeconds: 5\nperiodSeconds: 5\ntimeoutSeconds: 1\nsuccessThreshold: 1\nfailureThreshold: 3\n---\nkind: Service\napiVersion: v1\nmetadata:\nname: svc-pod-readiness\nspec:\nselector:\ntest: pod-readiness-liveness\ntype: ClusterIP\nports:\n- protocol: TCP\nport: 80\ntargetPort: 80\n</code></pre> <pre><code>#k apply  -f  svc-pod-readiness.yaml -l test=pod-readiness-liveness\n#k delete -f svc-pod-readiness.yaml  -l test=pod-readiness-liveness\nk apply -f svc-pod-readiness.yaml\nk get ep # \u4e00\u5f00\u59cb\u662f\u6709\u7684, \u8fc7\u4e86\u4e00\u6bb5\u65f6\u95f4, pod \u53d8\u6210 \u4e0d ready\u4e86, ep\u91cc\u5c31\u5220\u9664\u4e86\u8be5pod ip\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/core/service/service/#svcselector-pod","title":"svc\u6307\u5b9a\u7684selector \u6ca1\u6709pod","text":"<pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: svc-selector-no-pod\nspec:\nselector:\napp: pod-deploy-nginx3\ntype: ClusterIP\nports:\n- protocol: TCP\nport: 8800\ntargetPort: 80\n</code></pre> <p>Tip</p> <p>\u4f1a\u521b\u5efa\u540c\u540d\u7684ep, \u53ea\u662fep\u91cc\u7684ENDPOINTS \u6ca1\u6709ip,\u662f\u7a7a\u7684.</p> <pre><code>k get ep\n    NAME                  ENDPOINTS                       AGE\n    svc-selector-no-pod   &lt;none&gt;                          82s\n</code></pre> <ol> <li> <p>service \u21a9</p> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/core/service/traefik/","title":"traefik","text":"<p>Tip</p> <p>Traefik\uff08\u4e5f\u79f0\u4e3aTraefik Proxy\uff09\u662f\u4e00\u6b3e\u73b0\u4ee3\u7684\u53cd\u5411\u4ee3\u7406\u548c\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u4e13\u95e8\u7528\u4e8e\u5904\u7406HTTP\u548cTCP\u6d41\u91cf Traefik\u53ef\u4ee5\u4e0e istio \u4e00\u8d77\u4f7f\u7528\uff0c\u4f5c\u4e3aistio\u7684\u5165\u53e3\u7f51\u5173\uff0c\u7528\u4e8e\u5904\u7406\u5916\u90e8\u6d41\u91cf\u5e76\u5c06\u5176\u8f6c\u53d1\u5230Istio\u670d\u52a1\u7f51\u683c\u4e2d\u7684\u670d\u52a1</p>"},{"location":"devops/k8s/develop/","title":"\u4ecb\u7ecd","text":""},{"location":"devops/k8s/develop/#_1","title":"\u6e90\u7801\u6846\u67b6\u4ecb\u7ecd","text":"<pre><code>git clone https://github.com/kubernetes/kubernetes\ngit co -b v1.23.17 v1.23.17\n</code></pre> <p>Standard Go Project Layout</p> <pre><code>tree -L 1\n.\n\u251c\u2500\u2500 Makefile -&gt; build/root/Makefile\n\u251c\u2500\u2500 api\n\u251c\u2500\u2500 build # \u6784\u5efa\u76f8\u5173\u4ee3\u7801\n\u251c\u2500\u2500 cluster\n\u251c\u2500\u2500 cmd # \u53ef\u6267\u884c\u6587\u4ef6\u5165\u53e3\n\u251c\u2500\u2500 kube-apiserver # \u5176\u4ed6\u90fd\u7c7b\u4f3c\u8fd9\u6837\u7684\u76ee\u5f55\u7ed3\u679c\n\u251c\u2500\u2500 OWNERS\n     \u00a0\u00a0 \u251c\u2500\u2500 apiserver.go\n     \u00a0\u00a0 \u2514\u2500\u2500 app\n\u251c\u2500\u2500 docs\n\u251c\u2500\u2500 hack # \u6784\u5efa\u548c\u6d4b\u8bd5\u76f8\u5173\u4ee3\u7801\n\u251c\u2500\u2500 logo\n\u251c\u2500\u2500 pkg # \u6838\u5fc3\u5e93\u4ee3\u7801\n\u251c\u2500\u2500 plugin\n\u251c\u2500\u2500 staging # \u90e8\u5206\u6838\u5fc3\u5e93\u4ee3\u7801\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 third_party\n\u2514\u2500\u2500 vendor #\u9879\u76ee\u4f9d\u8d56\u7684\u5e93, \u4e00\u822c\u662f\u7b2c\u4e09\u65b9\u5e93\n</code></pre>"},{"location":"devops/k8s/develop/#_2","title":"\u7ec4\u4ef6\u6e90\u7801","text":"<p>cobra\u6559\u7a0b <pre><code>\u251c\u2500\u2500 cmd # \u53ef\u6267\u884c\u6587\u4ef6\u5165\u53e3\n\u251c\u2500\u2500 kube-apiserver # \u5176\u4ed6\u90fd\u7c7b\u4f3c\u8fd9\u6837\u7684\u76ee\u5f55\u7ed3\u679c\n\u251c\u2500\u2500 OWNERS\n     \u00a0\u00a0 \u251c\u2500\u2500 apiserver.go\n     \u00a0\u00a0 \u2514\u2500\u2500 app\n</code></pre></p>"},{"location":"devops/k8s/develop/#_3","title":"\u76f8\u5173\u5e93","text":"<ol> <li> <p>k8s\u6e90\u7801 \u21a9</p> </li> </ol>"},{"location":"devops/k8s/develop/code-generator/","title":"\u4ee3\u7801\u751f\u6210\u5668","text":"<p>Tip</p> <p>\u5173\u4e8ek8s\u751f\u6210\u5668, \u548cgo generate \u6709\u7c7b\u4f3c\u7684\u5730\u65b9, go-generate</p> <pre><code>git clone https://github.com/kubernetes/code-generator\ngit  co -b v0.23.17 v0.23.17\n# k8s \u6e90\u7801\u4e2d  \u4e5f\u6709\ncd  code-generator\n./generate-groups.sh\n</code></pre> <ol> <li> <p>code-generator \u21a9</p> </li> <li> <p>gengo \u21a9</p> </li> </ol>"},{"location":"devops/k8s/develop/data-structure/","title":"Data structure","text":"<p>Note</p> <p>K8s\u7cfb\u7edf\u867d\u7136\u6709\u76f8\u5f53\u590d\u6742\u548c\u4f17\u591a\u7684\u529f\u80fd,\u4f46\u5b83\u672c\u8d28\u4e0a\u662f\u4e00\u4e2a\u8d44\u6e90\u63a7\u5236\u7cfb\u7edf: \u6ce8\u518c\u3001\u7ba1\u7406\u3001\u8c03\u5ea6\u8d44\u6e90\u5e76\u7ef4\u62a4\u8d44\u6e90\u7684\u72b6\u6001 K8s\u5c06\u8d44\u6e90\u518d\u6b21\u5206\u7ec4\u548c\u7248\u672c\u5316,\u5f62\u6210Group(\u8d44\u6e90\u7ec4)\u3001Version(\u8d44\u6e90\u7248\u672c)\u3001Resource(\u8d44\u6e90)</p> <p></p>"},{"location":"devops/k8s/develop/client-go/","title":"\u4ecb\u7ecd","text":""},{"location":"devops/k8s/develop/client-go/#_1","title":"\u4ee3\u7801\u7ed3\u6784","text":"<pre><code>git clone https://github.com/kubernetes/client-go.git\n\ngit tag # \u67e5\u770btag\n# \u4ee5tag kubernetes-1.23.17 \u521b\u5efa\u4e00\u4e2a\u5206\u652f\ngit co -b kubernetes-1.23.17 kubernetes-1.23.17\n# \u6216\ngit co -b v0.23.17 v0.23.17\n</code></pre> <pre><code>\u279c tree -L 1\n.\n\u251c\u2500\u2500 rest\n\u251c\u2500\u2500 kubernetes\n\u251c\u2500\u2500 dynamic\n\u251c\u2500\u2500 discovery\n\u251c\u2500\u2500 informers\n\u251c\u2500\u2500 listers\n\u251c\u2500\u2500 applyconfigurations\n\u251c\u2500\u2500 metadata\n\u251c\u2500\u2500 pkg\n\u251c\u2500\u2500 plugin\n\u251c\u2500\u2500 restmapper\n\u251c\u2500\u2500 scale\n\u251c\u2500\u2500 testing\n\u251c\u2500\u2500 third_party\n\u251c\u2500\u2500 tools\n\u251c\u2500\u2500 transport\n\u2514\u2500\u2500 util\n</code></pre>"},{"location":"devops/k8s/develop/client-go/#restclient","title":"RESTClient","text":"<p>Tip</p> <p>RESTClient\u662f\u6700\u57fa\u7840\u7684\u5ba2\u6237\u7aef \u5176\u4ed6\u7684ClientSet\u3001DynamicClient\u53caDiscoveryClient\u90fd\u662f\u57fa\u4e8eRESTClient\u5b9e\u73b0\u7684 RESTClient \u5bf9HTTP Request\u8fdb\u884c\u4e86\u5c01\u88c5,\u5b9e\u73b0\u4e86RESTful\u98ce\u683c\u7684API</p> <pre><code>package main\nimport (\n\"context\"\n\"flag\"\n\"fmt\"\n\"path/filepath\"\ncorev1 \"k8s.io/api/core/v1\"\nmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n\"k8s.io/client-go/kubernetes/scheme\"\n\"k8s.io/client-go/rest\"\n\"k8s.io/client-go/tools/clientcmd\"\n\"k8s.io/client-go/util/homedir\"\n)\nfunc main() {\nvar kubeconfig *string\nif home := homedir.HomeDir(); home != \"\" {\n// ~/.kube/config \u786e\u4fdd\u4f60\u5bb6\u76ee\u5f55\u4e0b\u6709k8s\u7684\u914d\u7f6e\u6587\u4ef6\n// \u4f60\u672c\u5730\u53ef\u4ee5\u7528kubectl get po \u8fdb\u884c\u67e5\u8be2.\nkubeconfig = flag.String(\"kubeconfig\", filepath.Join(home, \".kube\", \"config\"), \"(optional) absolute path to the kubeconfig file\")\n} else {\nkubeconfig = flag.String(\"kubeconfig\", \"\", \"absolute path to the kubeconfig file\")\n}\nflag.Parse()\n// \u4f7f\u7528\u6307\u5b9a\u7684kubeconfig\u6587\u4ef6\u521b\u5efa\u4e00\u4e2aConfig\u5bf9\u8c61\nconfig, err := clientcmd.BuildConfigFromFlags(\"\", *kubeconfig)\nif err != nil {\npanic(err.Error())\n}\n// \u7531\u4e8e\u540e\u9762\u6211\u4eec\u8bf7\u6c42\u7684\u662fpod ,\u662f\u6838\u5fc3\u8d44\u6e90, /api \u8fd9\u6837\nconfig.APIPath = \"api\"\n// \u524d\u9762\u6211\u4eec\u8bf4\u8fc7, \u6838\u5fc3\u8d44\u6e90 \u7684group \u662f\u7a7a, \u70b9\u8fdb\u53bb\u4f1a\u770b\u5230\u662fgroup\u662f\u7a7a\u7684.\nconfig.GroupVersion = &amp;corev1.SchemeGroupVersion\nconfig.NegotiatedSerializer = scheme.Codecs\nrestClient, err := rest.RESTClientFor(config)\nif err != nil {\npanic(err.Error())\n}\n// k get po -n default\n// \u6700\u7ec8 \u53d8\u6210 http\u8bf7\u6c42 localhost:8001/api/v1/namespaces/default/pods?limit=5\npodList := &amp;corev1.PodList{}\nerr = restClient.Get().\nNamespace(\"default\").\nResource(\"pods\").\nVersionedParams(\n&amp;metav1.ListOptions{Limit: 5},\nscheme.ParameterCodec).\nDo(context.TODO()).\nInto(podList)\nif err != nil {\npanic(err)\n}\nfor _, item := range podList.Items {\nfmt.Println(item.Name)\n}\n}\n</code></pre>"},{"location":"devops/k8s/develop/client-go/client-go/","title":"client-go","text":"","tags":["k8s"]},{"location":"devops/k8s/develop/client-go/client-go/#_1","title":"\u51c6\u5907","text":"<pre><code># go \u4ee3\u7801\u4e2d\ngo mod init go-k8s-namespace\n# \u6dfb\u52a0\u6307\u5b9a\u7248\u672c\ngo get k8s.io/client-go@v0.23.17\ngo get k8s.io/api@v0.23.17\ngo get k8s.io/apimachinery@v0.23.17\n\n# \u627e\u5230client-go\u7684\u4f8b\u5b50, \u8fd9\u91cc\u6211\u4eec\u7528out-of-cluster,\u56e0\u4e3a\u6211\u662f\u5728\u81ea\u5df1\u7684\u4e3b\u673a\u4e0a\u8fde\u63a5\u865a\u62df\u673a\u91cc\u7684k8s\u96c6\u7fa4\nclient-go/examples/out-of-cluster-client-configuration\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/client-go/client-go/#_2","title":"\u6837\u4f8b","text":"<pre><code>package main\nimport (\n\"context\"\n\"flag\"\n\"fmt\"\n\"path/filepath\"\n// corev1 \"k8s.io/api/core/v1\"\n// corev1 \"k8s.io/api/core/v1\"\n\"k8s.io/apimachinery/pkg/api/errors\"\nmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n\"k8s.io/client-go/kubernetes\"\n\"k8s.io/client-go/tools/clientcmd\"\n\"k8s.io/client-go/util/homedir\"\n// storagev1 \"k8s.io/api/storage/v1\"\n// storagev1 \"k8s.io/api/storage/v1\"\n// storagev1 \"k8s.io/api/storage/v1\"\n//\n// Uncomment to load all auth plugins\n// _ \"k8s.io/client-go/plugin/pkg/client/auth\"\n//\n// Or uncomment to load specific auth plugins\n// _ \"k8s.io/client-go/plugin/pkg/client/auth/azure\"\n// _ \"k8s.io/client-go/plugin/pkg/client/auth/gcp\"\n// _ \"k8s.io/client-go/plugin/pkg/client/auth/oidc\"\n// _ \"k8s.io/client-go/plugin/pkg/client/auth/openstack\"\n)\nfunc main() {\nvar kubeconfig *string\nif home := homedir.HomeDir(); home != \"\" {\n// ~/.kube/config \u786e\u4fdd\u4f60\u5bb6\u76ee\u5f55\u4e0b\u6709k8s\u7684\u914d\u7f6e\u6587\u4ef6\n// \u4f60\u672c\u5730\u53ef\u4ee5\u7528kubectl get po \u8fdb\u884c\u67e5\u8be2.\nkubeconfig = flag.String(\"kubeconfig\", filepath.Join(home, \".kube\", \"config\"), \"(optional) absolute path to the kubeconfig file\")\n} else {\nkubeconfig = flag.String(\"kubeconfig\", \"\", \"absolute path to the kubeconfig file\")\n}\nflag.Parse()\n// \u4f7f\u7528\u6307\u5b9a\u7684kubeconfig\u6587\u4ef6\u521b\u5efa\u4e00\u4e2aConfig\u5bf9\u8c61\nconfig, err := clientcmd.BuildConfigFromFlags(\"\", *kubeconfig)\nif err != nil {\npanic(err.Error())\n}\n// \u521b\u5efa\u4e00\u4e2a\u65b0\u7684Kubernetes\u5ba2\u6237\u7aef\nclientset, err := kubernetes.NewForConfig(config)\nif err != nil {\npanic(err.Error())\n}\n// k get po -A\npods, err := clientset.\nCoreV1().\nPods(\"\"). // Pods(namespace) \"\" \u8868\u793a\u6240\u6709\u547d\u540d\u7a7a\u95f4\nList(context.TODO(), metav1.ListOptions{})\nif err != nil {\npanic(err.Error())\n}\nfmt.Printf(\"There are %d pods in the cluster\\n\", len(pods.Items))\n// \u9519\u8bef\u5904\u7406\nnamespace := \"default\"\npodName := \"pod-vol-empty-dir\"\npod, err := clientset.\nCoreV1().\nPods(namespace). // \u4f20\u9012\u547d\u540d\u7a7a\u95f4\nGet(context.TODO(), podName, metav1.GetOptions{})\nif errors.IsNotFound(err) { // \u4f7f\u7528k8s apimachinery\u7684errors\u5305 ,\u8fd9\u91cc\u8868\u793a \u6ca1\u6709\u627e\u5230 \u8fd9\u4e2apod\nfmt.Printf(\"Pod %s in namespace %s not found\\n\", podName, namespace)\n} else if statusError, isStatus := err.(*errors.StatusError); isStatus {\nfmt.Printf(\"Error getting pod %s in namespace %s: %v\\n\",\npodName, namespace, statusError.ErrStatus.Message)\n} else if err != nil {\npanic(err.Error())\n} else {\nfmt.Printf(\"Found pod %s in namespace %s\\n\", podName, namespace)\nfmt.Println(pod.TypeMeta)\nfmt.Println(pod.ObjectMeta.Name)\nfmt.Println(pod.Spec.NodeName)\nfmt.Println(pod.Status.PodIP)\n}\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/client-go/client-go/#pod","title":"pod","text":"listdetailcreateupdatepatchdeletewatch <pre><code>pods, err := clientset.\nCoreV1().\nPods(\"\"). // Pods(namespace) \"\" \u8868\u793a\u6240\u6709\u547d\u540d\u7a7a\u95f4\nList(context.TODO(), metav1.ListOptions{})\nfmt.Printf(\"There are %d pods in the cluster\\n\", len(pods.Items))\n</code></pre> <p>\u4f7f\u7528ResourceVersion<pre><code>pods, err := clientset.\nCoreV1().\nPods(\"default\").\nList(context.TODO(),\nmetav1.ListOptions{\nResourceVersion: \"2802779\",\n// \u6ce8\u610f\u4f7f\u7528limit \u548c\u53bb\u6389\u7684\u6548\u679c\nLimit:           50,\n})\nif err != nil {\npanic(err.Error())\n}\nfor _, item := range pods.Items {\nfmt.Println(item.Labels)\n}\n</code></pre> \u914d\u5408\u6587\u6863 resourceVersion</p> <pre><code>namespace := \"default\"\npodName := \"pod-vol-empty-dir\"\npod, err := clientset.\nCoreV1().\nPods(namespace). // \u4f20\u9012\u547d\u540d\u7a7a\u95f4\nGet(context.TODO(), podName, metav1.GetOptions{})\nfmt.Println(pod.TypeMeta)\nfmt.Println(pod.ObjectMeta.Name)\nfmt.Println(pod.Spec.NodeName)\nfmt.Println(pod.Status.PodIP)\n</code></pre> <p>Tip</p> <p>\u53ef\u662f\u5728\u521b\u5efa\u7684\u4f7f\u7528\u5148\u7528DryRun ,\u770b\u662f\u5426\u6709\u9519\u8bef. \u5b9e\u9645\u5de5\u4f5c\u4e2d, \u5148\u5224\u65ad\u662f\u5426\u6709\u8fd9\u4e2apod\u7b49\u7b49.</p> <pre><code>import (\ncorev1 \"k8s.io/api/core/v1\"\n)\n//.....\n// \u521b\u5efa\u4e00\u4e2aPod\u5bf9\u8c61\npod1 := &amp;corev1.Pod{\nObjectMeta: metav1.ObjectMeta{\nName:      \"my-pod\",\nNamespace: \"default\",\n},\nSpec: corev1.PodSpec{\nContainers: []corev1.Container{\n{\nName:  \"my-container\",\nImage: \"nginx:1.14.2\",\n// Lifecycle: &amp;corev1.Lifecycle{\n//     PreStop: &amp;corev1.LifecycleHandler{\n//         Exec: &amp;corev1.ExecAction{\n//             Command: []string{\n//                 \"/bin/sh\",\n//                 \"-c\",\n//                 \"sleep 20\",\n//             },\n//         },\n//     },\n// },\n},\n},\n},\n}\n// \u4f7f\u7528\u5ba2\u6237\u7aef\u521b\u5efaPod\ncreatedPod, err := clientset.\nCoreV1().\nPods(\"default\").\nCreate(context.TODO(),\npod1,\nmetav1.CreateOptions{\nDryRun: []string{metav1.DryRunAll}, // \u76f8\u5f53\u4e8e\u547d\u4ee4\u884c\u6267\u884c \u5e26\u4e0a--dry-run=client\n})\nif err != nil {\nlog.Fatal(err)\n}\nfmt.Printf(\"Created Pod: %s\\n\", createdPod.Name)\n</code></pre> <p>Warning</p> <p>update\u64cd\u4f5c\u53ea\u80fd\u66f4\u65b0\u4e00\u4e9b\u5c5e\u6027, \u4f60\u63d0\u4ea4\u4e86\u5f88\u591a\u5c5e\u6027\u8981\u4fee\u6539, \u4f1a\u62a5\u9519. \u53ef\u4ee5\u5148\u5220\u9664,\u518d\u521b\u5efa</p> <pre><code>pod1 := &amp;corev1.Pod{\nObjectMeta: metav1.ObjectMeta{\nName:      \"my-pod\",\nNamespace: \"default\",\n},\nSpec: corev1.PodSpec{\nContainers: []corev1.Container{\n{\nName:  \"my-container\",\nImage: \"nginx:1.14.2\",\nLifecycle: &amp;corev1.Lifecycle{\nPreStop: &amp;corev1.LifecycleHandler{\nExec: &amp;corev1.ExecAction{\nCommand: []string{\n\"/bin/sh\",\n\"-c\",\n\"sleep 20\",\n},\n},\n},\n},\n},\n},\n},\n}\n_, err = clientset.CoreV1().Pods(\"default\").Update(\ncontext.TODO(),\npod1,\nmetav1.UpdateOptions{})\nif err != nil {\n//pod updates may not change fields other than `spec.containers[*].image`, `spec.initContainers[*].image`, `spec.activeDeadlineSeconds`, `spec.tolerations` (only additions to existing tolerations) or `spec.terminationGracePeriodSeconds` (allow it to be set to 1 if it was previously negative)\nlog.Fatal(err) }\n</code></pre> <p>\u51e0\u79cd\u7c7b\u578b\u7684\u533a\u522b</p> <p>todo</p> StrategicMergePatchType <pre><code>patchBytes := []byte(`{\"metadata\":{\"labels\":{\"app\":\"nginx2\",\"run\":\"test\"}}}`)\n// patch := make(map[string]interface{})\n// patch[\"metadata\"] = map[string]interface{}{\n//  \"labels\": map[string]interface{}{\n//      \"app\": \"nginx\",\n//      \"run\": \"test\",\n//  },\n// }\n// patchBytes, err := json.Marshal(patch)\n_, err = clientset.CoreV1().Pods(\"default\").Patch(\ncontext.TODO(),\n\"my-pod\",\n// \u5c5e\u6027\u76f8\u540c \u5c31\u66f4\u65b0, \u6ca1\u6709\u7684\u5f53\u7136\u662f\u589e\u52a0\ntypes.StrategicMergePatchType,\npatchBytes,\nmetav1.PatchOptions{})\n</code></pre> <pre><code>err = clientset.\nCoreV1().\nPods(\"default\").\nDelete(context.TODO(), \"my-pod\", metav1.DeleteOptions{})\n</code></pre> <p><pre><code>curl localhost:8001/api/v1/namespaces/default/pods?watch\n</code></pre> \u770b\u770betcd\u7684\u7248\u672c\u76d1\u542c</p> <pre><code>package main\nimport (\n\"context\"\n\"flag\"\n\"fmt\"\n\"log\"\n\"path/filepath\"\n\"time\"\ncorev1 \"k8s.io/api/core/v1\"\n\"k8s.io/apimachinery/pkg/api/errors\"\nmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n\"k8s.io/apimachinery/pkg/watch\"\n\"k8s.io/client-go/kubernetes\"\n\"k8s.io/client-go/tools/clientcmd\"\n\"k8s.io/client-go/util/homedir\"\n//\n// Uncomment to load all auth plugins\n// _ \"k8s.io/client-go/plugin/pkg/client/auth\"\n//\n// Or uncomment to load specific auth plugins\n// _ \"k8s.io/client-go/plugin/pkg/client/auth/azure\"\n// _ \"k8s.io/client-go/plugin/pkg/client/auth/gcp\"\n// _ \"k8s.io/client-go/plugin/pkg/client/auth/oidc\"\n// _ \"k8s.io/client-go/plugin/pkg/client/auth/openstack\"\n)\nfunc main() {\nvar kubeconfig *string\nif home := homedir.HomeDir(); home != \"\" {\nkubeconfig = flag.String(\"kubeconfig\", filepath.Join(home, \".kube\", \"config\"), \"(optional) absolute path to the kubeconfig file\")\n} else {\nkubeconfig = flag.String(\"kubeconfig\", \"\", \"absolute path to the kubeconfig file\")\n}\nflag.Parse()\n// \u4f7f\u7528\u6307\u5b9a\u7684kubeconfig\u6587\u4ef6\u521b\u5efa\u4e00\u4e2aConfig\u5bf9\u8c61\nconfig, err := clientcmd.BuildConfigFromFlags(\"\", *kubeconfig)\nif err != nil {\npanic(err.Error())\n}\n// \u521b\u5efa\u4e00\u4e2a\u65b0\u7684Kubernetes\u5ba2\u6237\u7aef\nclientset, err := kubernetes.NewForConfig(config)\nif err != nil {\npanic(err.Error())\n}\n// \u521b\u5efa\u4e00\u4e2aPod\u5bf9\u8c61\npod1 := &amp;corev1.Pod{\nObjectMeta: metav1.ObjectMeta{\nName:      \"my-pod\",\nNamespace: \"default\",\nLabels: map[string]string{\n\"app\": \"pod-vol\",\n\"run\": \"test\",\n},\n},\nSpec: corev1.PodSpec{\nContainers: []corev1.Container{\n{\nName:  \"my-container\",\nImage: \"nginx:1.14.2\",\nLifecycle: &amp;corev1.Lifecycle{\nPreStop: &amp;corev1.LifecycleHandler{\nExec: &amp;corev1.ExecAction{\nCommand: []string{\n\"/bin/sh\",\n\"-c\",\n\"sleep 20\",\n},\n},\n},\n},\n},\n},\n},\n}\n// \u4f7f\u7528\u5ba2\u6237\u7aef\u521b\u5efaPod\ncreatedPod, err := clientset.\nCoreV1().\nPods(\"default\").\nCreate(context.TODO(),\npod1,\nmetav1.CreateOptions{\n// DryRun: []string{metav1.DryRunAll}, // \u76f8\u5f53\u4e8e\u547d\u4ee4\u884c\u6267\u884c \u5e26\u4e0a--dry-run=client\n})\nif err != nil {\nlog.Fatal(err)\n}\nfmt.Printf(\"ok: %s\\n\", createdPod.Name)\n// \u7b49\u5f85\u4e00\u4f1a,\u4e0d\u6025\u7740\u505a\u5220\u9664\u64cd\u4f5c, \u547d\u4ee4\u884c k get po \u770b\u770b\ntime.Sleep(10 * time.Second)\nerr = clientset.\nCoreV1().\nPods(\"default\").Delete(context.TODO(), \"my-pod\", metav1.DeleteOptions{\n// DryRun: []string{metav1.DryRunAll},\n})\nif err != nil {\nlog.Fatal(err)\n}\n// \u8be5Watcher\u5c06\u76d1\u542c\u6307\u5b9a\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6240\u6709Pod\u5bf9\u8c61\u7684\u4e8b\u4ef6\u3002\n// \u5982\u679c\u521b\u5efaWatcher\u6210\u529f\uff0c\u5b83\u5c06\u8fd4\u56de\u4e00\u4e2awatch.Interface\u5bf9\u8c61\u548c\u4e00\u4e2a\u9519\u8bef\u3002\nwatcher, err := clientset.CoreV1().Pods(\"default\").Watch(context.TODO(), metav1.ListOptions{\nLabelSelector: \"app=pod-vol,run=test\",\n})\nif err != nil {\nlog.Fatal(err)\n}\nstarted := time.Now()\nLoop:\nfor {\nselect {\n//watcher.ResultChan() \u901a\u9053\u5c06\u4f20\u9012Watcher\u63a5\u6536\u5230\u7684\u4e8b\u4ef6\ncase event := &lt;-watcher.ResultChan():\npod, ok := event.Object.(*corev1.Pod)\nif !ok {\nfmt.Println(\"xxxx::\", pod)\ncontinue\n}\n// \u6211\u4eec\u83b7\u53d6watcher \u7528\u7684\u662flabels \u9009\u62e9\u5668, \u53ef\u80fd\u6709\u4e0d\u540c\u7684pod\n// \u8fd9\u91cc\u53ef\u4ee5\u589e\u52a0\u5224\u65ad\u770b\u662f\u4e0d\u662f\u4f60\u60f3\u8981\u5904\u7406\u7684\u90a3\u4e2apod\nfmt.Println(pod.Name)\nif pod.Name != \"my-pod\" {\ncontinue\n}\nswitch event.Type {\ncase watch.Added:\nfmt.Printf(\"Pod added: %s\\n\", event.Object)\n// \u5904\u7406Pod\u6dfb\u52a0\u4e8b\u4ef6\ncase watch.Modified:\nfmt.Printf(\"Pod modified: %s\\n\", event.Object)\n// \u5904\u7406Pod\u4fee\u6539\u4e8b\u4ef6\ncase watch.Deleted:\nfmt.Printf(\"Pod deleted: %s\\n\", pod.Name)\n// \u5dee\u4e0d\u591a20s,\u56e0\u4e3a\u6211\u4eec\u5bb9\u5668preStop sleep 20s\nfmt.Println(\"duration:\", time.Since(started))\n// \u5904\u7406Pod\u5220\u9664\u4e8b\u4ef6\n// \u5982\u679c\u60f3\u5728\u8fd9\u91cc (\u903b\u8f91\u662f \u770b\u5220\u9664\u4e86, \u7136\u540e\u521b\u5efapod) ,\u90a3\u4e48\u4f60\u5e94\u8be5\u5728\u524d\u9762\u589e\u52a0\u4e00\u6b21\u5224\u65ad,\n// \u67e5\u8be2pod\u770b\u662f\u5426\u8fd9\u4e2apod \u5df2\u7ecf\u4e0d\u5b58\u5728\u4e86. \u56e0\u4e3a\u6709\u53ef\u80fd\u4f60\u6267\u884cwatch \u65f6 ,pod \u5df2\u7ecf\u5220\u9664\u4e86, \u90a3\u4e48\u4f60\u6c38\u8fdc\u90fd\u4e0d\u4f1a\u8d70\u5230\u8fd9\u4e86.\n}\ncase &lt;-time.After(60 * time.Second):\nfmt.Println(9999)\nbreak Loop\n}\n}\n// DryRun: []string{metav1.DryRunAll}, // \u76f8\u5f53\u4e8e\u547d\u4ee4\u884c\u6267\u884c \u5e26\u4e0a--dry-run=client\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/client-go/client-go/#namespace","title":"namespace","text":"<pre><code>list, err := clientset.\nCoreV1().\nNamespaces().\nList(context.TODO(), metav1.ListOptions{})\nfor _, item := range list.Items {\nfmt.Println(item.Name)\nfmt.Println(item.CreationTimestamp)\nfmt.Println(string(item.Status.Phase))\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/client-go/client-go/#scheduler","title":"scheduler","text":"node listnode detail\u8bbe\u7f6e\u6807\u7b7e\u5220\u9664\u6807\u7b7e\u8bbe\u7f6e\u6c61\u70b9 <pre><code>list, err := clientset.CoreV1().Nodes().List(context.TODO(), metav1.ListOptions{})\nif err != nil {\npanic(err.Error())\n}\nfor _, item := range list.Items {\nfmt.Println(item.ObjectMeta.Name)\nfmt.Println(item.ObjectMeta.Labels)\nfmt.Println(item.TypeMeta)\n// fmt.Println(item.Spec.Taints)\nfor _, v := range item.Spec.Taints {\nfmt.Println(v.Key, \"=\", v.Value, \":\", v.Effect)\n}\n// node \u72b6\u6001\nfor _, v := range item.Status.Conditions {\nfmt.Println(v.Type, v.Status, v.Reason)\n}\n}\n</code></pre> <pre><code>detail, err := clientset.CoreV1().Nodes().Get(context.TODO(), \"node1\", metav1.GetOptions{})\nif err != nil {\npanic(err.Error())\n}\nfmt.Println(detail.ObjectMeta.Name)\nfmt.Println(detail.ObjectMeta.Labels)\nfmt.Println(detail.TypeMeta)\nfor _, v := range detail.Spec.Taints {\nfmt.Println(v.Key, \"=\", v.Value, \":\", v.Effect)\n}\nfor _, v := range detail.Status.Conditions {\nfmt.Println(v.Type, v.Status, v.Reason)\n}\n</code></pre> <p>Tip</p> <p>\u53ef\u4ee5\u5148\u83b7\u53d6node\u7684label \u7136\u540e\u6709update\u7684\u65b9\u5f0f\u6765\u66f4\u65b0.</p> <pre><code>patchData := []byte(`{\"metadata\":{\"labels\":{\"app\":\"test\"}}}`)\n// \u6267\u884cPatch\u64cd\u4f5c, \u6709\u5219\u66f4\u65b0, \u65e0\u5219\u6dfb\u52a0\n_, err := clientset.\nCoreV1().\nNodes().\nPatch(context.TODO(), \"node1\", types.MergePatchType, patchData, metav1.PatchOptions{})\nif err != nil {\npanic(err.Error())\n}\n</code></pre> <pre><code>// null \u6ca1\u6709\u5f15\u53f7, \u5f53\u7136\u6211\u4eec\u5e94\u8be5\u7528map ,\u7136\u540e json.Marshal\u6765...\npatchData := []byte(`{\"metadata\":{\"labels\":{\"app1\":null}}}`)\n// \u6267\u884cPatch\u64cd\u4f5c\nupdatedNode, err := clientset.\nCoreV1().\nNodes().\nPatch(context.TODO(), \"node1\",\ntypes.StrategicMergePatchType,\npatchData, metav1.PatchOptions{})\nif err != nil {\npanic(err.Error())\n}\n</code></pre> <pre><code>// \u521b\u5efa\u8981\u8bbe\u7f6e\u7684\u6c61\u70b9\u6570\u636e,\ntaints := []corev1.Taint{\n{\nKey:    \"hello\",\nValue:  \"world\",\nEffect: corev1.TaintEffectNoSchedule,\n},\n}\n// \u5982\u679c\u60f3\u8981\u5728\u539f\u6765\u7684\u6c61\u70b9\u4e0a \u589e\u52a0, \u53ef\u4ee5\u5148\u83b7\u53d6\u8282\u70b9\u7684\u6c61\u70b9,\u7136\u540e...\n// k get no node1 -o yaml \u53ef\u4ee5\u770b\u5230\u8282\u70b9\u7684\u5c5e\u6027 spec.taints\npatchData, _ := json.Marshal(map[string]interface{}{\n\"spec\": map[string]interface{}{\n\"taints\": taints, //  \u8fd9\u6837\u5199\u4f1a\u8986\u76d6\u539f\u6765\u5df2\u6709\u7684\u6c61\u70b9\n},\n})\n// \u6267\u884cPatch\u64cd\u4f5c\n_, err = clientset.\nCoreV1().\nNodes().\nPatch(context.TODO(),\n\"node1\",\ntypes.MergePatchType,\npatchData,\nmetav1.PatchOptions{})\nif err != nil {\npanic(err.Error())\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/client-go/client-go/#pv","title":"pv","text":"listcreate <pre><code>pvList, err := clientset.\nCoreV1().\nPersistentVolumes().\nList(context.TODO(), metav1.ListOptions{})\nif err != nil {\npanic(err.Error())\n}\n// \u904d\u5386 PV \u5217\u8868\nfor _, pv := range pvList.Items {\nfmt.Println(pv.ObjectMeta.Name)\nfmt.Println(pv.Spec.StorageClassName)\nfmt.Println(pv.Status.Phase)\n}\n</code></pre> <pre><code>// \u521b\u5efa\u6301\u4e45\u5377\n// \u4ec5\u4f5c\u4e3apvc \u9009\u62e9pv \u7528\nstorageClassName := \"abc-no-defined-name\"\npv := &amp;corev1.PersistentVolume{\nObjectMeta: metav1.ObjectMeta{\nName: \"pv-client-go\",\n// Labels: map[string]string{\n//  \"run\": \"pv\",\n// },\n},\nSpec: corev1.PersistentVolumeSpec{\nCapacity: corev1.ResourceList{\ncorev1.ResourceStorage: resource.MustParse(\"300Mi\"),\n},\nAccessModes: []corev1.PersistentVolumeAccessMode{\ncorev1.ReadWriteOnce,\n},\nPersistentVolumeReclaimPolicy: corev1.PersistentVolumeReclaimRetain,\nStorageClassName:              storageClassName,\n// \u8fd9\u91cc\u6211\u7528NFS\nPersistentVolumeSource: corev1.PersistentVolumeSource{\nNFS: &amp;corev1.NFSVolumeSource{\nServer:   \"102.168.66.110\",\nPath:     \"/data/nfs\",\nReadOnly: false,\n},\n},\n},\n}\n_, err = clientset.\nCoreV1().\nPersistentVolumes(). //pv \u6ca1\u6709namespace\u6982\u5ff5\nCreate(context.TODO(), pv, metav1.CreateOptions{})\nif err != nil {\npanic(err.Error())\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/client-go/client-go/#pvc","title":"PVC","text":"listcreate <pre><code>// \u83b7\u53d6 PVC \u5217\u8868\npvcList, err := clientset.\nCoreV1().\nPersistentVolumeClaims(\"default\").\nList(context.TODO(), metav1.ListOptions{})\nif err != nil {\npanic(err.Error())\n}\n// \u904d\u5386 PVC \u5217\u8868\nfor _, pvc := range pvcList.Items {\nfmt.Println(pvc.ObjectMeta.Name)\nfmt.Println(pvc.Spec.VolumeName)\nfmt.Println(pvc.Status.Phase)\n}\n</code></pre> <pre><code>// \u521b\u5efapvc\nstorageClassName := \"abc-no-defined-name\"\npvc := &amp;corev1.PersistentVolumeClaim{\nObjectMeta: metav1.ObjectMeta{\nName: \"pvc-client-go\",\n},\nSpec: corev1.PersistentVolumeClaimSpec{\nAccessModes: []corev1.PersistentVolumeAccessMode{\ncorev1.ReadWriteOnce,\n},\nResources: corev1.ResourceRequirements{\nRequests: corev1.ResourceList{\ncorev1.ResourceStorage: resource.MustParse(\"220Mi\"),\n},\n},\nStorageClassName: &amp;storageClassName,\n// Selector: &amp;metav1.LabelSelector{\n//  MatchLabels: map[string]string{\n//      \"run\": \"pv\",\n//  },\n// },\n},\n}\n_, err = clientset.\nCoreV1().\nPersistentVolumeClaims(\"default\").\nCreate(context.TODO(), pvc, metav1.CreateOptions{})\nif err != nil {\npanic(err.Error())\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/client-go/client-go/#sc","title":"SC","text":"createlist\u8bbe\u7f6e\u4e3a\u9ed8\u8ba4delete <pre><code>import (\n\"k8s.io/utils/pointer\"\nstoragev1 \"k8s.io/api/storage/v1\"\n// ....\n)\nvolumeBindingImmediate := storagev1.VolumeBindingImmediate\nsc := &amp;storagev1.StorageClass{\nObjectMeta: metav1.ObjectMeta{\nName: \"sc-01-tmp\",\n},\nProvisioner:          \"example-nfs2\", // \u66ff\u6362\u4e3a\u4f60\u7684\u5b58\u50a8\u63d0\u4f9b\u5546\u7684 Provisioner\nVolumeBindingMode:    &amp;volumeBindingImmediate,\nAllowVolumeExpansion: pointer.BoolPtr(true),\n}\ncreatedSC, err := clientset.\nStorageV1().\nStorageClasses().\nCreate(context.TODO(), sc, metav1.CreateOptions{})\nif err != nil {\npanic(err.Error())\n}\nfmt.Printf(\"OK: %s\\n\", createdSC.Name)\n</code></pre> <pre><code>//  \u83b7\u53d6 StorageClass \u5217\u8868\nstorageClasses, _ := clientset.\nStorageV1().\nStorageClasses().\nList(context.TODO(), metav1.ListOptions{})\n// \u904d\u5386 StorageClass \u5217\u8868\nfor _, sc := range storageClasses.Items {\nfmt.Println(sc.Name)\nfmt.Println(sc.Provisioner)\nfmt.Println(sc.Parameters)\nfmt.Println(*sc.ReclaimPolicy)\nfmt.Println(\"is-default-class: \", sc.Annotations[\"storageclass.kubernetes.io/is-default-class\"] == \"true\")\n}\n</code></pre> <pre><code>serverVersion, err := clientset.Discovery().ServerVersion()\nif err != nil {\npanic(err)\n}\nmajorVersion, _ := strconv.Atoi(serverVersion.Major)\nminorVersion, _ := strconv.Atoi(serverVersion.Minor)\nif majorVersion &lt; 1 || (majorVersion == 1 &amp;&amp; minorVersion &lt; 14) {\nfmt.Println(\"\u8fd9\u4e2a\u7248\u672c\u4e0d\u652f\u6301\u8bbe\u7f6e\u9ed8\u8ba4StorageClass\")\nreturn\n}\nstorageClasses, _ := clientset.\nStorageV1().\nStorageClasses().\nList(context.TODO(), metav1.ListOptions{})\n// \u60f3\u8981\u8bbe\u7f6e\u6210\u9ed8\u8ba4\u7684 StorageClass\ntargetStorageClassName := \"sc-01-tmp\"\ndefaultStorageAnnotation := \"storageclass.kubernetes.io/is-default-class\"\nfor _, sc := range storageClasses.Items {\nfmt.Println(sc.Name)\nfmt.Println(sc.Annotations)\nif sc.Annotations[defaultStorageAnnotation] == \"true\" {\n// \u5220\u9664 default Storage Annotation key\ndelete(sc.Annotations, defaultStorageAnnotation)\n// \u66f4\u65b0 StorageClass\n_, err = clientset.\nStorageV1().\nStorageClasses().\nUpdate(context.TODO(), &amp;sc, metav1.UpdateOptions{})\nif err != nil {\npanic(err.Error())\n}\n}\nif sc.Name == targetStorageClassName &amp;&amp;\nsc.Annotations[defaultStorageAnnotation] != \"true\" {\nif sc.Annotations == nil {\nsc.Annotations = make(map[string]string)\n}\nsc.Annotations[defaultStorageAnnotation] = \"true\"\n// \u66f4\u65b0 StorageClass\n_, err = clientset.\nStorageV1().\nStorageClasses().\nUpdate(context.TODO(), &amp;sc, metav1.UpdateOptions{})\nif err != nil {\npanic(err.Error())\n}\n}\n}\n</code></pre> <pre><code>err = clientset.\nStorageV1().\nStorageClasses().\nDelete(context.TODO(), \"example-nfs\", metav1.DeleteOptions{})\nif err != nil {\npanic(err)\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/client-go/client-go/#configmap","title":"configmap","text":"listdetailcreatedeletecreatePodWithConfigmap <pre><code>list, err := clientset.\nCoreV1().\nConfigMaps(\"default\").\nList(context.TODO(), metav1.ListOptions{})\nif err != nil {\npanic(err.Error())\n}\nfor _, item := range list.Items {\nfmt.Println(\"name:\", item.ObjectMeta.Name)\nfmt.Println(\"type:\", item.TypeMeta)\nfmt.Println(\"immutable:\", *item.Immutable)\nfmt.Println(\"data:\", item.Data)\nfmt.Println(\"BinaryData:\", item.BinaryData)\n}\n</code></pre> <pre><code>item, err := clientset.CoreV1().ConfigMaps(\"default\").Get(context.TODO(), \"mysql-config2\", metav1.GetOptions{})\nif err != nil {\n// \u627e\u4e0d\u5230\u8be5configmap ,\u4f1a\u62a5\u9519\npanic(err.Error())\n}\nfmt.Println(\"name:\", item.ObjectMeta.Name)\nfmt.Println(\"type:\", item.TypeMeta)\nfmt.Println(\"immutable:\", *item.Immutable)\nfmt.Println(\"data:\", item.Data)\nfmt.Println(\"BinaryData:\", item.BinaryData)\n</code></pre> <pre><code>import (\n\"context\"\n\"flag\"\n\"fmt\"\n\"io/ioutil\"\n\"os\"\n\"path/filepath\"\ncorev1 \"k8s.io/api/core/v1\"\n\"k8s.io/apimachinery/pkg/api/errors\"\nmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n\"k8s.io/client-go/kubernetes\"\n\"k8s.io/client-go/tools/clientcmd\"\n\"k8s.io/client-go/util/homedir\"\n)\n//......\nnginxConfigData, err := ioutil.ReadFile(\"nginx.conf\")\nif err != nil {\nfmt.Printf(\"err: %v\\n\", err)\nreturn\n}\nconfigMap := &amp;corev1.ConfigMap{\nObjectMeta: metav1.ObjectMeta{\nName:      \"mysql-config22\",\nNamespace: \"default\",\n},\nData: map[string]string{\n\"user\":       \"root\",\n\"password\":   \"123\",\n\"nginx.conf\": string(nginxConfigData),\n},\n}\n// \u5728 Kubernetes \u4e2d\u521b\u5efa ConfigMap\ncreatedConfigMap, err := clientset.\nCoreV1().\nConfigMaps(\"default\").\nCreate(context.TODO(), configMap, metav1.CreateOptions{})\nif err != nil {\nfmt.Printf(\"%v\\n\", err)\nreturn\n}\nfmt.Printf(\"%s\\n\", createdConfigMap.Name)\n</code></pre> <pre><code>err = clientset.\nCoreV1().\nConfigMaps(\"default\").\nDelete(context.TODO(), \"mysql-config2\", metav1.DeleteOptions{})\nif err != nil {\npanic(err.Error())\n}\n</code></pre> <pre><code>pod1 := &amp;corev1.Pod{\nObjectMeta: metav1.ObjectMeta{\nName:      \"my-pod\",\nNamespace: \"default\",\nLabels: map[string]string{\n\"app\": \"pod-vol\",\n\"run\": \"test\",\n},\n},\nSpec: corev1.PodSpec{\nContainers: []corev1.Container{\n{\nName:  \"my-container\",\nImage: \"nginx:1.14.2\",\nEnv: []corev1.EnvVar{\n{\nName: \"MYSQL_USER\",\nValueFrom: &amp;corev1.EnvVarSource{\nConfigMapKeyRef: &amp;corev1.ConfigMapKeySelector{\nLocalObjectReference: corev1.LocalObjectReference{\nName: \"mysql-config22\",\n},\nKey: \"user\",\n},\n},\n},\n{\nName:  \"hello\",\nValue: \"world\",\n},\n},\n},\n},\n},\n}\ncreatedPod, err := clientset.\nCoreV1().\nPods(\"default\").\nCreate(context.TODO(),\npod1,\nmetav1.CreateOptions{\n})\nif err != nil {\nlog.Fatal(err)\n}\nfmt.Printf(\"%s\\n\", createdPod.Name)\n</code></pre> <pre><code>k exec my-pod  -- env\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/client-go/client-go/#secret","title":"secret","text":"listdetailcreatedelete <pre><code>list, err := clientset.CoreV1().Secrets(\"default\").List(context.TODO(), metav1.ListOptions{})\nif err != nil {\npanic(err.Error())\n}\nfor _, item := range list.Items {\nfmt.Println(\"name:\", item.ObjectMeta.Name)\nfmt.Println(\"type:\", item.TypeMeta)\nif item.Immutable != nil {\nfmt.Println(\"immutable:\", *item.Immutable)\n}\nfmt.Println(\"data:\", item.Data)\nfmt.Println(\"stringData:\", item.StringData)\nfmt.Println(\"type:\", item.Type)\n}\n</code></pre> <pre><code>item, err := clientset.CoreV1().Secrets(\"default\").Get(context.TODO(), \"mysql-root-password\", metav1.GetOptions{})\nif err != nil {\npanic(err.Error())\n}\nfmt.Println(\"name:\", item.ObjectMeta.Name)\nfmt.Println(\"type:\", item.TypeMeta)\nif item.Immutable != nil {\nfmt.Println(\"immutable:\", *item.Immutable)\n}\nfmt.Println(\"data:\", item.Data)\nfmt.Println(\"stringData:\", item.StringData)\nfmt.Println(\"type:\", item.Type)\n</code></pre> <pre><code>secret := &amp;corev1.Secret{\nObjectMeta: metav1.ObjectMeta{\nName:      \"secret-test\",\nNamespace: \"default\",\n},\nStringData: map[string]string{\n\"username\": \"root\",\n\"password\": \"123456\",\n},\nType: corev1.SecretTypeOpaque, // \u4e0d\u5199\u9ed8\u8ba4\u5c31\u662f\u8fd9\u4e2a\u7c7b\u578b\n}\ncreatedSecret, err := clientset.\nCoreV1().\nSecrets(\"default\").\nCreate(context.TODO(), secret, metav1.CreateOptions{})\nif err != nil {\nfmt.Printf(\"err: %v\\n\", err)\nreturn\n}\nfmt.Printf(\"ok: %s\\n\", createdSecret.Name)\n</code></pre> <pre><code>err = clientset.CoreV1().Secrets(\"default\").Delete(context.TODO(), \"secret-test\", metav1.DeleteOptions{})\nif err != nil {\npanic(err.Error())\n}\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/client-go/client-go/#svc","title":"svc","text":"create svccreate ep <pre><code>service := &amp;corev1.Service{\nObjectMeta: metav1.ObjectMeta{\nName:      \"svc-test\",\nNamespace: namespace,\n},\nSpec: corev1.ServiceSpec{\nSelector: map[string]string{\n\"app\": \"pod-deploy-nginx2\",\n},\nPorts: []corev1.ServicePort{\n{\nProtocol:   corev1.ProtocolTCP,\nPort:       8981,\nTargetPort: intstr.FromInt(int(80)),\n},\n},\n},\n}\ncreatedSVC, err := clientset.CoreV1().\nServices(namespace).\nCreate(context.TODO(), service, metav1.CreateOptions{})\nif err != nil {\npanic(err.Error())\n}\nfmt.Println(createdSVC.Name)\n</code></pre> <pre><code>endpoint := &amp;corev1.Endpoints{\nObjectMeta: metav1.ObjectMeta{\nName:      \"svc-test-2\",\nNamespace: namespace,\n},\nSubsets: []corev1.EndpointSubset{\n{\nAddresses: []corev1.EndpointAddress{\n{\nIP: \"10.244.1.82\",\n},\n{\nIP: \"10.244.2.81\",\n},\n},\nPorts: []corev1.EndpointPort{\n{\nProtocol: corev1.ProtocolTCP,\nPort:     int32(80),\n},\n},\n},\n},\n}\nep, err := clientset.\nCoreV1().\nEndpoints(\"default\").\nCreate(context.TODO(), endpoint, metav1.CreateOptions{})\nif err != nil {\npanic(err.Error())\n}\nfmt.Println(ep.Name)\n</code></pre> <ol> <li> <p>client-go \u21a9</p> </li> <li> <p>sample-apiserver \u21a9</p> </li> <li> <p>kubernetes-sigs \u21a9</p> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/develop/operator/crd/","title":"\u81ea\u5b9a\u4e49\u8d44\u6e90","text":""},{"location":"devops/k8s/develop/operator/crd/#customresourcedefinition","title":"CustomResourceDefinition","text":"<p>Info</p> <ol> <li>k8s \u5728\u53d1\u5c55\u8fc7\u7a0b\u4e2d, \u80af\u5b9a\u662f\u4e0d\u65ad\u7684\u589e\u52a0\u67d0\u79cd\u7c7b\u578b\u7684\u8d44\u6e90, \u6bd4\u5982  deployment, \u6211\u4eec\u4f1a\u521b\u5efa\u4e00\u4e2a \u7c7b\u578b\u662fkind: Deployment\u7684yaml\u6587\u4ef6</li> <li>k8s \u7cfb\u7edf\u91cc\u80af\u5b9a\u6709\u76f8\u5173\u7684\u4ee3\u7801\u6765\u5b9e\u73b0 \u8fd9\u4e2a\u7c7b\u578b\u7684\u4e1c\u897f\u6240\u5177\u6709\u7684\u529f\u80fd</li> <li>\u589e\u52a0\u8fd9\u6837\u4e00\u4e2a\u529f\u80fd, \u53ef\u80fd\u5c31\u9700\u8981\u5f88\u591a\u7684\u4ee3\u7801, k8s \u4ee3\u7801\u66f4\u65b0\u7684\u5468\u671f \u53ef\u80fd\u5c31\u6bd4\u8f83\u957f, \u65b0\u529f\u80fd\u7b49\u5f85\u65f6\u95f4\u53ef\u80fd\u5c31\u6bd4\u8f83\u957f</li> <li>\u800c\u81ea\u5b9a\u4e49\u8d44\u6e90 \u7684\u51fa\u73b0 ,\u5c31\u662f\u8ba9\u7528\u6237\u53ef\u4ee5\u81ea\u5df1\u6765\u7b80\u5355\u7684\u505a\u8fd9\u6837\u4e00\u4e2a\u6269\u5c55,\u589e\u52a0\u4e86\u4e00\u4e2a\u81ea\u5df1\u9700\u8981\u7684\u529f\u80fd.</li> </ol> <p>1.\u6211\u4eec\u73b0\u5728\u6765\u521b\u5efa\u4e00\u4e2ayaml\u6587\u4ef6\u6765\u8868\u793a\u6211\u4eec\u7684\u8d44\u6e90</p> crontab.yaml<pre><code>apiVersion: \"stable.example.com/v1\"\nkind: CronTab\nmetadata:\nname: my-new-cron-object\nspec:\ncronSpec: \"* * * * */5\"\nimage: my-awesome-cron-image\n</code></pre> <p>\u6211\u4eecapply\u770b\u770b,\u80af\u5b9a\u62a5\u9519\u4e86<pre><code>k apply -f crontab.yaml\nerror: unable to recognize \"crontab.yaml\": no matches for kind \"CronTab\" in version \"stable.example.com/v1\"\n</code></pre> 2.\u6211\u4eec\u5f97\u8ba9\u7cfb\u7edf\u77e5\u9053\u4f60yaml\u91cc\u7684\u4e1c\u897f\u662f\u5565\u73a9\u610f,\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2aCustomResourceDefinition\u8ba9\u7cfb\u7edf\u77e5\u9053\u4f60yaml\u91cc\u7684\u4e1c\u897f\u662f\u5565\u610f\u601d crontab-resource-definition.yaml<pre><code>apiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n# \u540d\u5b57\u5fc5\u9700\u4e0e\u4e0b\u9762\u7684 spec \u5b57\u6bb5\u5339\u914d\uff0c\u5e76\u4e14\u683c\u5f0f\u4e3a '&lt;\u540d\u79f0\u7684\u590d\u6570\u5f62\u5f0f&gt;.&lt;\u7ec4\u540d&gt;'\nname: crontabs.stable.example.com\nspec:\n# \u7ec4\u540d\u79f0\uff0c\u7528\u4e8e REST API: /apis/&lt;\u7ec4&gt;/&lt;\u7248\u672c&gt;\ngroup: stable.example.com\n# \u5217\u4e3e\u6b64 CustomResourceDefinition \u6240\u652f\u6301\u7684\u7248\u672c\nversions: # \u53ef\u8bbe\u7f6e\u591a\u4e2a\u7248\u672c\n- name: v1\n# \u6bcf\u4e2a\u7248\u672c\u90fd\u53ef\u4ee5\u901a\u8fc7 served \u6807\u5fd7\u6765\u72ec\u7acb\u542f\u7528\u6216\u7981\u6b62\nserved: true\n# \u5176\u4e2d\u4e00\u4e2a\u4e14\u53ea\u6709\u4e00\u4e2a\u7248\u672c\u5fc5\u9700\u88ab\u6807\u8bb0\u4e3a\u5b58\u50a8\u7248\u672c\nstorage: true\nschema:\nopenAPIV3Schema: #openAPIV3Schema \u662f\u9a8c\u8bc1\u81ea\u5b9a\u4e49\u5bf9\u8c61\u7684\u6a21\u5f0f\u3002(1)\ntype: object\nproperties:\nspec:\ntype: object\nproperties:\ncronSpec:\ntype: string\nimage:\ntype: string\nreplicas:\ntype: integer\nadditionalPrinterColumns: #(2)\n- name: Spec\ntype: string\ndescription: The cron spec defining the interval a CronJob is run\njsonPath: .spec.cronSpec\n- name: Replicas\ntype: integer\ndescription: The number of jobs launched by the CronJob\njsonPath: .spec.replicas\n- name: Age\ntype: date\njsonPath: .metadata.creationTimestamp\n# \u8303\u56f4 \u53ef\u4ee5\u662f Namespaced \u6216 Cluster\n# \u5c31\u50cfpod ,\u662f\u6709 ns \u8303\u56f4\u7684\nscope: Namespaced\nnames:\n# \u540d\u79f0\u7684\u590d\u6570\u5f62\u5f0f\uff0c\u7528\u4e8e URL\uff1a/apis/&lt;\u7ec4&gt;/&lt;\u7248\u672c&gt;/&lt;\u540d\u79f0\u7684\u590d\u6570\u5f62\u5f0f&gt;\nplural: crontabs\n# \u540d\u79f0\u7684\u5355\u6570\u5f62\u5f0f\uff0c\u4f5c\u4e3a\u547d\u4ee4\u884c\u4f7f\u7528\u65f6\u548c\u663e\u793a\u65f6\u7684\u522b\u540d\nsingular: crontab\n# kind \u901a\u5e38\u662f\u5355\u6570\u5f62\u5f0f\u7684\u9a7c\u5cf0\u547d\u540d\uff08CamelCased\uff09\u5f62\u5f0f\u3002\u4f60\u7684\u8d44\u6e90\u6e05\u5355\u4f1a\u4f7f\u7528\u8fd9\u4e00\u5f62\u5f0f\u3002\nkind: CronTab\n# shortNames \u5141\u8bb8\u4f60\u5728\u547d\u4ee4\u884c\u4f7f\u7528\u8f83\u77ed\u7684\u5b57\u7b26\u4e32\u6765\u5339\u914d\u8d44\u6e90, \u6bd4\u5982 k get po \u4e2d\u7684po \u662fpod\nshortNames:\n- ct\n</code></pre></p> <ol> <li>\u5408\u6cd5\u6027\u9a8c\u8bc1</li> <li>\u989d\u5916\u7684\u6253\u5370\u5217  <pre><code>k get ct #\u53ef\u4ee5\u770b\u5230\u66f4\u591a\u7684\u5217\nNAME                 SPEC        REPLICAS   AGE\nmy-new-cron-object   * * * * *   1          7s\n</code></pre></li> </ol> <pre><code>k apply -f crontab-resource-definition.yaml\n#\u67e5\u770b\u521b\u5efa\u4e86\u54ea\u4e9b \u8d44\u6e90\u5b9a\u4e49\nk get crd #(2)\nk api-resources # \u8fd9\u4e2a\u65f6\u5019\u80fd\u770b\u5230\u8fd9\u4e2a\u7c7b\u578bcrontab\u7684\u8d44\u6e90\n# \u521b\u5efa\u5b8c\u6210\u540e,\u6211\u4eec\u5c31\u53ef\u4ee5\u6709 \u901a\u8fc7http \u6765\u67e5\u8be2\u8fd9\u7c7b\u8d44\u6e90\u4e86\ncurl localhost:8001/apis/stable.example.com/v1/namespaces/default/crontabs/ #(1)\n# \u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u521b\u5efa\u8fd9\u4e2a\u81ea\u5b9a\u4e49\u7c7b\u578b\u7684\u5bf9\u8c61\nk apply -f crontab.yaml\n# \u548c\u6211\u4eec\u4f7f\u7528 k get po  \u4e00\u6837\n# \u53ef\u4ee5\u7528\u4e0a\u9762crd\u91cc\u5b9a\u4e49\u7684ct\u8fd9\u4e2ashortName\nk get ct #(3)\ncurl localhost:8001/apis/stable.example.com/v1/namespaces/default/crontabs/my-new-cron-object\n</code></pre> <ol> <li>\u7ed3\u679c     <pre><code>{\n\"apiVersion\": \"stable.example.com/v1\",\n\"items\": [],\n\"kind\": \"CronTabList\",\n\"metadata\": {\n\"continue\": \"\",\n\"resourceVersion\": \"2608555\"\n}\n}\n</code></pre></li> <li>\u7ed3\u679c     <pre><code>NAME                          CREATED AT\ncrontabs.stable.example.com   2023-08-07T02:35:01Z\n</code></pre></li> <li>\u7ed3\u679c     <pre><code>NAME                 AGE\nmy-new-cron-object   4s\n</code></pre></li> </ol> <p>3.\u73b0\u5728\u521b\u5efa\u7684CronTab \u7c7b\u578b\u7684\u5bf9\u8c61 \u548c\u6211\u4eecPOD \u7c7b\u4f3c, \u53ea\u662fpod\u5bf9\u8c61\u521b\u5efa\u5b8c\u540e,\u7cfb\u7edf\u4f1a\u7ed9\u521b\u5efa\u771f\u6b63\u7684pod,\u800cCronTab\u7cfb\u7edf\u53ef\u6ca1\u505a\u5565\u5b9e\u8d28\u6027\u7684\u52a8\u4f5c, \u8fd9\u9700\u8981\u6211\u4eec\u5199\u4e00\u4e9b\u4ee3\u7801(\u81ea\u5b9a\u4e49\u63a7\u5236\u5668,\u5c31\u662foperator), \u8ba9\u7cfb\u7edf\u770b\u5230\u8fd9\u6837\u7684\u5bf9\u8c61\u88ab\u5199\u5165\u540e,\u505a\u4e9b\u4ec0\u4e48\u4e8b\u60c5,\u5b8c\u5168\u7531\u7528\u6237\u6765\u8bbe\u8ba1. \u8be6\u89c1operator</p>"},{"location":"devops/k8s/develop/operator/crd/#finalizers","title":"Finalizers","text":""},{"location":"devops/k8s/develop/operator/crd/#_1","title":"\u4ecb\u7ecd","text":"<p>\u5982\u679c\u7ed9\u5bf9\u8c61\u8bbe\u7f6e\u4e86metadata.finalizers\u5b57\u6bb5,  \u90a3\u4e48\u5220\u9664k8s\u5bf9\u8c61\u524d\u4f1a\u89e6\u53d1\u5bf9\u5e94\u7684\u94a9\u5b50\u51fd\u6570 \u53ef\u4ee5\u4f7f\u7528 Finalizers \u63a7\u5236\u8d44\u6e90\u7684\u5783\u573e\u6536\u96c6, \u6216\u963b\u6b62\u5220\u9664\u672a\u88ab\u7ba1\u7406\u7684\u8d44\u6e90</p> <p></p> <p>Tip</p> <p>\u4e00\u4e2a\u5e38\u89c1\u7684 Finalizer \u7684\u4f8b\u5b50\u662f kubernetes.io/pv-protection\uff0c \u5b83\u7528\u6765\u9632\u6b62\u610f\u5916\u5220\u9664 PersistentVolume \u5bf9\u8c61  \u5f53\u4e00\u4e2a PersistentVolume \u5bf9\u8c61\u88ab Pod \u4f7f\u7528\u65f6\uff0c Kubernetes \u4f1a\u6dfb\u52a0 pv-protection Finalizer\u3002 \u5982\u679c\u4f60\u8bd5\u56fe\u5220\u9664 PersistentVolume\uff0c\u5b83\u5c06\u8fdb\u5165 Terminating \u72b6\u6001\uff0c \u4f46\u662f\u63a7\u5236\u5668\u56e0\u4e3a\u8be5 Finalizer \u5b58\u5728\u800c\u65e0\u6cd5\u5220\u9664\u8be5\u8d44\u6e90\u3002 \u5f53 Pod \u505c\u6b62\u4f7f\u7528 PersistentVolume \u65f6\uff0c Kubernetes \u6e05\u9664 pv-protection Finalizer\uff0c\u63a7\u5236\u5668\u5c31\u4f1a\u5220\u9664\u8be5\u5377</p> <pre><code>k get pv pv-nfs-0001 -o yaml |grep finalizers -A 3 -B 10\napiVersion: v1\n    kind: PersistentVolume\n    metadata:\n    annotations:\n        pv.kubernetes.io/bound-by-controller: \"yes\"\ncreationTimestamp: \"2023-07-18T12:44:00Z\"\nfinalizers:\n    - kubernetes.io/pv-protection\n</code></pre>"},{"location":"devops/k8s/develop/operator/crd/#_2","title":"\u6a21\u62df\u4e00\u4e0b","text":"pod-finalizers.yaml<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pod-nginx\nlabels:\napp: pod-nginx\nfinalizers:\n- abc/protect-xyz # \u968f\u4fbf\u5199\u4e00\u4e2a\nspec:\ncontainers:\n- name: c-main\nimage: nginx:1.14.2\n</code></pre> <pre><code>k apply -f pod-finalizers.yaml\nk delete -f pod-finalizers.yaml # \u4f1a\u770b\u5230\u5361\u7740, \u7b49\u5f85..\n# \u6211\u4eec\u624b\u52a8\u5c06 finalizers \u5b57\u6bb5\u5220\u9664\nk edit pod  pod-nginx # \u5220\u9664finalizers\n# \u53ef\u4ee5\u770b\u5230 ok\u4e86\n</code></pre> <ol> <li> <p>custom-resources \u21a9</p> </li> <li> <p>\u7248\u672c\u8f6c\u6362 \u21a9</p> </li> <li> <p>finalizers \u21a9</p> </li> <li> <p>finalizers \u21a9</p> </li> </ol>"},{"location":"devops/k8s/develop/operator/kubebuilder/","title":"kubebuilder","text":""},{"location":"devops/k8s/develop/operator/kubebuilder/#controller-tools","title":"controller-tools","text":"<p>Tip</p> <p>\u524d\u9762sample-controller\u7684\u4f8b\u5b50,\u867d\u7136\u7528\u4e86\u4ee3\u7801\u751f\u6210\u5668,\u4f46\u662f\u8fd8\u6709\u86ee\u591a\u4e1c\u897f\u9700\u8981\u4e00\u4e2a\u4e2a\u624b\u52a8\u7f16\u5199, \u4f1a\u6bd4\u8f83\u9ebb\u70e6, \u6709\u6ca1\u6709\u4ec0\u4e48\u5de5\u5177\u5462?</p> <pre><code>git clone https://github.com/kubernetes-sigs/controller-tools\ncd controller-tools\ntree -L 2\n.\n\u251c\u2500\u2500 Makefile\n\u251c\u2500\u2500 boilerplate.go.txt\n\u251c\u2500\u2500 cmd # \u67093\u4e2a\u5de5\u5177\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controller-gen\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 helpgen\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 type-scaffold  # scaffold \u662f\u811a\u624b\u67b6\u7684\u610f\u601d,\u7528\u6765\u751f\u6210types.go \n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 go.sum\n\u251c\u2500\u2500 pkg\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 crd # \u6839\u636e\u8fd9\u4e2a,\u5927\u6982\u80fd\u60f3\u5230,\u4e0a\u9762\u7684\u90a3\u4e2a\u5de5\u5177\u5e94\u8be5\u80fd\u81ea\u52a8\u751f\u6210crd yaml\u6587\u4ef6\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 deepcopy # \u540c\u6837\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 genall\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 loader\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 markers\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 rbac # \u89d2\u8272\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 schemapatcher\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 typescaffold\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 version\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 webhook  # webhook \u76f8\u5173\n\u2514\u2500\u2500 test.sh\n\n# \u5b89\u88c5\u5de5\u5177\ngo install sigs.k8s.io/controller-tools/cmd/controller-gen\ngo install sigs.k8s.io/controller-tools/cmd/type-scaffold\n</code></pre> <pre><code>type-scaffold --kind CronTab #(1)\n# \u6839\u636e\u6211\u4eectypes.go\u7684\u5b9a\u4e49 (\u6211\u4eec\u4e4b\u524d\u53ef\u4ee5\u8bf4\u662f\u5148\u5b9a\u4e49\u4e86crd yaml ,\u7136\u540e\u6765\u5199types.go \u6587\u4ef6)\n# \u4f1a\u5728\u5f53\u524d\u76ee\u5f55\u7684manifests \u4e0b \u751f\u6210\u81ea\u5b9a\u4e49\u8d44\u6e90\u7684crd yaml\u6587\u4ef6\ncontroller-gen crd paths=./...  output:crd:dir=manifests\n</code></pre> <ol> <li>\u7ed3\u679c\u53ef\u4ee5\u770b\u5230\u548c\u6211\u4eec\u4e0a\u9762\u5199\u7684types.go\u4e00\u6837\u7684\u4e1c\u897f     <pre><code>// CronTabSpec defines the desired state of CronTab\ntype CronTabSpec struct {\n// INSERT ADDITIONAL SPEC FIELDS -- desired state of cluster\n}\n// CronTabStatus defines the observed state of CronTab.\n// It should always be reconstructable from the state of the cluster and/or outside world.\ntype CronTabStatus struct {\n// INSERT ADDITIONAL STATUS FIELDS -- observed state of cluster\n}\n// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object\n// CronTab is the Schema for the crontabs API\n// +k8s:openapi-gen=true\ntype CronTab struct {\nmetav1.TypeMeta   `json:\",inline\"`\nmetav1.ObjectMeta `json:\"metadata,omitempty\"`\nSpec   CronTabSpec   `json:\"spec,omitempty\"`\nStatus CronTabStatus `json:\"status,omitempty\"`\n}\n// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object\n// CronTabList contains a list of CronTab\ntype CronTabList struct {\nmetav1.TypeMeta `json:\",inline\"`\nmetav1.ListMeta `json:\"metadata,omitempty\"`\nItems           []CronTab `json:\"items\"`\n}\n</code></pre></li> </ol>"},{"location":"devops/k8s/develop/operator/kubebuilder/#kubebuilder","title":"kubebuilder","text":"<p>Tip</p> <p>kubebuilder \u662f\u4e13\u95e8\u7528\u6765\u5f00\u53d1operator \u7684\u811a\u624b\u67b6\u5de5\u5177. \u524d\u9762\u7a0d\u5fae\u4ecb\u7ecd\u4e86\u4e0b controller-tools,\u73b0\u5728\u4ecb\u7ecd\u7684kubebuilder \u5b9e\u9645\u5185\u90e8\u4f1a\u4e5f\u4f7f\u7528\u5230\u4e86controller-tools.</p>"},{"location":"devops/k8s/develop/operator/kubebuilder/#_1","title":"\u5feb\u901f\u611f\u53d7\u4e00\u4e0b","text":"<pre><code>curl -L -o kubebuilder \"https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)\"\nchmod +x kubebuilder &amp;&amp; mv kubebuilder /usr/local/bin/\n# \u76f4\u63a5\u8fd0\u884c\u547d\u4ee4, \u4f1a\u770b\u5230\u4e00\u4e9b\u5e2e\u52a9\nkubebuilder\n\nmkdir crd-kubebuilder\ncd crd-kubebuilder\ngo mod init crd-kubebuilder\n\n# 1. \u521d\u59cb\u5316,\u4f7f\u7528\u7684v4 plugin, \u4f1a\u4e0b\u8f7d\u6bd4\u8f83\u65b0\u7248\u672c\u7684 \u5e93\nkubebuilder init --domain example.com\ntree -L 2\n.\n\u251c\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 Makefile\n\u251c\u2500\u2500 PROJECT\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 cmd\n\u2502   \u2514\u2500\u2500 main.go\n\u251c\u2500\u2500 config # \u4e00\u4e9byaml\u6587\u4ef6\n\u2502   \u251c\u2500\u2500 default\n\u2502   \u251c\u2500\u2500 manager\n\u2502   \u251c\u2500\u2500 prometheus\n\u2502   \u2514\u2500\u2500 rbac\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 go.sum\n\u2514\u2500\u2500 hack\n    \u2514\u2500\u2500 boilerplate.go.txt\n\n# 2. \u521b\u5efaapi\nkubebuilder create api  --group stable  --version v1 --kind CronTab\n# y y\n# 3. \u7f16\u5199\u63a7\u5236\u5668\u903b\u8f91\u7b49\u903b\u8f91\n# 4. \u751f\u6210 crd\nmake manifests\n</code></pre>"},{"location":"devops/k8s/develop/operator/kubebuilder/#_2","title":"\u67b6\u6784\u4ecb\u7ecd","text":"<ol> <li> <p>kubebuilder github \u21a9</p> </li> <li> <p>kubebuilder\u540c\u4e0a \u21a9</p> </li> <li> <p>kubebuilder\u6559\u7a0b \u21a9</p> </li> <li> <p>code-generation-customresources \u21a9</p> </li> <li> <p>controller-tools \u21a9</p> </li> <li> <p>controller-runtime \u21a9</p> </li> <li> <p>controller-gen\u4f7f\u7528 \u21a9</p> </li> </ol>"},{"location":"devops/k8s/develop/operator/sample-controller/","title":"sample-controller","text":"<p>\u91cd\u8981\u8bf4\u660e</p> <ol> <li>\u5148\u770b\u63a7\u5236\u5668\u7ec4\u4ef6\u7684\u539f\u7406\u4ee5\u53ca\u81ea\u5b9a\u4e49\u63a7\u5236\u5668</li> <li>operator \u5176\u5b9e\u5c31\u662f\u81ea\u5b9a\u4e49\u63a7\u5236\u5668, \u53ef\u80fd\u4e00\u822c\u4f1a\u5c06 \u7f16\u5199\u81ea\u5b9a\u4e49\u8d44\u6e90\u548c\u81ea\u5b9a\u4ee5\u63a7\u5236\u5668 \u53eb\u505a\u7f16\u5199operator</li> </ol> <p>\u53c2\u8003\u5b66\u4e60 k8s\u6e90\u7801\u4e2d<code>staging/src/k8s.io/sample-controller/</code>\u8fd9\u4e2a\u4f8b\u5b50 \u8fd9\u4e2a\u65f6\u5019 \u518d\u770b\u770b \u91cc\u9762\u7684controller.go\u6587\u4ef6, \u548c\u6211\u4eec\u4e4b\u524d\u5199\u7684\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u5dee\u4e0d\u591a.</p>","tags":["k8s"]},{"location":"devops/k8s/develop/operator/sample-controller/#_1","title":"\u81ea\u5b9a\u4e49\u8d44\u6e90","text":"<p>\u81ea\u5b9a\u4e49\u8d44\u6e90</p> crd-crontab.yaml<pre><code>apiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\nname: crontabs.stable.example.com\nspec:\ngroup: stable.example.com\nversions:\n- name: v1\nserved: true\nstorage: true\nschema:\nopenAPIV3Schema:\ntype: object\nproperties:\nspec:\ntype: object\nproperties:\ncron:\ntype: string\nimage:\ntype: string\nreplicas:\ntype: integer\nstatus:\ntype: object\nproperties:\navailableReplicas:\ntype: integer\n---\napiVersion: \"stable.example.com/v1\"\nkind: CronTab\nmetadata:\nname: my-new-cron-object\nspec:\ncron: \"* * * * */5\"\nimage: my-awesome-cron-image\n</code></pre> <pre><code>k apply -f crd-crontab.yaml\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/operator/sample-controller/#_2","title":"\u5b9a\u4e49\u7c7b\u578b","text":"<p>Tip</p> <p>\u53c2\u8003k8s\u6e90\u7801\u4e2d`staging/src/k8s.io/sample-controller/ \u76f8\u5173\u6587\u4ef6\u590d\u5236\u8fc7\u6765\u4fee\u6539\u4fee\u6539</p> <pre><code>tree crd-operator\ncrd-operator\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 hack\n\u2502   \u251c\u2500\u2500 boilerplate.go.txt\n\u2502   \u251c\u2500\u2500 tools.go\n\u2502   \u2514\u2500\u2500 update-codegen.sh\n\u251c\u2500\u2500 main.go\n\u2514\u2500\u2500 pkg\n    \u2514\u2500\u2500 apis # \u81ea\u5b9a\u4e49\u8d44\u6e90\u662f\u975e\u6838\u5fc3api, \u6240\u4ee5\u662fapis\n\u2514\u2500\u2500 stable.example.com # group\n\u251c\u2500\u2500 register.go\n            \u2514\u2500\u2500 v1 # version\n\u251c\u2500\u2500 doc.go\n                \u251c\u2500\u2500 register.go\n                \u251c\u2500\u2500 types.go\n</code></pre> register.gov1/register.gov1/doc.gov1/types.gohack/tools.gohack/update-codegen.sh <pre><code>package stableexamplecom\nconst (\nGroupName = \"stable.example.com\"\n)\n</code></pre> <pre><code>package v1\nimport (\nstableexamplecom \"crd-operator/pkg/apis/stable.example.com\"\nmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n\"k8s.io/apimachinery/pkg/runtime\"\n\"k8s.io/apimachinery/pkg/runtime/schema\"\n)\n// SchemeGroupVersion is group version used to register these objects\nvar SchemeGroupVersion = schema.GroupVersion{Group: stableexamplecom.GroupName, Version: \"v1\"}\n// Kind takes an unqualified kind and returns back a Group qualified GroupKind\nfunc Kind(kind string) schema.GroupKind {\nreturn SchemeGroupVersion.WithKind(kind).GroupKind()\n}\n// Resource takes an unqualified resource and returns a Group qualified GroupResource\nfunc Resource(resource string) schema.GroupResource {\nreturn SchemeGroupVersion.WithResource(resource).GroupResource()\n}\nvar (\n// SchemeBuilder initializes a scheme builder\nSchemeBuilder = runtime.NewSchemeBuilder(addKnownTypes)\n// AddToScheme is a global function that registers this API group &amp; version to a scheme\nAddToScheme = SchemeBuilder.AddToScheme\n)\n// Adds the list of known types to Scheme.\nfunc addKnownTypes(scheme *runtime.Scheme) error {\nscheme.AddKnownTypes(SchemeGroupVersion,\n&amp;CronTab{},\n&amp;CronTabList{},\n)\nmetav1.AddToGroupVersion(scheme, SchemeGroupVersion)\nreturn nil\n}\n</code></pre> <pre><code>// +k8s:deepcopy-gen=package\n// +groupName=stable.example.com\n// Package v1 is the v1 version of the API.\npackage v1\n</code></pre> <pre><code>package v1\nimport (\nmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n)\n// +genclient\n// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object\n// CronTab is a specification for a CronTab resource\n// \u5c31\u50cf\u5185\u7f6e\u8d44\u6e90\u5bf9\u8c61\u4e00\u6837, 4\u4e2a\u5927\u5c5e\u6027.\ntype CronTab struct {\nmetav1.TypeMeta   `json:\",inline\"`\nmetav1.ObjectMeta `json:\"metadata,omitempty\"`\nSpec   CronTabSpec   `json:\"spec\"`\nStatus CronTabStatus `json:\"status\"`\n}\n// CronTabSpec is the spec for a CronTab resource\ntype CronTabSpec struct {\nCron     string `json:\"cron\"` // \u6ce8\u610f\u548c\u4f60\u7684crd\u91cc\u5b9a\u4e49\u7684\u4e00\u6837\nReplicas *int32 `json:\"replicas\"`\n}\n// CronTabStatus is the status for a CronTab resource\ntype CronTabStatus struct {\nAvailableReplicas int32 `json:\"availableReplicas\"`\n}\n// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object\n// CronTabList is a list of CronTab resources\ntype CronTabList struct {\nmetav1.TypeMeta `json:\",inline\"`\nmetav1.ListMeta `json:\"metadata\"`\nItems []CronTab `json:\"items\"`\n}\n</code></pre> <pre><code>//go:build tools\n// +build tools\n/*\nCopyright 2019 The Kubernetes Authors.\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n    http://www.apache.org/licenses/LICENSE-2.0\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\npackage tools\n// \u56e0\u4e3a\u6211\u4eec\u4ee3\u7801\u4e2d\u6ca1\u6709\u4f7f\u7528\u8fd9\u4e2a\u5e93,\u4f46\u662f\u6211\u4eec\u53c8\u8981\u4f7f\u7528\u4ee3\u7801\u751f\u6210\u5668\n// \u6240\u4ee5\u7528\u8fd9\u4e2a\u65b9\u5f0f\u5c06\u8fd9\u4e2a\u4f9d\u8d56\u4e0b\u8f7d\u4e0b\u6765 (\u4f60\u5f53\u7136\u53ef\u4ee5\u5728\u4efb\u4f55.go\u6587\u4ef6\u91cc\u5199\u4e0a\u8fd9\u6837\u7684import,\u4e5f\u662fok\u7684.)\n// \u7136\u540e \u4f7f\u7528 go mod vendor \u540e\u5c06\u4e0b\u8f7d\u4f9d\u8d56\u5230\u9879\u76ee\u76ee\u5f55\u4e0b\u7684vendor \u76ee\u5f55,\u91cc\u9762\u5c31\u4f1a\u6709\u4f9d\u8d56(code-generator)\n// \u63a5\u7740 \u6211\u4eec\u5728\u4ee3\u7801\u751f\u6210\u811a\u672c\u4e2d\u6307\u5b9acode-generator\u7684\u8def\u5f84 (update-codegen.sh)\nimport _ \"k8s.io/code-generator\"\n</code></pre> <pre><code>#!/bin/bash\nSCRIPT_ROOT=$(dirname \"${BASH_SOURCE[0]}\")/..\n# code-generator \u76ee\u5f55\n# \u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u521b\u5efaoperator \u5199\u4ee3\u7801, \u662f\u5728\u4efb\u4f55\u4e00\u4e2a\u5730\u65b9\u521b\u5efa\u9879\u76ee\u76ee\u5f55\u7684\n# \u6240\u4ee5\u53ef\u80fd\u6700\u597d\u662f \u5728\u9879\u76ee\u76ee\u5f55 \u5c06\u4f9d\u8d56\u751f\u6210\u5230vendor \u76ee\u5f55(go mod vendor)\n# \u7136\u540e\u4ece\u8fd9\u4e2a vendor \u76ee\u5f55\u4e0b\u627e\u5230 \u4ee3\u7801\u751f\u6210\u5668\u811a\u672c\nCODEGEN_PKG=${CODEGEN_PKG:-$(cd \"${SCRIPT_ROOT}\"; ls -d -1 ./vendor/k8s.io/code-generator 2&gt;/dev/null)}\nif [ -z ${CODEGEN_PKG} ];then\necho \"\u8bf7\u6307\u5b9a\u4ee3\u7801\u751f\u6210\u5668\u811a\u672c\u8def\u5f84!!!\u6216\u4f7f\u7528 go mod vendor\u540e\u518d\u6267\u884c\u811a\u672c!\"\nexit\nfi\nGROUP_NAME=\"stable.example.com\"\nVERSION=\"v1\"\nMOD_NAME=\"crd-operator\" # go mod init \u521b\u5efa\u7684\u540d\u5b57\necho $ROOT_DIR\n# generate-groups.sh &lt;generators&gt; &lt;output-package&gt; &lt;apis-package&gt; &lt;groups-versions&gt; ...\n# output-package:\n#       \u8bbe\u7f6e\u4e3a\u5f53\u524d\u9879\u76ee\u6839\u76ee\u5f55\u7684\u7236\u76ee\u5f55\n#       \u9879\u76ee\u76ee\u5f55\u7684\u540d\u5b57\u8981\u4e0e  MOD_NAME \u4e00\u6837\n# --go-header-file  \u751f\u6210\u7684\u6587\u4ef6\u524d\u9762\u7684\u6ce8\u91ca,\u5fc5\u987b\u6307\u5b9a,\u5426\u5219\u62a5\u9519\n# bash \"${CODEGEN_PKG}\"/generate-groups.sh \"deepcopy,client,informer,lister\" \\\nbash \"${CODEGEN_PKG}\"/generate-groups.sh all \\\n${MOD_NAME}/pkg/generated ${MOD_NAME}/pkg/apis \\\n${GROUP_NAME}:${VERSION} \\\n--output-base \"${SCRIPT_ROOT}/../\" \\\n--go-header-file \"${SCRIPT_ROOT}\"/hack/boilerplate.go.txt\n</code></pre>","tags":["k8s"]},{"location":"devops/k8s/develop/operator/sample-controller/#_3","title":"\u4ee3\u7801\u751f\u6210\u5668\u751f\u6210\u6240\u9700\u4ee3\u7801","text":"<p>\u751f\u6210\u4ee3\u7801\u540e, \u53ef\u4ee5\u50cf \u64cd\u4f5c\u5185\u7f6e\u8d44\u6e90\u5bf9\u8c61\u90a3\u6837</p> <pre><code>go get k8s.io/client-go@v0.23.17\ngo get k8s.io/api@v0.23.17\ngo get k8s.io/apimachinery@v0.23.17\ngo get k8s.io/code-generator@v0.23.17\ngo mod tidy\ngo mod vendor\n./hack/update-codegen.sh\n\ntree crd-operator\n\u251c\u2500\u2500 pkg\n\u2502   \u251c\u2500\u2500 apis\n\u2502   \u2502   \u2514\u2500\u2500 stable.example.com\n\u2502   \u2514\u2500\u2500 generated # \u81ea\u52a8\u751f\u6210\u7684\u76ee\u5f55\n\u2502       \u251c\u2500\u2500 clientset # \u8fd9\u6837\u6211\u4eec\u80fd\u50cf\u4f7f\u7528pod \u4e00\u6837, \u7528clientset.CoreV1().Pods(\"\").List()\n\u2502       \u251c\u2500\u2500 informers # \u540c\u7406\n\u2502       \u2514\u2500\u2500 listers\n</code></pre> <p>Tip</p> <p>\u7f16\u5199main.go, \u5c31\u50cf client-go\u67e5\u8be2pod\u5217\u8868\u4e00\u6837 \u6216\u7f16\u5199\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u90a3\u6837\u4f7f\u7528informer \u7b49\u7b49..</p> main.go<pre><code>package main\nimport (\n\"context\"\n\"flag\"\n\"fmt\"\n\"path/filepath\"\nclientset \"crd-operator/pkg/generated/clientset/versioned\"\nmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n\"k8s.io/client-go/tools/clientcmd\"\n\"k8s.io/client-go/util/homedir\"\n)\nfunc main() {\nvar kubeconfig *string\nif home := homedir.HomeDir(); home != \"\" {\n// ~/.kube/config \u786e\u4fdd\u4f60\u5bb6\u76ee\u5f55\u4e0b\u6709k8s\u7684\u914d\u7f6e\u6587\u4ef6\n// \u4f60\u672c\u5730\u53ef\u4ee5\u7528kubectl get po \u8fdb\u884c\u67e5\u8be2.\nkubeconfig = flag.String(\"kubeconfig\", filepath.Join(home, \".kube\", \"config\"), \"(optional) absolute path to the kubeconfig file\")\n} else {\nkubeconfig = flag.String(\"kubeconfig\", \"\", \"absolute path to the kubeconfig file\")\n}\nflag.Parse()\n// \u4f7f\u7528\u6307\u5b9a\u7684kubeconfig\u6587\u4ef6\u521b\u5efa\u4e00\u4e2aConfig\u5bf9\u8c61\nconfig, err := clientcmd.BuildConfigFromFlags(\"\", *kubeconfig)\nif err != nil {\npanic(err.Error())\n}\n// \u521b\u5efa\u4e00\u4e2a\u65b0\u7684Kubernetes\u5ba2\u6237\u7aef\nclient, err := clientset.NewForConfig(config)\nif err != nil {\npanic(err.Error())\n}\ncrontabs, err := client.StableV1().CronTabs(\"default\").\nList(context.TODO(), metav1.ListOptions{})\nif err != nil {\npanic(err.Error())\n}\nfor _, item := range crontabs.Items {\nfmt.Println(item.Name, \":\", item.Spec.Cron)\n}\n}\n</code></pre> <ol> <li> <p>operator \u21a9</p> </li> <li> <p>code-generation-customresources \u21a9</p> </li> </ol>","tags":["k8s"]},{"location":"devops/k8s/ecosystem/helm/","title":"helm","text":""},{"location":"devops/k8s/ecosystem/helm/#_1","title":"\u4ecb\u7ecd","text":"Kubernetes\u7684\u4e16\u754c Linux\u7684\u4e16\u754c \u8fd0\u884c\u7740\u7684\u5bf9\u8c61 \u5bb9\u5668 \u8fdb\u7a0b \u8fd0\u884c\u6001\u7ba1\u7406 helm3 \u79fb\u9664\u4e86 tiller Systemd \u5b89\u88c5\u5305\u7248\u672c Helm Chart Version RPM Version \u5b89\u88c5\u5305 Helm Chart RPM\u5305 \u5305\u7ba1\u7406\u5de5\u5177 Helm Yum \u5b89\u88c5\u5305\u4ed3\u5e93 Helm Repository RPM Repositoy/Mirror \u64cd\u4f5c\u7cfb\u7edf Kubernetes Linux\u53d1\u884c\u7248"},{"location":"devops/k8s/ecosystem/helm/#_2","title":"\u5b89\u88c5","text":"<pre><code>wget https://repo.huaweicloud.com/helm/v3.12.2/helm-v3.12.2-linux-amd64.tar.gz\ntest $(sha256sum helm-v3.12.2-linux-amd64.tar.gz  |awk '{print $1}') == \"2b6efaa009891d3703869f4be80ab86faa33fa83d9d5ff2f6492a8aebe97b219\" &amp;&amp; echo \"file is ok\" || echo \"file is not ok\"\ntar -zxvf helm-v3.12.2-linux-amd64.tar.gz  -C /usr/local/bin/ --strip-components=1 linux-amd64/helm\n</code></pre>"},{"location":"devops/k8s/ecosystem/helm/#_3","title":"\u4f7f\u7528","text":"<pre><code># \u663e\u793a\u5b89\u88c5\u7684  -A \u8868\u793a\u6240\u6709\u547d\u540d\u7a7a\u95f4\nhelm list -A\nhelm uninstall xxx -n your-namespace\n\nhelm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/\nhelm repo list\n</code></pre> <ol> <li> <p>helm\u5b98\u65b9 \u21a9</p> </li> <li> <p>chartmuseum \u21a9</p> </li> <li> <p>\u56fd\u5185\u6e90\u4e0b\u8f7dhelm \u21a9</p> </li> <li> <p>github helm\u4e0b\u8f7d\u9875 \u21a9</p> </li> </ol>"},{"location":"go/basis/defer/","title":"defer","text":"<p>Tip</p> <p>\u5728\u51fd\u6570\u8fd4\u56de\u524d,return\u4e4b\u540e(\u5148\u6267\u884creturn,\u518ddefer) \u6267\u884c,\u5e38\u7528\u4e8e\u5173\u95ed\u8d44\u6e90</p> <p><pre><code>func defer1() int {\ni := 0\ndefer func() {\ni = 1\nfmt.Println(\"defer1\", i)\n}()\n// \u5b9e\u9645\u4e0a\u4f1a\u5f04\u4e00\u4e2a\u4e34\u65f6\u53d8\u91cf\u6765\u63a5\u6536i \u7136\u540e\n// \u540e\u7eed\u5bf9i\u7684\u64cd\u4f5c \u4e0e \u4e34\u65f6\u53d8\u91cf\u65e0\u5173\u4e86\nreturn i\n}\nfunc defer2() (i int) {\ndefer func() {\ni = 1\n}()\n// \u5df2\u7ecf\u6709\u53d8\u91cf\u540d,\u540e\u7eed\u7684\u66f4\u6539\u4f1a\u6539\u53d8i\n// \u5b66\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u548c\u6c47\u7f16\u4f1a\u66f4\u597d\u7406\u89e3, \u8fd9\u91cc\u6211\u5c31\u4e0d\u8be6\u7ec6\u5c55\u5f00\u4e86\nreturn i\n}\nfunc TestDefer(t *testing.T) {\nfmt.Println(111)\n// \u5148\u8fdb\u540e\u6267\u884c\ndefer func() {\nfmt.Println(333)\n}()\n{\n// \u4ee3\u7801\u5757\u4e2d\u7684defer \u4e5f\u662f\u5728\u51fd\u6570\u8fd4\u56de\u524d\u6267\u884c\ndefer func() {\nfmt.Println(\"\u4ee3\u7801\u5757\u4e2d\u7684defer\")\n}()\nfmt.Println(\"\u4ee3\u7801\u5757\u6267\u884c\u5b8c\u6bd5\")\n}\ndefer func() {\nfmt.Println(444)\n}()\nr := defer1()\nfmt.Println(r) // 0\nr2 := defer2()\nfmt.Println(r2) //1\nfmt.Println(222)\n}\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>111\n\u4ee3\u7801\u5757\u6267\u884c\u5b8c\u6bd5\ndefer1 1\n0\n1\n222\n444\n\u4ee3\u7801\u5757\u4e2d\u7684defer\n333\n</code></pre></p>"},{"location":"go/basis/defer/#_1","title":"\u5e95\u5c42\u539f\u7406","text":""},{"location":"go/basis/env/","title":"\u73af\u5883\u51c6\u5907","text":""},{"location":"go/basis/env/#_1","title":"\u5b89\u88c5","text":"<p>go \u4e00\u952e\u5b89\u88c5\u811a\u672c</p>"},{"location":"go/basis/env/#_2","title":"\u914d\u7f6e","text":"<pre><code>go env -w GOPROXY=https://goproxy.cn,http://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct\n</code></pre>"},{"location":"go/basis/env/#_3","title":"\u5e38\u7528\u6307\u4ee4","text":"<pre><code># \u6e05\u7406\u4e0b\u8f7d\u7684mod, \u4e00\u822c\u60c5\u51b5\u4e0b\u4e0d\u4f1a\u6e05\u7406.  ~/go/pkg/mod\ngo clean -modcache\n\ngo mod tidy\n\ngo env\nGOPATH=\"/Users/your_name/go\"  # go install \u5b89\u88c5\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u653e\u5728 GOPATH/bin\u4e2d\nGOMODCACHE=\"/Users/your_name/go/pkg/mod\"\nGOPRIVATE=\"\"\nGOPROXY=\"\"\nGOROOT=\"/usr/local/go\"\n</code></pre>"},{"location":"go/basis/env/#gvm","title":"gvm \u7248\u672c\u7ba1\u7406\u5de5\u5177","text":""},{"location":"go/basis/env/#_4","title":"\u73af\u5883\u95ee\u9898\u6392\u67e5","text":"<p>Question</p> <p>golang.org/x/sys@v0.0.0-20200930185726-fdedc70b468f/unix/syscall_darwin.1_13.go:29:3: //go:linkname must refer to declared function or variable</p> <p>Tips</p> <p>go get -u golang.org/x/sys \u5347\u7ea7\u7248\u672c</p> <ol> <li> <p>https://golang.google.cn/dl/ \u21a9</p> </li> </ol>"},{"location":"go/basis/func-closure/","title":"\u51fd\u6570\u548c\u95ed\u5305","text":""},{"location":"go/basis/func-closure/#_1","title":"\u51fd\u6570\u540d\u5230\u5e95\u662f\u4e2a\u5565","text":"main.go<pre><code>package main\nimport (\n\"fmt\"\n\"unsafe\"\n)\nfunc add(a, b int) int {\nsum := 0\nsum = a + b\nreturn sum\n}\nfunc main() {\nprintln(add)\naddFuncVar := add\nprintln(addFuncVar)\n// \u8fd9\u91cc\u7531\u4e8eprintln() \u548c fmt.Printf(\"%p\") \u6253\u5370 \u51fd\u6570\u540d, \u5904\u7406\u4e0a\u4e0d\u540c, \u4e3a\u4e86\u770b\u51fd\u6570\u540d\u6240\u4ee3\u8868\u76f4\u63a5\u5185\u5bb9\naddFuncVarVal := *(*uint64)(unsafe.Pointer(&amp;addFuncVar))\n// \u6211\u4eec\u5f97\u5230addFunc\u53d8\u91cf\u7684\u503c \u4e0e\u4e0a\u9762 println(add) \u76f8\u540c\nfmt.Printf(\"\u51fd\u6570\u540d\u6240\u8868\u793a\u7684\u503c: 0x%x\\n\", addFuncVarVal)\n// \u6211\u4eec\u5c06\u8fd9\u4e2a\u503c \u4f5c\u4e3a\u5185\u5b58\u5730\u5740, \u5c06\u5b83\u8f6c\u6362\u4e3a\u6307\u9488,\u627e\u5230\u5b83\u6307\u5411\u7684\u5185\u5bb9\naddFuncCodeRealAddr := *(*uint64)(unsafe.Pointer(uintptr(addFuncVarVal)))\nfmt.Printf(\"\u628a\u51fd\u6570\u540d\u8868\u793a\u7684\u503c\u4f5c\u4e3a\u5730\u5740,\u5b83\u6307\u5411\u7684\u90a3\u5757\u5185\u5b58\u7684\u5185\u5bb9 (\u5373\u4ee3\u7801\u5730\u5740): 0x%x\\n\", addFuncCodeRealAddr)\n// fmt.Printf \u6253\u5370 \u51fd\u6570\u540d \u5730\u5740 \u7ed3\u679c\u662f \u771f\u6b63\u4ee3\u7801\u7684\u5730\u5740\nfmt.Printf(\"fmt.Printf(\\\"%%p\\\")\u6253\u5370\u7684\u503c: %p\\n\", add)\nadd(1, 2)\nprintln(9999)\n}\n</code></pre> <p>\u7f16\u8bd1<pre><code>go build -o main -gcflags \"-N -l\" main.go\n</code></pre> ./main  \u6267\u884c\u7ed3\u679c<pre><code>0x10b1790\n0x10b1790\n\u51fd\u6570\u540d\u6240\u8868\u793a\u7684\u503c: 0x10b1790\n\u628a\u51fd\u6570\u540d\u8868\u793a\u7684\u503c\u4f5c\u4e3a\u5730\u5740,\u5b83\u6307\u5411\u7684\u90a3\u5757\u5185\u5b58\u7684\u5185\u5bb9 (\u5373\u4ee3\u7801\u5730\u5740): 0x108f600\nfmt.Printf(\"%p\")\u6253\u5370\u7684\u503c: 0x108f600\n9999\n</code></pre></p> dlv\u8c03\u8bd5\u67e5\u770b add\u4ee3\u7801\u5b9e\u9645\u5730\u5740<pre><code># \u65ad\u70b9\u6253\u5230 add(1,2) \u90a3\u91cc\n(dlv) s #\u8fdb\u5165\u51fd\u6570add ,\u6211\u4eec\u53ef\u4ee5\u770b\u5230 PC\u7684\u503c, \u8fd9\u91cc\u662fadd\u4ee3\u7801\u6307\u4ee4\u7684\u5185\u5b58\u5730\u5740\n&gt; main.add() ./main.go:8 (PC: 0x108f600)\n3: import (\n4:         \"fmt\"\n5:         \"unsafe\"\n6: )\n7:\n=&gt;   8: func add(a, b int) int {\n</code></pre> \u76f4\u63a5\u67e5\u770b\u6c47\u7f16\u4ee3\u7801\u6765\u770badd\u4ee3\u7801\u5185\u5b58\u5730\u5740<pre><code>go tool objdump -s \"main.add\" main\nTEXT main.add(SB) main.go\n  main.go:8             0x108f600               4883ec18                SUBQ $0x18, SP\n  main.go:8             0x108f604               48896c2410              MOVQ BP, 0x10(SP)\nmain.go:8             0x108f609               488d6c2410              LEAQ 0x10(SP), BP\n  main.go:8             0x108f60e               4889442420              MOVQ AX, 0x20(SP)\n#....\n</code></pre> <p>\u4f60\u53ef\u4ee5\u7ee7\u7eed\u7528\u4ee3\u7801\u83b7\u53d6 add \u7f16\u8bd1\u540e\u7684\u6307\u4ee4,\u4e0e\u4e0a\u9762\u7684 4883ec18 \u662f\u5426\u4e00\u81f4 (\u6ce8\u610f\u5de6\u8fb9\u662f\u4f4e\u5730\u5740\u7684\u5185\u5bb9)<pre><code>    addFuncCode := *(*uint32)(unsafe.Pointer(uintptr(addFuncCodeRealAddr)))\nfmt.Printf(\"0x%x\\n\", addFuncCode)\n</code></pre> \u4e0a\u9762\u7684\u64cd\u4f5c\u53ef\u4ee5\u8bf4\u7528\u4ee3\u7801\u6765\u5b9e\u73b0\u83b7\u53d6\"\u4ee3\u7801\u5185\u5bb9\"</p> <p>\u7ed3\u8bba</p> <ul> <li>\u51fd\u6570\u540d\u7adf\u7136\u662f\u4e2a\u4e8c\u7ea7\u6307\u9488!!!</li> </ul>"},{"location":"go/basis/func-closure/#_2","title":"\u95ed\u5305","text":"<p>Tip</p> <p>\u95ed\u5305=\u51fd\u6570+\u5f15\u7528\u73af\u5883</p> <pre><code>package main\n// \u5916\u90e8\u51fd\u6570\nfunc outerFunc(x int) func() int {\n// \u5185\u90e8\u51fd\u6570\n// \u8fd9\u4e2a\u533f\u540d\u5185\u90e8\u51fd\u6570\u53ef\u4ee5\u8bbf\u95ee\u548c\u64cd\u4f5c\u5916\u90e8\u51fd\u6570\u4e2d\u7684x\u53d8\u91cf\ninnerFunc := func() int {\nreturn x\n}\nreturn innerFunc\n}\nfunc main() {\n// \u521b\u5efa\u4e00\u4e2a\u95ed\u5305\u51fd\u6570\nclosure := outerFunc(10)\n// \u8c03\u7528\u95ed\u5305\u51fd\u6570\nclosure()\n}\n</code></pre> <p>\u67e5\u770b\u6c47\u7f16 <pre><code>go build -o main -gcflags \"-N -l -S\" main.go\n</code></pre> \u4f1a\u770b\u5230\u5f53\u524d\u8fd9\u4e2a\u95ed\u5305\u7684\u7ed3\u6784, \u8be6\u7ec6\u4ee5\u540e\u6709\u65f6\u95f4\u518d\u641e... <pre><code>runtime.newobject\nLEAQ    type:noalg.struct { F uintptr; main.x int }(SB), AX\n</code></pre></p> \u9a8c\u8bc1\u4e00\u4e0b\u95ed\u5305\u7ed3\u6784<pre><code>package main\nimport (\n\"fmt\"\n\"unsafe\"\n)\n// \u5916\u90e8\u51fd\u6570\nfunc outerFunc(x int) func() int {\n// \u5185\u90e8\u51fd\u6570\ninnerFunc := func() int {\nreturn x\n}\nreturn innerFunc\n}\nfunc main() {\n// \u521b\u5efa\u4e00\u4e2a\u95ed\u5305\u51fd\u6570\nclosure := outerFunc(10)\n// \u8fd9\u4e2a\u662f\u9488\u5bf9 \u4e0a\u9762\u7684\u95ed\u5305\u7ed3\u6784\ntype closureStruct struct {\nF uintptr\nx int\n}\nclosureVal := *(*uint64)(unsafe.Pointer(&amp;closure))\nclosureCodeRealAddr := *(*closureStruct)(unsafe.Pointer(uintptr(closureVal)))\nfmt.Println(closureCodeRealAddr.x) //10\n// \u8c03\u7528\u95ed\u5305\u51fd\u6570\nclosure()\n}\n</code></pre>"},{"location":"go/basis/func-closure/#println-fmtprint","title":"println &amp; fmt.Print","text":"<p>Todo</p>"},{"location":"go/basis/gc/","title":"GC","text":"<p>\u53ef\u4ee5\u5148\u770b\u770b\u6c47\u7f16</p> <p>Tip</p> <p>TODO</p>"},{"location":"go/basis/gc/#_1","title":"\u53ef\u6267\u884c\u6587\u4ef6","text":"<p>Tip</p> <p>\u4ee5\u540e\u6211\u4f1a\u653e\u5230\u64cd\u4f5c\u7cfb\u7edf\u6216\u6c47\u7f16\u7684\u6559\u7a0b\u91cc\u518d\u8be6\u7ec6\u8bb2,\u8fd9\u91cc\u7b80\u5355\u5199\u5199</p> <p>\u7a0b\u5e8f\u53ef\u80fd\u7684\u5185\u5b58\u5206\u5e03\u60c5\u51b5</p> <ul> <li>\u6808\u533a<ul> <li>\u7531\u7f16\u8bd1\u5668\u81ea\u52a8\u5206\u914d\u91ca\u653e, \u5b58\u653e\u51fd\u6570\u7684\u53c2\u6570\u503c,\u5c40\u90e8\u53d8\u91cf\u7684\u503c\u7b49</li> </ul> </li> <li>\u5806\u533a<ul> <li>\u4e00\u822c\u7531\u7a0b\u5e8f\u5458\u5206\u914d\u91ca\u653e,\u5982\u679c\u7a0b\u5e8f\u5458\u6ca1\u6709\u4e3b\u52a8\u91ca\u653e,\u7a0b\u5e8f\u7ed3\u675f\u65f6\u53ef\u80fd\u7531\u7cfb\u7edf\u56de\u6536</li> </ul> </li> <li>\u5168\u5c40,\u9759\u6001\u5b58\u50a8\u533a<ul> <li>\u5168\u5c40\u53d8\u91cf\u548c\u9759\u6001\u53d8\u91cf\u7684\u5b58\u50a8\u662f\u653e\u5728\u4e00\u5757\u7684</li> <li>\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u548c\u9759\u6001\u53d8\u91cf\u5728\u4e00\u5757\u533a\u57df .data</li> <li>\u672a\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u548c\u672a\u521d\u59cb\u5316\u7684\u9759\u6001\u53d8\u91cf\u5728\u76f8\u90bb\u7684\u53e6\u4e00\u5757\u533a\u57df .bss</li> <li>\u7a0b\u5e8f\u7ed3\u675f\u540e\u6709\u7cfb\u7edf\u91ca\u653e</li> </ul> </li> <li>\u6587\u5b57\u5e38\u91cf\u533a<ul> <li>\u5e38\u91cf\u5b57\u7b26\u4e32\u5c31\u662f\u653e\u5728\u8fd9\u91cc\u7684,\u7a0b\u5e8f\u7ed3\u675f\u540e\u7531\u7cfb\u7edf\u91ca\u653e</li> </ul> </li> <li>\u4ee3\u7801\u533a .text<ul> <li>\u5b58\u653e\u51fd\u6570\u4f53\u7684\u4e8c\u8fdb\u5236\u4ee3\u7801</li> </ul> </li> </ul> \u67e5\u770b\u5404\u4e2a\u6bb5<pre><code># size \u53ef\u6267\u884c\u6587\u4ef6\n# \u67e5\u770b\u7a0b\u5e8f\u7684\u4ee3\u7801\u6bb5 \u6570\u636e\u6bb5\nsize main\n        text       data     bss     dec     hex filename\n        746162    13200  212528  971890   ed472 main\nobjdump -t main\n\n# c \u8bed\u8a00\u7684\u60c5\u51b5\u53ef\u4ee5\u8fd9\u6837\ngcc -c main.c -o main.o\n# \u53ef\u4ee5\u770b\u770b \u53d8\u91cf\u5728\u54ea\u4e2a\u6570\u636e\u6bb5\nobjdump -t main.o |grep \"\u53d8\u91cf\u540d\"\n</code></pre>"},{"location":"go/basis/interface/","title":"\u63a5\u53e3","text":""},{"location":"go/basis/interface/#_1","title":"\u4ec0\u4e48\u662f\u63a5\u53e3","text":"<ol> <li>\u63a5\u53e3\u662f\u4e00\u79cd\u534f\u8bae, \u4e00\u79cd\u89c4\u5219, \u89c4\u5b9a\u4e86\u4e00\u4e9b\u529f\u80fd,\u5177\u4f53\u600e\u4e48\u5b9e\u73b0\u4e0d\u5173\u5fc3</li> <li>\u6bd4\u5982\u6211\u4eec\u9700\u8981\u5c06\u6570\u636e\u8fdb\u884c\u5b58\u50a8\u8bfb\u53d6,\u6211\u4eec\u89c4\u5b9a\u4e86\u8bfb\u53d6\u4fdd\u5b58\u529f\u80fd,\u600e\u4e48\u5b9e\u73b0\u4e0d\u5173\u5fc3.</li> <li>\u5728\u73b0\u5b9e\u4e2d\u5176\u5b9e\u53ef\u4ee5\u8bf4\u6211\u4eec\u5f88\u591a\u65f6\u5019\u7ecf\u5e38\u8bf4\u7684\u90fd\u662f\"\u63a5\u53e3\"<ol> <li>\u8bf4\u6253\u8f66, \u8f66\u662f\u4e00\u79cd\u5b9e\u73b0\u4e864\u4e2a\u8f6e\u5b50\u80fd\u79fb\u52a8\u7684\u63a5\u53e3, \u4e0d\u7ba1\u662f\u6bd4\u4e9a\u8fea\u8fd8\u662f\u5b9d\u9a6c\u90fd\u884c</li> <li>\u8bf4\u5403\u996d, \u996d\u662f\u4e00\u79cd\u5b9e\u73b0\u4e86\u53ef\u4ee5\u5403\u9971\u529f\u80fd\u7684\u63a5\u53e3,\u5177\u4f53\u5403\u4ec0\u4e48,\u8fd8\u4e0d\u6e05\u695a</li> <li>...</li> </ol> </li> <li>\u6240\u4ee5\u5b9e\u9645\u4e0a\u5728\u5f00\u53d1\u4e2d\u6211\u4eec\u5e94\u5f53 \u9762\u5411\u63a5\u53e3\u5f00\u53d1(\u5b9e\u9645\u5728\u8bbe\u8ba1\u9636\u6bb5,\u6c9f\u901a\u4e2d\u4e00\u76f4\u8bf4\u7684\u90fd\u662f\"\u63a5\u53e3\"), \u63a5\u53e3\u662f\u4e00\u79cd\u62bd\u8c61, \u4e0d\u5173\u5fc3\u5177\u4f53\u600e\u4e48\u5b9e\u73b0,\u8fd9\u6837\u4ee5\u540e\u66f4\u6362\u5177\u4f53\u5b9e\u73b0\u5c31\u4f1a\u6bd4\u8f83\u65b9\u4fbf</li> </ol>"},{"location":"go/basis/interface/#_2","title":"\u57fa\u672c\u64cd\u4f5c","text":"<p>Tip</p> <p>\u5f53\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u65b0\u7684\u7c7b\u578b\u65f6, \u53ea\u8981\u4fdd\u8bc1\u5176\u65b9\u6cd5\u96c6\u5408\u4e0e\u67d0\u4e2a\u63a5\u53e3\u76f8\u540c\u5373\u53ef\u9690\u5f0f\u5b9e\u73b0\u8be5\u63a5\u53e3</p> <pre><code>type Animal interface {\nShout()\n}\ntype Cat struct {\nAge  int\nName string\n}\n// \u9690\u5f0f\u5730\u5b9e\u73b0\u4e86Animal \u63a5\u53e3\n// \u7ed3\u6784\u4f53\u5b9e\u73b0\u63a5\u53e3\nfunc (c Cat) Shout() {\nfmt.Println(\"miao\")\n}\ntype Dog struct {\nAge  int\n}\n// \u7ed3\u6784\u4f53\u6307\u9488\u5b9e\u73b0\u63a5\u53e3\n// \u5c06\u7ed3\u6784\u4f53\u6307\u9488 \u5f53\u6210\u4e00\u4e2a\u6574\u4f53, \u8fd9\u4e2a\u4e1c\u897f\u5b9e\u73b0\u4e86 \u65b9\u6cd5Shout\nfunc (d *Dog) Shout() {\nfmt.Println(\"wang\")\n}\nfunc TestSlice(t *testing.T) {\n// \u5b9e\u9645\u4f1a\u505a \u7c7b\u578b\u662f\u5426\u5b9e\u73b0\u63a5\u53e3 \u7684\u68c0\u67e5\n// \u6ce8\u610f\u8fd9\u4e2a\u5b9e\u9645\u4e0a\u5c31\u662f\u4e00\u79cd\u7c7b\u578b\u8f6c\u6362\nvar a Animal = Cat{Age: 2, Name: \"tom\"}\na.Shout()\n// \u8fd9\u6837\u4e5f\u662fok\u7684,\u524d\u9762\u6211\u4eec\u5728\u7ed3\u6784\u4f53\u90a3\u91cc\u77e5\u9053,\u7f16\u8bd1\u5668\u4f1a\u81ea\u52a8\u7ed9 Cat\u7684\u540c\u540d\u65b9\u6cd5\u751f\u6210\u4e00\u4e2a*Cat\u7684\u540c\u540d\u65b9\u6cd5\n// \u8fd9\u4e2a\u540c\u540d\u65b9\u5f0f \u7684\u4f5c\u7528\u5c31\u5728\u8fd9\u91cc\n// \u6240\u4ee5*Cat \u5b9e\u73b0\u4e86 Shout \u65b9\u6cd5,\u5b9e\u73b0\u4e86 Animal\u63a5\u53e3\nvar a2 Animal = &amp;Cat{Age: 3, Name: \"jjj\"}\na2.Shout()\n// \u7ed3\u6784\u4f53\u6307\u9488 *Dog \u5b9e\u73b0\u4e86Shout\u65b9\u6cd5, \u6240\u4ee5\u53ef\u4ee5\nvar d Animal = &amp;Dog{Age: 1}\nd.Shout()\n// \u62a5\u9519, \u56e0\u4e3a Dog{Age: 1} \u6ca1\u6709\u5b9e\u73b0Shout() \u65b9\u6cd5\n// var d2 Animal = Dog{Age: 1}\n// \u7c7b\u578b\u65ad\u8a00 \u65b9\u5f0f\u4e00\ncat, ok := a.(Cat)\nif ok {\nfmt.Println(cat.Age)\n}\n// \u7c7b\u578b\u65ad\u8a00 \u65b9\u5f0f\u4e8c\nswitch a.(type) {\ncase Cat:\ncat := a.(Cat)\nfmt.Println(cat.Name)\n}\n}\n</code></pre>"},{"location":"go/basis/interface/#_3","title":"\u6570\u636e\u7ed3\u6784","text":""},{"location":"go/basis/interface/#_4","title":"\u63a5\u53e3\u4e0e\u5143\u6570\u636e","text":"<p>\u5173\u4e8e\u63a5\u53e3\u7684\u601d\u8003</p> <ul> <li><code>var animal Animal = Cat{Age: 2, Name: \"tom\"}</code><ul> <li>animal\u662f\u4e00\u4e2a\u7c7b\u578b\u4e3aAnimal\u63a5\u53e3\u7684\u53d8\u91cf</li> <li>\u8fd9\u662f\u4e00\u4e2a\u7c7b\u578b\u8f6c\u6362\u7684\u64cd\u4f5c, \u8fd9\u53e5\u8bdd\u770b\u8d77\u6765\u662f\u4e2a\u5e9f\u8bdd</li> </ul> </li> <li>Cat \u80fd\u5426\u8f6c\u6362\u4e3a \u63a5\u53e3Animal, \u662f\u5982\u4f55\u5224\u65ad\u7684?<ul> <li>Cat \u7ed3\u6784\u4f53\u662f\u5426\u5b9e\u73b0\u4e86\u63a5\u53e3\u7684\u65b9\u6cd5</li> </ul> </li> <li>animal\u53ef\u4ee5\u8f6c\u6362\u4e3aCat \u5bf9\u8c61, \u4e5f\u5c31\u662f\u8bf4 \u63a5\u53e3\u53d8\u91cfanimal\u5fc5\u5b9a\u5b58\u50a8\u4e86Cat\u5bf9\u8c61\u6570\u636e\u7684\u4fe1\u606f,\u4ee5\u53caCat\u7684\u7c7b\u578b\u4fe1\u606f</li> <li>\u63a5\u53e3\u6709\u65b9\u6cd5, \u63a5\u53e3\u53d8\u91cfanimal \u5fc5\u5b9a\u5b58\u50a8\u4e86 \u63a5\u53e3\u5b9a\u4e49\u7684\u65b9\u6cd5</li> </ul> <p>\u5173\u4e8e\u5143\u6570\u636e\u7684\u601d\u8003</p> <ul> <li>\u6211\u4eec\u77e5\u9053 \u5f53\u6211\u4eec\u5b9a\u4e49 \u4e00\u4e2a int64 \u7c7b\u578b\u7684\u53d8\u91cf\u65f6, \u7f16\u8bd1\u65f6\u7f16\u8bd1\u5668\u6700\u7ec8\u4f1a\u6839\u636e\u4ee3\u7801\u5b9a\u4e49\u7684 int64\u7684 \"\u7c7b\u578b\u4fe1\u606f\" \u6765\u5206\u914d\u591a\u5c11\u5185\u5b58\u7684</li> <li>\u8fd9\u4e9b \"\u7c7b\u578b\u4fe1\u606f\" \u6211\u4eec\u80fd\u5426\u5f97\u5230\u5462?<ul> <li>\u5728\u5173\u4e8e\u63a5\u53e3\u7684\u601d\u8003\u4e2d,\u56e0\u4e3a \u63a5\u53e3\u53d8\u91cf\u548c\u7ed3\u6784\u4f53\u53ef\u4ee5\u4e92\u76f8\u8f6c\u6362,\u6240\u4ee5\u63a5\u53e3\u53d8\u91cf\u5fc5\u5b9a\u5b58\u50a8\u4e86 \u7ed3\u6784\u4f53\u5b9e\u9645\u6570\u636e\u4ee5\u53ca\u7c7b\u578b\u7684\u4fe1\u606f</li> <li>\u8fd9\u4e2a\u4e0d\u5c31\u662f\u6211\u4eec\u60f3\u8981\u7684\u5417? \u90a3\u4e48\u6211\u4eec\u5c06\u53d8\u91cf\u8f6c\u6362\u6210\u63a5\u53e3\u7c7b\u578b\u4e0d\u5c31\u53ef\u4ee5\u4e86\u5417!!! \u8fd9\u6ce2\u63a8\u7406\u53ef\u4ee5!</li> </ul> </li> <li>\u7f16\u8bd1\u540e\u7684\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4f1a\u6709\u8fd9\u4e9b\u4fe1\u606f\u5417?<ul> <li>\u6ca1\u6709, \u901a\u8fc7\u4e8c\u8fdb\u5236 \u7684\u6c47\u7f16\u6307\u4ee4 ,\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u6700\u7ec8\u7684\u4e00\u6761\u6761\u6307\u4ee4,\u5f97\u51fa\u6307\u4ee4\u91cc\u662f\u6ca1\u6709\u6240\u8c13\u8fd9\u4e9b\u7c7b\u578b\u7684\u6982\u5ff5</li> </ul> </li> </ul>"},{"location":"go/basis/interface/#interface","title":"\u7a7a\u63a5\u53e3 interface{}","text":"<p>Tip</p> <ol> <li>\u524d\u9762\u6211\u4eec\u8bf4\u9053\u53ea\u8981\u5b9e\u73b0\u4e86\u63a5\u53e3\u5b9a\u4e49\u7684\u65b9\u6cd5, \u5c31\u7b97\u5b9e\u73b0\u4e86\u63a5\u53e3.</li> <li>\u7a7a\u63a5\u53e3 \u53ef\u4ee5\u8ba4\u4e3a\u662f\u6ca1\u6709\u65b9\u6cd5\u7684\u63a5\u53e3, \u90a3\u4e48\u6240\u6709\u7c7b\u578b\u53ef\u4ee5\u8bf4\u90fd\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3</li> <li>\u90a3\u4e48\u6240\u6709\u7684\u7c7b\u578b\u90fd\u53ef\u4ee5\u8f6c\u6362\u4e3a \u7a7a\u63a5\u53e3\u7c7b\u578b</li> </ol> \u7a7a\u63a5\u53e3\u6570\u636e\u7ed3\u6784<pre><code>type eface struct {\n_type *_type // \u7c7b\u578b\u4fe1\u606f\ndata  unsafe.Pointer // \u6570\u636e\u4fe1\u606f\n}\ntype _type struct {\nsize       uintptr // \u8fd9\u4e2a\u7c7b\u578b\u9700\u8981\u5360\u7528\u7684\u5185\u5b58\u5927\u5c0f\nptrdata    uintptr // size of memory prefix holding all pointers\nhash       uint32  // \u7c7b\u578b\u7684hash\u503c, \u7528\u6765\u7c7b\u578b\u6bd4\u8f83\u548c\u67e5\u627e\ntflag      tflag  // (1)\nalign      uint8  // \u7c7b\u578b\u7684\u5bf9\u9f50\u8fb9\u754c\nfieldAlign uint8  // \u7c7b\u578b\u5b57\u6bb5\u7684\u5bf9\u9f50\u8fb9\u754c\nkind       uint8  //\u7c7b\u578b\u7684\u5206\u7c7b (2)\n// \u6bd4\u8f832\u4e2a\u5f53\u524d\u7c7b\u578b\u7684\u53d8\u91cf\u662f\u5426\u76f8\u7b49\nequal func(unsafe.Pointer, unsafe.Pointer) bool\ngcdata    *byte   // gc \u76f8\u5173\nstr       nameOff // \u504f\u79fb, \u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u5f97\u5230 \u7c7b\u578b\u7684\u540d\u79f0\u7b49\u4fe1\u606f\nptrToThis typeOff // \u540c\u4e0a, \u5f97\u5230\u5bf9\u5e94\u6307\u9488\u7c7b\u578b\u7684\u4fe1\u606f\n}\n</code></pre> <ol> <li>tflag     <pre><code>type tflag uint8\nconst (\ntflagUncommon      tflag = 1 &lt;&lt; 0\ntflagExtraStar     tflag = 1 &lt;&lt; 1\ntflagNamed         tflag = 1 &lt;&lt; 2\ntflagRegularMemory tflag = 1 &lt;&lt; 3 )\n</code></pre></li> <li>kind     <pre><code>const (\nInvalid Kind = iota\nBool\nInt\nInt8\nInt16\nInt32\nInt64\nUint\nUint8\nUint16\nUint32\nUint64\nUintptr\nFloat32\nFloat64\nComplex64\nComplex128\nArray\nChan\nFunc\nInterface\nMap\nPointer\nSlice\nString\nStruct\nUnsafePointer\n)\n</code></pre></li> </ol> <p>Danger</p> <p>\u66f4\u591a\u7ec6\u8282\u7b49,\u540e\u7eed\u6709\u65f6\u95f4\u518d\u5f04\u5427...</p> \u4ee3\u7801\u9a8c\u8bc1\u7ed3\u6784<pre><code>package main\nimport (\n//  _ \"test/pkg\"\n\"fmt\"\n\"unsafe\"\n)\ntype eface struct {\n_type *_type         // \u7c7b\u578b\u4fe1\u606f\ndata  unsafe.Pointer // \u6570\u636e\u4fe1\u606f\n}\ntype _type struct {\nsize       uintptr // \u8fd9\u4e2a\u7c7b\u578b\u9700\u8981\u5360\u7528\u7684\u5185\u5b58\u5927\u5c0f\nptrdata    uintptr // size of memory prefix holding all pointers\nhash       uint32  // \u7c7b\u578b\u7684hash\u503c, \u7528\u6765\u7c7b\u578b\u6bd4\u8f83\u548c\u67e5\u627e\ntflag      uint8   //\nalign      uint8   // \u7c7b\u578b\u7684\u5bf9\u9f50\u8fb9\u754c\nfieldAlign uint8   // \u7c7b\u578b\u5b57\u6bb5\u7684\u5bf9\u9f50\u8fb9\u754c\nkind       uint8   //\u7c7b\u578b\u7684\u5206\u7c7b\n// \u6bd4\u8f832\u4e2a\u5f53\u524d\u7c7b\u578b\u7684\u53d8\u91cf\u662f\u5426\u76f8\u7b49\nequal     func(unsafe.Pointer, unsafe.Pointer) bool\ngcdata    *byte   // gc \u76f8\u5173\nstr       nameOff // \u504f\u79fb, \u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u5f97\u5230 \u7c7b\u578b\u7684\u540d\u79f0\u7b49\u4fe1\u606f\nptrToThis int32   // \u540c\u4e0a, \u5f97\u5230\u5bf9\u5e94\u6307\u9488\u7c7b\u578b\u7684\u4fe1\u606f\n}\n//go:linkname resolveNameOff runtime.resolveNameOff\nfunc resolveNameOff(ptrInModule unsafe.Pointer, off nameOff) name\ntype Cat struct {\nAge  int\nName string\n}\nfunc (c Cat) Show() {\nfmt.Println(11)\n}\nfunc (c Cat) pp() {\nfmt.Println(11)\n}\nfunc main() {\nvar a int64 = 66\nvar b interface{} = a\nc := *(*eface)(unsafe.Pointer(&amp;b))\nfmt.Println(*(*int64)(c.data)) // 66\nfmt.Println(*c._type)\nd := resolveNameOff(unsafe.Pointer(c._type), c._type.str)\nfmt.Println(d.name())\nfmt.Println(\"--\u81ea\u5b9a\u4e49\u7c7b\u578b (\u7ed3\u6784\u4f53) \u7684\u60c5\u51b5 \u5462?----\")\ncat := Cat{3, \"tom\"}\nvar catAny interface{} = cat\ncatEface := *(*eface)(unsafe.Pointer(&amp;catAny))\nfmt.Println(*catEface._type)\ndd := resolveNameOff(unsafe.Pointer(catEface._type), catEface._type.str)\nfmt.Println(dd.name())\n// \u7ed3\u6784\u4f53\u4e2d\u5b57\u6bb5\u7684\u4fe1\u606f\u5462? \u597d\u50cf\u4ec5\u4eceeface \u4e2d\u6ca1\u6709.\n// \u6211\u4eec\u770b\u6e90\u7801\u4e2d\u7684 \u8fd9\u4e2a\u65b9\u6cd5\n// func (t *_type) uncommon() *uncommontype\n// \u4ece\u4e2d\u77e5\u9053 struct \u7c7b\u578b \u6709\u989d\u5916\u7684\u4fe1\u606f\u5b58\u50a8\u5728 *_type \u6307\u9488\u6307\u5411\u7684\u5185\u5b58\ncatStructUncommon := *(*structUncommon)(unsafe.Pointer(catEface._type))\n// \u53ef\u81ea\u884c\u9a8c\u8bc1\nfmt.Println(catStructUncommon.fields[1].name.name())\nfmt.Println(catStructUncommon.u)\n}\ntype structUncommon struct {\nstructtype\nu uncommontype\n}\ntype defaultUncommon struct {\n_type\nu uncommontype\n}\ntype uncommontype struct {\npkgpath nameOff\nmcount  uint16 // number of methods\nxcount  uint16 // number of exported methods\nmoff    uint32 // offset from this uncommontype to [mcount]method\n_       uint32 // unused\n}\ntype structtype struct {\ntyp     _type\npkgPath name\nfields  []structfield\n}\ntype structfield struct {\nname   name\ntyp    *_type\noffset uintptr\n}\ntype name struct {\nbytes *byte\n}\ntype nameOff int32\nfunc (n name) name() string {\nif n.bytes == nil {\nreturn \"\"\n}\ni, l := n.readVarint(1)\nreturn unsafe.String(n.data(1+i, \"non-empty string\"), l)\n}\nfunc (n name) readVarint(off int) (int, int) {\nv := 0\nfor i := 0; ; i++ {\nx := *n.data(off+i, \"read varint\")\nv += int(x&amp;0x7f) &lt;&lt; (7 * i)\nif x&amp;0x80 == 0 {\nreturn i + 1, v\n}\n}\n}\nfunc (n name) data(off int, whySafe string) *byte {\nreturn (*byte)(add(unsafe.Pointer(n.bytes), uintptr(off), whySafe))\n}\nfunc add(p unsafe.Pointer, x uintptr, whySafe string) unsafe.Pointer {\nreturn unsafe.Pointer(uintptr(p) + x)\n}\n</code></pre>"},{"location":"go/basis/interface/#_5","title":"\u975e\u7a7a\u63a5\u53e3","text":"<pre><code>type iface struct {\ntab  *itab\ndata unsafe.Pointer\n}\ntype itab struct {\ninter *interfacetype  // \u63a5\u53e3\u7684\u5143\u6570\u636e\n_type *_type   // \u5b9e\u9645\u7c7b\u578b\u7684\u5143\u6570\u636e\nhash  uint32 //  _type.hash\u7684\u590d\u5236\u7528\u6765\u65b9\u4fbf\u505a\u7c7b\u578b\u65ad\u8a00\n_     [4]byte\nfun   [1]uintptr // variable sized. fun[0]==0 means _type does not implement inter.\n}\ntype interfacetype struct {\ntyp     _type\npkgpath name\nmhdr    []imethod  // \u65b9\u6cd5\u5217\u8868\n}\ntype _type struct {\nsize       uintptr\nptrdata    uintptr // size of memory prefix holding all pointers\nhash       uint32\ntflag      tflag\nalign      uint8\nfieldAlign uint8\nkind       uint8\n// function for comparing objects of this type\n// (ptr to object A, ptr to object B) -&gt; ==?\nequal func(unsafe.Pointer, unsafe.Pointer) bool\n// gcdata stores the GC type data for the garbage collector.\n// If the KindGCProg bit is set in kind, gcdata is a GC program.\n// Otherwise it is a ptrmask bitmap. See mbitmap.go for details.\ngcdata    *byte\nstr       nameOff\nptrToThis typeOff\n}\n</code></pre>"},{"location":"go/basis/map/","title":"Map","text":"<p>Warning</p> <p>\u6e90\u7801\u65b9\u9762\u770b\u7684\u662f\u4e0d\u652f\u6301\u6cdb\u578b\u7684\u7248\u672c.  \u672a\u5b8c\u5f85\u7eed...</p>","tags":["Go"]},{"location":"go/basis/map/#map","title":"\u56fe\u4e66\u9986\u4e0emap","text":"map \u56fe\u4e66\u9986\u5bf9\u5e94 \u6876 \u4e00\u4e2a\u4e2a\u5206\u7c7b\u4e0d\u540c\u7684\u4e66\u67b6 \u54c8\u5e0c\u7b97\u6cd5 \u4f60\u6839\u636e\u4e66\u540d\u8fdb\u884c\u5224\u65ad\u7684\u5224\u65ad\u65b9\u6cd5,\u77e5\u9053\u662f\u54ea\u4e2a\u5206\u7c7b, \u653e\u5230\u54ea\u4e2a\u4e66\u67b6\u4e0a \u54c8\u5e0c\u51b2\u7a81 \u591a\u672c\u4e66,\u6839\u636e\u4e66\u540d\u8fdb\u884c\u5224\u65ad,\u90fd\u5728\u540c\u4e00\u4e2a\u5206\u7c7b\u4e66\u67b6\u4e0a,\u5c31\u4f9d\u6b21\u653e\u5230\u4e66\u67b6\u4e0a\u7684\u7a7a\u4f59\u4f4d\u7f6e\u5373\u53ef  \u5982\u679c\u8be5\u4e66\u67b6\u6ee1\u4e86,\u5219\u9700\u8981\u65b0\u7684\u540c\u5206\u7c7b\u540d\u7684\u4e66\u67b6,\u5c06\u4e66\u653e\u5230\u8fd9\u4e2a\u65b0\u7684\u4e66\u67b6\u4e0a. \u8bfb\u53d6\u6570\u636e \u4f60\u6839\u636e\u4e66\u540d\u8fdb\u884c\u5224\u65ad,\u77e5\u9053\u662f\u54ea\u4e2a\u5206\u7c7b\u4e66\u67b6,\u7136\u540e\u5230\u8be5\u4e66\u67b6\u4e0a \u4ece\u5de6\u5230\u53f3\u6bd4\u5bf9\u8fc7\u53bb,\u6bd4\u5bf9\u4e66\u540d(ISBN),\u627e\u5230\u5e76\u62ff\u8d70 \u5199\u5165\u6570\u636e \u4f60\u6839\u636e\u4e66\u540d\u8fdb\u884c\u5224\u65ad,\u77e5\u9053\u662f\u54ea\u4e2a\u5206\u7c7b\u4e66\u67b6,\u7136\u540e\u5230\u8be5\u4e66\u67b6\u4e0a \u4ece\u5de6\u5230\u53f3\u6bd4\u5bf9\u8fc7\u53bb,\u6bd4\u5bf9\u4e66\u540d(ISBN),\u5982\u679c\u6709,\u5219\u66f4\u6362\u4e66,\u6ca1\u6709\u5c31\u653e\u5165\u6700\u53f3\u8fb9\u7a7a\u4f59\u4f4d\u7f6e \u88c5\u8f7d\u56e0\u5b50(\u5143\u7d20\u4e2a\u6570/\u6876\u6570\u91cf&lt;=6.5) \u5f88\u663e\u7136\u4e66\u67b6\u4e0a\u7684\u4e66\u8d8a\u591a,\u4f60\u627e\u4e66\u5c31\u8d8a\u6162, \u5982\u679c\u6bcf\u4e2a\u4e66\u67b6\u4e0a\u90fd\u53ea\u6709\u4e00\u4e2a\u672c\u4e66, \u90a3\u4e48\u4f60\u4e00\u5b9a\u975e\u5e38\u5feb\u5c31\u627e\u5230\u4e86.","tags":["Go"]},{"location":"go/basis/map/#_1","title":"\u6e90\u7801\u5206\u6790","text":"","tags":["Go"]},{"location":"go/basis/map/#_2","title":"\u6570\u636e\u7ed3\u6784","text":"<pre><code>func main() {\na := make(map[int]string, 10)\nfmt.Println(a)\n}\n</code></pre> <p>Tip</p> <p><code>go tool compile -S main.go</code> \u67e5\u770b\u6c47\u7f16\u4ee3\u7801\u53ef\u4ee5\u770b\u5230 <code>runtime.makemap</code>  \u5bb9\u91cf\u5c0f\u7684\u8bdd,\u53ef\u4ee5\u770b\u5230<code>runtime.makemap_small</code></p> <pre><code>func makemap(t *maptype, hint int, h *hmap) *hmap {\nmem, overflow := math.MulUintptr(uintptr(hint), t.bucket.size)\nif overflow || mem &gt; maxAlloc {\nhint = 0\n}\nif h == nil {\nh = new(hmap)\n}\nh.hash0 = fastrand()\nB := uint8(0)\nfor overLoadFactor(hint, B) {\nB++\n}\nh.B = B\nif h.B != 0 {\nvar nextOverflow *bmap\nh.buckets, nextOverflow = makeBucketArray(t, h.B, nil)\nif nextOverflow != nil {\nh.extra = new(mapextra)\nh.extra.nextOverflow = nextOverflow\n}\n}\nreturn h\n}\n</code></pre> map\u7ed3\u6784\u6876\u7ed3\u6784 src/runtime/map.go<pre><code>type hmap struct {\n// map \u4e2d\u7684\u5143\u7d20\u4e2a\u6570\uff0c\u5fc5\u987b\u653e\u5728 struct \u7684\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\uff0c\n// \u56e0\u4e3a\u5185\u7f6e\u7684 len \u51fd\u6570\u4f1a\u901a\u8fc7unsafe.Pointer\u4f1a\u4ece\u8fd9\u91cc\u8bfb\u53d6\ncount     int\nflags     uint8\n// bucket\u7684\u6570\u91cf\u662f2^B, \u6700\u591a\u53ef\u4ee5\u653e loadFactor * 2^B \u4e2a\u5143\u7d20\uff0c\u518d\u591a\u5c31\u8981 hashGrow \u4e86\n// \u88c5\u8f7d\u56e0\u5b50 loadFactor= \u5143\u7d20\u4e2a\u6570/\u6876\u6570\u91cf&lt;=6.5\nB         uint8\n//overflow \u7684 bucket \u8fd1\u4f3c\u6570\nnoverflow uint16\nhash0     uint32 // hash seed\n//2^B \u5927\u5c0f\u7684\u6570\u7ec4\u6307\u9488\uff0c\u5982\u679c count == 0 \u7684\u8bdd\uff0c\u53ef\u80fd\u662f nil\nbuckets    unsafe.Pointer\n// \u6269\u5bb9\u7684\u65f6\u5019\uff0cbuckets \u957f\u5ea6\u4f1a\u662f oldbuckets \u7684\u4e24\u500d,\u53ea\u6709\u5728 growing \u65f6\u5019\u4e3a\u7a7a\u3002\noldbuckets unsafe.Pointer\n// \u6307\u793a\u6269\u5bb9\u8fdb\u5ea6\uff0c\u5c0f\u4e8e\u6b64\u5730\u5740\u7684 buckets \u8fc1\u79fb\u5b8c\u6210\nnevacuate  uintptr // progress counter for evacuation (buckets less than this have been evacuated)\n// \u5f53 key \u548c value \u90fd\u53ef\u4ee5 inline \u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u7528\u8fd9\u4e2a\u5b57\u6bb5\nextra *mapextra // optional fields\n}\n</code></pre> <p>src/runtime/map.go<pre><code>type bmap struct {\n// \u5b58\u50a8\u4e86\u952e\u7684\u54c8\u5e0c\u7684\u9ad8 8 \u4f4d\ntophash [bucketCnt]uint8\n}\n</code></pre> \u4e0a\u9762\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u5e76\u4e0d\u662f golang runtime \u65f6\u7684\u7ed3\u6784\uff0c\u5728\u7f16\u8bd1\u65f6\u5019\u7f16\u8bd1\u5668\u4f1a\u7ed9\u5b83\u52a8\u6001\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7ed3\u6784 \u56e0\u4e3a\u54c8\u5e0c\u8868\u4e2d\u53ef\u80fd\u5b58\u50a8\u4e0d\u540c\u7c7b\u578b\u7684\u952e\u503c\u5bf9\uff0c\u800c\u4e14 Go \u8bed\u8a00\u4e5f\u4e0d\u652f\u6301\u6cdb\u578b\uff0c\u6240\u4ee5\u952e\u503c\u5bf9\u5360\u636e\u7684\u5185\u5b58\u7a7a\u95f4\u5927\u5c0f\u53ea\u80fd\u5728\u7f16\u8bd1\u65f6\u8fdb\u884c\u63a8\u5bfc <pre><code>// \u6bcf\u4e2a bucket \u91cc\u9762\u6700\u591a\u5b58\u50a8 8 \u4e2a key\ntype bmap struct {\ntopbits  [8]uint8 //key \u8ba1\u7b97\u51fa\u6765\u7684 hash \u503c\u7684\u9ad8 8 \u4f4d\nkeys     [8]keytype\nvalues   [8]valuetype\npad      uintptr\noverflow uintptr\n}\n</code></pre></p> <p></p> <ul> <li>\u4e3a\u4ec0\u4e48 \u6876\u5185\u7684key\u548cvalue \u8981\u8fd9\u6837\u8bbe\u8ba1? \u6211\u4eec\u4ee5  <code>map[int64]int8</code> \u4e3a\u4f8b\u6765\u8bf4\u660e</li> <li>\u5982\u679c\u6309\u7167 key/value/key/value/\u2026 \u8fd9\u6837\u7684\u6a21\u5f0f\u5b58\u50a8\uff0c\u7531\u4e8e\u5185\u5b58\u5bf9\u9f50,\u5728\u6bcf\u4e00\u4e2a key/value \u4e4b\u540e\u90fd\u8981\u989d\u5916\u9700\u89817\u4e2a\u5b57\u8282</li> <li>int64 8\u4e2a\u5b57\u8282 int8\u4e00\u4e2a\u5b57\u8282, \u5269\u4e0b\u76847\u4e2a\u5b57\u8282\u5c31\u6d6a\u8d39\u4e86. \u56e0\u4e3a\u63a5\u4e0b\u6765\u7684key 8\u4e2a\u5b57\u8282\u4f60\u653e\u4e0d\u4e0b</li> <li> <p>\u800c\u5c06\u6240\u6709\u7684 key\uff0cvalue \u5206\u522b\u7ed1\u5b9a\u5230\u4e00\u8d77\uff0c\u8fd9\u79cd\u5f62\u5f0f key/key/\u2026/value/value/\u2026\uff0c\u5219\u53ea\u9700\u8981\u5728\u6700\u540e\u6dfb\u52a0 pad</p> </li> <li> <p>\u6bcf\u4e2a bucket \u8bbe\u8ba1\u6210\u6700\u591a\u53ea\u80fd\u653e 8 \u4e2a key-value \u5bf9\uff0c\u5982\u679c\u6709\u7b2c 9 \u4e2a key-value \u843d\u5165\u5f53\u524d\u7684 bucket\uff0c\u90a3\u5c31\u9700\u8981\u518d\u6784\u5efa\u4e00\u4e2a bucket \uff0c\u901a\u8fc7 overflow \u6307\u9488\u8fde\u63a5\u8d77\u6765</p> </li> </ul>","tags":["Go"]},{"location":"go/basis/map/#b","title":"B\u503c\u7684\u8ba1\u7b97","text":"","tags":["Go"]},{"location":"go/basis/map/#_3","title":"\u6e90\u7801\u89e3\u6790","text":"\u8fd9\u91cc\u6211\u4eec\u521b\u5efa10\u4e2a\u5bb9\u91cf\u7684map<pre><code>func main() {\na := make(map[int]string, 10)\nfmt.Println(a)\n}\n</code></pre> makemap()\u4e2dB\u503c\u76f8\u5173overLoadFactor()bucketShift() <pre><code>B := uint8(0)\n// hint \u5c31\u662f 10\n// \u5982\u679c\u5f53\u524d\u5143\u7d20/\u6876\u6570 \u8d85\u8fc7\u4e86\u88c5\u8f7d\u56e0\u5b506.5 \u5219\u8bf4\u660e\u6876\u6570\u4e0d\u591f,\u9700\u8981\u589e\u52a0,B++\nfor overLoadFactor(hint, B) {\nB++\n}\n</code></pre> <pre><code>// \u5224\u65ad\u662f\u5426\u8d85\u8fc7\u4e86\u88c5\u8f7d\u56e0\u5b50\nfunc overLoadFactor(count int, B uint8) bool {\n// bucketCntBits = 3\n// bucketCnt     = 1 &lt;&lt; bucketCntBits  //1 \u5de6\u79fb3\u4f4d = 8\n// \u5f97\u51fa bucketCnt = 8\n// loadFactorNum = 13\n// loadFactorDen = 2\n// count&gt;bucketCnt \u5982\u679c\u5bb9\u91cf&gt; \u4e00\u4e2a\u6876\u80fd\u653e\u7684\u5143\u7d20\u6570\n// \u4e14 \u7b2c\u4e00\u6b21\u5faa\u73af, B=0, 10&gt;13*(1/2) \u4e00\u4e2a\u6876\u6700\u591a6.5 ,\u6211\u4eec\u88c5\u8f7d\u56e0\u4e3a\u662f6.5,\u8d85\u8fc7\u4e86,\u8bf4\u660e\u9700\u8981\u6269\u5bb9\u6876\n// \u5219\u7b2c\u4e8c\u5faa\u73af, B=1, bucketShift(B)= 1&lt;&lt;1=2 , 10&gt;13*(2/2) \u4e0d\u57ce\u91cc,\u9000\u51fa\u5faa\u73af\u4e86, \u7ed3\u679c\u662fB=1\nreturn count &gt; bucketCnt &amp;&amp; uintptr(count) &gt; loadFactorNum*(bucketShift(B)/loadFactorDen)\n}\n</code></pre> <pre><code>func bucketShift(b uint8) uintptr {\n// Masking the shift amount allows overflow checks to be elided.\nreturn uintptr(1) &lt;&lt; (b &amp; (8*8 - 1))\n}\n</code></pre>","tags":["Go"]},{"location":"go/basis/map/#_4","title":"\u4ee3\u7801\u9a8c\u8bc1","text":"<pre><code>package main\nimport (\n\"fmt\"\n\"unsafe\"\n)\ntype MapStruct struct {\ncount int\nflags uint8\nB     uint8\nnoverflow  uint16\nhash0      uint32\nbuckets    uintptr //unsafe.Pointer\noldbuckets unsafe.Pointer\nnevacuate  uintptr\nextra      uintptr\n}\nfunc main() {\nm := make(map[int32]int32, 10)\n// m \u5b9e\u9645\u662f\u4e2a\u6307\u9488, \u6307\u5411\u4e86\u771f\u6b63\u7684hmap\nm[1] = 22\nm[2] = 33\nfmt.Println(len(m)) //2\nhmapReal := *(**MapStruct)(unsafe.Pointer(&amp;m))\nfmt.Println(hmapReal.count, hmapReal.B) // 2 1\nbks := hmapReal.buckets\nfor i := 0; i &lt; (1 &lt;&lt; hmapReal.B); i++ {\n// bmap\u7684size=88\nkbase := bks + uintptr(i*88)\nfor j := 0; j &lt; 8; j++ {\nfmt.Println(\"key=\", *(*int32)((unsafe.Pointer)(kbase + uintptr(8+j*4))))\nfmt.Println(\"val=\", *(*int32)((unsafe.Pointer)(kbase + uintptr(8+8*4+j*4))))\n}\n}\n}\n</code></pre>","tags":["Go"]},{"location":"go/basis/map/#_5","title":"\u8bbf\u95ee","text":"","tags":["Go"]},{"location":"go/basis/map/#for-range","title":"for range \u4e3a\u5565\u662f\u968f\u673a\u7684","text":"<p><pre><code>package main\nimport (\n\"fmt\"\n)\nfunc main() {\nm := make(map[int32]int32, 10)\nm[1] = 22\nm[2] = 33\nm[3] = 44\nm[4] = 55\nm[5] = 66\nfor k, v := range m {\nfmt.Println(k, v)\n}\n}\n</code></pre> \u67e5\u770b\u6c47\u7f16 \u53ef\u4ee5\u770b\u5230 \u5199\u5165map \u7684\u76f8\u5173\u51fd\u6570<code>runtime.mapassign_fast32</code> range \u7684\u76f8\u5173\u51fd\u6570 <code>runtime.mapiterinit</code></p> mapiterinit()<pre><code>func mapiterinit(t *maptype, h *hmap, it *hiter) {\n...\n...\n// decide where to start\nr := uintptr(fastrand())\nif h.B &gt; 31-bucketCntBits {\nr += uintptr(fastrand()) &lt;&lt; 31\n}\nit.startBucket = r &amp; bucketMask(h.B)\nit.offset = uint8(r &gt;&gt; h.B &amp; (bucketCnt - 1))\n// iterator state\nit.bucket = it.startBucket\n}\n</code></pre>","tags":["Go"]},{"location":"go/basis/map/#_6","title":"\u6269\u5bb9","text":"","tags":["Go"]},{"location":"go/basis/map/#_7","title":"\u4e3a\u4ec0\u4e48\u9700\u8981\u6269\u5bb9","text":"<p>\u6876\u91cckey \u591a\u8d77\u6765\u4e86,8\u4e2a\u6ee1\u4e86, \u518doverflow \u6574\u4e2a\u51e0\u4e2a. \u4f60\u67e5\u8be2\u8d77\u6765\u5c31\u6162\u4e86. \u9700\u8981\u904d\u5386\u6876\u91cc\u7684\u5143\u7d20, \u8fd9\u5c31\u662f\u6709\u88c5\u8f7d\u56e0\u5b50\u7684\u5224\u65ad</p>","tags":["Go"]},{"location":"go/basis/map/#_8","title":"\u6e10\u8fdb\u5f0f\u6269\u5bb9","text":"","tags":["Go"]},{"location":"go/basis/panic-recover/","title":"panic-recover","text":"<p>Tip</p> <p>panic\u540e\u4f1a\u6267\u884c\u5f53\u524d\u534f\u7a0b(main\u4e5f\u662f\u534f\u7a0b)\u7684defer</p> <pre><code>func TestPanic(t *testing.T) {\ndefer func() {\nfmt.Println(\"main end\")\n}()\ngo func() {\ndefer func() {\nfmt.Println(\"goroutine end\")\n}()\n// \u534f\u7a0b panic,\u81ea\u5df1\u7684defer \u6267\u884c\u4e86, \u5916\u90e8\u7684defer \u4e0d\u4f1a\u6267\u884c\n// \u7136\u540e\u76f4\u63a5\u9000\u51fa\u6574\u4e2a\u7a0b\u5e8f\u4e86..\npanic(\"goroutine panic\")\n}()\ntime.Sleep(3 * time.Second)\nfmt.Println(\"main running\") // \u4e0d\u4f1a\u6267\u884c\n}\n</code></pre> <pre><code>func TestPanic(t *testing.T) {\ndefer func() {\nfmt.Println(\"main end\")\n}()\ngo func() {\ndefer func() {\nfmt.Println(\"goroutine end\")\n// recover \u5904\u7406\u540e, main \u534f\u7a0b\u4f1a\u7ee7\u7eed\u6b63\u5e38\u6267\u884c\nif err := recover(); err != nil {\nfmt.Println(\"err:\", err)\n}\n}()\npanic(\"goroutine panic\")\n}()\ntime.Sleep(3 * time.Second)\nfmt.Println(\"main running\")\n}\n</code></pre>"},{"location":"go/basis/panic-recover/#_1","title":"\u5e95\u5c42\u539f\u7406","text":"<p>Danger</p> <p>TODO</p> <pre><code>func gopanic(e any) {\ngp := getg()  // \u83b7\u53d6\u5f53\u524d\u534f\u7a0b\n// ...\nfor {\nd := gp._defer\nif d == nil {\nbreak\n}\n// ...\nif p.recovered {\n// ...\n}\n}\n</code></pre>"},{"location":"go/basis/plan9/","title":"\u6c47\u7f16","text":"","tags":["Go"]},{"location":"go/basis/plan9/#_1","title":"\u67e5\u770b\u6c47\u7f16\u4ee3\u7801","text":"<p>\u91cd\u8981</p> <ul> <li>\u67e5\u770bgo\u5e95\u5c42\u6267\u884c\u7684\u4ee3\u7801\u65f6, \u53ef\u4ee5\u901a\u8fc7\u67e5\u770b\u6c47\u7f16\u6765\u627e\u5230\u6e90\u7801\u4f4d\u7f6e</li> <li>\u4e0b\u9762\u51e0\u4e2a\u67e5\u770b\u7684\u65b9\u5f0f,\u7ed3\u679c\u683c\u5f0f\u7565\u6709\u4e0d\u540c</li> </ul> \u65b9\u5f0f\u4e00<pre><code># -l \u7981\u6b62\u5185\u8054\u4f18\u5316\n# -N Disable optimizations.\n# \u7f16\u8bd1\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6 \u7981\u6b62\u5185\u8054\u4f18\u5316\ngo build -o main -gcflags \"-N -l\" main.go\n# -S Print assembly listing to standard output (code only).\n# \u7f16\u8bd1\u6210\u4e8c\u8fdb\u5236\u6587\u4ef6,\u5e76\u6253\u5370\u6c47\u7f16\u4ee3\u7801\ngo build -o main -gcflags=\"-N -l -S\" main.go\n\n# \u4ece\u53ef\u6267\u884c\u6587\u4ef6 \u53cd\u7f16\u8bd1\u51fa\u6c47\u7f16\u4ee3\u7801\n# \u8868\u793a\u53ea\u8f93\u51fa main \u5305\u4e2d\u76f8\u5173\u7684\u6c47\u7f16\ngo tool objdump -s \"main.\" main\n# \u5982\u679c\u4f7f\u7528 \"main.main\" \u5219\u8868\u793a \u53ea\u8f93\u51fa main.main\u65b9\u6cd5\u76f8\u5173\u7684\u6c47\u7f16\ngo tool objdump -s \"main.main\" main\n</code></pre> \u65b9\u5f0f\u4e8c<pre><code>#  \u4f1a\u751f\u6210main.o \u6587\u4ef6, -S \u8f93\u51fa\u6c47\u7f16\u4ee3\u7801\ngo tool compile -S -N -l main.go\n# \u76f4\u63a5\u770b\u4ee3\u7801\u7684\u7b2c\u51e0\u884c\u7684\u6c47\u7f16\u4ee3\u7801\ngo tool compile -S -N -l main.go |grep \"main.go:8\"\n</code></pre> \u65b9\u5f0f\u4e09<pre><code># dlv  disassemble\n# \u67e5\u770b\u6c47\u7f16\u4ee3\u7801\n(dlv) disassemble -l main.main\n</code></pre>","tags":["Go"]},{"location":"go/basis/plan9/#go","title":"\u6c47\u7f16\u5206\u6790go\u4ee3\u7801","text":"<p>Todo</p> <p>\u66f4\u8be6\u7ec6\u7684\u6c47\u7f16\u8bf4\u660e\u540e\u7eed\u4f1a\u4e13\u95e8\u5199\u6559\u7a0b,\u6709\u4e9b\u5f88\u591a\u90fd\u5fd8\u8bb0\u4e86...,\u5f97\u91cd\u65b0\u82b1\u65f6\u95f4\u518d\u770b\u770b</p>","tags":["Go"]},{"location":"go/basis/plan9/#_2","title":"\u51fd\u6570\u8c03\u7528\u4e3a\u5565\u4f7f\u7528\u6808","text":"<pre><code>package main\nfunc C() {\nprintln(4)\n}\nfunc B() {\nC()\nprintln(3)\n}\nfunc A() {\nB()\nprintln(2)\n}\nfunc main() {\nA()\nprintln(1)\n}\n</code></pre> <p>\u601d\u8003</p> <ol> <li>\u51fd\u6570\u7684\u6267\u884c\u662f\u540e\u6765\u7684\u5148\u6267\u884c,\u8fd9\u4e2a\u548c\u6808\u7684\u540e\u8fdb\u5148\u51fa\u7279\u5f81\u4e00\u81f4</li> <li>\u6267\u884c\u4e00\u4e2a\u51fd\u6570\u9700\u8981\u7684\u4e00\u4e9b\u5185\u5b58: \u53c2\u6570, \u8fd4\u56de\u503c, \u81ea\u5df1\u7684\u5c40\u90e8\u53d8\u91cf<ol> <li>\u53c2\u6570\u548c\u8fd4\u56de\u503c \u7531\u8c03\u7528\u8005\u5206\u914d (\u7406\u7531\u540e\u9762\u8bb2)</li> <li>\u5c40\u90e8\u53d8\u91cf\u6240\u5728\u7684\u5185\u5b58, \u5982\u679c\u5728\u51fd\u6570\u6267\u884c\u5b8c\u6bd5\u540e,\u6ca1\u6709\u7528\u4e86,\u90a3\u76f4\u63a5\u5728\u51fd\u6570\u6808\u4e0a\u5373\u53ef,\u8fd4\u56de\u65f6,\u5f39\u51fa,\u79fb\u52a8\u6808\u9876\u6307\u9488\u5373\u53ef,(\u5c31\u662f\u5185\u5b58\u91ca\u653e)</li> <li>\u5c40\u90e8\u53d8\u91cf\u6240\u5728\u7684\u5185\u5b58, \u5982\u679c\u5728\u51fd\u6570\u6267\u884c\u5b8c\u6bd5\u540e,\u8fd8\u8981\u7528\u5230,\u5c31\u4e0d\u80fd\u5728\u51fd\u6570\u6808\u4e0a\u5206\u914d\u4e86,\u5728\u5176\u4ed6\u5730\u65b9\u5206\u914d,\u7136\u540e\u8fd4\u56de\u503c\u8fd4\u56de\u5b83\u5730\u5740\u5373\u53ef</li> </ol> </li> <li>\u8fd9\u6837\u51fd\u6570\u81ea\u5df1\u5206\u914d\u7684\u6808\u7a7a\u95f4\u5728\u8c03\u7528\u5b8c\u6bd5\u540e\u53ef\u4ee5\u5b8c\u5168\u91ca\u653e\u4e86,\u7b26\u5408\u5165\u6808\u51fa\u6808, \u53ef\u4ee5\u7528\u6765\u7ba1\u7406\u51fd\u6570</li> <li>\u8fd8\u6709\u4e00\u70b9\u53ef\u4ee5\u5f97\u51fa,\u5c31\u662f\u5728\u6808\u4e0a\u5206\u914d\u5185\u5b58\u7684\u53d8\u91cf\u5b83\u7684\u5927\u5c0f\u662f\u5fc5\u987b\u786e\u5b9a\u7684<ol> <li>\u6bd4\u5982\u5b9a\u4e49\u4e00\u4e2a\u5c40\u90e8\u53d8\u91cf \u662f\u5b57\u7b26\u4e32, \u7136\u540e\u5728\u540e\u7eed\u4ee3\u7801\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d, \u5b57\u7b26\u4e32\u505a\u4e86\u589e\u52a0, \u8fd9\u8bf4\u660e\u4f60\u7684\u5b57\u7b26\u4e32\u5360\u7528\u7684\u5185\u5b58\u5927\u5c0f\u4e0d\u56fa\u5b9a,\u4f60\u80af\u5b9a\u4e0d\u80fd\u5c06\u5b83\u5b8c\u5168\u76f4\u63a5\u5206\u914d\u5728\u6808\u4e0a\u4e86</li> <li>\u6240\u4ee5\u8fd9\u7c7b\u578b\u7684\u53d8\u91cf,\u5fc5\u5b9a\u9700\u8981\u5728\u5176\u4ed6\u5730\u65b9\u5206\u914d (\u5806\u4e0a\u5206\u914d, \u6808\u4e0a\u5b58\u5b83\u7684\u6307\u9488,\u6307\u9488\u5927\u5c0f\u662f\u786e\u5b9a\u7684)</li> </ol> </li> </ol>","tags":["Go"]},{"location":"go/basis/plan9/#go_1","title":"\u8981\u5206\u6790\u7684go\u4ee3\u7801","text":"<pre><code>package main\nfunc add(c, d int64) (sum int64) {\nvar add_local_var int64 = 3\nsum = c + d + add_local_var\nreturn sum\n}\nfunc main() {\nvar r int64\nvar a, b int64 = 1, 2\nr = add(a, b)\nprintln(r)\n}\n</code></pre> <p>\u6ce8\u610f</p> <p>go \u7684\u7248\u672c\u4e0d\u4e00\u6837\u770b\u5230\u7684\u7ed3\u679c\u53ef\u80fd\u4e0d\u4e00\u6837</p> OS go version Ubuntu 20.04.3 LTS go1.20.4 <pre><code>go tool compile -S -N -l main.go\n</code></pre>","tags":["Go"]},{"location":"go/basis/plan9/#mainmain","title":"main.main","text":"item description caller \u8c03\u7528\u8005 callee \u88ab\u8c03\u7528\u8005 SP \u6808\u9876\u6307\u9488 <ul> <li>args: \u53c2\u6570+\u8fd4\u56de\u503c, main()\u7684\u8c03\u7528\u8005\u4f20\u9012\u7ed9main\u7684\u53c2\u6570,\u6ca1\u6709,\u663e\u793a 0</li> <li>locals: \u5305\u542b\u5982\u4e0b<ul> <li>main\u51fd\u6570\u672c\u5730\u4f7f\u7528\u7684\u5c40\u90e8\u53d8\u91cf</li> <li>\u8c03\u7528\u5176\u4ed6\u6240\u6709\u51fd\u6570\u65f6\u4f20\u9012\u7684\u53c2\u6570\u4ee5\u53ca\u5b83\u7684\u8fd4\u56de\u503c (=callee \u6240\u6709 args\u4e4b\u548c) ,\u53c2\u6570\u548c\u8fd4\u56de\u503c\u7531caller\u8d1f\u8d23\u5206\u914d</li> </ul> </li> </ul> <p>\u4e3a\u4ec0\u4e48callee\u7684\u53c2\u6570\u548c\u8fd4\u56de\u503c\u8981\u7531caller\u5206\u914d\u5185\u5b58\u5462?</p> <ul> <li>\u5982\u679c\u5728 callee \u6808\u4e2d\u5206\u914d, \u90a3\u4e48\u6bcf\u6b21\u8c03\u7528 callee \u90fd\u8981\u8fdb\u884c\u5185\u5b58\u5206\u914d\u548c\u91ca\u653e\u7684\u64cd\u4f5c,\u6bd4\u5982\u4f60\u5728 main\u51fd\u6570\u91cc\u591a\u6b21 \u8c03\u7528 add(),\u6bcf\u6b21\u8c03\u7528\u90fd\u8981\u5206\u914d\u4e00\u6b21\u5185\u5b58\u548c\u91ca\u653e</li> <li>\u5982\u679c\u5728 caller \u6808\u4e2d\u5206\u914d\u5185\u5b58\uff0ccaller \u8c03\u7528\u591a\u6b21 callee, \u4e5f\u53ea\u9700\u8981\u4e00\u6b21\u5185\u5b58\u5206\u914d\u64cd\u4f5c</li> <li>\u5c40\u90e8\u53d8\u91cf a\u548cb \u7533\u8bf7\u7684\u6808\u7a7a\u95f4\u76f4\u63a5\u4f5c\u4e3a add \u7684\u53c2\u6570(c ,d)\u4e0d\u884c\u5417?<ul> <li>\u5982\u679cadd \u91cc\u5bf9 \u53c2\u6570\u505a\u4fee\u6539, \u6c47\u7f16\u4ee3\u7801\u600e\u4e48\u5904\u7406?<ul> <li>\u76f4\u63a5\u4fee\u6539 caller\u7684a,b \u6240\u5728\u7684\u6808\u5185\u5b58\u5417? \u90a3\u80af\u5b9a\u4e0d\u884c</li> <li>\u5728 callee \u4e2d\u7533\u8bf7\u5185\u5b58? \u90a3\u53c8\u53d8\u6210\u591a\u6b21\u5206\u914d\u91ca\u653e\u7684\u95ee\u9898\u4e86,\u4e5f\u4e0d\u884c\u7684</li> </ul> </li> <li>\u5904\u7406\u65b9\u5f0f\u5c31\u662f\u5728 caller \u6808\u4e2d\u7533\u8bf7\u53c2\u6570 !  ==&gt;\u53ef\u4ee5\u8bf4\u660e\u51fd\u6570\u662f\u503c\u8f6c\u9012\u7684</li> </ul> </li> <li>\u8fd4\u56de\u503c\u7684\u989d\u5916\u7406\u7531<ul> <li>callee \u7684\u8fd4\u56de\u503c, \u80af\u5b9a\u662f caller \u9700\u8981\u7528\u5230,\u6240\u4ee5 \u5728caller\u76f4\u63a5\u7533\u8bf7\u5185\u5b58\u7a7a\u95f4\u5c31\u884c\u4e86,callee \u76f4\u63a5\u5c06\u7ed3\u679c\u5199\u5165caller\u7684\u51fd\u6570\u6808\u5185\u5b58\u5373\u53ef</li> <li>\u5982\u679c\u4f60callee\u7533\u8bf7 ,\u6700\u540e\u51fd\u6570\u8fd4\u56de\u4f1a\u91ca\u653e\u5185\u5b58, \u4f60\u53ef\u80fd\u8fd8\u9700\u8981\u5c06\u8fd4\u56de\u503c\u590d\u5236\u5230 caller \u7684\u51fd\u6570\u6808\u5185,\u8fd9\u6837\u4f1a\u5bfc\u81f4\u989d\u5916\u7684\u5185\u5b58\u62f7\u8d1d\u64cd\u4f5c</li> </ul> </li> </ul> <pre><code>main.main STEXT size=109 args=0x0 locals=0x30 funcid=0x0 align=0x0\n</code></pre> <p>SB  \u4f2a\u5bc4\u5b58\u5668\uff0c\u4fdd\u5b58\u9759\u6001\u57fa\u5730\u5740(static-base) \u6307\u9488\uff0c\u5373\u6211\u4eec\u7a0b\u5e8f\u5730\u5740\u7a7a\u95f4\u7684\u5f00\u59cb\u5730\u5740 <pre><code>    0x0000 00000 (main.go:9)    TEXT    main.main(SB), ABIInternal, $48-0\n    0x0000 00000 (main.go:9)    CMPQ    SP, 16(R14)\n# PCDATA  \u5783\u573e\u56de\u6536\u76f8\u5173, \u7531go \u7f16\u8bd1\u5668\u52a0\u5165\n0x0004 00004 (main.go:9)    PCDATA  $0, $-2\n0x0004 00004 (main.go:9)    JLS 102\n0x0006 00006 (main.go:9)    PCDATA  $0, $-1\n</code></pre></p> <p>main \u7533\u8bf7\u768448\u4e2a\u5b57\u8282</p> <ul> <li><code>SUBQ $48, SP</code>  SP=SP-48 ,\u6808\u9876\u6307\u9488\u5f80\u4e0b\u79fb\u52a848\u4e2a\u5b57\u8282, \u5c31\u662fmain\u51fd\u6570 \u7533\u8bf7 48\u4e2a\u5b57\u8282\u7684\u6808\u7a7a\u95f4</li> <li>main\u7684\u5c40\u90e8\u53d8\u91cf a b \u517116\u4e2a\u5b57\u8282</li> <li>\u8c03\u7528add ,\u9700\u8981 \u4f20\u9012\u7684\u53c2\u6570 16\u4e2a\u5b57\u8282, r \u63a5\u6536add\u8fd4\u56de\u503c \u53608\u4e2a\u5b57\u8282  \u5171 24\u4e2a\u5b57\u8282 \u90fd\u7531caller(\u5373main) \u5206\u914d</li> <li>\u4fdd\u5b58BP  \u53608\u4e2a\u5b57\u8282</li> <li>\u8c03\u7528println()  \u4f20\u53c2 \u76f4\u63a5\u4f7f\u7528\u7684r,\u6211\u4f30\u8ba1\u662f\u7f16\u8bd1\u5668\u660e\u786e\u77e5\u9053println \u4e0d\u4f1a\u4fee\u6539\u53c2\u6570\u7684\u539f\u56e0?</li> </ul> <pre><code>    0x0006 00006 (main.go:9)    SUBQ    $48, SP\n    # BP \u4f2a\u5bc4\u5b58\u5668, \u8c03\u7528\u8005(\u8fd9\u91cc\u5c31\u662fmain\u7684\u8c03\u7528\u8005)\u51fd\u6570\u6808\u7684\u8d77\u59cb\u4f4d\u7f6e \u4ec5\u4f5c\u4e3a\u4e00\u4e2a\u6307\u793a\u4f5c\u7528\n# \u4fdd\u5b58BP \u4f2a\u5bc4\u5b58\u5668 \u5230\u6808 SP+40 \u7684\u4f4d\u7f6e\n0x000a 00010 (main.go:9)    MOVQ    BP, 40(SP)\n# \u5c06 SP+40 \u8fd9\u4e2a\u5730\u5740 (\u6808\u5730\u5740)  \u8bbe\u7f6e\u7ed9 BP\u5bc4\u5b58\u5668\n# \u73b0\u5728 BP\u5bc4\u5b58\u5668\u6307\u5411\u7684\u6808\u5185\u5b58 \u5b58\u50a8\u7684\u662f \u539f\u6765BP\u7684\u503c\n0x000f 00015 (main.go:9)    LEAQ    40(SP), BP\n    # FUNCDATA  \u5783\u573e\u56de\u6536\u76f8\u5173, \u7531go \u7f16\u8bd1\u5668\u52a0\u5165\n0x0014 00020 (main.go:9)    FUNCDATA    $0, gclocals\u00b7g2BeySu+wFnoycgXfElmcg==(SB)\n0x0014 00020 (main.go:9)    FUNCDATA    $1, gclocals\u00b7g2BeySu+wFnoycgXfElmcg==(SB)\n</code></pre> <ul> <li>\u5c06 SP+16 \u7684\u6808\u5185\u5b58 \u8bbe\u7f6e \u7acb\u5373\u6570 0 ==&gt; r\u53d8\u91cf</li> <li>\u5c06 SP+24 \u7684\u6808\u5185\u5b58 \u8bbe\u7f6e \u7acb\u5373\u6570 2 ==&gt; b\u53d8\u91cf</li> <li>\u5c06 SP+32 \u7684\u6808\u5185\u5b58 \u8bbe\u7f6e \u7acb\u5373\u6570 1 ==&gt; a\u53d8\u91cf</li> <li>\u5c06 \u7acb\u5373\u6570 1 \u8bbe\u7f6e\u5230 \u5bc4\u5b58\u5668 AX</li> <li>\u5c06 \u7acb\u5373\u6570 2 \u8bbe\u7f6e\u5230 \u5bc4\u5b58\u5668 BX</li> </ul> <pre><code>    0x0014 00020 (main.go:10)   MOVQ    $0, main.r+16(SP)\n0x001d 00029 (main.go:11)   MOVQ    $1, main.a+32(SP)\n0x0026 00038 (main.go:11)   MOVQ    $2, main.b+24(SP)\n0x002f 00047 (main.go:12)   MOVL    $1, AX\n    0x0034 00052 (main.go:12)   MOVL    $2, BX\n    0x0039 00057 (main.go:12)   PCDATA  $1, $0\n</code></pre> <ul> <li>\u8c03\u7528 add \u51fd\u6570, \u53bb\u770bmain.add</li> <li>CALL \u6307\u4ee4<ul> <li>\u5c06ip \u538b\u6808 \u5c31\u662f\u5c06\u4e0b\u4e00\u6761\u6307\u4ee4(\u8c03\u7528\u51fd\u6570\u540e\u7684\u4e0b\u4e00\u4e2a\u8981\u6267\u884c\u7684\u6307\u4ee4)\u7684\u5730\u5740 \u538b\u6808</li> <li>\u538b\u6808: \u5148\u5c06\u6808\u9876\u6307\u9488\u4e0b\u79fb, SP=SP-8 (\u5185\u5b58\u5730\u5740\u53608\u4e2a\u5b57\u8282), \u7136\u540e\u5c06ip\u8bbe\u7f6e\u5230SP\u6307\u5411\u7684\u6808\u4e0a</li> <li>\u8c03\u7528\u7684add \u51fd\u6570 \u6700\u540e\u4f1a\u6709\u4e00\u4e2aRET \u64cd\u4f5c, \u662f\u5f39\u6808. (call \u548c ret)</li> </ul> </li> </ul> <p><pre><code>    0x0039 00057 (main.go:12)   CALL    main.add(SB)\n</code></pre> </p> <p>CALL \u7684add \u6700\u540e\u7684RET\u540e, SP\u53c8\u91cd\u65b0\u53d8\u6210\u4e00\u5f00\u59cb\u7684 SP-48\u7684\u4f4d\u7f6e\u4e86. \u5c06AX\u5bc4\u5b58\u5668\u91cc\u7684\u503c\u8bbe\u7f6e\u5230 r\u7684\u6808\u5185\u5b58\u4f4d\u7f6e</p> <p><pre><code>    0x003e 00062 (main.go:12)   MOVQ    AX, main.r+16(SP)\n</code></pre> </p> <p><pre><code>    0x0043 00067 (main.go:13)   CALL    runtime.printlock(SB)\n0x0048 00072 (main.go:13)   MOVQ    main.r+16(SP), AX\n    0x004d 00077 (main.go:13)   CALL    runtime.printint(SB)\n0x0052 00082 (main.go:13)   CALL    runtime.printnl(SB)\n0x0057 00087 (main.go:13)   CALL    runtime.printunlock(SB)\n</code></pre> \u590d\u539fBP,SP <pre><code>    0x005c 00092 (main.go:14)   MOVQ    40(SP), BP\n    0x0061 00097 (main.go:14)   ADDQ    $48, SP\n    0x0065 00101 (main.go:14)   RET\n</code></pre></p>","tags":["Go"]},{"location":"go/basis/plan9/#mainadd","title":"main.add","text":"<ul> <li>args = 0x10=16, \u4f7f\u7528\u4e86caller\u7684\u6808\u5185\u5b58 (\u53c2\u6570+\u8fd4\u56de\u503c)</li> <li>$24-16<ul> <li>24\u8868\u793aadd \u7533\u8bf7\u7684\u6808\u5185\u5b58\u7a7a\u95f4, </li> <li>16\u8868\u793a \u7528\u5230\u4e86 caller\u7684\u6808\u5185\u5b58\u7a7a\u95f4\u5927\u5c0f = args</li> <li> \u4f60\u53ef\u80fd\u4f1a\u89c9\u5f97 \u4e0d\u5e94\u8be5\u662f \u53c2\u6570+\u8fd4\u56de\u503c= 24\u4e2a\u5b57\u8282\u5417?? \u600e\u4e48\u662f16,\u540e\u9762\u8bf4 </li> </ul> </li> </ul> <pre><code>main.add STEXT nosplit size=63 args=0x10 locals=0x18 funcid=0x0 align=0x0\n    0x0000 00000 (main.go:3)    TEXT    main.add(SB), NOSPLIT|ABIInternal, $24-16\n</code></pre> <ul> <li>BP+\u5c40\u90e8\u53d8\u91cf(sum+add_local_var) \u517124\u4e2a\u5b57\u8282?</li> <li> \u4f60\u53ef\u80fd\u53c8\u4f1a\u89c9\u5f97 \u8fd9\u4e2asum \u4e0d\u5c31\u662f main\u6808\u7a7a\u95f4\u7684r\u5417? \u4e0d\u76f4\u63a5\u4f7f\u7528\u5b83\u800c\u5728add\u6808\u5185\u5206\u914d\u4e86\u5185\u5b58\u5462? \u540e\u9762\u89e3\u7b54</li> </ul> <pre><code>    0x0000 00000 (main.go:3)    SUBQ    $24, SP\n    0x0004 00004 (main.go:3)    MOVQ    BP, 16(SP)\n0x0009 00009 (main.go:3)    LEAQ    16(SP), BP\n    0x000e 00014 (main.go:3)    FUNCDATA    $0, gclocals\u00b7g2BeySu+wFnoycgXfElmcg==(SB)\n0x000e 00014 (main.go:3)    FUNCDATA    $1, gclocals\u00b7g2BeySu+wFnoycgXfElmcg==(SB)\n0x000e 00014 (main.go:3)    FUNCDATA    $5, main.add.arginfo1(SB)\n</code></pre> <ol> <li>\u5c06AX( \u5373 1) \u8bbe\u7f6e\u5230 SP+32 =SP+24(add\u7533\u8bf7\u7684\u6808\u7a7a\u95f4)+8(call add \u538b\u6808) \u8fd9\u4e2a\u4f4d\u7f6e\u5c31\u662f main\u4e00\u5f00\u59cb\u7533\u8bf7\u6808\u5185\u5b58\u540e\u7684 sp\u7684\u4f4d\u7f6e, \u53c2\u6570c</li> <li>\u5c06BX( \u5373 2) \u53c2\u6570d</li> </ol> <pre><code>    0x000e 00014 (main.go:3)    MOVQ    AX, main.c+32(SP)\n0x0013 00019 (main.go:3)    MOVQ    BX, main.d+40(SP)\n</code></pre> <ul> <li>\u521d\u59cb\u5316 sum\u53d8\u91cf\u8bbe\u7f6e\u4e3a0</li> <li>\u8bbe\u7f6e \u5c40\u90e8\u53d8\u91cf add_local_var =3</li> </ul> <pre><code>    0x0018 00024 (main.go:3)    MOVQ    $0, main.sum(SP)\n0x0020 00032 (main.go:4)    MOVQ    $3, main.add_local_var+8(SP)\n</code></pre> <ul> <li>\u8ba1\u7b97\u540e\u5c06\u7ed3\u679c\u8bbe\u7f6e\u5230AX \u4ee5\u53casum\u53d8\u91cf,\u6211\u4eec\u53d1\u73b0\u8fd9\u91cc\u5e76\u6ca1\u6709\u64cd\u4f5cmain\u7684\u6808\u5185\u5b58\u5206\u914d\u7684\u8fd4\u56de\u503cr</li> <li>\u6240\u4ee5 $24-16 \u5199\u7684\u662f16</li> </ul> <p>$24-16\u7684\u95ee\u9898, \u77e5\u9053\u5373\u53ef,\u65e0\u9700\u592a\u8fc7\u5728\u610f</p> <ul> <li>\u6211\u5728\u770b\u7b14\u8bb0\u7684\u65f6\u5019,\u53d1\u73b0\u4ee5\u524d\u7684\u663e\u793a\u7684args\u662f24, \u4ee5\u524d\u7684\u770b\u8d77\u6765\u7b26\u5408\u6211\u4eec\u524d\u9762\u8bf4\u7684.</li> <li>\u4e3a\u4ec0\u4e48\u4e0d\u4e00\u6837 \u6211\u4f30\u8ba1\u662fgo \u7248\u672c\u7684\u95ee\u9898, \u4e0b\u9762\u662f\u6211\u8bd5\u4e86\u51e0\u4e2ago\u7248\u672c\u540e,\u4e00\u4e2a\u7b26\u5408\u7684 go1.15.4\u7248\u672c\u7684\u6c47\u7f16\u60c5\u51b5<pre><code>\"\".add STEXT nosplit size=60 args=0x18 locals=0x10\n0x0000 00000 (main.go:3)    TEXT    \"\".add(SB), NOSPLIT|ABIInternal, $16-24\n0x0000 00000 (main.go:3)    SUBQ    $16, SP\n0x0004 00004 (main.go:3)    MOVQ    BP, 8(SP)\n0x0009 00009 (main.go:3)    LEAQ    8(SP), BP\n0x000e 00014 (main.go:3)    FUNCDATA    $0, gclocals\u00b733cdeccccebe80329f1fdbee7f5874cb(SB)\n0x000e 00014 (main.go:3)    FUNCDATA    $1, gclocals\u00b733cdeccccebe80329f1fdbee7f5874cb(SB)\n0x000e 00014 (main.go:3)    MOVQ    $0, \"\".sum+40(SP)\n0x0017 00023 (main.go:4)    MOVQ    $3, \"\".add_local_var(SP)\n0x001f 00031 (main.go:5)    MOVQ    \"\".c+24(SP), AX\n0x0024 00036 (main.go:5)    ADDQ    \"\".d+32(SP), AX\n0x0029 00041 (main.go:5)    ADDQ    $3, AX\n0x002d 00045 (main.go:5)    MOVQ    AX, \"\".sum+40(SP)\n0x0032 00050 (main.go:6)    MOVQ    8(SP), BP\n0x0037 00055 (main.go:6)    ADDQ    $16, SP\n0x003b 00059 (main.go:6)    RET\n</code></pre> \u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 8\u884c\u548c13\u884c, add\u51fd\u6570\u662f\u76f4\u63a5\u4f7f\u7528main\u7684\u6808\u5185\u5b58\u4f5c\u4e3asum\u7684,\u6240\u4ee5add\u5b83\u7533\u8bf7\u7684\u6808\u5185\u5b58\u53ea\u670916,\u800c\u4f7f\u7528\u7684caller\u7684\u6808\u5185\u5b58\u662f24\u4e2a\u5b57\u8282</li> </ul> <pre><code>    0x0029 00041 (main.go:5)    LEAQ    (AX)(BX*1), AX\n    0x002d 00045 (main.go:5)    LEAQ    3(AX), AX\n    0x0031 00049 (main.go:5)    MOVQ    AX, main.sum(SP)\n</code></pre> <p></p> <p>BP\u548cSP\u5f52\u4f4d <pre><code>    0x0035 00053 (main.go:6)    MOVQ    16(SP), BP\n    0x003a 00058 (main.go:6)    ADDQ    $24, SP\n</code></pre></p> <ul> <li>RET<ul> <li>=POP IP, \u5c06\u4e4b\u524dmain call add\u7684\u65f6\u5019 \u538b\u6808\u7684ip,\u5f39\u51fa \u5199\u5165\u5230 ip\u5bc4\u5b58\u5668,\u8fd9\u6837 cpu\u5c31\u77e5\u9053\u91cd\u65b0\u6267\u884c\u54ea\u4e00\u6761\u6307\u4ee4\u4e86</li> <li>\u5148\u8bfb\u53d6\u6808\u6570\u636e \u5199\u5165ip\u5bc4\u5b58\u5668, \u7136\u540e SP=SP+8 \u5f80\u4e0a\u79fb\u52a8, \u8fd9\u6837\u5c31\u56de\u5230\u4e86 call add \u4e4b\u524d\u7684 sp\u4f4d\u7f6e\u4e86.</li> </ul> </li> </ul> <pre><code>    0x003e 00062 (main.go:6)    RET\n</code></pre>","tags":["Go"]},{"location":"go/basis/plan9/#go_2","title":"go\u8c03\u7528\u6c47\u7f16\u4ee3\u7801\u5199\u7684\u51fd\u6570","text":"<ol> <li> <p>tool compile \u21a9</p> </li> </ol>","tags":["Go"]},{"location":"go/basis/pragma-directives/","title":"\u7f16\u8bd1\u6307\u793a","text":"<p>Tip</p> <ul> <li>\u7f16\u8bd1\u6307\u793a\u4e00\u79cd\u8bed\u8a00\u7ed3\u6784,\u5b83\u6307\u793a\u7f16\u8bd1\u5668\u5e94\u8be5\u5982\u4f55\u5904\u7406\u5176\u8f93\u5165</li> <li>go\u4e2d\u8fd9\u6837\u7684\u6ce8\u91ca <code>//go:</code>(\u6ce8\u91ca//\u4e0ego\u6ca1\u6709\u7a7a\u683c) \u5c31\u662f Go \u8bed\u8a00\u7f16\u8bd1\u6307\u793a\u7684\u5b9e\u73b0\u65b9\u5f0f</li> </ul>"},{"location":"go/basis/pragma-directives/#gonoinline","title":"//go:noinline","text":"<p>\u4ec0\u4e48\u662finline\u5185\u8054\u4f18\u5316?</p> <ul> <li>\u51fd\u6570\u8c03\u7528\u9700\u8981\u5c06\u76f8\u5173\u5bc4\u5b58\u5668\u4e2d\u7684\u6570\u636e\u5165\u6808\u6765\u4fdd\u5b58\u73b0\u573a,\u51fd\u6570\u8c03\u7528\u5b8c\u6bd5\u53c8\u9700\u8981\u5f39\u6808\u6765\u6062\u590d\u73b0\u573a,\u9891\u7e41\u7684\u8fd9\u6837\u6d88\u8017\u65f6\u95f4,\u5f71\u54cd\u6267\u884c\u6548\u7387</li> <li>\u5185\u8054\u5c31\u662f\u5c06\u8c03\u7528\u7684\u51fd\u6570\u76f4\u63a5\u590d\u5236\u5230\u8c03\u7528\u5904.\u8fd9\u6837\u5c31\u4e0d\u7528\u9891\u7e41\u5165\u6808\u51fa\u6808,\u51cf\u5c11\u4e86\u5f00\u9500,\u6267\u884c\u901f\u5ea6\u5feb\u4e86.</li> <li>\u5185\u8054\u7684\u95ee\u9898<ul> <li>\u589e\u52a0\u4e86\u4ee3\u7801\u7684\u91cd\u590d</li> <li>\u5982\u679c\u51fd\u6570\u88ab\u5f88\u591a\u5f88\u591a\u5176\u4ed6\u5730\u65b9\u8c03\u7528,\u90fd\u5185\u8054\u4f18\u5316\u4e86,\u5982\u679c\u672c\u6765\u4e00\u4e2a\u5730\u65b9\u88ab\u7f13\u5b58,\u8bfb\u53d6\u6307\u4ee4\u5feb,\u73b0\u5728\u53ef\u80fd\u7f13\u5b58\u6ca1\u6709\u547d\u4e2d,\u5f97\u91cd\u65b0\u8bfb\u53d6\u518d\u7f13\u5b58,\u6162\u4e86</li> </ul> </li> </ul> \u5185\u8054\u4f18\u5316\u5bf9\u6bd4<pre><code>func show(){\nfmt.Println(\"hello\")\n}\nfunc test(){\nshow()\n}\n// ==&gt; \u5185\u8054\u4f18\u5316\u540e\nfunc show(){\nfmt.Println(\"hello\")\n}\nfunc test(){\n// \u76f4\u63a5\u590d\u5236\u5230\u8c03\u7528\u5904\nfmt.Println(\"hello\")\n}\n</code></pre> <p>Tip</p> <ul> <li><code>//go:noinline</code> \u987e\u540d\u601d\u4e49\u5c31\u662f\u7981\u6b62\u5185\u8054\u4f18\u5316,\u901a\u5e38\u6211\u4eec\u9700\u8981\u8c03\u5f0f\u7684\u65f6\u5019\u7528</li> <li>\u540e\u9762\u5fc5\u987b\u8ddf\u7740 func \u7684\u7533\u660e</li> </ul> <pre><code>package main\n// \u54ea\u4e2afunc \u4e0d\u60f3\u88ab\u5185\u8054\u4f18\u5316, \u5c31\u5728\u54ea\u4e2a\u4e0a\u9762\u5199\n//go:noinline\nfunc p() {\nprintln(2)\n}\nfunc main() {\na := 1\nprintln(a)\np()\n}\n</code></pre> <pre><code># \u4ee3\u7801\u4e2d \u5199\u4e86 \u7981\u6b62\u5185\u8054, \u67e5\u770b\u6c47\u7f16\u5c31\u53ef\u4ee5\u4e0d\u9700\u8981 -l\ngo tool compile -S  main.go |grep \"main.go:11\"\n</code></pre>"},{"location":"go/basis/pragma-directives/#golinkname","title":"//go:linkname","text":"<p>Tip</p> <ul> <li>\u5f53\u4f60\u60f3\u8981\u4f7f\u7528\u522b\u7684\u5305(\u81ea\u5df1\u5199\u7684\u5305\u6216\u8005go\u6e90\u7801\u7684\u5305\u90fd\u884c)\u6ca1\u6709\u5bfc\u51fa(\u79c1\u6709)\u7684\u53d8\u91cf\u548c\u65b9\u6cd5\u65f6</li> <li><code>//go:linkname localname [importpath.name]</code></li> <li>\u8c03\u8bd5\u4ee3\u7801\u65f6\u53ef\u80fd\u4f1a\u7528\u5230\u8fd9\u7c7b\u6280\u672f</li> </ul> <ul> <li>\u4f7f\u7528go\u6e90\u7801\u4e2d\u7684\u5305</li> </ul> <p>runtime.inheap \u8fd9\u4e2a\u65b9\u6cd5\u6b63\u5e38\u60c5\u51b5\u4e0b\u6211\u4eec\u662f\u6ca1\u6cd5\u8c03\u7528\u7684</p> <pre><code>package main\nimport (\n//  \u5982\u679c\u6ca1\u6709\u4f7f\u7528  \u4e5f\u9700\u8981import \n// _ \"unsafe\"\n\"unsafe\"\n)\n// \u8868\u793a inheap \u7684\u771f\u6b63\u5b9e\u73b0\u662f runtime.inheap\n//\n//go:linkname inheap runtime.inheap\nfunc inheap(arg uintptr) bool  // \u65b9\u6cd5\u7533\u660e,\u53bb\u770b runtime.inheap \u590d\u5236\u8fc7\u6765\nfunc main() {\nvar a int = 1\n// false \u8868\u793a\u5728\u6808\u4e0a\nprintln(inheap(uintptr(unsafe.Pointer(&amp;a))))\n}\n</code></pre> <ul> <li>\u81ea\u5df1\u7684\u5305\u4e2d\u7684\u79c1\u6709\u65b9\u6cd5</li> </ul> \u4ee3\u7801\u76ee\u5f55show.gomain.go <pre><code>.\n\u251c\u2500\u2500 go.mod  # mod name  \u662ftest\n\u251c\u2500\u2500 main.go\n\u251c\u2500\u2500 pkg\n\u2502   \u2514\u2500\u2500 show.go\n</code></pre> <pre><code>package pkg\nimport \"fmt\"\nfunc s() {\nfmt.Println(11)\n}\n</code></pre> main.go<pre><code>package main\nimport (\n_ \"test/pkg\"\n_ \"unsafe\"\n)\nfunc main() {\nshow()\n}\n// \u771f\u6b63\u5b9e\u73b0\u662ftest/pkg.s \u51fd\u6570\n//\n//go:linkname show test/pkg.s\nfunc show()\n</code></pre>"},{"location":"go/basis/quick-start/","title":"\u5feb\u901f\u5165\u95e8","text":"<p>Tip</p> <p>TODO</p>"},{"location":"go/basis/quick-start/#_1","title":"\u57fa\u672c\u6570\u636e\u7c7b\u578b","text":"\u5e38\u91cf\u751f\u6210\u5668iota <pre><code>// \u6bcf\u5f53\u9047\u5230const, \u5c31\u4f1a\u91cd\u7f6e\u4e3a0\nconst c1 = iota // 0\nconst (\n// const() \u4e2d\u6bcf\u589e\u52a0\u4e00\u884c\u58f0\u660e\u5c31\u4f1a\u5c06iota\u8ba1\u6570 +1\na  = \"hello\" // hello\nb            // hello\nc  = 9\nd         // 9  \u4f7f\u7528\u4e0e\u5b83\u6700\u8fd1\u7684\u8868\u8fbe\u5f0f \u8fd9\u91cc\u662f\u4e0a\u9762\u7684 9\ne         // 9\na1 = iota // 5  \u524d\u9762a \u90a3\u91cc\u662f0\na2        //6\n_         //7\na4        //8\nb1 = iota //9\nb2        // 10\n)\nconst (\nd1 = iota * 2 // 0\nd2            //2\nd3 = iota * 3 // 6\nd4            //9  \u4f7f\u7528\u6700\u8fd1\u7684 \u8868\u8fbe\u5f0f iota*3\n)\nconst (\ne1 = 1 &lt;&lt; iota //1\ne2             //2  \u5de6\u79fb iota=1 \u4f4d\ne3             //4  \u5de6\u79fb iota=2 \u4f4d\n)\n</code></pre>"},{"location":"go/basis/quick-start/#struct","title":"\u7a7a\u7ed3\u6784\u4f53struct{}","text":"<p>Important</p> <p>\u4e0d\u5360\u7528\u5185\u5b58, \u7ecf\u5e38\u7528, \u7528\u6765\u8282\u7ea6\u5185\u5b58</p> <pre><code>package main\nimport (\n\"fmt\"\n\"unsafe\"\n)\nfunc main() {\na := struct{}{}\nb := struct{}{}\nfmt.Println(unsafe.Sizeof(a), unsafe.Sizeof(b)) //0\n// \u76f8\u540c\nfmt.Printf(\"%p,%p\\n\", &amp;a, &amp;b)\nd := uintptr(unsafe.Pointer(&amp;a))\nfmt.Println(d)\ncat := Cat{\nName:   \"abc\",\nAg:     struct{}{},\nAge:    11,\nWeight: 110,\n}\n// \u6211\u4eec\u53d1\u73b0 \u7ed3\u679c\u662f32 , \u5728\u7ed3\u6784\u4f53\u91cc\u6210\u5458\u7c7b\u578b\u662f\u7a7a struct{} ,\u4e5f\u662f\u4e0d\u5360\u7528\u7a7a\u95f4\u7684\nfmt.Println(unsafe.Sizeof(cat))\n// \u4f46\u662f \u548c\u4e0a\u9762\u7684 a, b \u7684 \u7a7a\u7ed3\u6784\u4f53\u5730\u5740\u4e0d\u4e00\u6837.\n// &amp;cat.Ag, &amp;cat.Age \u5730\u5740\u4e00\u6837\nfmt.Printf(\"%p,%p,%p,%p\\n\", &amp;cat.Name, &amp;cat.Ag, &amp;cat.Age, &amp;cat.Weight)\ndog := Dog{\nAg:     struct{}{},\nName:   \"abc\",\nAge:    11,\nWeight: 110,\n}\nfmt.Println(unsafe.Sizeof(dog)) // 32 \u4e0d\u5360\u7528\u7a7a\u95f4\n// &amp;dog.Ag, &amp;dog.Name \u5730\u5740\u4e00\u6837\nfmt.Printf(\"%p,%p,%p,%p\\n\", &amp;dog.Ag, &amp;dog.Name, &amp;dog.Age, &amp;dog.Weight)\n// \u653e\u5728\u7ed3\u6784\u4f53\u6700\u540e\nh1 := struct {\nb byte\ns struct{}\n}{}\nfmt.Printf(\"%p,%p\\n\", &amp;h1.b, &amp;h1.s)\n// 2 \u4e2a\u5b57\u8282, \u4e5f\u5c31\u662f\u8bf4\u586b\u5145\u4e86\u4e00\u4e2a\u5b57\u8282\n// \u8bd5\u7740 \u5c06 b \u5f04\u6210 int16 int32 int64 \u770b\u770b\nfmt.Println(unsafe.Sizeof(h1))\n}\ntype Cat struct {\nName   string //16 byte\nAg     struct{}\nAge    int64 // 8\nWeight int64 // 8\n}\ntype Dog struct {\nAg     struct{}\nName   string //16 byte\nAge    int64  // 8\nWeight int64  // 8\n}\n</code></pre> \u5e95\u5c42\u539f\u7406<pre><code>func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {\n// ....\nif size == 0 {\n// \u7edf\u4e00\u8fd4\u56de\u5168\u5c40\u53d8\u91cf zerobase \u7684\u5730\u5740\nreturn unsafe.Pointer(&amp;zerobase)\n}\n}\n// base address for all 0-byte allocations\nvar zerobase uintptr\n</code></pre> dlv\u8c03\u8bd5\u770b\u770b<pre><code>b main.main\nc\nb 16\nc\np d\np uintptr(&amp;runtime.zerobase) # \u4e0e\u4e0a\u9762\u503c\u4e00\u6837\n</code></pre>"},{"location":"go/basis/quick-start/#nil","title":"nil","text":"<p>Tip</p> <p>nil \u662f\u4e00\u4e2a\u53d8\u91cf?</p> \u6e90\u7801\u4e2d,\u8bf7\u770b\u770b\u6ce8\u91ca<pre><code>// nil is zero value for a pointer, channel, func, interface, map, or slice type.\n// Type must be a pointer, channel, func, interface, map, or slice type\nvar nil Type\n</code></pre>"},{"location":"go/basis/quick-start/#make-new","title":"make &amp;&amp; new","text":"<pre><code>// \u53ea\u7528\u6765\u521b\u5efaslice\uff0cmap\u548cchannel\nfunc make(t Type, size ...IntegerType) Type\n// \u8fd4\u56de\u7684\u662f\u6307\u9488, \u6307\u9488\u6307\u5411\u7684\u5730\u5740\u53ef\u80fd\u5728\u6808\u4e0a\u4e5f\u53ef\u80fd\u5728\u5806\u4e0a\nfunc new(Type) *Type\n</code></pre>"},{"location":"go/basis/quick-start/#_2","title":"\u9003\u9038\u5206\u6790","text":"<pre><code>package main\nimport (\n\"unsafe\"\n)\n//go:linkname inheap runtime.inheap\nfunc inheap(arg uintptr) bool\nfunc main() {\nvar a int = 1\n// false \u8868\u793a\u5728\u6808\u4e0a\nprintln(inheap(uintptr(unsafe.Pointer(&amp;a))))\n}\n</code></pre>"},{"location":"go/basis/reflect/","title":"\u53cd\u5c04","text":"<p>Tip</p> <p>\u5efa\u8bae\u5148\u770b\u4e0b\u63a5\u53e3\u7ae0\u8282</p>"},{"location":"go/basis/reflect/#_1","title":"\u5143\u6570\u636e","text":"<p>\u4ec0\u4e48\u662f\u5143\u6570\u636e?</p> <p>\u662f\u63cf\u8ff0\u6570\u636e\u7684\u6570\u636e \u6bd4\u5982\u4e00\u4e2a\u7ed3\u6784\u4f53\u5bf9\u8c61\u662f\u4e2a\u6570\u636e, \u5b83\u662f\u4ec0\u4e48\u7c7b\u578b,\u8fd9\u4e2a\u7c7b\u578b\u5c31\u662f\u7528\u6765\u63cf\u8ff0\u8fd9\u4e2a\u5b83\u81ea\u5df1\u7684\u4e00\u79cd\u6570\u636e \u8fd9\u4e2a\u7ed3\u6784\u4f53\u5bf9\u8c61\u7684\u503c,\u6bd4\u5982 Dog{Name:\"tom\"} tom \u8fd9\u79cd\u5c31\u662f\u5b83\u7684\u503c, \u5b83\u663e\u7136\u4e5f\u662f\u63cf\u8ff0\u8be5\u7ed3\u6784\u4f53\u7684\u4e00\u79cd\u6570\u636e \u6211\u4eec\u53ea\u8981\u6709\u4e86\u4e00\u4e2a\u6570\u636e\u7684\u7c7b\u578b\u548c\u503c, \u90a3\u4e48\u6211\u4eec\u5c31\u77e5\u9053\u4e86\u8be5\u6570\u636e\u7684\u5168\u90e8\u4fe1\u606f</p>"},{"location":"go/basis/reflect/#_2","title":"\u4e09\u5b9a\u5f8b","text":""},{"location":"go/basis/reflect/#_3","title":"\u63a5\u53e3\u7c7b\u578b\u53d8\u91cf\u8f6c\u6362\u4e3a\u53cd\u5c04\u5bf9\u8c61","text":""},{"location":"go/basis/reflect/#reflecttype","title":"\u7c7b\u578b reflect.Type","text":"<p>Tip</p> <ul> <li>\u662f\u63a5\u53e3,\u7528\u4e8e\u83b7\u53d6\u5143\u6570\u636e : \"\u7c7b\u578b\"\u4fe1\u606f</li> <li>reflect.TypeOf() \u5bf9\u8c61\u8f6c\u6362\u4e3aType\u63a5\u53e3\u7684\u65b9\u6cd5</li> </ul> <p></p> TypeOf()\u7ed3\u6784\u4f53\u548c\u7ed3\u6784\u4f53\u6307\u9488\u7684\u53cd\u5c04 <p>\u91cd\u8981</p> <ul> <li>\u4ece\u6e90\u7801\u770b, \u521a\u597d\u548c\u6211\u4eec\u4e4b\u524d\u8bb2\u5230\u7684\u63a5\u53e3\u4e0e\u5143\u6570\u636e\u5c06\u53d8\u91cf\u8f6c\u4e3a\u63a5\u53e3\u7c7b\u578b,\u5c31\u53ef\u4ee5\u83b7\u53d6\u5b83\u7684\u5143\u6570\u636e\u7684\u63a8\u65ad\u4e00\u81f4</li> <li>\u540e\u9762\u6bd4\u5982<code>.Field(0)</code> \u8fd9\u7c7b\u64cd\u4f5c\u7684\u5e95\u5c42\u4e0e \u63a5\u53e3\u7ae0\u8282\u7684\u4ee3\u7801\u9a8c\u8bc1\u7ed3\u6784 \u539f\u7406\u4e00\u81f4</li> </ul> <pre><code>func TypeOf(i any) Type {\neface := *(*emptyInterface)(unsafe.Pointer(&amp;i))\nreturn toType(eface.typ)\n}\n</code></pre> <pre><code>package test\nimport (\n\"fmt\"\n\"reflect\"\n\"testing\"\n)\ntype Dog struct {\nAge  int\nname string\n}\nfunc (d Dog) shout() {\nprintln(\"wang ...\")\n}\nfunc (d Dog) Show() {\nprintln(\"show ...\")\n}\nfunc (d *Dog) SetName(name string) {\nd.name = name\n}\n</code></pre> \u7ed3\u6784\u4f53 \u53cd\u5c04\u7ed3\u6784\u4f53\u6307\u9488 \u53cd\u5c04 <pre><code>func TestA(t *testing.T) {\nd := Dog{11, \"tom\"}\ntyp := reflect.TypeOf(d)\nfmt.Println(typ.Name(), typ.Kind())\nif typ.Kind() == reflect.Struct {\n// \u5b57\u6bb5\nnumField := typ.NumField()\nfor i := 0; i &lt; numField; i++ {\n// \u53ef\u4ee5\u83b7\u53d6 private \u5b57\u6bb5 \u4fe1\u606f\nfmt.Println(typ.Field(i).Name, \"\u662f\u5426\u516c\u5f00:\", typ.Field(i).IsExported())\n}\n// \u65b9\u6cd5\nnumMethod := typ.NumMethod()\nfmt.Println(\"\u65b9\u6cd5\u4e2a\u6570:\", numMethod) //1\nfor i := 0; i &lt; numMethod; i++ {\n// \u53ea\u80fd\u83b7\u53d6public \u65b9\u6cd5 ,Show\nfmt.Println(typ.Method(i).Name)\n}\n}\n}\n</code></pre> <pre><code>func TestA(t *testing.T) {\nptrD := &amp;Dog{11, \"tom\"}\nptrTyp := reflect.TypeOf(ptrD)\n// kind \u662fptr\u6307\u9488\nfmt.Println(ptrTyp.Name(), ptrTyp.Kind())\n// \u65b9\u6cd5\nnumMethod := ptrTyp.NumMethod()\nfmt.Println(\"\u65b9\u6cd5\u4e2a\u6570:\", numMethod) // 2\nfor i := 0; i &lt; numMethod; i++ {\n// SetName  Show (\u524d\u9762\u8bf4\u8fc7\u7f16\u8bd1\u5668\u4f1a\u9ed8\u8ba4\u751f\u6210\u4e00\u4e2a\u5bf9\u5e94\u7684 *Dog \u4e3a\u63a5\u53d7\u8005\u7684\u65b9\u6cd5)\nfmt.Println(ptrTyp.Method(i).Name)\n}\nfmt.Println(ptrTyp.Elem().Kind()) // struct\n}\n</code></pre>"},{"location":"go/basis/reflect/#reflectvalue","title":"\u503c reflect.Value","text":"<p>Tip</p> <ul> <li>\u662f\u7ed3\u6784\u4f53,\u7528\u4e8e\u83b7\u53d6\u5143\u6570\u636e: \"\u503c\"\u4fe1\u606f</li> <li>reflect.ValueOf() \u5bf9\u8c61\u8f6c\u6362\u4e3aValue\u7ed3\u6784\u4f53\u7684\u65b9\u6cd5</li> </ul> <p></p> \u7ed3\u6784\u4f53\u4e0e\u7ed3\u6784\u4f53\u6307\u9488 \u503c\u7684\u53cd\u5c04 <pre><code>package test\nimport (\n\"fmt\"\n\"reflect\"\n\"testing\"\n)\ntype Dog struct {\nAge  int\nname string\n}\nfunc (d Dog) shout() {\nprintln(\"wang ...\")\n}\nfunc (d Dog) Show() {\nprintln(\"show ...\")\n}\nfunc (d *Dog) SetName(name string) {\nd.name = name\n}\n</code></pre> \u7ed3\u6784\u4f53\u53cd\u5c04\u7ed3\u6784\u4f53\u6307\u9488 <pre><code>func TestA(t *testing.T) {\nd := Dog{11, \"tom\"}\nval := reflect.ValueOf(d)\ntypFromVal := val.Type()\nnumField := val.NumField()\nfor i := 0; i &lt; numField; i++ {\nfield := val.Field(i)\ntypField := typFromVal.Field(i)\nif typField.IsExported() {\n// \u79c1\u6709\u7684\u5b57\u6bb5\u65e0\u6cd5 \u83b7\u53d6\u5b83\u7684\u503c\u7684\n// \u503c\u65e0\u6cd5\u4fee\u6539 ,\u56e0\u4e3a \u65b9\u6cd5\u662f\u503c\u8f6c\u9012,\u65e0\u610f\u4e49,\u6307\u9488\u7684\u8bdd\u5c31\u53ef\u4ee5\u4e86\nfmt.Println(field.Interface(), field.CanSet())\n} else {\nfmt.Println(typField.Name)\n}\n}\n}\n</code></pre> <pre><code>func TestA(t *testing.T) {\nptrD := &amp;Dog{11, \"tom\"}\nptrVal := reflect.ValueOf(ptrD)\nval = ptrVal.Elem()\ntypFromVal = val.Type()\nnumField = val.NumField()\nfor i := 0; i &lt; numField; i++ {\nfield := val.Field(i)\ntypField := typFromVal.Field(i)\nif typField.IsExported() {\nfmt.Println(field.Interface(), field.CanSet())\nfield.SetInt(3)\nfmt.Println(ptrD.Age)\n// \u6216\nfield.Set(reflect.ValueOf(5))\nfmt.Println(ptrD.Age)\n} else {\nfmt.Println(typField.Name)\n}\n}\nfmt.Println(ptrD.Age)\n}\n</code></pre>"},{"location":"go/basis/reflect/#_4","title":"\u53cd\u5c04\u5bf9\u8c61\u8f6c\u6362\u4e3a\u63a5\u53e3\u7c7b\u578b\u53d8\u91cf","text":"<p>reflect.Interface()</p> <p>\u8f6c\u4e3a\u63a5\u53e3\u7c7b\u578b\u7684\u53d8\u91cf, \u7136\u540e\u53ef\u901a\u8fc7\u7c7b\u578b\u65ad\u8a00\u7b49\u8f6c\u4e3a\u539f\u6765\u7684\u7c7b\u578b</p>"},{"location":"go/basis/reflect/#_5","title":"\u53ef\u53d8\u6027","text":""},{"location":"go/basis/reflect/#_6","title":"\u57fa\u7840\u64cd\u4f5c","text":"<pre><code>type Dog struct {\nAge  int\nName string\n}\nfunc (d Dog) SetName(name string) {\nd.Name = name\n}\nfunc TestReflect(t *testing.T) {\nd := &amp;Dog{Age: 2, Name: \"ff\"}\ndT := reflect.TypeOf(d)\nfor i := 0; i &lt; dT.NumMethod(); i++ {\n// \u6253\u5370\u65b9\u6cd5\nfmt.Println(dT.Method(i).Name, \"==\", dT.Method(i).Type, \"==\", dT.Method(i).Type.Kind())\n}\nvv := reflect.ValueOf(d)\nargs := []reflect.Value{reflect.ValueOf(\"tom\")}\n// \u8c03\u7528\u65b9\u6cd5\nvv.MethodByName(dT.Method(0).Name).Call(args)\nfmt.Println(d.Name)\n}\n</code></pre>"},{"location":"go/basis/slice/","title":"\u5207\u7247","text":""},{"location":"go/basis/slice/#_1","title":"\u6570\u636e\u7ed3\u6784","text":"<pre><code>type SliceHeader struct {\nData uintptr // \u5f15\u7528\u7684\u6570\u7ec4\u7684\u5730\u5740\nLen  int     // \u5207\u7247\u957f\u5ea6\nCap  int     // \u5f15\u7528\u7684\u6570\u7ec4\u7684\u957f\u5ea6\n}\nfunc TestSlice(t *testing.T) {\n// \u65b9\u5f0f1\nslice1 := []int{11, 22, 33, 44, 55}\nb := (*reflect.SliceHeader)(unsafe.Pointer(&amp;slice1))\nfmt.Println(b.Cap, b.Len) // 5 5\nfmt.Println(len(slice1), cap(slice1))\n// \u65b9\u5f0f2\narr := [5]int{11, 22, 33, 44, 55}\nslice2 := arr[1:3]\nc := (*reflect.SliceHeader)(unsafe.Pointer(&amp;slice2))\n// \u6307\u5411\u7684\u6570\u7ec4\u662f arr \u4ece1\u4e0b\u6807\u5f00\u59cb\u7684. \u6240\u4ee5cap \u662f4\nfmt.Println(c.Cap, c.Len) // 4 2\n// slice2[2]  \u8d8a\u754c\u4e86,len\u662f\u53ef\u4ee5\u8bbf\u95ee\u7684\u8303\u56f4\n// \u65b9\u5f0f3\nslice3 := make([]int, 5)\nd := (*reflect.SliceHeader)(unsafe.Pointer(&amp;slice3))\n// 5,5,824634322544   data \u521d\u59cb\u5316\u4e86, \u5206\u914d\u4e86\u5185\u5b58,\u5bf9\u5e94\u7684\u5b57\u8282\u6570\u7ec4\u5143\u7d20\u90fd\u662f0\nfmt.Println(d.Cap, d.Len, d.Data)\nslice33 := make([]int, 1, 5)\ndd := (*reflect.SliceHeader)(unsafe.Pointer(&amp;slice33))\n// cap =5, len=1\nfmt.Println(dd.Cap, dd.Len, slice33[0])\n// \u65b9\u5f0f4\nvar slice4 []int\ne := (*reflect.SliceHeader)(unsafe.Pointer(&amp;slice4))\n// data \u8fd8\u6ca1\u6709\u521d\u59cb\u5316\u7684 ,\u76f8\u6bd4 slice4:=[]int{} \u521d\u59cb\u5316\u63a8\u8350\u8fd9\u79cd\nfmt.Println(e.Cap, e.Len, e.Data)\na := [10]int{1, 2, 3, 4, 5, 6, 7, 8, 9}\n// 2\u4e2a\u5207\u7247\u5f15\u7528\u540c\u4e00\u4e2a\u5e95\u5c42\u6570\u7ec4\na1 := a[1:4]\na2 := a[2:5]\na1[1] = 111\nfmt.Println(a) // \u4fee\u6539\u4e86\u5e95\u5c42\u6570\u7ec4\u5143\u7d20\na2[0] = 222\nfmt.Println(a, a1[1])\na1 = append(a1, 333)\nfmt.Println(a) // \u4fee\u6539\u4e86\u5e95\u5c42\u6570\u7ec4\u5143\u7d20\n}\n</code></pre>"},{"location":"go/basis/slice/#append","title":"append","text":"<p>Tip</p> <ul> <li>\u7531\u4e8e\u771f\u5b9e\u7684\u6570\u636e\u662f\u901a\u8fc7\u5f15\u7528\u6570\u7ec4,\u90a3\u4e48\u5982\u679c\u8ffd\u52a0\u540e\u957f\u5ea6\u8d85\u8fc7\u4e86\u6570\u7ec4\u7684cap,\u80af\u5b9a\u9700\u8981\u91cd\u65b0\u5206\u914d\u4e00\u5757\u5185\u5b58,\u7136\u540e\u8fd8\u9700\u8981\u5c06\u539f\u6765\u7684\u6570\u636e\u590d\u5236\u5230\u65b0\u7684\u5185\u5b58\u5730\u5740\u4e0a</li> <li>\u65b0\u7684\u5185\u5b58\u8981\u591a\u5927\u624d\u597d\u5462?</li> </ul> \u54ea\u4e2a\u7248\u672c\u7684go \u5df2\u7ecf\u5fd8\u8bb0\u4e86. \u540e\u7eed\u66f4\u65b0\u6700\u65b0\u7248\u672c\u7684<pre><code>func growslice(et *_type, old slice, cap int) slice {\nnewcap := old.cap\ndoublecap := newcap + newcap\nif cap &gt; doublecap {\n//\u5982\u679c\u671f\u671b\u5bb9\u91cf\u5927\u4e8e\u5f53\u524d\u5bb9\u91cf\u7684\u4e24\u500d\u5c31\u4f1a\u4f7f\u7528\u671f\u671b\u5bb9\u91cf\nnewcap = cap\n} else {\nif old.len &lt; 1024 {\n// \u5426\u5219 \u5982\u679c\u5f53\u524d\u5207\u7247\u7684\u957f\u5ea6\u5c0f\u4e8e 1024 \u5c31\u4f1a\u5c06\u5bb9\u91cf\u8bbe\u7f6e\u4e3a\u539f\u51482\u500d\u5927\u5c0f\nnewcap = doublecap\n} else {\n//\u5982\u679c\u5f53\u524d\u5207\u7247\u7684\u957f\u5ea6\u5927\u4e8e 1024 \u5c31\u4f1a\u6bcf\u6b21\u589e\u52a0 25% \u7684\u5bb9\u91cf\uff0c\u76f4\u5230\u65b0\u5bb9\u91cf\u5927\u4e8e\u671f\u671b\u5bb9\u91cf\nfor 0 &lt; newcap &amp;&amp; newcap &lt; cap {\nnewcap += newcap / 4\n}\nif newcap &lt;= 0 {\nnewcap = cap\n}\n}\n}\n}\n</code></pre>"},{"location":"go/basis/slice/#for-range","title":"\u904d\u5386 for range","text":"<pre><code>func TestSlice(t *testing.T) {\narr := []int{1, 2, 3}\nvar v2 *int\nfor _, v := range arr {\nif v == 2 {\nv2 = &amp;v\n}\nfmt.Println(&amp;v) // \u540c\u4e00\u4e2a\u5730\u5740\n}\nfmt.Println(*v2) // 3\n}\n</code></pre>"},{"location":"go/basis/slice/#_2","title":"\u589e\u52a0\u6392\u5e8f","text":"<pre><code>package main\nimport (\n\"fmt\"\n\"math/rand\"\n\"sort\"\n)\ntype Student struct {\nName string\nAge  int\nId   string\n}\ntype StudentSlice []Student\n// \u6ce8\u610f\u6211\u4eec\u662f\u7ed9\u5207\u7247 \u6392\u5e8f,\u6240\u4ee5\u662f\u8ba9\u5207\u7247\u5b9e\u73b0\u4e86\u63a5\u53e3\nfunc (p StudentSlice) Len() int {\nreturn len(p)\n}\nfunc (p StudentSlice) Less(i, j int) bool {\nreturn p[i].Name &gt; p[j].Name\n}\nfunc (p StudentSlice) Swap(i, j int) {\n//\u8fd9\u4e2a\u5f7c\u6b64\u6362,\u548cpython\u4e00\u6837\u7684\u5199\u6cd5\np[i], p[j] = p[j], p[i]\n}\nfunc main() {\nvar ss StudentSlice\nfor i := 0; i &lt; 10; i++ {\ns := Student{\nName: fmt.Sprintf(\"stu%d\", rand.Intn(100)),\nId:   fmt.Sprintf(\"ID_%d\", rand.Intn(100)),\nAge:  rand.Intn(100),\n}\nss = append(ss, s)\n}\nfor _, v := range ss {\nfmt.Println(v)\n}\nsort.Sort(ss)\nfmt.Println(\"=================\")\nfor _, v := range ss {\nfmt.Println(v)\n}\n}\n</code></pre>"},{"location":"go/basis/string/","title":"\u5b57\u7b26\u4e32","text":""},{"location":"go/basis/string/#_1","title":"\u5982\u4f55\u8bbe\u8ba1\u5b57\u7b26\u4e32","text":"<ol> <li>str:=\"abc\",\u7136\u540e\u53ef\u4ee5str=\"hello\"<ol> <li>\u53d8\u91cf\u7684\u5185\u5b58\u5730\u5740\u662f\u4e0d\u53d8\u7684,\u5360\u7528\u5185\u5b58\u5927\u5c0f\u662f\u786e\u5b9a\u7684</li> <li>\u6307\u5411\u7684\u5b9e\u9645\u5b57\u7b26\u7684\u5185\u5b58\u5185\u5bb9\u662f\u5426\u53ef\u53d8</li> </ol> </li> <li>\u5b57\u7b26\u7684\u957f\u5ea6\u9700\u8981\u77e5\u9053<ol> <li>\u5b9e\u9645\u5b58\u653e\u5b57\u7b26\u7684\u5730\u65b9 \u9047 \"\\0\" \u622a\u6b62? \u6216 \u8bbe\u8ba1\u4e0a\u76f4\u63a5\u5199\u660e\u5b57\u7b26\u7684\u5b57\u8282\u957f\u5ea6</li> </ol> </li> <li>\u5b57\u7b26\u4e32\u5bf9\u5e94\u7684\u53d8\u91cf\u5927\u5c0f\u662f\u56fa\u5b9a\u7684, go\u8fd9\u6837\u8bbe\u8ba1<ol> <li>8\u4e2a\u5b57\u8282\u5b58\u653e\u5b57\u7b26\u7684\u5b57\u8282\u957f\u5ea6</li> <li>8\u4e2a\u5b57\u8282\u5b58\u653e\u5b9e\u9645\u5b57\u7b26\u7684\u5185\u5b58\u5730\u5740(\u8fd9\u4e2a\u5730\u5740\u4e0a\u662f\u8fde\u7eed\u7684\u5185\u5bb9\u7a7a\u95f4\u6765\u5b58\u653e\u5b57\u7b26: \u5b57\u8282\u6570\u7ec4)</li> </ol> </li> </ol>"},{"location":"go/basis/string/#_2","title":"\u6570\u636e\u7ed3\u6784","text":"\u5b57\u7b26\u4e32\u53d8\u91cf\u5360\u752816\u4e2a\u5b57\u8282<pre><code>type StringHeader struct {\nData uintptr\nLen  int\n}\n</code></pre>"},{"location":"go/basis/string/#_3","title":"\u4ee3\u7801\u9a8c\u8bc1","text":"<pre><code>func TestString(t *testing.T) {\na := \"abc\u6211\u4eec\"\nb := (*reflect.StringHeader)(unsafe.Pointer(&amp;a))\n// \u5b57\u8282\u5927\u5c0f16,  \u5b57\u7b26\u957f\u5ea6\u662f9, 1\u4e2a\u6c49\u5b57\u53603\u4e2a\u5b57\u8282\nprintln(unsafe.Sizeof(a), b.Len, b.Data)\nc := (*[3]int8)(unsafe.Pointer(b.Data))\n// 97 98 99\nprintln(c[0], c[1], c[2])\n// c[0] = 'd' // \u65e0\u6cd5\u4fee\u6539\u7684,\u5b57\u7b26\u6240\u5728\u5806\u5185\u5b58\u7684\u5185\u5bb9\u65e0\u6cd5\u4fee\u6539\n}\n</code></pre>"},{"location":"go/basis/string/#_4","title":"\u5b57\u7b26\u4e32\u80fd\u5426\u4fee\u6539\u4e0e\u5207\u7247\u8f6c\u6362","text":"<p>\u524d\u9762\u4ee3\u7801\u9a8c\u8bc1\u5b57\u7b26\u4e32\u6570\u636e\u7ed3\u6784,\u77e5\u9053 <code>a := \"abc\u6211\u4eec\"</code> \u8fd9\u6837\u5b9a\u4e49\u7684\u5b57\u7b26\u4e32\u662f\u65e0\u6cd5\u4fee\u6539\u6307\u5411\u7684\u5185\u5b58\u7684\u5185\u5bb9</p> \u5b57\u7b26\u5207\u7247\u8f6c\u5b57\u7b26\u4e32-\u65b9\u5f0f\u4e00<pre><code>func main() {\na := []byte{'a', 'b', 'c'}\nb := string(a)\nprintln(b)\n}\n</code></pre> <p>\u67e5\u770b\u6c47\u7f16\u53ef\u4ee5\u770b\u5230\u4f7f\u7528\u7684\u662f<code>runtime.slicebytetostring()</code></p> <pre><code>func slicebytetostring(buf *tmpBuf, ptr *byte, n int) string {\n// ...\nvar p unsafe.Pointer\nif buf != nil &amp;&amp; n &lt;= len(buf) {\np = unsafe.Pointer(buf)\n} else {\np = mallocgc(uintptr(n), nil, false)\n}\n// \u4f1a\u590d\u5236\u5207\u7247\u7684\u5185\u5bb9\nmemmove(p, unsafe.Pointer(ptr), uintptr(n))\nreturn unsafe.String((*byte)(p), n)\n}\n</code></pre> \u5b57\u7b26\u5207\u7247\u8f6c\u5b57\u7b26\u4e32-\u65b9\u5f0f\u4e8c<pre><code>func TestA(t *testing.T) {\na := []byte{'a', 'b', 'c'}\nb := *(*string)(unsafe.Pointer(&amp;a))\nfmt.Println(b) // abc\na[0] = 'd'\nfmt.Println(b) // dbc\n}\n</code></pre> <ul> <li>\u5207\u7247\u7684\u5185\u5b58\u7ed3\u6784 </li> <li>\u5b57\u7b26\u4e32\u7684\u5185\u5b58\u7ed3\u6784  \u6211\u4eec\u77e5\u9053\u7c7b\u578b\u8f6c\u6362\u5c31\u662f\u6362\u4e00\u79cd\u65b9\u5f0f\u6765\u8bfb\u5199\u5185\u5b58,\u6839\u636e\u5207\u7247\u548c\u5b57\u7b26\u4e32\u7684\u5185\u5b58\u7ed3\u6784,\u53d1\u73b0\u4ed6\u4eec\u521a\u597d\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u8fdb\u884c\u8f6c\u6362,\u5207\u7247data\u6307\u5411\u7684\u5b57\u7b26\u6570\u7ec4\u6210\u4e86\u5b57\u7b26\u4e32data\u7684\u6307\u5411,\u8fd9\u4e2a\u8f6c\u6362\u662f\u9ad8\u6548\u7387\u7684.</li> </ul> \u7a0d\u5fae\u770b\u4e0b\u6c47\u7f16<pre><code>0x006b 00107 (main.go:15) MOVQ    AX, main.a+48(SP) # \u5b57\u7b26\u6570\u7ec4\u5730\u5740\n0x0070 00112 (main.go:15) MOVQ    $3, main.a+56(SP) # \u5207\u7247\u957f\u5ea6 \u8bbe\u7f6e=3\n0x0079 00121 (main.go:15) MOVQ    $3, main.a+64(SP) # \u5207\u7247cap \u8bbe\u7f6e=3\n0x0082 00130 (main.go:16) LEAQ    main.a+48(SP), AX\n0x0087 00135 (main.go:16) TESTB   AL, (AX)\n0x0089 00137 (main.go:16) MOVQ    main.a+48(SP), AX\n0x008e 00142 (main.go:16) MOVQ    AX, main.b+32(SP) # \u5b57\u7b26\u6570\u7ec4\u5730\u5740\n0x0093 00147 (main.go:16) MOVQ    $3, main.b+40(SP)  # \u5b57\u7b26\u4e32\u7684len \u8bbe\u7f6e=3\n</code></pre>"},{"location":"go/basis/string/#_5","title":"\u4e00\u4e9b\u64cd\u4f5c","text":"\u904d\u5386\u5b57\u8282\u957f\u5ea6\u8f6c\u6210utf-8\u5b57\u7b26\u6570\u7ec4\u622a\u53d6 <pre><code>a := \"abc\u6211\u4eec\"\nfor _, c := range a {\n// \u6253\u5370\u6bcf\u4e2a\u5b57\u7b26\nfmt.Printf(\"%c\\n\", c)\n}\n</code></pre> <pre><code>a := \"abc\u6211\u4eec\"\nfmt.Println(len(a)) // 9 \u5b57\u8282\u6570\n</code></pre> <pre><code>a := \"abc\u6211\u4eec\"\ns := []rune(a) // \u8f6c\u6210 utf-8\u5b57\u7b26 \u6570\u7ec4\nfmt.Println(s[0], s[1], s[2], string(s[3]), string(s[4]))\n</code></pre> <pre><code>a := \"abc\u6211\u4eec\"\n// \u8f6c\u6210utf-8\u6570\u7ec4,\u5207\u7247\u540e\u8f6c\u6210\u5b57\u7b26\u4e32\ns := string([]rune(a)[3:])\nfmt.Println(s) //\u6211\u4eec\n</code></pre>"},{"location":"go/basis/string/#_6","title":"\u5b57\u7b26\u96c6","text":"<p>Todo</p> <p>\u6709\u65f6\u95f4\u518d\u8be6\u7ec6\u5199\u5199</p> <p>Question</p> <p>\u4e2d\u82f1\u6587\u6df7\u5408\u7684\u60c5\u51b5, \u8ba1\u7b97\u673a\u662f\u5982\u4f55\u77e5\u9053\u7528\u4e00\u4e2a\u5b57\u8282\u6216\u4e09\u4e2a\u5b57\u8282\u6765\u533a\u5206\u662f\u4ec0\u4e48\u5b57\u7b26\u7684\u5462? \u662f\u5982\u4f55\u65ad\u5b57\u7684?</p> <p>UTF-8\u7684\u7f16\u7801\u89c4\u5219 go\u8bed\u8a00\u9ed8\u8ba4\u7684\u7f16\u7801\u65b9\u5f0f</p> <ul> <li>1\u4e2a\u5b57\u8282\u7684\u5b57\u7b26: 0xxxxxxx, 0\u5f00\u5934\u8868\u793a\u4e00\u4e2a\u5b57\u8282\u7684</li> <li>2\u4e2a\u5b57\u8282\u7684\u5b57\u7b26: 110xxxxx 10xxxxxx<ul> <li>110 \u5f00\u5934\u8868\u793a2\u4e2a\u5b57\u8282\u7684</li> <li>10\u5f00\u5934\u8868\u793a\u4e00\u4e2a\u5b57\u7b26\u7684\u4e2d\u95f4\u5b57\u8282</li> </ul> </li> <li>3\u4e2a\u5b57\u8282\u7684\u5b57\u7b26: 1110xxxx 10xxxxxx 10xxxxxx</li> <li>4\u4e2a\u5b57\u8282\u7684\u5b57\u7b26: 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</li> </ul> <pre><code>func TestString(t *testing.T) {\na := \"\u6211\"\n// 0xE6 1110  0110\n// 0x88 10 001000\n// 0x91 10 010001\nfmt.Println(a[0], a[1], a[2])\n}\n</code></pre> <p>\u7ed3\u679c</p> <p>\u6211\u4eec\u5c06\u4e0a\u9762 \"\u6211\" \u6c49\u5b57\u7684\u6bcf\u4e2a\u5b57\u8282\u7684 \"\u524d\u7f00\" \u53bb\u6389\u5f97\u5230 0110 001000 010001 ==&gt; 01100010 00010001 =&gt; 0x6211 \u6211\u7684unicode \u7801\u5c31\u662f 0x6211</p>"},{"location":"go/basis/struct/","title":"\u7ed3\u6784\u4f53","text":""},{"location":"go/basis/struct/#_1","title":"\u7ed3\u6784\u4f53\u548c\u65b9\u6cd5\u662f\u5982\u4f55\u8054\u7cfb\u7684","text":"<p>\u7ed3\u6784\u4f53\u548c\u65b9\u6cd5\u662f\u901a\u8fc7\u65b9\u6cd5\u96c6\uff08method set\uff09\u8054\u7cfb\u8d77\u6765\u7684.\u65b9\u6cd5\u96c6\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u51fd\u6570\u6307\u9488,\u5b83\u6307\u5411\u7ed3\u6784\u4f53\u7c7b\u578b\u7684\u65b9\u6cd5. \u5f53\u5b9a\u4e49\u4e00\u4e2a\u7ed3\u6784\u4f53\u7c7b\u578b\u65f6,Go\u8bed\u8a00\u4f1a\u4e3a\u8fd9\u4e2a\u7c7b\u578b\u751f\u6210\u4e00\u4e2a\u65b9\u6cd5\u96c6</p> \u53cd\u5c04\u6765\u6253\u5370\u5bf9\u8c61\u7684\u65b9\u6cd5<pre><code>type Dog struct {\nAge  int\nName string\n}\nfunc (d Dog) SetName(name string) {\nfmt.Println(\"input::\", name)\nd.Name = name\n}\nfunc (d *Dog) GetName() string {\nfmt.Printf(\"\u65b9\u6cd5\u5185\u7684\u5730\u5740: %p\\n\", d)\nreturn d.Name\n}\nfunc TestStruct(t *testing.T) {\nfmt.Println(\"Dog \u7c7b\u578b\u7684 \u65b9\u6cd5\")\nd := Dog{Age: 2}\nv := reflect.TypeOf(d)\nfor i := 0; i &lt; v.NumMethod(); i++ {\n// SetName == func(test.Dog, string) == func\nfmt.Println(v.Method(i).Name, \"==\", v.Method(i).Type, \"==\", v.Method(i).Type.Kind())\n}\nfmt.Println(\"*Dog \u7c7b\u578b\u7684\u65b9\u6cd5\")\nd2 := &amp;Dog{}\nv2 := reflect.TypeOf(d2)\nfor i := 0; i &lt; v2.NumMethod(); i++ {\n// \u6ce8\u610f\u67092\u4e2afunc, SetName(*Dog,string) \u65b9\u6cd5 \u81ea\u52a8\u751f\u6210\u4e86\n// \u867d\u7136\u6211\u4eec\u53ea\u5b9a\u4e49\u4e86 func SetName(Dog,string) \u65b9\u6cd5\n// GetName == func(*test.Dog) string == func\n// SetName == func(*test.Dog, string) == func\nfmt.Println(v2.Method(i).Name, \"==\", v2.Method(i).Type, \"==\", v2.Method(i).Type.Kind())\n}\n}\n</code></pre> <p>\u91cd\u8981\u7ed3\u8bba</p> <p>\u6ce8\u610f \u7f16\u8bd1\u5668\u4e3a Dog \u7c7b\u578b\u7684 Shout\u65b9\u6cd5 \u751f\u6210\u4e86 \u5bf9\u5e94 *Dog\u7c7b\u578b \u7684Shout\u65b9\u6cd5</p> \u547d\u4ee4\u67e5\u770b\u5b9e\u73b0\u7684\u65b9\u6cd5<pre><code>go tool compile -S -N -l main.go\n# \u67e5\u770b\u6709\u54ea\u4e9b\u51fd\u6570\ngo tool nm -type  main.o|grep ' T '\n</code></pre>"},{"location":"go/basis/struct/#_2","title":"\u7ed3\u6784\u4f53\u65b9\u6cd5\u7684\u5b9e\u8d28\u4e0e\u53c2\u6570","text":"<p>Tip</p> <p>\u7ed3\u6784\u4f53\u8c03\u7528\u65b9\u6cd5\u5b9e\u9645\u4e0a\u662f\u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u7ed3\u6784\u4f53</p> <pre><code>type Dog struct {\nAge  int\nName string\n}\nfunc (d *Dog) GetName() string {\n// \u4e0eTestStruct2\u7684 &amp;d  \u5730\u5740\u4e00\u6837\nfmt.Printf(\"\u65b9\u6cd5\u5185\u7684\u5730\u5740: %p\\n\", d)\nreturn d.Name\n}\nfunc (d Dog) SetName(name string) {\nfmt.Println(\"input::\", name)\nd.Name = name\n}\n// \u524d\u9762\u901a\u8fc7\u53cd\u5c04\u6211\u4eec\u770b\u5230\u5b9e\u9645\u4e0a\u7684\u65b9\u6cd5\u662f\u8fd9\u6837\u7684\n/*\nfunc SetName(d Dog,name string) {\n    d.Name = name\n}\nfunc GetName(d *Dog) string{\n    return d.Name\n}\n\u7ed3\u6784\u4f53\u65b9\u6cd5\u4f1a\u81ea\u52a8\u751f\u6210\u4e00\u4e2a\u7ed3\u6784\u4f53\u6307\u9488\u7684\u65b9\u6cd5\nfunc SetName(d *Dog,name string) {\n    d.Name = name\n}\n*/\n</code></pre> \u7ed3\u6784\u4f53\u8c03\u7528\u65b9\u6cd5\u7ed3\u6784\u4f53\u6307\u9488\u8c03\u7528\u65b9\u6cd5 <pre><code>func TestStruct2(t *testing.T) {\nd := Dog{Age: 3, Name: \"hello\"}\nfmt.Printf(\"\u5916\u90e8\u7684  \u5730\u5740:%p\\n\", &amp;d)\n// \u5b9e\u9645\u662f\u5c06 &amp;d \u4f20\u9012 \u7ed9 GetName(&amp;d)  ==&gt; (*Dog).GetName(&amp;d)\nprintln(d.GetName()) // hello\n// \u7b49\u4ef7\u4e8e \u6267\u884c   Dog.SetName(d, \"abc\")\nd.SetName(\"abc\")     // SetName(d) , \u7531\u4e8ego \u662f\u503c\u4f20\u9012\u7684 ,\u6240\u4ee5\u6ca1\u6709\u6539\u53d8d\u7684Name\u5c5e\u6027\nprintln(d.Name)      // hello\n}\n</code></pre> <pre><code>func TestStruct2(t *testing.T) {\nf := &amp;Dog{Age: 3, Name: \"hello\"}\n// \u5b9e\u9645\u8c03\u7528\u4e86 SetName(*f ,abc)\n// \u6309\u7167\u524d\u9762\u8bf4\u5230\u7684\u53cd\u5c04 \u5e94\u8be5\u6709 SetName(*Dog,string) \u65b9\u6cd5\n// \u4f46\u8fd9\u91cc\u7684\u8c03\u7528\u8fd8\u662f\u7528\u7684  SetName(Dog,string) \u65b9\u6cd5!!!\n// \u90a3\u4e48\u81ea\u52a8\u751f\u6210\u7684 SetName(*Dog,string) \u65b9\u6cd5\u6709\u4ec0\u4e48\u7528\u5462?\nf.SetName(\"abc\")\nprintln(f.Name) // \u8fd8\u662f hello\n}\n</code></pre> <p>Tip</p> <p>\u7f16\u8bd1\u5668\u81ea\u52a8\u751f\u6210\u7684 SetName(*Dog,string) \u65b9\u6cd5 \u7528\u4e8e\u63a5\u53e3,\u6211\u4eec\u540e\u7eed\u518d\u8bf4</p>"},{"location":"go/basis/struct/#_3","title":"\u5185\u5b58\u5bf9\u9f50","text":"<p>\u5e94\u8be5\u662f\u8fd9\u6837\u8bf4\u7684... \u5fd8\u8bb0\u4e86. \u5148\u8fd9\u6837\u5199</p> <p>\u64cd\u4f5c\u7cfb\u7edf\u8bfb\u53d6\u5185\u5b58,\u4e0d\u662f\u4e00\u4e2a\u5b57\u8282\u4e00\u4e2a\u5b57\u8282\u7684\u8bfb\u7684, \u800c\u662f\u6309\u5b57\u957f(32\u4f4d\u7cfb\u7edf4\u4e2a\u5b57\u8282,64\u4f4d\u7cfb\u7edf8\u4e2a\u5b57\u8282)\u7684\u500d\u6570\u6765\u8bfb\u53d6</p>"},{"location":"go/basis/unsafe/","title":"unsafe","text":""},{"location":"go/basis/unsafe/#unsafepointer-uintptr","title":"unsafe.Pointer &amp; uintptr","text":"<p>GC \u4f1a\u7ba1\u7406 unsafe.Pointer uintptr \u5219\u4e0d\u4f1a</p>"},{"location":"go/basis/variable-type/","title":"\u53d8\u91cf\u4e0e\u7c7b\u578b\u7684\u672c\u8d28","text":"<p>\u4e00\u4e2a\u53d8\u91cf\u5c31\u662f\u4e00\u5757\u5185\u5b58(\u6709\u7684\u53d8\u91cf\u4e0d\u5360\u5185\u5b58\u7a7a\u95f4),\u53d8\u91cf\u7684\u7c7b\u578b\u89c4\u5b9a\u4e86\u4f60 \u5982\u4f55\u4ece\u8fd9\u5757\u5185\u5b58\u91cc\u8bfb\u53d6\u6570\u636e\u548c\u5199\u5165\u6570\u636e,\u4e14\u7ed9\u8fd9\u4e2a\u7c7b\u578b\u7684\u53d8\u91cf\u4e00\u4e9b\"\u64cd\u4f5c\u65b9\u6cd5\",\u6bd4\u5982 \u6570\u7ec4\u7684\u4e0b\u6807\u64cd\u4f5c</p>"},{"location":"go/basis/variable-type/#_1","title":"\u5927\u5c0f\u7aef","text":""},{"location":"go/basis/variable-type/#_2","title":"\u4ee3\u7801\u5224\u65ad\u5927\u5c0f\u7aef","text":"<pre><code>var val int32 = 1\nptr := unsafe.Pointer(&amp;val)\nIsLittleEndian := *(*byte)(ptr) == 1\nprintln(IsLittleEndian) //true \u5c31\u662f\u5c0f\u7aef\u6a21\u5f0f \n</code></pre>"},{"location":"go/basis/variable-type/#_3","title":"\u53d8\u91cf\u7c7b\u578b\u4e0e\u7c7b\u578b\u8f6c\u6362","text":"<p>\u53d8\u91cf\u7684\u7c7b\u578b\u89c4\u5b9a\u4e86\u4f60\u5982\u4f55\u4ece\u8fd9\u5757\u5185\u5b58\u91cc\u8bfb\u53d6\u6570\u636e\u548c\u5199\u5165\u6570\u636e \u7c7b\u578b\u7684\u8f6c\u6362\u65e0\u975e\u5c31\u662f\u4f60\u6362\u4e86\u4e00\u79cd\u8bfb\u5199\u6570\u636e\u7684\u65b9\u5f0f\u800c\u5df2</p> <pre><code>func main() {\n// 1000 0011\nvar a uint8 = 131\nprintln(a)\n// \u53d8\u6210\u6709\u7b26\u53f7\u7684, \u90a3\u4e48\u5b83\u7684\u6570\u636e\u7684\u8bfb\u53d6\u65b9\u5f0f\u5c31\u53d8\u4e86\n// 1000 0011 \u8d1f\u6570\u7684\u8865\u7801\n// \u53cd\u7801 1000 0010\n// \u539f\u7801 1111 1101 = -125\nb := int8(a)\nprintln(b) // -125\n}\n</code></pre>"},{"location":"go/basis/variable-type/#_4","title":"\u4e00\u5757\u53ef\u8bfb\u5199\u7684\u5185\u5b58,\u662f\u4e0d\u662f\u53ef\u4ee5\u6309\u7167\u6211\u4efb\u610f\u7684\u65b9\u5f0f\u6765\u8bfb\u5199\u5462?","text":"<p>\u662f\u7684, \u4f60\u60f3\u600e\u4e48\u8bfb\u5199,\u5c31\u600e\u4e48\u8bfb\u5199</p> <pre><code>package main\nimport (\n\"unsafe\"\n)\ntype FF struct {\ni int32\nj int8\nk int8\n}\nfunc main() {\n// \u6211\u4eec\u8fd9\u91cc\u5047\u5b9a z\u548c a \u53d8\u91cf\u4e4b\u95f4\u662f\u8fde\u7eed\u7684 (\u56e0\u4e3a\u53ef\u80fd\u4e0d\u4e00\u5b9a\u662f\u8fde\u7eed\u7684!)\nvar z int32 = 1800\nvar a, b, c, d int8 = 2, 4, 3, 1\nptr := unsafe.Pointer(&amp;d)\n// \u683c\u5f0f\u5316(\u7c7b\u578b\u8f6c\u6362)  \u7406\u89e3\u4e3a \u4f60\u60f3\u8fd9\u4e48\u53bb\u8bfb\u5199\u8fd9\u5757\u5185\u5b58\u4e0a\u7684\u6570\u636e\n// \u8fd9\u91cc\u5f53\u7136\u4f60\u53ef\u4ee5\u5c31\u7528 (*int32)(ptr) \u6765\u683c\u5f0f\u5316 \u8bfb\u53d64\u4e2a\u5b57\u8282\u7684\u6d4b\u8bd5\nff := (*FF)(ptr)\n//0xc00004c753 0xc00004c752 0xc00004c751 0xc00004c750\nprintln(&amp;a, &amp;b, &amp;c, &amp;d)\n// 0xc00004c754\nprintln(&amp;z)\n// 0xc00004c750 0xc00004c754\nprintln(&amp;ff.i, &amp;ff.j)\n// 33817345 8 7\nprintln(ff.i, ff.j, ff.k)\n// \u76f4\u63a5\u4fee\u6539\u4e86z \u539f\u6765\u90a3\u5757\u5185\u5b58\u4e0a\u67d0\u4e2a\u5b57\u8282\u4e0a\u7684\u6570\u636e\u4e86.\n// \u5f53\u7136\u5982\u679c\u8981\u53bb\u6539\u53d8\u91cf\u7684\u67d0\u4e2a\u5b57\u8282\u4e0a\u7684\u6570\u636e, \u53ef\u4ee5\u7528\u4f4d\u8fd0\u7b97..\nff.j = 9\n// 1801\nprintln(z)\nff.k = 1\n// 265\nprintln(z)\n}\n</code></pre> <p></p> <ul> <li>\u518d\u4e3e\u4e2a\u4f8b\u5b50</li> </ul> <pre><code>package main\nimport (\n\"unsafe\"\n)\ntype dd struct {\ni1  int8\narr [3]int8\n}\nfunc main() {\nd := 33817345\n// \u60f3\u600e\u4e48\u683c\u5f0f\u5316\u5c31\u600e\u4e48\u683c\u5f0f\u5316\n// \u60f3\u600e\u4e48\u8bfb\u5199\u6570\u636e\u5c31\u600e\u4e48\u683c\u5f0f\u5316\u5b83\nd2 := (*dd)(unsafe.Pointer(&amp;d))\nprintln(d2.i1, d2.arr[0], d2.arr[1], d2.arr[2])\nd2.arr[0] = 6\nprintln(d)\n}\n</code></pre> <p>\u7406\u89e3\u4e86\u7c7b\u578b,\u4f7f\u7528\u8d77 (unsafe.Pointer) \u4f1a\u53d8\u5f97\u66f4\u5bb9\u6613</p>"},{"location":"go/basis/variable-type/#_5","title":"\u6307\u9488\u7684\u7c7b\u578b","text":"<p>Tip</p> <ul> <li>\u6307\u9488: \u6307\u5411\u4e00\u4e2a\u5185\u5b58\u5730\u5740</li> <li>\u6307\u9488\u7c7b\u578b: \u8bf4\u660e\u4e86\u4f60\u7528\u4ec0\u4e48\u6837\u7684\u65b9\u5f0f\u7ed3\u6784\u53bb\u8bfb\u53d6\u8be5\u5757\u5185\u5b58</li> </ul> <pre><code>// \u65b0\u7684\u7ed3\u6784= \u65b0\u7684\u5185\u5b58\u8bfb\u53d6\u65b9\u5f0f\nnewPtr:=(*\u65b0\u7684\u7ed3\u6784)(unsafe.Pointer(\u5730\u5740))\n</code></pre>"},{"location":"go/concurrency/channel/","title":"channel","text":""},{"location":"go/concurrency/channel/#_1","title":"\u57fa\u672c\u64cd\u4f5c","text":"<p>Tip</p> <ul> <li>\u65e0\u7f13\u51b2:\u5047\u8bbe\u5feb\u9012, \u5728\u6ca1\u6709\u8702\u5de2\u7684\u60c5\u51b5\u4e0b, \u5feb\u9012\u5458\u5e26\u7740\u5305\u88f9\u6765\u4e86, \u4f60\u4eba\u4e0d\u5728, GG, \u963b\u585e\u4e86,\u7b49\u5f85</li> <li>\u6709\u7f13\u51b2:\u6709\u8702\u5de2\u540e, \u5305\u88f9\u5230\u4e86, \u5feb\u9012\u5458\u76f4\u63a5\u5c06\u5305\u88f9\u653e\u5230\u8702\u5de2\u5c31\u884c, \u4f46\u662f\u5982\u679c\u8702\u5de2\u6ee1\u4e86, GG,\u963b\u585e\u4e86,\u7b49\u5f85<ul> <li>\u5f53\u7136\u5982\u679c \u5ba2\u6237\u5728\u7684\u8bdd, \u90a3\u4e48\u76f4\u63a5\u4ea4\u7ed9\u5ba2\u6237\u5c31\u662f\u4e86,</li> </ul> </li> <li>\u4e0a\u97622\u70b9\u5df2\u7ecf\u8bf4\u660e\u4e86,\u4ec0\u4e48\u60c5\u51b5\u4e0b\u662f\u4e0d\u963b\u585e\u7684</li> </ul> <pre><code>func TestChan(t *testing.T) {\n//\u5b9a\u4e49\nvar intChan chan int\n// \u6307\u9488,\u5f15\u7528\u7c7b\u578b\nintChan = make(chan int, 3)\nfmt.Printf(\"intChar\u7684\u503c=%v intChan\u672c\u8eab\u7684\u5730\u5740=%p\\n\", intChan, &amp;intChan)\ngo func() {\n// \u5143\u7d20\u4e2a\u6570\u4e3a\u7a7a\u65f6\u8bfb \u4f1a\u963b\u585e\u7b49\u5f85\nfmt.Println(\"\u8bfb\u53d6\u7ba1\u9053\u7b49\u5f85\u4e2d...\")\nnum2 := &lt;-intChan\nfmt.Println(\"\u8bfb\u53d6\u5b8c\u6bd5...\", num2)\n}()\ntime.Sleep(2 * time.Second)\n// \u5411\u7ba1\u9053\u5199\u5165\u6570\u636e\nintChan &lt;- 1\nintChan &lt;- 2\nintChan &lt;- 3\n// \u6253\u5370\u7ba1\u9053\u7684\u957f\u5ea6\u548c\u5bb9\u91cf\n// \u5bb9\u91cf\u662f\u4e0d\u53d8\u7684,\u957f\u5ea6\u6839\u636e\u7ba1\u9053\u91cc\u9762\u5b58\u653e\u7740\u591a\u5c11\u4e2a\u6570\u636e\nfmt.Printf(\"intChan len=%d cap=%d\\n\", len(intChan), cap(intChan))\nintChan &lt;- 4\ngo func() {\n// \u6570\u636e\u5199\u5165,\u6ee1\u4e86,\u518d\u5199 \u4f1a\u963b\u585e\u7b49\u5f85\nfmt.Println(\"\u5199\u5165\u7ba1\u9053\u7b49\u5f85\u4e2d...\")\nintChan &lt;- 5\nfmt.Println(\"\u5199\u5165\u7ba1\u9053\u5b8c\u6bd5...\")\n}()\ntime.Sleep(3 * time.Second)\n//\u8bfb\u53d6\u7ba1\u9053\u6570\u636e\n// \u65e0\u53d8\u91cf\u63a5\u6536\n&lt;-intChan\n// \u6709\u53d8\u91cf\u63a5\u6536\nnum, ok := &lt;-intChan\nfmt.Println(\"\u8bfb\u53d6:\",ok, num)\ntime.Sleep(5 * time.Second)\n// \u5173\u95ed\u7ba1\u9053\u540e,\u4e0d\u80fd\u5199\u5165\u6570\u636e,\u4f46\u662f\u53ef\u4ee5\u8bfb\u53d6\nclose(intChan)\nnum = &lt;-intChan\nfmt.Println(num)\nnum = &lt;-intChan\nfmt.Println(num)\n// \u5df2\u7ecf\u6ca1\u6709\u5143\u7d20\u4e86, \u4f46\u662f\u8fd8\u662f\u53ef\u4ee5\u8bfb\u53d6\u64cd\u4f5c, \u503c\u662f0\nnum, ok = &lt;-intChan\nfmt.Println(num,ok) // 0 false\n}\n</code></pre> <pre><code>func main() {\n// \u65e0\u7f13\u51b2\nch := make(chan int)\n// \u6ca1\u6709\u6d88\u8d39\u8005, \u8fd0\u884c\u4f1a\u76f4\u63a5\u62a5\u9519\nch &lt;- 1\n}\n</code></pre> <p><pre><code>func main() {\nch := make(chan int)\n// \u542f\u52a8\u4e00\u4e2agoroutine\u5c06\u6570\u636e\u53d1\u9001\u5230\u901a\u9053\u4e2d\ngo func() {\nfor i := 1; i &lt;= 5; i++ {\nch &lt;- i // \u53d1\u9001\u6570\u636e\u5230\u901a\u9053\ntime.Sleep(time.Second)\n}\nclose(ch) // \u5173\u95ed\u901a\u9053\n}()\n// \u4f7f\u7528for range\u8fed\u4ee3\u8bfb\u53d6\u901a\u9053\u4e2d\u7684\u503c\n// \u5982\u679c\u6ca1\u6709 close \u4f1a\u8d85\u65f6\u9000\u51fa\nfor num := range ch {\nfmt.Println(num)\n}\n}\n</code></pre> - select <pre><code>\n</code></pre></p>"},{"location":"go/concurrency/channel/#_2","title":"\u5e95\u5c42\u539f\u7406","text":""},{"location":"go/concurrency/channel/#hchan","title":"hchan\u6570\u636e\u7ed3\u6784","text":"<p>\u601d\u8003 (\u4ee5\u6709\u7f13\u51b2\u4e3a\u4f8b)</p> <ol> <li>channel \u53ef\u80fd\u5360\u7528\u7684\u5185\u5b58\u7a7a\u95f4\u6bd4\u8f83\u5927, \u90a3\u4e48\u5c06\u5b9e\u9645\u6570\u636e\u5b58\u653e\u5728\u5806\u4e0a</li> <li>\u64cd\u4f5c\u4e0aFIFO,\u90a3\u4e48 \u4f7f\u7528\u4e00\u4e2a\u6570\u7ec4\u6765\u5b58\u6570\u636e ,\u73af\u5f62\u7684<ol> <li>\u9700\u8981\u4e00\u4e2a\u7d22\u5f15\u6307\u51fa\u4e0b\u4e00\u4e2a\u8bfb\u7684\u4e0b\u6807\u4f4d\u7f6e</li> <li>\u9700\u8981\u4e00\u4e2a\u7d22\u5f15\u6307\u51fa\u4e0b\u4e00\u4e2a\u5199\u7684\u4e0b\u6807\u4f4d\u7f6e</li> </ol> </li> <li>\u9700\u8981\u5b58\u50a8\u7684\u5143\u7d20\u7684\u7c7b\u578b\u4fe1\u606f</li> <li>\u7ebf\u7a0b\u5b89\u5168\u7684, \u90a3\u4e48\u80af\u5b9a\u6709\u9501\u8fd9\u6837\u7684\u4e1c\u897f</li> <li>\u7f13\u51b2\u533a\u4e3a\u7a7a\u65f6,\u5728\u8bfb\u8fd9\u4e2achan\u7684goroutine\u4f1a\u963b\u585e, \u5f53chan \u6709\u6570\u636e\u65f6,\u4f1a\u5f00\u59cb\u8bfb\u53d6\u6570\u636e,\u6240\u4ee5chan\u9700\u8981\u77e5\u9053\u8c01\u5728\u7b49\u5f85\u8bfb\u81ea\u5df1</li> <li>\u5f53\u7f13\u51b2\u533a\u6ee1\u4e86\u540e,\u5f80chan\u5199\u6570\u636e\u7684goroutine \u5c31\u4f1a\u963b\u585e,\u7b49\u7a7a\u51fa\u4f4d\u7f6e\u4e86, \u4e4b\u524d\u963b\u585e\u7684goroutine \u4f1a\u91cd\u65b0\u5f00\u59cb\u5199\u6570\u636e,\u6240\u4ee5\u9700\u8981\u77e5\u9053\u8c01\u5728\u7b49\u5f85\u5199\u8be5chan</li> <li>close \u64cd\u4f5c\u540e, \u4e0d\u80fd\u5199\u5165\u6570\u636e\u4e86, \u9700\u8981\u8bb0\u5f55 \u662f\u5426close\u7684\u4fe1\u606f</li> </ol> \u67e5\u770b\u6c47\u7f16\u77e5\u9053 runtime.makechan<pre><code>type hchan struct {\nqcount   uint           // \u5f53\u524d\u5b58\u653e\u7684\u5143\u7d20\u4e2a\u6570\ndataqsiz uint           // \u6570\u7ec4\u7684\u5bb9\u91cf\nbuf      unsafe.Pointer // \u6570\u7ec4\u7684\u5730\u5740\nelemsize uint16 closed   uint32  // \nelemtype *_type // element type\nsendx    uint   // \u4e0b\u4e00\u4e2a\u5199\u7684\u4e0b\u6807\nrecvx    uint   // \u4e0b\u4e00\u4e2a\u8bfb\u7684\u4e0b\u6807\nrecvq    waitq  // \u8bfb\u7b49\u5f85\u961f\u5217\nsendq    waitq  // \u5199\u7b49\u5f85\u961f\u5217\nlock mutex  // \u9501\n}\n</code></pre>"},{"location":"go/concurrency/channel/#recvqsendq","title":"recvq\u548csendq\u4f55\u65f6\u6709\u6570\u636e","text":"<p>Tip</p> <ol> <li>\u6709\u7f13\u51b2chan,\u7f13\u51b2\u533a\u6ee1\u4e86,\u8fd8\u5f80\u91cc\u5199\u7684goroutine \u4f1a\u52a0\u5165 sendq \u961f\u5217</li> <li>\u6709\u7f13\u51b2chan,\u7f13\u51b2\u533a\u7a7a\u7684,\u4ecech\u91cc\u8bfb\u7684goroutine \u4f1a\u52a0\u5165 recvq \u961f\u5217</li> <li>\u65e0\u7f13\u51b2chan,\u65e0\u4eba\u63a5\u6536\u65f6,\u5f80\u91cc\u5199\u7684goroutine \u4f1a\u52a0\u5165 sendq \u961f\u5217</li> <li>\u65e0\u7f13\u51b2chan,\u65e0\u4eba\u5199\u5165\u65f6,\u4ecech\u91cc\u8bfb\u7684goroutine \u4f1a\u52a0\u5165 recvq \u961f\u5217</li> </ol> \u7528\u4e8e\u68c0\u9a8csendq\u548crecvq\u7684demo<pre><code>package test\nimport (\n\"bytes\"\n\"fmt\"\n\"runtime\"\n\"strconv\"\n\"testing\"\n\"time\"\n\"unsafe\"\n)\ntype hchan struct {\nqcount   uint\ndataqsiz uint\nbuf      unsafe.Pointer\nelemsize uint16\nclosed   uint32\nelemtype *int64\nsendx    uint recvx    uint\nrecvq    waitq sendq    waitq\n}\ntype waitq struct {\nfirst *sudog\nlast  *sudog\n}\ntype sudog struct {\ng    *g\nnext *sudog\nprev *sudog\n}\ntype g struct {\n// \u901a\u8fc7\u6e90\u7801g \u7684\u7ed3\u6784, \u524d\u9762\u5b57\u6bb5\u5360\u7528\u7684\u5b57\u8282.\n// \u7248\u672c\u4e0d\u4e00\u6837\u53ef\u80fd \u8fd9\u91cc\u4e5f\u4f1a\u4e0d\u4e00\u6837.\ntmp  [19]uint64\ngoid uint64\n}\n// \u83b7\u53d6 goroutine \u7684id\nfunc GetGID() uint64 {\nb := make([]byte, 64)\nb = b[:runtime.Stack(b, false)]\nb = bytes.TrimPrefix(b, []byte(\"goroutine \"))\nb = b[:bytes.IndexByte(b, ' ')]\nn, _ := strconv.ParseUint(string(b), 10, 64)\nreturn n\n}\nfunc TestMain(t *testing.T) {\nfmt.Println(\"\u4e3b goroutine:\", GetGID())\n// ch := make(chan int) \u65e0\u7f13\u51b2\u9a8c\u8bc1\nch := make(chan int, 5)\nchAddr := *(*uintptr)(unsafe.Pointer(&amp;ch))\ngo func() {\nfmt.Println(\"\u8fd9\u4e2agoroutine A\u7684 id:\", GetGID())\nfor i := 0; i &lt; 10; i++ {\ntime.Sleep(50 * time.Millisecond)\nch &lt;- i\n}\n}()\ngo func() {\ntime.Sleep(1 * time.Second)\nfmt.Println(\"\u8fd9\u4e2agoroutine B\u7684 id:\", GetGID())\nfor i := 11; i &lt; 20; i++ {\ntime.Sleep(50 * time.Millisecond)\nch &lt;- i\n}\n}()\ngo func() {\nfor {\nhchanData := *(*hchan)(unsafe.Pointer(chAddr))\nfmt.Println(hchanData)\nif hchanData.sendq.first != nil {\nfmt.Println(\"hchan\u7ed3\u6784\u91ccsendq\u5b58\u7684 first goroutine id: \", hchanData.sendq.first.g.goid)\nif hchanData.sendq.first.next != nil {\nfmt.Println(\"hchan\u7ed3\u6784\u91ccsendq\u5b58\u7684first goroutine id -&gt;next: \", hchanData.sendq.first.next.g.goid)\n}\n}\nif hchanData.sendq.last != nil {\nfmt.Println(\"hchan\u7ed3\u6784\u91ccsendq\u5b58\u7684last goroutine id: \", hchanData.sendq.last.g.goid)\nif hchanData.sendq.last.prev != nil {\nfmt.Println(\"hchan\u7ed3\u6784\u91ccsendq\u5b58\u7684last goroutine id -&gt;prev: \", hchanData.sendq.last.prev.g.goid)\n}\n}\n// for select case \u5904\u8bfb\u53d6chan, \u5230\u6ca1\u6709\u5143\u7d20\u4e86,\u5c31\u4f1a\u5728recvq\u6dfb\u52a0\u8bfb\u53d6\u5b83goroutine\nif hchanData.recvq.first != nil {\nfmt.Println(\"\u5f53\u524dch \u7684\u5143\u7d20\u4e2a\u6570:\", len(ch))\n// \u4e3b\u534f\u7a0b \u6700\u540e\u4e00\u76f4\u7b49\u5f85\u8bfb\u53d6 chan\nfmt.Println(\"hchan\u7ed3\u6784\u91cc recvq \u5b58\u7684first goroutine id: \", hchanData.recvq.first.g.goid)\nclose(ch)\n}\ntime.Sleep(1 * time.Second)\n}\n}()\ntime.Sleep(5 * time.Second)\nLoop:\nfor {\nselect {\ncase c, ok := &lt;-ch:\nif !ok {\nbreak Loop\n}\nfmt.Println(c)\n}\ntime.Sleep(500 * time.Millisecond)\n}\n}\n</code></pre>"},{"location":"go/concurrency/channel/#runtimechansend1","title":"\u5199 runtime.chansend1","text":"<p><pre><code>func chansend1(c *hchan, elem unsafe.Pointer) {\nchansend(c, elem, true, getcallerpc())\n}\n</code></pre> <pre><code>func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool {\nif c == nil {\nif !block {\nreturn false\n}\n//chan\u662fnil\u7684\u60c5\u51b5, \u76f4\u63a5 \u963b\u585e\ngopark(nil, nil, waitReasonChanSendNilChan, traceEvGoStop, 2)\nthrow(\"unreachable\")\n}\n// ...\nif !block &amp;&amp; c.closed == 0 &amp;&amp; full(c) {\nreturn false\n}\nvar t0 int64\nif blockprofilerate &gt; 0 {\nt0 = cputicks()\n}\n// \u51c6\u5907\u5f00\u59cb\u53d1\u9001\u6570\u636e,\u5148\u52a0\u9501\nlock(&amp;c.lock)\nif c.closed != 0 {\nunlock(&amp;c.lock)\npanic(plainError(\"send on closed channel\"))  // (1)\n}\n// \u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u6709\u63a5\u6536\u8005\u5728\u7b49\u5f85\u6570\u636e,\u90a3\u4e48\u76f4\u63a5\u53d1\u7ed9\u5b83,\u4e0d\u7528\u5199\u5165\u7f13\u51b2\u533a\n// \u63a5\u6536\u8005\u5728\u7b49\u5f85\u610f\u5473\u7740\u7f13\u51b2\u533a\u91cc\u672c\u8eab\u662f\u6ca1\u6570\u636e\u7684\nif sg := c.recvq.dequeue(); sg != nil {\nsend(c, sg, ep, func() { unlock(&amp;c.lock) }, 3)\nreturn true\n}\n// \u5982\u679c\u7f13\u51b2\u533a\u6709\u7a7a\u4f59\u7684\u60c5\u51b5\nif c.qcount &lt; c.dataqsiz {\nqp := chanbuf(c, c.sendx)\nif raceenabled {\nracenotify(c, c.sendx, nil)\n}\ntypedmemmove(c.elemtype, qp, ep)\nc.sendx++\nif c.sendx == c.dataqsiz {\nc.sendx = 0\n}\nc.qcount++\nunlock(&amp;c.lock)\nreturn true\n}\nif !block {\nunlock(&amp;c.lock)\nreturn false\n}\n// \u8d70\u5230\u8fd9\u91cc\u7684\u8bdd, \u610f\u5473\u7740\u7f13\u51b2\u6ca1\u7a7a\u4f59\u4e14\u65e0\u63a5\u6536\u8005,\u8fd9\u4e2a\u65f6\u5019\u5c31\u662f \u6dfb\u52a0\u5230sendq\ngp := getg()\nmysg := acquireSudog()\nmysg.releasetime = 0\nif t0 != 0 {\nmysg.releasetime = -1\n}\nmysg.elem = ep\nmysg.waitlink = nil\nmysg.g = gp\nmysg.isSelect = false\nmysg.c = c\ngp.waiting = mysg\ngp.param = nil\nc.sendq.enqueue(mysg)\ngp.parkingOnChan.Store(true)\ngopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanSend, traceEvGoBlockSend, 2)\nKeepAlive(ep)\n// someone woke us up.\nif mysg != gp.waiting {\nthrow(\"G waiting list is corrupted\")\n}\ngp.waiting = nil\ngp.activeStackChans = false\nclosed := !mysg.success\ngp.param = nil\nif mysg.releasetime &gt; 0 {\nblockevent(mysg.releasetime-t0, 2)\n}\nmysg.c = nil\nreleaseSudog(mysg)\nif closed {\nif c.closed == 0 {\nthrow(\"chansend: spurious wakeup\")\n}\npanic(plainError(\"send on closed channel\"))\n}\nreturn true\n}\n</code></pre></p> <ol> <li>\u6d4b\u8bd5\u4ee3\u7801      <pre><code>// \u6267\u884c\u4f1a\u62a5\u9519 panic: send on closed channel\nfunc TestSendToCloseChan(t *testing.T) {\nch := make(chan int, 2)\nch &lt;- 1\nclose(ch)\nch &lt;- 2\n}\n</code></pre></li> </ol>"},{"location":"go/concurrency/channel/#runtimechanrecv1","title":"\u8bfb runtime.chanrecv1","text":""},{"location":"go/concurrency/context/","title":"context","text":"","tags":["Go"]},{"location":"go/concurrency/context/#background-todo","title":"Background &amp; TODO","text":"<pre><code>var (\nbackground = new(emptyCtx)\ntodo       = new(emptyCtx)\n)\n// Background returns a non-nil, empty Context. It is never canceled, has no\n// values, and has no deadline. It is typically used by the main function,\n// initialization, and tests, and as the top-level Context for incoming\n// requests.\n// \u4f5c\u4e3a\u521d\u59cb\u7684ctx,\u662f\u8d77\u70b9\u65f6\u4f7f\u7528\u8fd9\u4e2a\u6765\u5b9e\u4f8b\u5316,\u7136\u540e\u4f20\u9012\u7ed9\u540e\u7eed\u7684\nfunc Background() Context {\nreturn background\n}\n// TODO returns a non-nil, empty Context. Code should use context.TODO when\n// it's unclear which Context to use or it is not yet available (because the\n// surrounding function has not yet been extended to accept a Context\n// parameter).\n// \u4e0d\u662f\u8d77\u70b9\u65f6,\u7136\u540e\u4f60\u6682\u65f6\u4e0d\u77e5\u9053\u4f7f\u7528\u54ea\u4e2acontext,\u4ee3\u7801\u91cc\u5c31\u6682\u65f6\u5199\u4e0a,\n// \u628aTODO\u4f5c\u4e3a\u65b9\u6cd5 \u53ef\u4ee5\u8bf4\u5176\u5b9e\u5c31\u8868\u660e\u4e86\u4e4b\u540e\u903b\u8f91\u5f04\u5b8c\u540e,\u4f60\u5e94\u8be5\u518d\u6765\u770b\u770b\u5177\u4f53\u662f\u4f7f\u7528\u4ec0\u4e48\nfunc TODO() Context {\nreturn todo\n}\n</code></pre>","tags":["Go"]},{"location":"go/concurrency/context/#withvalue","title":"WithValue","text":"<pre><code>package test\nimport (\n\"context\"\n\"fmt\"\n\"testing\"\n\"time\"\n)\nfunc TestWithValue(t *testing.T) {\nctx := context.Background()\nparent := context.WithValue(ctx, \"name\", \"tom\")\nson := context.WithValue(parent, \"age\", \"11\")\nfmt.Println(parent.Value(\"name\"))\nfmt.Println(parent.Value(\"age\")) // nil \u65e0\u6cd5\u83b7\u53d6\u5b50ctx \u8bbe\u7f6e\u7684key\nfmt.Println(son.Value(\"name\"))\n}\n// \u6211\u4eec\u4e00\u822c\u662f\u4e0d\u4f1a\u8fd9\u4e48\u505a\u7684\nfunc TestWithValueMap(t *testing.T) {\nctx := context.Background()\nparent := context.WithValue(ctx, \"m\", map[string]string{\"name\": \"tom\"})\nm := parent.Value(\"m\").(map[string]string)\nm[\"age\"] = \"11\"\nson := context.WithValue(parent, \"m\", m)\nfmt.Println(parent.Value(\"m\").(map[string]string)[\"name\"])\n// \u7236 ctx \u83b7\u53d6 \u5b50 ctx \u8bbe\u7f6e\u7684key\nfmt.Println(parent.Value(\"m\").(map[string]string)[\"age\"])\nfmt.Println(son.Value(\"m\").(map[string]string)[\"name\"])\n}\n</code></pre>","tags":["Go"]},{"location":"go/concurrency/context/#withcancel","title":"WithCancel","text":"<p>Tip</p> <p>\u7236ctx cancel\u6216\u8d85\u65f6, \u6240\u6709\u5b50\u5b59ctx\u90fd\u4f1acancel\u6216\u8d85\u65f6</p> <pre><code>package test\nimport (\n\"context\"\n\"fmt\"\n\"testing\"\n\"time\"\n)\n// \u524d\u9762timeout \u53ef\u4ee5\u8bf4\u662f\u5230\u671f\u4f1a\u81ea\u52a8cancel\n// \u8fd9\u91cc\u662f\u9700\u8981\u6211\u4eec\u4e3b\u52a8 cancel ,\u7528\u6765\u63a7\u5236\u94fe\u8def\u6d41\u7a0b,\u6bd4\u5982\u63a7\u5236\u5b50goroutine \u9000\u51fa\nfunc TestWithCancel(t *testing.T) {\nctx, cancel := context.WithCancel(context.Background())\ngo func(context.Context) {\ngo func(context.Context) {\nc, cancelSon := context.WithCancel(ctx)\ndefer cancelSon()\nLoop:\nfor {\nselect {\ncase &lt;-c.Done(): // \u7236ctx cancel \u4f1a\u5bfc\u81f4\u5b50ctx \u4e5fcancel\nfmt.Println(\"gorouting2 is done\")\n// context canceled ,\u5f88\u660e\u661f, cancelSon() \u662f\u6ca1\u6267\u884c\u7684. \u4f46\u662ferr \u4fe1\u606f\u662f\nfmt.Println(c.Err())\nbreak Loop\ndefault:\n}\nfmt.Println(\"gorouting2 is running\")\ntime.Sleep(time.Second)\n}\n}(ctx)\nLoop:\nfor {\nselect {\ncase &lt;-ctx.Done():\nfmt.Println(\"gorouting1 is done\")\nbreak Loop\ndefault:\n}\nfmt.Println(\"gorouting1 is running\")\ntime.Sleep(time.Second)\n}\n}(ctx)\ntime.Sleep(3 * time.Second)\n// \u4e3b\u52a8\u53d6\u6d88\ncancel()\nfmt.Println(\"cancel...\")\ntime.Sleep(3 * time.Second)\n}\n</code></pre> <pre><code>// A cancelCtx can be canceled. When canceled, it also cancels any children\n// that implement canceler.\ntype cancelCtx struct {\nContext\nmu       sync.Mutex            // protects following fields\ndone     atomic.Value          // of chan struct{}, created lazily, closed by first cancel call\nchildren map[canceler]struct{} // set to nil by the first cancel call\nerr      error                 // set to non-nil by the first cancel call\ncause    error                 // set to non-nil by the first cancel call\n}\nfunc withCancel(parent Context) *cancelCtx {\nif parent == nil {\npanic(\"cannot create context from nil parent\")\n}\nc := newCancelCtx(parent)\npropagateCancel(parent, c)\nreturn c\n}\nfunc newCancelCtx(parent Context) *cancelCtx {\nreturn &amp;cancelCtx{Context: parent}\n}\n// \u7236 cancel\u540e, \u5c06cancel \u4f20\u9012\u7ed9\u5b50\u5b59 (\u5b50\u5b59\u4e5fcancel)\nfunc propagateCancel(parent Context, child canceler) {\ndone := parent.Done()\nif done == nil {\n// WithValue \u7684done() \u662fnil\nreturn\n}\nselect {\ncase &lt;-done:\n// \u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u7236 ctx cancel \u4e86\n// \u5219\u8c03\u7528\u5b50\u5b59\u7684cancel, \u5c06 \u7236ctx\u7684Err,\u4ee5\u53ca\u8c01\u5f15\u53d1\u7684\u4f20\u9012\nchild.cancel(false, parent.Err(), Cause(parent))\nreturn\ndefault: // \u56e0\u4e3a\u6709default \u6240\u4ee5\u5982\u679c &lt;-done \u6ca1\u6709\u6570\u636e,\u5c31\u4f1a\u7acb\u9a6c\u7ed3\u675f,\u8d70\u540e\u9762\u7684\u4ee3\u7801\n}\nif p, ok := parentCancelCtx(parent); ok {\n// \u5982\u679c\u627e\u5230\u6700\u8fd1\u4e00\u4e2a\u662fcancelCtx \u7684\u7956\u5148context\np.mu.Lock()\nif p.err != nil {\n// \u518d\u6b21\u5224\u65ad\n// \u5982\u679c\u7236ctx \u8fd9\u4e2a\u65f6\u5019cancel\u540e, \u90a3\u4e48\u76f4\u63a5cancel \u5b50ctx\nchild.cancel(false, p.err, p.cause)\n} else {\nif p.children == nil {\np.children = make(map[canceler]struct{})\n}\n// \u8bbe\u7f6echildren ,\u5b50 ctx, \u5185\u5bb9\u662f \u7a7a\u7ed3\u6784\u4f53\u7701\u5185\u5b58\n// \u540e\u9762\u6211\u4eec\u53ea\u9700\u8981key ctx \u5c31\u884c\n// \u540e\u7eed \u7236cancel\u65f6,\u9700\u8981cancel \u6240\u6709children \u7528\u5230\np.children[child] = struct{}{}\n}\np.mu.Unlock()\n} else {\n// \ngoroutines.Add(1)\ngo func() {\nselect {\ncase &lt;-parent.Done(): // \nchild.cancel(false, parent.Err(), Cause(parent)) //(1)\ncase &lt;-child.Done(): // \u5173\u5fc3\u81ea\u5df1\n}\n}()\n}\n}\n</code></pre> <ol> <li>\u4ee3\u7801     <pre><code>for child := range c.children {\nchild.cancel(false, err, cause)\n}\n</code></pre></li> </ol> <pre><code>// \u5982\u679cparent\u662fcancelCtx,\u5219\u8fd4\u56deparent ctx\u7684\u6307\u9488\n// \u5982\u679c\u4e0d\u662fcancelCtx (\u6bd4\u5982WithValue \u8fd4\u56de\u7684ctx),\u5219\u7ee7\u7eed\u5f80\u524d\u627e,\u627e\u5230\u6700\u8fd1\u7684\u7956\u5148cancelCtx\nfunc parentCancelCtx(parent Context) (*cancelCtx, bool) {\ndone := parent.Done()\nif done == closedchan || done == nil {\nreturn nil, false\n}\np, ok := parent.Value(&amp;cancelCtxKey).(*cancelCtx) //(1)\nif !ok {\nreturn nil, false\n}\npdone, _ := p.done.Load().(chan struct{})\nif pdone != done {\nreturn nil, false\n}\nreturn p, true\n}\n</code></pre> <ol> <li>\u4ee3\u7801     <pre><code>func (c *valueCtx) Value(key any) any {\nif c.key == key {\nreturn c.val\n}\nreturn value(c.Context, key)\n}\nfunc (c *cancelCtx) Value(key any) any {\nif key == &amp;cancelCtxKey {\nreturn c\n}\nreturn value(c.Context, key)\n}\n</code></pre></li> </ol>","tags":["Go"]},{"location":"go/concurrency/context/#withdeadlinetimeout","title":"WithDeadline/Timeout","text":"<p><pre><code>// A timerCtx carries a timer and a deadline. It embeds a cancelCtx to\n// implement Done and Err. It implements cancel by stopping its timer then\n// delegating to cancelCtx.cancel.\ntype timerCtx struct {\n*cancelCtx\ntimer *time.Timer // Under cancelCtx.mu.\ndeadline time.Time\n}\n// WithTimeout \u91cc\u9762\u76f4\u63a5\u8c03\u7528\u4e86 WithDeadline , \u548c\u5b83\u6ca1\u5565\u533a\u522b\nfunc WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) {\nreturn WithDeadline(parent, time.Now().Add(timeout))\n}\nfunc WithDeadline(parent Context, d time.Time) (Context, CancelFunc) {\nif parent == nil {\npanic(\"cannot create context from nil parent\")\n}\nif cur, ok := parent.Deadline(); ok &amp;&amp; cur.Before(d) {\n// The current deadline is already sooner than the new one.\nreturn WithCancel(parent)\n}\nc := &amp;timerCtx{\ncancelCtx: newCancelCtx(parent),\ndeadline:  d,\n}\npropagateCancel(parent, c)\ndur := time.Until(d)\nif dur &lt;= 0 {\nc.cancel(true, DeadlineExceeded, nil) // deadline has already passed\nreturn c, func() { c.cancel(false, Canceled, nil) }\n}\nc.mu.Lock()\ndefer c.mu.Unlock()\nif c.err == nil {\nc.timer = time.AfterFunc(dur, func() {\nc.cancel(true, DeadlineExceeded, nil)\n})\n}\nreturn c, func() { c.cancel(true, Canceled, nil) }\n}\n</code></pre> <pre><code>package test\nimport (\n\"context\"\n\"fmt\"\n\"testing\"\n\"time\"\n)\nfunc TestWithTimeout(t *testing.T) {\nctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)\ndefer cancel()\ndl, isSetDl := ctx.Deadline()\nfmt.Printf(\"\u9884\u8ba1\u7684\u8fc7\u671f\u65f6\u95f4: %s \\n\u662f\u5426\u8bbe\u7f6e\u4e86\u8fc7\u671f\u65f6\u95f4:%t\\n\", dl, isSetDl) // \u9884\u8ba1\u7684\u8fc7\u671f\u65f6\u95f4\n_, isSetDl2 := context.Background().Deadline()\nfmt.Println(isSetDl2) // false\nnow := time.Now()\ngo func() {\n// \u5230\u671f\u540e, Done() \u7ba1\u9053\u4f1a\u6709\u6570\u636e\n&lt;-ctx.Done()\n// \u5230\u671f\u7684\u60c5\u51b5\u65f6 \u9519\u8bef\u4fe1\u606f\nfmt.Println(\"err\", ctx.Err()) // err context deadline exceeded\nfmt.Println(\"\u7ecf\u8fc7\", time.Since(now), time.Now())\n}()\ntime.Sleep(4 * time.Second)\n}\nfunc TestWithTimeout2(t *testing.T) {\nctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)\ndefer cancel()\n// \u8d85\u65f6 \u8bbe\u7f6e\u65e0\u6548\u7684,\u7236ctx\u8d85\u65f6\u4e86, \u5b50\u5b59\u4e5f\u8d85\u65f6\u4e86.\ns, c := context.WithTimeout(ctx, 5*time.Second)\ndefer c()\ngo func() {\n&lt;-s.Done()\nfmt.Println(\"s:\", s.Err())\n}()\ngo func() {\n// \u5230\u671f\u540e, Done() \u7ba1\u9053\u4f1a\u6709\u6570\u636e\n&lt;-ctx.Done()\n// \u5230\u671f\u7684\u60c5\u51b5\u65f6 \u9519\u8bef\u4fe1\u606f\nfmt.Println(\"err\", ctx.Err()) // err context deadline exceeded\n}()\ntime.Sleep(7 * time.Second)\n}\nfunc TestWithTimeoutCancel(t *testing.T) {\nctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)\nnow := time.Now()\ngo func() {\n// \u4e3b\u52a8\u6267\u884ccancel()\u540e, Done() \u7ba1\u9053\u4f1a\u6709\u6570\u636e\n&lt;-ctx.Done()\nerr := ctx.Err()\nfmt.Println(\"err\", err) // err context canceled\nswitch err {\n// \u5224\u65ad\u9519\u8bef\u7c7b\u578b\ncase context.Canceled:\ncase context.DeadlineExceeded:\n}\nfmt.Println(\"\u7ecf\u8fc7\", time.Since(now))\n}()\ntime.Sleep(1 * time.Second)\ncancel()\ntime.Sleep(3 * time.Second)\n}\n</code></pre></p> <pre><code>func TestWithDeadline(t *testing.T) {\nctx, cancel := context.WithDeadline(context.Background(), time.Now().Add(3*time.Second))\ndefer cancel()\nfmt.Println(ctx)\n}\n</code></pre>","tags":["Go"]},{"location":"go/concurrency/goroutine/","title":"goroutine","text":"<p>Tip</p> <p>TODO</p>"},{"location":"go/concurrency/goroutine/#goroutine","title":"goroutine\u4e0e\u7ebf\u7a0b","text":"<ol> <li>goroutine \u662f\u7528\u6237\u6001\u7ebf\u7a0b, \u9700\u8981\u7531\u81ea\u5df1\u7684\u8c03\u5ea6\u7a0b\u5e8f</li> <li>\u5185\u6838\u6001\u7ebf\u7a0b\u7531\u64cd\u4f5c\u7cfb\u7edf\u8c03\u5ea6</li> </ol>"},{"location":"go/concurrency/goroutine/#gpm","title":"GPM","text":"<pre><code>go build -o main -gcflags \"-N -l\" main.go\nobjdump -t  main|grep -v '.text'| grep -E 'g0|m0'\n</code></pre>"},{"location":"go/infrastructure/clean-code/","title":"\u7f16\u7801\u89c4\u8303","text":"<p>Warning</p> <p>\u5f85\u6574\u7406...</p>"},{"location":"go/infrastructure/clean-code/#_1","title":"\u6ce8\u91ca","text":"<p>\u5bf9\u8c61\u58f0\u660e\u7684\u6ce8\u91ca\u5e94\u8be5\u662f\u5b8c\u6574\u7684\u53e5\u5b50,\u5373\u4f7f\u8fd9\u770b\u8d77\u6765\u6709\u70b9\u591a\u4f59. \u5f53\u63d0\u53d6\u5230doc\u6587\u6863\u4e2d\u65f6,\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u4f7f\u5b83\u4eec\u683c\u5f0f\u5316\u826f\u597d. \u6ce8\u91ca\u5e94\u4ee5\u6240\u63cf\u8ff0\u4e8b\u7269\u7684\u540d\u79f0\u5f00\u5934,\u5e76\u4ee5\u53e5\u70b9\u7ed3\u5c3e <pre><code>// Request represents a request to run a command.\ntype Request struct { ...\n// Encode writes the JSON encoding of req to w.\nfunc Encode(w io.Writer, req *Request) { ...\n</code></pre></p>"},{"location":"go/infrastructure/clean-code/#context","title":"Context","text":"<p>Warning</p> <p>\u5927\u591a\u6570\u4f7f\u7528Context\u7684\u51fd\u6570\u90fd\u5e94\u5c06\u5176\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u53c2\u6570 \u4e0d\u8981\u5c06Context\u6210\u5458\u6dfb\u52a0\u5230\u7ed3\u6784\u7c7b\u578b, \u5e94\u8be5\u5c06ctx\u53c2\u6570\u6dfb\u52a0\u5230\u8be5\u7c7b\u578b\u9700\u8981\u4f20\u9012\u7684\u6bcf\u4e2a\u65b9\u6cd5\u4e0a</p> <pre><code>func F(ctx context.Context, /* other arguments */) {}\n</code></pre>"},{"location":"go/infrastructure/clean-code/#crypto-rand","title":"Crypto Rand","text":"<p>\u4e0d\u8981\u4f7f\u7528\u8f6f\u4ef6\u5305 math/rand \u751f\u6210\u5bc6\u94a5\uff0c\u5373\u4f7f\u662f\u4e00\u6b21\u6027\u5bc6\u94a5\u4e5f\u662f\u5982\u6b64\u3002 \u5728\u6ca1\u6709\u79cd\u5b50\u60c5\u51b5\u4e0b\uff0c\u751f\u6210\u5668\u662f\u5b8c\u5168\u53ef\u9884\u6d4b\u7684\u3002 \u5c06time.Nanoseconds()\u7684\u4f5c\u4e3a\u968f\u673a\u751f\u6210\u5668\u7684\u79cd\u5b50\uff0c\u53ea\u6709\u51e0\u71b5\uff08\u5e94\u8be5\u662f\u6d88\u8017\u5f88\u5c11\u7684\u610f\u601d\uff09\u3002 \u76f8\u53cd\uff0c\u8bf7\u4f7f\u7528 crypto/rand's Reader\uff0c\u5982\u679c\u9700\u8981\u6587\u672c\uff0c\u8bf7\u6253\u5370\u4e3a\u5341\u516d\u8fdb\u5236\u6216base64 <pre><code>import (\n\"crypto/rand\"\n// \"encoding/base64\"\n// \"encoding/hex\"\n\"fmt\"\n)\nfunc Key() string {\nbuf := make([]byte, 16)\n_, err := rand.Read(buf)\nif err != nil {\npanic(err)  // out of randomness, should never happen\n}\nreturn fmt.Sprintf(\"%x\", buf)\n// or hex.EncodeToString(buf)\n// or base64.StdEncoding.EncodeToString(buf)\n}\n</code></pre></p>"},{"location":"go/infrastructure/clean-code/#_2","title":"\u58f0\u660e\u7a7a\u5207\u7247","text":"<p>\u58f0\u660e\u7a7a\u5207\u7247\u65f6\uff0c\u9996\u9009</p> <pre><code>var t []string </code></pre> <p>\u5176\u6b21</p> <p><pre><code>t := []string{}\n</code></pre> \u524d\u8005\u58f0\u660enil slice\u503c\uff0c\u800c\u540e\u8005\u58f0\u660e\u975enil\u4f46\u957f\u5ea6\u4e3a\u96f6\u3002 \u5b83\u4eec\u5728\u529f\u80fd\u4e0a\u7b49\u540c\uff0c\u4ed6\u4eec len\u548c cap\u5747\u4e3a\u96f6\uff0c\u800c\u96f6\u5207\u7247\u662f\u9996\u9009\u7684\u98ce\u683c\u3002</p>"},{"location":"go/infrastructure/clean-code/#_3","title":"\u9519\u8bef\u5b57\u7b26\u4e32","text":"<p>\u9519\u8bef\u5b57\u7b26\u4e32\u4e0d\u5e94\u5927\u5199\uff08\u9664\u975e\u4ee5\u4e13\u6709\u540d\u8bcd\u6216\u7f29\u5199\u5f00\u5934\uff09\u6216\u6807\u70b9\u7b26\u53f7\u7ed3\u675f\uff0c\u56e0\u4e3a\u5b83\u4eec\u901a\u5e38\u662f\u5728\u5176\u4ed6\u4e0a\u4e0b\u6587\u4e4b\u540e\u6253\u5370\u7684\u3002 \u4e5f\u5c31\u662f\u8bf4\uff0c\u8bf7\u4f7f\u7528 fmt.Errorf(\"something bad\")\uff0c\u4e0d\u8981\u4f7f\u7528 fmt.Errorf(\"Something bad\")\uff0c\u8fd9\u6837 log.Printf(\"Reading %s: %v\", filename, err)\u683c\u5f0f\u5c31\u4e0d\u4f1a\u51fa\u73b0\u865a\u5047\u7684\u5927\u5199\u5b57\u6bcd\u4e2d\u95f4\u6d88\u606f\u3002 \u8fd9\u4e0d\u9002\u7528\u4e8e\u65e5\u5fd7\u8bb0\u5f55\uff0c\u540e\u8005\u662f\u9690\u5f0f\u9762\u5411\u884c\u7684\uff0c\u5e76\u4e14\u672a\u5728\u5176\u4ed6\u6d88\u606f\u4e2d\u5408\u5e76\u3002</p>"},{"location":"go/infrastructure/clean-code/#goroutine","title":"Goroutine\u751f\u547d\u5468\u671f","text":"<p>\u5f53\u60a8\u751f\u6210goroutine\u65f6\uff0c\u8bf7\u6e05\u695a\u4f55\u65f6\u6216\u662f\u5426\u9000\u51fa\u3002 Goroutine\u53ef\u4ee5\u901a\u8fc7\u963b\u585e\u901a\u9053\u7684\u53d1\u9001\u6216\u63a5\u6536\u6765\u6cc4\u6f0f\uff1a\u5373\u4f7fgoroutine\u7684\u963b\u585e\u901a\u9053\u4e0d\u53ef\u8bbf\u95ee\uff0c\u5783\u573e\u6536\u96c6\u5668\u4e5f\u4e0d\u4f1a\u7ec8\u6b62goroutine\u3002 \u5373\u4f7fgoroutine\u4e0d\u4f1a\u6cc4\u6f0f\uff0c\u5728\u4e0d\u518d\u9700\u8981\u5b83\u4eec\u65f6\u4ecd\u5728\u98de\u884c\u4e2d\u4e5f\u4f1a\u5bfc\u81f4\u5176\u4ed6\u7ec6\u5fae\u4e14\u96be\u4ee5\u8bca\u65ad\u7684\u95ee\u9898\u3002 \u5728\u5173\u95ed\u7684\u901a\u9053\u4e0a\u53d1\u9001\u7d27\u6025\u6d88\u606f\u3002 \u201c\u5728\u4e0d\u9700\u8981\u7ed3\u679c\u4e4b\u540e\u201d\u4fee\u6539\u4ecd\u5728\u4f7f\u7528\u7684\u8f93\u5165\u4ecd\u7136\u4f1a\u5bfc\u81f4\u6570\u636e\u4e89\u7528\u3002 \u5c06goroutine\u8fdb\u884c\u4efb\u610f\u957f\u65f6\u95f4\u7684\u98de\u884c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e0d\u53ef\u9884\u6d4b\u7684\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\u3002 \u5c1d\u8bd5\u4f7f\u5e76\u53d1\u4ee3\u7801\u8db3\u591f\u7b80\u5355\uff0c\u4ee5\u4f7fgoroutine\u751f\u5b58\u671f\u663e\u800c\u6613\u89c1\u3002 \u5982\u679c\u90a3\u4e0d\u53ef\u884c\uff0c\u8bf7\u8bb0\u5f55goroutine\u4f55\u65f6\u4ee5\u53ca\u4e3a\u4f55\u9000\u51fa\u3002</p>"},{"location":"go/infrastructure/clean-code/#imports","title":"Imports","text":"<p>\u9664\u907f\u514d\u540d\u79f0\u51b2\u7a81\u5916\uff0c\u907f\u514d\u91cd\u547d\u540d\u5bfc\u5165\uff1b \u597d\u7684\u8f6f\u4ef6\u5305\u540d\u79f0\u4e0d\u9700\u8981\u91cd\u547d\u540d\u3002 \u53d1\u751f\u540d\u79f0\u51b2\u7a81\u65f6\uff0c\u6700\u597d\u91cd\u547d\u540d\u672c\u5730\u7684\u6216\u7279\u5b9a\u4e8e\u9879\u76ee\u7684\u5bfc\u5165\u3002 \u5bfc\u5165\u5305\u662f\u6309\u7ec4\u7ec4\u7ec7\u6392\u5e8f\u7684\uff0c\u7ec4\u4e4b\u95f4\u6709\u7a7a\u767d\u884c\u3002\u6807\u51c6\u5e93\u8f6f\u4ef6\u5305\u59cb\u7ec8\u5728\u7b2c\u4e00\u7ec4\u4e2d</p> <p>go imports \u5c06\u4e3a\u60a8\u505a\u5230\u8fd9\u4e00\u70b9</p>"},{"location":"go/infrastructure/clean-code/#import-blank","title":"Import Blank","text":"<p>\u4ec5\u51fa\u4e8e\u8f85\u52a9\u4f5c\u7528\u800c\u5bfc\u5165\u7684\u8f6f\u4ef6\u5305\uff08\u4f7f\u7528\u8bed\u6cd5import _\"pkg\"\uff09\u5e94\u4ec5\u5728\u7a0b\u5e8f\u7684\u4e3b\u8f6f\u4ef6\u5305\u6216\u9700\u8981\u5b83\u4eec\u7684\u6d4b\u8bd5\u4e2d\u5bfc\u5165\u3002</p>"},{"location":"go/infrastructure/clean-code/#import","title":"Import .","text":"<p>\u7531\u4e8e\u5faa\u73af\u4f9d\u8d56\u5173\u7cfb\uff0c\u5bfc\u5165 . \u5f62\u5f0f\u4e0d\u80fd\u7528\u4e8e\u8981\u6d4b\u8bd5\u7684\u7a0b\u5e8f\u5305\uff0c\u56e0\u6b64\u5728\u6d4b\u8bd5\u4e2d\u5f88\u6709\u7528 <pre><code>package foo_test\nimport (\n\"bar/testutil\" // also imports \"foo\"\n. \"foo\"\n)\n</code></pre></p>"},{"location":"go/infrastructure/clean-code/#in-band-errors","title":"In-Band Errors","text":"<p>\u5728C\u548c\u7c7b\u4f3c\u8bed\u8a00\u4e2d\uff0c\u51fd\u6570\u901a\u5e38\u8fd4\u56de-1\u8fd9\u6837\u7684\u503c\u6216null\u6765\u8868\u793a\u9519\u8bef\u6216\u6ca1\u6709\u7ed3\u679c <pre><code>// Lookup returns the value for key or \"\" if there is no mapping for key.\nfunc Lookup(key string) string\n// Failing to check a for an in-band error value can lead to bugs:\nParse(Lookup(key))  // returns \"parse failure for value\" instead of \"no value for key\"\n</code></pre> Go\u5bf9\u591a\u4e2a\u8fd4\u56de\u503c\u7684\u652f\u6301\u63d0\u4f9b\u4e86\u66f4\u597d\u7684\u89e3\u51b3\u65b9\u6848\u3002 \u51fd\u6570\u5e94\u8be5\u8fd4\u56de\u4e00\u4e2a\u9644\u52a0\u503c\u4ee5\u6307\u793a\u5176\u5176\u4ed6\u8fd4\u56de\u503c\u662f\u5426\u6709\u6548\uff0c\u800c\u4e0d\u662f\u8981\u6c42\u5ba2\u6237\u7aef\u68c0\u67e5\u5e26\u5185\u9519\u8bef\u503c\u3002 \u8be5\u8fd4\u56de\u503c\u53ef\u4ee5\u662f\u9519\u8bef\uff0c\u4e5f\u53ef\u4ee5\u662f\u5e03\u5c14\u503c\uff08\u4e0d\u9700\u8981\u8bf4\u660e\u65f6\uff09\u3002 \u5b83\u5e94\u8be5\u662f\u6700\u7ec8\u7684\u8fd4\u56de\u503c <pre><code>// Lookup returns the value for key or ok=false if there is no mapping for key.\nfunc Lookup(key string) (value string, ok bool)\n</code></pre> \u9f13\u52b1\u4f7f\u7528\u66f4\u5065\u58ee\u548c\u6613\u8bfb\u7684\u4ee3\u7801\uff1a <pre><code>value, ok := Lookup(key)\nif !ok {\nreturn fmt.Errorf(\"no value for %q\", key)\n}\nreturn Parse(value)\n</code></pre></p>"},{"location":"go/infrastructure/clean-code/#_4","title":"\u7f29\u8fdb\u9519\u8bef\u6d41","text":"<p>\u5c1d\u8bd5\u4f7f\u666e\u901a\u4ee3\u7801\u8def\u5f84\u4fdd\u6301\u6700\u5c0f\u7f29\u8fdb\uff0c\u5e76\u7f29\u8fdb\u9519\u8bef\u5904\u7406\uff0c\u5e76\u9996\u5148\u5bf9\u5176\u8fdb\u884c\u5904\u7406\u3002 \u901a\u8fc7\u5141\u8bb8\u5728\u89c6\u89c9\u4e0a\u5feb\u901f\u626b\u63cf\u6b63\u5e38\u8def\u5f84\uff0c\u53ef\u4ee5\u63d0\u9ad8\u4ee3\u7801\u7684\u53ef\u8bfb\u6027\u3002 \u4f8b\u5982\uff0c\u4e0d\u8981\u5199 <pre><code>if err != nil {\n// error handling\n} else {\n// normal code\n}\n</code></pre> \u5e94\u8be5\u5199\uff1a <pre><code>if err != nil {\n// error handling\nreturn // or continue, etc.\n}\n// normal code\n</code></pre> \u5982\u679c\u8be5 if\u8bed\u53e5\u5177\u6709\u521d\u59cb\u5316\u8bed\u53e5\uff0c\u4f8b\u5982\uff1a <pre><code>if x, err := f(); err != nil {\n// error handling\nreturn\n} else {\n// use x\n}\n</code></pre> \u90a3\u4e48\u8fd9\u53ef\u80fd\u9700\u8981\u5c06short\u53d8\u91cf\u58f0\u660e\u79fb\u81f3\u5176\u81ea\u5df1\u7684\u884c\uff1a \u8fd9\u6837\u7684\u76ee\u7684\u662f\u8ba9\u4e1a\u52a1\u4ee3\u7801\u80fd\u591f\u76f4\u63a5\u6e05\u6670\u7684\u770b\u5230 <pre><code>x, err := f()\nif err != nil {\n// error handling\nreturn\n}\n// use x\n</code></pre></p>"},{"location":"go/infrastructure/clean-code/#_5","title":"\u9996\u5b57\u6bcd\u7f29\u5199","text":"<p>\u540d\u79f0\u4e2d\u7684\u7f29\u5199\u8bcd\u6216\u9996\u5b57\u6bcd\u7f29\u5199\u8bcd\uff08\u4f8b\u5982\u201c URL\u201d\u6216\u201c NATO\u201d\uff09\u5177\u6709\u4e00\u81f4\u7684\u5927\u5c0f\u5199\u3002 \u4f8b\u5982\uff0c\u201c URL\u201d\u5e94\u663e\u793a\u4e3a\u201c URL\u201d\u6216\u201c url\u201d\uff08\u5982\u5728\u201c urlPony\u201d\u6216\u201c URLPony\u201d\u4e2d\u4e00\u6837\uff09\uff0c\u800c\u4ece\u4e0d\u663e\u793a\u4e3a\u201c Url\u201d\u3002 \u4f8b\u5982\uff1aServeHTTP\u800c\u4e0d\u662fServeHttp\u3002 \u5bf9\u4e8e\u5177\u6709\u591a\u4e2a\u5df2\u521d\u59cb\u5316\u201c\u5355\u8bcd\u201d\u7684\u6807\u8bc6\u7b26\uff0c\u8bf7\u4f7f\u7528\u201c xmlHTTPRequest\u201d\u6216\u201c XMLHTTPRequest\u201d\u3002 \u5f53\u201c ID\u201d\u662f\u201c identifier\u201d\u7684\u7f29\u5199\u65f6\uff0c\u8be5\u89c4\u5219\u4e5f\u9002\u7528\u4e8e\u201c ID\u201d\uff08\u8fd9\u5728\u51e0\u4e4e\u6240\u6709\u60c5\u51b5\u4e0b\u90fd\u4e0d\u662f\u201c ego\u201d\uff0c\u201c superego\u201d\u4e2d\u7684\u201c id\u201d\uff09\uff0c\u56e0\u6b64\u8bf7\u5199\u4e0a\u201c appID\u201d\u800c\u4e0d\u662f\u201c appId\u201d\u3002 \u534f\u8bae\u7f13\u51b2\u533a\u7f16\u8bd1\u5668\u751f\u6210\u7684\u4ee3\u7801\u4e0d\u53d7\u6b64\u89c4\u5219\u7ea6\u675f\u3002 \u4eba\u5de5\u7f16\u5199\u7684\u4ee3\u7801\u8981\u6bd4\u673a\u5668\u7f16\u5199\u7684\u4ee3\u7801\u5177\u6709\u66f4\u9ad8\u7684\u6807\u51c6\u3002</p>"},{"location":"go/infrastructure/clean-code/#interfaces","title":"\u63a5\u53e3\uff08Interfaces\uff09","text":"<p>Go\u63a5\u53e3\u901a\u5e38\u5c5e\u4e8e\u4f7f\u7528\u63a5\u53e3\u7c7b\u578b\u7684\u503c\u7684\u5305\u4e2d\uff0c\u800c\u4e0d\u662f\u5b9e\u73b0\u8fd9\u4e9b\u503c\u7684\u5305\u4e2d\u3002 \u5b9e\u73b0\u5305\u5e94\u8fd4\u56de\u5177\u4f53\u7684\uff08\u901a\u5e38\u662f\u6307\u9488\u6216\u7ed3\u6784\uff09\u7c7b\u578b\uff1a\u8fd9\u6837\uff0c\u53ef\u4ee5\u5c06\u65b0\u65b9\u6cd5\u6dfb\u52a0\u5230\u5b9e\u73b0\u4e2d\uff0c\u800c\u65e0\u9700\u8fdb\u884c\u5927\u91cf\u91cd\u6784\u3002 \u4e0d\u8981\u5728\u201c\u7528\u4e8e\u6a21\u62df\u201d\u7684API\u7684\u5b9e\u73b0\u65b9\u5b9a\u4e49\u63a5\u53e3\uff1b \u800c\u662f\u8bbe\u8ba1API\uff0c\u4ee5\u4fbf\u53ef\u4ee5\u4f7f\u7528\u5b9e\u9645\u5b9e\u73b0\u7684\u516c\u5171API\u5bf9\u5176\u8fdb\u884c\u6d4b\u8bd5\u3002 \u5728\u4f7f\u7528\u63a5\u53e3\u4e4b\u524d\uff0c\u4e0d\u8981\u5148\u5b9a\u4e49\u5b83\u4eec\uff1a\u5982\u679c\u6ca1\u6709\u5b9e\u9645\u7684\u7528\u6cd5\u793a\u4f8b\uff0c\u5f88\u96be\u77e5\u9053\u63a5\u53e3\u662f\u5426\u662f\u5fc5\u9700\u7684\uff0c\u66f4\u4e0d\u7528\u8bf4\u5b83\u5e94\u8be5\u5305\u542b\u4ec0\u4e48\u65b9\u6cd5\u4e86\u3002</p>"},{"location":"go/infrastructure/clean-code/#_6","title":"\u63a5\u53e3\u547d\u540d","text":"<p>\u6839\u636e\u547d\u540d\u89c4\u5219\uff0c\u4e00\u79cd\u65b9\u6cd5\u7684\u63a5\u53e3\uff0c\u9700\u8981\u5728\u540d\u79f0\u540e\u9762\u52a0\u4e0a -er \u7684\u540e\u7f00\uff0c\u6216\u8005\u901a\u8fc7\u4ee3\u7406\u540d\u8bcd\u7684\u65b9\u5f0f\u6765\u8fdb\u884c\u4fee\u9970\uff1aReader, Writer,Formatter,CloseNotifier \u7b49</p> <p>\u8fd9\u91cc\u6700\u9ebb\u70e6\u7684\u662f\uff0c\u4f60\u7684\u4e00\u4e2a\u63a5\u53e3\u6709\u591a\u4e2a\u65b9\u6cd5\u7684\u65f6\u5019\uff0c\u6309\u7167\u8fd9\u4e2a\u65b9\u5f0f\u547d\u540d\uff0c\u5c31\u4e0d\u603b\u662f\u5f88\u6e05\u6670\u660e\u4e86\u3002\u90a3\u662f\u5426\u8981\u628a\u7ed3\u6784\u62c6\u5206\uff0c\u53d8\u6210\u4e00\u4e2a\u63a5\u53e3\u5bf9\u5e94\u4e00\u4e2a\u65b9\u6cd5\u5462\uff1f\u6211\u89c9\u5f97\u8fd9\u4e2a\u53d6\u51b3\u5177\u4f53\u7684\u4f7f\u7528\u573a\u666f\u4e86\u3002 \u63a5\u53e3\u6211\u7684\u7406\u89e3: \u6309\u7406\u89e3\u6765\u8bf4\u5e94\u8be5\u540d\u5b57\u503e\u5411\u4e8e\u4e00\u79cd\u529f\u80fd\u7684\u540d\u5b57, \u5f53\u7136\u4e5f\u53ef\u4ee5\u662f\u4e00\u79cd\u4e1c\u897f\u7684\u540d\u5b57. \u4e00\u79cd\u7c7b\u578b\u4e00\u6837\u7684\u611f\u89c9</p> <ul> <li>\u547d\u540d\u89c4\u5219\u57fa\u672c\u548c\u4e0a\u9762\u7684\u7ed3\u6784\u4f53\u7c7b\u578b</li> <li> <p>\u5355\u4e2a\u51fd\u6570\u7684\u7ed3\u6784\u540d\u4ee5 \u201cer\u201d \u4f5c\u4e3a\u540e\u7f00\uff0c\u4f8b\u5982 Reader , Writer <pre><code>type Reader interface {\nRead(p []byte) (n int, err error)\n}\n</code></pre></p> </li> <li> <p>\u4e24\u4e2a\u51fd\u6570\u7684\u63a5\u53e3\u540d\u7efc\u5408\u4e24\u4e2a\u51fd\u6570\u540d</p> </li> </ul> <pre><code>type WriteFlusher interface {\nWrite([]byte) (int, error)\nFlush() error\n}\n</code></pre> <ul> <li>\u4e09\u4e2a\u4ee5\u4e0a\u51fd\u6570\u7684\u63a5\u53e3\u540d\uff0c\u7c7b\u4f3c\u4e8e\u7ed3\u6784\u4f53\u540d <pre><code>type Car interface {\nStart([]byte) Stop() error\nRecover()\n}\n</code></pre></li> </ul>"},{"location":"go/infrastructure/clean-code/#bool","title":"bool \u7c7b\u578b\u53d8\u91cf\u547d\u540d","text":"<p>\u540d\u79f0\u5e94\u4ee5 Has, Is, Can \u6216 Allow \u5f00\u5934 <pre><code>var isExist bool\nvar hasConflict bool\nvar canManage bool\nvar allowGitHook bool\n</code></pre></p>"},{"location":"go/infrastructure/clean-code/#_7","title":"\u5e38\u91cf\u547d\u540d","text":"<p>\u5e38\u91cf\u5747\u9700\u4f7f\u7528\u5168\u90e8\u5927\u5199\u5b57\u6bcd\u7ec4\u6210\uff0c\u5e76\u4f7f\u7528\u4e0b\u5212\u7ebf\u5206\u8bcd <pre><code>const APP_VER = \"1.0\"\n</code></pre></p>"},{"location":"go/infrastructure/clean-code/#_8","title":"\u884c\u957f\u5ea6","text":"<p>Go\u4ee3\u7801\u4e2d\u6ca1\u6709\u4e25\u683c\u7684\u884c\u957f\u5ea6\u9650\u5236\uff0c\u4f46\u8981\u907f\u514d\u884c\u592a\u957f\u3002 \u540c\u6837\uff0c\u8bf7\u52ff\u6dfb\u52a0\u6362\u884c\u7b26\u4ee5\u4f7f\u884c\u5728\u53ef\u8bfb\u6027\u66f4\u5f3a\u7684\u60c5\u51b5\u4e0b\u4fdd\u6301\u8f83\u77ed\uff08\u4f8b\u5982\uff0c\u5982\u679c\u5b83\u4eec\u662f\u91cd\u590d\u7684\uff09\u3002 \u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u4eba\u4eec\u201c\u4e0d\u81ea\u7136\u5730\u201d\u6362\u884c\uff08\u5728\u51fd\u6570\u8c03\u7528\u6216\u51fd\u6570\u58f0\u660e\u7684\u4e2d\u95f4\uff0c\u6216\u591a\u6216\u5c11\uff0c\u4f8b\u5982\uff0c\u5c3d\u7ba1\u5468\u56f4\u6709\u4e00\u4e9b\u4f8b\u5916\u60c5\u51b5\uff09\uff0c\u5982\u679c\u53c2\u6570\u548c\u7b80\u77ed\u7684\u53d8\u91cf\u540d\u6570\u91cf\u5408\u7406\uff0c\u5219\u4e0d\u9700\u8981\u6362\u884c\u3002\u957f\u884c\u4f3c\u4e4e\u5305\u542b\u957f\u540d\uff0c\u800c\u6446\u8131\u957f\u540d\u4f1a\u5f88\u6709\u5e2e\u52a9\u3002 \u6362\u53e5\u8bdd\u8bf4\uff0c\u6362\u884c\u662f\u56e0\u4e3a\u60a8\u6240\u5199\u5185\u5bb9\u7684\u8bed\u4e49\uff08\u4f5c\u4e3a\u4e00\u822c\u89c4\u5219\uff09\uff0c\u800c\u4e0d\u662f\u56e0\u4e3a\u884c\u957f\u3002 \u5982\u679c\u53d1\u73b0\u884c\u592a\u957f\uff0c\u5219\u66f4\u6539\u540d\u79f0\u6216\u8bed\u4e49\uff0c\u53ef\u80fd\u4f1a\u5f97\u5230\u4e0d\u9519\u7684\u7ed3\u679c\u3002 \u5b9e\u9645\u4e0a\uff0c\u8fd9\u548c\u5173\u4e8e\u529f\u80fd\u5e94\u8be5\u5199\u591a\u957f\u7684\u5efa\u8bae\u662f\u5b8c\u5168\u76f8\u540c\u7684\u3002 \u6ca1\u6709\u5f3a\u5236\u7684\u89c4\u5219\u201c\u4e00\u4e2a\u51fd\u6570\u7684\u957f\u5ea6\u4e0d\u80fd\u8d85\u8fc7N\u884c\u201d\uff0c\u4f46\u662f\u80af\u5b9a\u5b58\u5728\u8fd9\u6837\u4e00\u4e2a\u95ee\u9898\uff0c\u5373\u51fd\u6570\u592a\u957f\u6216\u8005\u5c0f\u51fd\u6570\u8fc7\u4e8e\u9891\u7e41\uff0c\u89e3\u51b3\u65b9\u6848\u662f\u91cd\u65b0\u5212\u5206\u51fd\u6570\u7684\u529f\u80fd\uff0c\u800c\u4e0d\u662f\u5f00\u59cb\u6570\u884c\u6570\u3002</p>"},{"location":"go/infrastructure/clean-code/#named-result-parameters","title":"Named Result Parameters (\u547d\u540d\u8fd4\u56de\u503c\u53c2\u6570)","text":"<p>\u8003\u8651\u4e00\u4e0bgodoc\u4e2d\u7684\u8868\u73b0\u3002\u547d\u540d\u7ed3\u679c\u53c2\u6570\u5982\u4e0b\uff1a <pre><code>func (n *Node) Parent1() (node *Node) {}\nfunc (n *Node) Parent2() (node *Node, err error) {}\n</code></pre></p> <p>\u4f1a\u5728godoc\u4e2d\u663e\u5f97\u7e41\u6742\uff1b\u66f4\u597d\u7684\u8868\u73b0\u5982\u4e0b\uff1a <pre><code>func (n *Node) Parent1() *Node {}\nfunc (n *Node) Parent2() (*Node, error) {}\n</code></pre></p> <ul> <li>\u4f8b\u5916 \u53e6\u4e00\u65b9\u9762\uff0c\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b,\u5982\u679c\u51fd\u6570\u8fd4\u56de\u4e24\u4e2a\u6216\u4e09\u4e2a\u76f8\u540c\u7c7b\u578b\u7684\u53c2\u6570\uff0c \u6216\u8005\u5982\u679c\u4ece\u4e0a\u4e0b\u6587\u4e2d\u4e0d\u6e05\u695a\u7ed3\u679c\u7684\u542b\u4e49\uff0c\u5219\u6dfb\u52a0\u540d\u79f0\u53ef\u80fd\u5f88\u6709\u7528\u3002\u4e0d\u8981\u4ec5\u4ec5\u4e3a\u4e86\u907f\u514d\u5728\u5185\u90e8\u58f0\u660evar\u800c\u547d\u540d\u7ed3\u679c\u53c2\u6570; \u8fd9\u5c31\u4ee5\u4e0d\u5fc5\u8981\u7684API\u5197\u957f\u4e3a\u4ee3\u4ef7\uff0c\u727a\u7272\u4e86\u5b9e\u73b0\u7684\u7b80\u77ed\u6027\u3002 <pre><code>func (f *Foo) Location() (float64, float64, error)\n// \u4e0d\u5982\u7528\u4e0b\u9762\u7684\u597d\u70b9\n// Location returns f's latitude and longitude.\n// Negative values mean south and west, respectively.\nfunc (f *Foo) Location() (lat, long float64, err error)\n</code></pre> \u5982\u679c\u51fd\u6570\u53ea\u6709\u51e0\u884c\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u88f8\u8fd4\u56de\u3002 \u4e00\u65e6\u6210\u4e3a\u901a\u7528\u7684\u51fd\u6570\uff0c\u8bf7\u660e\u786e\u8bf4\u660e\u60a8\u7684\u8fd4\u56de\u503c\u3002 \u7ed3\u8bba\uff1a\u4e3a\u4e86\u4f7f\u60a8\u53ef\u4ee5\u4f7f\u7528\u88f8\u8fd4\u56de\u800c\u547d\u540d\u7ed3\u679c\u53c2\u6570\u662f\u4e0d\u503c\u5f97\u7684\u3002\u6587\u6863\u7684\u6e05\u6670\u6027\u59cb\u7ec8\u6bd4\u5728\u51fd\u6570\u4e2d\u4fdd\u5b58\u4e00\u4e24\u884c\u66f4\u4e3a\u91cd\u8981</li> </ul>"},{"location":"go/infrastructure/clean-code/#_9","title":"\u5305\u6ce8\u91ca","text":"<p>\u50cfgodoc\u63d0\u51fa\u7684\u6240\u6709\u6ce8\u91ca\u4e00\u6837\uff0c\u5305\u6ce8\u91ca\u5fc5\u987b\u51fa\u73b0\u5728package\u5b50\u53e5\u7684\u65c1\u8fb9\uff0c\u4e14\u4e0d\u80fd\u6709\u7a7a\u884c <pre><code>// Package math provides basic constants and mathematical functions.\npackage math\n/*\nPackage template implements data-driven templates for generating textual\noutput such as HTML.\n....\n*/\npackage template\n</code></pre> \u5bf9\u4e8e\u201c package main\u201d\u6ce8\u91ca\uff0c\u5728\u4e8c\u8fdb\u5236\u540d\u79f0\u4e4b\u540e\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u6837\u5f0f\u7684\u6ce8\u91ca\uff08\u5982\u679c\u4f7f\u7528\u4e8c\u8fdb\u5236\u683c\u5f0f\uff0c\u5219\u53ef\u4ee5\u5927\u5199\uff09\uff0c\u4f8b\u5982\uff0c\u5bf9\u4e8e\u5728seedgen\u5305\u4e2d\u7684package main\u5305\uff0c\u60a8\u53ef\u4ee5\u7f16\u5199 <pre><code>// Binary seedgen ...\npackage main\n// Command seedgen ...\npackage main\n// Program seedgen ...\npackage main\n// The seedgen program ...\npackage main\n// \u90fd\u662f\u53ef\u4ee5\u7684\n</code></pre> \u8fd9\u4e9b\u793a\u4f8b\uff0c\u4ee5\u53ca\u8fd9\u4e9b\u7684\u660e\u667a\u7684\u53d8\u4f53\u662f\u53ef\u4ee5\u63a5\u53d7\u7684\u3002 \u8bf7\u6ce8\u610f\uff0c\u5305\u6ce8\u91ca\u4ee5\u5c0f\u5199\u5355\u8bcd\u5f00\u5934\u7684\u53e5\u5b50\u662f\u4e0d\u53ef\u53ef\u63a5\u53d7\u7684\uff0c\u56e0\u4e3a\u5b83\u4eec\u662f\u516c\u5f00\u53ef\u89c1\u7684 \u5e94\u8be5\u7528\u9002\u5f53\u7684\u82f1\u8bed\u5199\u6210\uff0c\u5305\u62ec**\u9996\u5b57\u6bcd\u5927\u5199\u7684\u53e5\u5b50**\u3002\u5f53\u4e8c\u8fdb\u5236\u540d\u79f0\u662f\u7b2c\u4e00\u4e2a\u5355\u8bcd\u65f6\uff0c\u5c06\u5176\u5927\u5199\u5373\u4f7f\u5b83\u4e0e\u62fc\u5199\u4e0d\u5b8c\u5168\u5339\u914d\u547d\u4ee4\u884c\u8c03\u7528\u4e5f\u662f\u5fc5\u9700\u7684</p>"},{"location":"go/infrastructure/clean-code/#_10","title":"\u5305\u540d","text":"<p>\u60a8\u5bf9\u5305\u4e2d\u6240\u6709\u540d\u79f0\u7684\u5f15\u7528\u90fd\u5c06\u4f7f\u7528\u5305\u540d\u5b8c\u6210\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u4ece\u6807\u8bc6\u7b26\u4e2d\u7701\u7565\u8be5\u540d\u79f0\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u5728\u5e9e\u5927\u7684\u5305\u4e2d\uff0c\u60a8\u4e0d\u9700\u8981\u8f93\u5165ChubbyFile\uff0c\u5ba2\u6237\u7aef\u5c06\u5176\u8f93\u5165\u4e3a chubby.ChubbyFile\u3002 \u800c\u662f\u547d\u540d\u7c7b\u578b File\uff0c\u5ba2\u6237\u7aef\u5c06\u5176\u5199\u4e3a chubby.File\u3002 \u907f\u514d\u4f7f\u7528\u65e0\u610f\u4e49\u7684\u7a0b\u5e8f\u5305\u540d\u79f0\uff0c\u4f8b\u5982util\uff0ccommon\uff0cmisc\uff0capi\uff0ctypes \u548cinterfaces\u3002 \u8bf7\u53c2\u9605 http://golang.org/doc/effective_go.html#package-names \u548c http://blog.golang.org/package-names \u4ee5\u83b7\u5f97\u66f4\u591a\u4fe1\u606f\u3002</p> <p>\u4fdd\u6301package\u7684\u540d\u5b57\u548c\u76ee\u5f55\u4fdd\u6301\u4e00\u81f4\uff0c\u5c3d\u91cf\u91c7\u53d6\u6709\u610f\u4e49\u7684\u5305\u540d\uff0c\u7b80\u77ed\uff0c\u6709\u610f\u4e49\uff0c\u5c3d\u91cf\u548c\u6807\u51c6\u5e93\u4e0d\u8981\u51b2\u7a81\u3002\u5305\u540d\u5e94\u8be5\u4e3a**\u5c0f\u5199**\u5355\u8bcd\uff0c\u4e0d\u8981\u4f7f\u7528\u4e0b\u5212\u7ebf\u6216\u8005\u6df7\u5408\u5927\u5c0f\u5199</p>"},{"location":"go/infrastructure/clean-code/#_11","title":"\u6587\u4ef6\u547d\u540d","text":"<p>\u5c3d\u91cf\u91c7\u53d6\u6709\u610f\u4e49\u7684\u6587\u4ef6\u540d\uff0c\u7b80\u77ed\uff0c\u6709\u610f\u4e49\uff0c\u5e94\u8be5\u4e3a**\u5c0f\u5199**\u5355\u8bcd\uff0c\u4f7f\u7528**\u4e0b\u5212\u7ebf**\u5206\u9694\u5404\u4e2a\u5355\u8bcd</p>"},{"location":"go/infrastructure/clean-code/#_12","title":"\u7ed3\u6784\u4f53\u547d\u540d","text":"<ul> <li>\u91c7\u7528\u9a7c\u5cf0\u547d\u540d\u6cd5\uff0c\u9996\u5b57\u6bcd\u6839\u636e\u8bbf\u95ee\u63a7\u5236\u5927\u5199\u6216\u8005\u5c0f\u5199</li> </ul>"},{"location":"go/infrastructure/clean-code/#_13","title":"\u4f20\u9012\u503c","text":"<p>\u4e0d\u8981\u4e3a\u4e86\u8282\u7701\u4e00\u4e9b\u5b57\u8282\uff0c\u5c06\u6307\u9488\u4f5c\u4e3a\u51fd\u6570\u53c2\u6570\u4f20\u9012\u3002 \u5982\u679c\u51fd\u6570\u6574\u4e2a\u8fc7\u7a0b\u4e2d\u90fd\u5c06 x \u4ec5\u4f5c\u4e3a *x \u4f7f\u7528\uff0c\u5219\u81ea\u53d8\u91cf\u4e0d\u5e94\u662f\u6307\u9488\u3002\u5e38\u89c1\u7684\u5b9e\u4f8b\u5305\u62ec\u4f20\u9012\u6307\u5411\u5b57\u7b26\u4e32\uff08 *string\u7684\u6307\u9488 \uff09\u6216\u6307\u5411\u63a5\u53e3\u503c\u7684\u6307\u9488\uff08 *io.Reader\uff09\u3002\u5728\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\uff0c\u503c\u672c\u8eab\u90fd\u662f\u56fa\u5b9a\u5927\u5c0f\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f20\u9012\u3002\u8fd9\u4e2a\u5efa\u8bae\u4e0d\u9002\u7528\u4e8e\u5927\u578b\u7ed3\u6784\uff0c\u751a\u81f3\u4e0d\u9002\u7528\u4e8e\u53ef\u80fd\u589e\u957f\u7684\u5c0f\u578b\u7ed3\u6784\u3002</p>"},{"location":"go/infrastructure/clean-code/#_14","title":"\u65b9\u6cd5\u63a5\u6536\u8005\u547d\u540d","text":"<p>\u65b9\u6cd5\u7684\u63a5\u6536\u8005\u7684\u540d\u79f0\u5e94\u53cd\u6620\u5176\u8eab\u4efd\u3002 \u901a\u5e38\uff0c\u5176\u7c7b\u578b\u7684\u4e00\u4e2a\u6216\u4e24\u4e2a\u5b57\u6bcd\u7f29\u5199\u5c31\u8db3\u591f\u4e86\uff08\u4f8b\u5982\uff0c\u201c\u5ba2\u6237\u201d\u662f\u201c c\u201d\u6216\u201c cl\u201d\uff09\u3002 \u4e0d\u8981\u4f7f\u7528\u901a\u7528\u540d\u79f0\uff0c\u4f8b\u5982\u201c me\u201d\uff0c\u201c this\u201d\u6216\u201c self\u201d\uff0c\u8fd9\u662f\u9762\u5411\u5bf9\u8c61\u8bed\u8a00\u7684\u5178\u578b\u6807\u8bc6\u7b26\uff0c\u8fd9\u4e9b\u6807\u8bc6\u7b26\u8d4b\u4e88\u8be5\u65b9\u6cd5\u7279\u6b8a\u7684\u542b\u4e49\u3002 \u5728Go\u4e2d\uff0c\u65b9\u6cd5\u7684\u63a5\u6536\u8005\u53ea\u662f\u53e6\u4e00\u4e2a\u53c2\u6570\uff0c\u56e0\u6b64\u5e94\u76f8\u5e94\u5730\u547d\u540d\u3002 \u8be5\u540d\u79f0\u4e0d\u5fc5\u50cf\u65b9\u6cd5\u53c2\u6570\u90a3\u6837\u5177\u6709\u63cf\u8ff0\u6027\uff0c\u56e0\u4e3a\u5b83\u7684\u4f5c\u7528\u662f\u663e\u800c\u6613\u89c1\u7684\uff0c\u6ca1\u6709\u4efb\u4f55\u6587\u6863\u76ee\u7684\u3002 \u5b83\u53ef\u80fd\u5f88\u77ed\uff0c\u56e0\u4e3a\u5b83\u5c06\u51fa\u73b0\u5728\u8be5\u7c7b\u578b\u7684\u6bcf\u79cd\u65b9\u6cd5\u7684\u51e0\u4e4e\u6bcf\u4e00\u884c\u4e0a\uff1b\u719f\u6089\u627f\u8ba4\u7b80\u6d01\u3002\u4e5f\u8981\u4fdd\u6301\u4e00\u81f4\uff1a\u5982\u679c\u5728\u4e00\u79cd\u65b9\u6cd5\u4e2d\u5c06\u63a5\u6536\u5668\u79f0\u4e3a\u201c c\u201d\uff0c\u5219\u5728\u53e6\u4e00\u79cd\u65b9\u6cd5\u4e2d\u8bf7\u52ff\u5c06\u5176\u79f0\u4e3a\u201c cl\u201d\u3002</p> <ul> <li>\u4f7f\u7528\u4e00\u4e2a\u5b57\u6bcd\u62162\u4e2a\u5b57\u6bcd\u5373\u53ef <pre><code>type T struct{} func (t *T)Get(){}\n</code></pre></li> </ul>"},{"location":"go/infrastructure/clean-code/#_15","title":"\u65b9\u6cd5\u63a5\u6536\u8005\u7c7b\u578b","text":"<p>\u5bf9\u4e8ego\u521d\u5b66\u8005\uff0c\u63a5\u53d7\u8005\u7684\u7c7b\u578b\u5982\u679c\u4e0d\u6e05\u695a\uff0c\u7edf\u4e00\u91c7\u7528\u6307\u9488\u578b <pre><code>func (t *T)Get(){}\n</code></pre></p> <p>\u9009\u62e9\u5728\u65b9\u6cd5\u4e0a\u4f7f\u7528\u503c\u63a5\u6536\u5668\u8fd8\u662f\u6307\u9488\u63a5\u6536\u5668\u53ef\u80fd\u5f88\u56f0\u96be\uff0c\u7279\u522b\u662f\u5bf9\u4e8e\u65b0\u7684Go\u7a0b\u5e8f\u5458\u800c\u8a00\u3002 \u5982\u679c\u6709\u7591\u95ee\uff0c\u8bf7\u4f7f\u7528\u6307\u9488\uff0c\u4f46\u662f\u6709\u65f6\u51fa\u4e8e\u6548\u7387\u7684\u539f\u56e0\uff08\u4f8b\u5982\uff0c\u5c0f\u7684\u4e0d\u53d8\u7ed3\u6784\u6216\u57fa\u672c\u7c7b\u578b\u7684\u503c\uff09\uff0c\u503c\u63a5\u6536\u5668\u624d\u6709\u610f\u4e49\u3002 \u4e00\u4e9b\u6709\u7528\u7684\u51c6\u5219\uff1a</p> <ul> <li> <p>\u5982\u679c\u63a5\u6536\u65b9\u662fmap\uff0cfunc\u6216channel\uff0c\u8bf7\u4e0d\u8981\u4f7f\u7528\u6307\u5411\u5b83\u4eec\u7684\u6307\u9488\u3002 \u5982\u679c\u63a5\u6536\u65b9\u662f\u5207\u7247\uff0c\u5e76\u4e14\u8be5\u65b9\u6cd5\u672a\u91cd\u65b0\u5207\u7247\u6216\u91cd\u65b0\u5206\u914d\u5207\u7247\uff0c\u8bf7\u4e0d\u8981\u4f7f\u7528\u6307\u5411\u8be5\u5207\u7247\u7684\u6307\u9488\u3002 <pre><code>package main\nimport (\n\"fmt\"\n)\ntype mp map[string]string\nfunc (m mp) Set(k, v string) {\nm[k] = v\n}\nfunc main() {\nm := make(mp)\nm.Set(\"k\", \"v\")\nfmt.Println(m)\n}\n</code></pre> <pre><code>//Channel\npackage main\nimport (\n\"fmt\"\n)\ntype ch chan interface{}\nfunc (c ch) Push(i interface{}) {\nc &lt;- i\n}\nfunc (c ch) Pop() interface{} {\nreturn &lt;-c\n}\nfunc main() {\nc := make(ch, 1)\nc.Push(\"i\")\nfmt.Println(c.Pop())\n}\n</code></pre></p> </li> <li> <p>\u5982\u679c\u9700\u8981\u5bf9slice\u8fdb\u884c\u4fee\u6539\uff0c\u901a\u8fc7\u8fd4\u56de\u503c\u7684\u65b9\u5f0f\u91cd\u65b0\u8d4b\u503c <pre><code>//Slice\npackage main\nimport (\n\"fmt\"\n)\ntype slice []byte\nfunc main() {\ns := make(slice, 0)\ns = s.addOne(42)\nfmt.Println(s)\n}\nfunc (s slice) addOne(b byte) []byte {\nreturn append(s, b)\n}\n</code></pre></p> </li> <li> <p>\u5982\u679c\u8be5\u65b9\u6cd5\u9700\u8981\u66f4\u6539\u63a5\u6536\u8005\uff0c\u5219\u63a5\u6536\u8005\u5fc5\u987b\u662f\u6307\u9488\u3002</p> </li> <li> <p>\u5982\u679c\u63a5\u6536\u8005\u662f\u5305\u542bsync.Mutex\u6216\u7c7b\u4f3c\u540c\u6b65\u5b57\u6bb5\u7684\u7ed3\u6784\uff0c\u5219\u63a5\u6536\u8005\u5fc5\u987b\u662f\u4e00\u4e2a\u6307\u9488\u4ee5\u907f\u514d\u590d\u5236\u3002 <pre><code>package main\nimport (\n\"sync\"\n)\ntype T struct {\nm sync.Mutex\n}\nfunc (t *T) lock() {\nt.m.Lock()\n}\n</code></pre></p> </li> <li> <p>\u5982\u679c\u63a5\u6536\u8005\u662f\u5927\u578b\u7ed3\u6784\u6216\u6570\u7ec4\uff0c\u5219\u6307\u9488\u63a5\u6536\u8005\u6548\u7387\u66f4\u9ad8\u3002\u591a\u5927\u662f\u5927\u578b\uff1f\u5047\u8bbe\u8fd9\u7b49\u6548\u4e8e\u5c06\u5176\u6240\u6709\u5143\u7d20\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u65b9\u6cd5\u3002\u5982\u679c\u611f\u89c9\u592a\u5927\uff0c\u5219\u5bf9\u4e8e\u63a5\u6536\u8005\u6765\u8bf4\u4e5f\u592a\u5927\u3002 <pre><code>\u5982\u679c\u63a5\u6536\u8005\u662f\u5927\u7684\u7ed3\u6784\u4f53\u6216\u8005\u6570\u7ec4\uff0c\u4f7f\u7528\u6307\u9488\u4f20\u9012\u4f1a\u66f4\u6709\u6548\u7387\npackage main\nimport (\n\"fmt\"\n)\ntype T struct {\ndata [1024]byte\n}\nfunc (t *T) Get() byte {\nreturn t.data[0]\n}\nfunc main() {\nt := new(T)\nfmt.Println(t.Get())\n}\n</code></pre></p> </li> <li> <p>\u51fd\u6570\u6216\u65b9\u6cd5\uff08\u540c\u65f6\u6267\u884c\u6216\u4ece\u8be5\u65b9\u6cd5\u8c03\u7528\u65f6\uff09\u662f\u5426\u4f1a\u4f7f\u63a5\u6536\u8005\u53d1\u751f\u53d8\u5316\uff1f \u503c\u7c7b\u578b\u5728\u8c03\u7528\u65b9\u6cd5\u65f6\u521b\u5efa\u63a5\u6536\u8005\u7684\u526f\u672c\uff0c\u56e0\u6b64\u5916\u90e8\u66f4\u65b0\u5c06\u4e0d\u4f1a\u5e94\u7528\u4e8e\u8be5\u63a5\u6536\u8005\u3002 \u5982\u679c\u66f4\u6539\u5fc5\u987b\u5728\u539f\u59cb\u63a5\u6536\u8005\u4e2d\u53ef\u89c1\uff0c\u5219\u63a5\u6536\u8005\u5fc5\u987b\u662f\u6307\u9488\u3002</p> </li> <li>\u5982\u679c\u63a5\u6536\u8005\u662f\u7ed3\u6784\u4f53\uff0c\u6570\u7ec4\u6216\u5207\u7247\uff0c\u5e76\u4e14\u5176\u4efb\u4f55\u5143\u7d20\u90fd\u662f\u6307\u5411\u53ef\u80fd\u6b63\u5728\u4fee\u6539\u7684\u5bf9\u8c61\u7684\u6307\u9488\uff0c\u5219\u6700\u597d\u4f7f\u7528\u6307\u9488\u63a5\u6536\u8005\uff0c\u56e0\u4e3a\u5b83\u4f1a\u4f7f\u8bfb\u8005\u66f4\u52a0\u6e05\u695a\u610f\u56fe\u3002</li> <li>\u5982\u679c\u63a5\u6536\u8005\u662f\u4e00\u4e2a\u5f88\u5c0f\u7684\u6570\u7ec4\u6216\u7ed3\u6784\uff0c\u81ea\u7136\u662f\u4e00\u4e2a\u503c\u7c7b\u578b\uff08\u4f8b\u5982\uff0c\u8bf8\u5982time.Time\u7c7b\u578b\uff09\uff0c\u6ca1\u6709\u53ef\u53d8\u5b57\u6bb5\u4e14\u6ca1\u6709\u6307\u9488\uff0c\u6216\u8005\u4ec5\u4ec5\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u57fa\u672c\u7c7b\u578b\uff08\u5982int\u6216string\uff09\uff0c\u503c\u63a5\u6536\u8005\u662f\u5408\u7406\u7684\u3002 \u503c\u63a5\u6536\u8005\u53ef\u4ee5\u51cf\u5c11\u53ef\u4ee5\u751f\u6210\u7684\u5783\u573e\u6570\u91cf\uff1b \u5982\u679c\u5c06\u503c\u4f20\u9012\u7ed9\u503c\u65b9\u6cd5\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5806\u6808\u4e0a\u7684\u526f\u672c\u800c\u4e0d\u662f\u5728\u5806\u4e0a\u5206\u914d\u3002 \uff08\u7f16\u8bd1\u5668\u4f1a\u5c3d\u91cf\u907f\u514d\u8fd9\u79cd\u5206\u914d\uff0c\u4f46\u662f\u5b83\u4e0d\u53ef\u80fd\u603b\u662f\u6210\u529f\u3002\uff09\u7531\u4e8e\u8fd9\u4e2a\u539f\u56e0\uff0c\u8bf7\u52ff\u5728\u6ca1\u6709\u8fdb\u884c\u6982\u8981\u5206\u6790\u7684\u60c5\u51b5\u4e0b\u9009\u62e9\u503c\u7c7b\u578b\u63a5\u6536\u8005\u3002</li> <li>\u6700\u540e\uff0c\u5982\u6709\u7591\u95ee\uff0c\u8bf7\u4f7f\u7528\u6307\u9488\u63a5\u6536\u8005\u3002</li> </ul>"},{"location":"go/infrastructure/clean-code/#_16","title":"\u53d8\u91cf\u540d","text":"<p>Go\u4e2d\u7684\u53d8\u91cf\u540d\u5e94\u8be5\u7b80\u77ed\u800c\u4e0d\u662f\u5197\u957f\u3002 \u5bf9\u4e8e\u8303\u56f4\u6709\u9650\u7684\u5c40\u90e8\u53d8\u91cf\u5c24\u5176\u5982\u6b64\u3002 \u6bd4\u8d77 lineCount \u66f4\u503e\u5411\u4e8e c\u3002\u6bd4\u8d77 sliceIndex \u66f4\u503e\u5411\u4e8e i\u3002</p>"},{"location":"go/infrastructure/clean-code/#_17","title":"\u4ee3\u7801\u5206\u6790","text":"<ul> <li>\u9759\u6001\u5206\u6790\u6211\u4eec\u7684\u6e90\u7801\u5b58\u5728\u7684\u5404\u79cd\u95ee\u9898\uff0c\u4f8b\u5982\u591a\u4f59\u7684\u4ee3\u7801\uff0c\u63d0\u524dreturn\u7684\u903b\u8f91\uff0cstruct\u7684tag\u662f\u5426\u7b26\u5408\u6807\u51c6\u7b49\u3002 <pre><code>go vet .\n</code></pre></li> </ul> <ol> <li> <p>uber \u21a9</p> </li> <li> <p>Effective Go \u21a9</p> </li> <li> <p>Go Common Mistakes \u21a9</p> </li> <li> <p>Go Code Review Comments \u21a9</p> </li> </ol>"},{"location":"go/infrastructure/semver/","title":"Semver","text":""},{"location":"go/infrastructure/semver/#version","title":"version","text":"<p>\u8bed\u4e49\u5316\u7248\u672c\u53f7\u7ba1\u7406</p>"},{"location":"go/infrastructure/semver/#commit-message","title":"commit message","text":"<p>angular commit</p>"},{"location":"go/infrastructure/test/","title":"\u6d4b\u8bd5","text":""},{"location":"go/infrastructure/test/#vscode-golang","title":"vscode golang \u76f8\u5173\u914d\u7f6e","text":"<pre><code>\"go.testFlags\": [\n\"-v\",\n],\n</code></pre>"},{"location":"go/infrastructure/test/#_1","title":"\u4ee3\u7801","text":"one_test.go \u6587\u4ef6\u540d\u5fc5\u987b\u4ee5 _test \u7ed3\u5c3e<pre><code>package test\nimport (\n\"fmt\"\n\"testing\"\n)\n// \u51fd\u6570\u540d\u5fc5\u987bTest \u5f00\u5934\nfunc TestOne(t *testing.T) {\nfmt.Println(1 == 1)\n}\n</code></pre> <p>\u70b9\u51fbvscode \u4e0a\u770b\u5230\u7684 <code>run test</code> \u6216 \u6253\u65ad\u70b9\u540e\u70b9\u51fb<code>debug test</code> \u6216\u8005\u4f7f\u7528\u547d\u4ee4</p> <pre><code># -v \u663e\u793a\u6253\u5370\u4fe1\u606f\ngo test -v # \u6267\u884c\u5f53\u524d\u76ee\u5f55\u4e0b\u6240\u6709\u7684 _test\u6d4b\u8bd5\u6587\u4ef6\ngo test -v target_dir/* # \u6307\u5b9a\u76ee\u5f55\ngo test -v one_test.go # \u6307\u5b9a\u6587\u4ef6\n# \u6267\u884c\u6307\u5b9a\u6d4b\u8bd5\u65b9\u6cd5\ngo test -v -run TestOne one_test.go\n</code></pre>"},{"location":"go/pkg/cobra/","title":"cobra","text":""},{"location":"go/pkg/cobra/#_1","title":"\u6982\u5ff5","text":"\u4f8b\u5b50\u8bf4\u660e<pre><code># server \u662f command(action),  'port' \u662f \u4e00\u4e2aflag,\u6539\u53d8\u66b4\u9732\u7684\u7aef\u53e3,\u5bf9\u884c\u4e3a\u7684\u4fee\u9970\n# hugo \u662f \u5e94\u7528\u7a0b\u5e8f\u7684\u540d\u79f0\nhugo server --port=1313\n# git \u662f\u5e94\u7528\u7a0b\u5e8f, clone \u662fcommand(action), URL \u662fArgs, --bare\u662f flag\ngit clone URL --bare\n</code></pre>"},{"location":"go/pkg/cobra/#_2","title":"\u5b9e\u6218","text":"<p>cobra github \u6587\u6863 cobra-cli <pre><code># \u5b89\u88c5cobra-cli \u7528\u4e8e\u4ee3\u7801\u751f\u6210\ngo install github.com/spf13/cobra-cli@latest\n\nmkdir my-app &amp;&amp; cd my-app &amp;&amp; cobra-cli init\n# \u6216\u8005\ncobra-cli init my-app &amp;&amp; cd my-app\ntree\n.\n\u251c\u2500\u2500 LICENSE\n\u251c\u2500\u2500 cmd\n\u2502   \u2514\u2500\u2500 root.go\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 go.sum\n\u2514\u2500\u2500 main.go\n</code></pre></p>"},{"location":"go/pkg/cobra/#_3","title":"\u6839\u547d\u4ee4","text":"cmd/root.go<pre><code>/*\nCopyright \u00a9 2023 NAME HERE &lt;EMAIL ADDRESS&gt;\n\u5728cmd \u76ee\u5f55\u4e0b\u7684\u4e00\u4e2a\u6587\u4ef6, \u5c31\u662f\u4e00\u4e2a\u547d\u4ee4(command)\n\u8fd9\u4e2aroot.go \u662f\u6839\u547d\u4ee4\n*/\npackage cmd\nimport (\n\"fmt\"\n\"os\"\n\"github.com/spf13/cobra\"\n)\n// \u6839\u547d\u4ee4, \u5c31\u662f\u6bd4\u5982\u4f60\u6267\u884c  git,\u4e0d\u5e26\u4efb\u4f55\u5b50\u547d\u4ee4, \u5219\u79f0\u8fd9\u79cd\u53eb \u6839\u547d\u4ee4\n// \u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u672c\u8eab(\u4e0d\u5e26\u53c2\u6570 flag) \u5c31\u662f\u7b97 \u4e00\u4e2a \u547d\u4ee4 , \u5373\u6839\u547d\u4ee4\nvar rootCmd = &amp;cobra.Command{\n// ./my-app -h \u663e\u793a\u7684\u547d\u4ee4\u540d\n// \u6839\u547d\u4ee4\u7684\u8fd9\u4e2a\u8bbe\u7f6e \u8981\u4e0e\u5e94\u7528\u7a0b\u5e8f\u672c\u8eab\u540d\u5b57\u4e00\u6837,\u5426\u5219\u4f1a\u8bef\u5bfc\u522b\u4eba\nUse: \"my-app\",\n// \u7c7b\u6bd4 git --help\n//       clone     Clone a repository into a new directory  ==&gt; \u7b80\u77ed\u4fe1\u606f\n// \u8fd9\u91cc\u662f\u6839\u547d\u4ee4\u7684Short,\u7b80\u77ed\u7684\u4e0d\u4f1a\u663e\u793a\nShort: \"\u7b80\u77ed\u7684\u63cf\u8ff0, \u6267\u884c app-name --help \u4f1a\u663e\u793a\u5404\u4e2acommand\u81ea\u5df1\u7684short\u4fe1\u606f\",\n// \u547d\u4ee4 -h/--help \u663e\u793a\u7684\u4fe1\u606f.\nLong: `\u8be6\u7ec6\u63cf\u8ff0, \u8fd0\u884c \u6839command ,\u5373: \u76f4\u63a5\u8fd0\u884c app name --help \u4e0d\u5e26command, \u663e\u793a\u7684\u63d0\u793a\u4fe1\u606f`,\n// \u6839\u547d\u4ee4, \u5177\u4f53\u884c\u4e3a, \u8fd9\u91cc\u53ef\u4ee5\u5b9a\u4e49.\n// \u5982\u679c\u6ca1\u6709 \u8fd9\u4e2arun: \u90a3\u4e48\u5c31\u6ca1\u6709\u884c\u4e3a, \u4f1a\u663e\u793a\u4e0a\u9762\u7684Long \u4fe1\u606f\u4ee5\u53ca \u5e2e\u52a9\u4fe1\u606f\n// \u8fd9\u91cc\u5982\u679c\u8bbe\u7f6e\u4e86, ./my-app \u4f1a\u663e\u793a hello world\n// Run: func(cmd *cobra.Command, args []string) {\n//  fmt.Println(\"hello world\")\n// },\n}\n// Execute adds all child commands to the root command and sets flags appropriately.\n// This is called by main.main(). It only needs to happen once to the rootCmd.\nfunc Execute() {\n// flags \u4f20\u9012\u6709\u9519 \u6216\u8005 \u4f7f\u7528runE \u5e26E\u7684, \u7136\u540e\u6709err \u8fd4\u56de\u7684\u60c5\u51b5\u4e0b err \u624d\u4e0d\u662fnil\nerr := rootCmd.Execute()\nif err != nil {\nfmt.Println(\"err:\", err.Error())\nos.Exit(1)\n}\n}\nvar cfgFile string\nvar version string\nfunc init() {\n// \u5168\u5c40 global flag, \u6240\u6709 command \u90fd\u80fd\u7528\n// \u56e0\u4e3a\u5728 \u6839\u547d\u4ee4\u4e0b \u521b\u5efa\u7684, \u800c\u5176\u4ed6\u5b50\u547d\u4ee4\u90fd\u662f\u7ee7\u627f\u81ea \u6839\u547d\u4ee4.\n// ~/.my-app.yaml \u662f\u9ed8\u8ba4\u503c, \u6267\u884c\u547d\u4ee4 \u6ca1\u6709\u4f20\u9012 --config=xxxx \u65f6, config\u8fd9\u4e2aflag\u7684\u9ed8\u8ba4\u503c\nrootCmd.PersistentFlags().StringVar(&amp;cfgFile, \"config\", \"~/.my-app.yaml\", \"\u5bf9\u8fd9\u4e2aflag\u7684\u8bf4\u660e: \u8fd9\u662f\u914d\u7f6e\u6587\u4ef6\")\n// \u5728\u5176\u4ed6 \u5b50\u547d\u4ee4\u4e0b\u521b\u5efa\u7684 PersistentFlags ,\u6211\u4eec\u79f0\u4e3a \u6301\u4e45flag. \u53ea\u6709\u5b83\u81ea\u5df1\u548c\u5b83\u7684\u5b50\u547d\u4ee4\u4ee5\u53ca\u5b83\u7684\u7ee7\u627f\u547d\u4ee4\u53ef\u4ee5\u4f7f\u7528\nrootCmd.PersistentFlags().StringVarP(&amp;version, \"version\", \"v\", \"1.0\", \"\u663e\u793a\u7248\u672c\")\n// \u672c\u5730 flags\n// \u8fd9\u4e2a \u6267\u884c\u7684\u90a3\u4e2acommand(\u5f53\u524d\u547d\u4ee4) \u624d\u80fd\u7528\u7684 flag.\n// --debug / -D (\u7b80\u5199)  false \u9ed8\u8ba4\u503c\n// BoolP \u76f8\u6bd4Bool \u5c31\u662f\u591a\u4e86 \u4e00\u4e2a\u652f\u6301\u7b80\u5199\nrootCmd.Flags().BoolP(\"debug\", \"D\", false, \"\u662f\u5426debug\")\n}\n</code></pre> <pre><code>go build .\n./my-app -h\n</code></pre>"},{"location":"go/pkg/cobra/#_4","title":"\u6dfb\u52a0\u547d\u4ee4","text":"<pre><code># \u63a5\u4e0b\u6765\u6dfb\u52a0\u4e00\u4e2a\u547d\u4ee4\ncobra-cli add serve\n# \u4f1a\u5728 cmd\u76ee\u5f55\u4e0b\u521b\u5efa\u4e00\u4e2a serve.go \u6587\u4ef6\n</code></pre> cmd/serve.go \u505a\u76f8\u5173\u4fee\u6539<pre><code>/*\nCopyright \u00a9 2023 NAME HERE &lt;EMAIL ADDRESS&gt;\n*/\npackage cmd\nimport (\n\"errors\"\n\"fmt\"\n\"github.com/spf13/cobra\"\n)\nvar serveCmd = &amp;cobra.Command{\nUse:     \"serve\",                //  ./my-app -h \u5e2e\u52a9\u4fe1\u606f\u663e\u793a\u7684\u547d\u4ee4\u540d\nShort:   \"short serve\",          //  ./my-app -h \u4f1a\u770b\u5230\nLong:    `A longer description`, //  ./my-app serve -h \u4f1a\u770b\u5230\nAliases: []string{\"s\"},          //   \u547d\u4ee4\u522b\u540d ./my-app s \u7b49\u540c\u4e8e ./my-app serve\n// \u5982\u679c\u6709\u9519\u8bef, \u5c31\u4e0d\u8981\u518d\u663e\u793a \u4f7f\u7528\u5e2e\u52a9\u4e86.\n// \u9ed8\u8ba4\u6ca1\u8bbe\u7f6e\u662f false , \u547d\u4ee4\u6267\u884c\u6709\u9519\u8bef, \u4f1a\u663e\u793a\u5e2e\u52a9\nSilenceUsage: true,\nPersistentPreRun: func(cmd *cobra.Command, args []string) {\nfmt.Printf(\"serve PersistentPreRun run\u8fd0\u884c\u524d \u6267\u884c, \u8fd9\u4e2a\u4f1a\u88ab\u5b50\u547d\u4ee4\u7ee7\u627f,\u9664\u975e\u5b50\u547d\u4ee4\u81ea\u5df1\u5199\u4e86\u81ea\u5df1\u7684: %v\\n\", args)\n},\nPreRun: func(cmd *cobra.Command, args []string) {\nfmt.Printf(\"run \u8fd0\u884c\u524d\u6267\u884c, \u4e0d\u4f1a\u88ab\u5b50\u547d\u4ee4\u7ee7\u627f: %v\\n\", args)\n},\nRun: func(cmd *cobra.Command, args []string) {\nfmt.Println(\"\u6267\u884c\u4e86 serve  \u5b50\u547d\u4ee4\")\n// rootCmd \u91cc\u8bbe\u7f6e\u7684 \u5168\u5c40config\nconfig := cmd.Flags().Lookup(\"config\").Value\n// cmd.Flags() \u5305\u542b\u6240\u6709\u7684flag\ndirtyReload0 := cmd.Flags().Lookup(\"dirtyreload\").Value\n// \u83b7\u53d6 local flags\ndirtyReload := cmd.LocalFlags().Lookup(\"dirtyreload\").Value\nfmt.Println(dirtyReload0, dirtyReload)\n// cmd.PersistentFlags()\nfmt.Println(config)\n// \u53c2\u6570\nfmt.Println(\"args:\", args)\n},\nPostRun: func(cmd *cobra.Command, args []string) {\nfmt.Printf(\"run \u8fd0\u884c\u540e\u6267\u884c, \u4e0d\u4f1a\u88ab\u5b50\u547d\u4ee4\u7ee7\u627f: %v\\n\", args)\n},\nPersistentPostRun: func(cmd *cobra.Command, args []string) {\nfmt.Printf(\"serve PersistentPostRun run\u8fd0\u884c\u540e\u6267\u884c, \u8fd9\u4e2a\u4f1a\u88ab\u5b50\u547d\u4ee4\u7ee7\u627f,\u9664\u975e\u5b50\u547d\u4ee4\u81ea\u5df1\u5199\u4e86\u81ea\u5df1\u7684: %v\\n\", args)\n},\n// \u5982\u679c\u4e0d\u5199\u8fd9\u4e2a ,\u8868\u793a\u63a5\u6536\u4efb\u610f\u53c2\u6570\nArgs: func(cmd *cobra.Command, args []string) error {\nfmt.Println(\"\u6240\u6709 pre post run \u4e4b\u524d\u6267\u884c\")\n// \u53c2\u6570\u81ea\u5b9a\u4e49\u9a8c\u8bc1\nif len(args) &lt; 1 {\nreturn errors.New(\"\u81f3\u5c11\u4e00\u4e2a\u53c2\u6570\")\n}\nfmt.Println(\"args:\", args)\n// \u8fd4\u56denil \u624d\u4f1a\u6267\u884c\u540e\u7eed\u7684run\u65b9\u6cd5\nreturn nil\n},\n}\nfunc init() {\nrootCmd.AddCommand(serveCmd)\nserveCmd.Flags().Bool(\"dirtyreload\", false, \"Help message for dirty\")\n}\n</code></pre> <pre><code>go build .\n./my-app s  #(1)\n# \u4ee3\u7801\u91cc bool \u7c7b\u578b\u7684, \u8fd9\u91cc\u6267\u884c\u662f \u53ea\u8981\u5e26\u4e0a \u5c31\u8868\u793atrue\n# \u5f53\u7136\u4e5f\u53ef\u4ee5 --dirtyreload=true\n./my-app s --dirtyreload --config=./debug.yaml\n</code></pre> <ol> <li>\u663e\u793a     <pre><code>\u6267\u884c\u4e86 serve  \u547d\u4ee4\nfalse\n~/.my-app.yaml\n</code></pre></li> </ol>"},{"location":"go/pkg/cobra/#_5","title":"\u547d\u4ee4\u6dfb\u52a0\u5b50\u547d\u4ee4","text":"\u7ed9\u547d\u4ee4\u6dfb\u52a0\u5b50\u547d\u4ee4<pre><code># \u9ed8\u8ba4 \u6ca1\u6709-p \u6307\u660e\u7684\u8bdd, \u5c31\u662f\u7ed9rootCmd\u6dfb\u52a0\u547d\u4ee4\ncobra-cli add image -p 'serveCmd'\n</code></pre> cmd/image.go<pre><code>/*\nCopyright \u00a9 2023 NAME HERE &lt;EMAIL ADDRESS&gt;\n*/\npackage cmd\nimport (\n\"fmt\"\n\"github.com/spf13/cobra\"\n)\n// imageCmd represents the image command\nvar imageCmd = &amp;cobra.Command{\nUse:   \"image\",\nShort: \"image A brief \",\nLong:  `image A longer description.`,\nRunE: func(cmd *cobra.Command, args []string) error {\nfmt.Println(\"image called\")\n// return errors.New(\"eeee\")\nreturn nil\n},\nPersistentPostRun: func(cmd *cobra.Command, args []string) {\nfmt.Printf(\"image PersistentPostRun: %v\\n\", args)\n},\n// \u7528cobra \u63d0\u4f9b\u7684\u65b9\u6cd5, \u4e4b\u524d\u6211\u4eec\u5728serve \u547d\u4ee4\u4e2d\u7528\u7684\u81ea\u5b9a\u4e49\nArgs: cobra.ExactArgs(1),\n/*\n        \u8fd9\u91cc\u7684\u8868\u793a \u53ea\u63a5\u6536 \u8fd9\u6837\u7684\u53c2\u6570\n        Args:      cobra.OnlyValidArgs,\n        ValidArgs: []string{\"abc\", \"efg\"},\n    */\n}\nfunc init() {\nserveCmd.AddCommand(imageCmd)\n}\n</code></pre> <pre><code>go build .\n./my-app s image # \u62a5\u9519\n./my-app s image abc\n</code></pre>"},{"location":"go/pkg/dlv/","title":"dlv\u8c03\u8bd5","text":""},{"location":"go/pkg/dlv/#_1","title":"\u5e38\u7528\u547d\u4ee4","text":"<pre><code>dlv attach pid #\u5bf9\u6b63\u5728\u8fd0\u884c\u7684\u8fdb\u7a0b\u76f4\u63a5\u8fdb\u884c\u8c03\u8bd5\ndlv debug main.go\ndlv exec \u53ef\u6267\u884c\u6587\u4ef6\n# b  \u6253\u65ad\u70b9 \u5305\u540d.\u65b9\u6cd5\u540d\nb main.main\nc\n# \u5728\u4e0a\u9762\u7684c \u6267\u884c\u540e,\u624d\u53ef\u4ee5\u8fd9\u6837b \u5230\u884c\u53f7\nb 11 # \u76f4\u63a5\u884c\u53f7 \u6253\u65ad\u70b9\n# \u6216\u8005 \u4e00\u5f00\u59cb\u8fd9\u6837\u76f4\u63a5\u6253 \u884c\u53f7\u7684\u65ad\u70b9\nb main.go:12\nbp # \u6253\u5370\u6240\u6709\u65ad\u70b9\np a # \u6253\u5370\u53d8\u91cfa\n# \u6253\u5370 \u67d0\u4e2a\u5185\u5b58\u5730\u5740\u7684\u5185\u5bb9,\u6bd4\u5982\u60f3\u770b sp\u5bc4\u5b58\u5668\u6307\u5411\u7684\u5185\u5b58\np *(*uint64)(0x000000c000050758)\ns # \u9010\u884c\u6267\u884c\u4ee3\u7801 \u9047\u5230\u51fd\u6570\u4f1a\u8fdb\u5165\u5185\u90e8\nstepout #\u8df3\u51fa\u51fd\u6570\nn # \u9010\u884c\u6267\u884c\u4ee3\u7801 \u4e0d\u8fdb\u5165\u51fd\u6570\u5185\nargs #\u67e5\u770b\u88ab\u8c03\u7528\u51fd\u6570\u6240\u4f20\u5165\u7684\u53c2\u6570\u503c\nlocals #\u67e5\u770b\u6240\u6709\u5c40\u90e8\u53d8\u91cf\nlocals \u53d8\u91cf\u540d # \u67e5\u770b\u5177\u4f53\u53d8\u91cf\nclear \u7f16\u53f7 # \u5220\u9664\u6307\u5b9a\u65ad\u70b9 ,bp \u6253\u5370\u53ef\u4ee5\u770b\u5230\u7f16\u53f7\nclearall #  \u5220\u9664\u6240\u6709\u65ad\u70b9\nregs # \u6253\u5370\u5bc4\u5b58\u5668\u4fe1\u606f\ngoroutines # \u663e\u793a\u6240\u6709\u534f\u7a0b,\u6709\u7f16\u53f7 , *\u8868\u793a\u5f53\u524d\u6267\u884c\u7684\u534f\u7a0b\ngoroutine \u7f16\u53f7 # \u5207\u6362\u534f\u7a0b\nl # \u6253\u5370\u4ee3\u7801\nr # \u91cd\u542f\u5f53\u524d\u8fdb\u7a0b\n# \u67e5\u770b\u6c47\u7f16\u4ee3\u7801\ndisassemble -l main.main\n</code></pre>"},{"location":"go/pkg/dlv/#_testgo","title":"\u8c03\u8bd5 _test.go \u6587\u4ef6","text":"<p><pre><code>func TestBasic(t *testing.T) {\na := struct{}{}\nb := struct{}{}\nfmt.Println(unsafe.Sizeof(a)) //0\n// \u76f8\u540c\nfmt.Printf(\"%p,%p\\n\", &amp;a, &amp;b)\nfmt.Println(11)\n}\n</code></pre> <pre><code># Double-dashes `--` can be used to pass arguments to the test program\n# dlv test [package] -- -test.run TestSomething -test.v -other-argument\ndlv test -- -test.run TestBasic -test.v\n# b \u6253\u65ad\u70b9 \u540e\u9762\u7684\u662f Test \u7684\u65b9\u6cd5\u540d\n(dlv) b TestBasic\n(dlv) c  # \u6267\u884c\u5230\u65ad\u70b9\u4f4d\u7f6e\n(dlv) n # \u4e0b\u4e00\u884c\n(dlv) n # \u4e0b\u4e00\u884c\n(dlv) p &amp;a\n</code></pre></p>"},{"location":"go/pkg/gdb/","title":"Gdb","text":"<p>pt ptype</p>"},{"location":"go/pkg/go-cache/","title":"Go cache","text":"<pre><code>import  \"github.com/patrickmn/go-cache\"\nfunc main() {\n//c\u7684items (map\u7ed3\u6784) \u8fc7\u671fkey\u6e05\u7406\u65f6\u95f4 = DefaultExpiration + CleanupInterval\nc := cache.New(time.Duration(100)*time.Second, time.Duration(10)*time.Second)\nfmt.Println(c)\n// \u67d0\u4e2akey\u8fc7\u671f\u88ab\u5220\u9664\u7684\u65f6\u5019\u4f1a\u89e6\u53d1\nc.OnEvicted(func(a string, b interface{}) {\nfmt.Println(a, b)\n})\n// \u8fd9\u4e2akey x\u7684\u8fc7\u671f\u65f6\u95f4\u662f 5+ cache.New\u91cc\u8bbe\u7f6e\u7684cleanupInterval \u65f6\u95f4\n// \u5982\u679ckey \u8bbe\u7f6e\u7684 \u8fc7\u671f\u65f6\u95f4 =0 , \u5219\u4f7f\u7528\u9ed8\u8ba4\u7684New\u91cc\u8bbe\u7f6e\u7684\u8fc7\u671f\u65f6\u95f4\n// -1\u7684\u8bdd ,\u6c38\u4e0d\u8fc7\u671f\nc.Set(\"x\", \"y\", 0*time.Second)\nselect {}\n}\n</code></pre>"},{"location":"go/pkg/go-generate/","title":"generate","text":""},{"location":"go/pkg/go-generate/#_1","title":"\u4ecb\u7ecd","text":"<p>Tip</p> <ol> <li>go generate \u547d\u4ee4, \u6211\u8fd9\u91cc\u5c06\u5b83\u653e\u5230\u8fd9\u8fb9.</li> <li>Go \u8bed\u8a00\u7684\u6807\u51c6\u5e93\u4e2d\u7684 cmd/go/internal/generate</li> <li>go generate \u547d\u4ee4\u4f1a\u904d\u5386\u6307\u5b9a\u7684\u5305\u8def\u5f84\u4e0b\u7684\u6240\u6709 Go \u6e90\u6587\u4ef6,\u5e76\u89e3\u6790\u8fd9\u4e9b\u6e90\u6587\u4ef6\u4e2d\u7684 //go:generate \u6ce8\u91ca,\u8fd9\u4e9b\u6ce8\u91ca\u5305\u542b\u4e86\u4ee3\u7801\u751f\u6210\u6307\u4ee4</li> <li>//go:generate \u540e\u9762\u5c31\u662f\u4f1a\u6267\u884c\u7684\u547d\u4ee4,\u6bd4\u5982 <code>//go:generate echo hello</code>  \u6267\u884c<code>go generate</code> \u4f1a\u663e\u793a hello</li> </ol>"},{"location":"go/pkg/go-generate/#_2","title":"\u4f8b\u5b50","text":"<p>\u63d0\u9192</p> <p>\u65e9\u671f\u7b14\u8bb0, \u4e0b\u9762\u7684\u4f8b\u5b50\u7c97\u7cd9,\u7ed9struct\u7c7b\u578b\u751f\u6210getset\u65b9\u6cd5, \u7b49\u6574\u7406\u4e86ast\u540e, \u6211\u4f1a\u518d\u5b8c\u5584\u4e00\u4e0b.  \u5efa\u8bae\u53bb\u5b66\u4e60 stringer</p> <pre><code>tree\n.\n\u251c\u2500\u2500 abc.go\n\u251c\u2500\u2500 codegen\n\u2502   \u2514\u2500\u2500 gen.go\n\u251c\u2500\u2500 go.mod\n\u2514\u2500\u2500 pkg\n    \u2514\u2500\u2500 cat.go\n</code></pre> abc.go<pre><code>//go:generate echo 123\n// goto hell\n// xyz\npackage main\n//go:generate go run codegen/gen.go\n//go:generate echo hello--world\n//helloworld33\ntype Person struct { // this is person\nName string // this is name\nAge  int32\n}\n//go:generate echo 99\ntype Cup struct {\nPrice  float64\nOrigin string\n}\n</code></pre> codegen/gen.go<pre><code>package main\nimport (\n\"fmt\"\n\"go/ast\"\n\"go/parser\"\n\"go/printer\"\n\"go/token\"\n\"os\"\n\"strings\"\n\"text/template\"\n)\ntype Field struct {\nName string\nType string\n}\ntype StructInfo struct {\nName        string\nFields      []Field\nPackageName string\n}\nfunc generateCode() {\nfset := token.NewFileSet()\n// \u89e3\u6790\u5f53\u524d\u76ee\u5f55\u4e0b\u6240\u6709\u7684 Go \u6e90\u6587\u4ef6,\u4e0d\u4f1a\u9012\u5f52\u89e3\u6790\u5b50\u76ee\u5f55\u91cc\u7684\u6587\u4ef6\u7684.\npkgs, err := parser.ParseDir(fset, \".\", nil, parser.ParseComments)\nif err != nil {\nfmt.Fprintf(os.Stderr, \"Failed to parse directory: %v\\n\", err)\nos.Exit(1)\n}\nfor _, pkg := range pkgs {\nfor _, file := range pkg.Files {\npackageName := file.Name.Name\n// for _, l := range file.Doc.List {\n//  fmt.Println(\"file-doc\", l.Text)\n// }\n// fmt.Println(\"---\", packageName, file.Doc.Text(), \"===\")\n// for _, c := range file.Comments {\n//  // \u6328\u5728\u4e00\u8d77\u76842\u884c\u6ce8\u91ca\u7b97\u4e00\u4e2afile\u7684Comment\n//  fmt.Print(\"[\")\n//  for _, l := range c.List {\n//      fmt.Println(\"cc\", l.Text)\n//  }\n//  fmt.Println(\"]\")\n// }\n// for _, d := range file.Decls {\n//  x := d.(*ast.GenDecl)\n//  if x.Doc != nil {\n//      fmt.Println(len(x.Doc.List))\n//      for _, l := range x.Doc.List {\n//          fmt.Println(\"ooo\", l.Text)\n//      }\n//      fmt.Println(\"gg\", x.Doc.Text(), \"--\")\n//  }\n//  ts := x.Specs[0].(*ast.TypeSpec)\n//  fmt.Println(ts.Name)\n// }\n// continue\nast.Inspect(file, func(n ast.Node) bool {\nswitch x := n.(type) {\n// \u6ce8\u91ca\u5199\u5728type struct \u4e0a\u9762\u7684\u6ce8\u91ca \u662f\u7b97\u4e00\u4e2a\u8282\u70b9. \u4e0d\u662f\u5c5e\u4e8etype struct\u7684\u5185\u90e8\u4e1c\u897f\ncase *ast.GenDecl:\n// fmt.Println(\"\u6ce8\u91ca\u5185\u5bb92:\", x.Doc.Text())\ncase *ast.CommentGroup:\n// fmt.Println(\"\u6ce8\u91ca\u5185\u5bb9:\", x.Text())\ncase *ast.TypeSpec:\nif structType, ok := x.Type.(*ast.StructType); ok {\nfmt.Println(\"\u7ed3\u6784\u4f53\u540d\u79f0:\", x.Name.Name)\nstructInfo := StructInfo{\nName:        x.Name.Name,\nPackageName: packageName,\n}\n// \u63d0\u53d6\u7ed3\u6784\u4f53\u5b57\u6bb5\u4fe1\u606f\nfor _, field := range structType.Fields.List {\nfor _, ident := range field.Names {\nstructInfo.Fields = append(structInfo.Fields, Field{\nName: ident.Name,\nType: fileSetToString(fset, field.Type),\n})\n}\n}\n// \u751f\u6210 Get \u548c Set \u65b9\u6cd5\u7684\u4ee3\u7801\ngenerateGetSetMethods(structInfo)\n}\n}\n// ast.Print(fset, n)\nreturn true\n})\n}\n}\n}\nfunc generateGetSetMethods(structInfo StructInfo) {\ntmpl := template.Must(template.New(\"\").Parse(getSetMethodsTemplate))\nfileName := structInfo.Name + \"_getset.go\"\nfmt.Println(fileName)\nfile, err := os.Create(fileName)\nif err != nil {\nfmt.Fprintf(os.Stderr, \"Failed to create file: %v\\n\", err)\nos.Exit(1)\n}\ndefer file.Close()\nerr = tmpl.Execute(file, structInfo)\nif err != nil {\nfmt.Fprintf(os.Stderr, \"Failed to generate code: %v\\n\", err)\nos.Exit(1)\n}\nfmt.Printf(\"\u751f\u6210\u7684\u6587\u4ef6 %s\\n\", fileName)\n}\nfunc fileSetToString(fset *token.FileSet, node ast.Node) string {\nvar buf strings.Builder\nif err := printer.Fprint(&amp;buf, fset, node); err != nil {\nreturn \"\"\n}\nreturn buf.String()\n}\nconst getSetMethodsTemplate = `\n// Code generated by go generate; DO NOT EDIT.\npackage {{.PackageName}}\n{{range .Fields}}\nfunc (s *{{$.Name}}) Get{{.Name}}() {{.Type}} {\n    return s.{{.Name}}\n}\nfunc (s *{{$.Name}}) Set{{.Name}}(value {{.Type}}) {\n    s.{{.Name}} = value\n}\n{{end}}\n`\nfunc main() {\nfmt.Println(111)\ngenerateCode()\n}\n</code></pre> <pre><code># \u53ea\u4f1a\u89e3\u6790\u5f53\u524d\u76ee\u5f55\u4e0b\u7684\u6240\u6709go\u6587\u4ef6\ngo generate # \u4f1a\u521b\u5efastruct\u7c7b\u578b\u7684 getset \u65b9\u6cd5 \u7684go\u6587\u4ef6\n# \u6216\u8005\ncd codegen\ngo build .\nmv codegen /usr/local/bin\n\u7136\u540e\u5728\u6ce8\u91ca\u4e2d \u8fd9\u6837\u5199 \u4e5f\u662fok\u7684\n//go:generate codegen\n\n# \u89e3\u6790\u5b50\u76ee\u5f55 pkg \u9700\u8981\u8fdb\u53bb\u76ee\u5f55?\ncd pkg\ngo generate\n</code></pre>"},{"location":"go/pkg/go-generate/#stringer","title":"stringer","text":"<p>Todo</p> <p>todo</p>"},{"location":"go/pkg/gocron/","title":"Gocron","text":""},{"location":"go/pkg/gocron/#gocron","title":"gocron","text":"<pre><code>import \"github.com/go-co-op/gocron\"\nfunc sync() {\nfmt.Println(1111)\n}\nfunc main() {\ns := gocron.NewScheduler(time.Local)\ns.Every(1).Seconds().Do(sync)\ns.StartBlocking()\ns.StartAsync()\ntest()\n}\n</code></pre>"},{"location":"go/pkg/gorm/","title":"gorm","text":"<p>Danger</p> <p>\u5f85\u6574\u7406</p>"},{"location":"go/pkg/gorm/#_1","title":"\u5173\u8054\u5173\u7cfb","text":""},{"location":"go/pkg/gorm/#_2","title":"\u5c5e\u4e8e","text":"<p>user \u5c5e\u4e8e\u67d0\u4e2aprofile, profile\u8868\u6ca1\u6709user\u7684\u4efb\u4f55\u4fe1\u606f \u53ef\u4ee5\u8bf4 \u4e00\u4e2aprofile \u53ef\u4ee5\u8ba9\u591a\u4e2auser \u4f7f\u7528, \u6240\u4ee5\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u8bbe\u8ba1\u8868 \u540e\u9762\u53ef\u4ee5\u770b\u770b \u5305\u542b\u5173\u7cfb\u7684\u7406\u89e3</p> <p>ForeignKey AssociationForeignKey\u5982\u4f55\u586b \u5982\u4e0b\u4e3a\u4f8b \u6211\u4eec\u8981\u5f97\u5230Profile ,\u80af\u5b9a\u662f\u6839\u636e\u67d0\u4e2a\u5b57\u6bb5 \u5173\u8054\u5230Profile\u8868\u624d\u884c \u8fd9\u4e2a\u5173\u8054\u7684\u5b57\u6bb5\u5c31\u662f ForeignKey,\u5916\u952e,\u8fd9\u4e2a\u503c\u4e0d\u662f\u968f\u4fbf\u63d2\u5165\u7684,\u662f\u53e6\u5916\u4e00\u4e2a\u8868\u7684\u6570\u636e \u4e0d\u7ba1\u662f\u5305\u542b\u8fd8\u662f\u5c5e\u4e8e,\u601d\u8003\u4e00\u4e0b,\u6211\u8981\u5f97\u5230\u8fd9\u4e2a profile \u662f\u6839\u636e\u54ea\u4e2a\u5b57\u6bb5 \u5c31\u5199\u54ea\u4e2a \u8fd9\u4e2a\u5b57\u6bb5\u53ef\u80fd\u5728 User\u8868 \u4e5f\u53ef\u80fd\u5728Profile\u8868(\u4e0d\u540c\u7684\u5173\u7cfb,\u5728\u4e0d\u540c\u7684\u8868) \u800cAssociationForeignKey \u586b\u7684 \u5c31\u662f\u4f60\u5199\u7684\u5916\u952e\u662f\u4e0e\u54ea\u4e2a\u5b57\u6bb5 \u8fdb\u884c\u5173\u8054\u7684,\u4e00\u822c\u53ef\u80fd\u662f\u4e3b\u952e</p> <pre><code>type MyUser struct {\ngorm.Model\n// \u5728\u5c5e\u4e8e\u5173\u7cfb\u4e2d,ForeignKey \u8868\u793a \u5f53\u524dUser\u8868\u4e2d ProfileID \u5c5e\u4e8e\u5916\u952e\n// \u5c31\u662f\u8bf4\u8be5\u503c\u4e0d\u662f\u968f\u4fbf\u63d2\u5165\u5230user\u8868\u7684, \u4ed6\u7684\u503c \u6765\u81ea\u4e8e Profile\u8868\u7684 \u67d0\u4e2a\u5b57\u6bb5,\u8fd9\u68372\u4e2a\u8868\u5c31\u5c06\u5efa\u7acb\u4e86\u5173\u7cfb\u4e86\n//AssociationForeignKey \u8fd9\u4e2a\u5c31\u662f\u6765\u6307\u5b9a \u662f\u6765\u81ea\u4e8e\u54ea\u4e2a\u5b57\u6bb5\u7684,\nProfile   Profile `gorm:\"ForeignKey:ProfileID;AssociationForeignKey:ID\"`\nProfileID int\n}\ntype MyProfile struct {\ngorm.Model\nName string\n}\nctx = context.Background()\ndb, err:= gorm.Open(\"mysql\", \"root:@tcp(127.0.0.1:3306)/hx?charset=utf8&amp;parseTime=True&amp;loc=Local\")\nfmt.Println(err)\ndb.LogMode(true)\ndefer db.Close()\ndb.Set(\"gorm:table_options\", \"ENGINE=InnoDB\").AutoMigrate(&amp;User{},&amp;Profile{})\np:=MyProfile{}\nu:=MyUser{}\ndb.First(&amp;u)\n// \u4e0b\u9762\u8fd9\u4e2a\u4f1a\u62a5\u9519\u7684, \u67e5\u770bRelated\u7684\u6e90\u7801, \u80fd\u53d1\u73b0\u95ee\u9898\n// \u5982\u679c\u6211\u4eec\u7684\u6a21\u578b\u540d\u5b57\u548c\u5916\u952e\u540d\u5b57\u4e0d\u8fd9\u6837\u8d77\u7684\u8bdd,\u5c31\u4e0d\u4f1a\u6709\u95ee\u9898\ndb.Model(&amp;u).Related(&amp;p)\n// \u6b63\u786e\u7684\u65b9\u5f0f\u9700\u8981 \u6307\u5b9a\u5916\u952e \u6216\u8005 \u662f  MyProfile (MyUser\u6a21\u578b\u7684\u5c5e\u6027) \ndb.Model(&amp;u).Related(&amp;p,\"ProfileID\")\n// \u4e5f\u53ef\u4ee5\u8fd9\u6837\ndb.Model(&amp;u).Related(&amp;u.MyProfile,\"ProfileID\")\n// \u4e00\u6b65\u8d70\u5230\u4f4d\n// u.MyProfile \u4e5f\u6709\u4e86\n// \u5148\u67e5\u8be2my_users \u8868, \u5f97\u5230profile_id,\u7136\u540e\u53bb\u67e5\u8be2my_profiles \u8868\ndb.Model(&amp;u).Preload(\"MyProfile\").First(&amp;u)\n</code></pre>"},{"location":"go/pkg/gorm/#_3","title":"\u5305\u542b\u4e00\u4e2a","text":"<pre><code>// User \u5305\u542b\u4e00\u4e2a CreditCard, UserID \u4e3a\u5916\u952e\ntype User struct {\ngorm.Model\nCreditCard   CreditCard\n}\ntype CreditCard struct {\ngorm.Model\nUserID   uint\nNumber   string\n}\nvar card CreditCard\ndb.Model(&amp;user).Related(&amp;card, \"CreditCard\")\n//// SELECT * FROM credit_cards WHERE user_id = 123; // 123 is user's primary key\n// CreditCard\u662fuser\u7684\u5b57\u6bb5\u540d\u79f0\uff0c\u8fd9\u610f\u5473\u7740\u83b7\u5f97user\u7684CreditCard\u5173\u7cfb\u5e76\u5c06\u5176\u586b\u5145\u5230\u53d8\u91cf\n// \u5982\u679c\u5b57\u6bb5\u540d\u4e0e\u53d8\u91cf\u7684\u7c7b\u578b\u540d\u76f8\u540c\uff0c\u5982\u4e0a\u4f8b\u6240\u793a\uff0c\u53ef\u4ee5\u7701\u7565\uff0c\u5982\uff1a\ndb.Model(&amp;user).Related(&amp;card)\n</code></pre> <ul> <li>\u6307\u5b9a\u5916\u952e\u548c\u5173\u8054\u5916\u952e</li> </ul> <pre><code>// \u8fd9\u4e2a\u4f8b\u5b50\u4e2d ,\u4e0e\u4e4b\u524d\u7684\u5c5e\u4e8e,\u505a\u4e2a\u5bf9\u6bd4\n// \u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u4ece  \u6570\u636e\u5e93\u8bbe\u8ba1\u4e0a, \u4e00\u4e2aUser\u662f\u53ef\u4ee5\u6709\u591a\u4e2aProfile\u7684\n// \u53ea\u4e0d\u8fc7\u8fd9\u91ccUser\u6a21\u578b \u7684Profile \u5c5e\u6027 \u7c7b\u578b\u662f\u5355\u4e00\u5bf9\u8c61, \u8868\u793a \u53ea\u6709\u4e00\u4e2aprofile,\n// \u5982\u679c\u662f\u5305\u542b\u591a\u4e2a, \u5c31\u7528 []Profile \u5c31\u884c\u4e86\ntype Profile struct {\ngorm.Model\nName   string\nUserID uint\n}\ntype User struct {\ngorm.Model\nRefer   string\n// User\u5f97\u5230Profile \u662f\u6839\u636e Profile\u8868\u7684UserID\u5916\u952e, \n// \u8be5\u5916\u952e\u662f \u4e0e User\u8868\u7684 Refer \u5b57\u6bb5\u5173\u8054\u7684,\u5c31\u662f\u8bf4\u5916\u952e\u7684\u503c\u6765\u81ea\u4e8e Refer,\u9ed8\u8ba4\u4e0d\u5199\u7684\u8bdd\u662fID\nProfile Profile `gorm:\"ForeignKey:UserID;AssociationForeignKey:Refer\"`\n}\n// \u53e6\u5916\u4e00\u4e2a\u4f8b\u5b50\ntype MyUser struct {\ngorm.Model\nIds int64\nMyProfile   MyProfile   `gorm:\"ForeignKey:ProfileID;AssociationForeignKey:ID\"` ProfileID int\nName string\n// \u540c\u7406\nEmail Email `gorm:\"ForeignKey:UserID;AssociationForeignKey:IDs\"`\n}\ntype Email struct{\nUserID int64\ngorm.Model\nEm string\n}\ntype MyProfile struct {\ngorm.Model\nHeight int64\nName string\nT int64\n}\n</code></pre>"},{"location":"go/pkg/gorm/#_4","title":"\u5305\u542b\u591a\u4e2a","text":"<pre><code>// User \u5305\u542b\u591a\u4e2a emails, UserID \u4e3a\u5916\u952e\ntype User struct {\ngorm.Model\nEmails   []Email\n}\ntype Email struct {\ngorm.Model\nEmail   string\nUserID  uint\n}\ndb.Model(&amp;user).Related(&amp;emails)\n</code></pre>"},{"location":"go/pkg/gorm/#_5","title":"\u901a\u8fc7\u4e3b\u952e(\u6216\u8005\u5176\u4ed6\u5b57\u6bb5)\u5224\u65ad\u5982\u679c\u6709\u8bb0\u5f55\u5219\u66f4\u65b0,\u5426\u5219\u521b\u5efa\u65b0\u7684\u8bb0\u5f55","text":"<p>\u4e0d\u4f1a\u4f7f\u7528\u4f60\u4f20\u9012\u7684\u4e3b\u952e\u7684</p> <pre><code>r := Reviewer{}\n// b := Reviewer{Name: \"yy\"}\n// id\u662f\u4e3b\u952e, \u5728 assign\u91cc\u4e0d\u8981\u6dfb\u52a0 id ,\u5426\u5219\u4f1a\u4fee\u6539\u7684\n// \u8fd9\u91cc\u7684\u610f\u601d\u5373\u4f7f \u627eid=1\u7684\u8bb0\u5f55,\u5982\u679c\u6709\u5219\u66f4\u65b0,\u5426\u5219\u521b\u5efa\n// \u5982\u679cassign \u53c2\u6570\u4f7f\u7528\u7684 \u662f \u5bf9\u8c61 ,\u5219\u91cc\u9762\u5982\u679c\u6709\u7684\u503c\u662f0 \u6216\u8005false,\u662f\u4e0d\u6267\u884c\u7684\n// \u800c\u4f7f\u7528map\u5219\u53ef\u4ee5. \u56e0\u4e3a0,false \u53ef\u80fd\u662f\u9ed8\u8ba4\u503c,\u5904\u7406\u4e0a \u4e0d\u53bb\u6267\u884c\u4e86\nerr = db.Model(&amp;r).Where(\"id=1\").Assign(map[string]interface{}{\n\"name\": \"ioioxx\",\n}).FirstOrCreate(&amp;r).Error\n</code></pre> <p>\u6ce8\u610f\u5b9e\u9645\u4e0a\u4e0a\u9762\u7684\u7528\u6cd5 \u4e00\u822c\u7528\u5728\u4e00\u5b9a\u8981\u5148\u5224\u65ad\u662f\u5426\u5b58\u5728\u7684\u90a3\u79cd\u9700\u6c42,\u800c\u4e14\u67e5\u8be2\u7684\u6761\u4ef6\u4e0d\u662fid \u50cf\u4e0a\u9762\u7684 \u7528 \u5224\u65adid\u662f\u5426==0 =0\u5219\u521b\u5efa,!=0 \u5219\u4fee\u6539 \u00a0\u4f1a\u66f4\u597d, \u4e0d\u7528\u6bcf\u6b21\u90fd\u67e5\u8be2 \u5982\u679c\u662f\u5224\u65ad\u8868\u91cc\u662f\u5426\u6709title\u4e3axx\u7684\u8bb0\u5f55,\u6ca1\u6709\u5219\u5199\u5165,\u6709\u5219\u4fee\u6539\u8fd9\u6837\u7684\u9700\u6c42 \u5219\u7528\u4e0a\u9762\u7684</p>"},{"location":"go/pkg/gorm/#hooks","title":"hooks","text":""},{"location":"go/pkg/gorm/#_6","title":"\u9488\u5bf9\u5355\u4e2a\u6a21\u578b\u7684\u94a9\u5b50","text":"<pre><code>func (m *Course) AfterCreate(scope *gorm.Scope) error {\n// scope.SetColumn(\"ID\", uuid.New())\nfmt.Println(scope.FieldByName(\"title\"))\n// fmt.Println(len(*scope.Fields))\n// \u53ef\u4ee5\u83b7\u53d6\u5230\u6a21\u578b\u8bbe\u7f6e\u7684\u503c, \u6a21\u578b\u4e2d\u53ef\u4ee5\u8bbe\u7f6e\u6570\u636e\u5e93\u4e0d\u9700\u8981\u7684\u503c\n// Bbb         string      `gorm:\"-\"`  \u9700\u8981\u6709 `gorm:\"-\"`\nfor _, v := range scope.Fields() {\nfmt.Println(*v)\n}\nfmt.Println(scope.IndirectValue)\nreturn nil\n}\nfunc (cp *CourseProgress) AfterDelete() error {\n// \u4e00\u6761\u8bed\u53e5\u5220\u9664\u591a\u6761\u8bb0\u5f55,\u53ea\u4f1a\u89e6\u53d1\u4e00\u6b21\u8fd9\u4e2a\n// cp\u7684\u5c5e\u6027\u503c,\u5e76\u4e0d\u4f1a\u4ece\u6570\u636e\u5e93\u91cc\u8bfb\u53d6\u4ec0\u4e48, \u8fd8\u662f\u539f\u6765\u8c03\u7528\u65f6\u7684\u6837\u5b50\nfmt.Println(\"x\", cp)\nreturn nil\n}\nfunc\u00a0(m\u00a0*Course)\u00a0AfterUpdate(scope\u00a0*gorm.Scope)\u00a0error\u00a0{\n// \u66f4\u65b0\u591a\u6761\u8bed\u53e5\u53ea\u4f1a\u89e6\u53d1\u4e00\u6b21\u8fd9\u4e2a\u64cd\u4f5c\n// m\u7684\u503c \u662f\u4e4b\u524d \u8c03\u7528update \u65f6\u7684\u6a21\u578b,\u4ee5\u53ca update() \u4e2d\u8bbe\u7f6e\u8981\u66f4\u65b0\u7684\u5c5e\u6027\u7684\u503c\u90fd\u4f1a\u8d4b\u503c\u7ed9\u6a21\u578bm, \u8fd8\u6709\u66f4\u65b0\u65f6\u95f4\u4f1a\u6709\n//\u00a0fmt.Println(scope.FieldByName(\"ID\"))\nfmt.Println(scope.CombinedConditionSql())\nfmt.Println(scope.SQLVars)\nfmt.Println(scope.SQL)\n// fmt.Println(scope.Search)\nfmt.Println(scope.SelectAttrs())\nfor _, vv := range scope.Fields() {\nfmt.Println(vv.Name, vv.Field)\n}\n//\u00a0fmt.Println(scope.IndirectValue)\nreturn\u00a0nil\n}\n</code></pre>"},{"location":"go/pkg/gorm/#callback","title":"callback\u4e2d\u7684\u4e8b\u52a1\u95ee\u9898","text":"<pre><code>// \u4ecegorm \u6e90\u7801\u4e2d callback_create.go  callMethod\u53bb\u770b\n// \u6839\u636e\u4e0d\u540c\u7684\u56de\u8c03\u65b9\u6cd5(\u5176\u5b9e\u5c31\u662f\u53c2\u6570\u4e0d\u540c\u7684\u60c5\u51b5\u4e0b)\u4e0d\u540c\u7684\u6267\u884c\u65b9\u5f0f\n// \u4f7f\u7528scope *gorm.DB\n// scope.Create(&amp;a) \u6b63\u786e\u6267\u884c,\u7136\u540e\u540e\u9762\u8fd4\u56deerr, \u8fd9\u79cd\u60c5\u51b5, \u90fd\u56de\u6eda\u4e86\nfunc (m *ModuleQuiz) AfterCreate(scope *gorm.DB) error {\na := Lesson{CourseID: 1234, Payload: \"{}\", Covers: \"{}\"}\nscope.Create(&amp;a)\nreturn errors.New(\"abc\")\n}\n// scope *gorm.Scope\nfunc (m *ModuleQuiz) AfterCreate(scope *gorm.Scope) error {\na := Lesson{CourseID: 1234, Payload: \"{}\", Covers: \"{}\"}\nscope.DB().Create(&amp;a) //  \u8fd9\u4e2a\u4f1a\u6267\u884c\u7684, \u5373\u4f7f\u540e\u9762\u8fd4\u56de\u4e86error\nreturn errors.New(\"abc\")\n}\n</code></pre>"},{"location":"go/pkg/gorm/#preload","title":"preload","text":"<p>preload \u7684\u610f\u4e49\u662f\u5565,\u8111\u5b50\u91cc\u60f3\u4e00\u60f3, preload\u91cc\u7684\u4e1c\u897f\u4e00\u5b9a\u662f\u6839\u636e\u4f60\u5916\u90e8\u7684\u8868\u7684\u4e00\u4e2a \u5b57\u6bb5\u6765\u5173\u8054,\u7136\u540e\u67e5\u8be2\u6570\u636e \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770bsql \u5f97\u51fa ,\u5b9e\u9645\u4e0a\u5c31\u53ea\u67092\u6761sql\u8bed\u53e5,\u4e00\u6761\u662f\u5f97\u5230course\u7684\u8bb0\u5f55 \u4e00\u6761\u662f\u83b7\u53d6\u8bfe\u7a0b\u7684\u8bfe\u8282\u7684\u4fe1\u606f, \u00a0\u8fd9\u6761\u7684sql\u662f \u8fd9\u6837\u7684 course_id in(...) , \u7136\u540e\u5b9e\u9645\u4e0a \u5e94\u8be5\u662f\u505a\u4e86\u4e00\u4e2a\u5faa\u73af,\u6839\u636elesson\u7684course_id\u6765\u62fc\u63a5\u5230\u6570\u7ec4\u91cc,\u6240\u4ee5\u6211\u4eec\u7684prelaod\u7684\u67e5\u8be2\u8bed\u53e5\u5982\u679c\u662f\u81ea\u5df1\u505a\u4e86\u4e9b\u5b9a\u4e49,\u5fc5\u987b\u5e26\u4e0a course_id ,\u5426\u5219 \u4f60\u65e0\u6cd5\u83b7\u53d6,\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48 \u4e0b\u9762\u7684\u8bed\u53e5,\u770b\u8d77\u6765\u53ea\u8981\u83b7\u53d6count\u5c31\u53ef\u4ee5,\u4e3a\u4ec0\u4e48\u8fd8\u8981\u83b7\u53d6course_id\u8fd9\u4e2a\u5b57\u6bb5\u7684\u539f\u56e0 \u8bb0\u5f97\u8fd8\u8981group_by , \u60f3\u60f3 2\u6761sql\u8bed\u53e5\u5c31\u77e5\u9053\u4e86</p> <pre><code>err := resource.GetDB().Model(&amp;Course{}).\nCount(&amp;cnt).\nScopes(PageAndSize(page, size)).\nPreload(\"Lesson\", func(db *gorm.DB) *gorm.DB {\n// \u83b7\u53d6 \u5fc5\u987b\u8981\u5e26\u4e0a \u4e00\u4e2acourse_id, \u8fd9\u91cc\u7684As count \u53ef\u4ee5 as id ,\u8fd9\u6837\u4f60\u7684Lesson\u6a21\u578b\u4e0d\u7528\u6dfb\u52a0\u989d\u5916\u7684\u5c5e\u6027\nreturn db.Select(\"course_id,count(id) AS count\").Group(\"course_id\")\n}).\nFind(&amp;cl).Error\n</code></pre> <pre><code>// \u6bcf\u4e2alesson\u90fd\u6709\u4e00\u4e2a\u5bf9\u5e94\u7684progress\n// \u6211\u4eec\u9700\u8981\u6240\u6709\u7684Lesson\u7684progress\u65f6 ,\u7528 Lessons.Progress\n// \u5982\u679c\u4f7f\u7528Lesson.Progress \u53ea\u4f1a\u83b7\u53d6\u4e00\u4e2a\nerr = resource.GetDB().Model(c).Where(courseIDs).\nPreload(\"Lessons\", func(db *gorm.DB) *gorm.DB {\nreturn db.Order(\"id\")\n}).\nPreload(\"Lessons.Progress\", func(db *gorm.DB) *gorm.DB {\n</code></pre>"},{"location":"go/pkg/gorm/#update-create-save","title":"update create save","text":""},{"location":"go/pkg/gorm/#update","title":"update","text":"<p>update \u51e1\u662f\u9ed8\u8ba4\u503c\u5f97,\u90fd\u4e0d\u4f1a\u66f4\u65b0, \u6709\u5c31\u662f\u8bf4\u5982\u679c\u4f60\u9700\u8981\u5c06status\u4fee\u6539\u4e3a0, \u4f60\u80af\u5b9a\u4f20\u9012\u8fc7\u67650, \u800c\u5b9e\u9645\u4e0a \u4e0d\u4f1a\u4fee\u6539, \u56e0\u4e3a0\u662f\u9ed8\u8ba4\u503c</p> <p>\u6240\u4ee5\u5efa\u8bae\u8868\u91cc\u7684\u5b57\u6bb5\u7684\u503c\u8bbe\u7f6e\u4e0d\u8981\u67090</p>"},{"location":"go/pkg/gorm/#save","title":"save","text":"<p>\u90fd\u4f1a\u66f4\u65b0 \u662f\u4e0d\u662f\u9ed8\u8ba4\u503c\u4e0d\u7ba1, \u4f7f\u7528\u6a21\u578b\u7684\u9ed8\u8ba4\u503c \u8fdb\u884c\u5199\u5165\u6570\u636e\u5e93\u4e86</p>"},{"location":"go/pkg/gorm/#create","title":"create","text":"<p>\u4f7f\u7528\u6a21\u578b\u7684\u9ed8\u8ba4\u503c, \u6240\u4ee5\u4f60\u4e0d\u4f20\u9012\u7684\u5b57\u6bb5,\u4f1a\u4f7f\u7528\u6a21\u578b\u7684\u9ed8\u8ba4\u503c\u6765\u8fdb\u884c\u521d\u59cb\u5316,\u5199\u5165\u6570\u636e\u5e93\u4e2d \u8fd9\u79cd \u4e5f\u4e0d\u597d, \u56e0\u4e3a\u6570\u636e\u5e93\u8868\u8bbe\u8ba1\u6709\u53ef\u80fd\u6709\u9ed8\u8ba4\u503c \u6bd4\u59821, \u90a3\u8fd9\u79cd\u60c5\u51b5\u5c31\u4f1a\u5bfc\u81f4\u5199\u51650\u4e86</p>"},{"location":"go/pkg/gorm/#_7","title":"\u9ed8\u8ba4\u503c\u95ee\u9898","text":"<pre><code>type Animal struct {\nID   int64\nName string `gorm:\"default:'galeone'\"`\nAge  int64\n}\n</code></pre> <p>\u7136\u540e\u6d4b\u8bd5 \u5199\u5165\u548c\u83b7\u53d6 \u4ee5\u53ca\u66f4\u65b0\u65f6 \u662f\u8be5\u9ed8\u8ba4\u503c \u4f1a\u4e0d\u4f1a\u66f4\u65b0</p> <p>\u597d\u50cf\u6839\u672c\u4e0d\u4f1a\u5199\u5165\u9ed8\u8ba4\u503c\u5230\u6570\u636e\u5e93</p> <ul> <li>\u4f7f\u7528\u4e0b\u97622\u79cd\u65b9\u5f0f</li> </ul> <p>\u8fd9\u6837\u6ca1\u6709\u4f20\u9012\u7684\u65f6\u5019,\u662f\u4e0d\u4f1a\u7528\u6240\u8c13\u7684\u9ed8\u8ba4\u503c\u5199\u5165\u5230\u6570\u636e\u5e93\u7684 create</p> <pre><code>// Use pointer value\ntype User struct {\ngorm.Model\nName string\nAge  *int   //\n}\n// Use scanner/valuer\ntype User struct {\ngorm.Model\nName string\nAge  sql.NullInt64  //\n}\n</code></pre> <ul> <li>\u4e2a\u4eba\u89c9\u5f97\u53ef\u80fd\u8fd8\u662f\u8fd9\u6837\u5904\u7406</li> <li>\u5982\u679c\u6570\u636e\u5e93\u91cc\u9700\u8981NUll \u8fd9\u6837\u7684,\u5219\u7528* \u6216\u8005nullint64\u8fd9\u79cd</li> <li>\u5982\u679c\u6570\u636e\u5e93\u9ed8\u8ba4\u503c\u4e3a&gt;0\u7684,\u7136\u540ecreate\u65f6,\u6ca1\u6709\u4f20\u9012,\u60f3\u8981\u4f7f\u7528\u6570\u636e\u5e93\u4e2d\u7684\u9ed8\u8ba4\u503c,\u5219\u4ee3\u7801\u4e2d\u76f4\u63a5\u5199\u4e0a,if =0 {} else {} \u8bbe\u7f6e\u6a21\u578b\u7684\u503c\u4e3a\u6570\u636e\u5e93\u9ed8\u8ba4\u503c ? \u597d?</li> <li>update \u65f6\u6a21\u578b\u662f\u9ed8\u8ba4\u503c \u662f\u4e0d\u66f4\u65b0\u7684,\u6240\u4ee5\u5c3d\u91cf\u4e0d\u8981\u4f7f\u75280</li> <li>\u6dfb\u52a0\u65f6\u60f3\u8981\u4f7f\u7528\u6570\u636e\u5e93\u7684\u9ed8\u8ba4\u503c \u662f\u5426\u53ef\u4ee5 \u00a0<code>gorm:\"-\"</code> \u6765\u5904\u7406\u8be5\u5b57\u6bb5 (\u83b7\u53d6\u7684\u65f6\u5019\u5e94\u8be5 \u662f\u53ef\u4ee5\u7684?)</li> </ul>"},{"location":"go/pkg/gorm/#omitinsertupdate","title":"\u4f7f\u7528omit\u6765\u6392\u9664\u4e0d\u8981insert\u7684\u548cupdate\u7684 \u89e3\u51b3\u4e0a\u9762\u7684\u95ee\u9898","text":""},{"location":"go/pkg/gorm/#bytejson","title":"\u4f7f\u7528[]byte\u6765\u5904\u7406json\u7c7b\u578b\u7684\u5b57\u6bb5","text":"<pre><code>// \u5c06proto message \u91cc\u7684\u5b57\u6bb5\u5b9a\u4e49\u4e3abytes ,==&gt; go ==&gt; []byte\n// gorm model \u5b57\u6bb5\u4e5f\u8bbe\u7f6e\u4e3a[]byte ,\u53ef\u4ee5\u4ece\u6570\u636e\u5e93\u91cc\u8bfb\u53d6\u5230\u6570\u636e, \u5199\u5165\u4e5f\u662fok\u7684,\n//  \u5982\u679c\u6211\u4eec\u60f3\u8981\u5c06json\u683c\u5f0f\u7684\u6570\u636e \u8fd4\u56de\u5230\u6d4f\u89c8\u5668\u90a3\u8fb9 \u662fjson\u7684\u683c\u5f0f\u7684\u8bdd, \u5c06[]byte \u683c\u5f0f \u5199\u6210 json.RawMessage \u5373\u53ef\n// \u6b63\u5e38\u60c5\u51b5\u4e0b\u6211\u4eec\u4f1a\u8fd9\u6837\u5904\u7406\na:=`{\"name\":\"x\",\"school\":{\"name\":\"qh\",\"class\":11}}`\ntype Person struct{\nAge int64\nSch string\n}\np:=Person{\nAge:11,\nSch:a\n}\njson.Marshal(p)  ==&gt; \u5f97\u5230\u7684sch \u8fd8\u662f\u4e2a\u5b57\u7b26\u4e32\ntype Person struct{\nAge int64\nSch json.RawMessage  ==&gt; \u5b9e\u9645\u5c31\u662f[]byte, \u53ef\u4ee5\u770b\u770b\u6e90\u7801\n}\np:=Person{\nAge:11,\nSch:(json.RawMessage)(a)\n}\njson.Marshal(p)  ==&gt; \u53ef\u4ee5\u90fd\u53d8\u6210\n</code></pre>"},{"location":"go/pkg/gorm/#_8","title":"\u6709\u5173\u4f7f\u7528\u5206\u8868\u7684\u6ce8\u610f\u4e8b\u9879","text":"<pre><code>// \u6839\u636euid \u6765\u5224\u65ad\u5199\u5165\u54ea\u4e2a\u8868\nfunc (t *Test) TableName() string {\nreturn fmt.Sprintf(\"test_%d\", t.UID%10)\n}\n</code></pre> <p>\u5728\u4f7f\u7528 \u67e5\u8be2,\u66f4\u65b0 ,\u521b\u5efa\u7684\u65f6\u5019,\u9700\u8981\u6ce8\u610f\u662f\u5426\u7528\u5230 \u5206\u8868</p> <pre><code>// \u4f7f\u7528 &amp;Test{} \u4f7f\u7528\u5230\u4e86 \u5206\u8868\n//  &amp;\u6ce8\u610f\u8fd9\u4e2a  \u6ca1\u6709&amp; \u7684  \u5c31\u4e0d\u9002\u7528\u4e86\n// \u90fd\u662f\u6709deleted_at is null\u7684\nModel(&amp;Test{UID: 8}).Update(...)\n.Model(&amp;User).Create(&amp;Test{UID:8})  // \u521b\u5efa\u7684\u662ftest ,\u4e0emodel\u6307\u5b9a\u7684\u65e0\u5173\n.Create(&amp;Test{UID:8})  //\u8d70\u5206\u8868\u7684\n.Create(Test{UID:8})  //\u6ca1&amp; \u4e0d\u8d70\u5206\u8868\u7684\n// \u56e0\u4e3a\u4f7f\u7528Find \u5176\u5b9e \u4e0d\u4f1a\u53bb\u7ba1Model\u91cc\u8bbe\u7f6e\u7684\u662f\u54ea\u4e2a\u8868\n// \u7ecf\u8fc7\u6d4b\u8bd5, \u5c31\u662f\na:=Test{}\nModel(&amp;User{}).Find(&amp;a) // \u627e\u7684\u662ftest\u8868,\u4e0e Model\u91cc\u7684User\u8868\u65e0\u5173\n.Model(&amp;Test{UID:8}).Find(&amp;..)  // \u4e0d\u7ba1model\u6709\u6ca1\u6709&amp; \u90fd\u4e0d\u8d70\u5206\u8868\n// \u9700\u8981\u6307\u5b9a .Table((&amp;Test{UID:8}).TableName())\n.Model(&amp;Test{UID:8}).Scan(&amp;..)  //\u8d70\u5206\u8868   Model(\u6ca1&amp;)  \u4e0d\u8d70\u5206\u8868\n// Scan \u4e0e Find \u7684\u533a\u522b\u662f,\u4ed6\u5fc5\u987b\u6307\u5b9atable\u6216\u8005model\n// \u6240\u4ee5\u4e0a\u9762\u6211\u4eec\u7684Scan \u6307\u5b9a\u4e86model \u662f\u8d70\u5206\u8868\u7684\n// \u51e1\u662f\u7528.Table \u6765\u6307\u5b9a\u8868\u540d\u7684, \u67e5\u8be2\u4e0d\u4f1a\u6709 deleted_at is null\n// \u66f4\u65b0\u4e5f\u4e0d\u4f1a\u66f4\u65b0 updated_at\nFirst() \u6362\u6210 Model(&amp;).order limit .Scan(&amp;obj)\n// model \u4e0d\u4f1a\u7ba1cp\u5c5e\u6027\u7684\u503c \u6765\u4f5c\u4e3a\u8fc7\u6ee4\u6761\u4ef6,(\u9664\u975e\u662f\u4e3b\u952eid\u6709\u503c,\u5219\u4f1a\u4f5c\u4e3awhere\u6761\u4ef6)\n// \u53ea\u4f1a\u5173\u5fc3where\u91cc\u7684 ,\u5982\u679cwhere\u91cc\u7684\u7528\u7684\u662f\u6a21\u578b,\u90a3\u4e48 \u7528&amp; \u624d\u4f1a\u6307\u5b9atablename\n// \u5426\u5219 \u51fa\u95ee\u9898\n.Model(&amp;cp).Where(&amp;cp).Scan()\n// \u6ce8\u610f\u5982\u679c\u8fd9\u91ccWhere(&amp;cp), \u7136\u540e\u540e\u9762update, \u4f1a\u5148\u5c06\n// is_finished \u5c5e\u6027true\u503c \u8bbe\u7f6e\u5230\u6a21\u578bcp\u4e2d,\u7136\u540e\u4f5c\u4e3awhere\u6761\u4ef6\n// \u8fd9\u6837\u5c31\u5bfc\u81f4\u95ee\u9898\u4e86,\n// update is_finished=true where is_finished =true   XX\n// where \u8fd8\u662f\u4e0d\u7528\u6a21\u578b\u6bd4\u8f83\u597d\ncp := models.CourseProgress{UID: 1457341, LessonID: 97}\nresource.GetDB().\n//Where(\"uid = ?\", cp.UID).\n//Where(\"lesson_id = ?\", cp.LessonID).\nWhere(&amp;cp). Model(&amp;cp).\nUpdate(\"is_finished\", true)\n</code></pre> <pre><code>// \u8fd9\u91cc\u4e0d\u662f\u6307\u9488\ncp := CourseProgress{\nPlatform: 2,\nUID:      121,\nCourseID: 100,\n}\n//\u4f46\u662f\u4f20\u9012\u8fdb\u53bb\u7684\u662f\u6307\u9488,\u6240\u4ee5\u91cc\u9762\u4f1a\u4f7f\u7528\u5230 \u5206\u8868\ncp.DeleteCourseProgress()\nfunc (cp *CourseProgress) DeleteCourseProgress() error {\nfmt.Println(cp.LessonID)\ncp.LessonID = 10\n// Delete(cp) \u662f\u6307\u9488 \u624d\u4f1a\u4f7f\u7528\u6a21\u578b\u4e2d\u7684TableName()\nreturn resource.GetDB().Where(cp).Delete(cp).Error\n}\n</code></pre> <pre><code>func (c *User) Test() {\nfmt.Println(c.ID)\nc.ID = 123\n}\nfunc main() {\nu := User{Name: \"xx\"}\nu.Test()\nfmt.Println(u) // \u4fee\u6539\u4e86id\n}\n</code></pre>"},{"location":"go/pkg/gorm/#_9","title":"\u5176\u4ed6\u6280\u5de7","text":"<pre><code>\u8fd9\u6837\u9ed8\u8ba4\u7684\u8868\u540d\u4e0d\u662f+s \u7684, \u53ef\u4ee5\u4e0d\u7528 TableName()\u6765\u5177\u4f53\u6307\u5b9a\u4e86\ndb.SingularTable(true)\n\n\u4fee\u6539\u9ed8\u8ba4\u8868\u540d\n\u60a8\u53ef\u4ee5\u901a\u8fc7\u5b9a\u4e49DefaultTableNameHandler\u5bf9\u9ed8\u8ba4\u8868\u540d\u5e94\u7528\u4efb\u4f55\u89c4\u5219\ngorm.DefaultTableNameHandler = func (db *gorm.DB, defaultTableName string) string  {\n  return \"prefix_\" + defaultTableName;\n}\n\n*gorm.expr\u5b50\u67e5\u8be2\ndb.Where(\"amount &gt; ?\", DB.Table(\"orders\").Select(\"AVG(amount)\").Where(\"state = ?\", \"paid\").QueryExpr()).Find(&amp;orders)\n\n// Cancel limit condition with -1\ndb.Limit(10).Find(&amp;users1).Limit(-1).Find(&amp;users2)\n\n// Cancel offset condition with -1\ndb.Offset(10).Find(&amp;users1).Offset(-1).Find(&amp;users2)\n</code></pre>"},{"location":"go/pkg/gorm/#set","title":"Set \u7684\u4f7f\u7528","text":"<p>\u6211\u4eec\u5728afterUpdate\u8fd9\u79cd\u64cd\u4f5c\u4e2d,\u5982\u679c\u60f3\u8981\u77e5\u9053\u8be5update\u4e4b\u524d\u7684\u67d0\u4e2a\u5b57\u6bb5\u7684\u503c\u7684\u65f6\u5019\u600e\u4e48\u529e\u5462?</p> <pre><code>// gorm \u4e2d\u7684\u6bcf\u6b21.Where\u554a\u4ec0\u4e48\u7684\u64cd\u4f5c\u90fd\u662f db.clone() \u4e00\u6b21\u7684, \u4e4b\u540e\u7684clone\u90fd\u4f1a\u5e26\u4e0a\u4f60\u8bbe\u7f6e\u7684\u503c(set\u8bbe\u7f6e\u7684)\ne = db.Where(&amp;wher).Where(\"id = 111\").\nSet(\"old\", 1). // \u8fd9\u4e2a\u5c31\u662f\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u4e34\u65f6\u7684\u503c,\u5728afterupdate \u53ef\u4ee5\u4f7f\u7528\nUpdate(map[string]interface{}{\"is_finished\": true, \"stars\": 11})\n// \u6240\u4ee5\u4f60\u5728afterUpdate \u4e2d\u53ef\u4ee5\na, ok := scope.Get(\"old\")\nif ok {\nfmt.Println(\"ss\", a)\n}\nfmt.Println(scope.DB().RowsAffected)\n// \u8fd9\u6837\u6211\u4eec\u5c31\u7b97\u662f\u8fbe\u5230\u4e86,\u83b7\u53d6\u66f4\u65b0\u4e4b\u524d\u7684old \u503c\u7684\u8981\u6c42\u4e86\n</code></pre>"},{"location":"go/pkg/gorm/#table","title":".Table()","text":"<pre><code>// \u770b\u4e0b\u6e90\u7801\u5c31\u77e5\u9053\u4e86\n// \u6ca1\u6709 deleted_at is null  \u9700\u8981\u624b\u52a8\u6dfb\u52a0\nresource.GetDB().Table((&amp;Course{}).TableName()).Count() // \u5982\u679c\u4f7f\u7528\u7684\u662f Find \u5219\n//\u4e0d\u9700\u8981 deleted_at is null \u9ed8\u8ba4\u5c31\u6709\nTable((&amp;CourseProgress{UID: 2}).TableName()).\nFind(&amp;a)    // table \u6709\u6548, Model \u65e0\u6548\n</code></pre>"},{"location":"go/pkg/gorm/#first-find","title":"first &amp; find","text":"<p>\u610f\u4e49\u4e0a\u6765\u8bf4, \u6211\u4eec\u67e5\u8be2\u5217\u8868, \u6ca1\u6709\u6570\u636e\u662f\u5b8c\u5168\u6b63\u5e38\u7684, \u800c\u5f53\u6211\u4eec \u67e5\u8be2\u67d0\u4e00\u6761\u8bb0\u5f55\u662f\u5426\u5b58\u5728\u65f6,\u6b63\u5e38\u60c5\u51b5\u4e0b,\u6211\u4eec\u662f\u9700\u8981\u8fd9\u6761\u8bb0\u5f55\u7684, \u6240\u4ee5\u624d\u67e5\u8be2. \u6240\u4ee5\u7cfb\u7edf\u8bbe\u8ba1\u4e0a\u7ed9\u4f60\u62a5err\u4e86</p> <pre><code>//gorm  // callback_query.go / init()\n//\u67e5\u770b\u5b9e\u9645\u8c03\u7528\u7684 \u67e5\u8be2\u65b9\u6cd5.\nelse if scope.db.RowsAffected == 0 &amp;&amp; !isSlice {\nscope.Err(ErrRecordNotFound)\n}\n//\u6211\u4eec\u53d1\u73b0,Find(&amp; xx   ) xx \u4f7f\u7528\u5207\u7247\u7684\u65f6\u5019, \n//\u4e0d\u4f1a\u62a5ErrRecordNotFound, FIrst \u4f7f\u7528\u7684\u662f\u5355\u4e2a \u6240\u4ee5\u62a5ErrRecordNotFound\n</code></pre>"},{"location":"go/pkg/gorm/#_10","title":"\u5b50\u67e5\u8be2","text":"<p>subQuery \u662f\u4f1a\u7528() \u5305\u8d77\u6765\u7684</p> <pre><code>resource.GetDB().Exec(\nfmt.Sprintf(`insert into %s (a,b,c,d,created_at,updated_at,actived_at,e) select * from (?) tmp where not exists(?)`, cp.TableName()),\nresource.GetDB().\nModel(models.AB{}).\nSelect(\"?,b,c,d ,now(),now() ,now() ,'{}'\", cp.UID).\nWhere(\"id = ?\", c.ID).Order(\"id\").Limit(2).\nSubQuery(),\nresource.GetDB().Model(cp).Where(\"id=?\", ID).Where(\"id = tmp.id\").QueryExpr(),\n)\n</code></pre>"},{"location":"go/pkg/net/","title":"Net","text":""},{"location":"go/pkg/net/#ip","title":"\u83b7\u53d6ip\u5730\u5740","text":"<pre><code>func TestA(t *testing.T) {\nnetInterfaces, err := net.Interfaces()\nif err != nil {\npanic(err.Error())\n}\nfor i := 0; i &lt; len(netInterfaces); i++ {\nif (netInterfaces[i].Flags &amp; net.FlagUp) != 0 {\naddrs, _ := netInterfaces[i].Addrs()\nfor _, address := range addrs {\nif ipNet, ok := address.(*net.IPNet); ok &amp;&amp; !ipNet.IP.IsLoopback() {\n//\u83b7\u53d6IPv6\n/*if ipNet.IP.To16() != nil {\n                        fmt.Println(ipNet.IP.String())\n                    }*/\n//\u83b7\u53d6IPv4\nif ipNet.IP.To4() != nil {\nfmt.Println(ipNet.IP.String())\n}\n}\n}\n}\n}\n}\n</code></pre>"},{"location":"linux/nginx/","title":"nginx","text":""},{"location":"linux/nginx/#_1","title":"\u67e5\u770b\u914d\u7f6e","text":"\u53ef\u4ee5\u770b\u5230\u914d\u7f6e\u6587\u4ef6\u7684\u4f4d\u7f6e<pre><code>nginx -V | grep  abc  # \u4f60\u53d1\u73b0grep \u4efb\u4f55\u4e1c\u897f\u90fd\u4f1a\u8f93\u51fa...\nnginx -V # \u5b9e\u9645\u4e0a\u8fd9\u4e2a\u662f\u9519\u8bef\u4fe1\u606f\u8f93\u51fa\u5230\u7ec8\u7aef\nnginx -V 2&gt;&amp;1 |grep nginx.conf\nnginx -V 2&gt;&amp;1 1&gt;tmp.txt # \u8fd9\u6837\u624d\u4f1a\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6.\n</code></pre>"},{"location":"linux/bash/grep/","title":"grep","text":"<p>-E/egrep</p> <ol> <li>\u4e0d\u5e26-E\u7684\u65f6\u5019 \u90a3\u4e48{} () | + ? \u6ca1\u6709\u7279\u522b\u542b\u4e49,\u5c31\u662f\u5b83\u672c\u8eab,\u5982\u679c\u60f3\u8981\u53d8\u6210\u7279\u6b8a\u542b\u4e49\u5219\u524d\u9762\u52a0\u4e0a\\</li> <li>\u5e26\u4e0a-E\u4e0e\u4e4b\u76f8\u53cd</li> <li>\u7b49\u4ef7\u4e0eegrep</li> </ol>"},{"location":"linux/bash/grep/#-v","title":"-v \u663e\u793a\u4e0d\u5339\u914d\u7684\u884c","text":"1.txt\u4e0d\u5e26 -v\u5e26-v <pre><code>hello world\npython hell\nabc hello efg\n</code></pre> <pre><code>grep hello 1.txt\n# \u7ed3\u679c\nhello world\nabc hello efg\n</code></pre> <pre><code>grep hello -v 1.txt\n# \u7ed3\u679c\npython hell\n</code></pre>"},{"location":"linux/bash/grep/#_1","title":"\u5ffd\u7565\u5927\u5c0f\u5199","text":"<pre><code>grep -i hello &lt;&lt;EOF\nhello world\npython hell\nabc HeLlo efg\nEOF\n# \u7ed3\u679c\nhello world\nabc HeLlo efg\n</code></pre>"},{"location":"linux/bash/grep/#_2","title":"\u663e\u793a\u884c\u53f7","text":"<pre><code>grep -n hello &lt;&lt;EOF\nhello world\npython hell\nabc hello efg\nEOF\n1:hello world\n3:abc hello efg\n</code></pre>"},{"location":"linux/bash/grep/#_3","title":"\u9012\u5f52\u641c\u7d22","text":"<p><pre><code>tree\n.\n\u251c\u2500\u2500 1.txt \n\u2514\u2500\u2500 a\n    \u251c\u2500\u2500 1.txt\n    \u2514\u2500\u2500 b\n        \u2514\u2500\u2500 1.txt\n</code></pre> <pre><code># \u4f1a\u641c\u7d22\u5f53\u524d\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\ngrep -r hello # \u4e0d\u80fd\u6307\u5b9a\u6587\u4ef6\na/b/1.txt:go hello\n    a/1.txt:python hello\n    1.txt:hello\n    1.txt:hello world\n\n# -l \u53ea\u663e\u793a \u5339\u914d\u7684\u6587\u4ef6\u540d\ngrep -rl hello\n    a/b/1.txt\n    a/1.txt\n    1.txt\n</code></pre></p>"},{"location":"linux/bash/grep/#-f","title":"-F \u6309\u5b57\u9762\u610f\u601d\u627e","text":"<pre><code>grep \"he.*\" 1.txt\n    hello\n    hello world\n    hell\n    he.*\ngrep \"he\\.\\*\" 1.txt\n    he.*\ngrep -F \"he.*\" 1.txt\n    he.*\n</code></pre>"},{"location":"linux/bash/grep/#_4","title":"\u67e5\u770b\u5339\u914d\u884c\u7684\u524d\u540e\u51e0\u884c","text":"<pre><code># -A  --after-context\n# -B  --before-context\ncat example.txt|grep \"hello\" -A 10 -B 2\n</code></pre>"},{"location":"linux/bash/grep/#-c","title":"-c \u53ea\u663e\u793a\u5339\u914d\u4e86\u51e0\u884c","text":"<pre><code>grep -c hello 1.txt\n</code></pre>"},{"location":"linux/bash/grep/#-w","title":"-w \u5339\u914d\u6574\u8bcd","text":"<pre><code>grep -w hello &lt;&lt;EOF\nhelloworld\nhello world\nabchello xzy\nEOF\n</code></pre>"},{"location":"linux/bash/grep/#-x","title":"-x \u5339\u914d\u5230\u6574\u884c","text":"<pre><code>grep -x \"hello world\" &lt;&lt;EOF\nhello world \nhello world\nhello world ok\nEOF\n# \u53ea\u4f1a\u5339\u914d\u5230\u7b2c\u4e8c\u884c, \u7b2c\u4e00\u884c \u540e\u9762\u6709\u7a7a\u683c \u4e5f\u4e0d\u884c.\n</code></pre>"},{"location":"linux/bash/quick-start/","title":"\u57fa\u7840","text":"<p>Warning</p> <p>\u5f85\u6574\u7406...</p>","tags":["Bash"]},{"location":"linux/bash/quick-start/#_1","title":"\u5e38\u7528\u547d\u4ee4","text":"\u5e2e\u52a9cdmkdirlscatdaterenamecphistory\u67e5\u770b\u7528\u6237 \u51e0\u4e2a\u90fd\u8bd5\u8bd5<pre><code>man sed\nhelp cd\ncd --help\ncd -h\n</code></pre> <p><pre><code>cd   # \u76f4\u63a5\u4ec0\u4e48\u4e5f\u4e0d\u52a0 \u4f1acd \u5230 \u5bb6\u76ee\u5f55\ncd ~ # \u540c\u4e0a\ncd - # \u8fd4\u56de\u4e0a\u4e00\u6b21\u7684\u76ee\u5f55\n</code></pre> \u5173\u4e8ecd\u5efa\u8bae\u8bbe\u7f6e\u4e00\u4e9b\u8fd9\u6837\u7684\u522b\u540d<pre><code>cat &gt;&gt; /etc/profile &lt;&lt;EOF\nalias ..=\"cd ..\"\nalias ...=\"cd ../..\"\nEOF\n</code></pre></p> <pre><code># -v \u663e\u793a\u521b\u5efa\u4fe1\u606f\n# -p \u591a\u7ea7\u76ee\u5f55\u53ef\u4ee5\u81ea\u52a8\u521b\u5efa\nmkdir -pv a/b/c\nmkdir -pv a/{a1,a2} #(1)\n</code></pre> <ol> <li>\u7ed3\u679c     <pre><code>a\n\u251c\u2500\u2500 a1\n\u2514\u2500\u2500 a2\n</code></pre></li> </ol> <pre><code>#\u5982\u4f55\u53ea\u5217\u51fa\u76ee\u5f55\nls -p #\u53ef\u4ee5\u7ed9\u6587\u4ef6\u5939\u540e\u9762\u52a0\u4e0a/,\u5176\u5b9e\u5b9e\u9645\u4e0a\u5c31\u662f\u6709/\nls -d */ #\u5c31\u53ef\u4ee5\u8bf4\u660e \u5b9e\u9645\u4e0a\u6709/ ,\u8fd9\u6837\u5c31\u53ea\u5217\u51fa\u76ee\u5f55\u4e86\nls -p |egrep \"/$\"\n#\u7ed9\u6587\u4ef6\u540d\u52a0\u4e0a\u5f15\u53f7\nls -Q\n#\u5220\u9664\u76ee\u5f55\nls -Qd */|xargs rm -fr\n\n# \u67e5\u770b\u6587\u4ef6\u7684inode\u4fe1\u606f\nls -i\n# \u67e5\u770b\u6587\u4ef6\u7684\u8bfb\u53d6\u65f6\u95f4,\u9ed8\u8ba4\u662f\u4fee\u6539\u65f6\u95f4\nls --time=atime\nll -t # \u6309\u4fee\u6539\u65f6\u95f4\u6392\u5e8f, \u964d\u5e8f\nll -rt #\u53cd\u7740.  \u65b0\u7684\u5728\u6700\u540e.\n#\u4f7f\u7528ll\u7684\u8bdd \u524d\u9762\u591a\u4e86\u4e00\u884c total\n# \u6bd4\u5982\u5728\u76ee\u5f55\u4e2d\u662f\u5907\u4efd\u6587\u4ef6,  \u8fd9\u91cc\u7684\u547d\u4ee4\u4fbf\u662f\u5220\u9664\u65e7\u768410\u4e2a\u5907\u4efd\nls -rt | head -10 |xargs rm\n</code></pre> <pre><code># \u663e\u793a\u884c\u53f7\ncat -n a.txt\n\ncat &gt; 2.txt &lt;&lt;EOF\nhello world\nEOF\ncat &gt;&gt; 2.txt &lt;&lt;EOF\nhello shell\nEOF\n# 2.txt \u7684\u5185\u5bb9 \u52a0\u4e0a  echo hello python \u547d\u4ee4\u663e\u793a\u7684\u5185\u5bb9\ncat 2.txt &lt;(echo hello python)\n# \u7ed3\u679c\u8f93\u51fa\nhello world\n    hello shell\n    hello python\n# \u91cd\u5b9a\u5411\u52303.txt\ncat &gt;3.txt  2.txt &lt;(echo hello python)\ncat &gt;3.txt 2.txt &lt;(cat &lt;&lt;EOF\ngo to hell\ngood night\nEOF)\necho 111 &gt; 1.txt\ncat 1.txt &lt;(cat 2.txt &lt;(cat  &lt;&lt;EOF\nxyz\nabc\nEOF\n))\n</code></pre> <pre><code># \u65f6\u95f4\u6233\ndate +%s\n# \u4e00\u5929\u524d\u7684\u65f6\u95f4\u6233\ndate -d \"1 day ago\" +%s\n\ndate +\"%Y/%m/%d %H:%M:%S\"\n</code></pre> <pre><code># \u6ca1\u6709\u8fd9\u4e2a\u547d\u4ee4\u7684\u8bdd,\u9700\u8981\u5b89\u88c5\napt install rename\n# \u5982\u679c\u540e\u7f00\u540d\u5339\u914d\u5230, \u4e5f\u4f1a\u4fee\u6539\n# \u4e0d\u540c\u7684linux\u7248\u672c \u53ef\u80fd\u4f7f\u7528\u7684\u65b9\u5f0f\u4e0d\u4e00\u6837\nrename txt mp3 `ls` #\u628a\u6587\u4ef6\u540d\u91cc\u7684txt\u66ff\u6362\u4e3amp3\nrename txt mp3 *\n# \u8fd9\u4e2a\u662fubuntu\u7684 \u4e0esed \u4e00\u4e2a\u5fb7\u884c..\nrename \"s/txt/mp3/g\" *\n</code></pre> <p>Warning</p> <ul> <li>\u5b9e\u9645\u4e0acp\u9ed8\u8ba4\u662f\u4f1a\u8986\u76d6\u7684\uff0c\u51fa\u73b0\u4f60\u8fd9\u79cd\u60c5\u51b5\u662f\u56e0\u4e3acp\u88abalias\u6210cp -i\u4e86\uff0c\u53ef\u4ee5\u901a\u8fc7alias\u547d\u4ee4\u67e5\u770b\u3002</li> <li>\\cp\u5219\u662f\u544a\u8bc9shell\u4e0d\u8981\u53bb\u67e5alias\uff0c\u76f4\u63a5\u6267\u884c\u539f\u672c\u7684cp</li> </ul> <pre><code># \u8fd9\u4e2a\u547d\u4ee4\u6765\u67e5\u770b\u4e00\u4e0b\nalias\n</code></pre> <pre><code>history -c  # \u6e05\u7a7ahistory\nhistory -a  # \u8868\u793a\u628a\u5f53\u524dsession\u7684history\u7acb\u5373\u5199\u5165\u5230history\u6587\u4ef6\u91cc\u53bb ~/.bash_history\n#\u4f30\u8ba1\u539f\u6765\u662f\u8fc7\u4e00\u6bb5\u65f6\u95f4\u4ec0\u4e48\u7684 \u624d\u5199\u5165\u6587\u4ef6\n#\u67e5\u770b\u4fdd\u5b58\u8bb0\u5f55\u7684\u6587\u4ef6\necho $HISTFILE\n#history\u914d\u7f6e\nvim /etc/profile\n\n# \u7a7a\u683c+\u547d\u4ee4,\u4e0d\u4f1a\u5199\u5165\u5230history\u4e2d. \u9632\u6b62\u6709\u4eba\u7528\u65b9\u5411\u952e\u4e0d\u5c0f\u5fc3 \u4f7f\u7528history \u91cc\u7684rm\u547d\u4ee4 \u8bef\u5220\u9664\u7b49\u7b49\necho \"export HISTCONTROL=ignorespace\" &gt;&gt; ~/.zshrc\n</code></pre> <pre><code>w\n# \u7b80\u6d01\nusers\n# \u6700\u540e\u767b\u5f55\u7684\u7528\u6237\u60c5\u51b5\nlast\n</code></pre> \u5173\u673a\u4e0e\u91cd\u542falias\u67e5\u627e findddseqsort,tactarEOF <pre><code>halt\n#\u6216\u8005init 0 \u4e5f\u662f\u5173\u673a\nshutdown -h now # h=halt\n### \u91cd\u542f\nreboot\ninit 6 #\u4e5f\u662f\u91cd\u542f\nshutdown -r now #\u91cd\u542f r=reboot\n</code></pre> <pre><code>vim /etc/profile\nalias cls='clear'\n#\u6240\u6709\u7528\u6237\u6c38\u4e45\u751f\u6548\nvim /etc/bashrc\n#\u5f53\u524d\u7528\u6237\u751f\u6548\nvim ~/.bashrc\n#\u8bbe\u7f6e\u7684\u522b\u540d\u53ef\u4ee5\u4f7f\u7528 which \u6765\u627e\n</code></pre> <pre><code>which cp\nwhereis rsync\nwhereis -b rsync\n#\u67e5\u627e\u66f4\u591a\u6709\u5173\u8fd9\u4e2a\u5b57\u7b26\u4e32\u5728\u54ea\u91cc\u6709\u7684\nlocate cp\nfind /tmp -type f -name '*.log' -mtime +7\n</code></pre> <ul> <li>\u751f\u6210\u7a7a\u6587\u4ef6 <pre><code>dd if=/dev/zero of=test bs=10M count=1\n</code></pre></li> <li>\u590d\u5236\u6587\u4ef6\u5185\u5bb9\u5230\u53e6\u5916\u4e00\u4e2a\u6587\u4ef6 <pre><code>dd if=abc.jpg of=test conv=notrunc\n</code></pre></li> <li>\u8df3\u8fc7\u590d\u5236\u6e90\u591a\u5c11\u5b57\u8282 <pre><code># \u8df3\u8fc7test,jpg\u7684 10m\u5185\u5bb9, \u540e\u9762\u7684\u5185\u5bb9\u590d\u5236\u5230my.mp4\ndd if=test.jpg of=my.mp4 bs=10M skip=1\n</code></pre></li> <li>\u8df3\u8fc7\u8f93\u51fa\u7684\u76ee\u6807\u6587\u4ef6\u7684\u591a\u5c11\u5b57\u8282 <pre><code># \u5982\u679cof\u6307\u5b9a\u7684\u6587\u4ef6\u662f\u4e0d\u5b58\u5728\u7684,\u90a3\u4e48\u4e5f\u4f1a\u5728\u6587\u4ef6\u524d\u9762\u5199\u5165\u7a7a\u768410m \u5927\u5c0f\u7684\u6570\u636e\n# \u5c31\u662f\u4ece\u6307\u5b9a\u6587\u4ef6\u768410M \u5927\u5c0f\u4f4d\u7f6e\u5f00\u59cb\u5199\u5165if\u6307\u5b9a\u7684\u6587\u4ef6\ndd if=a.mp4  of=testbak.jpg  bs=10M seek=1\n</code></pre></li> </ul> <pre><code># \u9ed8\u8ba4\u4ee5\u56de\u8f66\u7b26 \u4e3a\u5206\u9694\u7b26 \u8f93\u51fa 1 2 3 4 5\nseq 1 5\nseq 1 2 5 #\u4e2d\u95f4\u76842\u662f\u95f4\u9694 \u8fd9\u91cc\u6253\u51fa1 3 5\n# -s \u6307\u5b9a\u5206\u9694\u7b26 \u8fd9\u91cc\u662f\u7a7a\u683c\nseq -s \" \" 1 5\n</code></pre> <p>-w \u8865\u96f6<pre><code># \u6839\u636e\u66f4\u5bbd\u7684\u90a3\u4e2a\u6765\u8865\u8db3\u5176\u4ed6\nseq -w 5 11\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>05\n06\n07\n08\n09\n10\n11\n</code></pre></p> -f \u6307\u5b9a\u683c\u5f0f\u8f93\u51fa\u6570\u5b57<pre><code># %g \u9ed8\u8ba4\n# %2g\u8868\u793a \u5bbd\u5ea6\u662f2\u4f4d, \u4e0d\u591f\u5c31\u8865\u7a7a\u683c\nseq -f \"%2g\" 1 3\n</code></pre> <p>\u6267\u884c\u7ed3\u679c<pre><code>1\n2\n3\n</code></pre> <pre><code># 0\u8868\u793a\u5bbd\u5ea6\u4e0d\u8db3\u7684\u8bdd,\u8865\u96f6,\u800c\u4e0d\u662f\u7a7a\u683c\nseq -f \"%02g\" 1 3\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>01\n02\n03\n</code></pre> <pre><code>seq -f \"file%02g\" 1 3\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>file01\nfile02\nfile03\n</code></pre></p> <pre><code>seq 10|sort -rn\n# \u5012\u5e8f\u6253\u51fa\nseq 10|tac\n</code></pre> \u6253\u5305\u89e3\u5305 <pre><code># --exclude \u6392\u9664\ntar -zcvf my-web.tar --exclude=web/.git --exclude=web/node_modules web/\n</code></pre> <pre><code>tar -zxvf my-web.tar\n# tar xf helm-v3.12.2-linux-amd64.tar.gz \u89e3\u538b\u540e \u7684\u6587\u4ef6\u7ed3\u679c\u662f\u8fd9\u6837\u7684\nlinux-amd64/\n\u251c\u2500\u2500 helm\n\u251c\u2500\u2500 LICENSE\n\u2514\u2500\u2500 README.md\n# -C \u6307\u5b9a\u89e3\u538b\u5230\u7684\u76ee\u5f55\n# --strip-components=1 \u8868\u793a \u5265\u79bb\u8def\u5f84\u4e00\u7ea7, \u56e0\u4e3a\u8fd9\u91cc\u6211\u4eec\u53ea\u6709  linux-amd64/ \u8fd9\u6837\u4e00\u7ea7\u76ee\u5f55\n# \u5982\u679c\u4f60\u67092\u7ea7\u5c31 \u5199 --strip-components=2\n# --strip-components=1  \u540e\u9762 \u8981\u5199\u4e0a tar\u5305\u91cc\u7684 \u4f60\u8981\u89e3\u538b\u7684\u6587\u4ef6\u8def\u5f84 linux-amd64/helm\n# \u7ed3\u679c\u5c31\u662f\u5c06helm \u53ef\u6267\u884c\u6587\u4ef6 \u89e3\u538b\u5230 /usr/local/bin/\ntar -zxvf helm-v3.12.2-linux-amd64.tar.gz  -C /usr/local/bin/ --strip-components=1 linux-amd64/helm\n</code></pre> <p><pre><code>\u547d\u4ee4\u63a5\u6536\u65b9 &lt;&lt;EOF\nyour content\nEOF\ncat &lt;&lt;EOF\nhello\nworld\nEOF\nsed -n '/hello/p' &lt;&lt;EOF\nhello\nworld\nEOF\n</code></pre> -EOF \u6ca1\u6709\u6548\u679c...<pre><code>cat &gt;tmp.txt&lt;&lt;-EOF\n    hello world\n    cat dog\nEOF\n</code></pre></p> <p>Warning</p> <pre><code>cat &gt; abc.txt &lt;&lt;EOF\nabc\nEOF cat &gt; 2.txt &lt;&lt;EOF\n222\nEOF\n</code></pre> <ul> <li>\u5982\u679c\u5728\u7b2c\u4e09\u884c\u7684EOF\u540e\u9762\u6211\u4eec\u591a\u52a0\u4e86\u4e00\u4e2a\u7a7a\u683c,\u5176\u4ed6EOF\u540e\u90fd\u6ca1\u6709</li> <li>\u4e0a\u9762\u7684\u7a0b\u5e8f\u8fd0\u884c\u7684\u7ed3\u679c\u662f</li> </ul> \u6700\u540eabc.txt\u91cc\u7684\u5185\u5bb9<pre><code>abc\nEOF\n\ncat &gt; 2.txt &lt;&lt;EOF\n222\n</code></pre> killwatchtree\u4efb\u52a1\u524d\u540e\u53f0\u547d\u4ee4bg fg ctrl+z <pre><code>killall -0 nginx\necho $? # 0 \u8868\u793a \u8fdb\u7a0b\u5b58\u5728, \u975e0 \u8868\u793a\u4e0d\u5b58\u5728\nkillall -s 0 nginx # \u540c\u4e0a\n</code></pre> <pre><code># \u6bcf\u96941s \u67e5\u770b\u4e00\u6b21\nwatch -n 1 tail /var/log/syslog\n</code></pre> <pre><code># -I \u5ffd\u7565\u6587\u4ef6 \u6587\u4ef6\u5939\n# -L 2 \u663e\u793a\u5c42\u7ea7\ntree -L 2 -I node_modules\n</code></pre> <pre><code># \u6bd4\u5982\u4f60\u6b63\u5728vim \u7f16\u8f91\u4e00\u4e2a\u6587\u4ef6\n#\u6309\u4e0b \u8be5\u6309\u952e\uff0c\u5219\u4f1a\u5c06\u5f53\u524d\u6267\u884c\u7684\u8fdb\u7a0b\u6682\u505c\uff0c\u653e\u5230\u540e\u53f0,\u8fd9\u4e2a\u65f6\u5019\u4f60\u53ef\u4ee5\u505a\u5176\u4ed6\u4e8b\u60c5\u4e86\nctrl+z jobs # \u67e5\u770b\u5f53\u524d\u653e\u5230\u540e\u53f0\u7684\u4efb\u52a1 1 \u8fd9\u79cd\u5c31\u662f\u4efb\u52a1\u7684\u7f16\u53f7\n# suspended \u53ef\u4ee5\u77e5\u9053\u540e\u53f0\u4efb\u52a1\u7684\u72b6\u6001\n[1]  + suspended  vim my.md\nsleep 600 &amp; #\u76f4\u63a5\u4e00\u4e2a\u540e\u53f0\u7684\u4efb\u52a1\nsleep 500\nctrl+z # \u5c06 sleep 500 \u8fd9\u4e2a\u4efb\u52a1\u6682\u505c\u653e\u5230\u540e\u53f0\njobs [1]  + suspended  vim my.md\n    [2]    running    sleep 600  # \u53ef\u4ee5\u770b\u5230running\u7684\u72b6\u6001\u7684\u4efb\u52a1\n[3]  - suspended  sleep 500\n# fg %\u7f16\u53f7 \u6216 \u76f4\u63a5 %\u7f16\u53f7 \u5c06\u540e\u53f0\u6682\u505c\u7684\u4efb\u52a1\u91cd\u65b0\u653e\u56de\u524d\u53f0\u8fd0\u884c \nfg %1  fg # \u8fd9\u6837\u4f1a\u76f4\u63a5\u5c06\u7f16\u53f71\u7684\u4efb\u52a1 \u653e\u56de\u524d\u53f0\u8fd0\u884c\nbg %3 # \u8868\u793a\u5c06\u540e\u53f0\u6682\u505c\u7684\u4efb\u52a1 \u53d8\u6210\u5728\u540e\u53f0\u6267\u884c\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/quick-start/#_2","title":"\u78c1\u76d8","text":"<pre><code>du -h -d 1 dir  #\u4f1a\u663e\u793adir\u76ee\u5f55\u91cc\u7684\u5b50\u76ee\u5f55 \u4e00\u5c42\ndu -h -d 0 dir  #\u53ea\u4f1a\u663e\u793adir \u7684\u5927\u5c0f\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/quick-start/#_3","title":"\u7f51\u7edc\u547d\u4ee4","text":"nccurlss netstatlsofwget <pre><code># \u6307\u5b9aCA \u8bc1\u4e66 \u6216 \u81ea\u7b7e\u540d\u8bc1\u4e66 ,\u8fd9\u4e2a\u9700\u8981\u4f60\u914d\u7f6e /etc/hosts\ncurl --cacert server.crt https://example1.com/\n#  \u65e0\u9700\u914d\u7f6e /etc/hosts, \u76f4\u63a5\u6307\u5b9adns\ncurl --cacert server.crt --resolve example1.com:443:192.168.1.104  https://example1.com/\n</code></pre> <pre><code>ss -tnl\n</code></pre> <pre><code>lsof -i:8080\n# \u901a\u8fc7pid \u627e\u6587\u4ef6\u4f4d\u7f6e\nlsof -p pid\n</code></pre> <pre><code># -O \u4fdd\u5b58\u4e3a\u6307\u5b9a\u7684\u6587\u4ef6\u540d\n# -q quiet\nwget https://mirrors.163.com/.help/sources.list.jammy -qO /etc/apt/sources.list\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/script/","title":"\u811a\u672c","text":""},{"location":"linux/bash/script/#_1","title":"\u5faa\u73af","text":"<pre><code>while true\ndo\necho 1\nsleep 3\ndone\n# killall -0 docker-proxy \u6267\u884c\u7684\u7ed3\u679c $? =0 \u7684\u60c5\u51b5, \u624d\u4f1a\u8fdb\u5165\u5faa\u73af\nwhile killall -0 docker-proxy\ndo\necho 1\nsleep 3\ndone\n</code></pre>"},{"location":"linux/bash/script/#_2","title":"\u51fd\u6570","text":""},{"location":"linux/bash/script/#_3","title":"\u83b7\u53d6\u51fd\u6570\u540d\u79f0","text":"<p>Warning</p> <p>\u4e0d\u8981\u7528 <code>sh fun.sh</code> \u6765\u6267\u884c, \u5426\u5219 \u6ca1\u6709 <code>$FUNCNAME</code></p> fun.sh<pre><code>#!/bin/bash\nshow(){\n# FUNCNAME \u5b9e\u9645\u662f\u4e00\u4e2a\u6570\u7ec4,\u5305\u542b\u4e86\u5f53\u524d\u8c03\u7528\u6808\u4e0a\u6240\u6709\u51fd\u6570\u7684\u540d\u79f0,\u5148\u8fdb\u540e\u51fa\necho $FUNCNAME # \u9996\u4e2a\u5143\u7d20\u662f\u5f53\u524d\u51fd\u6570\u540d\n# \u53ef\u4ee5\u53d1\u73b0\u5b9e\u9645\u6709\u4e2amain \u51fd\u6570, \u5148main,\u518d\u8c03\u7528\u4e86show2, \u6700\u540eshow\necho ${FUNCNAME[@]} # show show2 main.\n}\nshow2(){\nshow\n}\nshow2\n</code></pre> <pre><code>bash fun.sh\n# \u6216\u8005\nchmod +x fun.sh\n./fun.sh\n</code></pre>"},{"location":"linux/bash/script/#_4","title":"() {}","text":"<p>\u8bf4\u660e</p> <p>\u5b9e\u73b0\u6267\u884c\u811a\u672c\u65f6,\u6ca1\u6709\u53c2\u6570\u76f4\u63a5\u63d0\u793a\u9519\u8bef, \u7136\u540e\u9000\u51fa\u811a\u672c</p> <p>() \u91cc\u5b9e\u9645\u662f\u5728\u5b50shell\u91cc\u6267\u884c\u547d\u4ee4,\u5b83\u7684exit\u9000\u51fa,\u53d8\u91cf\u4fee\u6539\u7b49\u64cd\u4f5c\u90fd\u4e0d\u5f71\u54cd\u5f53\u524dshell,\u6240\u4ee5\u4e0d\u5bf9</p> <p>{} \u91cc\u9762\u7684\u662f\u5728\u5f53\u524dshell\u7684, \u4e00\u7ec4\u547d\u4ee4\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\u6267\u884c.</p> \u9519\u7684\u7248\u672c<pre><code>#!/bin/bash\ntest -z $1 &amp;&amp; ( echo \"need arg\";exit; )\necho ok\n</code></pre> \u5bf9\u7684\u7248\u672c<pre><code>#!/bin/bash\ntest -z $1 &amp;&amp; { echo \"need arg\";exit; }\necho ok\n</code></pre> <p>\u6ce8\u610f</p> <p>\u6ce8\u610f \u9700\u8981{ } \u4e24\u8fb9\u7a7a\u683c, \u6700\u540e }\u524d\u9762\u7684; \u4e5f\u662f\u9700\u8981\u7684</p>"},{"location":"linux/bash/script/#_5","title":"`` \u548c $()","text":"<p>Note</p> <p>\u5c06\u547d\u4ee4\u6267\u884c\u7684\u7ed3\u679c\u8d4b\u503c\u7ed9\u53d8\u91cf</p> <pre><code>t=$(date +%Y) # t=`date +%Y`\necho $t # 2023\n</code></pre>"},{"location":"linux/bash/script/#shift","title":"shift","text":"shift.sh<pre><code>#!/bin/bash\necho $*   # sh shift.sh a b c d e f\nshift  # \u53c2\u6570\u5de6\u79fb\u4e00\u4f4d\necho $1 # \u8fd9\u4e2a\u65f6\u5019 \u7b2c\u4e00\u4e2a\u53c2\u6570\u5c31\u662f b\nshift 1 # \u540c shift\necho $1 #  c\nshift 3 # \u53c2\u6570\u5de6\u79fb3 \u4f4d\necho $1 # \u8fd9\u4e2a\u65f6\u5019 $1 \u662ff\n</code></pre> <pre><code>sh shift.sh a b c d e f\n</code></pre>"},{"location":"linux/bash/sed/","title":"sed","text":"env version OS <code>Ubuntu 20.04.6 LTS</code> sed <code>sed (GNU sed) 4.7</code>","tags":["Bash"]},{"location":"linux/bash/sed/#_1","title":"\u5de5\u4f5c\u539f\u7406","text":"<p>sed = stream editor \u53ef\u4ee5\u5bf9\u6807\u51c6\u8f93\u51fa\u548c\u6587\u4ef6\u8fdb\u884c\u9010\u884c\u5904\u7406</p>","tags":["Bash"]},{"location":"linux/bash/sed/#_2","title":"\u547d\u4ee4\u7ed3\u6784","text":"","tags":["Bash"]},{"location":"linux/bash/sed/#_3","title":"\u6d41\u7a0b\u56fe","text":"","tags":["Bash"]},{"location":"linux/bash/sed/#-debug","title":"--debug \u5206\u6790\u6d41\u7a0b","text":"","tags":["Bash"]},{"location":"linux/bash/sed/#p","title":"p \u6253\u5370\u64cd\u4f5c\u5206\u6790","text":"example.txt\u6267\u884c\u547d\u4ee4debug\u5206\u6790 <pre><code>hello cat\nhello world\nhot dog\n</code></pre> <p><pre><code># = \u7684\u884c\u4e3a\u662f\u6253\u5370\u5339\u914d\u7684\u884c\u7684\u884c\u53f7\nsed '/hello/=;p' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>1\nhello cat\nhello cat\n2\nhello world\nhello world\nhot dog\nhot dog\n</code></pre></p> <pre><code>sed --debug '/hello/=;p' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>SED PROGRAM:\n/hello/ =\np\nINPUT:   'example.txt' line 1\nPATTERN: hello cat\nCOMMAND: /hello/ =\n1\nCOMMAND: p\nhello cat\nEND-OF-CYCLE:\nhello cat\nINPUT:   'example.txt' line 2\nPATTERN: hello world\nCOMMAND: /hello/ =\n2\nCOMMAND: p\nhello world\nEND-OF-CYCLE:\nhello world\nINPUT:   'example.txt' line 3\nPATTERN: hot dog\nCOMMAND: /hello/ =\nCOMMAND: p\nhot dog\nEND-OF-CYCLE:\nhot dog\n</code></pre> <ol> <li>\u7b2c5\u884c, \u663e\u793a pattern space buffer\u7684\u5185\u5bb9,\u5c31\u662f\u884c\u5185\u5bb9</li> <li>\u663e\u793a\u7ed3\u679c\u91cc\u7684\u7b2c6\u884c<code>COMMAND: /hello/ =</code> \u5224\u65adpattern space\u662f\u5426\u5305\u542bhello,\u662f\u7684\u8bdd\u5c31\u6253\u5370\u5b83\u7684\u884c\u53f7</li> <li>\u7b2c8\u884c <code>COMMAND: p</code> [addr]\u662f\u7a7a,\u5c31\u662f\u76f4\u63a5\u5339\u914d\u4e86,\u76f4\u63a5p\u64cd\u4f5c\u6253\u5370pattern space\u7684\u5185\u5bb9.</li> <li>\u7b2c11\u884c\u662f \u4e0d\u5e26-n\u7684 \u9ed8\u8ba4\u884c\u4e3a \u6253\u5370\u4e86pattern space\u7684\u5185\u5bb9 <code>hello cat</code></li> </ol>","tags":["Bash"]},{"location":"linux/bash/sed/#s","title":"s \u66ff\u6362\u64cd\u4f5c\u5206\u6790","text":"\u6267\u884c\u547d\u4ee4debug\u5206\u6790 <pre><code>sed  's/hello/xxxx/gp' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>xxxx cat\nxxxx cat\nxxxx world\nxxxx world\nhot dog\n</code></pre> <pre><code>sed --debug 's/hello/xxxx/gp' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>SED PROGRAM:\ns/hello/xxxx/gp\nINPUT:   'example.txt' line 1\nPATTERN: hello cat\nCOMMAND: s/hello/xxxx/gp\nMATCHED REGEX REGISTERS\nregex[0] = 0-5 'hello'\nxxxx cat\nPATTERN: xxxx cat\nEND-OF-CYCLE:\nxxxx cat\nINPUT:   'example.txt' line 2\nPATTERN: hello world\nCOMMAND: s/hello/xxxx/gp\nMATCHED REGEX REGISTERS\nregex[0] = 0-5 'hello'\nxxxx world\nPATTERN: xxxx world\nEND-OF-CYCLE:\nxxxx world\nINPUT:   'example.txt' line 3\nPATTERN: hot dog\nCOMMAND: s/hello/xxxx/gp\nPATTERN: hot dog\nEND-OF-CYCLE:\nhot dog\n</code></pre> <ol> <li>\u7b2c8\u884c \u662f <code>s/hello/xxxx/gp</code>\u4e2dp\u8fd9\u4e2as\u7684flag\u7684\u884c\u4e3a(\u6253\u5370pattern space). \u6ce8\u610f\u5b83\u5176\u5b9e\u5e76\u4e0d\u662fX,s\u662fX,\u8fd9\u4e2ap\u53ea\u662f\u5b83\u7684flag,\u53ea\u4e0d\u8fc7\u884c\u4e3a\u4e0e\u8eab\u4e3aX\u7684p\u64cd\u4f5c\u4e00\u6837.\u540e\u7eed\u518d\u8bf4</li> <li>\u7b2c9\u884c \u663e\u793a\u53d8\u5316\u540e\u7684 pattern space \u7684\u5185\u5bb9\u7ed9\u6211\u4eec\u770b. \u8fd9\u4e2a\u65f6\u5019\u5df2\u7ecf\u88ab\u66ff\u6362\u4e86\u76f8\u5173\u7684\u5b57\u7b26\u4e32. \u5982\u679cpatttern space \u5185\u5bb9\u6709\u53d8\u5316\u4f1a\u5728\u8fd9\u91cc\u91cd\u65b0\u663e\u793a\u4e00\u6b21</li> <li>\u4e0d\u5e26-n\u7684\u9ed8\u8ba4\u64cd\u4f5c, \u6253\u5370 pattern space</li> </ol>","tags":["Bash"]},{"location":"linux/bash/sed/#a","title":"a \u884c\u540e\u63d2\u5165\u64cd\u4f5c\u5206\u6790","text":"\u6267\u884c\u547d\u4ee4debug\u5206\u6790 <pre><code>sed -n '/world/a python' example.txt\n</code></pre> <p>\u6267\u884c\u7ed3\u679c<pre><code>python\n</code></pre> \u4ece\u6267\u884c\u7ed3\u679c\u770b, a\u64cd\u4f5c\u9ed8\u8ba4\u4f1a\u6253\u5370\u4f60\u63d2\u5165\u7684\u5185\u5bb9</p> <pre><code># \u6211\u4eecdebug \u4e00\u4e0b\u4e0d\u5e26 -n \u53c2\u6570\u7684 \u6d41\u7a0b.\nsed --debug '/world/a python' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>SED PROGRAM:\n/world/ a\\python\n\nINPUT:   'example.txt' line 1\nPATTERN: hello cat\nCOMMAND: /world/ a\\python\n\nEND-OF-CYCLE:\nhello cat\nINPUT:   'example.txt' line 2\nPATTERN: hello world\nCOMMAND: /world/ a\\python\n\nEND-OF-CYCLE:\nhello world\npython\nINPUT:   'example.txt' line 3\nPATTERN: hot dog\nCOMMAND: /world/ a\\python\n\nEND-OF-CYCLE:\nhot dog\n</code></pre> <ol> <li>\u4ece11-16\u884c\u53ef\u4ee5\u770b\u5230 Pattern space\u5e76\u6ca1\u6709\u53d1\u751f\u53d8\u5316. (\u6709\u53d8\u5316\u4f1a\u91cd\u65b0\u663e\u793a\u4e00\u6b21)</li> <li>15\u884c\u662f \u6ca1\u6709-n \u7684\u9ed8\u8ba4\u884c\u4e3a, \u6253\u5370Pattern space</li> <li>16\u884c\u662fa \u7684\u884c\u4e3a. \u5b83\u53d1\u751f\u5728 \u9ed8\u8ba4\u6253\u5370pattern space\u884c\u4e3a\u7684\u540e\u9762</li> <li>a\u7684\u884c\u4e3a: \u4e0d\u6539\u53d8pattern space , \u5b83\u4f1a\u628a\u5728\u8be5\u547d\u4ee4\u540e\u9762\u7684\u6587\u672c,\u5728\u5f53\u524dCYCLE\u7ed3\u675f\u6216\u8bfb\u53d6\u4e0b\u4e00\u884c\u65f6\u8f93\u51fa.</li> <li>\u6ce8\u610f\u4e0a\u9762\u7684\u7a7a\u884c3,7,13,20\u8fd9\u51e0\u884c,\u8fd9\u662fCOMMAND\u672c\u8eab\u7684\u4e00\u90e8\u5206. \u5c31\u662f\u8bf4\u6211\u4eeca python\u540e\u9762\u5b9e\u9645\u8ddf\u7740\u4e00\u4e2a\u6362\u884c\u7b26,\u8981\u4e0d\u7136\u4e5f\u4e0d\u4f1a\u662f\u63d2\u5165\u4e00\u884c\u4e86. \u6240\u4ee5<code>SED PROGRAM:</code>\u540e\u9762\u663e\u793a\u7684\u662f2\u884c,\u5305\u542b\u4e86\u4e00\u4e2a\u6362\u884c\u7b26</li> </ol>","tags":["Bash"]},{"location":"linux/bash/sed/#i","title":"i \u884c\u524d\u63d2\u5165\u64cd\u4f5c\u5206\u6790","text":"\u6267\u884c\u547d\u4ee4debug\u5206\u6790 <pre><code>sed '/world/i python' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>hello cat\npython\nhello world\nhot dog\n</code></pre> <p><pre><code>sed  --debug '/world/i python' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>SED PROGRAM:\n/world/ i\\python\n\nINPUT:   'example.txt' line 1\nPATTERN: hello cat\nCOMMAND: /world/ i\\python\n\nEND-OF-CYCLE:\nhello cat\nINPUT:   'example.txt' line 2\nPATTERN: hello world\nCOMMAND: /world/ i\\python\n\npython\nEND-OF-CYCLE:\nhello world\nINPUT:   'example.txt' line 3\nPATTERN: hot dog\nCOMMAND: /world/ i\\python\n\nEND-OF-CYCLE:\nhot dog\n</code></pre> 1. \u7b2c14\u884c\u76f4\u63a5\u6253\u5370\u4e86, \u53ef\u4ee5\u4e0ea\u64cd\u4f5c \u505a\u4e2a\u5bf9\u6bd4 2. \u5b98\u65b9\u539f\u8bdd: <code>Immediately output the lines of text which follow this command</code></p>","tags":["Bash"]},{"location":"linux/bash/sed/#hx-hold-space","title":"H\u548cx\u64cd\u4f5c \u4e0ehold space","text":"input.txt\u6267\u884c\u6307\u4ee4\u5206\u6790 <p>\u5b98\u65b9\u4f8b\u5b50, \u6211\u5185\u5bb9\u7a0d\u5fae\u53d8\u4e0b <pre><code>js\nvue\nreact\n\npython\nphp\n\njava\ngolang\nrust\n</code></pre></p> <p><pre><code>sed '/./{H;$!d} ; x ; s/^/\\nSTART--&gt;/ ; s/$/\\n&lt;--END/' input.txt\n# \u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u5728\u6700\u5f00\u5934\u589e\u52a0\u4e00\u4e2a\u7a7a\u884c. \u8fd9\u91cc\u8fd9\u4e2a\u5c06\u8fd9\u4e2a\u53bb\u6389\u4e86.\n# sed '/./{H;$!d} ; x ; s/^/START--&gt;/; $!s/$/\\n&lt;--END\\n/;$s/$/\\n&lt;--END/' input.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>START--&gt;\njs\nvue\nreact\n&lt;--END\n\nSTART--&gt;\npython\nphp\n&lt;--END\n\nSTART--&gt;\njava\ngolang\nrust\n&lt;--END\n</code></pre></p> X Description <code>H</code>3  \u6dfb\u52a0\u4e00\u4e2a\u6362\u884c\u7b26\u5230hold space,\u7136\u540e\u5c06pattern space \u7684\u5185\u5bb9\u8ffd\u52a0\u5230hold space <code>x</code>4  \u4e92\u76f8hold space\u548cpattern space\u7684\u5185\u5bb9 <code>d</code>  \u5220\u9664 pattern space\u7684\u5185\u5bb9,\u7acb\u523b\u5f00\u59cb\u4e0b\u4e00\u6b21cycle,\u540e\u7eed\u7684\u547d\u4ee4\u4e0d\u518d\u6267\u884c\u54e6 <pre><code>sed --debug '/./{H;$!d} ; x ; s/^/\\nSTART--&gt;/ ; s/$/\\n&lt;--END/' input.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>SED PROGRAM:\n/./ {\n    H\n    $! d\n}\nx\ns/^/\nSTART--&gt;/\ns/$/\n&lt;--END/\nINPUT:   'input.txt' line 1\nPATTERN: js\nCOMMAND: /./ {\nCOMMAND:   H\nHOLD:    \\njs\nCOMMAND:   $! d\nEND-OF-CYCLE:\nINPUT:   'input.txt' line 2\nPATTERN: vue\nCOMMAND:   /./ {\nCOMMAND:     H\nHOLD:    \\njs\\nvue\nCOMMAND:     $! d\nEND-OF-CYCLE:\nINPUT:   'input.txt' line 3\nPATTERN: react\nCOMMAND:     /./ {\nCOMMAND:       H\nHOLD:    \\njs\\nvue\\nreact\nCOMMAND:       $! d\nEND-OF-CYCLE:\nINPUT:   'input.txt' line 4\nPATTERN:\nCOMMAND:       /./ {\nCOMMAND:       }\nCOMMAND:       x\nPATTERN: \\njs\\nvue\\nreact\nHOLD:\nCOMMAND:       s/^/\nSTART--&gt;/\nMATCHED REGEX REGISTERS\nregex[0] = 0-0 ''\nPATTERN: \\nSTART--&gt;\\njs\\nvue\\nreact\nCOMMAND:       s/$/\n&lt;--END/\nMATCHED REGEX REGISTERS\nregex[0] = 22-22 ''\nPATTERN: \\nSTART--&gt;\\njs\\nvue\\nreact\\n&lt;--END\nEND-OF-CYCLE:\n\nSTART--&gt;\njs\nvue\nreact\n&lt;--END\nINPUT:   'input.txt' line 5\nPATTERN: python\nCOMMAND:       /./ {\nCOMMAND:         H\nHOLD:    \\npython\nCOMMAND:         $! d\nEND-OF-CYCLE:\nINPUT:   'input.txt' line 6\nPATTERN: php\nCOMMAND:         /./ {\nCOMMAND:           H\nHOLD:    \\npython\\nphp\nCOMMAND:           $! d\nEND-OF-CYCLE:\nINPUT:   'input.txt' line 7\nPATTERN:\nCOMMAND:           /./ {\nCOMMAND:           }\nCOMMAND:           x\nPATTERN: \\npython\\nphp\nHOLD:\nCOMMAND:           s/^/\nSTART--&gt;/\nMATCHED REGEX REGISTERS\nregex[0] = 0-0 ''\nPATTERN: \\nSTART--&gt;\\npython\\nphp\nCOMMAND:           s/$/\n&lt;--END/\nMATCHED REGEX REGISTERS\nregex[0] = 20-20 ''\nPATTERN: \\nSTART--&gt;\\npython\\nphp\\n&lt;--END\nEND-OF-CYCLE:\n\nSTART--&gt;\npython\nphp\n&lt;--END\nINPUT:   'input.txt' line 8\nPATTERN: java\nCOMMAND:           /./ {\nCOMMAND:             H\nHOLD:    \\njava\nCOMMAND:             $! d\nEND-OF-CYCLE:\nINPUT:   'input.txt' line 9\nPATTERN: golang\nCOMMAND:             /./ {\nCOMMAND:               H\nHOLD:    \\njava\\ngolang\nCOMMAND:               $! d\nEND-OF-CYCLE:\nINPUT:   'input.txt' line 10\nPATTERN: rust\nCOMMAND:               /./ {\nCOMMAND:                 H\nHOLD:    \\njava\\ngolang\\nrust\nCOMMAND:                 $! d\nCOMMAND:               }\nCOMMAND:               x\nPATTERN: \\njava\\ngolang\\nrust\nHOLD:    rust\nCOMMAND:               s/^/\nSTART--&gt;/\nMATCHED REGEX REGISTERS\nregex[0] = 0-0 ''\nPATTERN: \\nSTART--&gt;\\njava\\ngolang\\nrust\nCOMMAND:               s/$/\n&lt;--END/\nMATCHED REGEX REGISTERS\nregex[0] = 26-26 ''\nPATTERN: \\nSTART--&gt;\\njava\\ngolang\\nrust\\n&lt;--END\nEND-OF-CYCLE:\n\nSTART--&gt;\njava\ngolang\nrust\n&lt;--END\n</code></pre> <ol> <li>\u7b2c13\u884c, /./\u5339\u914d\u975e\u7a7a\u884c</li> <li>\u7b2c14\u884c, H\u6307\u4ee4, \u5c06\u6362\u884c\u7b26+pattern space\u8ffd\u52a0\u5230 hold space</li> <li>\u7b2c15\u884c, \u53ef\u4ee5\u770b\u5230hold space\u7684\u5185\u5bb9</li> <li>\u7b2c16\u884c, d \u64cd\u4f5c ,\u7136\u540e17\u884c\u76f4\u63a5 \u53bb\u4e0b\u4e00\u6b21 cycle,\u540e\u7eed \u547d\u4ee4\u4e0d\u518d\u6267\u884c.</li> <li>\u7b2c32\u884c, input.txt \u7b2c4\u884c\u662f\u7a7a\u884c, \u6240\u4ee5/./ \u4e0d\u5339\u914d, \u6ca1\u6709\u505a{}\u91cc\u9762\u7684d\u64cd\u4f5c, \u5219\u7ee7\u7eed\u540e\u9762\u7684\u6307\u4ee4 x,\u5c06hold space\u548cpattern space \u4e92\u6362\u4e86.</li> <li>\u540e\u9762\u662fs \u66ff\u6362\u64cd\u4f5c. \u6700\u540e \u4e0d\u5e26-n\u7684\u9ed8\u8ba4 \u6253\u5370pattern space \u64cd\u4f5c.</li> </ol>","tags":["Bash"]},{"location":"linux/bash/sed/#option","title":"OPTION \u53c2\u6570","text":"OPTION Description <code>-n</code>  \u4ec5\u663e\u793a script \u5904\u7406\u540e\u7684\u7ed3\u679c <code>-e</code>  \u4ee5\u6307\u5b9a\u7684 script \u6765\u5904\u7406\u8f93\u5165\u7684\u6587\u672c\u6587\u4ef6,\u9ed8\u8ba4\u5c31\u6709\u8fd9\u4e2a\u53c2\u6570 <code>-f</code>  \u4ee5\u6307\u5b9a\u7684\u6587\u4ef6\u7684\u5185\u5bb9\u6765\u4f5c\u4e3a script \u6765\u5904\u7406 input-file <code>-E/-r</code>  \u652f\u6301\u6269\u5c55\u6b63\u5219  (\u63a8\u8350\u7528-E \u53ef\u79fb\u690d\u6027)   \u5e26-E\u4e0e\u4e0d\u5e26-E\u7684\u533a\u522b 1. \u4e0d\u5e26\u7684\u65f6\u5019 \u90a3\u4e48{} () | + ?  \u6ca1\u6709\u7279\u522b\u542b\u4e49,\u5c31\u662f\u5b83\u672c\u8eab,\u5982\u679c\u60f3\u8981\u53d8\u6210\u7279\u6b8a\u542b\u4e49\u5219\u524d\u9762\u52a0\u4e0a\\2. \u5e26\u4e0a-E\u4e0e\u4e4b\u76f8\u53cd <code>-i</code> \u76f4\u63a5\u4fee\u6539 input-file \u7684\u5185\u5bb9 <code>-s</code>  \u653e\u5230input-file\u7ae0\u8282\u8bf4\u660e <code>--debug</code>  \u663e\u793a sed \u7684\u6267\u884c\u8fc7\u7a0b,\u4f4e\u7248\u672c\u7684sed\u53ef\u80fd\u6ca1\u6709  example.txt -n -e -f -E/-r -i <pre><code>hello cat\nhello world\nhot dog\n</code></pre> \u4e0d\u5e26-n\u5e26 -n <p>\u4e0b\u9762\u8fd9\u4e2a,\u5339\u914d\u5219\u6253\u5370\u5904\u7406\u540e\u7684\u884c(/hello/p\u7684\u884c\u4e3a),\u7136\u540e\u4e0d\u7ba1\u5339\u914d\u4e0e\u5426\u518d\u6253\u5370\u5904\u7406\u540e\u7684\u884c(\u4e0d\u5e26-n\u7684\u9ed8\u8ba4\u884c\u4e3a). <pre><code>sed '/hello/p' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>hello cat\nhello cat\nhello world\nhello world\nhot dog\n</code></pre></p> <p>\u53ea\u6253\u5370\u5339\u914d\u7684\u884c <pre><code>sed -n '/hello/p' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>hello cat\nhello world\n</code></pre></p> <p>\u6307\u5b9a\u591a\u4e2a-e, \u5c31\u662f\u5bf9\u8bfb\u53d6\u7684\u884c,\u6309\u987a\u5e8f\u8fdb\u884c script1,\u7136\u540escript2 \u64cd\u4f5c</p> <p><pre><code>sed -n -e '/hello/p' -e '/world/p' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>hello cat\nhello world\nhello world\n</code></pre></p> <p>\u5c06 /hello/p \u8fd9\u6837\u7684 <code>script</code> \u5199\u5230\u6587\u4ef6\u4e2d\u53bb,\u6267\u884c\u5982\u4e0b\u547d\u4ee4 <pre><code>sed -n -f script.sed example.txt\n</code></pre></p> <p><code>|</code>\u65e0\u7279\u6b8a\u542b\u4e49,\u5c31\u662f\u5b83\u672c\u8eab,\u6240\u4ee5\u6ca1\u6709\u627e\u5230\u5339\u914d\u7684\u884c. <pre><code>sed  -n '/hello|world/p' example.txt\n</code></pre> \u8fd9\u91cc\u7684<code>|</code>\u8868\u793a\u7279\u6b8a\u542b\u4e49\u6216 ,\u6240\u4ee5\u53ef\u4ee5\u6b63\u786e\u5339\u914d. <pre><code>sed  -n -E '/hello|world/p' example.txt\n</code></pre></p> <p><pre><code>sed -n 's/cat/dog/g;p' example.txt\n# \u76f4\u63a5\u4fee\u6539\u6e90\u6587\u4ef6\u4e86, \u6ce8\u610f\u8fd9\u91cc\u5c31\u4e0d\u80fd\u518d\u52a0\u4e0a;p\u4e86. \u5426\u5219\u4f60\u6587\u4ef6\u91cc\u5c31\u91cd\u590d\u884c\u4e86.\nsed -i 's/cat/dog/g' example.txt\n</code></pre> -  \u4f7f\u7528-i\u540e\u9762\u76f4\u63a5\u5e26\u4e0a.bak \u6765\u4fee\u6539\u6587\u4ef6\u7684\u540c\u65f6\u8fdb\u884c\u5907\u4efd. <pre><code># \u4f1a\u5148\u5c06example.txt \u505a\u4e2a\u5907\u4efd, \u6587\u4ef6\u540d\u662f\nsed -i.bak 's/cat/dog/g' example.txt.bak\n# \u6240\u4ee5 \u5199-i \u548c\u5176\u4ed6 -E\u8fd9\u79cd\u53c2\u6570\u65f6\u8981\u6ce8\u610f, \u4e0d\u8981\u653e\u5728i\u7684\u540e\u9762 , \n# \u5199\u6210 -Ei\u800c\u4e0d\u662f-iE \u540e\u8005\u662f\u505a\u4e86\u5907\u4efd\u4e86.E\u6210\u4e86\u5907\u4efd\u6587\u4ef6\u7684\u540e\u7f00\u540d\n</code></pre></p> <p>\u5173\u4e8e-i\u7684\u5e95\u5c42\u903b\u8f91</p> <ol> <li>\u5b9e\u9645\u662f\u521b\u5efa\u4e86\u4e00\u4e2a\u4e34\u65f6\u6587\u4ef6, \u5c06\u8f93\u51fa\u5199\u5165\u5230\u8be5\u4e34\u65f6\u6587\u4ef6\u800c\u4e0d\u662f\u7ec8\u7aef.</li> <li>\u7b49\u5230\u6587\u4ef6\u8bfb\u5b8c,\u4f1a\u5c06\u4e34\u65f6\u6587\u4ef6rename \u4e3a \u6211\u4eec \u539f\u672c\u7684\u6587\u4ef6\u540d</li> </ol> <p><pre><code># \u6211\u4eec\u4f7f\u7528strace\u6765\u8ddf\u8e2a\u6211\u4eec\u7684sed\u64cd\u4f5c\u91cc\u4e0e\u6587\u4ef6\u6709\u5173\u7684\u7cfb\u7edf\u8c03\u7528\nstrace -e trace=file sed -i 's/cat/dog/g' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>...\n...\nopenat(AT_FDCWD, \"example.txt\", O_RDONLY)  = 3\nopenat(AT_FDCWD, \"./sedE5aURA\", O_RDWR|O_CREAT|O_EXCL, 0600) = 4\nrename(\"./sedE5aURA\", \"example.txt\")       = 0\n</code></pre></p>","tags":["Bash"]},{"location":"linux/bash/sed/#input-file","title":"input-file","text":"text.txt \u6307\u5b9a\u591a\u4e2a\u6587\u4ef6 -s <pre><code>tomcat\nhello cat\ngoogle\n</code></pre> <pre><code>sed  -n '/cat/{p;=}' example.txt text.txt\n</code></pre> <p>\u6267\u884c\u7ed3\u679c<pre><code>hello cat\n1\ntomcat\n4\nhello cat\n5\n</code></pre>  1. \u770b\u884c\u53f7,\u6211\u4eec\u53ef\u4ee5\u77e5\u9053sed\u662f\u5c062\u4e2a\u6587\u4ef6\u5f53\u6210\u4e00\u4e2a\u6587\u4ef6\u6765\u5904\u7406  2. \u4f7f\u7528 <code>-s</code> \u53c2\u6570, \u4f1a\u5c06\u6bcf\u4e2a\u6587\u4ef6\u4f5c\u4e3a\u4e00\u4e2a\u5355\u72ec\u7684\u6765\u5904\u7406</p> <pre><code>sed  -ns '/cat/{p;=}' example.txt text.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>hello cat\n1\ntomcat\n1\nhello cat\n2\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/sed/#script","title":"script","text":"","tags":["Bash"]},{"location":"linux/bash/sed/#addr","title":"[addr] \u5339\u914d\u884c","text":"example.txt \u6240\u6709\u884c \u6307\u5b9a\u884c\u53f7 \u6b63\u52195 \u533a\u95f4 \u53d6\u53cd \u6700\u540e\u4e00\u884c <pre><code>hello one\nhello two\ntree\nfour\nfive\nspace\nblank\nworld one\nxxx two\nyyy\nworld five\nzzz\n</code></pre> <pre><code># \u4f1a\u6253\u5370\u6240\u6709\u884c \u8fd9\u4e2a\u65f6\u5019 [addr] \u53ef\u4ee5\u8bf4\u662f\u7a7a\u7684.\nsed -n \"p\" example.txt\nsed -n \"s/hello/world/g\" example.txt\n</code></pre> <p><pre><code># \u5339\u914d\u5230\u7b2c\u4e8c\u884c\nsed -n '2p' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>hello two\n</code></pre></p> <pre><code># \u5305\u542bhello\u7684\u884c\nsed -n '/hello/p' example.txt\n# \u5927\u5199\u7684I \u8868\u793a\u5ffd\u7565\u5927\u5c0f\u5199, \u5982\u679c\u5199\u6210 i ,\u662f \u884c\u524d\u63d2\u5165\u7684\u64cd\u4f5c. \u662fX\u7c7b\u522b\nsed -n '/hello/Ip' example.txt\n</code></pre> <ul> <li>\u884c\u53f7\u6307\u5b9a\u533a\u95f4,\u591a\u884c</li> </ul> <p><pre><code># \u5339\u914d\u5230\u7b2c2\u52304\u884c\nsed -n '2,4p' example.txt\n# \u7b2c2\u884c, \u518d\u52a02\u884c, \u4e5f\u5c31\u662f2-4\u884c, \u4e00\u51713\u884c\nsed -n '2,+2p' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>hello two\ntree\nfour\n</code></pre> - \u6b63\u5219\u533a\u95f4 /pattern1/,/pattern2/</p> <ol> <li><code>\u5339\u914d\u5230pattern1\u7684\u884c</code>\u5f00\u59cb\u5230<code>\u5339\u914d\u5230pattern2\u7684\u884c</code>\u7ed3\u675f</li> <li>\u5982\u679c\u5f00\u59cb\u7684\u884c\u6ca1\u6709\u5339\u914d\u5230,\u90a3\u4e48\u5c31\u6ca1\u6709\u5339\u914d\u5230\u884c</li> <li>\u800c\u5230\u54ea\u4e00\u884c\u4e3a\u6b62\u5462? \u7a0d\u5fae\u601d\u8003\u4e0b, \u53ef\u4ee5\u5f97\u51fa\u8fd9\u6837\u7684\u7ed3\u8bba : <ol> <li>\u5982\u679c<code>\u5230\u54ea\u884c\u4e3a\u6b62</code>\u6ca1\u6709\u5339\u914d\u5230, \u5c31\u610f\u5473\u7740\u4e00\u76f4\u5339\u914d\u5230\u6700\u540e\u4e00\u884c </li> <li><code>\u5230\u54ea\u884c\u4e3a\u6b62</code> \u6709\u591a\u884c\u90fd\u80fd\u5339\u914d\u5230, \u80af\u5b9a\u662f\u9996\u5148\u5339\u914d\u7684\u90a3\u4e00\u884c.</li> </ol> </li> </ol> <pre><code># \u542b\u6709two\u7684\u884c\u5230  \u542b\u6709five\u7684\u884c\nsed -n '/two/,/five/p' example.txt\n</code></pre> <p>\u591a\u4e2a\u7b26\u5408\u7684\u533a\u95f4, \u5c31\u4f1a\u90fd\u5339\u914d\u4e0a\u7684 \u6267\u884c\u7ed3\u679c<pre><code>hello two\ntree\nfour\nfive\nxxx two\nyyy\nworld five\n</code></pre> <pre><code># \u7b2c\u4e00\u4e2a\u533a\u95f4\u5339\u914d\u5230\u4e86. \u7b2c\u4e8c\u4e2a\u533a\u95f4\u53ea\u5339\u914d\u5230\u5f00\u59cb\u7684\u884c. \u90a3\u4e48\u7b2c\u4e8c\u4e2a\u533a\u95f4\u5c31\u662f\u5339\u914d\u884c\u5230\u6700\u540e\u4e00\u884c\nsed -n '/two/,/four/p' example.txt\n</code></pre></p> <p>\u6267\u884c\u7ed3\u679c<pre><code>hello two\ntree\nfour\nxxx two\nyyy\nworld five\nzzz\n</code></pre> - \u884c\u53f7\u6b63\u5219\u6df7\u5408\u4f7f\u7528</p> <pre><code>#/four/ \u5982\u679c\u6ca1\u5339\u914d\u5230\u884c,\u90a3\u4e48\u4ece\u7b2c 1 \u884c\u4e00\u76f4\u5339\u914d\u5230\u6700\u540e,\u4f1a\u90fd\u6253\u5370.\nsed -n '1,/four/p' example.txt\n#\u5982\u679c\u5339\u914d\u5230\u884c\u53f7\u5927\u4e8e \u540e\u9762\u7684\u5177\u4f53\u884c\u6570, \u90a3\u4e48\u5c31\u53ea\u4f1a\u663e\u793a /four/ \u5339\u914d\u5230\u7684\u884c\nsed -n '/four/,6p' example.txt\n</code></pre> <pre><code># \u6392\u96641-2 \u884c,\u5176\u4ed6\u884c\u8fdb\u884cs\u64cd\u4f5c\nsed -n '1,2!s/one/111/p' example.txt\n# \u6253\u5370\u4e0d\u4fdd\u62a4hello\u7684\u884c\nsed -n '/hello/!p' example.txt\n</code></pre> <pre><code># \u6253\u5370\u6700\u540e\u4e00\u884c\nsed -n '$p'  text.txt example.txt\n# \u6253\u5370\u5404\u81ea\u6587\u4ef6\u7684\u6700\u540e\u4e00\u884c.\nsed -ns '$p'  text.txt example.txt\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/sed/#x","title":"X \u6307\u4ee4","text":"","tags":["Bash"]},{"location":"linux/bash/sed/#p_1","title":"\u67e5 (p)","text":"X Description <code>p</code>  \u6253\u5370\u5904\u7406\u540e\u7684\u5339\u914d\u884c  (\u6253\u5370pattern space + \u6362\u884c\u7b26) <code>=</code>  \u6253\u5370\u5339\u914d\u884c\u7684\u884c\u53f7 + \u6362\u884c\u7b26 <ul> <li><code>p</code> </li> </ul> <pre><code>seq 3|sed -n '2p'\n</code></pre> <ul> <li><code>=</code> </li> </ul> <pre><code># \u663e\u793a\u5339\u914d\u5230\u7684\u884c\u7684\u884c\u53f7\nsed -n '/hello/=' example.txt\n\nseq -f \"line%g\" 1 3|sed '='\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>1\nline1\n2\nline2\n3\nline3\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/sed/#a-i-r-w","title":"\u589e (a i r w)","text":"X Description <code>a</code>  \u884c\u540e\u8ffd\u52a0 <code>i</code>  \u884c\u524d\u8ffd\u52a0 <code>r</code>  \u5916\u90e8\u6587\u4ef6\u8bfb\u5165, \u884c\u540e\u8ffd\u52a0 <code>w</code>  \u5339\u914d\u884c\u5199\u5165\u5916\u90e8\u6587\u4ef6 <pre><code># \u5728\u5339\u914d\u5230\u7684hello \u884c\u4e0b\u4e00\u884c ,\u6dfb\u52a0 NIHAO \u8fd9\u6837\u4e00\u884c\n# a\u540e\u9762 \u7a7a\u683c \u518d\u8ddf\u4e0a\u4f60\u8981\u6dfb\u52a0\u7684\u5185\u5bb9\nsed -i '/hello/a NIHAO' example.txt\n# \u5339\u914d\u5230\u7684\u6bcf\u4e00\u4e2a\u884c \u540e\u90fd\u6dfb\u52a0\u4e00\u884c \u5185\u5bb9\u662fhi\nsed -i '/hello/,/world/a hi'\n# \u63d2\u5165\u591a\u884c.\nsed -i '/hello/a\\\nhi\\\nhow are your' example.txt\n\n# \u884c\u524d\nsed -i '/hello/i NIHAO' example.txt\n# \u5c06new.txt \u91cc\u7684\u5185\u5bb9\u6dfb\u52a0\u5230 \u5305\u542bhello \u7684\u884c\u540e\nsed -i '/hello/r new.txt' example.txt\nsed -n '/hello/w new.txt' out.txt\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/sed/#d","title":"\u5220 (d)","text":"X Description <code>d</code>  \u5220\u9664 pattern space\u7684\u5185\u5bb9,\u7acb\u523b\u5f00\u59cb\u4e0b\u4e00\u6b21cycle,\u540e\u7eed\u7684\u547d\u4ee4\u4e0d\u518d\u6267\u884c\u4e14\u9ed8\u8ba4\u4e0d\u5e26-n\u65f6\u7684\u6253\u5370\u5904\u7406\u540e\u7684\u884c(pattern space+\u6362\u884c\u7b26) \u7684\u884c\u4e3a\u4e5f\u4e0d\u4f1a\u6267\u884c. \u5982\u679c\u8fd9\u4e2a\u9ed8\u8ba4\u884c\u4e3a\u6ca1\u6709\u53d6\u6d88,\u90a3\u4e48\u4f60\u4e0d\u5e26-n\u65f6\u6bcf\u6b21d,\u90fd\u4f1a\u6253\u5370\u4e00\u884c\u7a7a\u884c\u4e86  <ul> <li>d</li> </ul> <p><pre><code>seq -f \"line%g\" 1 3 | sed '2d;='\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>1\nline1\n3\nline3\n</code></pre> <pre><code># \u5220\u9664\u5305\u542bhello\u7684\u884c\u5230\u5305\u542bworld\u7684\u884c, \u6709\u591a\u4e2a\u5c31\u6267\u884c\u5220\u9664\u591a\u4e2a\u533a\u95f4\nsed '/hello/,/world/d' example.txt\n</code></pre></p>","tags":["Bash"]},{"location":"linux/bash/sed/#s_1","title":"\u6539 (s)","text":"X Description <code>s</code>   \u66ff\u6362\u64cd\u4f5c flags Description <code>i/I</code> \u5339\u914d\u65f6\u5ffd\u7565\u5927\u5c0f\u5199 example.txt\u4f8b\u5b50\u53cd\u5411\u5f15\u7528 &amp;\u4e0e\\n <pre><code>HEllo cat\nxx hello yyy hello\nhot dog HELLO\n</code></pre> <p><pre><code>#\u6bcf\u4e00\u884c\u7684\u7b2c\u4e00\u4e2a hello \u66ff\u6362\u4e3a world\nsed 's/hello/world/' example.txt\n# \u5168\u90e8hello\u66ff\u6362\u4e3aworld\nsed 's/hello/world/g' example.txt #\u5ffd\u7565\u5927\u5c0f\u5199,\u5168\u90e8\u66ff\u6362 i/I \u5927\u5199\u7684I\u4e5f\u662f\u4e00\u4e2a\u610f\u601d\nsed 's/hello/world/ig' example.txt # \u5c06\u884c\u5185\u7b2c 2 \u4e2a\u5339\u914d\u7684 hello \u5230\u540e\u9762\u6240\u6709\u5339\u914d\u5230\u7684 hello \u66ff\u6362\u4e3a world\nsed 's/hello/world/2g' example.txt\n</code></pre> sed 's/hello/world/2g' example.txt \u6267\u884c\u7ed3\u679c<pre><code>HEllo cat\nxx hello yyy world\nhot dog HELLO\n</code></pre></p> <pre><code># \\U \u5c06\u5339\u914d\u5230\u7684\u5185\u5bb9 \u8f6c\u4e3a\u5927\u5199 (\\u \u662f\u7b2c\u4e00\u4e2a\u5b57\u7b26\u5927\u5199)\nsed 's/hello/\\U&amp;/g' example.txt\n# \u5c06xx\u8f6c\u4e3a\u5927\u5199, yyy\u8f6c\u4e3a\u5927\u5199 \\E\u8868\u793a\u505c\u6b62\u524d\u9762\\U \u7684\u884c\u4e3a,\u5c31\u662f\\E\u540e\u9762\u7684\u4e0d\u4f1a\u7ee7\u7eed\u8f6c\u5927\u5199\u4e86.\nsed -E 's/(xx)\\shello\\s(yyy)/\\U\\1\\E hello \\U\\2/g' example.txt\n# \u540c\u7406 \\L \u662f\u5c06\u5339\u914d\u5230\u7684\u5185\u5bb9 \u8f6c\u4e3a\u5c0f\u5199, \\l \u662f\u5c06\u7b2c\u4e00\u4e2a\u5b57\u7b26\u8f6c\u5c0f\u5199\nsed -E 's/hello/\\L&amp;/ig' example.txt\n</code></pre> regex Description <code>&amp;</code> \u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u5230\u7684\u6240\u6709\u5185\u5bb9 <code>\\n</code> (n\u503c\u4e3a1-9) \u6b63\u5219\u8868\u8fbe\u5f0f\u91cc\\(\\)\u91cc\u5339\u914d\u5230\u7684\u5185\u5bb9 &amp;\\n <pre><code># \u5c06\u4e24\u884c\u7684eat/EAT \u6539\u6210==&gt; don't eat/EAT\n# &amp; \u8868\u793a/eat/\u6b63\u5219\u5339\u914d\u5230\u7684\u5177\u4f53\u5185\u5bb9\nsed \"s/eat/don't &amp;/i\" &lt;&lt;EOF\ncats eat fish\ndogs EAT fish\nEOF\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>cats don't eat fish\ndogs don't EAT fish\n</code></pre> <p><pre><code># \\S \u975e\u7a7a\u767d\u5b57\u7b26\n# \u6309\u987a\u5e8f \u7b2c\u4e00\u4e2a() \u5c31\u662f \\1...\nsed -E \"s/(\\S+)\\s(eat)\\s(\\S+)/\\3 \\2 \\1/i\" &lt;&lt;EOF\ncats eat fish\ndogs EAT fish\nEOF\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>fish eat cats\nfish EAT dogs\n</code></pre></p>","tags":["Bash"]},{"location":"linux/bash/sed/#nn","title":"n/N","text":"X Description <code>n</code>   \u5982\u679c\u6ca1\u6709\u4f7f\u7528\u53c2\u6570-n, \u5219\u7acb\u523b\u6253\u5370\u5904\u7406\u540e\u7684\u884c(pattern space+\u6362\u884c\u7b26),\u7136\u540e\u4e0d\u7ba1\u662f\u5426\u4f7f\u7528-n,\u90fd\u5c06pattern space \u66ff\u6362\u4e3a\u4e0b\u4e00\u884c\u7684\u5185\u5bb9,\u5982\u679c\u6ca1\u6709\u4e0b\u4e00\u884c\u4e86,\u5219\u7acb\u523b\u7ed3\u675f,\u540e\u7eed\u6307\u4ee4\u4e0d\u64cd\u4f5c. <code>N</code>   \u8ffd\u52a0\u6362\u884c\u7b26\u5230pattern space,\u7ee7\u7eed\u8ffd\u52a0\u4e0b\u4e00\u884c\u7684\u5185\u5bb9 ,\u5982\u679c\u6ca1\u6709\u4e0b\u4e00\u884c\u4e86,\u5219\u7acb\u523b\u7ed3\u675f,\u540e\u7eed\u6307\u4ee4\u4e0d\u64cd\u4f5c. nN <p><pre><code>seq 1 3 | sed  'n;p'\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>1\n2\n2\n3\n</code></pre></p> debug<pre><code>SED PROGRAM:\nn\np\nINPUT:   'STDIN' line 1\nPATTERN: 1\nCOMMAND: n\n1\nPATTERN: 2\nCOMMAND: p\n2\nEND-OF-CYCLE:\n2\nINPUT:   'STDIN' line 3\nPATTERN: 3\nCOMMAND: n\n3\nEND-OF-CYCLE:\n</code></pre> <ol> <li>\u7b2c6-7\u884c,\u7531\u4e8e\u8fd9\u91cc \u4e0d\u5e26-n,\u5219\u7acb\u523b\u6253\u5370 pattern space,\u7136\u540e \u5c06pattern space \u66ff\u6362\u4e3a\u4e0b\u4e00\u884c</li> <li>\u7b2c8\u884c\u663e\u793a\u4e3a\u66ff\u6362\u540e\u7684 pattern space</li> <li>\u7b2c9-10\u884c \u662fp\u7684\u64cd\u4f5c, \u6253\u5370\u4e86 pattern space</li> <li>\u7b2c13\u884c\u8bf4\u660e\u76f4\u63a5\u8bfb\u53d6\u4e86\u6587\u4ef6\u7684\u7b2c3\u884c, \u7b2c15\u884c\u7684n \u64cd\u4f5c \u53d1\u73b0\u6ca1\u6709\u4e0b\u4e00\u884c\u4e86.\u7acb\u523b\u7ed3\u675f\u4e86. \u4e0d\u505a\u540e\u7eed\u7684p\u64cd\u4f5c.</li> </ol> <pre><code>#  \u6bd4\u5982\u5076\u6570\u884c \u505a\u4e9b\u64cd\u4f5c\nseq 6 | sed -n 'n;p'\n# \u5339\u914d\u5230\u7684\u884c\u540e\u9762\u7b2c2\u884c\nseq 7 |sed -n '/3/{n;n;p}' # \u663e\u793a5\n</code></pre> <p><pre><code># \u5c06\u7b2c3\u884c\u548c\u7b2c3\u884c \u5408\u6210\u4e00\u884c.\nsed  '2N;s/\\n/--/' example.txt\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>HEllo cat\nxx hello yyy hello--hot dog HELLO\n</code></pre> debug<pre><code>SED PROGRAM:\n2 N\ns/\\n/--/\nINPUT:   '2.txt' line 1\nPATTERN: HEllo cat\nCOMMAND: 2 N\nCOMMAND: s/\\n/--/\nPATTERN: HEllo cat\nEND-OF-CYCLE:\nHEllo cat\nINPUT:   '2.txt' line 2\nPATTERN: xx hello yyy hello\nCOMMAND: 2 N\nPATTERN: xx hello yyy hello\\nhot dog HELLO\nCOMMAND: s/\\n/--/\nMATCHED REGEX REGISTERS\nregex[0] = 18-19 '\n'\nPATTERN: xx hello yyy hello--hot dog HELLO\nEND-OF-CYCLE:\nxx hello yyy hello--hot dog HELLO\n</code></pre></p>","tags":["Bash"]},{"location":"linux/bash/sed/#_4","title":"; \u548c {;}","text":"<p>;\u53ef\u4ee5\u6709\u591a\u4e2a</p> <p>{}\u91cc\u8fd8\u53ef\u4ee5\u6709{}</p> ;{;} <p><pre><code># = \u8868\u793a\u6253\u5370\u5339\u914d\u7684\u884c\u7684\u884c\u53f7\nsed -n  '/hello/=;p' &lt;&lt;EOF\nhello cat\nhot dog\nworld hello\nEOF\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>1\nhello cat\nhot dog\n3\nworld hello\n</code></pre> <code>/hello/=;p</code> \u5bf9\u4e0e\u5339\u914d\u5230hello\u7684\u884c\u6267\u884c=\u6307\u4ee4, p\u4e0e\u524d\u9762\u7684\u65e0\u5173, \u5b83\u4f1a\u91cd\u65b0\u770b\u8be5\u884c\u662f\u5426\u5339\u914d\u5b83\u81ea\u5df1\u7684\u89c4\u5219.</p> <p><pre><code>sed -n  '/hello/{=;p}' &lt;&lt;EOF\nhello cat\nhot dog\nworld hello\nEOF\n</code></pre> \u6267\u884c\u7ed3\u679c<pre><code>1\nhello cat\n3\nworld hello\n</code></pre></p> <p><code>/hello/{=;p}</code> \u5bf9\u4e8e\u5339\u914d\u5230hello\u7684\u884c \u6267\u884c =\u6307\u4ee4,\u518d\u6267\u884cp\u6307\u4ee4. {}\u91cc\u7684\u6307\u4ee4\u662f\u4e00\u4e2a\u6574\u4f53</p> <pre><code># \u591a\u4e2a\u64cd\u4f5c \u53ef\u4ee5\u8fd9\u6837\u5199 ,\u4e0d\u7528;\u53f7\nsed  '/hello/{\n/world/a  python\n=\n}' &lt;&lt;EOF\nhello xx\nhello world\ngolang\nEOF\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/sed/#_5","title":"\u4f7f\u7528\u53d8\u91cf","text":"<pre><code>pattern=\"he..o\"\n# \u8fd9\u6837. pattern\u91cc\u7684. \u5728\u4e0b\u9762\u8fd8\u662f\u8868\u793a \u4efb\u610f\u5b57\u7b26\u54e6.\n# \u4f7f\u7528\u53cc\u5f15\u53f7\nsed -n \"s/$pattern/world/g\" example.txt\n#\u6216\u8005 \u5355\u5f15\u53f7\nsed -n 's/'$pattern'/world/g' example.txt\n</code></pre> <ol> <li> <p>https://www.gnu.org/software/sed/manual/sed.html \u21a9</p> </li> <li> <p>https://www.gnu.org/software/sed/#source \u21a9</p> </li> <li> <p>https://www.gnu.org/software/sed/manual/sed.html#Multiline-techniques \u21a9</p> </li> <li> <p>https://www.gnu.org/software/sed/manual/sed.html#Other-Commands \u21a9</p> </li> <li> <p>https://www.gnu.org/software/sed/manual/sed.html#Regular-Expressions-Overview \u21a9</p> </li> <li> <p>https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Regular_Expressions \u21a9</p> </li> <li> <p>https://www.ibm.com/docs/en/aix/7.3?topic=s-sed-command \u21a9</p> </li> </ol>","tags":["Bash"]},{"location":"linux/bash/var/","title":"\u53d8\u91cf","text":"","tags":["Bash"]},{"location":"linux/bash/var/#_1","title":"\u73af\u5883\u53d8\u91cf","text":"<pre><code>env # \u6253\u5370\u6240\u6709\u73af\u5883\u53d8\u91cf\nprintenv # \u540c\u4e0a\necho $HOME # \u6253\u5370\u67d0\u4e2a\u53d8\u91cf\u7684\u503c\nprintenv HOME # \u540c\u4e0a\n# \u4e00\u4e9b\u5e38\u7528\u7684\u73af\u5883\u53d8\u91cf\necho $PWD\necho $HOST # \u5f53\u524d\u4e3b\u673a\u540d\necho $IFS # \u8bcd\u4e0e\u8bcd\u7684\u5206\u9694\u7b26, \u9ed8\u8ba4\u4e3a\u7a7a\u683c\necho $RANDOM #\u8fd4\u56de\u4e00\u4e2a0\u523032767\u4e4b\u95f4\u7684\u968f\u673a\u6570\necho $SHELL  # \u5f53\u524d\u4f7f\u7528\u7684Shell  \u6bd4\u5982 /bin/bash \u6216/bin/zsh\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_2","title":"\u81ea\u5b9a\u4e49\u53d8\u91cf","text":"\u589e\u8bfb\u5220export\u8bbe\u7f6e\u9ed8\u8ba4\u503c <pre><code>echo $ff # \u6ca1\u6709\u5b9a\u4e49\u7684\u53d8\u91cf\u540d ,\u9ed8\u8ba4\u662f\u7a7a\na=1 # \u4e24\u8fb9\u4e0d\u80fd\u7528\u7a7a\u683c\n# \u8fd9\u4e2a\u76f8\u5f53\u4e8e \"a=\" \u7136\u540e \u6267\u884c1 \u8fd9\u4e2a\u547d\u4ee4\n# \u63d0\u793a \u6ca1\u67091 \u8fd9\u4e2a\u547d\u4ee4\na= 1\na =1 # \u540c\u6837 ,\u4f1a\u5c06a \u4f5c\u4e3a\u547d\u4ee4 \u6267\u884c,\u63d0\u793a\u6ca1\u6709\u8be5\u547d\u4ee4\nstr=\"hello world\" # \u7528\u7a7a\u683c \u7528\"\" \u5305\u8d77\u6765\necho $str  # hello world, \u9ed8\u8ba4\u4f1a\u5c06\u591a\u4e2a\u7a7a\u683c\u5408\u5e76\u6210\u4e00\u4e2a\nstr=\"hello     world\"\necho $str  # hello world\necho \"$str\"  # hello     world\n</code></pre> <pre><code>python_version=3.10\npython=snake\n# $ \u4f1a\u5c06\u540e\u9762\u7684\u5b57\u7b26\u4e32\u89c6\u4e3a\u53d8\u91cf\u540d\necho $python_version # 3.10\n# \u4f7f\u7528{} \u5c06\u53d8\u91cf\u540d\u5305\u8d77\u6765\necho ${python}_version # snake_version\n</code></pre> \u53d8\u91cf\u7684\u503c\u5f53\u6210\u53d8\u91cf\u540d<pre><code>a=b\nc=a\necho $c # a\necho ${!c} # b\n</code></pre> <pre><code>a=1\nunset a\n# \u8bbe\u7f6e\u4e3a\u7a7a, \u5c31\u662f\u5220\u9664, \u524d\u9762\u8bf4\u5230,\u4e0d\u5b9a\u4e49,\u9ed8\u8ba4\u5c31\u662f\u7a7a\na=''\na=\n</code></pre> <pre><code>a=1 # \u53ea\u80fd\u5728\u5f53\u524dshell\u53ef\u7528,\nexport a # \u8fd9\u6837 \u5728\u5f53\u524dshell\u521b\u5efa\u7684\u5b50shell\u90fd\u53ef\u4ee5\u4f7f\u7528\u8be5\u53d8\u91cf\nexport b=2 # \u76f4\u63a5\u8d4b\u503cexport\n</code></pre> <p><pre><code># b \u4e0d\u4e3a\u7a7a,\u5219\u8fd4\u56deb\u7684\u503c, \u5426\u5219\u8fd4\u56de 123\na=${b:-123}\necho $a # 123 ,b\u8fd8\u662f\u7a7a\u7684\n# b \u4e0d\u4e3a\u7a7a,\u5219\u8fd4\u56deb\u7684\u503c, \u5426\u5219\u8bbe\u7f6eb\u4e3a123,\u5e76\u4e14\u8fd4\u56de123\na=${b:=123}\necho $a,$b # 123,123\n# c \u4e0d\u4e3a\u7a7a,\u5219\u8fd4\u56de1, \u5426\u5219\u8fd4\u56de\u7a7a\n# \u53ef\u4ee5\u7528\u6765\u5224\u65adc \u662f\u5426\u4e3a\u7a7a,\u8fd4\u56de1 \u5c31\u662f\u4e0d\u4e3a\u7a7a\u4e86\necho ${c:+1} #\nc=2\necho ${c:+1} # 1\n# \u5982\u679cd\u53d8\u91cf\u672a\u5b9a\u4e49,\u5219\u62a5\u9519\u9000\u51fa ,\u9519\u8bef\u4fe1\u606f\u662f\u4f60\u5199\u7684 undefined\n# \u7528\u6765\u9632\u6b62\u53d8\u91cf\u672a\u5b9a\u4e49\n${d:?undefined} # -bash: d: undefined\n</code></pre> \u811a\u672c\u4e2d\u5e94\u7528<pre><code># \u4f7f\u7528 1 \u5230 9 \u8868\u793a\u53c2\u6570\n#!/bin/bash\n${1:?\"\u8bf7\u5e26\u4e0a\u53c2\u6570\"}\n</code></pre></p>","tags":["Bash"]},{"location":"linux/bash/var/#_3","title":"\u5c40\u90e8\u53d8\u91cf\u548c\u5168\u5c40\u53d8\u91cf","text":"<pre><code>#!/bin/bash\na=1\nfoo(){\nb=2 # \u6267\u884cfoo\u51fd\u6570\u540e, b\u662f\u5168\u5c40\u53d8\u91cf\nlocal c=3 # \u5c40\u90e8\u53d8\u91cf\nlocal a=4 # \u4e0e\u5916\u90e8\u7684a \u662f\u4e0d\u4e00\u6837\u7684\u53d8\u91cf\n}\nfoo\necho $a # 1\necho $b # \u8bfb\u53d6\u7684\u5230\necho $c # \u8bfb\u53d6\u4e0d\u5230\nbar(){\necho $b\n}\nbar # \u4f1a\u6253\u5370 b\u7684\u503c\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_4","title":"$\u5f00\u5934\u7684\u7279\u6b8a\u53d8\u91cf","text":"<p><pre><code># \u4e0a\u4e00\u4e2a\u547d\u4ee4\u7684\u9000\u51fa\u7801,\u6211\u4eec\u7528\u6765\u5224\u65ad\u547d\u4ee4\u6267\u884c\u662f\u5426\u6210\u529f\nlss\necho $?  # &gt; 0 \u8868\u793a\u6267\u884c\u5931\u8d25, 0 \u8868\u793a\u6210\u529f\n# $$\u4e3a\u5f53\u524dShell\u7684\u8fdb\u7a0bID\necho $$\n#$_ \u4e0a\u4e00\u4e2a\u547d\u4ee4\u7684\u6700\u540e\u4e00\u4e2a\u53c2\u6570\nls tmp_install\necho $_ # tmp_install\n</code></pre> \u811a\u672ca.sh<pre><code>#!/bin/bash\necho $0\necho $1\necho $2\necho $*\necho $@\necho $#\n# \u770b\u770b$@ $* \u4e4b\u95f4\u7684\u533a\u522b\nfor var in \"$*\"\ndo\necho \"$var\"\ndone\nfor var in \"$@\"\ndo\necho \"$var\"\ndone\n</code></pre></p> \u6267\u884c ./a.sh a b c \u7684\u7ed3\u679c<pre><code>./a.sh  # $0 \u811a\u672c\u672c\u8eab\na       # $1 \u7b2c\u4e00\u4e2a\u53c2\u6570\nb       # $2 \u7b2c\u4e8c\u4e2a\u53c2\u6570\na b c   # $* \u6240\u6709\u53c2\u6570\na b c   # $@ \u6240\u6709\u53c2\u6570\n3       # $# \u53c2\u6570\u4e2a\u6570\na b c   # \"$*\" \u53c2\u6570\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\na       # \"$@\" \u8fd8\u662f\u4f1a\nb\nc\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#declare-typeset","title":"declare / typeset","text":"<p>Tip</p> <p>declare\u548ctypeset \u7b49\u4ef7</p>","tags":["Bash"]},{"location":"linux/bash/var/#_5","title":"\u6253\u5370\u5f53\u524d\u73af\u5883\u6240\u6709\u53d8\u91cf","text":"<pre><code># \u4e0d\u5e26\u53c2\u6570\ndeclare\ntypeset\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_6","title":"\u7533\u660e\u4e3a\u53ea\u8bfb","text":"<pre><code># \u53ea\u8bfb, \u4fee\u6539\u4f1a\u62a5\u9519\ndeclare -r a=1\na=2  # -bash: a: readonly variable\nunset a  # -bash: unset: a: cannot unset: readonly variable\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_7","title":"\u7533\u660e\u4e3a\u6574\u578b","text":"<pre><code>a1=1\na2=2\nc=b1+b2\necho $c  # \u7ed3\u679c\u662f  b1+b2\n# \u6211\u4eec\u8ba1\u7b97\u662f\u8981\u8fd9\u6837\u7684\na4=$((a1 + a2))  # \u6216a3=$(($a1 + $a2))\n# \u7533\u660e\u4e3a\u6574\u578b\ndeclare -i a1=1 a2=2\ndeclare -i res\nres=a1+a2\necho $res # 3\nres=a1+a2 # 3 \u8fd9\u6837\u5176\u5b9e\u5c31ok\u7684, \u53ea\u8981 \u7ed3\u679c\u7684\u53d8\u91cf\u8bbe\u7f6e\u4e3a\u6574\u578b,a1\u548ca2 \u4e0d\u9700\u8981\u8bbe\u7f6e.\nres=a1+10 # 11\nd=1+2\necho d # 1+2\ndeclare -i d\nd=1+2\necho d # 3\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_8","title":"\u58f0\u660e\u53d8\u91cf\u4e3a\u5927/\u5c0f\u5199\u5b57\u6bcd","text":"<pre><code># \u7533\u660e\u4e3a\u5c0f\u5199\ndeclare -l a\na=AbC\necho $a # abc\n# \u7533\u660e\u4e3a\u5927\u5199\ndeclare -u b\nb=abc\necho $b # ABC\n# \u53d6\u6d88\u53d8\u91cfb \u7684\u5927\u5199\u7533\u660e\ndeclare +u b # - \u53d8+ \u90fd\u6709\u7c7b\u4f3c\u6548\u679c\nb=abc\necho $b # abc \u4e0d\u518d\u4f1a\u53d8\u6210ABC\u4e86\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_9","title":"\u7533\u660e\u4e3a\u73af\u5883\u53d8\u91cf","text":"<pre><code>a=1\ndeclare -x a # \u540cexport a\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_10","title":"\u663e\u793a\u5f53\u524d\u73af\u5883\u7684\u6240\u6709\u51fd\u6570","text":"<pre><code># \u6253\u5370\u5f53\u524d\u73af\u5883\u7684\u6240\u6709\u51fd\u6570\u540d \u4ee5\u53ca \u5b9a\u4e49\ndeclare -f\n# \u53ea\u6253\u5370\u51fd\u6570\u540d\ndeclare -F\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_11","title":"\u5b57\u7b26\u4e32","text":"","tags":["Bash"]},{"location":"linux/bash/var/#_12","title":"\u62fc\u63a5","text":"<pre><code>str1=\"hello\"\nstr2=\"world\"\nresult=\"$str1 $str2\"\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_13","title":"\u957f\u5ea6","text":"<pre><code>str=\"hello world\"\necho ${#str} # \u8f93\u51fa \"11\"\necho $(expr length \"$str\")\necho `expr length \"$str\"`\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_14","title":"\u622a\u53d6","text":"\u622a\u53d6\u83b7\u53d6\u5b57\u7b26\u5728\u5b57\u7b26\u4e32\u4e2d\u7684\u7d22\u5f15\u83b7\u53d6\u5b50\u4e32\u7684\u957f\u5ea6 <pre><code>str=\"hello world\"\n#  \u4ece\u7b2c6\u4e2a\u7d22\u5f15\u5f00\u59cb,\u5305\u542b\u7d22\u5f15\u4f4d\u7f6e\u7684\u5b57\u7b26, \u622a\u53d65\u4e2a\u5b57\u7b26.\necho ${str:6:5} # \u8f93\u51fa \"world\"\necho ${str:2} # llo world\n# \u540c\u4e0a\necho ${str:(2)}  # llo world\n# : \u540e\u9762\u5fc5\u987b\u6709\u7a7a\u683c. -2 \u8868\u793a\u4ece\u5c3e\u90e8\u5f00\u59cb\u627e\necho ${str: -2} #ld\n# \u540c\u4e0a\necho ${str:(-2)} #ld\necho ${str: -5:2} # wo\necho ${str:(-5):2} # wo\n</code></pre> <p>Warning</p> <p>expr index \u547d\u4ee4\u53ea\u80fd\u67e5\u627e\u5355\u4e2a\u5b57\u7b26\u6216\u5b57\u7b26\u4e32\u4e2d\u7684\u7b2c\u4e00\u4e2a\u5b57\u7b26\uff0c\u4e0d\u80fd\u67e5\u627e\u591a\u4e2a\u5b57\u7b26\u7ec4\u6210\u7684\u5b50\u4e32 \u5982\u679c\u662f\u5b50\u4e32,\u90a3\u4f1a\u5c06\u5b50\u4e32\u91cc\u7684\u6bcf\u4e2a\u5b57\u7b26\u5168\u90e8\u627e\u4e00\u904d, \u7136\u540e\u663e\u793a\u6700\u77ed\u7684\u90a3\u4e2a \u8fd9\u91cc\u7684\u7d22\u5f15\u662f\u4ece1 \u5f00\u59cb\u7684, \u800c${str:1} \u662f\u4ece0\u5f00\u59cb\u7684 </p> <pre><code>str=\"hello world\"\n# \u4e0d\u662f7 \u800c\u662f3?  \u8fd9\u662f\u56e0\u4e3a\u5b83\u4f1a\u5c06\u4f60\u7684\u5b57\u4e32\u91cc\u7684\u6bcf\u4e2a\u5b57\u7b26\u5168\u90e8\u627e\u4e00\u904d, \u7136\u540e\u663e\u793a\u6700\u77ed\u7684\u90a3\u4e2a\n# w \u662f\u5728 \u7b2c7\u4e2a\u4f4d\u7f6e, o\u5728 5,  \u800cl \u662f\u57283 \u6700\u77ed\nexpr index \"$str\" \"world\" # 3\nexpr index \"$str\" \"worle\" # 2\n# \u6211\u4eec\u5e94\u8be5\u8fd9\u6837\u4f7f\u7528\u8fd9\u4e2a\nexpr index \"$str\" \"w\"  # 7\n</code></pre> <p>Tip</p> <p>\u6240\u4ee5\u8fd9\u4e2a\u7684\u7528\u6cd5 \u5c31\u4e0d\u8be5\u6574\u5b50\u4e32, \u800c\u662f\u7528\u6765\u627e\u5355\u4e2a\u5b57\u7b26\u7684\u64cd\u4f5c</p> <p>Warning</p> <p>\u5fc5\u987b\u662f\u4ece\u5934\u5f00\u59cb\u627e\u7684</p> <pre><code>str=\"hello world\"\nexpr match \"$str\" world # 0\nexpr match \"$str\" hell # 4\nexpr match \"$str\" hellq # 0\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_15","title":"\u66ff\u6362","text":"\u66ff\u6362\u7b2c\u4e00\u4e2a\u5339\u914d\u7684\u66ff\u6362\u5168\u90e8\u5339\u914d\u7684 <pre><code>str=\"hello hello world\"\necho ${str/hello/goodbye} # \u8f93\u51fa \"goodbye hello world\"\n</code></pre> <pre><code>str=\"hello hello world\"\necho ${str//hello/goodbye} # \u8f93\u51fa \"goodbye goodbye world\"\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_16","title":"\u5220\u9664(\u66ff\u6362\u4e3a\u7a7a)","text":"\u4ece\u5934\u5220\u9664\u4ece\u5c3e\u5220\u9664 <p>\u6700\u77ed\u5339\u914d<pre><code>str=\"hello world hello python\"\necho ${str#*llo} # world hello python\n</code></pre> \u6700\u957f\u5339\u914d<pre><code>str=\"hello world hello python\"\necho ${str##*llo} # python\n</code></pre></p> <p>\u6700\u77ed\u5339\u914d<pre><code>str=\"hello world hello python\"\necho ${str%llo*} # hello world he\n</code></pre> \u6700\u957f\u5339\u914d<pre><code>str=\"hello world hello python\"\necho ${str%%llo*} # he\n</code></pre></p>","tags":["Bash"]},{"location":"linux/bash/var/#_17","title":"\u5927\u5c0f\u5199\u8f6c\u6362","text":"\u5927\u5199\u8f6c\u5c0f\u5199\u5c0f\u5199\u8f6c\u5927\u5199 <pre><code>str=\"Hello World\"\necho ${str,,} # \u8f93\u51fa \"hello world\"\n</code></pre> <pre><code>str=\"hello world\"\necho ${str^^} # \u8f93\u51fa \"HELLO WORLD\"\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_18","title":"\u6570\u7ec4","text":"<p>Tip</p> <p>\u6574\u578b\u6570\u7ec4\u65e0\u9700\u7528declare -a arr \u8fdb\u884c\u7533\u660e \u5173\u8054\u6570\u7ec4\u5fc5\u987b\u8981declare -A arr \u8fdb\u884c\u7533\u660e</p>","tags":["Bash"]},{"location":"linux/bash/var/#_19","title":"\u589e","text":"\u65b9\u5f0f\u4e00\u65b9\u5f0f\u4e8c\u65b9\u5f0f\u4e09read -a\u8ffd\u52a0\u5143\u7d20 <pre><code>arr[0]=a\narr[1]=b\narr[2]=c\n</code></pre> <pre><code>arr=(a b c) # \u7d22\u5f15\u6309\u987a\u5e8f\narr=([0]=c [1]=a [2]=b) # \u6307\u5b9a\u7d22\u5f15\n</code></pre> <pre><code>touch a.txt b.txt c.txt\narr=(x *.txt)\necho ${arr[0]} # x\necho ${arr[1]} # a.txt\narr2=(x $(ls *.txt))\n</code></pre> <pre><code>read -a arr # \u8f93\u5165 a b c\necho ${arr[0]} # a\n</code></pre> <pre><code>arr=(a b c)\narr+=(1 2 3)\necho ${arr[@]} # a b c 1 2 3 \n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_20","title":"\u67e5","text":"\u5355\u4e2a\u5143\u7d20\u6240\u6709\u5143\u7d20\u5143\u7d20\u4e2a\u6570\u5143\u7d20\u7684\u957f\u5ea6\u7d22\u5f15\u904d\u5386\u622a\u53d6 <pre><code>arr=(a b c)\necho ${arr[0]} # a\necho $arr  # \u8f93\u51fa \u9996\u4e2a\u5143\u7d20\u7684\u503c\necho $arr[0] # \u8f93\u51fa a[0]  ,{} \u662f\u5fc5\u987b\u7684.\n</code></pre> <pre><code>arr=(a b c)\necho ${arr[@]} # a b c\necho ${arr[*]}\n</code></pre> <pre><code>arr=([5]=1 [2]=4 [10]=1)\necho ${#arr[*]} #3\necho ${#arr[@]} #3\n</code></pre> \u7d22\u5f150\u7684\u5143\u7d20\u7684\u957f\u5ea6<pre><code>arr=(abc e fg)\necho ${#arr[0]} #3\n</code></pre> <pre><code>arr=([5]=1 [2]=4 [10]=1)\necho ${!arr[@]} # \u6253\u5370\u7d22\u5f15 2 5 10\necho ${!arr[*]} # \u540c\u4e0a\n</code></pre> <pre><code>arr=(a b c)\nfor i in ${!arr[@]}\ndo\necho ${arr[i]}\ndone\n</code></pre> <p>Tip</p> <p>\u4e0e\u5b57\u7b26\u4e32\u622a\u53d6\u7c7b\u4f3c</p> <pre><code>arr=(a b c e f g)\n# ${arr[@]:position:length}\necho ${arr[@]:1:2} # b c\n# \u7701\u7565 length\necho ${arr[@]:2} # c e f g\necho ${arr[@]: -2} # f g\necho ${arr[@]: -3:1} # e\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_21","title":"\u5220","text":"<pre><code>arr=(a b c)\necho ${!arr[@]} # 0 1 2\nunset arr[0]\necho ${arr[@]} # b c\necho ${!arr[@]} # 1 2, \u7d22\u5f150 \u6ca1\u6709\u4e86.\nunset arr # \u5168\u90e8\u5220\u9664\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/var/#_22","title":"\u5173\u8054\u6570\u7ec4","text":"<p>Tip</p> <p>\u9700\u8981bash 4.0 \u4ee5\u4e0a\u7248\u672c</p> <pre><code>declare -A it\nit[\"go\"]=\"1.19.0\"\nit[\"python\"]=\"3.10.0\"\nit[\"rust\"]=\"1.58.1\"\n</code></pre>","tags":["Bash"]},{"location":"linux/bash/%E7%BB%BC%E5%90%88%E4%BE%8B%E5%AD%90/","title":"\u7efc\u5408\u4f8b\u5b50","text":"","tags":["Bash"]},{"location":"linux/bash/%E7%BB%BC%E5%90%88%E4%BE%8B%E5%AD%90/#_1","title":"\u5b9e\u7528\u811a\u672c","text":"<p>\u770b\u65e0\u6ce8\u91ca\u7684\u914d\u7f6e\u6587\u4ef6<pre><code># \u8fc7\u6ee4\u6389\u7a7a\u884c\u548c\u6ce8\u91ca, \u8fd9\u91cc\u4ee5# \u4f5c\u4e3a\u6ce8\u91ca\u7b26\u53f7\u7684\u4f8b\u5b50\n# [:blank:] \u8868\u793a \u7a7a\u683c\u548ctab\n# 1. \u9996\u5148\u4ee5\u7a7a\u683c\u6216tab\u5f00\u5934\u7684 (0\u4e2a\u6216\u591a\u4e2a,0\u5c31\u8868\u793a\u53ef\u4ee5\u4e0d\u662f\u4ee5\u8fd9\u4e2a\u4e3a\u5f00\u5934)\n# 2. [^#[:blank:]] \u53cd\u5411\u5b57\u7b26\u96c6 ,\u8868\u793a\u63a5\u7740\u7684\u5b57\u7b26\u662f \u4e0d\u80fd\u662f# \u7a7a\u683c\u548ctab, \u5c31\u662f\u8bf4\u5339\u914d\u975e(#\u7a7a\u683ctab)\u7684\u5b57\u7b26\n#    \u8fc7\u6ee4\u4e86\u7a7a\u884c, \u8fc7\u6ee4\u4e86 #\u5f00\u5934\u7684\u884c, \u8fc7\u6ee4\u4e86 \u7a7a\u683c/tab+# \u7684\u884c\nsed -n '/^[[:blank:]]*[^#[:blank:]]/p' my.cnf\n</code></pre> \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5e76\u505a\u5907\u4efd<pre><code># \u4fee\u6539\u6587\u4ef6 my.cnf, \u5e76\u505a\u5c06\u6e90\u6587\u4ef6\u751f\u6210\u4e00\u4e2a\u5907\u4efd,\u6587\u4ef6\u540d\u662fmy.cnf.bak\nsed -i.bak 's/hello/world/g' my.cnf\n</code></pre> \u7edf\u8ba1\u82f1\u8bed\u5355\u8bcd\u6b21\u6570<pre><code># (\u7f51\u4e0a\u968f\u4fbf\u627e\u5230\u7684\u4f8b\u5b50\u57fa\u672c\u90fd\u4e0d\u592a\u4e25\u8c28.)\n# \u8fd9\u91cc\u6211\u6392\u9664\u4e86 \u5404\u79cd\u7b26\u53f7. \u6bd4\u5982\u6807\u70b9\u7b26\u53f7. &lt;&gt; \u7b49\u7b49\n# \u4f1a\u5c06 don't \u548c xxx's \u8fd9\u79cd \u770b\u6210\u4e00\u4e2a\u5355\u8bcd. (\u5177\u4f53\u770b\u5b9e\u9645\u7684\u9700\u6c42)\n# \\L \u8868\u793a\u90fd\u8f6c\u6210\u5c0f\u5199\nsed -nE \"s/[^a-zA-Z]*([a-zA-Z]+'[a-zA-Z]|[a-zA-Z]+)[^a-zA-Z]*/\\L\\1\\n/gp\" book.txt \\\n|sed '/^$/d' \\\n|sort \\\n|uniq -c \\\n|sort -n -r -t \" \" -k 1 \\\n|head -10\n</code></pre> \u5904\u7406\u7a7a\u884c\u7a7a\u683c<pre><code>#\u5220\u9664\u884c\u9996\u7684\u7a7a\u683c\u548c\u884c\u5c3e\u7684\u7a7a\u683c\nsed 's/^ *//;s/ *$//' example.txt\n\n# \u5236\u8868\u7b26 tab \u8f6c\u4e3a\u7a7a\u683c\nsed 's/\\t/  /g' example.txt\n\n# \u5220\u9664\u7a7a\u884c\nsed  '/^$/d' example.txt\n</code></pre> \u6307\u5b9a\u884c\u53f7,\u6b63\u5219\u5339\u914d,\u533a\u95f4,\u975e!,\u6700\u540e\u4e00\u884c$<pre><code># \u6253\u5370\u7b2c5\u884c\nsed -n '5p' example.txt\n# \u6253\u53705-10\u884c\nsed -n '5,10p' example.txt\n# \u5220\u9664 \u7b2c2-4\u884c, 7-10\u884c\nseq 1 15 |sed '2,4d;7,+3d'\n# \u6253\u5370\u4e0d\u5305\u542bhello\u7684\u884c, I\u8868\u793a \u5ffd\u7565\u5927\u5c0f\u5199, \u8981\u653e\u5230!\u7684\u524d\u9762\nsed -En '/hello/I!p' example.txt\n# \u9996\u884c\u4e0d\u6253\u5370\nsed -n '1!p' example.txt\n# \u6253\u5370\u6700\u540e\u4e00\u884c\nsed -n '$p' example.txt\n\n# \u5339\u914d\u5305\u542bpython\u7684\u884c\u5230 \u5305\u542bjava\u7684\u884c\n# macos\u548clinux\u4e0b\u7684\u90fd\u4f1a\u5339\u914d\u4e0a,2\u4e2a\u533a\u95f4\nsed -n '/python/,/java/p' &lt;&lt;EOF\nmacos\n    python url1\n    golang url2\n    java url3\nlinux\n    python url4\n    golang  url5\n    java url6\nEOF\n# \u53ea\u6253\u5370macos\u4e0b\u7684 ,\u53ef\u4ee5\u8fd9\u6837\nsed -n '/^macos/,/^linux/{/python/,/java/p}' &lt;&lt;EOF\nmacos\n    python url1\n    golang url2\n    java url3\nlinux\n    python url4\n    golang  url5\n    java url6\nEOF\n</code></pre></p> <p><pre><code># \u5c06\u7b2c2\u884c\u548c\u7b2c3\u884c\u5408\u6210\u4e00\u884c\nsed  '2N;s/\\n/ /' example.txt\n</code></pre> \u6574\u7406\u4e2d...<pre><code>\n</code></pre></p>","tags":["Bash"]},{"location":"linux/bash/%E7%BB%BC%E5%90%88%E4%BE%8B%E5%AD%90/#python-conda","title":"python conda \u4e00\u952e\u5b89\u88c5\u811a\u672c","text":"<p>\u8fd9\u91cc\u53ea\u652f\u6301ubuntu\u548cmac, \u6211\u53ea\u6682\u65f6\u6d4b\u8bd5\u4e86 ubuntu \u4e0b\u7684\u5b89\u88c5,\u540e\u7eed\u4f1a\u518d\u4f18\u5316\u6d4b\u8bd5. <pre><code>os=$(uname -s|tr '[:upper:]' '[:lower:]')\ninstall_python(){\n#/Linux installers/,/Installing/ \u8868\u793a\u627e \u8fd92\u4e2a\u4e4b\u95f4\u7684\u6587\u672c\nif [ $os == \"linux\" ];then\nos_begin=\"Linux installers\"\nos_end=\"Installing\"\nelse\nos_begin=\"macOS installers\"\nos_end=\"Linux installers\"\nfi\npyversion=($(curl -Ss https://docs.conda.io/en/latest/miniconda.html | sed -n  '/'\"${os_begin}\"'/,/'\"${os_end}\"'/s#.*&lt;td&gt;Python \\([0-9.]*\\)&lt;/td&gt;#\\1#p'))\necho \"\u9009\u62e9\u4f60\u7684python\u7248\u672c\"\nfor j in ${!pyversion[@]}\ndo\necho $(expr $j + 1): ${pyversion[$j]}\ndone\necho -n \"\u8bf7\u8f93\u5165\u7f16\u53f7:\"\nread python_version_no\n    # \u5c06. \u8f6c\u4e49\npython_version=${pyversion[$(expr $python_version_no-1)]/./\\\\.}\npython_next_version=${pyversion[$python_version_no]/./\\\\.}\nbetween_begin=\"Python \"${python_version}\nbetween_end=\"Python \"${python_next_version}\nif [ -z ${python_next_version} ];then\nbetween_end=\"Installing\"\nfi\n# \u4f7f\u7528//,//{//,//} \u6765\u8303\u56f4\u5185\u627e\u8303\u56f4\ncpuverurl=($(curl -Ss https://docs.conda.io/en/latest/miniconda.html | sed -n '/'\"${os_begin}\"'/,/'\"${os_end}\"'/{/'\"${between_begin}\"'/,/'\"${between_end}\"'/s/.* class=\"reference external\" href=\"\\(.*Linux-\\(.*\\)\\.sh\\)\"&gt;.*/\\2 \\1/p}'))\ndeclare conda_url\n    declare cpu_ver\n\necho \"\u9009\u62e9\u4f60\u7684cpu\u67b6\u6784\"\nfor j in ${!cpuverurl[@]}\ndo\nif [ $(($j%2)) == 0 ];then\ni=$(expr $j / 2 + 1)\necho $i: ${cpuverurl[$j]}\ncpu_ver[$i]=${cpuverurl[$j]}\nconda_url[$i]=${cpuverurl[$(expr $j + 1)]}\nfi\ndone\necho -n \"\u8f93\u5165\u7f16\u53f7:\"\nread chosen_cpu\n    echo \"\u4f60\u9009\u62e9\u7684\u662f:\" ${cpu_ver[${chosen_cpu}]}\nminiconda_url=${conda_url[${chosen_cpu}]}\nexecfile=${conda_url[${chosen_cpu}]##*/}\nwget ${miniconda_url}\nchmod +x $execfile\n# -p \u5b89\u88c5\u7684\u76ee\u5f55.\nbash $execfile -b -p $HOME/miniconda\n    $HOME/miniconda/bin/conda init zsh\n    . ~/.zshrc\n    # \u5982\u679c\u4f60\u5728bash \u73af\u5883\u4e0b \u5b89\u88c5\u7684. \u60f3\u8981\u7528zsh\n# conda init zsh \n# \u5728zsh \u73af\u5883\u4e0b\u5b89\u88c5 \u9ed8\u8ba4\u5c31\u4f1a\u4fee\u6539.zshrc\u7684. \n}\ninstall_python\n</code></pre></p>","tags":["Bash"]},{"location":"linux/bash/%E7%BB%BC%E5%90%88%E4%BE%8B%E5%AD%90/#go","title":"go \u4e00\u952e\u5b89\u88c5\u811a\u672c","text":"<pre><code>os=$(uname -s|tr '[:upper:]' '[:lower:]')\ninstall_go(){\necho  \u6682\u65f6\u53ea\u5199\u4e86 amd64\u7248\u672c\u7684\u4e0b\u8f7d.\n    echo \" \u8f93\u5165\u4f60\u8981\u7684go\u7248\u672c\"\ncurl -Ss https://golang.google.cn/dl/ | sed -n 's/.*class=\"toggle\" id=\"go\\([.0-9]*\\)\"&gt;/\\1/p'| head -20\n    read go_version\n    wget https://golang.google.cn/dl/go${go_version}.${os}-amd64.tar.gz\n    # \u8fd9\u91cc\u6211\u76f4\u63a5\u5220\u9664\u4e86\u65e7\u7684, \u540e\u7eed\u518d\u5b8c\u5584 , \u53ef\u4ee5\u7528 \u8f6f\u94fe\u63a5\u4e4b\u7c7b\u7684.\nrm -rf /usr/local/go &amp;&amp; tar -C /usr/local -xzf go${go_version}.${os}-amd64.tar.gz\n    echo 'export PATH=$PATH:/usr/local/go/bin' &gt;&gt; ~/.zshrc\n    . ~/.zshrc\n    go env -w GOPROXY=https://goproxy.cn,http://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct\n}\ninstall_go\n</code></pre>","tags":["Bash"]},{"location":"linux/monitor/elk/","title":"Elk","text":"<ol> <li> <p>apm-server \u21a9</p> </li> <li> <p>https://github.com/elastic/apm-agent-go \u21a9</p> </li> </ol>"},{"location":"linux/systems-performance/cpu/","title":"Cpu","text":"<pre><code>top\n# \u5404\u4e2a\u8fdb\u7a0b\u7684\u60c5\u51b5\npidstat -u\n</code></pre>"},{"location":"linux/systems-performance/io/","title":"Io","text":"<pre><code>yum install iotop -y\niostat\niotop\n</code></pre>"},{"location":"linux/systems-performance/mem/","title":"Mem","text":"<pre><code>free -h\nvmstat\nvmstat -S M\n# \u5012\u5e8f \u663e\u793a \u5404\u4e2a\u7a0b\u5e8f\u5185\u5b58\u5360\u7528 , -p \u663e\u793a\u767e\u5206\u6bd4\nsmem -rp\nsmem -rk # -k\u663e\u793a \u5185\u5b58\u5355\u4f4d\n</code></pre>"},{"location":"linux/systems-performance/network/","title":"Network","text":"<pre><code>yum install iftop nethogs -y\niftop\n# \u5404\u4e2a\u8fdb\u7a0b\u7684\u60c5\u51b5\nnethogs\n</code></pre>"},{"location":"linux/systems-performance/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%97%AE%E9%A2%98%E9%9B%86%E9%94%A6/","title":"\u670d\u52a1\u5668\u95ee\u9898\u96c6\u9526","text":"","tags":["Linux"]},{"location":"linux/systems-performance/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%97%AE%E9%A2%98%E9%9B%86%E9%94%A6/#_1","title":"\u660e\u660e\u5220\u9664\u4e86\u6587\u4ef6\u78c1\u76d8\u5374\u6ca1\u53d8\u5316","text":"<pre><code># -d \u8868\u793a\u6587\u4ef6\u5939\u6df1\u5ea6\ndu -h / -d 1 #\u770b\u770b\u54ea\u4e9b\u6587\u4ef6\u5939\u5360\u7528\u591a\nlsof|grep deleted  #\u770b\u770b\n</code></pre>","tags":["Linux"]},{"location":"linux/systems-performance/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%97%AE%E9%A2%98%E9%9B%86%E9%94%A6/#mysql","title":"mysql\u5220\u9664\u5927\u91cf\u6570\u636e,\u5bfc\u81f4\u78c1\u76d8\u7206\u70b8","text":"<p>Note</p> <p>\u9996\u5148\u6b63\u5e38\u8bbe\u8ba1\u4e0b\u5c31\u4e0d\u4f1a\u6709\u8fd9\u79cd\u95ee\u9898. \u4e4b\u524d\u516c\u53f8\u5c06\u5927\u91cf\u65e5\u5fd7\u5199\u5230mysql, \u7136\u540e\u78c1\u76d8\u672c\u8eab\u4e5f\u4e0d\u5927,\u5bb9\u91cf\u6ee1\u4e86,\u8981\u6c42\u5220\u9664\u4e00\u4e9b\u65e5\u5fd7  \u76f4\u63a5 <code>delete from</code> \u4f1a\u5bfc\u81f4\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7206\u589e.</p> \u6b63\u786e\u7684\u4e34\u65f6\u64cd\u4f5c<pre><code># sql_log_bin=0 \u4e34\u65f6\u7981\u7528\u4e8c\u8fdb\u5236\u65e5\u5fd7\nset sql_log_bin=0;delete from tbl where ....;\n</code></pre>","tags":["Linux"]},{"location":"linux/systems-performance/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%97%AE%E9%A2%98%E9%9B%86%E9%94%A6/#todo","title":"todo","text":"","tags":["Linux"]},{"location":"network-programming/https/","title":"https\u4e0e\u8bc1\u4e66","text":"","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#http","title":"http\u7684\u95ee\u9898","text":"<p>HTTP \u662f\u660e\u6587\u4f20\u8f93\u7684\u534f\u8bae,\u6570\u636e\u5728\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u4e0d\u52a0\u5bc6, \u5bb9\u6613\u88ab\u7a83\u542c\u7be1\u6539\u548c\u52ab\u6301</p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#_1","title":"\u89e3\u51b3\u65b9\u6848","text":"","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#1","title":"1. \u5bf9\u79f0\u52a0\u5bc6","text":"<p>\u4ec0\u4e48\u662f\u5bf9\u79f0\u52a0\u5bc6</p> <ul> <li>\u80fd\u4f7f\u7528\u540c\u4e00\u4e2a\u5bc6\u94a5\u7528\u6765\u52a0\u5bc6\u548c\u89e3\u5bc6</li> <li>\u8fd9\u4e5f\u662f\u666e\u901a\u4eba\u7acb\u9a6c\u5c31\u53ef\u4ee5\u60f3\u5230\u7684\u65b9\u5f0f</li> <li>\u6211\u6765\u4e3e\u4e2a\u6211\u8bbe\u8ba1\u7684\u7b97\u6cd5:<ul> <li>\u53d1\u9001 hello world, \u52a0\u5bc6\u65b9\u6cd5\u662f \u5c06\u5b57\u7b26\u52a0\u4e0a\u5728\u5355\u8bcd\u4e0a\u7684\u7d22\u5f15*\u5bc6\u94a5,\u8fd9\u91cc\u5bc6\u94a5=1<ol> <li>h \u7d22\u5f15\u662f1 -&gt; h+1=i</li> <li>e \u7d22\u5f15\u662f2 -&gt; e+2=g</li> <li>hello world =&gt; igopt xqupi</li> </ol> </li> <li>\u77e5\u9053\u5bc6\u94a5\u5c31\u53ef\u4ee5\u89e3\u5bc6\u4e86</li> </ul> </li> </ul> <p></p> <p>\u7ed3\u8bba</p> <p>\u52a0\u5bc6\u7b97\u6cd5\u548c\u5bc6\u94a5\u90fd\u53ef\u80fd\u88ab\u62e6\u622a, \u4e0d\u5b89\u5168.</p> <p>Tip</p> <p></p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#2","title":"2. \u975e\u5bf9\u79f0\u52a0\u5bc6","text":"<p>\u975e\u5bf9\u79f0\u52a0\u5bc6</p> <p>\u5b83\u4f7f\u7528\u4e86\u4e00\u5bf9\u5bc6\u94a5\uff0c\u5206\u522b\u662f\u516c\u94a5\uff08Public Key\uff09\u548c\u79c1\u94a5\uff08Private Key\uff09 \u6d4f\u89c8\u5668\u53d1\u9001\u6570\u636e\u65f6\u7528\u516c\u94a5\u5bf9\u6570\u636e\u8fdb\u884c\u52a0\u5bc6, \u670d\u52a1\u7aef\u4f7f\u7528\u914d\u5bf9\u7684\u79c1\u94a5\u5bf9\u6570\u636e\u8fdb\u884c\u89e3\u5bc6 \u670d\u52a1\u7aef\u8fd4\u56de\u6570\u636e\u7ed9\u6d4f\u89c8\u5668\u65f6\u7528\u79c1\u94a5\u8fdb\u884c\u52a0\u5bc6, \u6d4f\u89c8\u5668\u7528\u516c\u94a5\u8fdb\u884c\u89e3\u5bc6 \u52a0\u5bc6\u89e3\u5bc6\u90fd\u76f8\u5bf9\u6bd4\u8f83\u8017\u65f6</p> <p>\u5982\u4f55\u89e3\u51b3\u5bf9\u79f0\u52a0\u5bc6\u4e2d\u5bc6\u94a5\u4f20\u8f93\u5b89\u5168\u95ee\u9898?</p> <ol> <li>\u4f7f\u7528\u975e\u5bf9\u79f0\u52a0\u5bc6\u7b97\u6cd5, \u79c1\u94a5\u653e\u5728\u670d\u52a1\u5668,\u88ab\u62e6\u622a\u9ed1\u5ba2\u4e5f\u65e0\u6cd5\u83b7\u53d6,\u516c\u94a5\u5728\u6d4f\u89c8\u5668</li> <li>\u6d4f\u89c8\u5668\u4f7f\u7528\u516c\u94a5\u52a0\u5bc6<code>\u5bf9\u79f0\u52a0\u5bc6\u7528\u7684\u5bc6\u94a5</code>, \u670d\u52a1\u5668\u4f7f\u7528\u79c1\u94a5\u89e3\u5bc6\u5f97\u5230\u771f\u5b9e\u8fd9\u4e2a<code>\u5bc6\u94a5</code>.</li> <li>\u662f\u4e0d\u662f\u89c9\u5f97\u591a\u6b64\u4e00\u4e3e\u4e86, \u76f4\u63a5\u7528\u975e\u5bf9\u79f0\u52a0\u5bc6\u7b97\u6cd5\u52a0\u5bc6\u6570\u636e\u4e0d\u5c31\u5f97\u4e86??<ol> <li>\u975e\u5bf9\u79f0\u52a0\u5bc6\u89e3\u5bc6\u8017\u65f6, \u6bcf\u6b21\u6570\u636e\u4f20\u8f93\u90fd\u8fd9\u6837 ,\u4f24\u4e0d\u8d77</li> <li>\u5bc6\u94a5\u7531\u670d\u52a1\u5668\u751f\u6210, \u53ea\u751f\u6210\u4e00\u5bf9, \u5982\u679c\u6765\u4e00\u4e2a\u5ba2\u6237\u7aef\u5c31\u751f\u6210\u4e00\u5bf9,\u8fd8\u662f\u8017\u65f6.</li> <li>\u6240\u4ee5\u53ea\u8981\u6d4f\u89c8\u5668\u8bbf\u95ee\u5b83\u5c31\u4f1a\u5f97\u5230\u8fd9\u4e2a\u516c\u94a5, \u9ed1\u5ba2\u4e5f\u80fd\u5f97\u5230, \u5982\u679c\u5b83\u62e6\u622a\u4e86\u670d\u52a1\u5668\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u7684\u6570\u636e,\u53ef\u4ee5\u89e3\u5bc6</li> <li>\u6240\u4ee5\u6211\u4eec\u4f7f\u7528\u7ed3\u54082\u4e2a\u7b97\u6cd5,\u4fdd\u8bc1\u4e00\u5f00\u59cb\u5bf9\u79f0\u52a0\u5bc6\u7684\u5bc6\u94a5(\u76d0)\u4f20\u8f93\u5b89\u5168\u5c31\u884c\u4e86,\u5bf9\u5bf9\u79f0\u52a0\u5bc6\u7684\u5bc6\u94a5\u7528\u516c\u94a5\u52a0\u5bc6,\u9ed1\u5ba2\u622a\u53d6\u6570\u636e,\u56e0\u4e3a\u5b83\u53ea\u6709\u516c\u94a5,\u662f\u65e0\u6cd5\u89e3\u5bc6\u7684</li> <li>\u8fd9\u6837\u670d\u52a1\u7aef\u77e5\u9053\u4e86 \u5bf9\u79f0\u52a0\u5bc6\u7684\u5bc6\u94a5, \u8fd9\u4e4b\u540e\u5c31\u7528\u5bf9\u79f0\u52a0\u5bc6\u7b97\u6cd5\u5bf9\u6570\u636e\u8fdb\u884c\u52a0\u5bc6\u6765\u4f20\u8f93</li> </ol> </li> </ol> <p></p> <p>Question</p> <p>\u4e8b\u60c5\u597d\u50cf\u5b8c\u7f8e\u89e3\u51b3\u4e86,\u771f\u7684\u5b89\u5168\u4e86\u5417?</p> <p>Tip</p> <p></p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#3","title":"3. \u4e2d\u95f4\u4eba\u653b\u51fb","text":"<p>\u524d\u9762\u7684\u95ee\u9898</p> <ol> <li>\u9ed1\u5ba2\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u83b7\u53d6\u670d\u52a1\u5668\u53d1\u9001\u7684\u516c\u94a5\u7684\u9636\u6bb5\u62e6\u622a,\u90a3\u5b83\u53ef\u4ee5\u4f2a\u9020\u6210\u670d\u52a1\u5668,\u4f5c\u4e3a\u4e00\u4e2a\u4e2d\u95f4\u4eba</li> <li>\u6d4f\u89c8\u5668\u53d1\u9001\u5230\u4e86 \u4e2d\u95f4\u4eba, \u4e2d\u95f4\u4eba\u81ea\u5df1\u751f\u6210\u4e00\u5bf9\u516c\u94a5\u79c1\u94a5, \u5b83\u5c06\u81ea\u5df1\u7684\u8fd9\u4e2a\u516c\u94a5\u8fd4\u56de\u7ed9\u6d4f\u89c8\u5668,\u81ea\u5df1\u518d\u5411\u771f\u6b63\u7684\u670d\u52a1\u5668\u53d1\u8d77\u8bf7\u6c42</li> <li>\u6d4f\u89c8\u5668\u5f97\u5230\u4e00\u4e2a\u5047\u7684\u516c\u94a5, \u7136\u540e\u5b83\u53d1\u9001\u7684\u6570\u636e\u5168\u90e8\u88ab\u4e2d\u95f4\u4eba\u622a\u83b7,\u53ef\u4ee5\u89e3\u5bc6...</li> <li>\u95ee\u9898\u7684\u5173\u952e\u662f, \u6d4f\u89c8\u5668\u786e\u4fdd\u5f97\u5230\u670d\u52a1\u7aef\u771f\u6b63\u4e0b\u53d1\u7684\u516c\u94a5</li> </ol> <p>\u5982\u4f55\u89e3\u51b3\u5462?</p> <ol> <li>\u73b0\u5b9e\u7684\u4e00\u4e2a\u4f8b\u5b50<ol> <li>\u5047\u8bbe\u6211\u53bb\u4e00\u5bb6\u67d0\u67d0\u660e\u661f\u5f00\u7684\u5e97\u4e70\u4e1c\u897f, \u6211\u8981\u5148\u786e\u8ba4\u8fd9\u5bb6\u5e97\u662f\u4e0d\u662f\u771f\u7684, \u6211\u4eec\u5c31\u53bb\u770b\u8425\u4e1a\u6267\u7167</li> <li>\u4e00\u770b\u76d6\u7ae0\u662f\u771f\u7684.  \u8fd9\u5c31\u884c\u4e86\u5417?  \u4e00\u4e2a\u4eba\u60f3\u5f00\u4e2a\u5e97 ,\u4ed6\u81ea\u5df1\u53bb\u7533\u8bf7\u8425\u4e1a\u6267\u7167, \u90a3\u8fd9\u4e2a\u7ae0\u4e5f\u662f\u771f\u7684\u554a, \u5149\u770b\u7ae0\u8fd9\u6837\u8fd8\u4e0d\u884c!!!</li> <li>\u90a3\u6211\u770b\u770b\u8425\u4e1a\u6267\u7167\u4e0a\u5199\u7684\u6cd5\u4eba\u662f\u8c01\u4e0d\u5c31\u884c\u4e86\u5417?  \u5bf9!</li> <li>\u5ba1\u6279\u4eba\u5458, \u76d6\u7ae0\u7684\u65f6\u5019\u770b\u8eab\u4efd\u8bc1\u548c\u8138\u5199\u4e0a\u6cd5\u4eba,\u800c\u4e0d\u662f\u8ba9\u7533\u8bf7\u8005\u968f\u4fbf\u5199,\u7136\u540e\u5728\u540d\u5b57\u4e0a\u76d6\u7ae0,\u8fd9\u6837\u6ca1\u6cd5\u7be1\u6539\u4e86.</li> </ol> </li> <li>\u73b0\u5728\u6211\u4eec\u6539\u8fdb\u6211\u4eec\u4e4b\u524d\u7684\u8bbe\u8ba1(\u4ec5\u4ec5\u662f\u81ea\u5df1\u7684\u601d\u8003\u8fc7\u7a0b,\u4e0e\u5b9e\u9645https\u4e0d\u4e00\u6837):<ol> <li>\u670d\u52a1\u7aef\u5c06 \u5b83\u7684\u516c\u94a5 \u53d1\u9001\u7ed9 \u503c\u5f97\u4fe1\u8d56\u7b2c\u4e09\u65b9\u8bc1\u4e66\u9881\u53d1\u673a\u6784CA,CA\u7528\u81ea\u5df1\u7684\u4e00\u5bf9\u5bc6\u94a5\u4e2d\u7684\u79c1\u94a5\u5bf9\u670d\u52a1\u7aef\u516c\u94a5\u8fdb\u884c\u52a0\u5bc6</li> <li>\u670d\u52a1\u7aef \u628a\u4eceCA\u90a3\u91cc\u83b7\u53d6\u7684\u5bc6\u6587\u53d1\u9001\u7ed9\u6d4f\u89c8\u5668, \u6d4f\u89c8\u5668\u7528 CA\u7684\u516c\u94a5\u8fdb\u884c\u89e3\u5bc6.\u8fd9\u91cc\u7684\u5173\u952e\u5c31\u662f\u64cd\u4f5c\u7cfb\u7edf\u5b89\u88c5\u540e\u5c31\u6709\u4e00\u4e9bCA\u7684\u516c\u94a5,\u6240\u4ee5\u6d4f\u89c8\u5668\u65e0\u9700\u901a\u8fc7\u7f51\u7edc\u83b7\u53d6CA\u516c\u94a5,\u8981\u4e0d\u7136\u53c8\u91cd\u590d\u4e4b\u524d\u7684\u95ee\u9898\u4e86.\u53ea\u8981\u6d4f\u89c8\u5668\u80fd\u7528\u8fd9\u4e2aCA\u516c\u94a5\u89e3\u5bc6, \u5c31\u8bf4\u660e\u6570\u636e\u662f\u901a\u8fc7CA\u52a0\u5bc6\u7684.</li> <li>\u90a3\u4e2d\u95f4\u4eba\u5c06\u81ea\u5df1\u7684\u516c\u94a5\u53d1\u9001\u7ed9CA,CA\u7528\u79c1\u94a5\u52a0\u5bc6\u540e\u53d1\u9001\u7ed9\u4e2d\u95f4\u4eba,\u4e2d\u95f4\u4eba\u518d\u8f6c\u53d1\u7ed9\u6d4f\u89c8\u5668,\u8fd9\u4e2a\u65f6\u5019\u6d4f\u89c8\u5668\u662f\u53ef\u4ee5\u89e3\u5bc6\u7684,\u5c31\u4ee5\u4e3a\u662fok\u7684\u4e86! \u4e0d\u884c!!</li> <li>\u90a3CA\u7ed9\u4f60\u516c\u94a5\u52a0\u5bc6\u7684\u65f6\u5019, \u518d\u5e26\u4e0a\u53d1\u8d77\u8bf7\u6c42\u7684\u7f51\u7ad9\u7684\u57df\u540d\u4e0d\u5c31ok\u4e86. \u8fd9\u6837\u5373\u4f7f\u4e2d\u95f4\u4eba\u8bf7\u6c42CA,CA\u52a0\u5bc6\u4f1a\u5e26\u4e0a\u4e2d\u95f4\u4eba\u7684\u57df\u540d, \u6d4f\u89c8\u5668\u89e3\u5bc6\u540e\u53d1\u73b0\u57df\u540d\u4e0d\u662f\u81ea\u5df1\u60f3\u8981\u8bbf\u95ee\u7684\u7f51\u7ad9. \u4e2d\u95f4\u4eba\u5411CA\u7533\u8bf7\u8bc1\u4e66\u65f6,\u4f1a\u9012\u4ea4\u4e2a\u4eba\u4fe1\u606f, CA\u4f1a\u5ba1\u6838\u771f\u5b9e\u6027, \u6240\u4ee5\u4e0d\u4f1a\u8ba9\u5b83\u968f\u4fbf\u5199\u57df\u540d,\u65e0\u6cd5\u5192\u5145\u539f\u6765\u6211\u4eec\u771f\u6b63\u8bf7\u6c42\u7684\u90a3\u4e2a\u670d\u52a1\u5668</li> </ol> </li> </ol> <p>\u95ee\u9898</p> <ol> <li>\u4e2d\u95f4\u4eba\u628a\u81ea\u5df1\u5f53\u6210CA \u505a\u8bc1\u4e66\u53d1\u7ed9\u6d4f\u89c8\u5668\u884c\u5417?<ol> <li>\u8fd9\u6837\u6d4f\u89c8\u5668\u67e5\u770b\u8bc1\u4e66\u9881\u53d1\u673a\u6784, \u5b83\u64cd\u4f5c\u7cfb\u7edf\u5c31\u6ca1\u6709,\u56e0\u4e3a\u53ea\u6709\u5185\u7f6e\u7684\u90a3\u4e9b\u53ef\u9760\u7684, \u6240\u4ee5\u6ca1\u6709\u5bf9\u5e94\u7684\u516c\u94a5\u6765\u89e3\u5bc6</li> <li>\u5f53\u7136\u5982\u679c\u4f60\u7684\u7cfb\u7edf\u88ab\u9ed1\u5ba2\u5b89\u88c5\u4e86\u5b83\u81ea\u5df1\u751f\u6210\u7684\u8bc1\u4e66, \u90a3\u4e48\u6d4f\u89c8\u5668\u5c31\u4f1a\u627e\u5230\u5bf9\u5e94\u7684\u516c\u94a5\u6765\u89e3\u5bc6\u4e86,\u4e0d\u8fc7\u8fd9\u662f\u4f60\u7684\u95ee\u9898</li> </ol> </li> </ol>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#4-https","title":"4. https \u6700\u7ec8\u65b9\u6848","text":"","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#_2","title":"\u8bc1\u4e66\u76f8\u5173","text":"<p>Root CA \u4f1a\u7ed9\u4e8c\u7ea7 CA \u9881\u53d1\u8bc1\u4e66,</p> <p>\u4e00\u822c\u7528\u6237\u7f51\u7ad9\u7684\u8bc1\u4e66 \u7531 \u4e8c\u7ea7CA\u9881\u53d1.</p> <p>\u64cd\u4f5c\u7cfb\u7edf\u9ed8\u8ba4\u5c31\u5b89\u88c5\u4e86\u5f88\u591aRoot CA</p> <p>Tip</p> <p>X.509 \u662f\u4e00\u79cd\u5e38\u7528\u7684\u6570\u5b57\u8bc1\u4e66\u683c\u5f0f\u6807\u51c6,\u5b9a\u4e49\u4e86\u8bc1\u4e66\u7684\u7ed3\u6784\u548c\u5185\u5bb9</p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#openssl","title":"openssl \u76f8\u5173\u64cd\u4f5c","text":"<pre><code># \u79c1\u94a5\n# \u8bb0\u5f97\u6743\u9650\u8bbe\u7f6e600\u6700\u597d\n# \u975e\u5bf9\u79f0\u7b97\u6cd5 \u4f7f\u7528rsa \u751f\u6210\nopenssl genrsa -out server.key 2048\n# \u8868\u793a\u4f1a\u5bf9\u751f\u6210\u7684key \u8fdb\u884c\u4e00\u6b21\u5bf9\u79f0\u52a0\u5bc6, \u4f1a\u63d0\u793a\u4f60\u8f93\u5165\u5bc6\u7801\n# \u4e0d\u8fc7\u4e0d\u63a8\u8350, \u9700\u8981\u4f60\u8f93\u5165\u5bc6\u7801\u89e3\u5bc6.\u9ebb\u70e6\nopenssl genrsa -out server-des.key -des 2048\n# \u4ece\u79c1\u94a5\u63d0\u53d6\u516c\u94a5 ,\u8fd9\u91cc\u8981\u5bf9\u5e94\u7684\u7b97\u6cd5, rsa\nopenssl rsa -in server.key -pubout -out server.pub\n# \u4f1a\u63d0\u793a\u4f60\u8f93\u5165\u5bc6\u7801,\u624d\u80fd\u63d0\u53d6\u516c\u94a5\nopenssl rsa -in server-des.key -pubout -out server-des.pub\n# \u5c06\u52a0\u5bc6\u8fc7\u7684\u79c1\u94a5 \u8f6c\u6362\u4e3a \u4e0d\u52a0\u5bc6\u7684\nopenssl rsa -in server-des.key -out server-des-remove.key\n\necho 123 &gt; tmp.txt\n# \u4f7f\u7528\u516c\u94a5\u52a0\u5bc6\nopenssl rsautl -encrypt -in  tmp.txt -inkey server.pub -pubin -out tmp.txt.encry\n\n# \u4f7f\u7528\u79c1\u94a5\u89e3\u5bc6\n# \u8f93\u51fa\u5230\u6587\u4ef6\nopenssl rsautl -decrypt -in  tmp.txt.encry -inkey server.key  -out tmp.txt.dencry\n# \u76f4\u63a5\u8f93\u51fa\u89e3\u5bc6\u540e\u7684\u5185\u5bb9\nopenssl rsautl -decrypt -in  tmp.txt.encry -inkey server.key\n\n# \u4f7f\u7528\u79c1\u94a5\u52a0\u5bc6(\u7b7e\u540d)\nopenssl rsautl -sign -in  tmp.txt -inkey server.key  -out tmp.txt.sign\n# \u4f7f\u7528\u516c\u94a5\u89e3\u5bc6(\u9a8c\u7b7e)\nopenssl rsautl -verify -in  tmp.txt.sign -inkey server.pub -pubin\n</code></pre>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#ca","title":"\u6a21\u62dfCA\u9881\u53d1\u8bc1\u4e66","text":"<p>Important</p> <p>\u6ce8\u610f\u8fd9\u91cc\u662f\u6211\u4eec\u6a21\u62dfCA\u673a\u6784, \u6240\u4ee5\u6b65\u9aa4\u5f88\u591a, \u5982\u679c\u53ea\u662f\u7b80\u5355\u7684\u4e3a\u6211\u4eec\u670d\u52a1\u5668\u751f\u6210\u4e00\u4e2a\u8bc1\u4e66, \u4e0d\u9700\u8981\u8fd9\u6837,\u89c1\u5feb\u901f\u81ea\u7b7e\u540d\u8bc1\u4e66</p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#1ca","title":"1.\u914d\u7f6eCA","text":"<p><pre><code>openssl ca # \u4f1a\u770b\u5230\u914d\u7f6e\u6587\u4ef6\n</code></pre> /etc/pki/tls/openssl.cnf<pre><code>[ ca ]\ndefault_ca      = CA_default    #\u9ed8\u8ba4CA\u7684\u8bbe\u7f6e\u662f\u54ea\u4e2a,  \u4e0b\u9762\u90a3\u4e2a\u914d\u7f6e\u5c31\u662f\u4e86.\n####################################################################\n[ CA_default ]\ndir             = /etc/pki/CA           # \ncerts           = $dir/certs            # \u53d1\u5e03\u7684\u8bc1\u4e66\u653e\u8fd9\u4e2a\u76ee\u5f55\ncrl_dir         = $dir/crl              # \u8bc1\u4e66\u540a\u9500\u5217\u8868\u5b58\u653e\u76ee\u5f55\ndatabase        = $dir/index.txt        # \u9881\u53d1\u7ed9\u8c01\u7b49\u7b49\u4fe1\u606f\u6570\u636e\u7684\u7d22\u5f15\n#unique_subject = no                    # \u9ed8\u8ba4\u662fyes ,\u8868\u793a \u8bc1\u4e66\u7533\u8bf7\u8005\u4e3b\u4f53 \u552f\u4e00, \u4e0d\u80fd\u7528\u540c\u4e00\u4e2acsr\u7533\u8bf7\u591a\u4e2a\u8bc1\u4e66\nnew_certs_dir   = $dir/newcerts         # \u65b0\u9881\u53d1\u7684\u8bc1\u4e66\u5b58\u653e\u76ee\u5f55,\u5f53\u7136\u4e0a\u9762\u7684certs \u4e5f\u4f1a\u6709\u65b0\u9881\u53d1\u7684\u8bc1\u4e66\u5b58\u653e\ncertificate     = $dir/cacert.pem       # CA\u7684\u8bc1\u4e66 (\u6211\u4eec\u81ea\u5df1\u6d4b\u8bd5\u5c31\u4e00\u4e2aRoot CA\u5c31\u884c)\nserial          = $dir/serial           # \u6bcf\u4e2a\u8bc1\u4e66\u90fd\u6709\u7f16\u53f7, \u8fd9\u91cc\u662f\u4e0b\u4e00\u4e2a\u8981\u9881\u53d1\u7684\u8bc1\u4e66\u7684\u7f16\u53f7\ncrlnumber       = $dir/crlnumber        # \u540a\u9500\u7684\u7f16\u53f7,\u540c\u4e0a\ncrl             = $dir/crl.pem          # \u5305\u542b\u4e4b\u524d\u6240\u6709\u540a\u9500\u8bc1\u4e66\u7684\u5217\u8868\nprivate_key     = $dir/private/cakey.pem# CA\u7684\u79c1\u94a5\nRANDFILE        = $dir/private/.rand    # private random number file\nx509_extensions = usr_cert              # The extentions to add to the cert\nname_opt        = ca_default            # Subject Name options\ncert_opt        = ca_default            # Certificate field options\ndefault_days    = 365                   # \u8bc1\u4e66\u9ed8\u8ba4\u6709\u6548\u671f \u5929 ,\u53ef\u4ee5\u6539\u62103650\ndefault_crl_days= 30                    # how long before next CRL\ndefault_md      = sha256                # use SHA-256 by default\npreserve        = no                    # keep passed DN ordering\npolicy          = policy_match #\u5339\u914d\u4e0b\u9762\u7684 \u8868\u793a\u4f7f\u7528\u8fd9\u4e2a\u5b89\u5168\u7b56\u7565\n[ policy_match ] # \u4f60\u5728\u751f\u6210\u8bc1\u4e66\u7684\u65f6\u5019\u4f1a\u63d0\u793a\u4f60\u8f93\u5165\u8fd9\u4e9b\u4fe1\u606f\n# match \u8868\u793a\u5c06\u6765\u4f60\u7528\u6237\u7f51\u7ad9\u7533\u8bf7\u8bc1\u4e66\u65f6\u586b\u5199\u4e1c\u897f\u5fc5\u987b\u4e0eCA\u7684\u4e00\u81f4\n# \u4e5f\u5c31\u662f\u8bf4\u4f60\u7f51\u7ad9\u7533\u8bf7\u65f6 \u56fd\u5bb6 \u90e8\u95e8,\u516c\u53f8\u5fc5\u987b\u548cCA\u7684\u4e00\u81f4\n# \u6211\u4eec\u81ea\u5df1 \u5185\u90e8\u7528, \u53ef\u4ee5\u7528\u8fd9\u4e2a\u7b56\u7565\u6765\ncountryName             = match\nstateOrProvinceName     = match # \u5dde\u540d\u6216\u7701\u4efd\u540d\u79f0\uff0c\u53ef\u4ee5\u662f\u4e2d\u6587\u6216\u82f1\u6587\norganizationName        = match   # \u516c\u53f8\u540d\u79f0\uff0c\u53ef\u4ee5\u662f\u4e2d\u6587\u6216\u82f1\u6587\norganizationalUnitName  = optional # \u90e8\u95e8\u540d\u79f0\uff0c\u53ef\u4ee5\u662f\u4e2d\u6587\u6216\u82f1\u6587\ncommonName              = supplied #\u5fc5\u987b\u8f93\u5165 \u7533\u8bf7 SSL \u8bc1\u4e66\u7684\u5177\u4f53\u7f51\u7ad9\u57df\u540d\nemailAddress            = optional # optional \u53ef\u5199\u53ef\u4e0d\u5199\n[ policy_anything ] # \u4f60\u53ef\u4ee5\u9009\u62e9\u8fd9\u4e2a\u7b56\u7565\ncountryName             = optional\nstateOrProvinceName     = optional\nlocalityName            = optional\norganizationName        = optional\norganizationalUnitName  = optional\ncommonName              = supplied\nemailAddress            = optional\n</code></pre></p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#2ca","title":"2.CA\u751f\u6210\u6839\u8bc1\u4e66","text":"<pre><code># \u6a21\u62dfCA,\u672c\u5730\u81ea\u5b9a\u4e49CA,\u6211\u4eec\u5047\u8bbe\u5728\u4e00\u53f0\u670d\u52a1\u5668\u4e0a \u662f\u4e13\u95e8\u5f04CA\u7684\n/etc/pki/CA\n\u251c\u2500\u2500 certs\n\u251c\u2500\u2500 crl\n\u251c\u2500\u2500 newcerts\n\u2514\u2500\u2500 private\ncd /etc/pki/CA\ntouch index.txt\n# 16\u8fdb\u5236\necho 01 &gt; serial\n# \u751f\u6210CA\u7684\u79c1\u94a5\nopenssl genrsa -out ./private/cakey.pem 2048\n# \u751f\u6210CA\u81ea\u7b7e\u540d\u8bc1\u4e66 cacert.pem\n# x509\u8868\u793a\u8f93\u51fa\u8fd9\u79cd\u683c\u5f0f\u7684\u8bc1\u4e66\nopenssl req -x509 -new -key ./private/cakey.pem  \\\n-days 5000 \\\n-out cacert.pem\n    # \u76f4\u63a5\u6307\u5b9a\nopenssl req -x509 -new -key ./private/cakey.pem \\\n-subj \"/CN=example1.com/C=CN/O=taobao/ST=BJ\" \\\n-days 5000 \\\n-out cacert.pem\n\n# \u9a8c\u7b7e, \u7528\u9881\u53d1\u8bc1\u4e66\u7684 x \u53bb\u9a8c\u8bc1 \u88ab\u7b7e\u53d1\u7684 y\nopenssl verify -CAfile cacert.pem cacert.pem\n# \u67e5\u770b\u8bc1\u4e66\u5185\u5bb9, \u5982\u679c\u76f4\u63a5\u7528base64 -d \u89e3\u7801\u4f1a\u770b\u5230\u4e00\u4e9b\u4e71\u7801.\n#  \u4e5f\u53ef\u4ee5\u5c06\u8fd9\u4e2a\u6587\u4ef6 \u6253\u5f00 (\u5728mac\u6216windows\u4e0a \u4f1a\u7528\u9ed8\u8ba4\u7684\u7a0b\u5e8f\u6253\u5f00,\u53ef\u4ee5\u770b\u5230\u76f8\u5173\u4fe1\u606f)\nopenssl x509 -in cacert.pem -noout -text  #(1)\n</code></pre> <ol> <li>\u56e0\u4e3a\u6211\u4eec\u7684\u914d\u7f6e\u6587\u4ef6\u91cc\u6709 x509_extensions = v3_ca     The extentions to add to the self signed cert     \u6240\u4ee5\u8fd9\u4e9b\u76f8\u5e94\u7684\u4f1a\u5728\u81ea\u7b7e\u540d\u8bc1\u4e66\u91cc\u6dfb\u52a0<pre><code>[ v3_ca ]\nsubjectKeyIdentifier=hash\nauthorityKeyIdentifier=keyid:always,issuer\nbasicConstraints = CA:true\n</code></pre> <pre><code>Certificate:\nData:\nVersion: 3 (0x2)\nSerial Number:\nee:e1:85:de:8f:2a:00:76\nSignature Algorithm: sha256WithRSAEncryption\n# \u8bc1\u4e66\u9881\u53d1\u8005\nIssuer: C=XX, L=Default City, O=Default Company Ltd, CN=example1.com\nValidity\nNot Before: Aug  1 16:51:52 2023 GMT\nNot After : Apr  9 16:51:52 2037 GMT\n# \u8bc1\u4e66\u7533\u8bf7\u8005, \u9881\u53d1\u7ed9\u8c01 ,\u8fd9\u91cc\u548c \u9881\u53d1\u8005\u4e00\u6837, \u81ea\u7b7e\u540d\nSubject: C=XX, L=Default City, O=Default Company Ltd, CN=example1.com\nSubject Public Key Info:\nPublic Key Algorithm: rsaEncryption\nPublic-Key: (2048 bit)\nModulus:\n00:98:ad:ff:cc:a1:2d:2c:24:30:d4:87:14:02:06:\n0f:50:60:ec:b2:0c:19:09:7c:96:74:82:46:c0:a3:\nbc:86:77:7e:b2:fb:9e:a1:4f:fd:2b:3a:02:20:2b:\na1:94:d4:49:62:ce:36:1f:80:a8:71:fb:1e:3f:e3:\n90:d3:78:f7:74:86:4f:3b:8c:85:d1:ae:4f:26:23:\n15:29:f0:ed:0f:ee:a7:08:f5:3c:70:f2:b5:1c:f1:\n71:e1:73:79:85:9d:11:64:2f:84:29:93:5b:df:d7:\na2:32:19:fe:c4:72:70:a9:d1:b3:54:22:6e:77:27:\n2d:43:ec:5c:06:6a:7b:65:07:a9:ba:9a:35:db:2a:\n7c:6f:f5:d6:27:59:15:d5:40:d3:94:dc:4c:7d:25:\n8e:a3:3d:23:d1:5b:4e:6a:35:cf:ee:b4:0f:59:ec:\n65:bb:b6:75:21:c5:6d:dd:a6:87:a7:15:af:bb:e1:\na5:75:6c:6c:36:da:60:13:41:f3:a8:11:b1:3f:8f:\nbd:d4:03:c7:e0:f5:2f:68:76:7f:d0:67:45:eb:48:\n8a:ad:70:34:3f:6b:fa:fc:bb:83:4f:e8:a0:3c:5c:\n77:b5:c6:10:e0:b3:a8:fc:66:8c:56:e8:9d:64:6e:\n8c:fe:42:65:02:c5:1d:81:66:e4:60:f2:5b:6d:e1:\ncc:cb\nExponent: 65537 (0x10001)\nX509v3 extensions:\nX509v3 Subject Key Identifier:\n3C:CE:32:F7:55:76:EB:E7:4D:CF:10:26:F0:35:D2:24:3B:89:6B:94\nX509v3 Authority Key Identifier:\nkeyid:3C:CE:32:F7:55:76:EB:E7:4D:CF:10:26:F0:35:D2:24:3B:89:6B:94\nX509v3 Basic Constraints:\nCA:TRUE\nSignature Algorithm: sha256WithRSAEncryption\n49:b0:f1:1b:58:06:be:02:e7:8a:7e:f0:59:d1:96:22:9f:62:\nba:e0:a3:09:5c:56:b3:2b:8c:a4:9d:6b:4f:dc:ea:af:39:b1:\n05:01:78:ed:7d:c6:84:59:3b:a6:d4:c4:5f:ae:d9:d3:82:80:\nbe:41:e0:c5:ae:ff:40:89:c5:2a:bd:f3:5b:20:c6:c5:59:6d:\n32:3c:19:b2:9b:4d:7f:c3:ef:a1:ab:51:6e:19:b7:88:45:91:\nef:ab:e7:c9:bd:c0:ca:c0:fa:48:58:cf:a0:e3:d2:bb:41:e8:\n60:da:6b:0b:1f:91:fa:cb:08:9c:4f:4e:05:3b:80:2a:ad:63:\nb1:75:c1:57:1a:08:27:a2:d6:06:52:00:d4:d2:41:3a:ad:27:\n11:67:ba:de:85:57:24:d5:cf:77:d7:b7:a7:8a:9e:c2:29:e4:\n41:ce:4a:37:8f:db:14:50:32:60:80:9a:92:f1:76:7e:73:80:\n37:cc:6c:fb:ca:82:02:8b:8f:62:5c:91:b1:0a:ad:72:57:e0:\n6d:a1:12:0b:c7:86:ef:9f:47:35:52:96:65:e0:cf:b2:65:d5:\n45:a1:8f:db:12:2a:e8:ae:c6:f3:08:97:b5:1a:7a:4c:f9:92:\n30:bd:ce:28:94:84:a9:67:f4:d5:2a:87:cc:da:6e:4c:ad:a6:\n18:39:d5:32\n</code></pre></li> </ol>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#3_1","title":"3.\u7528\u6237\u670d\u52a1\u5668\u63d0\u4ea4\u7533\u8bf7","text":"<pre><code># \u73b0\u5728\u626e\u6f14 \u7528\u6237\u7f51\u7ad9\u7533\u8bf7\u8bc1\u4e66, \u5047\u5b9a\u5728\u53e6\u5916\u4e00\u53f0\u670d\u52a1\u5668\n# \u5148\u521b\u5efa\u7f51\u7ad9\u7684\u79c1\u94a5\nopenssl genrsa -out server.key 2048\n# \u76f4\u63a5\u521b\u5efa\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42csr\u6587\u4ef6\n# \u6ce8\u610f \u7531\u4e8e\u6211\u4eec\u914d\u7f6e\u4e86 policy_match ,\u6240\u4ee5\u51e0\u4e2a \u9700\u8981\u548cCA\u7684\u4e00\u81f4\n# \u6307\u5b9a server.key \u662f\u56e0\u4e3acsr\u4fe1\u606f \u9700\u8981\u5305\u542b\u670d\u52a1\u7aef\u7684\u516c\u94a5,\u516c\u94a5\u53ef\u4ee5\u4ece\u79c1\u94a5\u63d0\u53d6.\n#  \u8bf4\u660e\u8fd9\u4e9b\u662f\u60f3\u8bf4 \u5199\u7684\u65f6\u5019 \u77e5\u9053\u4e3a\u5565\u9700\u8981\u8fd9\u4e9b\u53c2\u6570\nopenssl req -new -key server.key -subj \"/CN=example1.com/C=CN/O=taobao/ST=BJ\" -out server.csr\n\n# \u67e5\u770b\u4e00\u4e0bcsr\nopenssl req -in server.csr -text -noout\n# \u5c06\u5b83 \u53d1\u9001\u7ed9 CA\u670d\u52a1\u5668\n</code></pre>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#4ca","title":"4.CA\u6839\u636e\u7533\u8bf7\u751f\u6210\u8bc1\u4e66","text":"<pre><code># \u53ef\u4ee5\u6307\u5b9a -policy ,\u8fd9\u6837\u4e0d\u7528\u4e0eca \u67d0\u4e9b\u4e00\u81f4\n# openssl ca -in server.csr -policy policy_anything -out certs/server.crt -days 3650\n# \u56de\u5230 CA \u7684\u670d\u52a1\u5668 ,\u62ff\u5230 \u7528\u6237\u7f51\u7ad9\u7684csr\u6587\u4ef6, \u7b7e\u7f72\u751f\u6210\u8bc1\u4e66,\u6700\u540e\u4f60\u53d1\u9001\u7ed9\u7533\u8bf7\u8005\nopenssl ca -in server.csr  -out certs/server.crt -days 3650 #(1)\n/etc/pki/CA\n\u251c\u2500\u2500 newcerts # \u8fd9\u4e2a\u76ee\u5f55\u4e0b\u4f1a\u81ea\u52a8\u6709\u8fd9\u6b21\u9881\u53d1\u7684\u8bc1\u4e66\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 01.pem # \u91cc\u9762\u7684\u5185\u5bb9\u66f4\u591a, \u4f1a\u589e\u52a0\u89e3\u7801\u540e\u7684\u5185\u5bb9\n# \u9a8c\u7b7e\nopenssl verify -CAfile cacert.pem certs/server.crt\n\n# \u67e5\u770b\u8bc1\u4e66, \u67e5\u770b\u90e8\u5206\u5185\u5bb9, -text \u4f1a\u663e\u793a\u6240\u6709 -issuer  \u9881\u53d1\u8005 -dates \u6709\u6548\u671f\nopenssl x509 -in certs/server.crt -noout -subject -issuer -dates\n# \u67e5\u770b\u8bc1\u4e66\u72b6\u6001,\u9a8c\u8bc1\u6709\u6548\u4e0e\u5426  01 \u662fserial \u8bc1\u4e66\u7f16\u53f7\nopenssl ca -status 01\n# \u9ed8\u8ba4\u4e0d\u80fd\u4f7f\u7528\u540c\u4e00\u4e2acsr \u7533\u8bf7 \u53e6\u5916\u4e00\u4e2a\u8bc1\u4e66, \u4e0d\u8fc7\u53ef\u4ee5\u4fee\u6539 \u4f7f\u5b83\u53ef\u4ee5\n# \u9664\u4e86 \u524d\u9762\u7684\u914d\u7f6e\u6587\u4ef6, \u6211\u4eec\u53ef\u4ee5 \u4fee\u6539 index.txt.attr\nunique_subject = yes # \u6539\u6210no \u5c31\u53ef\u4ee5\n</code></pre> <ol> <li>\u63d0\u793a\u4fe1\u606f     <pre><code>...\nSerial Number: 1 (0x1) # \u53ef\u4ee5\u770b\u5230\u7f16\u53f7\nSign the certificate? [y/n]:  # \u63d0\u793a\u8981\u7b7e\u540d\u4e86\n1 out of 1 certificate requests certified, commit? [y/n]y\nWrite out database with 1 new entries\nData Base Updated\n</code></pre></li> </ol>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#5","title":"5.\u5ba2\u6237\u7aef\u5b89\u88c5\u8bc1\u4e66","text":"<ol> <li>\u5ba2\u6237\u7aef(\u6d4f\u89c8\u5668\u7684\u7cfb\u7edf) \u9700\u8981\u5b89\u88c5 \u4e0a\u9762\u521b\u5efa\u7684\u6839\u8bc1\u4e66 cacert.pem,\u8fd9\u6837\u4f60\u64cd\u4f5c\u7cfb\u7edf\u5c31\u6709\u4e86CA\u7684\u516c\u94a5\u4e86,\u5c31\u597d\u50cf\u7cfb\u7edf\u5b89\u88c5\u540e\u9ed8\u8ba4\u7684\u90a3\u4e9bRoot CA\u4e00\u6837  </li> <li>\u8bbf\u95ee golang web https\u670d\u52a1 https://example1.com, \u4f1a\u63d0\u793a\u4f60\u5b89\u88c5\u8bc1\u4e66 <pre><code>tree\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 main.go\n\u251c\u2500\u2500 pki\n\u2502   \u251c\u2500\u2500 server.crt # \u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684\n\u2502   \u251c\u2500\u2500 server.key # \u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684\n</code></pre> <pre><code>package main\nimport (\n\"fmt\"\n\"log\"\n\"net/http\"\n)\nfunc main() {\nhttp.HandleFunc(\"/\", handler)\nlog.Fatal(http.ListenAndServeTLS(\":443\", \"./pki/server.crt\", \"./pki/server.key\", nil))\n}\nfunc handler(w http.ResponseWriter, r *http.Request) {\nfmt.Fprintln(w, \"Hello, HTTPS!\")\n}\n</code></pre> <pre><code>go run main.go\n</code></pre> /etc/hosts<pre><code>192.168.1.100 example1.com\n</code></pre> <pre><code># \u5c06server.crt \u53d1\u9001\u5230\u5176\u4ed6\u673a\u5668, \u53ef\u4ee5\u5728\u8fd9\u6837\u7684\u673a\u5668\u4e0a curl\ncurl --cacert server.crt --resolve example1.com:443:192.168.1.104 https://example1.com/\nHello, HTTPS!\n</code></pre></li> </ol> <p>chrome/edge \u6d4f\u89c8\u5668\u95ee\u9898</p> <ol> <li>\u8bbf\u95ee\u7f51\u9875\u4f1a\u63d0\u793a\u4f60 Subject Alternative Name Missing</li> <li>\u63d0\u793a net: cert_invalid</li> </ol> CA\u89e3\u51b3\u6b65\u9aa4\u7b80\u5355\u5feb\u901f\u81ea\u7b7e\u540d\u65b9\u6cd5 <p>/etc/pki/tls/openssl.cnf \u6dfb\u52a0<pre><code># \u8fd9\u4e2a\u8868\u793a\u6dfb\u52a0\u5230\u8bc1\u4e66\u8bf7\u6c42\u91cc\u7684\u914d\u7f6e\nreq_extensions = v3_req # The extensions to add to a certificate request\n[ v3_req ]\nbasicConstraints = CA:FALSE\nkeyUsage = nonRepudiation, digitalSignature, keyEncipherment\nsubjectAltName = @alt_names # \u6dfb\u52a0\u8fd9\u884c\n[alt_names]  # \u6dfb\u52a0\nDNS.1   = example1.com # \u6dfb\u52a0\u6211\u4eec\u8bbf\u95ee\u7684\u57df\u540d\n</code></pre> \u751f\u6210\u8bc1\u4e66\u7b49\u6b65\u9aa4\u7a0d\u4f5c\u53d8\u66f4<pre><code>openssl genrsa -out ./private/cakey.pem 2048\n# \u6839\u8bc1\u4e66 -extensions v3_req \u9700\u8981\u663e\u5f0f\u6307\u5b9a\nopenssl req -x509 -new -key ./private/cakey.pem \\\n-subj \"/CN=example1.com/C=CN/O=taobao/ST=BJ\" \\\n-extensions v3_req -days 5000 \\\n-out cacert.pem\n\nopenssl genrsa -out server.key 2048\n# csr  \u9ed8\u8ba4\u5c31\u4f1a\u5e94\u7528\u914d\u7f6e\u91cc\u7684 req_extensions = v3_req ,\u56e0\u4e3a\u5c31\u662freq \u751f\u6210csr \u8bf7\u6c42\u6587\u4ef6 \u7684\u64cd\u4f5c\n# \u5982\u679c\u524d\u9762\u7684 req_extensions = v3_req \u88ab\u6ce8\u91ca\u4e86, \u5219\u9700\u8981 \u663e\u5f0f\u6307\u5b9a-extensions v3_req\nopenssl req -new -key server.key -subj \"/CN=example1.com/C=CN/O=taobao/ST=BJ\" -out server.csr\n# \u751f\u6210\u8bc1\u4e66\n# \u5982\u679c\u4e0d\u6307\u5b9a -extensions v3_req \u5219\u4f1a\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u91cc  user_cert \u6307\u5b9a\u7684\u914d\u7f6e.\n# x509_extensions = usr_cert  # The extentions to add to the cert\n# [ usr_cert ]\n# These extensions are added when 'ca' signs a request.\nopenssl ca -in server.csr -extensions v3_req  -out /etc/pki/CA/certs/server.crt -days 3650\n# \u67e5\u770b\u4e00\u4e0b, \u4f1a\u770b\u5230\u7248\u672c\u662f3 \u7b49\u4fe1\u606f\n</code></pre></p> <pre><code>openssl genrsa -out server.key 2048\n# \u5b9e\u9645\u4e0a\u5c31\u662f\u4f7f\u7528\u4e34\u65f6\u7684openssl.cnf (\u591a\u5305\u542b\u4e86\u6211\u4eec\u8bbe\u7f6e\u7684[SAN] \u6269\u5c55,\u540d\u5b57\u968f\u4fbf\u8d77, -extensions \u6307\u5b9a\u5c31\u884c)\n# \u751f\u6210\u7684 server.crt \u91cc  X509v3 extensions: \u5c31\u53ea\u4f1a\u6709 subjectAltName\nopenssl req -x509 -new \\\n-key server.key \\\n-subj \"/CN=example1.com/C=CN/O=taobao/ST=BJ\" \\\n-extensions SAN \\\n-config &lt;(cat /etc/pki/tls/openssl.cnf &lt;(echo [SAN];echo subjectAltName=DNS.1:example1.com)) \\\n-days 1000 \\\n-out server.crt\n</code></pre> <p>\u6700\u540e\u597d\u50cf\u9664\u4e86ca\u6839\u8bc1\u4e66\u5b89\u88c5, \u7f51\u7ad9\u670d\u52a1\u5668\u7684\u8bc1\u4e66\u8fd8\u662f\u8981\u624b\u52a8\u5b89\u88c5?</p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#99","title":"99.\u540a\u9500\u8bc1\u4e66","text":"<pre><code># \u540a\u9500\u8bc1\u4e66, \u6307\u5b9a\u8bc1\u4e66\u8def\u5f84\u5373\u53ef, \u7ed3\u679c\u770b index.txt  \u8bc1\u4e66\u72b6\u6001\u53d8\u6210 R \u8868\u793arevoke\nopenssl ca -revoke  newcerts/01.pem\n# \u66f4\u65b0\u540a\u9500\u5217\u8868\n# \u6307\u5b9a\u8981\u540a\u9500\u7684\u8bc1\u4e66\u7f16\u53f7,\u7b2c\u4e00\u6b21\u9700\u8981\u8fd9\u6837,\necho 01 &gt; /etc/pki/CA/crlnumber\nopenssl ca -gencrl -out /etc/pki/CA/crl.pem\n# \u67e5\u770b\u540a\u9500\u5217\u8868\nopenssl crl -in /etc/pki/CA/crl.pem -noout -text\n</code></pre>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#_3","title":"\u5feb\u901f\u751f\u6210\u8bc1\u4e66","text":"<p>Tip</p> <p>\u4e0d\u7528\u6a21\u62dfca\u90a3\u6837</p> <pre><code># \u4e0d\u9700\u8981ca\u6839\u8bc1\u4e66\u7684, \u81ea\u7b7e\u540d\u8bc1\u4e66, \u81ea\u5df1\u7ed9\u81ea\u5df1\u7b7e\u540d,\n# \u5ba2\u6237\u7aef\u76f4\u63a5\u5b89\u88c5\u8fd9\u4e2a,\u91cc\u9762\u6709\u516c\u94a5,\u7136\u540e\u670d\u52a1\u7aef\u4e5f\u662f\u53d1\u9001\u8fd9\u4e2a\u8bc1\u4e66\n# \u5ba2\u6237\u7aef\u53d1\u9001\u64cd\u4f5c\u7cfb\u7edf\u6709\u8fd9\u4e2a\u8bc1\u4e66\u7684\u9881\u53d1\u673a\u6784, \u5176\u5b9e\u5c31\u662f\u5b83\u81ea\u5df1\nopenssl genrsa -out server.key 2048\nopenssl req -x509 -new -key server.key -subj \"/CN=example1.com/C=CN/O=taobao/ST=BJ\" -days 5000 -out server.crt\n\n# centos 7\u6709\u81ea\u5e26\u7684Makefile\ncd /etc/pki/tls/certs/\nmake # \u4f1a\u63d0\u793a\u4f7f\u7528\u65b9\u6cd5\n# \u9700\u8981\u6839\u8bc1\u4e66\u7684\n# \u6839 \u79c1\u94a5\nopenssl genrsa  -out ca.key 2048\n# \u6839\u8bc1\u4e66\nopenssl req -x509 -nodes -new -key ca.key -subj \"/CN=example1.com/C=CN/O=tb/ST=BJ\" -days 5000 -out ca.crt\n# \u670d\u52a1\u5668 \u79c1\u94a5\nopenssl genrsa -out server.key 2048\n# csr\nopenssl req -new -key server.key -subj \"/CN=example1.com/C=CN/O=tb/ST=BJ\" -out server.csr\n# \u4e4b\u524d\u7684\u8fd9\u4e2a\u64cd\u4f5c,\u4f1a\u53bb\u627e\u914d\u7f6e\u4e2d\u7684 ca\u79c1\u94a5\n# openssl ca -in server.csr  -out server.crt -days 3650\n# \u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u6307\u5b9a  -CAcreateserial \u52a0\u4e0a\u8fd9\u4e2a\u8868\u793a\u4f1a\u521b\u5efa\u7f16\u53f7\u6587\u4ef6 ca.srl\n# -extfile        - configuration file with X509V3 extensions to add\n# -extensions     - section from config file with X509V3 extensions to add\n# \u524d\u9762\u6211\u4eec\u63d0\u5230chrome \u63d0\u793a\u6709\u95ee\u9898, \u5e94\u8be5 \u53ea\u8981\u670d\u52a1\u5668\u8bc1\u4e66 \u8bbe\u7f6e subjectAltName \u5c31\u884c\u4e86.\n# \u6307\u5b9aca.crt \u90a3\u662f\u56e0\u4e3a \u751f\u6210\u7684\u8bc1\u4e66\u9700\u8981\u9881\u53d1\u673a\u6784\u7684\u4fe1\u606f.\nopenssl x509 -req -CA ca.crt \\\n-CAkey ca.key -CAcreateserial \\\n-in server.csr -out server.crt \\\n-extensions v3_req \\\n-extfile &lt;(cat /etc/pki/tls/openssl.cnf &lt;(cat &lt;&lt;EOF\n[ v3_req ]\nbasicConstraints = CA:FALSE\nkeyUsage = nonRepudiation, digitalSignature, keyEncipherment\nsubjectAltName = @alt_names\n[alt_names]\nDNS.1 = example1.com\nEOF\n))\n# \u67e5\u770b\nopenssl x509 -in server.crt -noout -text #(1)\n</code></pre> <ol> <li> <p>\u6269\u5c55\u7684\u4e00\u4e9b\u4fe1\u606f</p> <pre><code>X509v3 extensions:\nX509v3 Basic Constraints:\nCA:FALSE\nX509v3 Key Usage:\nDigital Signature, Non Repudiation, Key Encipherment\nX509v3 Subject Alternative Name:\nDNS:example1.com\n</code></pre> </li> </ol>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#_4","title":"\u5173\u4e8e\u8bc1\u4e66\u7684\u603b\u7ed3","text":"<p>Tip</p> <p>\u5ba2\u6237\u7aef\u5b89\u88c5\u6839\u8bc1\u4e66(\u81ea\u7b7e\u540d\u8bc1\u4e66\u4e5f\u4e00\u6837)\u662f\u4e3a\u4e86\u89e3\u5bc6\u670d\u52a1\u7aef\u4f20\u8fc7\u6765\u7684\u8bc1\u4e66\u5185\u5bb9,\u4ee5\u83b7\u53d6\u670d\u52a1\u7aef\u7684\u516c\u94a5, \u7136\u540e\u4f7f\u7528\u516c\u94a5\u52a0\u5bc6\u968f\u673a\u5bc6\u94a5(\u7528\u6765\u5bf9\u79f0\u52a0\u5bc6\u7528),\u5c06\u8fd9\u5bc6\u94a5\u5b89\u5168\u53d1\u9001\u7ed9\u670d\u52a1\u7aef,\u6700\u540e\u7528\u8fd9\u4e2a\u5bc6\u94a5\u52a0\u5bc6\u4f20\u8f93\u7684\u6570\u636e,\u4ee5\u8fbe\u5230\u5b89\u5168\u7684\u76ee\u7684</p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#https","title":"\u6293\u5305\u5206\u6790https","text":"<p>Note</p> <p>go web\u7a0b\u5e8f\u5728\u865a\u62df\u673a\u4e2d, \u5728\u5bbf\u4e3b\u673a\u6d4f\u89c8\u5668\u8bbf\u95ee</p> \u865a\u62df\u673a\u4e2d\u8fd0\u884c<pre><code>go run main.go\n# \u6293\u5305\ntcpdump -i eth1 -nn -X -S  tcp port 443 -w go.pcap\n</code></pre> <p>\u5bbf\u4e3b\u673a\u4e2d\u7528safari\u8bbf\u95ee https://example1.com, \u7b49\u4e00\u6bb5\u65f6\u95f4,\u5c06\u865a\u62df\u673a\u4e2d\u7684\u6293\u53d6\u7684\u5305go.pcap \u5728\u5bbf\u4e3b\u673a\u4e2d\u7528wireshark \u6253\u5f00\u8fd9\u4e2a </p> <p>Todo</p> <p>TODO</p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#_5","title":"\u5176\u4ed6\u5b89\u5168\u76f8\u5173","text":"","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/https/#_6","title":"\u6458\u8981\u7b97\u6cd5","text":"<p>Tip</p> <ol> <li>\u6458\u8981\u7b97\u6cd5\uff08Hash Algorithm\uff09\u4e5f\u53eb\u54c8\u5e0c\u7b97\u6cd5\u3001\u6563\u5217\u7b97\u6cd5, \u5b83\u662f\u4e00\u79cd\u5c06\u4efb\u610f\u957f\u5ea6\u7684\u6570\u636e\u6620\u5c04\u4e3a\u56fa\u5b9a\u957f\u5ea6\u6458\u8981\uff08\u54c8\u5e0c\u503c\uff09\u7684\u7b97\u6cd5.\u6458\u8981\u7b97\u6cd5\u5e38\u7528\u4e8e\u9a8c\u8bc1\u6570\u636e\u7684\u5b8c\u6574\u6027\u548c\u552f\u4e00\u6027,\u4ee5\u53ca\u5bc6\u7801\u5b66\u4e2d\u7684\u6570\u5b57\u7b7e\u540d\u3001\u5bc6\u7801\u6821\u9a8c\u7b49\u5e94\u7528</li> <li>\u4efb\u610f\u957f\u5ea6\u2192 \u56fa\u5b9a\u957f\u5ea6, \u5f88\u663e\u7136\u4e0d\u53ef\u80fd\u4ece\u6620\u5c04\u540e\u7684\u6458\u8981\u503c\u63a8\u5bfc\u51fa\u539f\u6765\u7684\u6570\u636e.</li> </ol> <p></p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/sniffer/","title":"Sniffer","text":""},{"location":"network-programming/sniffer/#tools","title":"tools","text":""},{"location":"network-programming/sniffer/#tcpdump","title":"tcpdump","text":""},{"location":"network-programming/sniffer/#fiddler","title":"fiddler","text":""},{"location":"network-programming/sniffer/#charles","title":"charles","text":""},{"location":"network-programming/tcp/","title":"tcp","text":"<p>Warning</p> <p>\u672a\u5b8c\u5f85\u7eed</p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/tcp/#socket","title":"socket","text":"<ul> <li>\u4e0e\u7f51\u7edc\u4e2d\u7684\u5176\u4ed6\u5e94\u7528\u8fdb\u884c\u901a\u4fe1\u7684\u51fd\u6570\u63a5\u53e3</li> <li>\u5c01\u88c5\u4e86\u4f20\u8f93\u5c42\u7684\u534f\u8bae, tcp udp</li> <li>\u65e2\u7136\u662f\u4e0e\u7f51\u7edc\u4e2d\u7684\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u901a\u4fe1, \u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u63a8\u65adsocket\u5957\u63a5\u5b57\u80af\u5b9a\u6709ip(\u786e\u5b9a\u4e3b\u673a)\u548cport(\u786e\u5b9a\u5e94\u7528),\u7528\u6765\u660e\u786e\u662f\u54ea\u4e2a\u5e94\u7528</li> </ul>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/tcp/#_1","title":"\u4ee3\u7801","text":"\u5ba2\u6237\u7aef\u670d\u52a1\u7aef client.c<pre><code>#include &lt;stdio.h&gt;\n#include &lt;unistd.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;sys/types.h&gt;\n#include &lt;sys/stat.h&gt;\n#include &lt;string.h&gt;\n#include &lt;arpa/inet.h&gt;\n#include &lt;fcntl.h&gt;\n// tcp client\nint main(int argc, const char* argv[])\n{\n// \u521b\u5efa\u5957\u63a5\u5b57\nint fd = socket(AF_INET, SOCK_STREAM, 0);\nif(fd == -1)\n{\nperror(\"socket error\");\nexit(1);\n}\n// \u8fde\u63a5\u670d\u52a1\u5668\nstruct sockaddr_in serv_addr;\n// \u5c06serv_addr \u7ed3\u6784\u4f53 \u6240\u5360\u5185\u5b58\u5185\u5bb9\u7f6e\u4e3a0, \u7b49\u4ef7\u4e8e bzero(&amp;serv_addr, sizeof(serv_addr));\nmemset(&amp;serv_addr, 0, sizeof(serv_addr));\nserv_addr.sin_family = AF_INET;\n//\u7f51\u7edc\u4f20\u8f93\u6570\u636e\u91c7\u7528\u7684\u662f\u5927\u7aef ,\u6240\u4ee5\u8fd9\u91cc\u7aef\u53e3\u8981\u8f6c\u6362\u4e3a\u5927\u7aef\n// h: host, to:to, n: net, s:short int (unsigned)\n// \u5c06\u4e3b\u673a\u5b57\u8282\u5e8f\u8f6c\u4e3a\u7f51\u7edc\u5b57\u8282\u5e8f(\u5927\u7aef)\nserv_addr.sin_port = htons(9999);\n// \u5c06ip\u8f6c\u6362\u4e3a\u7f51\u7edc\u5b57\u8282\u5e8f, \u662f\u5c06\u5b57\u7b26\u4e32(ip) \u8f6c\u4e3aint\u578b(\u5927\u7aef\u65b9\u5f0f)\n// \u76f4\u63a5\u4fee\u6539 &amp;serv_addr.sin_addr.s_addr\n// inet_pton\u8f6c\u6362\u6210\u529f\u5219\u8fd4\u56de1,\u8f6c\u6362\u5931\u8d25\u8fd4\u56de 0,\u5982\u679c\u6307\u5b9a\u7684\u5730\u5740\u7c7b\u578b\u534f\u8bae\u7c07\u4e0d\u5408\u6cd5,\u5c06\u8fd4\u56de-1\ninet_pton(AF_INET, \"127.0.0.1\", &amp;serv_addr.sin_addr.s_addr);\nint ret = connect(fd, (struct sockaddr*)&amp;serv_addr, sizeof(serv_addr));\nif(ret == -1)\n{\nperror(\"connect error\");\nexit(1);\n}\n// \u901a\u4fe1\nwhile(1)\n{\n// \u5199\u6570\u636e\n// \u63a5\u6536\u952e\u76d8\u8f93\u5165\nchar buf[512];\nprintf(\"input: \\n\");\nfgets(buf, sizeof(buf), stdin);\n// \u8fd9\u91cc\u5982\u679c\u8f93\u5165\u7684\u5c0f\u4e8e512 \u4f1a\u5c31\u6700\u540e\u7684\u56de\u8f66\u7b26\u53f7\u4e5f\u53d1\u9001\u8fc7\u53bb.(\u8be6\u60c5\u89c1fgets\u7684\u8bf4\u660e)\n// \u4f60\u53ef\u4ee5\u81ea\u5df1\u5c06\u6700\u540e\u7684\u56de\u8f66\u7b26\u5904\u7406\u6389...\n// \u53d1\u9001\u7ed9\u670d\u52a1\u5668, +1 \u662f\u628a\u6700\u540e\u7684\\0 \u4e5f\u53d1\u9001\u8fc7\u53bb.\nwrite(fd, buf, strlen(buf)+1);\n// \u63a5\u6536\u670d\u52a1\u5668\u7aef\u7684\u6570\u636e\nint len = read(fd, buf, sizeof(buf));\nif(len == -1)\n{\nperror(\"read error\");\nbreak;\n}\nelse if( len == 0 )\n{\nprintf(\"\u670d\u52a1\u7aef\u5173\u95ed\u4e86\u8fde\u63a5 ...\\n\");\nbreak;\n} else if(len &gt; 0)\n{\nprintf(\"read buf = %s, len = %d\\n\", buf, len);\n}\n}\nclose(fd);\nreturn 0;\n}\n</code></pre> server.c<pre><code>#include &lt;stdio.h&gt;\n#include &lt;unistd.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;sys/types.h&gt;\n#include &lt;sys/stat.h&gt;\n#include &lt;string.h&gt;\n#include &lt;sys/socket.h&gt;\n#include &lt;arpa/inet.h&gt;\n#include &lt;ctype.h&gt;\nint main(int argc, const char* argv[])\n{\n// \u521b\u5efa\u7528\u4e8e\u76d1\u542c\u7684\u5957\u8282\u5b57\nint listen_fd = socket(AF_INET, SOCK_STREAM, 0);\nif(listen_fd == -1)\n{\nperror(\"socket error\");\nexit(1);\n}\nstruct sockaddr_in serv_addr;\nmemset(&amp;serv_addr, 0, sizeof(serv_addr));\nserv_addr.sin_family = AF_INET;     // \u5730\u5740\u65cf\u534f\u8baeipv4\nserv_addr.sin_port = htons(9999);   // \u672c\u5730\u7aef\u53e3\u9700\u8981\u8f6c\u6362\u4e3a\u5927\u7aef\n// ip\u8f6c\u4e3a\u7f51\u7edc\u5b57\u8282\u5e8f(\u5927\u7aef)\nserv_addr.sin_addr.s_addr = htonl(INADDR_ANY);  // 0\u8868\u793a\u7528\u672c\u673a\u7684\u4efb\u610fIP\nint ret = bind(listen_fd, (struct sockaddr*)&amp;serv_addr, sizeof(serv_addr));\nif(ret == -1)\n{\nperror(\"bind error\");\nexit(1);\n}\n// \u8bbe\u7f6e\u76d1\u542c\nret = listen(listen_fd, 64);\nif(ret == -1)\n{\nperror(\"listen error\");\nexit(1);\n}\n// \u7b49\u5f85\u5e76\u63a5\u53d7\u8fde\u63a5\u8bf7\u6c42\nstruct sockaddr_in client_addr;\nsocklen_t client_len = sizeof(client_addr);\nint client_fd = accept(listen_fd, (struct sockaddr*)&amp;client_addr, &amp;client_len);\nif(client_fd == -1)\n{\nperror(\"accept error\");\nexit(1);\n}\nchar client_ip_buf[64];\n// \u7f51\u7edc\u5b57\u8282\u5e8f \u8f6c\u6362\u4e3a \u4e3b\u673a\u5b57\u8282\u5e8f, \u7ed3\u679c\u5b58\u50a8\u5230client_ip_buf\n// \u8fd4\u56de\u503c\u662f\u4e2a\u6307\u5411client_ip_buf \u7684\u6307\u9488\nconst char* client_ip=inet_ntop(AF_INET, &amp;client_addr.sin_addr.s_addr, client_ip_buf, sizeof(client_ip_buf));\nprintf(\"client ip: %s, port: %d\\n\", client_ip, ntohs(client_addr.sin_port));\n// \u901a\u4fe1\nwhile(1)\n{\n// \u5148\u63a5\u6536\u6570\u636e\nchar buf[1024] = {0};\nint len = read(client_fd, buf, sizeof(buf));\nif(len == -1)\n{\nperror(\"read error\");\nbreak;\n}\nelse if(len &gt; 0)\n{\n// \u987a\u5229\u8bfb\u51fa\u4e86\u6570\u636e\nprintf(\"read buf = %s\\n\", buf);\nfor(int i=0; i&lt;len; ++i)\n{\nbuf[i] = toupper(buf[i]);\n}\nprintf(\" toupper: %s\\n\", buf);\n// \u6570\u636e\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\nwrite(client_fd, buf, strlen(buf)+1);\n}\nelse if( len == 0 )\n{\nprintf(\"client disconnect ...\\n\");\nbreak;\n}\n}\nclose(listen_fd);\nclose(client_fd);\nreturn 0;\n}\n</code></pre> <pre><code>gcc client.c -o client\ngcc server.c -o server\n./server\n./client\n</code></pre>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/tcp/#tcp","title":"tcp \u62a5\u6587","text":"","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/tcp/#-","title":"\u63e1\u624b-\u4f20\u8f93-\u6325\u624b","text":"","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/tcp/#_2","title":"\u6ed1\u52a8\u7a97\u53e3","text":"","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/tcp/#_3","title":"\u4fee\u6539\u7f13\u51b2\u533a\u5927\u5c0f","text":"","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/tcp/#tcp_1","title":"\u7cfb\u7edftcp\u7f13\u51b2\u8bbe\u7f6e","text":"<p>\u67e5\u770b\u914d\u7f6e<pre><code>cat /proc/sys/net/ipv4/tcp_rmem\n4096    87380   5369920\n# 4096 \u662f\u8bf4\u63a5\u6536\u7f13\u51b2\u533a(\u8bfb\u7f13\u51b2\u533a)\u7684\u6700\u5c0f\u503c\n# 87380 \u8868\u793a\u9ed8\u8ba4\u503c \u8be5\u503c\u4f1a\u8986\u76d6rmem_default, \u4e0d\u662f\u88ab\u8986\u76d6, \u7f51\u7edc\u4e0a\u5f88\u591a\u8bf4\u88ab\u8986\u76d6.. \u771f\u7684\u670d\u4e86\n# 5369920 \u63a5\u6536\u7f13\u51b2\u533a\u7a7a\u95f4\u7684\u6700\u5927\u5b57\u8282\u6570(\u8be5\u503c\u4f1a\u88abrmem_max\u8986\u76d6)\ncat /proc/sys/net/core/rmem_max  #\u4e00\u4e2asocket\u7684\u8bfb\u7f13\u51b2\u533a\u53ef\u7531\u7a0b\u5e8f\u8bbe\u7f6e\u7684\u6700\u5927\u503c\n212992\ncat /proc/sys/net/core/rmem_default #\u4e00\u4e2asocket\u7684\u88ab\u521b\u5efa\u51fa\u6765\u65f6\uff0c\u9ed8\u8ba4\u7684\u8bfb\u7f13\u51b2\u533a\u5927\u5c0f\n212992\n</code></pre> \u4e34\u65f6\u4fee\u6539\u914d\u7f6e,\u91cd\u542f\u540e\u5931\u6548<pre><code>sysctl -w net.ipv4.tcp_wmem=\"1 1 1\"\nsysctl -w net.core.wmem_max=5000\n</code></pre></p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/tcp/#linux","title":"\u67e5\u770blinux\u5173\u4e8e\u7f13\u51b2\u7684\u6e90\u7801","text":"linux4.9\u6e90\u7801 net/core/sock.h<pre><code>#define TCP_SKB_MIN_TRUESIZE    (2048 + SKB_DATA_ALIGN(sizeof(struct sk_buff)))\n#define SOCK_MIN_SNDBUF     (TCP_SKB_MIN_TRUESIZE * 2)\n#define SOCK_MIN_RCVBUF      TCP_SKB_MIN_TRUESIZE\n</code></pre> linux4.9\u6e90\u7801 net/core/sock.c<pre><code>switch (optname) {\ncase SO_SNDBUF:\n// \u5982\u679c val&gt; /proc/sys/net/core/wmem_max ,\u5219\u8bbe\u7f6e\u6210wmem_max \u7684\u503c\nval = min_t(u32, val, sysctl_wmem_max);\nset_sndbuf:\nsk-&gt;sk_userlocks |= SOCK_SNDBUF_LOCK;\n// \u5982\u679c val\u503c\u7684 2\u500d \u8fd8\u5c0f\u4e8e\u6700\u5c0f\u503c, \u90a3\u4e48 \u4f7f\u7528 \u6700\u5c0f\u503c,\u5426\u800c\u5c31\u662f val\u503c\u76842\u500d\nsk-&gt;sk_sndbuf = max_t(int, val * 2, SOCK_MIN_SNDBUF);\nsk-&gt;sk_write_space(sk);\nbreak;\ncase SO_RCVBUF:\nval = min_t(u32, val, sysctl_rmem_max);\nset_rcvbuf:\nsk-&gt;sk_userlocks |= SOCK_RCVBUF_LOCK;\nsk-&gt;sk_rcvbuf = max_t(int, val * 2, SOCK_MIN_RCVBUF);\nbreak;\n}\n</code></pre> <p>\u5f97\u51fa\u7ed3\u8bba</p> <ol> <li>\u5982\u679c\u4f60\u8bbe\u7f6e\u7684\u503c &gt; \u6700\u5927\u503c,\u5219 \u8bbe\u7f6e\u4e3a \u6700\u5927\u503c\u76842\u500d</li> <li>\u5982\u679c\u4f60\u8bbe\u7f6e\u7684\u503c\u76842\u500d &lt; \u6700\u5c0f\u503c,\u5219 \u8bbe\u7f6e\u4e3a \u6700\u5c0f\u503c</li> <li>\u5176\u4ed6\u60c5\u51b5 ,\u5219\u8bbe\u7f6e\u4e3a \u8be5\u503c\u76842\u500d</li> </ol>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/tcp/#_4","title":"\u4ee3\u7801\u4fee\u6539\u7f13\u51b2","text":"server.c<pre><code>#include &lt;stdio.h&gt;\n#include &lt;unistd.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;sys/types.h&gt;\n#include &lt;sys/stat.h&gt;\n#include &lt;string.h&gt;\n#include &lt;sys/socket.h&gt;\n#include &lt;arpa/inet.h&gt;\n#include &lt;ctype.h&gt;\n#include &lt;unistd.h&gt;\nvoid getsockopts(char* s ,int sockfd){\nprintf(\"===%s===\\n\",s);\nint opt_val;\nsocklen_t opt_len=sizeof(opt_val);\nif (getsockopt(sockfd,SOL_SOCKET, SO_SNDBUF, &amp;opt_val, &amp;opt_len)!=0){\nperror(\"getsocketopt error\");\nexit(1);\n}\nprintf(\"\u5199\u7f13\u51b2\u533a\u5927\u5c0f: %d\\n\", opt_val);\nopt_val=0;\nif (getsockopt(sockfd,SOL_SOCKET, SO_RCVBUF, &amp;opt_val, &amp;opt_len)!=0){\nperror(\"getsocketopt error\");\nexit(1);\n}\nprintf(\"\u8bfb\u7f13\u51b2\u533a\u5927\u5c0f: %d\\n\", opt_val);\nopt_val=0;\nif (getsockopt(sockfd,SOL_SOCKET, SO_SNDLOWAT, &amp;opt_val, &amp;opt_len)!=0){\nperror(\"getsocketopt error\");\nexit(1);\n}\nprintf(\"\u53d1\u9001\u4f4e\u6f6e\u9650\u5ea6\u5927\u5c0f: %d\\n\", opt_val);\n}\nvoid setsockopts(int sockfd,int nRecvBuf,int nSendBuf){\n// \u63a5\u6536\u7f13\u51b2\u533a\nint ret=setsockopt(sockfd,SOL_SOCKET,SO_RCVBUF,(const char*)&amp;nRecvBuf,sizeof(int));\nif (ret !=0){\nperror(\"setsocketopt error\");\n}\n//\u53d1\u9001\u7f13\u51b2\u533a\nret =setsockopt(sockfd,SOL_SOCKET,SO_SNDBUF,(const char*)&amp;nSendBuf,sizeof(int));\nif (ret !=0){\nperror(\"setsocketopt error\");\n}\n}\nint main(int argc, const char* argv[])\n{\n// printf(\"argcount: %d\\n\",argc);\nif (argc!=3){\nprintf(\"\u8bf7\u8f93\u5165\u8981\u8bbe\u7f6e\u7684\u8bfb\u7f13\u51b2\u548c\u5199\u7f13\u51b2\\n\");\nprintf(\"usage: %s \u8bfb\u7f13\u51b2\u503c \u5199\u7f13\u51b2\u503c\\n\",argv[0]);\nexit(1);\n}\n// \u521b\u5efa\u7528\u4e8e\u76d1\u542c\u7684\u5957\u8282\u5b57\nint listen_fd = socket(AF_INET, SOCK_STREAM, 0);\nif(listen_fd == -1)\n{\nperror(\"socket error\");\nexit(1);\n}\ngetsockopts(\"before set\",listen_fd);\n// \u8fd9\u91cc\u4e0d\u4e25\u8c28,\u968f\u4fbf\u7528\u7528\nsetsockopts(listen_fd,atoi(argv[1]),atoi(argv[2]));\ngetsockopts(\"after set\",listen_fd);\nstruct sockaddr_in serv_addr;\nmemset(&amp;serv_addr, 0, sizeof(serv_addr));\nserv_addr.sin_family = AF_INET;\nserv_addr.sin_port = htons(9999);\nserv_addr.sin_addr.s_addr = htonl(INADDR_ANY);\nint ret = bind(listen_fd, (struct sockaddr*)&amp;serv_addr, sizeof(serv_addr));\nif(ret == -1)\n{\nperror(\"bind error\");\nexit(1);\n}\n// \u8bbe\u7f6e\u76d1\u542c\nret = listen(listen_fd, 64);\nif(ret == -1)\n{\nperror(\"listen error\");\nexit(1);\n}\n// \u7b49\u5f85\u5e76\u63a5\u53d7\u8fde\u63a5\u8bf7\u6c42\nstruct sockaddr_in client_addr;\nsocklen_t client_len = sizeof(client_addr);\nint client_fd = accept(listen_fd, (struct sockaddr*)&amp;client_addr, &amp;client_len);\nif(client_fd == -1)\n{\nperror(\"accept error\");\nexit(1);\n}\nchar client_ip_buf[64];\nconst char* client_ip=inet_ntop(AF_INET, &amp;client_addr.sin_addr.s_addr, client_ip_buf, sizeof(client_ip_buf));\nprintf(\"client ip: %s, port: %d\\n\", client_ip, ntohs(client_addr.sin_port));\n// \u901a\u4fe1\nwhile(1)\n{\nsleep(3);\n}\nclose(listen_fd);\nclose(client_fd);\nreturn 0;\n}\n</code></pre> <pre><code>./server2 212993 1\nargcount: 3\n===before set===\n\u5199\u7f13\u51b2\u533a\u5927\u5c0f: 16384\n\u8bfb\u7f13\u51b2\u533a\u5927\u5c0f: 87380\n\u53d1\u9001\u4f4e\u6f6e\u9650\u5ea6\u5927\u5c0f: 1\n===after set===\n\u5199\u7f13\u51b2\u533a\u5927\u5c0f: 4608 # \u6700\u5c0f\u503c\n\u8bfb\u7f13\u51b2\u533a\u5927\u5c0f: 425984 # \u6700\u5927\u503c\u76842\u500d\n\u53d1\u9001\u4f4e\u6f6e\u9650\u5ea6\u5927\u5c0f: 1\n./server2 212991 1\n===before set===\n\u5199\u7f13\u51b2\u533a\u5927\u5c0f: 16384\n\u8bfb\u7f13\u51b2\u533a\u5927\u5c0f: 87380\n\u53d1\u9001\u4f4e\u6f6e\u9650\u5ea6\u5927\u5c0f: 1\n===after set===\n\u5199\u7f13\u51b2\u533a\u5927\u5c0f: 4608\n\u8bfb\u7f13\u51b2\u533a\u5927\u5c0f: 425982 # \u8bbe\u7f6e\u7684\u503c\u76842\u500d\n\u53d1\u9001\u4f4e\u6f6e\u9650\u5ea6\u5927\u5c0f: 1\n</code></pre>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"network-programming/tcp/#_5","title":"\u963b\u585e","text":"<p>\u963b\u585e ,\u963b\u585e, \u5565\u662f\u963b\u585e? 1. \u5047\u8bbe\u5feb\u9012, \u5728\u6ca1\u6709\u8702\u5de2\u7684\u60c5\u51b5\u4e0b, \u5feb\u9012\u5458\u5e26\u7740\u5305\u88f9\u6765\u4e86, \u4f60\u4eba\u4e0d\u5728, GG 2. \u6709\u8702\u5de2\u540e, \u5305\u88f9\u5230\u4e86, \u5feb\u9012\u5458\u53d1\u73b0\u8702\u5de2\u6ee1\u4e86, GG</p>","tags":["\u7f51\u7edc\u7f16\u7a0b"]},{"location":"python/basis/env/","title":"\u73af\u5883\u51c6\u5907","text":""},{"location":"python/basis/env/#_1","title":"\u5b89\u88c5","text":"<p>python conda \u4e00\u952e\u5b89\u88c5\u811a\u672c</p>"},{"location":"python/basis/env/#pip","title":"pip","text":""},{"location":"python/basis/env/#_2","title":"\u4fee\u6539\u6e90","text":"<p>Note</p> <p>~/.pip/pip.conf  \u4e2d\u6dfb\u52a0\u6216\u4fee\u6539:</p> <pre><code>[global]\nindex-url = https://mirrors.aliyun.com/pypi/simple/\n[install]\ntrusted-host=mirrors.aliyun.com\n</code></pre>"},{"location":"python/basis/env/#_3","title":"\u5e38\u7528\u547d\u4ee4","text":"<pre><code>pip install django==1.8.2 #\u6307\u5b9a\u7248\u672c\n# \u663e\u793a\u5b89\u88c5\u7684\u5305\npip list\n# \u8f93\u51fa\u6240\u6709\u5728\u672c\u5730\u5df2\u7ecf\u5b89\u88c5\u7684\u5305(\u4e0d\u5305\u62ec pip,wheel,setuptools\u7b49\u81ea\u5e26\u5305)\npip freeze\npip freeze &gt; requirements.txt\n# \u8fd9\u4e2a\u5219\u8f93\u51fa\u7684\u5185\u5bb9\u4e0epip list\u7684\u5305 \u4e00\u6837\npip freeze --all&gt; requirements.txt\n# \u5982\u679c\u770b\u5230 \u663e\u793a\u5185\u5bb9\u6709 file:/// \u8fd9\u79cd\u5305 \u8def\u5f84\n# \u4e0d\u8fc7\u8fd9\u4e2a\u547d\u4ee4\u4f1a\u8f93\u51fa setuptools,pip \u7b49\u81ea\u5e26\u7684\u5305, \u8981\u624b\u52a8\u5220\u9664\npip list --format=freeze &gt; requirements.txt\n\n# \u5b89\u88c5\u4f9d\u8d56\npip install -r requirements.txt\n\n# \u67e5\u770b\u4f7f\u7528pip\u5b89\u88c5\u7684\u5e93 \u5728\u7cfb\u7edf\u4e2d\u7684\u4f4d\u7f6e\npip show django\n</code></pre>"},{"location":"python/basis/env/#conda","title":"conda","text":"<p>Note</p> <p>pyenv \u8fd9\u4e2a\u5df2\u7ecf\u4e0d\u63a8\u8350 Anaconda \u662f\u4e00\u4e2a\u7528\u4e8e\u79d1\u5b66\u8ba1\u7b97\u7684 Python \u53d1\u884c\u7248\uff0c\u652f\u6301 Linux, Mac, Windows, \u5305\u542b\u4e86\u4f17\u591a\u6d41\u884c\u7684\u79d1\u5b66\u8ba1\u7b97\u3001\u6570\u636e\u5206\u6790\u7684 Python \u5305  Miniconda \u662f\u4e00\u4e2a Anaconda \u7684\u8f7b\u91cf\u7ea7\u66ff\u4ee3\uff0c\u9ed8\u8ba4\u53ea\u5305\u542b\u4e86 python \u548c conda\uff0c\u4f46\u662f\u53ef\u4ee5\u901a\u8fc7 pip \u548c conda \u6765\u5b89\u88c5\u6240\u9700\u8981\u7684\u5305</p> <pre><code>conda config --help\n# \u67e5\u770b\u6839\u76ee\u5f55\nconda info --root\n\nconda info -e  #\u67e5\u770b\u5df2\u5b89\u88c5\u7684\u73af\u5883\n#\u6dfb\u52a0\u56fd\u5185\u955c\u50cf\nconda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/\nconda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/\n\n# \u4f7f\u7528\u8fc7conda config \u547d\u4ee4\u540e \u4f1a\u751f\u6210\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6 cat ~/.condarc, \u9ed8\u8ba4\u662f\u6ca1\u6709\u7684\n#\u8bbe\u7f6e\u641c\u7d22\u65f6\u663e\u793a\u901a\u9053\u5730\u5740\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u4e0d\u52a0\uff0c\u53ea\u662f\u4e3a\u4e86\u770b\u4e00\u4e0b\u662f\u5426\u4ece\u955c\u50cf\u7ad9\u4e0b\u8f7d\nconda config --set show_channel_urls yes\n#\u57fa\u4e8e python3.6 \u521b\u5efa\u4e00\u4e2a\u540d\u4e3apython36\u7684\u73af\u5883\nconda  create --name python36 python=3.6\n#\u6fc0\u6d3b\u73af\u5883\n# \u9ed8\u8ba4\u73af\u5883\u91cc \u5df2\u7ecf\u5b89\u88c5\u4e86 \u5404\u79cd\u79d1\u5b66\u5e93\u4ec0\u4e48\u7684,,jupyter note \u4e4b\u7c7b\u7684,\u6240\u4ee5\u6ca1\u4ec0\u4e48\u7279\u6b8a\u60c5\u51b5,\u9ed8\u8ba4\u5c31\u7528\u8fd9\u4e2a\nconda activate # \u6fc0\u6d3b\u9ed8\u8ba4\u7684base \u73af\u5883, \u901a\u8fc7conda env list \u80fd\u67e5\u770b\nconda activate python36\n#\u79bb\u5f00\u5f53\u524d\u73af\u5883\nconda deactivate\n#\u67e5\u770b\u5b89\u88c5\u4e86\u7684\u73af\u5883\u60c5\u51b5,\u5e26* \u7684\u8868\u793a\u5f53\u524d\u73af\u5883\nconda env list\n# \u79fb\u9664\u4e00\u4e2a\u540d\u79f0python36\u53eb\u505a\u73af\u5883\nconda env remove --name python36\n\nconda search \u5305\u540d\n#\u5220\u9664\u6307\u5b9a\u73af\u5883\u4e2d\u7684\u6307\u5b9a\u5305\nconda remove -n python36 numpy\nconda remove \u5305\u540d  # \u5220\u9664\u5f53\u524d\u73af\u5883\u4e2d\u7684\u6307\u5b9a\u5305\n# \u5b89\u88c5\u5305\nconda install --name myenv scipy # \u5b89\u88c5\u5305\u5230\u6307\u5b9a\u73af\u5883\u4e2d\nconda install scipy # \u5b89\u88c5\u5305\u5230\u5f53\u524d\u73af\u5883\u4e2d\nconda install scipy=0.15.0  # \u5b89\u88c5\u6307\u5b9a\u7248\u672c\u7684\u5305\uff0c\u5230\u5f53\u524d\u73af\u5883\nconda install scipy curl # \u5b89\u88c5\u591a\u4e2a\u5305\nconda install -c anaconda django # -c\u662f\u6307\u5b9a\u6e20\u9053\u540d\u79f0\uff0c\u4e5f\u5c31\u662f\u7528\u54ea\u4e2a\u6e20\u9053\u5b89\u88c5django\u3002\n# \u5b89\u88c5\u4e0d\u5728conda\u6216\u8005 anaconda \u7684\u5305\uff0c\u5f53\u4f60\u5b89\u88c5\u7684\u5305\u4e0d\u5728conda\u7ba1\u7406\u8303\u56f4\u7684\u65f6\u5019\u53ef\u4ee5\u4f7f\u7528pip\u6765\u5b89\u88c5\nconda install pip  # \u9996\u5148\u5728\u5f53\u524d\u73af\u5883\u4e2d\u5b89\u88c5pip\npip install \u5305\u540d   # \u5176\u6b21\u5728\u901a\u8fc7PIP\u547d\u4ee4\u5728\u5f53\u524d\u73af\u5883\u4e2d\u5b89\u88c5\u5305\nconda update \u5305\u540d  # \u66f4\u65b0\u5f53\u524d\u73af\u5883\u6307\u5b9a\u7684\u5305\nconda update -n python36 numpy # \u66f4\u65b0\u6307\u5b9a\u73af\u5883\u4e2d\u7684\u6307\u5b9a\u5305\nconda list\nconda list -n python36 # \u67e5\u770b\u6307\u5b9a\u73af\u5883\u4e2d\u5b89\u88c5\u7684\u6240\u6709\u5305\n</code></pre> <ol> <li> <p>conda\u56fd\u5185\u6e90 \u21a9</p> </li> <li> <p>miniconda\u5b98\u65b9 \u21a9</p> </li> <li> <p>anaconda\u5b98\u65b9 \u21a9</p> </li> </ol>"},{"location":"python/basis/quick-start/","title":"Quick start","text":"<p>Warning</p> <p>\u65e9\u671f \u7b14\u8bb0 \u6682\u5b58 \u5f85\u4fee\u6539.</p> <p><pre><code>name = 'ab'\nname2=name\n# \u6253\u5370\u5730\u5740\nprint(id(name))\nprint(id(name2))\nprint('hello ',name)\n</code></pre> <pre><code>name='tom'\nage=10\n#\u4f1a\u5f00\u8f9f\u591a\u5757\u5185\u5b58,\u6548\u7387\u4f4e\u4e0b\nprint('my name is '+ name)\nprint('my name is %s' % 'tom')\nprint('my name is {}'.format('tom'))\n#\u63a8\u8350\u4e00\u4e0b2\u4e2d\u65b9\u5f0f,\u6bd4\u8f83\u597d,\u53ea\u4f1a\u5f00\u8f9f\u4e00\u5757\u5185\u5b58\nprint('my name is {_name}, age is {_age}'.format(_name=name,_age=age))\nprint('my name is {0}, age is {1}'.format(name,age))\nprint('my name is %(name)s' % {'name':'tom'})\n</code></pre></p> \u8f93\u5165\u5bc6\u7801, \u5c31\u662f\u8ba9\u4f60\u770b\u4e0d\u5230\u7684\u90a3\u4e2a\u6548\u679c<pre><code>import  getpass\nname=input('name:')\npassword=getpass.getpass('password:')\n</code></pre> for range<pre><code>for i in range(10):\nprint(i) # 0 - 9\nfor i in range(0,10,2):\nprint(i) # 0 2 4 6 8\n</code></pre>"},{"location":"python/basis/quick-start/#_1","title":"\u5b57\u5178","text":"<pre><code>st={\n'001':'x',\n'002':'y',\n'003':'z',\n'004':'a',\n'005':'b',\n}\nr=st.pop('001') #\u83b7\u53d6 key\u662f001\u7684 value\nprint(r) # x\nprint(st) # st \u5b9e\u9645\u5df2\u7ecf\u88ab\u4fee\u6539\u4e86\u54e6! {'002': 'y', '003': 'z'}\n# \u5220\u9664key\ndel st['002']\n#\u968f\u673a\u5220\u9664\n# st.popitem()\n# \u67e5\u627e\nb='004' in st\nprint(b) #True\nc=st.get('000')\nprint(c) #None\n# \u5982\u679c\u6ca1\u6709,\u5219\u8bbe\u7f6e\u4e3a\u540e\u9762\u7684,\u5982\u679c\u5df2\u7ecf\u6709\u4e86,\u5219\u4e0d\u505a\u64cd\u4f5c\nst.setdefault('000',[1,2]) # \u751f\u6548\u4e86\nst.setdefault('000',[3,3]) # \u4e0d\u4f1a\u4fee\u6539, \u8fd8\u662f [1,2]\nprint(st['000'])\nst2={\n'001':'tom',\n'006':'jack'\n}\n# st \u7528 st2\u6765\u66f4\u65b0\u81ea\u5df1\nst.update(st2) # \u7528st2\u7684\u5185\u5bb9 \u8986\u76d6\u4e86st\nprint(st)\n# \n#\u5b57\u5178\u7684for\nfor i in st:\nprint(st[i])\ni=st.items()\nprint(i) # dict_items([('001', 'x'), ('002', 'y'), ('003', 'z'), ('004', 'a'), ('005', 'b')])\nprint(type(i))\n# \u6548\u7387\u6bd4\u4e0a\u9762\u4f4e\nfor k,v in i:\nprint(k,v)\n#\u521d\u59cb\u5316\u4e00\u4e2a\u65b0\u7684\u5b57\u5178,\u7b2c\u4e8c\u4e2a\u53c2\u6570\u662f\u5b57\u5178\u7684\u503c,\u7b2c\u4e00\u4e2a\u662fkey\nnew=dict.fromkeys([1,2,3],'o')\nprint(new)\nnew[1]='y'\nprint(new)  # {1: 'y', 2: 'o', 3: 'o'}\nnew2=dict.fromkeys([1,2,3],{'name':'z'})\n# \u8be5\u5b57\u5178\u7684\u503c\u5171\u4eab\u4e00\u4e2a\u5185\u5b58\u5730\u5740,value\u662f\u4e2a\u5b57\u5178,\u6539\u53d8\u4e00\u4e2a,\u6240\u6709\u7684\u503c\u90fd\u4f1a\u6539\u53d8\nnew2[1]['name']='yy'\nprint(new2) #{1: {'name': 'yy'}, 2: {'name': 'yy'}, 3: {'name': 'yy'}}\n</code></pre>"},{"location":"python/basis/quick-start/#set","title":"set \u96c6\u5408","text":"<pre><code>#set \u4e5f\u53eb\u96c6\u5408,\u4e3b\u8981\u7528\u6765\u53bb\u91cd,\u548c\u5173\u7cfb\u6d4b\u8bd5,\u65e0\u5e8f\u7684\nlist1=[1,5,2,3,2,8,9]\nset1=set(list1)\nset2=set([1,4,3,7])\nprint(set1)\n#\u4ea4\u96c6  set1 &amp; set2\nprint(set1.intersection(set2))\n#\u5e76\u96c6 set1 | set2\nprint(set1.union(set2))\n#\u5dee\u96c6,\u6211\u6709\u7684,\u4f60\u6ca1\u6709, set1 - set2\nprint(set1.difference(set2))\n#\u5224\u65ad\u662f\u5426\u662f\u5b50\u96c6  set1 &lt;= set2\nprint(set1.issubset(set2))\n#\u83b7\u53d6\u53bb\u6389\u4ea4\u96c6\u7684 \u6570\u636e  set1 ^ set2\nprint(set1.symmetric_difference(set2)) # {2, 4, 5, 7, 8, 9}\n#\u6dfb\u52a0 \u4e00\u4e2a\nset1.add('y')\n# \u6dfb\u52a0\u591a\u4e2a\nset1.update([0,10])\n# \u5220\u9664, \u5982\u679c\u6ca1\u6709\u8fd9\u4e2a \u5143\u7d20,\u5219\u62a5\u9519\nset1.remove(10)\n# \u5220\u9664, \u5982\u679c\u6ca1\u6709\u8fd9\u4e2a \u5143\u7d20,\u4e0d\u4f1a\u62a5\u9519\nset1.discard(10)\nprint(0 in set1)\n</code></pre>"},{"location":"python/basis/quick-start/#file","title":"file","text":"<pre><code># \u5982\u679c\u4ee5w\u6a21\u5f0f\u6253\u5f00 \u6587\u4ef6\u7684\u8bdd, \u9996\u5148\u4f60\u4e0d\u80fd\u8bfb\u53d6\u5185\u5bb9\n# \u5176\u6b21\u5982\u679c\u5df2\u7ecf\u6709\u4e2a\u6587\u4ef6\u662fa.txt \u90a3\u4e48\u91cc\u9762\u7684\u5185\u5bb9\u4f1a\u88ab\u6e05\u7a7a\nf=open('a.txt','w')\n#\nf.write('aaa')\nf.close()\n# r \u8bfb\nf=open('a.txt','r')\nx=f.read()\nf.close()\n# \u8fd9\u4e2a\u662f\u8ffd\u52a0\u5185\u5bb9,\u4e0d\u4f1a\u8986\u76d6\u6389\u539f\u6765\u7684\n# \u8fd8\u662f\u4e0d\u80fd\u8bfb\nf2=open('a.txt','a')\nf2.close()\nf=open('a.txt','r')\n# \u5982\u679c\u6587\u4ef6\u975e\u5e38\u5927,\u8fd9\u6837\u4f1a\u4e00\u884c\u4e00\u884c\u7684\u628a\u5185\u5bb9\u5b58\u653e\u5230\u5185\u5b58\u4e2d\n# \u8fd9\u4e2a\u4e0d\u592a\u597d\nfor line in f.readlines():\nprint(line)\nfor index,line in enumerate(f.readlines()):\nprint(index,line)\nf.close() # ?\nf=open('a.txt','r')\n#\u8fd9\u4e2a\u4e5f\u662f\u4e00\u884c\u4e00\u884c\u7684\u8bfb,\u4f46\u662f\u5185\u5b58\u91cc\u53ea\u4fdd\u5b58\u4e00\u884c\u7684\u6570\u636e,\u8fd9\u4e2a\u5c31\u6bd4\u8f83\u597d\u7684\u65b9\u6cd5\nfor line in f:\nprint(line)\nf.close()\n</code></pre> <pre><code># a.txt\n# hello world\nf=open('a.txt','r',encoding='utf-8')\nx=f.read(2)\nprint(x) # he\n# tell \u83b7\u53d6\u4e86\u51e0\u4e2a\u5b57\u8282\ncnt=f.tell()\nprint(cnt) #2\nf.seek(6)\nx=f.read(2)\nprint(x) # wo\nprint(f.encoding) #utf-8\nf.close()\n</code></pre> <pre><code>import sys,time\nf=open('a.txt','a')\nf.write('b')\nf.flush() #\u7acb\u523b\u5237\u65b0\u5230\u78c1\u76d8\nf.write('c')\ntime.sleep(5) # \u8fd9\u4e2a\u671f\u95f4\u4f60\u5c31\u80fd\u770b\u5230\u6587\u4ef6\u91cc\u6709\u4e86b, \u4f46\u662f\u770b\u4e0d\u5230c\nf.close()\nimport sys,time\nfor i in range(20):\nsys.stdout.write('#')\n# \u8fd9\u91cc\u5c31\u662f\u7acb\u523b\u5237\u65b0,\u8981\u4e0d\u7136\u4f1a\u7b49\u7ed3\u675f\u540e\u4e00\u8d77\u51fa\u6765\u7684\nsys.stdout.flush()\ntime.sleep(0.1)\n</code></pre> <pre><code>#w+ \u5199\u8bfb\n# \u8fd8\u662f\u4f1a\u5148 \u91cd\u5199\u8be5\u6587\u4ef6\u7684,\u6240\u4ee5\u4e00\u822c\u5199\u8bfb\u6a21\u5f0f\u6ca1\u4ec0\u4e48\u7528,\u6211\u4eec\u4e00\u822c\u7528r+\u6a21\u5f0f\n#r+ \u662f\u8bfb\u5199, \u8ffd\u52a0\u6a21\u5f0f\nf=open('a.txt','r+')\nf.readline()\nprint(f.tell())\nf.write('------')\nf.close()\n</code></pre> <pre><code># f=open('a.txt','rb') #b \u8868\u793a\u4ee5\u4e8c\u8fdb\u5236\u6a21\u5f0f\u6253\u5f00\n#\u4ee5\u4e8c\u8fdb\u5236\u6253\u5f00\u540e,\u4e0d\u80fd\u8bfb\u53d6\u591a\u5c11\u5b57\u8282\n#\u4e00\u822c\u5728socket\u7f51\u7edc\u7f16\u7a0b\u91cc\u4f1a\u7528\u5230\nf=open('b.txt','wb')\n#\u9700\u8981\u5c06\u5b57\u7b26\u4e32\u8f6c\u6362\u6210\u4e8c\u8fdb\u5236\u5199\u5165,\u4f60\u770b\u5230\u7684b.txt\u6587\u4ef6\u91cc\u8fd8\u662fhello\nf.write('hello'.encode())\nf.close()\n</code></pre> <pre><code>#\u4fee\u6539\u6587\u4ef6,\u901a\u8fc7\u628a\u8be5\u6587\u4ef6\u4fdd\u5b58\u5230\u53e6\u5916\u4e00\u4e2a\u6587\u4ef6\nf=open(\"09\",\"r\",encoding=\"utf-8\")\nfn=open('09.new','w',encoding=\"utf-8\")\nfor line in f:\nif 'a' in line:\nline=line.replace(\"a\",\"xxx\")\nfn.write(line)\n#\u4e3a\u4e86\u907f\u514d\u6253\u5f00\u6587\u4ef6\u540e\u5fd8\u8bb0\u5173\u95ed\nwith open('a.txt',\"a\") as f:\npass\n#\u652f\u6301\u6253\u5f00\u591a\u4e2a\nwith open(\"a.txt\",'a') as f1,open(\"b.txt\",\"a\") as f2:\npass\n</code></pre>"},{"location":"python/basis/quick-start/#chardet","title":"chardet","text":"<pre><code>import  sys\nimport  chardet\nprint(sys.getdefaultencoding()) # utf-8\n</code></pre>"},{"location":"python/basis/quick-start/#_2","title":"\u51fd\u6570","text":"<pre><code>def t1():\nreturn 1\n# \u6ca1\u6709\u5199return ,\u90a3\u4e48\u9ed8\u8ba4\u8fd4\u56de None\ndef t2():\nprint(1)\nx=t2()\nprint(x) # None\n</code></pre>"},{"location":"python/pandas/quick-start/","title":"\u5feb\u901f\u5165\u95e8","text":""},{"location":"python/pandas/quick-start/#excel","title":"\u521b\u5efaexcel","text":"\u521b\u5efa\u7a7aexcel\u521b\u5efa\u5e26\u6570\u636e\u7684excel <pre><code>import pandas as pd\nfile = \"output.xlsx\"\n# \u7b80\u5355\u521b\u5efa\u4e00\u4e2axlsx\u6587\u4ef6\ndf = pd.DataFrame()\n# \u4fdd\u5b58\u5230\u76ee\u5f55\u4e0b,\u5185\u5bb9\u662f\u7a7a\u7684\ndf.to_excel(\"output.xlsx\")\n</code></pre> <ul> <li>\u4f1a\u5728\u6700\u5de6\u8fb9\u4e00\u5217\u663e\u793a0 1 2,\u662fdataFrame\u7684\u7d22\u5f15</li> </ul> <pre><code>import pandas as pd\ndf = pd.DataFrame({\"id\": [11, 22, 33], \"name\": [\"xiaobai\", \"xiaohong\", \"xiaohei\"]})\ndf.to_excel(\"output.xlsx\") # (1)\n</code></pre> <ol> <li> <p>\u751f\u6210\u7684excel</p> id name 0 11 xiaohei 1 22 xiaohong 2 33 xiaobai </li> <li> <p>\u5c06id \u8bbe\u7f6e\u4e3adf\u7684\u7d22\u5f15, \u8fd9\u6837\u751f\u6210\u7684excel \u4e0d\u4f1a\u5728\u524d\u9762\u7528\u81ea\u52a8\u751f\u62100 1 2..</p> </li> </ol> <pre><code>df = pd.DataFrame({\"id\": [11, 22, 33], \"name\": [\"xiaobai\", \"xiaohong\", \"xiaohei\"]})\ndf = df.set_index(\"id\")\ndf.to_excel(\"output.xlsx\") # (1)\n</code></pre> <ol> <li> <p>\u751f\u6210\u7684excel</p> id name 11 xiaohei 22 xiaohong 33 xiaobai </li> </ol>"},{"location":"python/pandas/quick-start/#excel_1","title":"\u8bfb\u53d6excel","text":"input.xlsx\u8bfb\u53d6\u6570\u636e id name 11 xiaohei 22 xiaohong 33 xiaobai 44 xiaohuang 55 xiaolan 66 xiaozi <pre><code>import pandas as pd\nfile = \"input.xlsx\"\nuser = pd.read_excel(file)\nprint(user.shape)   # \u6253\u5370\u51e0\u884c\u51e0\u5217 (1)\nprint(user.columns) # \u6253\u5370\u5217\u540d(\u8868\u5934)\nprint(user.head())  #\u9ed8\u8ba4\u6253\u53705\u884c (2)\nprint(user.head(1)) # \u8bfb\u4e00\u884c\n# \u76f4\u63a5\u6307\u5b9a\u54ea\u5217\u662findex, \u8fd9\u6837\u83b7\u53d6\u7684\u6570\u636e\u5c31\u4e0d\u4f1a\u6709\u81ea\u52a8\u751f\u6210\u7684\u90a3\u4e2a\u7d22\u5f15\u5217\nuser = pd.read_excel(file, index_col=\"id\")\nprint(user.head()) # (6)\n# \u5982\u679c \u8868\u683c\u524d\u9762\u7684\u884c\u662f\u7a7a\u7684, \u4f1a\u81ea\u52a8\u8df3\u8fc7\u7684\n# \u5982\u679c \u662f\u810f\u6570\u636e, \u5c31\u9700\u8981\u6307\u5b9a\u4e86\n# \u4eceexcel\u7684\u7b2c\u4e8c\u884c\u5f00\u59cb\u8bfb, \u6216\u8bf4\u7b2c\u4e8c\u884c\u4f5c\u4e3a\u5217\u540d\u884c\nuser = pd.read_excel(file, header=1)\nprint(user.columns) # \u8fd9\u4e2a\u65f6\u5019\u7684\u5217\u540d\u662f \u4e0a\u9762\u8bfb\u53d6\u7684\u7b2c\u4e00\u884c. (3)\n# \u6ca1\u6709header\u7684\u60c5\u51b5,\u5c31\u662f\u6211\u4eec\u6ca1\u6709\u7ed9\u8868\u683c\u7684\u8868\u5934\u6307\u5b9a\u662f\u4ec0\u4e48\u5b57\u6bb5\n# \u6ca1\u6709\u5217\u540d, \u5168\u662f\u6570\u636e, \u90a3\u4e48\u6211\u4eec\u5c31\u8981\nuser = pd.read_excel(file, header=None)\nprint(user.columns) # \u9ed8\u8ba4\u4f1a\u7ed9\u8868\u5934\u6307\u5b9a\u4e3a 0,1,2.. (4)\nuser = pd.read_excel(file)\nuser.columns = [\"user_id\", \"user_name\"]\n# inplace=True \u8868\u793a\u76f4\u63a5\u4fee\u6539, \u5426\u5219\u4f60\u9700\u8981 user=user.set_index(\"user_id\")\nuser.set_index(\"user_id\",inplace=True) # \u8fd9\u6837\u5c31\u4e0d\u4f1a\u8f93\u51fa \u9ed8\u8ba4\u7684\u7d22\u5f15\u5217, \u7528user_id\u4f5c\u4e3a\u7d22\u5f15\u4e86.\nuser.to_excel(\"output5.xlsx\") # (5)\n</code></pre> <ol> <li> <p>(6, 2) .6\u884c2\u5217\u7684\u610f\u601d,\u6ce8\u610f\u4e0d\u5305\u542b\u5217\u540d\u90a3\u4e00\u884c</p> </li> <li> <p>\u8f93\u51fa\u7684\u7ed3\u679c: \u52a0\u4e0a\u5217\u540d\u90a3\u4e00\u884c,\u4e00\u51716\u884c, \u7b2c\u4e00\u5217\u662f\u7d22\u5f15\u5217     <pre><code>   id       name\n0  11    xiaobai\n1  22   xiaohong\n2  33    xiaohei\n3  44  xiaohuang\n4  55    xiaolan\n</code></pre></p> </li> <li>\u663e\u793a:     <pre><code>Index([11, 'xiaobai'], dtype='object')\n</code></pre></li> <li>\u663e\u793a:     <pre><code>Int64Index([0, 1], dtype='int64')\n</code></pre></li> <li> <p>\u751f\u6210\u7684excel</p> user_id user_name 11 xiaohei 22 xiaohong 33 xiaobai 44 xiaohuang 55 xiaolan 66 xiaozi </li> <li> <p>\u663e\u793a:     <pre><code>id       name\n11    xiaobai\n22   xiaohong\n33    xiaohei\n44  xiaohuang\n55    xiaolan\n</code></pre></p> </li> </ol>"},{"location":"python/pandas/quick-start/#_1","title":"\u7edf\u8ba1","text":""},{"location":"python/pandas/quick-start/#_2","title":"\u6392\u5e8f","text":""},{"location":"python/pandas/quick-start/#_3","title":"\u6570\u636e\u7b5b\u9009","text":""},{"location":"tags/","title":"tags","text":""},{"location":"tags/#bash","title":"Bash","text":"<ul> <li>\u57fa\u7840</li> <li>sed</li> <li>\u53d8\u91cf</li> <li>\u7efc\u5408\u4f8b\u5b50</li> </ul>"},{"location":"tags/#docker","title":"Docker","text":"<ul> <li>\u6d41\u91cf\u8d70\u5411\u5206\u6790</li> </ul>"},{"location":"tags/#go","title":"Go","text":"<ul> <li>Map</li> <li>\u6c47\u7f16</li> <li>context</li> </ul>"},{"location":"tags/#linux","title":"Linux","text":"<ul> <li>\u670d\u52a1\u5668\u95ee\u9898\u96c6\u9526</li> </ul>"},{"location":"tags/#docker_1","title":"docker","text":"<ul> <li>dockerfile</li> </ul>"},{"location":"tags/#k8s","title":"k8s","text":"<ul> <li>\u547d\u4ee4\u6c47\u603b</li> <li>\u73af\u5883\u5b89\u88c5</li> <li>\u955c\u50cf\u4ed3\u5e93</li> <li>apiserver</li> <li>controller-manager</li> <li>etcd</li> <li>kubectl</li> <li>API\u8d44\u6e90</li> <li>\u914d\u7f6e\u7ba1\u7406</li> <li>\u63a7\u5236\u5668</li> <li>\u5b58\u50a8\u7ba1\u7406</li> <li>pod</li> <li>\u8c03\u5ea6\u5668</li> <li>service</li> <li>client-go</li> <li>sample-controller</li> </ul>"},{"location":"tags/#mysql","title":"mysql","text":"<ul> <li>\u7d22\u5f15\u5e95\u5c42</li> </ul>"},{"location":"tags/#redis","title":"redis","text":"<ul> <li>\u6570\u636e\u7c7b\u578b</li> <li>\u73af\u5883\u914d\u7f6e</li> <li>\u6570\u636e\u6301\u4e45\u5316</li> <li>\u6e90\u7801\u5206\u6790</li> </ul>"},{"location":"tags/#_1","title":"\u7a0b\u5e8f\u5458\u9884\u5907","text":"<ul> <li>ssh</li> <li>git\u57fa\u7840</li> </ul>"},{"location":"tags/#_2","title":"\u7f51\u7edc\u7f16\u7a0b","text":"<ul> <li>https\u4e0e\u8bc1\u4e66</li> <li>tcp</li> </ul>"}]}